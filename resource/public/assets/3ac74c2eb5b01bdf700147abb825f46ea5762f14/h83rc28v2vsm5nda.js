import{d3 as _e,aA as Ee,R as de,g8 as we,P as Me,a as Re,X as Ie,b as E,g9 as Oe,ga as ce,gb as Ae,gc as ke,D as oe,m as X,ax as Ne,gd as be,bw as De,ex as Pe,fp as xe,aE as ne,bz as qe,r as le,q as F,ge as Ue,gf as Le,fB as He,aD as ze,O as B,aK as se,gg as Fe,s as Be,L as We,F as $e,E as Ve,aL as Ge,gh as Qe,gi as je}from"./dze2l9y9kn6nwat0.js";import{dV as pe,dW as Je,dX as Ke,dY as ue,dZ as ge,d_ as Xe,d$ as fe,e0 as Ye,e1 as Ze,i as et,a7 as tt,e2 as ot,e3 as me,e4 as nt,e5 as st,a6 as it,e6 as at,e7 as rt,e8 as dt,e9 as ct,ea as lt,ay as ut,eb as gt,ec as ft,ed as mt,ee as _t,ef as pt}from"./j4xe1fdohr6xk09p.js";import{a as ht,d as yt,r as vt}from"./cg166fqqcxkeiosv.js";import{T as Tt}from"./gzm2pyuieq14d2cd.js";const St="OAI-Echo-Logs",k={FOCUS_IN:0,FOCUS_OUT:1,COPY:2,PASTE:3,TOUCH_START:4,TOUCH_END:5},he=[];function N(o){return()=>{he.push({type:o,ts:Math.round(performance.now())})}}const Ct={focusin:N(k.FOCUS_IN),focusout:N(k.FOCUS_OUT),copy:N(k.COPY),paste:N(k.PASTE),touchstart:N(k.TOUCH_START),touchend:N(k.TOUCH_END)};function bt(o){const e=o??document.getElementById(Tt);for(const[i,u]of Object.entries(Ct))e?.removeEventListener(i,u),e?.addEventListener(i,u)}function Et(){return{[St]:he.slice(0,10).map(o=>`${o.type},${o.ts}`).join(",")}}const wt=1e3*30,W=pe.getTracer("completion"),y={};function Dt(o){return y[o]?!1:(y[o]=[],!0)}function Pt(o){if(y[o]){for(;y[o]?.length>0;)y[o].shift()?.();return delete y[o],!0}return!1}function Mt(o,e,i,u,v){const l=new AbortController,M=v?Je([v,l.signal]):l.signal,b="threadId"in e?e.threadId:void 0,$="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,D=e.model,P=e.messages[0]?.id,x={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:b,continue_from_shared_conversation_id:b!=null?void 0:$,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:e.completionMetadata?.variantPurpose,suggestions:e.completionMetadata?.suggestions?e.completionMetadata.suggestions.map(n=>Ke(n)):void 0,chosen_suggestion:e.completionMetadata?.suggestion?{type:e.completionMetadata.suggestion.type,index:e.completionMetadata.suggestionIndex,source:e.completionMetadata?.suggestion.type===ue.Autocomplete?e.completionMetadata.suggestion.source:void 0,user_input:e.completionMetadata?.suggestion.type===ue.Autocomplete?e.completionMetadata.suggestion.userInput:void 0}:void 0,history_and_training_disabled:w(e.historyDisabled),conversation_mode:e.completionMetadata?.conversationMode,force_paragen:w(e.forceParagen),force_paragen_model_slug:e.forceParagenModel,force_indepth_feedback:w(e.forceIndepthFeedback),force_rate_limit:w(e.forceRateLimit),reset_rate_limits:w(e.resetRateLimits),disable_system_content_toggling:w(e.disableSystemContentToggling),source:e.completionMetadata?.source,system_hints:e.completionMetadata?.systemHints,prefetch_ids:e.completionMetadata?.prefetchIds,supports_buffering:!0,supported_encodings:[ge.V1],conversation_origin:K(e.conversationOrigin),force_use_search:K(e.forceUseSearch),client_reported_search_source:e.completionMetadata?.searchSource,client_contextual_info:e.contextualInfo,paragen_stream_type_override:K(e.paragenStreamType==="none"?null:e.paragenStreamType),paragen_cot_summary_display_override:K(e.paragenCotSummaryDisplay==="none"?null:e.paragenCotSummaryDisplay),is_onboarding_conversation:w(e.isOnboardingConversation)};let R,I;const T=_e(o);Ee(T)?(I=window.location.origin+"/backend-anon",R=de.getUnauthHeaders().additionalHeaders):(Xe(3010482349,`${D}-AAAA`)?I=window.location.origin+"/backend-alt":I=window.location.origin+"/backend-api",R=de.getAuthedHeadersWithAccessToken(T?.accessToken));const g=`${I}/conversation`,V=we(e.chatReq,e.turnstileToken,e.proofToken,null),G={...R,...Et(),...V};let q=!1,O=!1,A=!1,h=!1,Q,S,C,j,U;W.startActiveSpan("completion.response",n=>{Q=W.startSpan("completion.first_response"),S=W.startSpan("completion.first_token_including_tool_calls"),C=W.startSpan("completion.first_token_including_visible_content"),j=W.startSpan("completion.first_token"),U=n});const Y=pe.setSpan(fe.active(),U);let f=null,L=!1;function m(){L||(L=!0,i({type:"done"}))}function H(n){if(e.turnTracker.onBytesReceived(n.data),n.data==="[DONE]")l.abort(),U.end(),m();else if(n.event!=="ping")try{let t=JSON.parse(n.data);if(n.event==="delta_encoding")if(t===ge.V1)e.turnTracker.stream_encoding=t,f=new Ze;else{oe.addError(`[completion-delta] unknown delta encoding: ${t}`);return}else if(n.event==="delta"){if(!f){oe.addError("[completion-delta] delta event before delta_encoding");return}t=f.applyDelta(t)}if(t.error){const _=E.createWithErrorMessage(g,"server",t.error);throw i({type:"error",error:_}),_}else"type"in t?t.type==="gizmo_inline_review"?i({type:"gizmo_inline_review",gizmoId:t.gizmo_id}):t.type==="title_generation"?i({type:"title_generation",title:t.title,conversation_id:t.conversation_id}):t.type==="moderation"?i({type:"moderation",conversationId:t.conversation_id,messageId:t.message_id,isCompletion:t.is_completion,flagged:t.moderation_response.flagged,blocked:t.moderation_response.blocked,disclaimers:t.moderation_response.disclaimers,metadata:t.moderation_response.metadata}):t.type==="url_moderation"?i({type:"url_moderation",conversationId:t.conversation_id,messageId:t.message_id,url:t.url_moderation_result.full_url,isSafe:t.url_moderation_result.is_safe}):t.type==="num_variants_in_stream"?i({type:"num_variants_in_stream",num_variants_in_stream:t.num_variants_in_stream,display_treatment:t.display_treatment}):t.type==="conversation_detail_metadata"?i(t):t.type==="message_stream_complete"&&m():(i({type:"message",message:t.message,conversationId:t.conversation_id}),q||(q=!0,Q.end()),!O&&t.message.author.role===X.Assistant&&(O=!0,S.end()),!A&&t.message.author.role===X.Assistant&&Ne(t.message)&&(A=!0,C.end()),!h&&t.message.author.role===X.Assistant&&be(t.message)&&(h=!0,j.end()))}catch(t){if(t instanceof E)throw t}}let d=setTimeout(()=>{Me.logEvent(Re.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:Ie.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}})},wt);fe.with(Y,()=>(e.profiler?.logTiming("fetch_event_source"),Ye(g,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...G},body:JSON.stringify(x),signal:M,openWhenHidden:!0,async onopen(n){const t=n.headers.get("content-type")??"",_=n.headers.get("Cf-Ray")??null;if(n.ok&&t.includes("text/event-stream")){u(_,e.model);return}else if(t.includes("application/json")){const c=await n.json(),a=new E(g,n.status,c);if(a.isServerError())throw a;if((a?.code==="expired_session_key"||a?.code==="invalid_api_key"||a?.code==="token_expired")&&typeof window<"u"&&window._oaiHandleSessionExpired?.("stream",JSON.stringify(a)),a?.code==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}throw a}else{const c=await n.text();throw new E(g,n.status,{detail:{message:Oe,code:"unexpected_content_type",contentType:t,text:c?.substring(0,1e3)}})}},onmessage:n=>{d&&(clearTimeout(d),d=null),y[P]?y[P].push(()=>H(n)):H(n)},onerror(n){let t=n instanceof Error?n:new Error(JSON.stringify(n));throw t.message==="Failed to fetch"&&(t=E.createWithErrorMessage(g,"server",`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${ce}`)),t.message==="network error"&&(t=E.createWithErrorMessage(g,"client",`A network error occurred. Please check your connection and try again. ${ce}`)),Ae("fetch-error:conversation:new-message",{url:g,message:t?.message}),i({type:"error",error:t}),t}}))).catch(async n=>{n instanceof E?ke(n):oe.addError(n),e.turnTracker.handleRawError(n.message??"Something went wrong",n.status)})}function w(o){if(o===!0)return o}function K(o){if(o!=null)return o}function xt({clientThreadId:o,preRequestCompletion:e}){const i=ht(),u=De(),v=Pe(),l=xe(),M=yt(),b=et(),$=null,D=tt(o),P=D&&"gizmo"in D?D.gizmo?.gizmo.id:void 0,x=ot(P),R=P?x?me.PROJECT:me.GPT:void 0;return vt.useCallback(async function({requestedModelId:I,completionType:T=se.Next,eventSource:g="mouse",completionMetadata:V,extraStreamParams:G,promptMessage:q,prependMessages:O,appendMessages:A,profiler:h}={}){const Q=performance.now();e?.(),nt.reset(),q&&ne(o,s=>{qe.appendMessage(s,q)});const S=le.getCurrentLeafId(F(o));h?.logTiming("start_chat_requirements");const C=await Ue();h?.logTiming("fetched_chat_requirements"),C.force_login&&b({authType:"login"});const[j,U]=await Promise.all([st.getEnforcementToken(C).then(s=>(h?.logTiming("fetched_turnstile_token"),s),s=>null),Le.getEnforcementToken(C).then(s=>(h?.logTiming("fetched_p_token"),s),s=>null),i.ensureQueryData(He(l))]),Y=performance.now()-Q;ze.publish({kind:"requestCompletion"});const f=le.getTree(F(o));B.retainThread(o);const L=je(),m=`${Qe}${o}-${L}`,H=`${o}-${L}`,d=f.getNodeByIdOrMessageId(S);f.getConversationTurns(S,$!=null).length>2&&ne(o,s=>{s.scrollToMessageId=d.message.id});const t={gizmo_id:d.message.metadata?.gizmo_id};B.updateTree(o,s=>{s.addNode(m,"",S,X.Assistant,void 0,t)}),B.setThreadCurrentLeafId(o,m);let _,c=[],a=f.getNodeByIdOrMessageId(d.parentId);for(;a!=null&&(a.metadata?.isPlaceholderTemplateAssistantWelcomeMessage===!0||a.metadata?.isClientCreatedSystemMessage===!0);){const s=a.message;c.unshift(s);const r=f.getNodeByIdOrMessageId(a.parentId);_=r.message?.id??r.id,a=r}if(T===se.Next||T===se.Variant){const s=f.getNodeByIdOrMessageId(d.parentId);if(_??=s.message?.id??s.id,O){let r=d.parentId,ee=d.id;B.updateTree(o,z=>{for(const te of O)z.insertNodeBefore(ee,{id:te.id,message:te,parentId:r,children:[]}),r=te.id}),c.push(...O)}if(c.push(d.message),A){let r=S;B.updateTree(o,ee=>{for(const z of A)ee.insertNodeBefore(m,{id:z.id,message:z,parentId:r,children:[]}),r=z.id}),c.push(...A)}c=Rt(c,G)}else _??=d.message.id;const Z=I??F(o)?.modelId??it(Fe(i,l)).id,ie=Be(o);ie===void 0&&We(o)&&ne(o,s=>{s.initialThreadData.lastModelUsed=Z});const J=new at({gizmoType:R,messages:c});rt()&&await dt();const ve=(s,r)=>{!F(s)?.disableConversationNavigation&&!r&&_t(M,i,s,x)},Te=new ct(i,o,m,T,Z,g,ve,v,H,J,l),Se=(s,r)=>{s&&J.onReceivedRequestId(s),pt(H,r,s,Y)},Ce={is_dark_mode:u,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window?.innerHeight,page_width:window?.innerWidth,pixel_ratio:window?.devicePixelRatio,screen_height:window?.screen?.height,screen_width:window?.screen?.width},ae=F(o),p=lt(),re=new AbortController;Mt(i,{conversationOrigin:ae?.conversationOrigin??null,model:Z,completionType:T,threadId:ie,continueFromSharedConversationId:ae?.continuingFromSharedConversationId,historyDisabled:l,parentMessageId:_,messages:c,chatReq:C,turnstileToken:j,proofToken:U,completionMetadata:V,turnTracker:J,profiler:h,contextualInfo:Ce,isOnboardingConversation:V?.isOnboardingConversation,forceParagen:p.forceParagen,forceParagenModel:p.forceParagen?p.forceParagenModel.value:void 0,forceRateLimit:p.forceRateLimit,resetRateLimits:p.resetRateLimits,disableSystemContentToggling:p.rebaseSystemMessageContent!=null,forceUseSearch:p.forceUseSearch??void 0,paragenStreamType:p.paragenStreamType,paragenCotSummaryDisplay:p.paragenCotSummaryDisplay,...G},Te.handleResponse,Se,re.signal),ut(o,{source:$e.CLIENT,value:Ve.STREAMING}),Ge.addRequest(m,re,J),gt.onCompletionRequestStarted(m),_e(i)?.user==null&&ft.incrementUserMessageCount()},[o,i,v,l,u,$,M,b,R,x,e])}const Rt=(o,e)=>{let i=o;return e?.forceUseSearch===!1&&o.length>0&&(i=o.map(u=>{const{system_hints:v,...l}=u.metadata||{};return{...u,metadata:{...l,system_hints:v?.filter(M=>M!==mt.Search)}}})),i};export{Dt as b,Pt as e,bt as t,xt as u};
//# sourceMappingURL=h83rc28v2vsm5nda.js.map

import{j as e,M as u,h as te,c as ae,r as F,v as ie}from"./cg166fqqcxkeiosv.js";import{bT as S,q as ne,s as le,ab as R,h as V,I as re,bb as oe,Q as de,g3 as me,bh as ce,g4 as ge,M as B,m as ue,aE as fe,d1 as pe,b7 as he,c2 as _e,bz as xe,aj as je}from"./dze2l9y9kn6nwat0.js";import{at as ye,df as Me,dg as ve,dh as we,m as Pe,aF as J,di as z,dj as be,bP as Se,dk as W,dl as Ne}from"./j4xe1fdohr6xk09p.js";import{T as v}from"./jky4nhpbj4n3xuh7.js";import{T as Te}from"./kxggiygl9l9wvt1i.js";import"./h83rc28v2vsm5nda.js";import"./gzm2pyuieq14d2cd.js";import"./cfvh96gbcjdpth1v.js";import"./m5vf38e63o5zwpil.js";import"./m4iicmyh3x1nme4j.js";import"./b6ddr1xo1x0u3g1f.js";function ze({action:s,handleUserAction:t,userActionParams:i,displayParams:a}){return s.type==="deny"?e.jsx(S,{color:"secondary",size:"small",onClick:()=>{t({...i,actionData:{type:"deny",...s.deny}})},children:e.jsx(u,{...s.name==="decline"?j.decline:j.deny})}):s.type==="allow"?e.jsx(S,{color:"primary",size:"small",onClick:()=>{t({...i,actionData:{type:"allow",...s.allow}})},children:e.jsx(u,{...s.name==="allow"?j.allow:j.confirm})}):s.type==="always_allow"?e.jsx(S,{color:"secondary",size:"small",onClick:async()=>{t({...i,actionData:{type:"always_allow",...s.always_allow}})},children:e.jsx(u,{...j.alwaysAllow})}):s.type==="oauth_redirect"?e.jsx(S,{color:"primary",size:"small",onClick:()=>{ke(s.oauth_redirect,i.clientThreadId,i.turnGizmo)},children:e.jsx(u,{...j.signInButton,values:{domain:a.domain}})}):s.type==="contact_gizmo"?e.jsx(S,{color:"secondary",size:"small",onClick:async()=>{t({...i,actionData:{type:"contact_gizmo",...s.contact_gizmo}})},children:e.jsx(u,{...j.allow})}):null}async function ke(s,t,i){const a=ne(t),n=le(t),l=a?.mode?.kind===R.GizmoTest,r=n&&!l?ye(n,i):window.location.href;s.gizmo_id==="FAKE_PLUGIN_GIZMO"&&Me({id:s.gizmo_action_id},r),ve.doOAuthRedirect(s.gizmo_id,s.gizmo_action_id,s.domain,r,l)}const j=V({alwaysAllow:{id:"jitPluginMessage.alwaysAllow",defaultMessage:"Always Allow"},allow:{id:"jitPluginMessage.allow",defaultMessage:"Allow"},decline:{id:"jitPluginMessage.decline",defaultMessage:"Decline"},confirm:{id:"jitPluginMessage.confirm",defaultMessage:"Confirm"},deny:{id:"jitPluginMessage.deny",defaultMessage:"Deny"},signInButton:{id:"jitPluginMessage.signInButton",defaultMessage:"Sign in with {domain}"}}),N="openaiFileIdRefs";function Ye({messages:s,clientThreadId:t,isLastTurnInConversation:i,onRequestCompletion:a}){const[n,l]=te(),[r,...m]=s,o=ae(),c=re(),w=oe(t),x=r.message.metadata?.gizmo_id??w,P=de(t,d=>Ne(je(d?.mode),x)),U=we(P)&&P.gizmo_id===x,b=Pe(x,U)?.data,[$,K]=F.useState(!1),G=me(r.message.recipient);let k;if(G?.functionName!=null&&b?.tools!=null){for(const d of b.tools)if(Ae(d,G.functionName)){k=d;break}}const q=m.filter(d=>d.message.metadata?.jit_plugin_data?.from_server?.type==="debug"),Q=m.filter(d=>!["debug","send_test"].some(g=>g===d.message.metadata?.jit_plugin_data?.from_server?.type)),{uiState:_,jitPluginData:f,fileAttachments:Y}=Fe(r,Q,i);let h=f?.from_server?.type!=="denied_by_user"?f?.from_server?.body.domain:k?.metadata?.domain;h?h.endsWith("__jit_plugin")&&(h=h.slice(0,-12)):h="connector";const E=k?.metadata?.privacy_policy_url;F.useEffect(()=>{if(L(f?.from_client)?.type==="oauth_success")return;const d=n.get("oauth_success");if(f?.from_server?.type==="oauth_required"&&d){for(const g of f.from_server.body.actions)if(g.type==="oauth_redirect"){if(g.oauth_redirect.gizmo_id==="FAKE_PLUGIN_GIZMO")return;C({assistantMessage:r,clientThreadId:t,onRequestCompletion:a,actionData:{type:"oauth_success",target_message_id:g.oauth_redirect.target_message_id},conversationMode:P});return}l(g=>(g.delete("oauth_success"),g),{replace:!0})}},[P,r,s,t,a,f,i,n,l]);let y=v.Running,M=h?p.running:p.starting,I={domain:h},T=null;if(_===7)return null;if(_===4||_===5){y=v.Paused,M=p.confirmingSimple;const d={gizmoName:b?.gizmo.display.name??"ChatGPT",domain:h};T=o.formatMessage(p.confirmParamsTitle,d),I={...d,title:g=>e.jsxs("div",{className:"inline-flex items-center gap-1 text-sm",children:[g,e.jsx(J,{className:"icon-sm"})]}),subtitle:g=>e.jsx("div",{className:"text-xs",children:g})}}else _===1?(y=v.Finished,M=p.finished,T=o.formatMessage(p.sentParamsTitle,{gizmoName:b?.gizmo.display.name??"ChatGPT",domain:h}),I={domain:h}):_===2?(y=v.Error,M=p.error):(_===3||_===6)&&(y=v.Stopped,M=_===6?p.declined:p.stopped);const Z={assistantMessage:r,allMessages:s,clientThreadId:t,turnGizmo:b,onRequestCompletion:a,conversationMode:P},H={domain:h},D=f?.from_server?.type!=="denied_by_user"?f?.from_server?.body.actions.map((d,g)=>e.jsx(ze,{action:d,displayParams:H,handleUserAction:C,userActionParams:Z},g)):null,X=M?o.formatMessage(M,I):null,ee=ce.div`flex gap-2 flex-wrap mt-1 empty:hidden`,O=f?A(f):null,Ce=O?.[N]??[],se=!!O;return e.jsxs(e.Fragment,{children:[e.jsx(De,{debugMessages:q}),e.jsx(Te,{highlightedCommand:X,status:y,showWorkUserSetting:!1,children:se?e.jsx(Ge,{privacyPolicyUrl:E,data:f,isPromptingForPermission:y===v.Paused}):null}),e.jsx(ee,{children:Y?.map(d=>e.jsx(z,{file:d.name,fileId:d.id,width:"wide",alwaysShowData:!0,showDownloadButton:!0,downloadLink:d.download_url,contextConnectorInfo:be(d.context_connector_info)},d.id))}),(_===5||_===4)&&D&&!c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2 flex gap-2",children:D}),e.jsxs("div",{className:"my-1 flex items-center gap-2 text-sm",children:[e.jsx(ge,{className:"icon-sm"}),e.jsx(u,{...p.confirmingSubtitle})]})]}),T!==null&&e.jsx(Oe,{title:T,privacyPolicyUrl:E,data:f,onClose:()=>K(!1),isOpen:$,actionButtons:D})]})}function Ie({messageMetadata:s}){const[t,i]=F.useState(!1);return e.jsxs("div",{className:"my-2 flex flex-col text-sm",children:[e.jsxs("div",{className:"flex flex-row items-center hover:cursor-pointer",onClick:()=>{i(!t)},children:[t?e.jsx(J,{className:"icon-sm"}):e.jsx(_e,{className:"icon-sm"}),e.jsx("div",{className:"font-semibold",children:s.display_message})]}),t&&e.jsx("pre",{children:JSON.stringify(s.data,null,2)})]})}function De({debugMessages:s}){return s.length===0?null:e.jsx("div",{children:s.map((t,i)=>{const a=t.message.metadata?.jit_plugin_data?.from_server;return a&&a.type==="debug"?e.jsx(Ie,{messageMetadata:a.body},i):null})})}function Fe(s,t,i){if(s.message.metadata?.jit_plugin_data?.from_server?.type==="send_test")return{uiState:7};if(t.some(a=>a.message.content.content_type===B.SystemError))return{uiState:2};if(Se(s.message))return{uiState:3};for(let a=t.length-1;a>=0;a--){const n=t[a];if(n.message.metadata?.invoked_plugin){const m=[];return t.forEach(o=>{const c=o.message.metadata?.attachments?.filter(w=>w.display_files_from_actions_ext);c&&m.push(...c)}),{uiState:1,jitPluginData:n.message.metadata.jit_plugin_data,fileAttachments:m}}const l=L(n.message.metadata?.jit_plugin_data?.from_client);if(l!=null){if(l?.type==="contact_gizmo")return{uiState:1,jitPluginData:t[a-1]?.message.metadata?.jit_plugin_data};if(l?.type==="deny")return{uiState:6};if(l?.type==="oauth_success")return{uiState:0,jitPluginData:n.message.metadata?.jit_plugin_data};break}const r=n.message.metadata?.jit_plugin_data?.from_server;if(r?.type==="preview"&&i)return{uiState:0,jitPluginData:n.message.metadata?.jit_plugin_data};if(r?.type==="confirm_action"&&i)return{uiState:5,jitPluginData:n.message.metadata?.jit_plugin_data};if(r?.type==="oauth_required"&&i)return{uiState:4,jitPluginData:n.message.metadata?.jit_plugin_data}}return{uiState:i?0:3}}function C({actionData:s,assistantMessage:t,clientThreadId:i,turnGizmo:a,onRequestCompletion:n,conversationMode:l}){const r={id:ie(),author:{role:ue.Tool,name:t.message.recipient},content:{content_type:B.Text,parts:[""]},recipient:"all",metadata:{jit_plugin_data:{from_client:s}}};l=l??{kind:R.PrimaryAssistant},a?.gizmo.id&&(r.metadata.gizmo_id=a.gizmo.id),fe(i,m=>{xe.appendMessage(m,r,{completionSampleFinishTime:Date.now()})}),n({completionMetadata:{conversationMode:l}})}function Ae(s,t){if(s.type!==pe.JIT_PLUGIN||!s.metadata.json_schema)return!1;let i=!1;function a(n){for(const l in n)l==="operationId"&&n[l]===t&&(i=!0),n[l]&&typeof n[l]=="object"&&a(n[l])}return a(s.metadata.json_schema),i}function A(s){if(s.from_server?.type==="confirm_action"||s.from_server?.type==="oauth_required"||s.from_server?.type==="preview")return s.from_server.body.params}function Ge({data:s,privacyPolicyUrl:t,isPromptingForPermission:i}){const a=s?A(s):null,l=(a?.[N]??[]).map((r,m)=>{const o=r.name.startsWith("dalle-");let c=r.name;return o&&(c=`${c}.webp`),e.jsx(z,{file:c,fileId:r.id},m)});return e.jsxs("div",{className:"mb-4 mt-1 divide-y divide-token-border-light overflow-hidden rounded-xl border border-token-border-light",children:[e.jsxs("div",{className:"flex justify-between bg-token-main-surface-tertiary px-4 py-2 text-sm text-token-text-secondary",children:[i?e.jsx(u,{id:"JITPluginMessage.params.sharing.present",defaultMessage:"The following will be shared:"}):e.jsx(u,{id:"JITPluginMessage.params.sharing.past",defaultMessage:"The following was shared:"}),t&&e.jsx("a",{href:W(t),className:"text-token-text-primary",target:"_blank",rel:"noreferrer",children:e.jsx(u,{...p.privacyPolicyLink})})]}),a&&Object.keys(a).map((r,m)=>r===N?null:e.jsxs("div",{className:"flex items-center space-x-2 px-4 py-2 font-mono",children:[e.jsx("span",{className:"text-token-text-tertiary",children:`${r}:`}),e.jsx("span",{children:JSON.stringify(a[r],null,2)})]},m)),l.length>0&&e.jsx("div",{className:"px-4 py-2",children:l})]})}function Ee({title:s,data:t,privacyPolicyUrl:i,actionButtons:a}){const n=t?A(t):null,l=n?.[N]??[],r=l.filter(o=>!o.mime_type?.startsWith("image/")).map((o,c)=>e.jsx(z,{file:o.name,fileId:o.id},c)),m=l.filter(o=>o.mime_type?.startsWith("image/")).map((o,c)=>{const w=o.name.startsWith("dalle-");let x=o.name;return w&&(x=`${x}.webp`),e.jsx(z,{file:x,fileId:o.id},c)});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-semibold",children:s}),n&&Object.keys(n).map((o,c)=>o===N?null:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:o}),e.jsx("div",{children:JSON.stringify(n[o],null,2)})]},c)),m.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:e.jsx(u,{id:"jitPluginMessage.paramsModalImages",defaultMessage:"Images"})}),m]}),r.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:e.jsx(u,{id:"jitPluginMessage.paramsModalFiles",defaultMessage:"Files"})}),r]}),e.jsxs("div",{className:"flex flex-row items-center justify-between pt-4",children:[a!==null&&e.jsx("div",{className:"space-x-2",children:a}),i&&e.jsx("a",{className:"text-xs font-semibold",href:W(i),children:e.jsx(u,{...p.privacyPolicyLink})})]})]})}function Oe({title:s,data:t,privacyPolicyUrl:i,onClose:a,isOpen:n,actionButtons:l}){return e.jsx(he,{isOpen:n,onClose:a,type:"success",hideSeparator:!0,showCloseButton:!0,size:"normal",title:e.jsx(u,{id:"jitPluginMessage.paramsModalTitle",defaultMessage:"Review action"}),children:e.jsx("div",{className:"relative flex h-full flex-col gap-2 overflow-hidden",children:e.jsx("div",{className:"space-y-2",children:e.jsx(Ee,{title:s,data:t,privacyPolicyUrl:i,actionButtons:l})})})})}function L(s){if(s&&"user_action"in s){const t=s.user_action;s={...s,...t.data},"target_message_id"in s&&t.target_message_id&&(s.target_message_id=t.target_message_id)}return s}const p=V({starting:{id:"jitPluginMessage.starting",defaultMessage:"Starting action"},confirming:{id:"jitPluginMessage.confirmingV4",defaultMessage:"<title>{gizmoName} wants to talk to {domain}</title><subtitle>Only allow sites you trust</subtitle>"},confirmingSimple:{id:"jitPluginMessage.confirming.simple",defaultMessage:"{gizmoName} wants to talk to {domain}"},confirmingSubtitle:{id:"jitPluginMessage.confirming.subtitle",defaultMessage:"Only allow sites you trust."},running:{id:"jitPluginMessage.runningV4",defaultMessage:"Talking to {domain}"},finished:{id:"jitPluginMessage.finishedV4",defaultMessage:"Talked to {domain}"},stopped:{id:"jitPluginMessage.stoppedV4",defaultMessage:"Stopped talking to {domain}"},error:{id:"jitPluginMessage.errorV5",defaultMessage:"Error talking to {domain}"},declined:{id:"jitPluginMessage.declined",defaultMessage:"You declined this action"},ranTest:{id:"jitPluginMessage.ranTest",defaultMessage:"Tested {operationName}"},confirmParamsTitle:{id:"jitPluginMessage.confirmParamsTitleV3",defaultMessage:"{gizmoName} wants to share this info with {domain}"},sentParamsTitle:{id:"jitPluginMessage.sentParamsTitleV2",defaultMessage:"{gizmoName} sent this info to {domain}"},privacyPolicyLink:{id:"jitPluginMessage.privacyPolicyLinkV2",defaultMessage:"Privacy policy"}});export{Ye as JITPluginMessage};
//# sourceMappingURL=x3ju7asrz72fp0r5.js.map

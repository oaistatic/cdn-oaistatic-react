import{d as It,r as E,D as Ot,v as Vt,j as ne,u as Bt}from"./j12so9ru57hpoz1y.js";import{pu as Nt,ti as At,tj as _t,tk as Lt,tl as le,d as zt,dQ as Ht,tm as Le,tn as Ft,to as Ut,tp as Kt,tq as jt,tr as $t,ha as G,ts as Gt,a$ as Wt,n5 as pe,tt as Xt,r7 as ze,tu as He,nz as qt,tv as Yt,oX as Te,n6 as Ee,nu as it,p1 as Jt,tw as Qt,p2 as at,tb as Zt,tx as en,n2 as tn,dD as nn,ty as te,tz as sn,tA as on,tB as rn,nB as fe,hC as an,np as cn,nA as ln,tC as un,tD as dn,tE as pn}from"./jn7p98x7qxquz26a.js";import{a as z,P as L,T as X,b as Z,D as O,A as hn,B as fn,M as ct,j as lt,C as mn,G as Fe,y as gn,d as wn,m as xe,o as Ue,z as Cn,R as yn,g as En,H as ut,I as kn,q as dt,J as Pn,u as Mn,k as pt,E as ht,K as Sn,h as vn,v as bn}from"./msp412gwqdn605it.js";import{n as De,D as Rn,Q as Tn,dM as xn,a as Se,p as Ke,dy as Dn,o as In,u as On,bT as Vn,hq as Bn,r as Nn,dT as An}from"./j5zd9vs1l0bwsjqa.js";import{O as _n,R as Ln,U as je,E as zn,C as Hn,J as Fn,A as Un,x as Kn,V as jn,y as $n,z as Gn,Q as Wn,W as ft,S as mt}from"./ke2u5pwt169srvv9.js";import{H as $e,d as Ge,E as We,k as Xn,Y as qn}from"./epsg05et2lobrl6v.js";import{M as Yn,C as Ie,a as Xe}from"./hv2qnh4kmlq1qj5o.js";import{i as Jn}from"./fqps1a3pxo0q8nxi.js";import{a as Qn}from"./n0tk3xne532h7ges.js";function Zn(s,e){const t=[];return s.descendants((n,o)=>{n.marks.forEach(r=>{r.type===e&&t.push({from:o,to:o+n.nodeSize,mark:r})})}),t}function es(s,e,t){const n=e.mark.type,o={...e.mark.attrs,disabled:t};return s.removeMark(e.from,e.to,n),s.addMark(e.from,e.to,n.create(o)),s}const Oe=new z("disableUnsafeLinks");function ts(s,e){return s.setMeta(Oe,{safeUrls:e})}function ns(s){return s.getMeta(Oe)??null}function ss(s=new Set){return new L({key:Oe,state:{init(e){return{safeUrls:s}},apply(e,t){const n=ns(e);if(n==null)return t;const{safeUrls:o}=n;return{...t,safeUrls:o}}},appendTransaction(e,t,n){const o=this.getState(n),r=n.tr,i=n.schema.marks[Nt.proseMirrorMarkName()],a=Zn(n.doc,i);let c=!1;return a.forEach(l=>{const u=l.mark.attrs.href,d=o.safeUrls.has(u),p=l.mark.attrs.disabled===!0;d===p&&(es(r,l,!d),c=!0)}),c?r:null}})}const me=new z("placeholder");function os(s,e){return s.setMeta(me,{isDisabled:e})}function rs(s){return s.getMeta(me)??null}function is(s,e=!1){return new L({key:me,state:{init(){return{isDisabled:e}},apply(t,n){const o=rs(t);return o?.isDisabled!=null?{...n,isDisabled:o.isDisabled}:n}},props:{decorations(t){const{doc:n,selection:o}=t;if(me.getState(t).isDisabled||!(o instanceof X&&o.empty))return null;const{$cursor:i}=o;if(!i||!s)return null;const a=i.start();if(!((i.parent.isTextblock||i.parent.type.name==="doc")&&i.pos===a&&i.node().content.size===0))return null;const l=Z.widget(a,()=>{const u=document.createTextNode(s.formatMessage(as.placeholder)),d=document.createElement("span");return d.className="text-token-text-tertiary dark:text-gray-500 pointer-events-none select-none",d.style.position="absolute",d.appendChild(u),d});return O.create(n,[l])}}})}const as=It({placeholder:{id:"n2B51U",defaultMessage:"Write something..."}}),ve=new z("edit"),qe=(s,e,t,n)=>{const o=[];for(const{start:r,end:i,editId:a}of e)o.push(Z.inline(r,i,{class:At({isHovered:!1,isRejected:!1,isReplacement:!1}),"data-edit-id":a}));for(const{start:r,end:i,editId:a}of s)o.push(Z.inline(r,i,{class:_t({isHovered:!1,isRejected:!1,isReplacement:!0}),"data-edit-id":a}));return o},cs=(s,e)=>new L({key:ve,state:{init(){const n=new Set;return{decorations:qe(s,e),hoveredEditId:null,rejectedEdits:n}},apply(t,n){const o=t.getMeta(ve)??null,{hoveredEditId:r,rejectedEdits:i}=o??n;return{decorations:qe(s,e),hoveredEditId:r,rejectedEdits:i}}},props:{decorations(t){const n=this.getState(t);return n?O.create(t.doc,n.decorations.concat()):O.empty},editable(){return!1},attributes(){return{class:"cursor-default",style:"--text-primary:var(--text-secondary)"}}}}),Ye=(s,e,t,n,o)=>new Lt(s,e,t,n,s===e?le.none:[new le(e-s,o)],t===n?le.none:[new le(n-t,o)]);class ge{constructor(e,t){this.doc=e,this.changes=t}static create(e){return new ge(e,[])}addSteps(e,t){const n=[];for(const r of t){let i=0;if(r.getMap().forEach((a,c,l,u)=>{n.push(Ye(a+i,c+i,l,u,r)),i=u-l-(c-a)}),r instanceof hn||r instanceof fn){const{from:a,to:c}=r;n.push(Ye(a,c,a,c,r))}}if(n.length===0)return this;const o=this.changes.concat(n);return new ge(e,o)}}const ae=new z("changeset"),be=new z("highlightChanges"),gt=s=>ae.getState(s),ls=s=>{const{state:e}=s,t=e.tr.setMeta(ae,!0);s.updateState(e.apply(t))},us=s=>{const{state:e}=s,t=gt(e);if(!t)return;const{maps:n,steps:o}=t,r=new ct(n),i=e.tr;for(let c=o.length-1;c>=0;c--){const l=o[c].map(r.slice(c+1));if(!l)continue;i.maybeStep(l).doc&&r.appendMap(l.getMap(),c)}const a=e.apply(i.setMeta(ae,!0));s.updateState(a)},ds=()=>{const s=n=>({changeset:ge.create(n),maps:[],steps:[]}),e=new L({key:ae,state:{init:(n,{doc:o})=>s(o),apply:(n,o,r,i)=>{const{doc:a}=i;if(n.getMeta(ae))return s(a);const{docChanged:l,mapping:u,steps:d,docs:p}=n;if(!l)return o;const{changeset:h,maps:m,steps:M}=o,{maps:S}=u,q=d.map((k,y)=>k.invert(p[y]));return{changeset:h.addSteps(a,d),maps:m.concat(S),steps:M.concat(q)}}}}),t=new L({key:be,state:{init(){return{deco:O.empty,show:!1}},apply(n,o,r,i){const a=e.getState(i);if(!a)return o;const{changeset:c}=a,{doc:l}=i,{changes:u}=c,d=u.map(({fromB:h,toB:m})=>Z.inline(h,m,{class:"blame-marker"})),p=n.getMeta(be);return{deco:O.create(l,d),show:p??o.show}}},props:{decorations(n){const o=this.getState(n);if(!o?.show)return O.empty;const{deco:r}=o;return r}}});return[e,t]},re=new z("autocomplete");function Je(s,e){return s.setMeta(re,{suggestion:e})}function ps(s){return s.getMeta(re)}function Qe(s){if(!(s instanceof X))return null;const{$cursor:e}=s;if(!e)return null;const t=e.end();return e.pos===t?t:null}function hs(s=null){return new L({key:re,state:{init(){return{suggestion:s}},apply(e,t){const n=ps(e);return n===void 0?t:{...t,suggestion:n.suggestion??null}}},props:{decorations(e){const{doc:t,selection:n}=e,{suggestion:o}=re.getState(e);if(!o)return null;const r=Qe(n);if(r==null)return O.empty;const i=Z.widget(r,()=>{const a=document.createTextNode(o),c=document.createElement("span");return c.className="text-token-text-tertiary dark:text-gray-500 pointer-events-none select-none",c.appendChild(a),c});return O.create(t,[i])},handleDOMEvents:{keydown:(e,t)=>{const{state:n}=e,o=re.getState(n),r=Qe(n.selection);t.key==="Tab"&&o.suggestion&&r!=null&&(t.preventDefault(),e.dispatch(n.tr.insert(r,n.schema.text(o.suggestion))))}}}})}const fs=(s,e)=>{const t=E.useRef(!1),n=E.useRef(null),o=E.useRef(e);o.current=e;const r=E.useCallback(zt(async i=>{t.current=!1;const a=crypto.randomUUID();n.current=a;const c=await o.current?.(i());!t.current&&c!==void 0&&s.current&&n.current===a&&s.current.dispatch(Je(s.current.state.tr,c))},200),[]);return E.useCallback(i=>{t.current=!0;const a=De(s.current);a.dispatch(Je(a.state.tr,null)),r(i)},[r,s])};function wt(s){let e=s.selection.$from.pos-1;if(e<0)return null;let t=s.doc.nodeAt(e);for(;(t==null||t.type.name===Ht.proseMirrorNodeName())&&e>0;)e-=1,t=s.doc.nodeAt(e);return t!=null?{node:t,pos:e}:t}function ms(s,e){const t=wt(s);if(t==null)return!1;const{node:n,pos:o}=t,r=o+n.nodeSize,i=s.tr,c=s.schema.nodes.paragraph.create(null);i.insert(r,c);const l=r+c.nodeSize-1,u=i.doc.resolve(l),d=new X(u);return i.setSelection(d),e(i),!0}function gs(s,e){const t=wt(s);if(t==null)return!1;const{node:n,pos:o}=t,r=s.tr;return r.deleteRange(o,o+n.nodeSize),e(r),!0}const Ze=_n({settings:{background:"var(--gray-100)"}});class Ve{constructor(e,t,n,o){this.pmView=t,this.getPos=n,this.node=e;const r=[{key:"ArrowUp",run:this.maybeEscape("line",-1)},{key:"ArrowLeft",run:this.maybeEscape("char",-1)},{key:"ArrowDown",run:this.maybeEscape("line",1)},{key:"ArrowRight",run:this.maybeEscape("char",1)},{key:"Backspace",run:this.handleBackspace},{key:"Shift-Enter",run:this.handleShiftEnter}];this.languageCompartment=new $e,this.themeCompartment=new $e;const i=Ln(e.attrs.lang),a=Ge.create({doc:this.node.textContent,extensions:[this.themeCompartment.of(o?je:Ze),We.theme({"&":{borderRadius:"4px",padding:"0.5rem"},"&.cm-focused":{outline:"none"}}),Xn.of([...r,...zn,...Hn,Fn]),Un(),Kn(),jn(),qn(),$n(Gn),this.languageCompartment.of(i!=null?[i]:[]),Ge.changeFilter.of(c=>(!c.docChanged&&!this.updating&&this.forwardSelection(),!0))]});this.cm=new We({state:a,dispatch:this.dispatch}),i==null&&this.setLanguage(e.attrs.lang)}node;updating=!1;cm;languageCompartment;themeCompartment;get pmSchema(){return this.pmView.state.schema}get dom(){return this._setIsCodeBlockView(),this.cm.dom}setLanguage=async e=>{const t=await Wn(e);t&&this.cm.dispatch({effects:this.languageCompartment.reconfigure(t)})};setTheme=e=>{const t=e?je:Ze;this.cm.dispatch({effects:this.themeCompartment.reconfigure(t)})};handleBackspace=e=>{const{selection:t}=e.state;if(!(t.main.empty&&t.main.from===0)||this.cm.state.doc.length>0)return!1;const n=gs(this.pmView.state,this.pmView.dispatch);return this.pmView.focus(),n};handleShiftEnter=()=>{const e=ms(this.pmView.state,this.pmView.dispatch);return this.pmView.focus(),e};dispatch=e=>{if(this.cm.update([e]),this.updating)return;const t=(this.getPos()??0)+1,n=e.state.doc.toString(),o=Le(this.node.textContent,n);if(o){const{text:r,from:i,to:a}=o,c=r?this.pmSchema.text(r):null,l=this.pmView.state.tr.replaceWith(i+t,a+t,c);this.pmView.dispatch(l)}this.forwardSelection()};update=e=>{if(e.type!==this.node.type)return!1;e.attrs.lang!==this.node.attrs.lang&&this.setLanguage(e.attrs.lang),e.attrs.isDarkMode!=null&&e.attrs.isDarkMode!==this.node.attrs.isDarkMode&&this.setTheme(e.attrs.isDarkMode),this.node=e;const t=Le(this.cm.state.doc.toString(),e.textContent);if(t){const{text:n,from:o,to:r}=t;this.updating=!0,this.cm.dispatch({changes:{from:o,to:r,insert:n}}),this.updating=!1}return!0};asProseMirrorSelection=e=>{const t=(this.getPos()??0)+2,{anchor:n,head:o}=this.cm.state.selection.main;return X.create(e,n+t,o+t)};forwardSelection=()=>{if(!this.cm.hasFocus)return;const{state:e}=this.pmView,t=this.asProseMirrorSelection(e.doc);t.eq(e.selection)||this.pmView.dispatch(e.tr.setSelection(t))};maybeEscape=(e,t)=>n=>{const{state:o}=n,{selection:r}=o,a=(()=>{const h=r.main.from,{number:m,from:M}=o.doc.lineAt(h);return{line:m,ch:h-M}})(),c=o.selection.ranges.some(h=>!h.empty),l=1,u=o.doc.lineAt(o.doc.length).number;if(c||a.line!==(t<0?l:u)||e==="char"&&a.ch!==(t<0?0:o.doc.line(a.line).length))return!1;const d=(this.getPos()??0)+(t<0?0:this.node.nodeSize),p=lt.near(this.pmView.state.doc.resolve(d),t);return this.pmView.dispatch(this.pmView.state.tr.setSelection(p).scrollIntoView()),this.pmView.focus(),!0};setSelection=(e,t)=>{this.focus(),this.updating=!0,this.cm.dispatch({selection:{anchor:e,head:t}}),this.updating=!1};focus=()=>{this.cm.focus(),this.forwardSelection()};selectNode=()=>{this.focus()};stopEvent=()=>!0;destroy=()=>{this.cm.destroy()};_setIsCodeBlockView=()=>{this.cm.dom.dataset.isCodeBlockView="true"};static _getIsCodeBlockView=e=>e.dataset.isCodeBlockView==="true";static isInCodeBlockView(e){return e instanceof HTMLElement?e.closest("[data-is-code-block-view]")!=null:!1}}function ws(s,e,t){try{return e instanceof X?X.create(s,e.anchor,e.head):e instanceof mn?X.create(s,e.from,e.to):e instanceof Fe?new Fe(s):void 0}catch{return X.create(s,0)}}class Cs{rules;constructor(e,t){this.rules=[].concat.apply([],e.syntaxExtensions().map(n=>n.proseMirrorInputRules(t)))}build(){return Jn({rules:this.rules})}}class ys{keymap;constructor(e,t){this.keymap=new Map;for(const n of e.syntaxExtensions())this.addKeymap(n.proseMirrorKeymap(t));this.addKeymap(gn)}build(){const e={};return this.keymap.forEach((t,n)=>{e[n]=wn(...t)}),xe(e)}addKeymap(e){for(const t in e)this.keymap.get(t)||this.keymap.set(t,[]),De(this.keymap.get(t)).push(e[t])}}class Es{nodes={};marks={};constructor(e){for(const t of e.nodeExtensions()){const n=t.proseMirrorNodeName(),o=t.proseMirrorNodeSpec();n!=null&&o!=null&&(n!=="text"&&(o.attrs={...o.attrs,start:{default:void 0},end:{default:void 0}}),this.nodes[n]=o)}for(const t of e.markExtensions()){const n=t.proseMirrorMarkName(),o=t.proseMirrorMarkSpec();n!=null&&o!=null&&(this.marks[n]=o)}}build(){try{return new Ue({nodes:this.nodes,marks:this.marks})}catch(e){Rn.addError(e,{nodes:this.nodes})}return new Ue({nodes:{doc:{content:"block+"},paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p",preserveWhitespace:"full"}],toDOM:()=>["p",0]},text:{group:"inline"}},marks:this.marks})}}const ks=5;class Ps{builtSchema;inputRulesBuilder;keymapBuilder;nodeViewBuilder;unistToProseMirrorConverter;proseMirrorToUnistConverter;unified;memoizedProsemirrorDocs=new Map;constructor(e=[]){const t=new Ft(e);this.builtSchema=new Es(t).build(),this.inputRulesBuilder=new Cs(t,this.builtSchema),this.keymapBuilder=new ys(t,this.builtSchema),this.nodeViewBuilder=new Ut(t),this.unistToProseMirrorConverter=new Kt(t,this.builtSchema),this.proseMirrorToUnistConverter=new jt(t),this.unified=new $t(t).build()}parse(e){try{if(this.memoizedProsemirrorDocs.has(e))return De(this.memoizedProsemirrorDocs.get(e));const t=this.unistToProseMirrorConverter.convert(this.parseUnist(e));if(this.memoizedProsemirrorDocs.set(e,t),this.memoizedProsemirrorDocs.size>ks){const n=this.memoizedProsemirrorDocs.keys().next().value;this.memoizedProsemirrorDocs.delete(n)}return t}catch(t){G.logError("Failed to parse document",t)}return this.schema().text(" ")}parseUnist(e){return this.unified.runSync(this.unified.parse(e))}schema(){return this.builtSchema}inputRulesPlugin(){return this.inputRulesBuilder.build()}keymapPlugin(){return this.keymapBuilder.build()}nodeViews(){return this.nodeViewBuilder.build()}serialize(e){const t=this.proseMirrorToUnistConverter.convert(e);return this.unified.stringify(t)}}let et=null;function se(s={}){return et??=new Ps([new Yn(s?.shouldStripDirectives)]),et}const Ms=(s,e,t,n)=>{const o=[];for(const r of e)for(const i of t)o.push({from:r,to:i,parentNodeNamesAtStart:r.parentNodeTypeNameStack,slice:s.slice(r.pmPos,i.pmPos)});return o.sort((r,i)=>{const a=Math.abs(r.from.sourcePos-n.start)+Math.abs(r.to.sourcePos-n.end),c=Math.abs(i.from.sourcePos-n.start)+Math.abs(i.to.sourcePos-n.end);return a===c?i.slice.size-r.slice.size:a-c}),o},Ss=(s,e)=>xn(s.parentNodeNamesAtStart,e.parentNodeTypeNameStack),tt=new WeakMap,vs=({diff:s})=>{const e=new Gt(Wt.GetDiffedDoc,{debug:!1});e.startBlock("get_diffed_doc");const t=se(),{contentAfter:n,contentBefore:o,edits:r}=s,i=t.parse(n),a=t.parse(o),c=r.concat().sort((k,y)=>k.positionBefore.start-y.positionBefore.start),l=[],u=[];e.startBlock("init_position_transformers");const{sourceRangeToPmRange:d}=pe(a),{sourceRangeToPmRange:p}=pe(i);e.endBlock("init_position_transformers");let h=a,m=0,M=0;const S=[],q=(k,y,P)=>{for(const[V,F]of P.entries())try{if(!Ss(y,F))continue;const{pmPos:v}=F,{slice:N}=y;return h=h.replace(v,v,N),l.push({editId:k,start:v,end:v+N.size}),[V,F]}catch(v){S.push(v)}return null};for(let k=0;k<c.length;k++){const{id:y,positionBefore:P,positionAfter:V}=c[k];e.startBlock("transform_positions");const F=d(P),v=p(V);e.endBlock("transform_positions");const{start:N,end:x}=F,{start:B,end:w}=v,C=V.start!==V.end,g=C?Ms(i,B,w,V):null;e.startBlock("get_merged_doc_positions");const{positions:H}=pe(h);e.endBlock("get_merged_doc_positions");const R=Math.max(...N.map(({pmPos:_})=>_)),D=Math.min(...x.map(({pmPos:_})=>_)),Y=[].concat(x).concat(N),U=P.start!==P.end&&a.textBetween(R,D).length>0;let A=!1;if(U&&!C)u.push({editId:y,start:R+m,end:D+m}),A=!0;else if(!U&&!C)A=!0;else{const _=Y.map(({pmPos:T})=>H[T+m]);for(const T of g??[]){const I=q(y,T,_);if(I==null)continue;const J=I[0],ee=T.slice.size,ie=J<x.length;ie||(m+=ee),U&&u.push({editId:y,start:R+m,end:D+m}),ie&&(m+=ee),A=!0;break}}if(!A&&g!=null){const T=Math.min(...N.map(({pmPos:I})=>I))+m-1;for(const I of g)try{h=h.replace(T,T,I.slice),l.push({editId:y,start:T,end:T+I.slice.size}),m+=I.slice.size,U&&u.push({editId:y,start:R+m,end:D+m}),A=!0;break}catch(J){S.push(J)}}A?G.logEvent("Canvas Diff Edit Success"):(G.logEvent("Canvas Diff Edit Fail"),G.logError("Failed to insert edit for diffed doc",Tn(S),{errors:S.map(Xt),replaceFromCandidates:N,replaceToCandidates:x,sliceFromCandidates:B,sliceToCandidates:w}),M++)}return G.logDistribution("Canvas Diff Edit Success Ratio",(c.length-M)/c.length),G.logDistribution("Canvas Diff Edit Fail Count",M),G.logDistribution("Canvas Diff Edit Success Count",c.length-M),G.logDistribution("Canvas Diff Edit Count",c.length),e.endBlock("get_diffed_doc"),{doc:h,addedRanges:l,deletedRanges:u}},bs=({diff:s})=>{const e=tt.get(s);if(e!=null)return e;const t=vs({diff:s});return tt.set(s,t),t},ue=new z("focus"),Rs=(s,e)=>new L({key:ue,state:{init:()=>!1,apply(t,n){const o=t.getMeta(ue);return typeof o=="boolean"?o:n}},props:{handleDOMEvents:{blur:(t,n)=>{const{relatedTarget:o}=n;return o!=null&&Ve.isInCodeBlockView(o)||(e(n),t.dispatch(t.state.tr.setMeta(ue,!1))),!1},focus:(t,n)=>(s(n),t.dispatch(t.state.tr.setMeta(ue,!0)),!1)}}}),Ts=500;class W{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let n=this.items.length;for(;;n--)if(this.items.get(n-1).selection){--n;break}let o,r;t&&(o=this.remapping(n,this.items.length),r=o.maps.length);let i=e.tr,a,c,l=[],u=[];return this.items.forEach((d,p)=>{if(!d.step){o||(o=this.remapping(n,p+1),r=o.maps.length),r--,u.push(d);return}if(o){u.push(new $(d.map));let h=d.step.map(o.slice(r)),m;h&&i.maybeStep(h).doc&&(m=i.mapping.maps[i.mapping.maps.length-1],l.push(new $(m,void 0,void 0,l.length+u.length))),r--,m&&o.appendMap(m,r)}else i.maybeStep(d.step);if(d.selection)return a=o?d.selection.map(o.slice(r)):d.selection,c=new W(this.items.slice(0,n).append(u.reverse().concat(l)),this.eventCount-1),!1},this.items.length,0),{remaining:c,transform:i,selection:a}}addTransform(e,t,n,o){let r=[],i=this.eventCount,a=this.items,c=!o&&a.length?a.get(a.length-1):null;for(let u=0;u<e.steps.length;u++){let d=e.steps[u].invert(e.docs[u]),p=new $(e.mapping.maps[u],d,t),h;(h=c&&c.merge(p))&&(p=h,u?r.pop():a=a.slice(0,a.length-1)),r.push(p),t&&(i++,t=void 0),o||(c=p)}let l=i-n.depth;return l>Ds&&(a=xs(a,l),i-=l),new W(a.append(r),i)}remapping(e,t){let n=new ct;return this.items.forEach((o,r)=>{let i=o.mirrorOffset!=null&&r-o.mirrorOffset>=e?n.maps.length-o.mirrorOffset:void 0;n.appendMap(o.map,i)},e,t),n}addMaps(e){return this.eventCount==0?this:new W(this.items.append(e.map(t=>new $(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let n=[],o=Math.max(0,this.items.length-t),r=e.mapping,i=e.steps.length,a=this.eventCount;this.items.forEach(p=>{p.selection&&a--},o);let c=t;this.items.forEach(p=>{let h=r.getMirror(--c);if(h==null)return;i=Math.min(i,h);let m=r.maps[h];if(p.step){let M=e.steps[h].invert(e.docs[h]),S=p.selection&&p.selection.map(r.slice(c+1,h));S&&a++,n.push(new $(m,M,S))}else n.push(new $(m))},o);let l=[];for(let p=t;p<i;p++)l.push(new $(r.maps[p]));let u=this.items.slice(0,o).append(l).append(n),d=new W(u,a);return d.emptyItemCount()>Ts&&(d=d.compress(this.items.length-n.length)),d}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),n=t.maps.length,o=[],r=0;return this.items.forEach((i,a)=>{if(a>=e)o.push(i),i.selection&&r++;else if(i.step){let c=i.step.map(t.slice(n)),l=c&&c.getMap();if(n--,l&&t.appendMap(l,n),c){let u=i.selection&&i.selection.map(t.slice(n));u&&r++;let d=new $(l.invert(),c,u),p,h=o.length-1;(p=o.length&&o[h].merge(d))?o[h]=p:o.push(d)}}else i.map&&n--},this.items.length,0),new W(ze.from(o.reverse()),r)}static empty=new W(ze.empty,0)}function xs(s,e){let t;return s.forEach((n,o)=>{if(n.selection&&e--==0)return t=o,!1}),s.slice(t)}class ${constructor(e,t,n,o){this.map=e,this.step=t,this.selection=n,this.mirrorOffset=o}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new $(t.getMap().invert(),t,this.selection)}}}class Q{constructor(e,t,n,o,r){this.done=e,this.undone=t,this.prevRanges=n,this.prevTime=o,this.prevComposition=r}}const Ds=20;function Is(s,e,t,n){let o=t.getMeta(oe),r;if(o)return o.historyState;t.getMeta(Bs)&&(s=new Q(s.done,s.undone,null,0,-1));let i=t.getMeta("appendedTransaction");if(t.steps.length==0)return s;if(i&&i.getMeta(oe))return i.getMeta(oe).redo?new Q(s.done.addTransform(t,void 0,n,he(e)),s.undone,nt(t.mapping.maps),s.prevTime,s.prevComposition):new Q(s.done,s.undone.addTransform(t,void 0,n,he(e)),null,s.prevTime,s.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(i&&i.getMeta("addToHistory")===!1)){let a=t.getMeta("composition"),c=s.prevTime==0||!i&&s.prevComposition!=a&&(s.prevTime<(t.time||0)-n.newGroupDelay||!Os(t,s.prevRanges)),l=i?ke(s.prevRanges,t.mapping):nt(t.mapping.maps);return new Q(s.done.addTransform(t,c?e.selection.getBookmark():void 0,n,he(e)),W.empty,l,t.time,a??s.prevComposition)}else return(r=t.getMeta("rebased"))?new Q(s.done.rebased(t,r),s.undone.rebased(t,r),ke(s.prevRanges,t.mapping),s.prevTime,s.prevComposition):new Q(s.done.addMaps(t.mapping.maps),s.undone.addMaps(t.mapping.maps),ke(s.prevRanges,t.mapping),s.prevTime,s.prevComposition)}function Os(s,e){if(!e)return!1;if(!s.docChanged)return!0;let t=!1;return s.mapping.maps[0].forEach((n,o)=>{for(let r=0;r<e.length;r+=2)n<=e[r+1]&&o>=e[r]&&(t=!0)}),t}function nt(s){let e=[];for(let t=s.length-1;t>=0&&e.length==0;t--)s[t].forEach((n,o,r,i)=>e.push(r,i));return e}function ke(s,e){if(!s)return null;let t=[];for(let n=0;n<s.length;n+=2){let o=e.map(s[n],1),r=e.map(s[n+1],-1);o<=r&&t.push(o,r)}return t}function Vs(s,e,t){let n=he(e),o=oe.get(e).spec.config,r=(t?s.undone:s.done).popEvent(e,n);if(!r)return null;let i=r.selection.resolve(r.transform.doc),a=(t?s.done:s.undone).addTransform(r.transform,e.selection.getBookmark(),o,n),c=new Q(t?a:r.remaining,t?r.remaining:a,null,0,-1);return r.transform.setSelection(i).setMeta(oe,{redo:t,historyState:c})}let Pe=!1,st=null;function he(s){let e=s.plugins;if(st!=e){Pe=!1,st=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){Pe=!0;break}}return Pe}const oe=new z("history"),Bs=new z("closeHistory");function Me(s={},e=void 0){return s={depth:s.depth||100,newGroupDelay:s.newGroupDelay||500},new L({key:oe,state:{init(){return e??new Q(W.empty,W.empty,null,0,-1)},apply(t,n,o){return Is(n,o,t,s)}},config:s,props:{handleDOMEvents:{beforeinput(t,n){let o=n.inputType,r=o=="historyUndo"?yt:o=="historyRedo"?Re:null;return!r||!t.editable?!1:(n.preventDefault(),r(t.state,t.dispatch))}}}})}function Ct(s,e){return(t,n)=>{let o=oe.getState(t);if(!o||(s?o.undone:o.done).eventCount==0)return!1;if(n){let r=Vs(o,t,s);r&&n(e?r.scrollIntoView():r)}return!0}}const yt=Ct(!1,!0),Re=Ct(!0,!0),Ns=()=>new L({key:new z("katex"),props:{decorations(s){const e=[];return s.doc.descendants((t,n)=>{(t.type.name==="inline_math"||t.type.name==="math_block")&&e.push(Z.widget(n+1,()=>{const o=document.createElement("span"),r=Cn.renderToString(t.attrs.latex,{throwOnError:!1,displayMode:t.type.name==="math_block"});return o.innerHTML=r,o}))}),O.create(s.doc,e)}}}),As=new z("linkTooltip"),_s=36;class Ls{tooltipElement;button;onMouseLeave;constructor(e){this.tooltipElement=document.createElement("div"),this.tooltipElement.className=Se("absolute  py-1.5 px-2.5 bg-token-main-surface-primary border border-token-border-default rounded-lg text-xs z-50 items-center cursor-pointer shadow-md flex justify-center cursor-pointer","transform -translate-x-1/2"),this.button=document.createElement("button"),this.button.textContent="Open link",this.button.className=Se("bg-none","border-none","text-token-text-primary ","text-sm"),this.tooltipElement.appendChild(this.button),this.onMouseLeave=e,this.tooltipElement.addEventListener("mouseleave",e)}show(e,t,n){document.body.appendChild(this.tooltipElement),this.tooltipElement.style.left=`${e}px`,this.tooltipElement.style.top=`${t}px`;const o=()=>{window.open(n,"_blank"),this.hide()};this.button.addEventListener("click",o,{once:!0})}hide(){this.tooltipElement.parentNode&&this.tooltipElement.parentNode.removeChild(this.tooltipElement)}}function zs(){let s=null,e=null;const t=r=>{if(s==null||e==null)return!1;const i=Array.from(e.getClientRects()),a=s.tooltipElement.getBoundingClientRect();if(i.length===1){const c=i[0];return!He(r.clientX,r.clientY,qt([c,a]))}else return!Yt(r.clientX,r.clientY,[a,...i])},n=(r,i)=>{s&&(s.hide(),s=null);const a=r.getAttribute("href");if(!a)return;const c=Array.from(r.getClientRects()),l=c.find(p=>He(i.clientX,i.clientY,p))??c[0],u=l.left+l.width/2,d=l.top-_s;s=new Ls(p=>{t(p)&&o()}),s.show(u,d,a),e=r},o=()=>{s&&(s.hide(),s=null),e=null};return new L({key:As,props:{handleDOMEvents:{mousemove(r,i){const a=()=>{const{target:l}=i;if(!(l instanceof HTMLElement))return!1;const u=l.closest("a[href]");return u!=null&&u!==e?(n(u,i),!0):!1},c=()=>{s==null||!t(i)||o()};a()||c()}}},view:()=>({destroy:o})})}function Et(s){return se().serialize(s).length}const Hs=new z("maxLength"),Fs=(s,e,t)=>new L({key:Hs,state:{init(){return t},apply:()=>{}},filterTransaction(n){if(s==null||!n.steps.some(i=>i instanceof yn||i instanceof En?i.slice.size>i.to-i.from:!1))return!0;const r=Et(n.doc);return r<=t?!0:(e&&Te(e,s),G.logEvent("Canvas Prosemirror Max Length",{maxLength:t,newLength:r}),!1)}});function Us(s,e){const{state:t}=s,{selection:n}=t,o=n.content(),{schema:r}=t,i=r.topNodeType.create(null,o.content),a=Ks(i,s),c=t.doc.textBetween(n.from,n.to,`
`);e.clipboardData?.setData("application/x-prosemirror",c),e.clipboardData?.setData("text/plain",a),e.preventDefault()}function Ks(s,e){let t="";function n(o){if(o.type.name==="paragraph")return o.content.forEach(r=>{n(r)}),t+=`
`,!1;if(o.type.name==="contentReference"){const r=o.attrs.index,i=js(r,e);return i&&(t+=`[${i}]`),!1}else o.isText&&o.text!==void 0&&(t+=o.text);return!0}return s.descendants(n),t.endsWith(`
`)&&(t=t.slice(0,-1)),t}function js(s,e){const t=ut.getState(e.state),n=parseInt(s);if(t==null||n==null)return null;const o=t?.displayedContentReferences?.[n];return o==null||o.type!=="grouped_webpages"?null:o.items?.[0]?.url}class $s{dom;node;view;getPos;key;collectReactElement;constructor(e,t,n,o){this.node=e,this.getPos=n,this.view=t,this.dom=document.createElement("span"),this.dom.className="content-reference-node";const r=()=>`${Vt()}`;this.key=`content-reference-node-${r()}`,this.collectReactElement=o,this.renderReactComponent()}renderReactComponent(){const{index:e}=this.node.attrs,t=ut.getState(this.view.state);if(e==null)return;const n=t?.displayedContentReferences?.[e];if(!n||n.type!=="grouped_webpages")return;const o=ne.jsx(Qn,{webpageRef:n,trackContentReferenceEvent:()=>{},index:e}),r=Ot.createPortal(o,this.dom);this.collectReactElement(this.key,r)}update(e){return e.attrs!==this.node.attrs&&(this.node=e,this.renderReactComponent()),!0}destroy(){this.collectReactElement(this.key,null)}}function Gs(s={}){return new L({view(e){return new Ws(e,s)}})}class Ws{constructor(e,t){var n;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(n=t.width)!==null&&n!==void 0?n:1,this.color=t.color===!1?void 0:t.color||"black",this.class=t.class,this.handlers=["dragover","dragend","drop","dragleave"].map(o=>{let r=i=>{this[o](i)};return e.dom.addEventListener(o,r),{name:o,handler:r}})}destroy(){this.handlers.forEach(({name:e,handler:t})=>this.editorView.dom.removeEventListener(e,t))}update(e,t){this.cursorPos!=null&&t.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),t=!e.parent.inlineContent,n;if(t){let a=e.nodeBefore,c=e.nodeAfter;if(a||c){let l=this.editorView.nodeDOM(this.cursorPos-(a?a.nodeSize:0));if(l){let u=l.getBoundingClientRect(),d=a?u.bottom:u.top;a&&c&&(d=(d+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2),n={left:u.left,right:u.right,top:d-this.width/2,bottom:d+this.width/2}}}}if(!n){let a=this.editorView.coordsAtPos(this.cursorPos);n={left:a.left-this.width/2,right:a.left+this.width/2,top:a.top,bottom:a.bottom}}let o=this.editorView.dom.offsetParent;this.element||(this.element=o.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",t),this.element.classList.toggle("prosemirror-dropcursor-inline",!t);let r,i;if(!o||o==document.body&&getComputedStyle(o).position=="static")r=-pageXOffset,i=-pageYOffset;else{let a=o.getBoundingClientRect();r=a.left-o.scrollLeft,i=a.top-o.scrollTop}this.element.style.left=n.left-r+"px",this.element.style.top=n.top-i+"px",this.element.style.width=n.right-n.left+"px",this.element.style.height=n.bottom-n.top+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let t=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),n=t&&t.inside>=0&&this.editorView.state.doc.nodeAt(t.inside),o=n&&n.type.spec.disableDropCursor,r=typeof o=="function"?o(this.editorView,t,e):o;if(t&&!r){let i=t.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let a=kn(this.editorView.state.doc,i,this.editorView.dragging.slice);a!=null&&(i=a)}this.setCursor(i),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){(e.target==this.editorView.dom||!this.editorView.dom.contains(e.relatedTarget))&&this.setCursor(null)}}function de(s){return(e,t,n)=>{const{doc:o,selection:r}=e,{empty:i,$head:a}=r;if(i&&n?.endOfTextblock(s)){const c=s==="left"||s==="up"?-1:1,l=lt.near(o.resolve(c>0?a.after():a.before()),c);if(l.$head?.parent.type.name===Ie)return t?.(e.tr.setSelection(l)),!0}return!1}}const Xs=xe({ArrowLeft:de("left"),ArrowRight:de("right"),ArrowUp:de("up"),ArrowDown:de("down")}),we=new z("modelCursor");function qs(s,e){return s.setMeta(we,{modelCursor:e})}function Ys(s){return s.getMeta(we)??null}const ot=(s,e)=>{const{doc:t}=s,n=[];if(!e)return O.empty;const{modelSelectionPositionRange:o,modelCursorPosition:r}=e,{sourceRangeToPmRange:i,sourceEndToPmPos:a}=pe(t);if(r!=null){const c=Ee(r,a(r),"min");if(c==null)return O.empty;if(c!=null&&it(t,c)){const l=t.resolve(c);if(t.nodeAt(c)?.type.name===Xe.proseMirrorNodeName()||l.nodeBefore?.type.name===Xe.proseMirrorNodeName())return O.empty}n.push(Z.widget(c,()=>{const l=document.createElement("span");return l.className=Jt.modelCursor,l},{ignoreSelection:!0,side:1}))}else if(o!=null){const{start:c,end:l}=i(o),u=Ee(o.start,c,"max"),d=Ee(o.end,l,"min");if(u==null||d==null)return O.empty;n.push(Z.inline(u,d,{class:`${Qt} bg-[Highlight]!`}))}return n.length?O.create(t,n):O.empty},Js=(s,e)=>{let n=s.domAtPos(e)?.node;if(n===s.dom)return null;for(;n&&!(n instanceof HTMLElement);)n=n.parentNode;return n},Qs=(s,e)=>{Js(s,e.to)?.scrollIntoView({behavior:"smooth",block:"center"})},Zs=(s,e)=>{if(s&&!e)return!0;const t=s?.modelSelectionPositionRange?.start,n=e?.modelSelectionPositionRange?.start;return t!==void 0&&(n===void 0||t!==n)};function rt(s=void 0,e=void 0){return new L({key:we,state:{init:(t,n)=>({modelCursor:s,deco:ot(n,s),isNewCursor:!1,isCursorActive:e?.isCursorActive??!1}),apply:(t,n,o,r)=>{const a=Ys(t)?.modelCursor??n.modelCursor,c=ot(r,a),l=!!((!n.isCursorActive||Zs(a,n.modelCursor))&&c&&c.find()[0]),u=!!a&&(l||n.isCursorActive);return{modelCursor:a,deco:c,isNewCursor:l,isCursorActive:u}}},props:{decorations(t){return this.getState(t)?.deco}},view(t){return{update(n){const{deco:o,isNewCursor:r}=we.getState(n.state),i=o&&o.find()[0];i&&r&&Qs(n,i)}}}})}const kt="ignoreDocChange";function eo(s){return s.setMeta(kt,!0)}function to(s){return s.getMeta(kt)===!0}function no(s){const e=s.content.size-(s.lastChild?.content.size??0)-1;if(it(s,e))return X.create(s,e)}const Pt=({intl:s,toaster:e,value:t,comments:n,diff:o,maxLength:r=at,selection:i,onFocus:a,onBlur:c,onSave:l,safeUrls:u,modelCursor:d,isDisabled:p,prevState:h,contentRefereces:m,shouldUseContentReferencePlugin:M})=>{const S=se({shouldStripDirectives:p}),q=S.schema();let k=t;r!=null&&k.length>r&&(k=k.slice(0,r),e!=null&&s!=null&&Te(e,s,r));let y,P=[],V=[];o&&o.edits.length>0?{doc:y,addedRanges:P,deletedRanges:V}=bs({diff:o}):y=S.parse(k);const F=i?ws(y,i):no(y),v=()=>{const x=h?.plugins.find(B=>B.spec.key===Me().spec.key);return x==null||h==null?Me():Me({},x.getState(h))},N=x=>{const B=h?.plugins.find(C=>C.spec.key===rt().spec.key),w=h&&B?.getState(h);return rt(x,w)};return dt.create({doc:y,schema:q,selection:F,plugins:[...M?[Pn(m)]:[],Fs(s,e,r),S.inputRulesPlugin(),S.keymapPlugin(),xe({"Mod-s":()=>(l(),!0),"Mod-z":yt,"Mod-shift-z":Re,"Mod-y":Re}),Xs,Ns(),Gs(),Mn(),v(),Rs(a,c),ft(n??[]),...o?[cs(P,V)]:[],N(d),ss(new Set(u??[])),is(s,p),hs(h?re.getState(h).suggestion:null),zs(),...ds()]})},so=(s,e)=>{const t=se(),n=t.schema(),o=t.parse(s);return dt.create({doc:o,schema:n,plugins:[ft(e??[])]})},wo=({mount:s,value:e,comments:t,isDarkMode:n})=>new ht({mount:s},{editable:()=>!1,state:so(e,t),nodeViews:{[Ie]:(r,i,a)=>new Ve(r,i,a,n)}}),oo=(s,{intl:e,toaster:t,comments:n,value:o,maxLength:r=at,onBlur:i,onFocus:a,onChange:c,onUpdate:l,onSave:u,safeUrls:d,modelCursor:p,selection:h,isDisabled:m,diff:M,prevState:S,contentRefereces:q,collectReactElement:k},y=!1)=>{const P=pt(Ke()),V=Pt({intl:e,toaster:t,comments:n,value:o,maxLength:r,onBlur:i,onFocus:a,onSave:u,safeUrls:d,modelCursor:p,selection:h,isDisabled:m,diff:M,prevState:S,contentRefereces:q,collectReactElement:k,shouldUseContentReferencePlugin:P});l(V);const F=w=>{const C=B.state.apply(w);if(B.updateState(C),l(C),!w.docChanged||to(w))return;const g=gt(C);if(!g)return;const{doc:H}=C,{changeset:R}=g;c?.({transaction:w,changeset:R,doc:H,getSerializedDocument:()=>se().serialize(H),getAdjustedComments:()=>{const D=Zt(mt,C);if(D==null)return[];const Y=se(),U=Y.parse(Y.serialize(H)),A=en(U,D.positions);return tn(D.comments,A)}})},v=se(),x={...v.nodeViews(),...P?{[Dn]:(w,C,g)=>new $s(w,C,g,k)}:{},...M!=null?{}:{[Ie]:(w,C,g)=>new Ve(w,C,g,y)}},B=new ht({mount:s},{state:V,editable:()=>!m,dispatchTransaction:F,nodeViews:x,...P?{handleDOMEvents:{copy:(w,C)=>Us(w,C)}}:{},handlePaste(w,C){const H=In(Ke()).checkGate("4242210007");let R;if(P&&(R=C.clipboardData?.getData("application/x-prosemirror")),R||=C.clipboardData?.getData("text/plain"),R==null)return!1;G.logEvent("Canvas Prosemirror Paste",{textLength:R.length});const D=Et(w.state.doc),Y=D+R.length,U=r!=null&&Y>r;U&&t!=null&&e!=null&&Te(t,e,r);const A=C.clipboardData?.getData("text/html");if(H&&A){const T=ro(A),I=new window.DOMParser().parseFromString(T,"text/html"),J=Sn.fromSchema(w.state.schema).parse(I.body),ee=new vn(J.content,1,1);return w.dispatch(w.state.tr.replaceSelection(ee)),!0}let _=R;if(U){const I=r-D-50;_=I>0?R.slice(0,I):""}return bn(w,_,P),!0}});return{view:B,pmu:v}},ro=s=>s.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3");function io(s,e){const t=e.target;if(t instanceof Element&&[fe.PROSEMIRROR_EDITOR_CONTAINER,fe.PROSEMIRROR_CONTEXT_CHILDREN].some(c=>t.closest(`#${c}`)!=null))return!1;s.focus();const n=un(s.dom.getBoundingClientRect(),{x:e.clientX,y:e.clientY}),o=s.state.tr,r=s.posAtCoords({left:n.x,top:n.y});if(r!=null){const i=Math.min(r.pos,dn(s.state.doc)-1);o.setSelection(new X(o.doc.resolve(i))),s.dispatch(o)}return!0}const Mt=({editorRef:s,wrapperClassName:e,transparentBackground:t=!1,comments:n,commentingOn:o,diff:r,paddingBottom:i,hoveredCommentId:a,focusedCommentId:c,hoveredEditId:l,rejectedEdits:u,showChanges:d,isDisabled:p=!1,value:h,onBlur:m,onFocus:M,onChange:S,onMouseLeave:q,onSave:k,getAutocompleteSuggestion:y,safeUrls:P,children:V,width:F,modelCursor:v,shouldResetSelection:N=!1,contentRefereces:x})=>{const B=Bt(),w=On(),C=E.useRef(null),g=E.useRef(null),[H,R]=E.useState(null),D=Vn(),Y=Bn(),[{width:U},A]=nn(),_=E.useRef(m);_.current=m;const T=E.useRef(M);T.current=M;const I=fs(g,y),J=Nn(),ee=async f=>{S?.(f),pn(J)&&I(f.getSerializedDocument)},ie=E.useRef(ee);ie.current=ee;const Ce=E.useRef(k);Ce.current=k;const ce=pt(J),[bt,Rt]=E.useState(()=>new Map),ye=E.useCallback((f,b)=>{Rt(K=>{const j=new Map(K);return b==null?j.delete(f):j.set(f,b),j})},[]),Be=E.useCallback((f=h)=>Pt({intl:B,toaster:w,comments:n,diff:r,value:f,selection:N?void 0:g.current?.state.selection,onBlur:b=>_.current?.(b),onFocus:b=>T.current?.(b),onSave:()=>Ce.current?.(),modelCursor:v,isDisabled:p,safeUrls:P,prevState:H,contentRefereces:x,collectReactElement:ye,shouldUseContentReferencePlugin:ce}),[B,w,n,r,h,N,v,p,P,H,x,ye,ce]),Tt=E.useCallback(f=>{const b=Be(f);g.current?.updateState(b),R(b)},[Be]);E.useImperativeHandle(s,()=>({UNSAFE_setValue:Tt,revertChanges:()=>{if(g.current==null)throw new Error("Tried to call revertChanges, but viewRef.current is null");us(g.current)},flushChanges:()=>{if(g.current==null)throw new Error("Tried to call flushChanges, but viewRef.current is null");ls(g.current)},maybeFocusOnEditor:f=>{if(g.current==null)throw new Error("Tried to call maybeFocus, but viewRef.current is null");return io(g.current,f)},viewRef:g})),An(()=>{const{current:f}=C;if(!f)return;const{view:b}=oo(f,{intl:B,toaster:w,comments:n,diff:r,value:h,onBlur:K=>_.current?.(K),onFocus:K=>T.current?.(K),onChange:K=>ie.current?.(K),onUpdate:R,onSave:()=>Ce.current?.(),isDisabled:p,safeUrls:P,prevState:H,contentRefereces:x,collectReactElement:ye,shouldUseContentReferencePlugin:ce},D);return g.current=b,()=>{b?.destroy()}},[r]),E.useEffect(()=>{g.current?.setProps({editable:()=>!p})},[p]),te(f=>os(f,p),g,[p]),te(f=>{if(!Y)return;const{schema:b}=f.doc.type,K=b.nodes.code_block;return K?(f.doc.descendants((j,_e)=>{if(j.type===K){const Dt=j.type.create({...j.attrs,isDarkMode:D},j.content,j.marks);f.replaceWith(_e,_e+j.nodeSize,Dt)}}),eo(f)):f},g,[Y,D]),te(f=>f.setMeta(be,d),g,[d]),te(f=>qs(f,v),g,[v]),te(f=>f.setMeta(mt,{comments:n,commentingOn:o,hoveredCommentId:a,focusedCommentId:c}),g,[n,a,c,o]),te(f=>f.setMeta(ve,{hoveredEditId:l,rejectedEdits:u??new Set}),g,[l,u]),te(f=>ts(f,new Set(P??[])),g,[P]);const xt=E.useCallback(()=>g.current,[g]),Ne=[],Ae=[];return E.Children.forEach(V,f=>{if(!E.isValidElement(f))return;const{type:b}=f;if(b===vt)Ne.push(f);else if(b===St)Ae.push(f);else throw new Error("Invalid Prosemirror child: "+JSON.stringify(b))}),ne.jsx(sn.Provider,{value:xt,children:ne.jsx(on.Provider,{value:H,children:ne.jsxs(rn.Provider,{value:U,children:[ne.jsx("div",{id:fe.PROSEMIRROR_CONTEXT_CHILDREN,children:Ne}),ne.jsxs("div",{className:e,onMouseLeave:q,id:fe.PROSEMIRROR_EDITOR_CONTAINER,style:{paddingBottom:i},children:[ne.jsx("div",{ref:an(C,A),className:Se(cn.main,ln.composer,"markdown prose dark:prose-invert contain-inline-size focus:outline-hidden",t?"bg-transparent":"bg-token-main-surface-primary"),style:{width:F}}),Ae,ce?Array.from(bt.values()):null]})]})})})},St=({children:s})=>s,vt=({children:s})=>s;Mt.EditorChildren=St;Mt.ContextChildren=vt;export{Mt as P,so as a,wo as c};
//# sourceMappingURL=c7zwb9p0mkhdhxup.js.map

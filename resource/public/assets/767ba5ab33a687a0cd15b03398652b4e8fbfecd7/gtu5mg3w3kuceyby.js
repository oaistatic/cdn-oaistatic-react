import{r as t,u as k,j as d}from"./j12so9ru57hpoz1y.js";import{R as _,aQ as W,gM as T,B as D,a as A,c_ as F,P as j,aw as U,cU as L,cu as I}from"./j5zd9vs1l0bwsjqa.js";import{u as B}from"./mpl7u7azbwm9upe9.js";import{da as N,db as P,d9 as G}from"./jn7p98x7qxquz26a.js";class O{static async transcribe(r,e){const c=new FormData;return c.append("file",r),e&&c.append("language",e),_.post(`${W}/transcribe`,c)}}const V=48e3,q=10,C=V*q,z=4e3,H=10*60*1e3,p=u=>B.setState(r=>{r.status=u}),X=u=>{const r=t.useRef(u);r.current=u;const e=t.useRef(null),c=t.useRef([]),w=t.useRef(null),x=t.useRef(null),g=t.useRef(null),n=t.useRef(new Float32Array(0)),f=t.useRef(null),s=t.useCallback(()=>{n.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),m=t.useCallback(async o=>{p("transcribing");try{const h=await O.transcribe(new File([o],"whisper.mp3",{type:"audio/mpeg-3"}));p("idle"),r.current.onSuccess(h.text),s()}catch{p("error"),s()}},[s]),a=t.useCallback(o=>{f.current!==null&&(clearTimeout(f.current),f.current=null),o&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,p("idle"),s()),e.current?.stop(),e.current?.stream.getTracks().forEach(h=>h.stop()),e.current=null,g.current?.disconnect(),g.current=null,x.current?.disconnect(),x.current=null,w.current?.close(),w.current=null},[s]),M=t.useCallback(()=>{s(),p("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:z,channelCount:1}}).then(o=>{e.current=new MediaRecorder(o),T()?(c.current=[],e.current.ondataavailable=l=>{l.data.size>0&&c.current.push(l.data)},e.current.onstop=async()=>{const l=new Blob(c.current,{type:"audio/mpeg-3"});await m(l)},e.current.start(1e3)):(e.current.ondataavailable=async l=>{await m(l.data)},e.current.start()),n.current=new Float32Array(C).fill(r.current.initialValue),r.current.onWaveformDataUpdate(n.current),p("recording"),f.current=window.setTimeout(()=>{a()},H);const R=new AudioContext;w.current=R;const y=R.createMediaStreamSource(o);x.current=y;const i=R.createScriptProcessor(2048,1,1);g.current=i,i.onaudioprocess=l=>{const v=l.inputBuffer.getChannelData(0);for(let S=0;S<v.length;S++)v[S]=Math.max(v[S],r.current.initialValue);const E=n.current,b=new Float32Array(E.length+v.length);if(b.set(E,0),b.set(v,E.length),b.length>C){const S=b.length-C;n.current=b.slice(S)}else n.current=b;r.current.onWaveformDataUpdate(n.current)},y.connect(i),i.connect(R.destination)}).catch(()=>{p("error"),s()})},[s,a,m]);return t.useEffect(()=>()=>{a(!0)},[a]),{startRecording:M,stopRecording:a}};function K({disabled:u=!1,size:r="small",initialValue:e,onSuccess:c,onWaveformDataUpdate:w,onExit:x,buttonClassName:g}){const n=k(),f=B(i=>i.status),s=t.useRef(!1),{startRecording:m,stopRecording:a}=X({onSuccess:c,onWaveformDataUpdate:w,initialValue:e});t.useEffect(()=>{const i=()=>{document.hidden&&a()};return window.addEventListener("visibilitychange",i),()=>{window.removeEventListener("visibilitychange",i),a()}},[a]),t.useEffect(()=>{s.current||(m(),s.current=!0)},[m]);const M=d.jsx("div",{children:d.jsx(D,{"aria-label":n.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),size:r,type:"button",onClick:()=>{a(!0),x()},disabled:u||f==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:A(N,u?"opacity-30":P,g),children:d.jsx(F,{"aria-label":n.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"h-[18px] w-[18px] text-black dark:text-white",fontSize:"inherit"})})}),o=f==="transcribing",h=o?d.jsx(L,{}):d.jsx(I,{className:"icon-lg"}),R=o?n.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):n.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),y=d.jsx("div",{children:d.jsx("button",{type:"button","aria-label":R,className:A(G,g),onClick:()=>{j.logEvent("Whisper on Web/Windows: Clicked to end dictation"),U.logEvent("chatgpt_composer_whisper_button_clicked_end"),a()},children:h})});return d.jsxs("div",{className:"flex gap-x-1.5",children:[M,y]})}export{K as WhisperModeControls};
//# sourceMappingURL=gtu5mg3w3kuceyby.js.map

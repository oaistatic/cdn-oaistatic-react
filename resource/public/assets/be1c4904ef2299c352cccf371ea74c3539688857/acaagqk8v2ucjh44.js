import{r as t,e as k,j as d}from"./fs6h2trisr1juto6.js";import{R as _,as as T,dy as W,c4 as D,d as A,c6 as F,P as j,a as L,S as N,cp as P,d6 as U}from"./cyi7nanrg0vdotzd.js";import{u as B}from"./twfcf5t51x04u1vc.js";import{cy as I,cz as z,h4 as G}from"./df9u9imhvwerk6zv.js";class O{static async transcribe(r,e){const c=new FormData;return c.append("file",r),e&&c.append("language",e),_.post(`${T}/transcribe`,c)}}const V=48e3,q=10,C=V*q,H=4e3,X=10*60*1e3,p=u=>B.setState(r=>{r.status=u}),Z=u=>{const r=t.useRef(u);r.current=u;const e=t.useRef(null),c=t.useRef([]),w=t.useRef(null),v=t.useRef(null),g=t.useRef(null),n=t.useRef(new Float32Array(0)),f=t.useRef(null),s=t.useCallback(()=>{n.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),m=t.useCallback(async o=>{p("transcribing");try{const h=await O.transcribe(new File([o],"whisper.mp3",{type:"audio/mpeg-3"}));p("idle"),r.current.onSuccess(h.text),s()}catch{p("error"),s()}},[s]),a=t.useCallback(o=>{f.current!==null&&(clearTimeout(f.current),f.current=null),o&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,p("idle"),s()),e.current?.stop(),e.current?.stream.getTracks().forEach(h=>h.stop()),e.current=null,g.current?.disconnect(),g.current=null,v.current?.disconnect(),v.current=null,w.current?.close(),w.current=null},[s]),E=t.useCallback(()=>{s(),p("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:H,channelCount:1}}).then(o=>{e.current=new MediaRecorder(o),W()?(c.current=[],e.current.ondataavailable=l=>{l.data.size>0&&c.current.push(l.data)},e.current.onstop=async()=>{const l=new Blob(c.current,{type:"audio/mpeg-3"});await m(l)},e.current.start(1e3)):(e.current.ondataavailable=async l=>{await m(l.data)},e.current.start()),n.current=new Float32Array(C).fill(r.current.initialValue),r.current.onWaveformDataUpdate(n.current),p("recording"),f.current=window.setTimeout(()=>{a()},X);const R=new AudioContext;w.current=R;const y=R.createMediaStreamSource(o);v.current=y;const i=R.createScriptProcessor(2048,1,1);g.current=i,i.onaudioprocess=l=>{const x=l.inputBuffer.getChannelData(0);for(let b=0;b<x.length;b++)x[b]=Math.max(x[b],r.current.initialValue);const M=n.current,S=new Float32Array(M.length+x.length);if(S.set(M,0),S.set(x,M.length),S.length>C){const b=S.length-C;n.current=S.slice(b)}else n.current=S;r.current.onWaveformDataUpdate(n.current)},y.connect(i),i.connect(R.destination)}).catch(()=>{p("error"),s()})},[s,a,m]);return t.useEffect(()=>()=>{a(!0)},[a]),{startRecording:E,stopRecording:a}};function Y({disabled:u=!1,size:r="small",initialValue:e,onSuccess:c,onWaveformDataUpdate:w,onExit:v,buttonClassName:g}){const n=k(),f=B(i=>i.status),s=t.useRef(!1),{startRecording:m,stopRecording:a}=Z({onSuccess:c,onWaveformDataUpdate:w,initialValue:e});t.useEffect(()=>{const i=()=>{document.hidden&&a()};return window.addEventListener("visibilitychange",i),()=>{window.removeEventListener("visibilitychange",i),a()}},[a]),t.useEffect(()=>{s.current||(m(),s.current=!0)},[m]);const E=d.jsx("div",{children:d.jsx(D,{"aria-label":n.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),size:r,type:"button",onClick:()=>{a(!0),v()},disabled:u||f==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:A(I,u?"opacity-30":z,g),children:d.jsx(F,{"aria-label":n.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"h-[18px] w-[18px] text-black dark:text-white",fontSize:"inherit"})})}),o=f==="transcribing",h=o?d.jsx(P,{}):d.jsx(U,{className:"icon-lg"}),R=o?n.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):n.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),y=d.jsx("div",{children:d.jsx("button",{type:"button","aria-label":R,className:A(G,g),onClick:()=>{j.logEvent(L.composerWhisperButtonClickedEnd),N.logEvent("chatgpt_composer_whisper_button_clicked_end"),a()},children:h})});return d.jsxs("div",{className:"flex gap-x-1.5",children:[E,y]})}export{Y as WhisperModeControls};
//# sourceMappingURL=acaagqk8v2ucjh44.js.map

import{r as t,f as L,af as N,j as h}from"./n3epq09dut36rmi2.js";import{jK as U,d4 as _,d5 as j,jL as q}from"./uox23aig6gp6se2y.js";import{at as F,bR as I,bN as P,gG as z,c as B,aj as G,aO as O,W as $}from"./nqrmgk5te3uzwsyz.js";import{u as T}from"./jd7yzda1iudpei56.js";function y(o,r){return e=>{F.addAction(`${o}.${r}`,e)}}function H(o){return(r,e)=>{F.addError(r,{...e,name:o,status:"error"})}}const g={recording:{start:y("whisper-recording","start"),cancel:y("whisper-recording","cancel"),submit:y("whisper-recording","submit")},transcription:{request:y("whisper-transcription","request"),transcriptDelivered:y("whisper-transcription","transcriptDelivered"),error:H("whisper-transcription"),requestSuccess:y("whisper-transcription","requestSuccess")}};class V{static async transcribe(r,e,R={}){const l=new FormData;l.append("file",r),e&&l.append("language",e);const i={durationMs:R.durationMs,language:e,fileSize:r.size},d=performance.now();return g.transcription.request(i),I.post(`${P}/transcribe`,l).then(n=>{const s=performance.now()-d;return g.transcription.requestSuccess({...i,durationMs:s}),n}).catch(n=>{const s=performance.now()-d;throw g.transcription.error(n,{...i,durationMs:s}),n})}}const X=48e3,K=10,D=X*K,Z=4e3,J=10*60*1e3,S=o=>T.setState(r=>{r.status=o}),Q=o=>{const r=t.useRef(o);r.current=o;const e=t.useRef(null),R=t.useRef([]),l=t.useRef(null),i=t.useRef(null),d=t.useRef(null),n=t.useRef(new Float32Array(0)),s=t.useRef(null),b=t.useRef(null),v=t.useRef(!1),c=t.useCallback(()=>{n.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),M=t.useCallback(async(p,u)=>{S("transcribing");try{const a=await V.transcribe(new File([p],"whisper.mp3",{type:"audio/mpeg-3"}),void 0,{durationMs:u});S("idle"),g.transcription.transcriptDelivered({durationMs:u,transcriptLength:a.text.length}),r.current.onSuccess(a.text),c()}catch(a){S("error"),g.transcription.error(a,{durationMs:u}),c()}},[c]),w=t.useCallback(p=>{if(!v.current)return;v.current=!1,b.current!==null&&(clearTimeout(b.current),b.current=null);const u=s.current!=null?performance.now()-s.current:void 0;p&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,S("idle"),c(),g.recording.cancel({durationMs:u}),s.current=null),e.current?.stop(),e.current?.stream.getTracks().forEach(a=>a.stop()),e.current=null,d.current?.disconnect(),d.current=null,i.current?.disconnect(),i.current=null,l.current?.close(),l.current=null,p||g.recording.submit({durationMs:u})},[c]),A=t.useCallback(()=>{c(),S("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:Z,channelCount:1}}).then(p=>{s.current=performance.now(),g.recording.start(),e.current=new MediaRecorder(p);const u=z();v.current=!0,u?(R.current=[],e.current.ondataavailable=m=>{m.data.size>0&&R.current.push(m.data)},e.current.onstop=async()=>{const m=new Blob(R.current,{type:"audio/mpeg-3"}),f=s.current!=null?performance.now()-s.current:void 0;await M(m,f)},e.current.start(1e3)):(e.current.ondataavailable=async m=>{const f=s.current!=null?performance.now()-s.current:void 0;await M(m.data,f)},e.current.start()),n.current=new Float32Array(D).fill(r.current.initialValue),r.current.onWaveformDataUpdate(n.current),S("recording"),b.current=window.setTimeout(()=>{w()},J);const a=new AudioContext;l.current=a;const C=a.createMediaStreamSource(p);i.current=C;const W=a.createScriptProcessor(2048,1,1);d.current=W,W.onaudioprocess=m=>{const f=m.inputBuffer.getChannelData(0);for(let E=0;E<f.length;E++)f[E]=Math.max(f[E],r.current.initialValue);const k=n.current,x=new Float32Array(k.length+f.length);if(x.set(k,0),x.set(f,k.length),x.length>D){const E=x.length-D;n.current=x.slice(E)}else n.current=x;r.current.onWaveformDataUpdate(n.current)},C.connect(W),W.connect(a.destination)}).catch(()=>{S("error"),c(),g.recording.cancel()})},[c,w,M]);return t.useEffect(()=>()=>{w(!0)},[w]),{startRecording:A,stopRecording:w}};function ne({disabled:o=!1,initialValue:r,onSuccess:e,onWaveformDataUpdate:R,onExit:l,buttonClassName:i,visualTreatment:d}){const n=L(),s=T(C=>C.status),b=t.useRef(!1),{startRecording:v,stopRecording:c}=Q({onSuccess:e,onWaveformDataUpdate:R,initialValue:r}),M=N();t.useEffect(()=>()=>{c()},[c]),t.useEffect(()=>{b.current||(v(),b.current=!0)},[v]),t.useEffect(()=>{M.state!=="idle"&&c()},[M.state,c]);const w=h.jsx("div",{children:h.jsx("button",{"aria-label":n.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:()=>{c(!0),l()},disabled:o||s==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:B(d==="composer-btn"?"composer-btn":B(_,o?"opacity-30":j,i)),children:h.jsx(U,{"aria-label":n.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"h-[18px] w-[18px]",fontSize:"inherit"})})}),A=s==="transcribing",p=A?h.jsx($,{}):h.jsx(q,{className:"icon-lg"}),u=A?n.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):n.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),a=h.jsx("div",{children:h.jsx("button",{type:"button","aria-label":u,disabled:o,className:d==="composer-btn"?"composer-btn":B(_,o?"opacity-30":j,i),onClick:()=>{G.logEvent("Whisper on Web/Windows: Clicked to end dictation"),O.logEvent("chatgpt_composer_whisper_button_clicked_end"),c()},children:p})});return h.jsxs("div",{className:"flex gap-x-1.5",children:[w,a]})}export{ne as WhisperModeControls};
//# sourceMappingURL=elzkmszcvys74iv2.js.map

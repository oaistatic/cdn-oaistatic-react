import{f as K,j as e,g as B,r as F,M as p,p as ve,v as Me}from"./n3epq09dut36rmi2.js";import{B as y,F as w,aX as be,bc as we,aL as ie,dh as Ne,af as Pe,gE as Se,al as ke,c3 as Te,cs as ne,aa as ze,aY as Ae,k as Ce}from"./nqrmgk5te3uzwsyz.js";import{he as Ie,a2 as Fe,jB as De,ek as Ee,e3 as Be,jC as Le,Q as Ve,bI as re,i6 as D,i7 as Oe,cA as Re,jD as le,fv as Ge,jE as $e}from"./uox23aig6gp6se2y.js";import{T as k,a as Je}from"./iwi9e9tak1je4ys9.js";import"./e4sjbad9hyqt73xe.js";import"./dkr8jkx9n88ez7ho.js";import"./nnldvg4yjd3ynnqu.js";const We=w.div`h-px bg-token-border-default`,_=w.div`text-sm font-medium py-3 leading-6`,Ue=w.div`my-4 p-5 w-full rounded-2xl popover bg-token-main-surface-primary shadow-lg border border-token-border-default`,J=":",Ke=({to:t,cc:s,bcc:n,subject:i,body:a,onClick:l,isDraft:o=!0,isCanceled:m=!1})=>{const r=K(),c=[];return t&&c.push(e.jsx("div",{children:e.jsxs("div",{className:"flex",children:[e.jsxs(_,{className:"text-token-text-tertiary me-1",children:[r.formatMessage(M.draftToFieldLabel),J]}),e.jsx(_,{children:t})]})},"to")),s&&c.push(e.jsx("div",{children:e.jsxs("div",{className:"flex",children:[e.jsxs(_,{className:"text-token-text-tertiary me-1",children:[r.formatMessage(M.draftCcFieldLabel),J]}),e.jsx(_,{children:s})]})},"cc")),n&&c.push(e.jsx("div",{children:e.jsxs("div",{className:"flex",children:[e.jsxs(_,{className:"text-token-text-tertiary me-1",children:[r.formatMessage(M.draftBccFieldLabel),J]}),e.jsx(_,{children:n})]})},"bcc")),i&&c.push(e.jsx(_,{children:i},"subject")),a&&c.push(e.jsx(_,{className:"whitespace-pre-line",children:a},"body")),e.jsxs(Ue,{children:[e.jsxs("div",{className:"mb-4 flex items-center",children:[e.jsx(Ie,{className:"icon-sm me-4"}),e.jsx("div",{className:"font-semibold",children:o?r.formatMessage(M.draftMessageLabel):r.formatMessage(M.sentMessageLabel)})]}),c.map((v,j)=>e.jsxs(F.Fragment,{children:[e.jsx(We,{}),v]},j)),o&&!m&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(y,{color:"primary",className:"py-2",onClick:l,children:r.formatMessage(M.sendButton)})}),m&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(y,{color:"primary",className:"py-2",disabled:!0,children:r.formatMessage(M.canceledButton)})})]})},M=B({draftMessageLabel:{id:"emailView.draftMessageLabel",defaultMessage:"Draft Message"},sentMessageLabel:{id:"emailView.sentMessageLabel",defaultMessage:"Sent Message"},sendButton:{id:"emailView.sendButton",defaultMessage:"Send"},draftToFieldLabel:{id:"emailView.draftToLabel",defaultMessage:"To"},draftCcFieldLabel:{id:"emailView.draftCcLabel",defaultMessage:"Cc"},draftBccFieldLabel:{id:"emailView.draftBccLabel",defaultMessage:"Bcc"},canceledButton:{id:"emailView.canceledButton",defaultMessage:"Canceled"}});function Qe({action:t,handleUserAction:s,userActionParams:n,displayParams:i}){return t.type==="deny"?e.jsx(y,{color:"secondary",size:"small",onClick:a=>{s({sourceEvent:a,...n,actionData:{type:"deny",...t.deny}})},children:e.jsx(p,{...t.name==="decline"?b.decline:b.deny})}):t.type==="allow"?e.jsx(y,{color:"primary",size:"small",onClick:a=>{s({sourceEvent:a,...n,actionData:{type:"allow",...t.allow}})},children:e.jsx(p,{...t.name==="allow"?b.allow:b.confirm})}):t.type==="always_allow"?e.jsx(y,{color:"secondary",size:"small",onClick:a=>{s({sourceEvent:a,...n,actionData:{type:"always_allow",...t.always_allow}})},children:e.jsx(p,{...b.alwaysAllow})}):t.type==="oauth_redirect"?e.jsx(y,{color:"primary",size:"small",onClick:()=>{Ye(t.oauth_redirect,n.clientThreadId,n.turnGizmo)},children:e.jsx(p,{...b.signInButton,values:{domain:i.domain}})}):t.type==="contact_gizmo"?e.jsx(y,{color:"secondary",size:"small",onClick:a=>{s({sourceEvent:a,...n,actionData:{type:"contact_gizmo",...t.contact_gizmo}})},children:e.jsx(p,{...b.allow})}):null}async function Ye(t,s,n){const i=be(s),a=we(s),l=i?.mode?.kind===ie.GizmoTest,o=a&&!l?Fe(a,n):window.location.href;t.gizmo_id==="FAKE_PLUGIN_GIZMO"?De({id:t.gizmo_action_id},o):Ee.doOAuthRedirect(t.gizmo_id,t.gizmo_action_id,t.domain,o,l)}const b=B({alwaysAllow:{id:"jitPluginMessage.alwaysAllow",defaultMessage:"Always Allow"},allow:{id:"jitPluginMessage.allow",defaultMessage:"Allow"},decline:{id:"jitPluginMessage.decline",defaultMessage:"Decline"},confirm:{id:"jitPluginMessage.confirm",defaultMessage:"Confirm"},deny:{id:"jitPluginMessage.deny",defaultMessage:"Deny"},signInButton:{id:"jitPluginMessage.signInButton",defaultMessage:"Sign in with {domain}"}}),qe=w.div`h-px bg-token-border-default`,te=w.div`text-sm font-medium py-3 leading-6`,Ze=w.div`my-4 p-5 w-full rounded-2xl popover bg-token-main-surface-primary shadow-lg border border-token-border-default`,He=":",Xe=({functionName:t,parameters:s,onClick:n,isDraft:i=!0,isCanceled:a=!1})=>{const l=K(),o=Object.entries(s).filter(([m,r])=>!r||m==="timezone_str"&&r===Intl.DateTimeFormat().resolvedOptions().timeZone?!1:r.length>0);return e.jsxs(Ze,{children:[e.jsx("div",{className:"mb-4 flex items-center font-semibold",children:e.jsx("div",{children:i?U(t):et(t,l)})}),o.map(([m,r])=>e.jsxs("div",{children:[e.jsx(qe,{}),e.jsxs("div",{className:"flex",children:[e.jsxs(te,{className:"text-token-text-tertiary me-1",children:[U(m),He]}),e.jsx(te,{className:"whitespace-pre-line",children:oe(r,l)})]})]},m)),i&&!a&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(y,{color:"primary",className:"py-2",onClick:n,children:l.formatMessage(E.approveButton)})}),a&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(y,{color:"primary",className:"py-2",disabled:!0,children:l.formatMessage(E.canceledButton)})})]})},et=(t,s)=>{switch(t){case"create_event":return"Created Event ✅";default:return`${U(t)} ${s.formatMessage(E.completedAction)} ✅`}},U=t=>{switch(t){case"timezone_str":return"Timezone";default:return t.split("_").map(s=>s.charAt(0).toUpperCase()+s.slice(1).toLowerCase()).join(" ")}},oe=(t,s)=>{if(Array.isArray(t))return t.map(a=>oe(a,s)).join(s.formatMessage(E.valueSeparator));if(typeof t=="object")return JSON.stringify(t);if(t.match(/^\s*\d{4}-\d{2}-\d{2}/)==null)return t;const i=new Date(t);return Number.isNaN(i.getTime())?t:s.formatDate(i,{weekday:"short",month:"short",day:"numeric",hour:"numeric",minute:"numeric"})},E=B({approveButton:{id:"ParametersView.approveButton",defaultMessage:"Approve"},completedAction:{id:"ParametersView.completedAction",defaultMessage:"Completed"},canceledButton:{id:"ParametersView.canceledButton",defaultMessage:"Canceled"},valueSeparator:{id:"ParametersView.valueSeparator",defaultMessage:","}}),A="openaiFileIdRefs",tt=["send_email","batch_modify_email","create_event","update_event","delete_event"];function ht({messages:t,clientThreadId:s,isLastTurnInConversation:n,onRequestCompletion:i}){const[a,l]=ve(),[o,...m]=t,r=K(),c=Be(),v=Ne(s),j=o.metadata?.gizmo_id??v,T=Pe(s,d=>$e(d?.mode,j)),ce=Le(T)&&T.gizmo_id===j,z=Ve(j,ce)?.data,[me,ue]=F.useState(!1),Y=Se(o.recipient);let L;if(Y?.functionName!=null&&z?.tools!=null){for(const d of z.tools)if(nt(d,Y.functionName)){L=d;break}}const fe=m.filter(d=>d.metadata?.jit_plugin_data?.from_server?.type==="debug"),V=m.filter(d=>!["debug","send_test"].some(f=>f===d.metadata?.jit_plugin_data?.from_server?.type)),{uiState:u,jitPluginData:g,fileAttachments:ge,invokedPlugin:q}=it(o,V,n);let O;for(let d=V.length-1;d>=0;d--){const f=V[d].metadata?.jit_plugin_data;if(f?.from_server?.type==="confirm_action"){O=f;break}}let h=g?.from_server?.type!=="denied_by_user"?g?.from_server?.body.domain:L?.metadata?.domain;h?h.endsWith("__jit_plugin")&&(h=h.slice(0,-12)):h="connector";const Z=L?.metadata?.privacy_policy_url;F.useEffect(()=>{if(de(g?.from_client)?.type==="oauth_success")return;const d=a.get("oauth_success");if(g?.from_server?.type==="oauth_required"&&d){for(const f of g.from_server.body.actions)if(f.type==="oauth_redirect"){W({eventSource:"url",assistantMessage:o,onRequestCompletion:i,actionData:{type:"oauth_success",target_message_id:f.oauth_redirect.target_message_id},conversationMode:T});return}l(f=>(f.delete("oauth_success"),f),{replace:!0})}},[T,o,t,s,i,g,n,a,l]);let N=k.Running,P=h?x.running:x.starting,R={domain:h},C=null;if(u===7)return null;if(u===4||u===5){N=k.Paused,P=x.confirmingSimple;const d={gizmoName:z?.gizmo.display.name??"ChatGPT",domain:h};C=r.formatMessage(x.confirmParamsTitle,d),R={...d,title:f=>e.jsxs("div",{className:"inline-flex items-center gap-1 text-sm",children:[f,e.jsx(re,{className:"icon-sm"})]}),subtitle:f=>e.jsx("div",{className:"text-xs",children:f})}}else u===1?(N=k.Finished,P=x.finished,C=r.formatMessage(x.sentParamsTitle,{gizmoName:z?.gizmo.display.name??"ChatGPT",domain:h}),R={domain:h}):u===2?(N=k.Error,P=x.error):(u===3||u===6)&&(N=k.Stopped,P=u===6?x.declined:x.stopped);const H={assistantMessage:o,allMessages:t,clientThreadId:s,turnGizmo:z,onRequestCompletion:i,conversationMode:T},pe={domain:h},G=g?.from_server?.type!=="denied_by_user"?g?.from_server?.body.actions.map((d,f)=>e.jsx(Qe,{action:d,displayParams:pe,handleUserAction:W,userActionParams:H},f)):null,xe=P?r.formatMessage(P,R):null,he=w.div`flex gap-2 flex-wrap mt-1 empty:hidden`,X=g?Q(g):null,dt=X?.[A]??[],je=!!X;let I=e.jsx(e.Fragment,{});const $=se(g,q)||se(O,void 0)||"";if(tt.includes($)&&(u===5||u===1||u===3||u===6)){const d=u!==1,f=(u===3||u===6)&&!n,S=ae(g,q)??ae(O,void 0),ee=ye=>{g?.from_server?.type==="confirm_action"&&g?.from_server?.body?.actions?.[0].type==="allow"&&(W({...H,sourceEvent:ye,actionData:{type:"allow",...g?.from_server?.body?.actions?.[0].allow}}),Ae(s,_e=>{_e.scrollToMessageId=s}))};switch($){case"send_email":I=e.jsx(Ke,{to:S?.to,cc:S?.cc,bcc:S?.bcc,subject:S?.subject,body:S?.body,onClick:u===5?ee:()=>{},isDraft:d,isCanceled:f});break;default:I=e.jsx(Xe,{functionName:$??"",parameters:S??{},onClick:u===5?ee:()=>{},isDraft:d,isCanceled:f});break}}else(u===5||u===4)&&G&&!c&&(I=e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2 flex gap-2",children:G}),e.jsxs("div",{className:"my-1 flex items-center gap-2 text-sm",children:[e.jsx(ke,{className:"icon-sm"}),e.jsx(p,{...x.confirmingSubtitle})]})]}));return e.jsxs(e.Fragment,{children:[e.jsx(at,{debugMessages:fe}),e.jsx(Je,{highlightedCommand:xe,status:N,showWorkUserSetting:!1,children:je?e.jsx(rt,{privacyPolicyUrl:Z,data:g,isPromptingForPermission:N===k.Paused}):null}),e.jsx(he,{children:ge?.map(d=>e.jsx(D,{file:d.name,fileId:d.id,width:"wide",alwaysShowData:!0,showDownloadButton:!0,downloadLink:d.download_url,contextConnectorInfo:Oe(d.context_connector_info)},d.id))}),I,C!==null&&e.jsx(ot,{title:C,privacyPolicyUrl:Z,data:g,onClose:()=>ue(!1),isOpen:me,actionButtons:G})]})}function st({messageMetadata:t}){const[s,n]=F.useState(!1);return e.jsxs("div",{className:"my-2 flex flex-col text-sm",children:[e.jsxs("div",{className:"flex flex-row items-center hover:cursor-pointer",onClick:()=>{n(!s)},children:[s?e.jsx(re,{className:"icon-sm"}):e.jsx(Ge,{className:"icon-sm"}),e.jsx("div",{className:"font-semibold",children:t.display_message})]}),s&&e.jsx("pre",{children:JSON.stringify(t.data,null,2)})]})}function at({debugMessages:t}){return t.length===0?null:e.jsx("div",{children:t.map((s,n)=>{const i=s.metadata?.jit_plugin_data?.from_server;return i&&i.type==="debug"?e.jsx(st,{messageMetadata:i.body},n):null})})}function se(t,s){return t?.from_server?.type==="confirm_action"?t?.from_server?.body?.operation:s?.parsed_function_call?.name}function ae(t,s){return t?.from_server?.type==="confirm_action"?t?.from_server?.body?.params:s?.parsed_function_call?.kwargs}function it(t,s,n){if(t.metadata?.jit_plugin_data?.from_server?.type==="send_test")return{uiState:7};if(s.some(i=>i.content.content_type===ne.SystemError))return{uiState:2};if(Re(t))return{uiState:3};for(let i=s.length-1;i>=0;i--){const a=s[i];if(a.metadata?.invoked_plugin){const m=[];return s.forEach(r=>{const c=r.metadata?.attachments?.filter(v=>v.display_files_from_actions_ext);c&&m.push(...c)}),{uiState:1,jitPluginData:a.metadata.jit_plugin_data,invokedPlugin:a.metadata.invoked_plugin,fileAttachments:m}}const l=de(a.metadata?.jit_plugin_data?.from_client);if(l!=null){if(l?.type==="contact_gizmo")return{uiState:1,jitPluginData:s[i-1]?.metadata?.jit_plugin_data};if(l?.type==="deny")return{uiState:6};if(l?.type==="oauth_success")return{uiState:0,jitPluginData:a.metadata?.jit_plugin_data};break}const o=a.metadata?.jit_plugin_data?.from_server;if(o?.type==="preview"&&n)return{uiState:0,jitPluginData:a.metadata?.jit_plugin_data};if(o?.type==="confirm_action"&&n)return{uiState:5,jitPluginData:a.metadata?.jit_plugin_data};if(o?.type==="oauth_required"&&n)return{uiState:4,jitPluginData:a.metadata?.jit_plugin_data}}return{uiState:n?0:3}}function W({actionData:t,assistantMessage:s,turnGizmo:n,onRequestCompletion:i,conversationMode:a,...l}){const o={id:Me(),author:{role:ze.Tool,name:s.recipient},content:{content_type:ne.Text,parts:[""]},recipient:"all",metadata:{jit_plugin_data:{from_client:t},gizmo_id:n?.gizmo.id},clientMetadata:{completionSampleFinishTime:Date.now()}};i({...l,promptMessage:o,completionMetadata:{conversationMode:a??{kind:ie.PrimaryAssistant}}})}function nt(t,s){if(t.type!==Te.JIT_PLUGIN||!t.metadata.json_schema)return!1;let n=!1;function i(a){for(const l in a)l==="operationId"&&a[l]===s&&(n=!0),a[l]&&typeof a[l]=="object"&&i(a[l])}return i(t.metadata.json_schema),n}function Q(t){if(t.from_server?.type==="confirm_action"||t.from_server?.type==="oauth_required"||t.from_server?.type==="preview")return t.from_server.body.params}function rt({data:t,privacyPolicyUrl:s,isPromptingForPermission:n}){const i=t?Q(t):null,l=(i?.[A]??[]).map((o,m)=>{const r=o.name.startsWith("dalle-");let c=o.name;return r&&(c=`${c}.webp`),e.jsx(D,{file:c,fileId:o.id},m)});return e.jsxs("div",{className:"divide-token-border-default border-token-border-default mt-1 mb-4 divide-y overflow-hidden rounded-xl border",children:[e.jsxs("div",{className:"bg-token-main-surface-tertiary text-token-text-secondary flex justify-between px-4 py-2 text-sm",children:[n?e.jsx(p,{id:"JITPluginMessage.params.sharing.present",defaultMessage:"The following will be shared:"}):e.jsx(p,{id:"JITPluginMessage.params.sharing.past",defaultMessage:"The following was shared:"}),s&&e.jsx("a",{href:le(s),className:"text-token-text-primary",target:"_blank",rel:"noreferrer",children:e.jsx(p,{...x.privacyPolicyLink})})]}),i&&Object.keys(i).map((o,m)=>o===A?null:e.jsxs("div",{className:"flex items-center space-x-2 px-4 py-2 font-mono",children:[e.jsx("span",{className:"text-token-text-tertiary",children:`${o}:`}),e.jsx("span",{children:JSON.stringify(i[o],null,2)})]},m)),l.length>0&&e.jsx("div",{className:"px-4 py-2",children:l})]})}function lt({title:t,data:s,privacyPolicyUrl:n,actionButtons:i}){const a=s?Q(s):null,l=a?.[A]??[],o=l.filter(r=>!r.mime_type?.startsWith("image/")).map((r,c)=>e.jsx(D,{file:r.name,fileId:r.id},c)),m=l.filter(r=>r.mime_type?.startsWith("image/")).map((r,c)=>{const v=r.name.startsWith("dalle-");let j=r.name;return v&&(j=`${j}.webp`),e.jsx(D,{file:j,fileId:r.id},c)});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-semibold",children:t}),a&&Object.keys(a).map((r,c)=>r===A?null:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:r}),e.jsx("div",{children:JSON.stringify(a[r],null,2)})]},c)),m.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:e.jsx(p,{id:"jitPluginMessage.paramsModalImages",defaultMessage:"Images"})}),m]}),o.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:e.jsx(p,{id:"jitPluginMessage.paramsModalFiles",defaultMessage:"Files"})}),o]}),e.jsxs("div",{className:"flex flex-row items-center justify-between pt-4",children:[i!==null&&e.jsx("div",{className:"space-x-2",children:i}),n&&e.jsx("a",{className:"text-xs font-semibold",href:le(n),children:e.jsx(p,{...x.privacyPolicyLink})})]})]})}function ot({title:t,data:s,privacyPolicyUrl:n,onClose:i,isOpen:a,actionButtons:l}){return e.jsx(Ce,{testId:"modal-jit-plugin-params",isOpen:a,onClose:i,type:"success",hideSeparator:!0,showCloseButton:!0,size:"normal",title:e.jsx(p,{id:"jitPluginMessage.paramsModalTitle",defaultMessage:"Review action"}),children:e.jsx("div",{className:"relative flex h-full flex-col gap-2 overflow-hidden",children:e.jsx("div",{className:"space-y-2",children:e.jsx(lt,{title:t,data:s,privacyPolicyUrl:n,actionButtons:l})})})})}function de(t){if(t&&"user_action"in t){const s=t.user_action;t={...t,...s.data},"target_message_id"in t&&s.target_message_id&&(t.target_message_id=s.target_message_id)}return t}const x=B({starting:{id:"jitPluginMessage.starting",defaultMessage:"Starting action"},confirming:{id:"jitPluginMessage.confirmingV4",defaultMessage:"<title>{gizmoName} wants to talk to {domain}</title><subtitle>Only allow sites you trust</subtitle>"},confirmingSimple:{id:"jitPluginMessage.confirming.simple",defaultMessage:"{gizmoName} wants to talk to {domain}"},confirmingSubtitle:{id:"jitPluginMessage.confirming.subtitle",defaultMessage:"Only allow sites you trust."},running:{id:"jitPluginMessage.runningV4",defaultMessage:"Talking to {domain}"},finished:{id:"jitPluginMessage.finishedV4",defaultMessage:"Talked to {domain}"},stopped:{id:"jitPluginMessage.stoppedV4",defaultMessage:"Stopped talking to {domain}"},error:{id:"jitPluginMessage.errorV5",defaultMessage:"Error talking to {domain}"},declined:{id:"jitPluginMessage.declined",defaultMessage:"You declined this action"},ranTest:{id:"jitPluginMessage.ranTest",defaultMessage:"Tested {operationName}"},confirmParamsTitle:{id:"jitPluginMessage.confirmParamsTitleV3",defaultMessage:"{gizmoName} wants to share this info with {domain}"},sentParamsTitle:{id:"jitPluginMessage.sentParamsTitleV2",defaultMessage:"{gizmoName} sent this info to {domain}"},privacyPolicyLink:{id:"jitPluginMessage.privacyPolicyLinkV2",defaultMessage:"Privacy policy"}});export{ht as JITPluginMessage};
//# sourceMappingURL=gv70d3tg5ak51g8p.js.map

import{f7 as Pe,cN as je,aW as Xe,aJ as ne,aG as Q,g as qe,s as Ye,cW as He,c2 as ee,aj as Ze,c4 as q,c5 as H,aX as Fe,ag as U,bR as Ve,af as et,ec as tt,gQ as nt,bc as st,dV as it,aa as Te,h1 as ot,cr as at,be,cn as rt,bf as ct,cc as ut,h2 as lt,gS as dt,eC as Ce,g1 as ke,f9 as ht,cf as ft,h3 as gt,aQ as mt}from"./nqrmgk5te3uzwsyz.js";import{aS as pt,d as yt,bL as wt,df as St,N as vt,mE as Ee,mF as _t,is as Tt,mG as bt,it as Ct,mH as kt,jR as Et,mI as Rt,mJ as xt,mK as Dt,mL as At,mM as Mt,af as Pt,mN as qt,kH as Re,mO as Ht,mP as Ft,mQ as It,mR as Kt}from"./uox23aig6gp6se2y.js";import{r as p,a as Lt,d as Nt}from"./n3epq09dut36rmi2.js";import{a as F,P as I,D as se,b as Ie,T as ce,p as zt}from"./dkr8jkx9n88ez7ho.js";const Ke=new F("transactionEventPlugin"),xe="prosemirrorDispatchTransaction";function De(n,e){const{eventTarget:t}=Ke.getState(n.state);return t.addEventListener(xe,e),()=>{t.removeEventListener(xe,e)}}function tn(n){return new I({key:Ke,state:{init(){return{eventTarget:n}},apply(e,t){return t}}})}const te=new F("customKeymapPlugin");function Ot(n,e){n.dispatch(n.state.tr.setMeta(te,{handlers:e}))}function nn(n={handlers:{}}){return new I({key:te,state:{init(){return{...n}},apply(e,t){const s=e.getMeta(te);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const i=te.getState(e.state).handlers[t.key];return i?i(t):!1}}})}const sn=n=>{if(!n)return{enabled:!1,trackingKeywords:[]};const e=Pe(n,"463092697").value,t=e?.trackingKeywords,s=!!e?.softmentionEnabled;return Array.isArray(t)&&t.every(i=>typeof i=="string")?{enabled:s,trackingKeywords:t}:{enabled:s,trackingKeywords:[]}};function $t(){return{decorations:se.empty,matches:[]}}const Le=new F("keywordPlugin");function on(n){const e=new RegExp(`\\b(${n.join("|")})\\b`,"gi");return new I({key:Le,state:{init(){return $t()},apply(t,s){if(!t.docChanged)return s;const i=[],o=[];return t.doc.descendants((a,c)=>{if(!a.isText||!a.text)return;const r=a.text;let u;for(;(u=e.exec(r))!=null;){const f=c+u.index,w=f+u[0].length;i.push(Ie.inline(f,w,{class:"hint-pill"})),o.push({from:f,to:w,keyword:u[1]})}}),{decorations:se.create(t.doc,i),matches:o}}},props:{decorations(t){const s=this.getState(t);return s?s.decorations:se.empty}}})}const E=new F("menuSelectorPlugin");function Ae(n){n.dispatch(n.state.tr.setMeta(E,{active:!1,onMenuAction:void 0}))}function an(n,e){n.dispatch(n.state.tr.setMeta(E,{active:!0,onMenuAction:e}))}function rn(n={submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[" "]}){return new I({key:E,state:{init(){return{...n,active:!1}},apply(e,t){const s=e.getMeta(E);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const s=E.getState(e.state);if(!s.active)return!1;if(!t.isComposing)return s.submitKeys.includes(t.key)?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),Ae(e),s.onMenuAction?.("submit")??!0):s.cancelKeys.includes(t.key)?(t.preventDefault(),s.onMenuAction?.("cancel"),Ae(e),!0):t.key==="ArrowUp"?(t.preventDefault(),s.onMenuAction?.("up"),!0):t.key==="ArrowDown"?(t.preventDefault(),s.onMenuAction?.("down"),!0):s.checkStrictMatchKeys.includes(t.key)&&s.onMenuAction?.("checkMatch")?(t.preventDefault(),!0):!1},handleDOMEvents:{blur:e=>{E.getState(e.state).onMenuAction?.("cancel")}}}})}const G=new F("placeholderPlugin");function cn(n){return new I({key:G,state:{init(){return{placeholder:n}},apply(e,t){return e.getMeta(G)?{placeholder:e.getMeta(G).placeholder}:t}},props:{decorations(e){const{doc:t}=e;if(t.childCount===1&&t.firstChild?.isTextblock&&t.firstChild.content.size===0){const i=[],{placeholder:o}=G.getState(e);return e.doc.descendants((a,c)=>{const r=Ie.node(c,c+a.nodeSize,{class:"placeholder","data-placeholder":o});i.push(r)}),se.create(t,i)}}}})}const ie="command_token",un={group:"inline",inline:!0,atom:!0,content:"text*",attrs:{id:"",hint:""},selectable:!1,draggable:!1,toDOM:n=>["span",{"data-mention-id":n.attrs.id,"data-mention-hint":n.attrs.hint,class:"hint-pill"},n.attrs.hint],parseDOM:[{tag:"span[data-mention-id][data-mention-hint]",getAttrs:n=>{const e=n.getAttribute("data-mention-id"),t=n.getAttribute("data-mention-hint");return{id:e,hint:t}}}]};function Ne(n,e){if(n.depth===0)return;const t=n.nodeBefore?.text?.match(/(?:^|\s)(\/(\w*))$/);if(t?.[1].length!==void 0){const s=n.pos-t[1].length,i=n.pos,o=s===e?.from;return{range:{from:s,to:i},queryText:t[2],isDismissed:o}}}const ue=new F("systemHintPlugin");function ze(n,e){return n.setMeta(ue,e),n}function ln(n){const t=n.state.selection.$from,s=Ne(t,void 0);n.dispatch(ze(n.state.tr,{...oe(),dismissedRange:s?.range}))}function oe(){return{queryText:"",active:!1,range:void 0,dismissedRange:void 0}}function Ut(n,e,t,s,i){const o=n.state.tr;ze(o,oe());const a=t+" ",c=n.state.schema.nodes[ie].create({id:e,hint:a},n.state.schema.text(a));if(i===s){const r=o.doc.resolve(s).nodeAfter;if(r?.isText){const u=r?.textContent.match(new RegExp(`^(?:${t}) ?`));u&&(i=s+u[0].length)}}o.replaceWith(s,i,c),o.doc.descendants((r,u)=>{r.type.name===ie&&r!==c&&(s===1&&u===s+c.nodeSize||u===1&&s===u+r.nodeSize?o.delete(u,u+r.nodeSize):o.insertText(r.textContent,u,u+r.nodeSize))}),n.dispatch(o)}function Gt(n){const e=n.state.tr;e.doc.descendants((t,s)=>{if(t.type.name===ie){const i=s+t.nodeSize;s===1&&e.doc.resolve(i).nodeAfter==null?e.delete(s,i):e.insertText(t.textContent,s,s+t.nodeSize)}}),e.steps.length>0&&n.dispatch(e)}function Me(n){const{active:e,range:t,queryText:s,onHintMatch:i}=n;if(i)return i(!e||!t?void 0:{text:s,range:t})}function Qt(n){const e=[];return n.descendants(t=>{t.type.name===ie&&typeof t.attrs?.id=="string"&&e.push(t.attrs.id)}),e}function dn(){return new I({key:ue,state:{init(){return oe()},apply(n,e,t,s){const i=n.getMeta(ue),o={...oe(),...e,...i},a=n.selection;if(a.from!==a.to||s.doc.eq(t.doc))return Me(o),o;const c=a.$from,r=Ne(c,e.dismissedRange);return o.active=!!r&&!r.isDismissed,r&&(o.queryText=r.queryText,o.range=r.range,r.isDismissed&&(r.queryText===""&&e.queryText!==""?o.dismissedRange=void 0:o.dismissedRange=r.range)),Me(o),o}}})}class Bt extends je{constructor(e){super(),this.view=e,this.subscribe("focus",()=>this._store.setState({isFocused:!0})),this.subscribe("blur",()=>this._store.setState({isFocused:!1}))}fileInputHandle=null;_store=Xe(e=>({isFocused:!1,autocompletions:[],showTaggingDropdown:!1,waveWidth:300,isInReasonMode:!1,rateLimitBannerFeature:null,setShowTaggingDropdown:t=>e({showTaggingDropdown:t})}));get store(){return this._store}_usedDictation=!1;_dictationEdited=!1;get usedDictation(){return this._usedDictation}set usedDictation(e){this._usedDictation=e}get dictationEdited(){return this._dictationEdited}set dictationEdited(e){this._dictationEdited=e}get element(){return this.view.dom}get document(){return this.view.dom.ownerDocument}isEmpty(){return this.view.state.doc.textContent.trim().length===0}isFocused(){return this.view.hasFocus()}trimLeadingText(e){const s=this.view.state.tr;let i=0;return s.doc.descendants((o,a)=>{if(o.isText&&o.text){if(typeof e=="string"&&o.text.startsWith(e))i=e.length;else if(e instanceof RegExp){const c=o.text.match(e);c?.index===0&&(i=c[0].length)}if(i){const c=o.text.substring(i).trimStart();i=o.text.length-c.length,s.delete(a,a+i)}}return!o.isLeaf}),i>0?(this.view.dispatch(s),!0):!1}replaceAll(e,t){const i=this.view.state.tr,o=[];i.doc.descendants((a,c)=>{!a.isText||a.text===void 0||o.push({node:a,pos:c})}),o.reverse(),o.forEach(({node:a,pos:c})=>{!a.isText||a.text===void 0||a.text.includes(e)&&i.insertText(a.text.replaceAll(e,t),c,c+a.text.length)}),this.view.dispatch(i)}appendText(e){this.view.dispatch(this.view.state.tr.insertText(e))}delete(e,t){this.view.dispatch(this.view.state.tr.delete(e,t))}focus(){this.view.hasFocus()||(this.view.focus(),this.view.dispatch(this.view.state.tr.setSelection(ce.atEnd(this.view.state.doc)).scrollIntoView()))}setText(e){const{tr:t,schema:s}=this.view.state,i=e?s.nodes.paragraph.create(null,s.text(e)):s.nodes.paragraph.create();this.view.dispatch(t.replaceWith(0,this.view.state.doc.content.size,i)),this.view.hasFocus()&&this.view.dispatch(this.view.state.tr.setSelection(ce.atEnd(this.view.state.doc)))}getContentLength(){return this.view.state.doc.content.size}getCurrentText(){return this.view.state.doc.textContent}hasMultipleLines(){let e=0;return this.view.state.doc.descendants(t=>{t.isBlock&&e++}),e>1}getContentToSend(){return zt(this.view)}resize(){}isReady(){return!!this.view.state.doc}setPlaceholder(e){this.view.dispatch(this.view.state.tr.setMeta(G,{placeholder:e}))}getSelectionStart(){return this.view.state.selection.ranges[0].$from.pos}setSelection(e,t){this.view.dispatch(this.view.state.tr.setSelection(ce.create(this.view.state.doc,e,t))),this.view.focus()}isMenuSelectorActive(){return E.getState(this.view.state).active}registerKeyHandlers(e){Ot(this.view,e)}registerFileInput(e){this.fileInputHandle=e}openFileDialog(){this.fileInputHandle?.openFileDialog()}acceptLegacyKeydown(){return!1}subscribe(e,t){if(e==="change"){const s=()=>{this.usedDictation&&(this._dictationEdited=!0),t(void 0)};return De(this.view,s)}return this.view.dom?.addEventListener(e,t,{capture:!0}),()=>{this.view.dom?.removeEventListener(e,t,{capture:!0})}}useState(e){return p.useSyncExternalStore(t=>De(this.view,t),()=>e(this),()=>e(this))}getSystemHint(){return Qt(this.view.state.tr.doc)[0]??null}getKeywords(){return Le.getState(this.view.state)?.matches.map(t=>t.keyword)??[]}addSystemHint(e,t,s=1,i=1){Ut(this.view,e,t,s,i)}removeSystemHints(){Gt(this.view)}canShowAutocompletion(){const e=this.getSystemHint();return e===ne.PictureV2||e===ne.Tatertot||!this.isMenuSelectorActive()&&!e}}const Wt=Q({}),Oe=Q(void 0),Jt=Q(void 0),le=Q(0),de=Q(0),hn=({serverThreadId:n,clientThreadId:e,getIsDisabled:t,composerController:s,currentModelId:i,account:o,onReset:a,onInfer:c,isInferEnabledForModel:r})=>{const[u,f]=p.useState(!1),w=qe(),K=Pe(w,"3519990784").value,B=Number(K?.inference_debounce_ms??200),R=Ye(w,"209963048")&&["gpt-4o","auto"].includes(i),L=He(),S=p.useRef(null),x=pt(({enableInferredJuice:l})=>l)||R||r,D=p.useRef(c);D.current=c;const T=p.useRef(0),b=p.useRef(0),W=ee(()=>Jt()),C=p.useCallback(yt(l=>{if(t())return;Ze.logEventWithStatsig("chatgpt_web_autoswitch_infer_called","chatgpt_web_autoswitch_infer_called",{is_paid_user:o?.hasPaidSubscription()});const g=l.length,J=g<5?"<5":g<=10?"5-10":g<=20?"10-20":g<=50?"30-50":"50+";if(q.count(H.DEFAULT,"chatgpt_web_autoswitch_infer_called",{prompt_length:J,is_paid_user:o?.hasPaidSubscription()?"true":"false"}),R)return;const N=++T.current,j=Date.now();f(j);const re=Fe(e),z=U.getCurrentNode(re);Ve.postAnonAware("/conversation/infer",{prompt:l,conversation_id:n??null,is_history_and_training_disabled:L,parent_message_id:z.message.id,auto_switcher_treatment_override:W},{additionalHeaders:{"x-conduit-token":S.current??""}}).then(_=>{if(S.current=_.conduit_token,t()||b.current>N||s.getContentToSend().content.length<l.length)return;b.current=N;const{effort_mode:O,debug_info:X,request_id:Y}=_;X&&Wt.set(X),Y&&Oe.set(Y),le.set(A=>A+1),de.set(l.length),D.current(O)}).finally(()=>{f(_=>_&&j<_?_:!1)})},B),[t,n,W]),y=et(e,l=>l?.modelId),v=p.useRef(void 0);return p.useEffect(()=>{if(!x||!(s instanceof Bt)){y&&y!==v.current&&(v.current=y);return}const l=()=>{const{content:g}=s.getContentToSend();t()||!x||(g?C(g):(S.current=null,a(),f(!1),++T.current,b.current=T.current))};return y&&y!==v.current&&(v.current=y,l()),s.subscribe("change",()=>{l()})},[x,t,s,C,c,a,n,L,y]),u!==!1};function fn(n){const e=qe(),t=Lt(),s=tt(),i=He(),o=nt(),a=Nt(),c=wt(),r=St(n),u=r&&"gizmo"in r?r.gizmo?.gizmo.id:void 0,f=vt(u),w=u?f?Ee.PROJECT:Ee.GPT:void 0,K=_t(),B=ee(()=>Oe()),ae=ee(()=>le()),R=ee(()=>de()),L=Tt(D=>D.threads[n]?.modelSelection),S=L?.type===bt.EFFORT_MODE?L.effortMode:void 0,{configurationMenuType:he}=Ct(),x=he!=="none";return p.useCallback(async function({requestedModelId:D,completionType:T=at.Next,sourceEvent:b,eventSource:W,completionMetadata:C,extraStreamParams:y,parentMessageId:v,promptMessage:l,existingMessages:g,prependMessages:J,appendMessages:N,profiler:j,skipNotification:re}){const z=b?.timeStamp??performance.now(),_=W??(b?kt(b):"mouse"),O=new AbortController,X=ot(),Y=st(n),A=`request-${n}-${X}`,h=Fe(n),{conduitToken:fe=null,prepareState:ge="none",lastPrepareTimestamp:me=null}=h??{},Z=D??h?.modelId??Et(it(t)).id,pe=U.findNode(h,d=>d.message.author.role===Te.Assistant||d.message.author.role===Te.Tool)==null,$e=h?.continuingFromSharedConversationId!=null,ye=v?U.getNode(h,v):g?.[0]?U.getParentNode(h,g[0].id):U.getCurrentNode(h),Ue=ye.message.id??ye.id,we=[...g??[],...J??[],...l?[l]:[],...N??[]],$=new Rt({clientRequestId:A,gizmoType:w,preflightTime:z});if($.onUserMessages(we),f&&pe){const d=x?C?.systemHints:C?.systemHints?.filter(V=>V!==ne.Canvas&&V!==ne.PictureV2);xt(e).set(V=>({...V,[n]:d??[]}))}const M=new Dt(e,A,t,h,n,v,J,l,N,T,Z,S??h?.effortMode,_,i,z,a,f,pe,$e,$,re??!1,o),Ge=At(n);Mt(n)?.value===be.REALTIME&&await Ge,rt.publish({kind:"requestCompletion"}),Pt(n,{source:ct.CLIENT,value:be.STREAMING}),ut.addRequest(A,O,$),qt.onCompletionRequestStarted(A),M.updateBeforeRequest();const Qe=performance.now(),k=[],P=lt()??(k.push("chatReq"),await dt());P.force_login&&c({authType:"login"});const Be=Re.getEnforcementTokenSync(P)??(k.push("turnstile"),await Re.getEnforcementToken(P)),We=Ce.getEnforcementTokenSync(P)??(k.push("proofofwork"),await Ce.getEnforcementToken(P));t.getQueriesData(ke)==null&&await t.ensureQueryData(ke);const Se=k.includes("chatReq")?"false":"true",ve=k.includes("turnstile")?"false":"true",_e=k.includes("proofofwork")?"false":"true";q.hist(H.DEFAULT,"chat_req_time",[{key:"wasChatReqSync",value:Se},{key:"wasTurnstileSync",value:ve},{key:"wasProofofworkSync",value:_e}],performance.now()-Qe),ht(mt(),{eventName:"chatgpt_web_completion_integrity_checks",value:k.length===0?"true":"false",metadata:{wasChatReqSync:Se,wasTurnstileSync:ve,wasProofofworkSync:_e}}),Ht()&&await Ft();const m=It();if($.onCompletionStarted(T,Z),M.preflightTime=performance.now()-z,K&&me!=null){const d=performance.now()-me;d<=6e4&&q.hist(H.DEFAULT,"fast_conversation_last_prepare_to_convo_client",[{key:"model_id",value:Z},{key:"prepare_state",value:String(ge)},{key:"has_conduit_token",value:fe!=null?"true":"false"}],d)}(S??h?.effortMode)&&(q.hist(H.DEFAULT,"chatgpt_web_autoswitcher_infer_calls_per_message",[],ae),le.set(0),R!==0&&l?q.hist(H.DEFAULT,"chatgpt_web_autoswitcher_prompt_length_difference",[],ft(l).length-R):q.count(H.DEFAULT,"chatgpt_web_autoswitcher_message_before_infer_completed"),de.set(0));const Je=Kt(e,{conversationOrigin:h?.conversationOrigin??null,model:Z,completionType:T,prepareState:ge,conduitToken:fe,threadId:Y,effortMode:S??h?.effortMode??void 0,inferRequestId:B,continueFromSharedConversationId:h?.continuingFromSharedConversationId,historyDisabled:i,isAnonModeEnabled:o,parentMessageId:Ue,messages:we,chatReq:P,turnstileToken:Be,proofToken:We,completionMetadata:C,contextualInfo:{is_dark_mode:s,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window.innerHeight,page_width:window.innerWidth,pixel_ratio:window.devicePixelRatio,screen_height:window.screen.height,screen_width:window.screen.width},isOnboardingConversation:C?.isOnboardingConversation,forceParagen:m.forceParagen,forceParagenModel:m.forceParagen?m.forceParagenModel.value:void 0,forceRateLimit:m.forceRateLimit,resetRateLimits:m.resetRateLimits,recordRendering:m.recordRendering,disableSystemContentToggling:m.rebaseSystemMessageContent!=null,forceUseSearch:m.forceUseSearch??void 0,paragenStreamType:m.paragenStreamType,paragenCotSummaryDisplay:m.paragenCotSummaryDisplay,...K?{f_completion:!0}:{},...y},$,j,O.signal,n);try{for await(const d of Je)d.type==="connected"?M.handleStreamConnected(d):d.type!=="perf_stats"&&d.type!=="server_ste_metadata"&&M.handleResponse(d)}catch(d){gt(d)||O.signal.aborted?M.handleAbort(d):M.handleError(d)}},[n,t,w,f,e,S,i,a,K,B,s,x,c,ae,R,o])}export{Bt as P,ie as a,dn as b,nn as c,tn as d,ze as e,an as f,sn as g,Ae as h,ln as i,hn as j,on as k,rn as m,cn as p,un as s,xe as t,fn as u};
//# sourceMappingURL=e4sjbad9hyqt73xe.js.map

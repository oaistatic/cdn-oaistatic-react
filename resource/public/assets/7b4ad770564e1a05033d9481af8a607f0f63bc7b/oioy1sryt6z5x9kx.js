const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/kw08ajijqinojrwh.js","assets/kfrdmkli83ureki3.js","assets/root-fi49nzd2.css","assets/kspsmo2l8jg7uqdj.js"])))=>i.map(i=>d[i]);
var Z=Object.defineProperty,J=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var Y=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var T=(e,r,t)=>r in e?Z(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,D=(e,r)=>{for(var t in r||(r={}))Y.call(r,t)&&T(e,t,r[t]);if(j)for(var t of j(r))ee.call(r,t)&&T(e,t,r[t]);return e},k=(e,r)=>J(e,Q(r));import{r as n,h as te,al as re,j as f,M as I,_ as V}from"./kfrdmkli83ureki3.js";import{D as $,bf as ne,W as se,lv as L,aB as P,az as G,cy as W,e6 as U,kc as oe,_ as ce,a7 as ae,aA as H}from"./kw08ajijqinojrwh.js";import{m9 as X,ma as N,mb as q}from"./fyw02vlaiv2vq6cj.js";function C(e,r){return t=>{$.addAction("".concat(e,".").concat(r),t)}}function ie(e){return(r,t)=>{$.addError(r,k(D({},t),{name:e,status:"error"}))}}const b={recording:{start:C("whisper-recording","start"),cancel:C("whisper-recording","cancel"),submit:C("whisper-recording","submit")},transcription:{request:C("whisper-transcription","request"),transcriptDelivered:C("whisper-transcription","transcriptDelivered"),error:ie("whisper-transcription"),requestSuccess:C("whisper-transcription","requestSuccess")}};class ue{static async transcribe(r,t,S={}){const w=new FormData;w.append("file",r),t&&w.append("language",t);const g={durationMs:S.durationMs,language:t,fileSize:r.size},m=performance.now();return b.transcription.request(g),ne.post("".concat(se,"/transcribe"),w).then(o=>{const c=performance.now()-m;return b.transcription.requestSuccess(k(D({},g),{durationMs:c})),o}).catch(o=>{const c=performance.now()-m;throw b.transcription.error(o,k(D({},g),{durationMs:c})),o})}}const le=48e3,de=10,B=le*de,pe=4e3,fe=600*1e3,M=e=>X.setState(r=>{r.status=e}),me=e=>{const r=n.useRef(e);r.current=e;const t=n.useRef(null),S=n.useRef([]),w=n.useRef(null),g=n.useRef(null),m=n.useRef(null),o=n.useRef(new Float32Array(0)),c=n.useRef(null),y=n.useRef(null),v=n.useRef(!1),i=n.useCallback(()=>{o.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),E=n.useCallback(async(u,h)=>{var p;M("transcribing");try{let l;L()?l=new File([u],"whisper.mp3",{type:"audio/mpeg"}):l=new File([u],"whisper.".concat(u.type.split(/[\/;]/)[1]||"mp3"),{type:u.type});const a=await ue.transcribe(l,void 0,{durationMs:h});M("idle"),b.transcription.transcriptDelivered({durationMs:h,transcriptLength:a.text.length}),r.current.onSuccess(a.text,a.asset_pointer,a.asset_ttl,(p=a.asset_format)!=null?p:null),i()}catch(l){M("error"),b.transcription.error(l,{durationMs:h}),i()}},[i]),R=n.useCallback(u=>{var p,l,a,d,s;if(!v.current)return;v.current=!1,y.current!==null&&(clearTimeout(y.current),y.current=null);const h=c.current!=null?performance.now()-c.current:void 0;u&&t.current&&(t.current.ondataavailable=null,t.current.onstop=null,M("idle"),i(),b.recording.cancel({durationMs:h}),c.current=null),(p=t.current)==null||p.stop(),(l=t.current)==null||l.stream.getTracks().forEach(A=>A.stop()),t.current=null,(a=m.current)==null||a.disconnect(),m.current=null,(d=g.current)==null||d.disconnect(),g.current=null,(s=w.current)==null||s.close(),w.current=null,u||b.recording.submit({durationMs:h})},[i]),F=n.useCallback(()=>{i(),M("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:pe,channelCount:1}}).then(u=>{c.current=performance.now(),b.recording.start(),t.current=new MediaRecorder(u);const h=L();v.current=!0,h?(S.current=[],t.current.ondataavailable=d=>{d.data.size>0&&S.current.push(d.data)},t.current.onstop=async()=>{const d=new Blob(S.current,{type:"audio/mpeg-3"}),s=c.current!=null?performance.now()-c.current:void 0;await E(d,s)},t.current.start(1e3)):(t.current.ondataavailable=async d=>{const s=c.current!=null?performance.now()-c.current:void 0;await E(d.data,s)},t.current.start()),o.current=new Float32Array(B).fill(r.current.initialValue),r.current.onWaveformDataUpdate(o.current),M("recording"),y.current=window.setTimeout(()=>{R()},fe);const p=new AudioContext;w.current=p;const l=p.createMediaStreamSource(u);g.current=l;const a=p.createScriptProcessor(2048,1,1);m.current=a,a.onaudioprocess=d=>{const s=d.inputBuffer.getChannelData(0);for(let x=0;x<s.length;x++)s[x]=Math.max(s[x],r.current.initialValue);const A=o.current,_=new Float32Array(A.length+s.length);if(_.set(A,0),_.set(s,A.length),_.length>B){const x=_.length-B;o.current=_.slice(x)}else o.current=_;r.current.onWaveformDataUpdate(o.current)},l.connect(a),a.connect(p.destination)}).catch(()=>{M("error"),i(),b.recording.cancel()})},[i,R,E]);return n.useEffect(()=>()=>{R(!0)},[R]),{startRecording:F,stopRecording:R}},z=G(()=>V(()=>import("./kw08ajijqinojrwh.js").then(e=>e.yt),__vite__mapDeps([0,1,2])),{loading:e=>H(e)}),O=G(()=>V(()=>import("./kspsmo2l8jg7uqdj.js"),__vite__mapDeps([3,1])),{loading:e=>H(e)});function be({disabled:e=!1,initialValue:r,onSuccess:t,onWaveformDataUpdate:S,onExit:w,buttonClassName:g,visualTreatment:m}){const o=te(),c=X(s=>s.status),y=n.useRef(!1),{startRecording:v,stopRecording:i}=me({onSuccess:t,onWaveformDataUpdate:S,initialValue:r}),E=re();n.useEffect(()=>()=>{i()},[i]),n.useEffect(()=>{y.current||(v(),y.current=!0)},[v]),n.useEffect(()=>{E.state!=="idle"&&i()},[E.state,i]);const R=()=>{i(!0),w()},F=m==="codex"?f.jsx(P,{type:"button",color:"ghost",size:"small",onClick:R,icon:z,disabled:e||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},children:f.jsx(I,{id:"wham.whisperModeControls.cancel",defaultMessage:"Cancel"})}):f.jsx("div",{children:f.jsx("button",{"aria-label":o.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:R,disabled:e||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:W(m==="composer-btn"?"composer-btn":W(N,e?"opacity-30":q,g)),children:f.jsx(z,{"aria-label":o.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"icon",fontSize:"inherit"})})}),u=c==="transcribing",h=u?f.jsx(U,{}):f.jsx(O,{className:"icon-lg"}),p=u?o.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):o.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),l=()=>{ce.logEvent("Whisper on Web/Windows: Clicked to end dictation"),ae.logEvent("chatgpt_composer_whisper_button_clicked_end"),i()},a=s=>{s.key==="Escape"&&oe(s)&&(R(),s.preventDefault())},d=m==="codex"?f.jsx(P,{type:"button",color:"secondary",size:"small",disabled:e,icon:u?U:O,onClick:l,onKeyDown:a,ref:K,children:f.jsx(I,{id:"wham.whisperModeControls.done",defaultMessage:"Done"})}):f.jsx("div",{children:f.jsx("button",{type:"button","aria-label":p,disabled:e,className:m==="composer-btn"?"composer-btn":W(N,e?"opacity-30":q,g),onClick:l,onKeyDown:a,ref:K,children:h})});return f.jsxs("div",{className:"flex gap-x-1.5",children:[F,d]})}function K(e){e==null||e.focus()}export{be as WhisperModeControls};
//# sourceMappingURL=oioy1sryt6z5x9kx.js.map

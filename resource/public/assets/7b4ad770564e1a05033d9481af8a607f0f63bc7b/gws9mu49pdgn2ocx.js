var G=Object.defineProperty;var L=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var D=(s,e,t)=>e in s?G(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,_=(s,e)=>{for(var t in e||(e={}))F.call(e,t)&&D(s,t,e[t]);if(L)for(var t of L(e))U.call(e,t)&&D(s,t,e[t]);return s};import{j as i,r as w}from"./kfrdmkli83ureki3.js";import{f9 as V,M as O,n as K,dR as A,cy as M,i5 as B,a9 as W,bK as q,bJ as $,aa as z,ay as j,_ as J,d_ as Y,V as E}from"./kw08ajijqinojrwh.js";import{jY as Q}from"./fyw02vlaiv2vq6cj.js";import{u as X}from"./ipjj058rvhjq2uu2.js";import{r as Z}from"./kbj1b07s2z6vxqkg.js";import"./h1em0bjkpkjv8ykw.js";import"./hu1bt0oauegdhua6.js";function H(s,e,t={}){if(!s||!e)return Promise.resolve();const{padding:a=0,behavior:l="smooth",signal:p,idleMs:g=120,timeoutMs:x=4e3,resolveOnUserInterruption:o=!0}=t,c=e.getBoundingClientRect(),m=s.getBoundingClientRect().top-c.top+e.scrollTop-a;return e.scrollTo({top:m,behavior:l}),l!=="smooth"&&Math.abs(e.scrollTop-m)<=1?Promise.resolve():new Promise((d,h)=>{let T=!1,n,f;const r=["wheel","touchstart","mousedown","keydown"],v=()=>{n&&window.clearTimeout(n),f&&window.clearTimeout(f),e.removeEventListener("scroll",C,N),e.removeEventListener("scrollend",b),r.forEach(k=>{e.removeEventListener(k,S,R)}),p==null||p.removeEventListener("abort",y)},I=()=>{T||(T=!0,v(),d())},y=()=>{v();const k=new DOMException("Scroll aborted","AbortError");h(k)},S=()=>{if(o)I();else{v();const k=new Error("Scroll interrupted by user");h(k)}},b=()=>I(),C=()=>{n&&window.clearTimeout(n),n=window.setTimeout(()=>{I()},g)},N={passive:!0},R={passive:!0,capture:!0};if("onscrollend"in e?e.addEventListener("scrollend",b,{once:!0}):(e.addEventListener("scroll",C,N),C()),r.forEach(k=>{e.addEventListener(k,S,R)}),p){if(p.aborted)return y();p.addEventListener("abort",y,{once:!0})}f=window.setTimeout(()=>{I()},x)})}function P(s){return s.map(e=>e.type==="list"?"":e.type==="text"?e.value:Array.isArray(e.children)?P(e.children):"").join("")}function ee({markdown:s}){var g;const e=X().use(Z).parse(s),t=[];let a=6,l;const p=({text:x,depth:o,originalMarkdown:c})=>{x&&(t.push({text:x,depth:o,originalMarkdown:c}),o<a&&(a=o))};for(let x=0;x<e.children.length;x++){const o=e.children[x];if(o.type==="heading"){const c=o;if(l=c,c.depth<=3){const u=P(c.children);if(u.trim()){const m=c.position?s.slice(c.position.start.offset,c.position.end.offset):u;p({text:u,originalMarkdown:m,depth:c.depth})}}}else if(o.type==="thematicBreak")l=void 0;else if(o.type==="list"&&(l&&l.depth<=3||l===void 0)){const c=o;for(const u of c.children){const m=P(u.children),d=u.position?s.slice(u.position.start.offset,u.position.end.offset):m;p({text:m,originalMarkdown:d,depth:((g=l==null?void 0:l.depth)!=null?g:0)+1})}}}return t.length===0&&(a=0),{tocItems:t,minDepth:a}}const te=300,ne=36,se={type:"tween",ease:"linear",duration:.3},pe=s=>i.jsx(V,{name:"TableOfContentsSidebar",fallback:()=>i.jsx(i.Fragment,{children:null}),logRequestErrors:!0,children:i.jsx(oe,_({},s))}),oe=({clientThreadId:s,scrollContainerRef:e})=>{const[t,a]=w.useState(!1),[l,p]=w.useState([]),[g,x]=w.useState(!1),{conversationMode:o,conversationTurnIds:c,activeTurnIdPair:u}=O(s,d=>{const h=E.getConversationTurnIds(d),T=d==null?void 0:d.turnIdsInViewpoint,n=T==null?void 0:T.reduce((r,v)=>v.turnIndex<r.turnIndex?v:r,{turnIndex:1/0,turnId:"",role:j.User}),f=[];return n&&(f.push(n.turnId),n.role===j.Assistant&&n.turnIndex>0?f.unshift(h[n.turnIndex-1]):n.turnIndex<h.length-1&&f.push(h[n.turnIndex+1])),{conversationMode:d==null?void 0:d.mode,conversationTurnIds:h,activeTurnIdPair:f}});w.useEffect(()=>{!g&&(l.length!==u.length||!l.every(d=>u.includes(d)))&&p(u)},[u,l,g]);const m=w.useRef(null);return(o==null?void 0:o.kind)!==K.PrimaryAssistant?null:i.jsx(A.div,{className:M("fixed end-4 top-25 z-10 max-h-[calc(100vh-20rem)] overflow-hidden ps-1 will-change-transform",t&&"border-token-border-default bg-token-bg-primary scrollbar overflow-y-auto rounded-lg border py-4 ps-3 shadow-lg [scrollbar-gutter:stable]"),initial:!1,animate:{width:t?te:ne},transition:se,onMouseEnter:()=>{m.current&&clearTimeout(m.current),a(!0)},onMouseLeave:()=>{m.current=setTimeout(()=>a(!1),500)},children:i.jsx("div",{className:"block font-normal",children:c.map((d,h)=>i.jsx(re,{clientThreadId:s,turnIndex:h,active:l.includes(d),isHovered:t,isLast:h===c.length-1,scrollContainerRef:e,onScrollingChange:x},d))})})},re=({turnIndex:s,clientThreadId:e,active:t,isHovered:a,isLast:l,scrollContainerRef:p,onScrollingChange:g})=>{const x=w.useRef(null),[o,c]=O(e,n=>{const f=E.getConversationTurnAtIndex(n,s),r=s>0?E.getConversationTurnAtIndex(n,s-1):null,v=(r==null?void 0:r.role)===j.User&&r.messages.some(I=>{var y;return(y=I.metadata)==null?void 0:y.visually_hide_response_from_conversation});return[f,v]}),{tocItems:u,truncatedContent:m,minDepth:d}=w.useMemo(()=>{const r=o.messageGroups.filter(b=>b.type!==-1&&[B.Text,B.b1de6e2_rm].includes(b.type)).flatMap(b=>b.messages.filter(C=>W(C)||[q.b1de6e2_rm].includes($(C)))).map(b=>z(b,{shouldGetVisibleText:!1,shouldGetTextFromContentReferences:!1})).join("\n"),v=r.length>1e3?r.slice(0,1e3)+"...":r,{tocItems:I,minDepth:y}=o.role===j.Assistant?ee({markdown:r}):{tocItems:[],minDepth:0};return{tocItems:I.filter(b=>b.depth-y<=1),content:r,truncatedContent:v,minDepth:y}},[o]);w.useEffect(()=>{var n;t&&a&&((n=x.current)==null||n.scrollIntoView({behavior:"smooth",block:"center"}))},[t,a]);const h=w.useCallback(async(n,f)=>{const r=document.querySelector(f==="turn"?'[data-turn-id="'.concat(n,'"]'):'[data-section-id="'.concat(n,'"]'));r&&p.current&&(J.logEvent("Table of Contents: Clicked",{type:f,screenWidth:window.innerWidth}),g(!0),await H(r,p.current),g(!1))},[p,g]);if(c)return null;const T=o.role===j.User?i.jsxs("div",{onClick:()=>h(o.id,"turn"),className:M("text-token-text-tertiary hover:text-token-text-primary text-xs","relative flex cursor-pointer items-center overflow-visible py-1",t&&"text-token-text-primary! font-medium"),title:m,children:[t&&i.jsx("div",{className:M("border-token-bg-primary box-content overflow-hidden border border-4","absolute -start-3 h-2 w-2 -translate-x-1/2 rounded-full",a?"bg-token-icon-primary":"bg-token-icon-tertiary")}),i.jsx(A.span,{initial:!0,animate:{opacity:a?1:0},transition:{type:"tween",ease:"easeInOut",duration:.3},className:"truncate overflow-hidden will-change-transform",children:m})]}):i.jsx(Y,{initial:!1,mode:"wait",children:o.role===j.Assistant&&t&&a?i.jsx(A.div,{initial:{height:0,paddingTop:0,paddingBottom:0},animate:{height:t&&a?"auto":0,paddingTop:a?4:0,paddingBottom:a?4:0},exit:{height:0,paddingTop:0,paddingBottom:0},transition:{type:"tween",ease:"linear",duration:.3},className:"overflow-hidden ps-6 will-change-transform",children:u.length===0?i.jsx("div",{onClick:()=>h(o.id,"turn"),className:M("text-token-text-tertiary line-clamp-2 cursor-pointer text-xs"),title:m,children:m}):i.jsx("ul",{className:"flex flex-col gap-4",children:u.map((n,f)=>{const r=Q(n.originalMarkdown),v=n.depth-d;return i.jsx("li",{className:M(v!==0&&"ps-4"),children:i.jsx("div",{onClick:()=>h(r,"section"),className:"hover:text-token-text-primary text-token-text-tertiary cursor-pointer truncate text-xs",children:n.text})},f)})})}):null});return T?i.jsxs("div",{ref:x,className:"flex items-stretch gap-2",children:[i.jsx("div",{className:"flex w-2 justify-center",children:!(l&&o.role===j.Assistant)&&i.jsx("div",{className:M("h-full w-[2px]",a?"bg-token-border-heavy":"bg-token-border-default")})}),i.jsx("div",{className:"flex min-w-0 flex-1 basis-0 flex-col",children:T})]}):null};export{pe as TableOfContentsSidebar};
//# sourceMappingURL=gws9mu49pdgn2ocx.js.map

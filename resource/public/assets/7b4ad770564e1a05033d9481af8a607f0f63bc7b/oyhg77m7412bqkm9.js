import{r as n,u as I,h as K,d as L,l as O,j as c,ag as q,a as B,a9 as N,y as U}from"./kfrdmkli83ureki3.js";import{jN as z,p as H,rq as Q,fM as $}from"./kw08ajijqinojrwh.js";import{W as G}from"./c9y1a55iezj3p7dm.js";import{y as X,z as J,k as V,W as Y,r as Z,t as D,A as ee}from"./oyvo09ze11a90qsd.js";import{cx as te,aW as P,aX as A}from"./fyw02vlaiv2vq6cj.js";import{u as re}from"./ny16i6vydtz4gnvl.js";import{useSetupBaseWhamKeyboardActions as ne}from"./op7sgz1bowo3300n.js";import{b as oe,g as se,T as ue,W as ae,c as ie}from"./cxcgq7fw1eh9yl4l.js";import{u as me}from"./pd4wtm7wtmrmmmqr.js";import"./nh6x5pasrftsddpw.js";import"./c7lf6x6u521mpx19.js";import"./nc8gen230lb13csi.js";import"./goxcf7vc701q04ob.js";import"./zmq298rl93f7s2hn.js";import"./fux1oumbpb3w9e7e.js";import"./mo4f6niq6474ip4n.js";import"./i6j31imn3cki69v8.js";import"./lrftmyomhnslqldf.js";import"./dn55ejno9ewvlhxs.js";import"./mgt4kmm4im6a7le7.js";import"./ipjj058rvhjq2uu2.js";import"./h1em0bjkpkjv8ykw.js";import"./esgn9c4esm3mlqc4.js";import"./ab1440qk9vnud23e.js";import"./dm8z7bzkrzic0zmg.js";import"./hu1bt0oauegdhua6.js";import"./eb8h7c171jyixp4q.js";import"./giwakgarsud1rsxv.js";import"./pbjg7z6w7wj6b69y.js";import"./fy52bb9t6zneap2s.js";import"./lafhvalu919ojf7s.js";import"./lptwpbjabrvjmhsj.js";import"./l8r2q1y684enjq2l.js";import"./j3xa7zoduffqfxbm.js";import"./kmtsjg7uv0tesj55.js";import"./gf4c0f98pdaqc94a.js";import"./idxukd613qgy7urm.js";import"./jqc82mvozbbjvbcp.js";import"./et0kjfzq519mr3zi.js";import"./edhlcmww46h398kf.js";import"./e96bwg1s7x4og2fp.js";import"./fxythiulbb2q3qno.js";import"./cw8iso7iidphmxgk.js";import"./eix6aku103dkp2pu.js";function ce(){return n.useSyncExternalStore(t=>(document.addEventListener("focusin",t),document.addEventListener("focusout",t),()=>{document.removeEventListener("focusin",t),document.removeEventListener("focusout",t)}),()=>{var t;return typeof document<"u"&&((t=document.activeElement)==null?void 0:t.hasAttribute("data-wham-comment-textarea"))===!0},()=>!1)}function de(t){var b,_,k,T,h,W,w;const a=I(),i=z(),m=ce(),{data:e,error:p}=X(t,{refetchOnWindowFocus:!0,refetchOnMount:!0}),{isLoading:d}=J(t),o=V(n.useCallback(({getTurnsForTask:s})=>{var u;return(u=s(t))!=null?u:[]},[t])),{focusedAssistantTurn:r,setFocusedAssistantTurnId:j}=oe({taskId:t,task:e==null?void 0:e.task,currentUserTurn:(b=e==null?void 0:e.current_user_turn)!=null?b:null,currentAssistantTurn:(_=e==null?void 0:e.current_assistant_turn)!=null?_:null}),M=n.useMemo(()=>{var s,u;return se({focusedAssistantTurn:r,pastTurns:o,currentDiffTaskTurnId:(u=(s=e==null?void 0:e.current_diff_task_turn)==null?void 0:s.id)!=null?u:null})},[r,(k=e==null?void 0:e.current_diff_task_turn)==null?void 0:k.id,o]),l=(T=e==null?void 0:e.task)==null?void 0:T.current_turn_id,C=!!(e!=null&&e.task.has_unread_turn)&&l===((h=e==null?void 0:e.current_assistant_turn)==null?void 0:h.id),g=((W=e==null?void 0:e.current_assistant_turn)==null?void 0:W.turn_status)==="completed";n.useEffect(()=>{var f;if(!i)return;const s=(f=e==null?void 0:e.task)==null?void 0:f.title;if(!s)return;const u=document.title;return document.title=s,()=>{document.title=u}},[i,(w=e==null?void 0:e.task)==null?void 0:w.title]),n.useEffect(()=>{!C||!g||Y.markTurnAsRead(t).then(()=>{a.invalidateQueries({queryKey:["wham","tasks"]}),a.invalidateQueries({queryKey:["wham","task",t]})})},[C,g,t,a]);const v=n.useMemo(()=>{var E,x,S,y;const s=r?Z(r.turn_status):!1,u=((S=r==null?void 0:r.sibling_turn_ids)==null?void 0:S.includes((x=(E=e==null?void 0:e.current_assistant_turn)==null?void 0:E.id)!=null?x:""))||(r==null?void 0:r.id)===((y=e==null?void 0:e.current_assistant_turn)==null?void 0:y.id),f=!(e!=null&&e.current_diff_task_turn);return s&&(u||f)},[r,e==null?void 0:e.current_assistant_turn,e==null?void 0:e.current_diff_task_turn]);return{taskDetails:e,taskDetailsError:p,loadingTurnMapping:d,turns:o,focusedAssistantTurn:r,setFocusedAssistantTurnId:j,currentDiffTaskTurn:M,canFollowUp:v,isCommentFocused:m}}function pe(){const[t,a]=n.useState([]),[i,m]=n.useState(!1),e=n.useCallback(()=>{a([])},[]),p=n.useCallback(({onClose:d,isComposerEmpty:o})=>({force:r=!1}={})=>{if(r||t.length===0&&o){e(),d();return}m(!0)},[t.length,e]);return{comments:t,setComments:a,confirmClose:i,setConfirmClose:m,clearComments:e,createCloseHandler:p}}function le({taskId:t,onClose:a}){"use no forget";var y,F;const i=H(),m=K(),e=L(),{composerController:p,isComposerEmpty:d}=me(),{taskDetails:o,taskDetailsError:r,loadingTurnMapping:j,turns:M,focusedAssistantTurn:l,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g,canFollowUp:v,isCommentFocused:b}=de(t),_=n.useMemo(()=>D(l),[l]),k=n.useMemo(()=>({taskId:t,task:o==null?void 0:o.task,pastTurns:M,canFollowUp:v,focusedAssistantTurn:l,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g}),[t,o,M,v,l,C,g]),{comments:T,setComments:h,confirmClose:W,setConfirmClose:w,clearComments:s,createCloseHandler:u}=pe(),f=n.useMemo(()=>({comments:T,setComments:h,clearComments:s,readonlyComments:_}),[T,h,s,_]),E=te.useCurrentImage()!=null,x=u({onClose:a,isComposerEmpty:d});ne(),re([{key:"newTask",action:()=>{e("/codex",{state:{focusComposer:!0}})},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.newTask",defaultMessage:"New task"}),group:A.Chat,keyboardBinding:[P.Mod,P.Shift,"o"]},{key:"closeTask",action:()=>{e("/codex")},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.closeTask",defaultMessage:"Close task"}),group:A.Chat,keyboardBinding:[P.Escape],enabled:!E&&!b}]);const S=n.useCallback(({force:R=!1}={})=>{x({force:R})},[x]);return r?(i.danger(O({id:"wham.task-details.error",defaultMessage:"Error loading task"}),{id:"wham-task-details-error-".concat(t),hasCloseButton:!0,duration:3,toastId:"wham_task_page_content_error"}),c.jsx(q,{to:"/codex"})):c.jsx(Q.Provider,{value:p,children:c.jsx(ue,{value:f,children:c.jsx(ae,{value:k,children:c.jsx(ie,{permissions:"write",turnId:(F=(y=o==null?void 0:o.current_assistant_turn)==null?void 0:y.id)!=null?F:"",confirmClose:W,setConfirmClose:w,handleClose:S,loadingTurnMapping:j})})})})}function fe(){var d;const t=L(),a=B(),{taskId:i}=N();ee();const m=(d=a.state)!=null?d:{},{backgroundLocation:e}=m,p=n.useCallback(()=>{t(e?-1:"/codex")},[e,t]);return i?c.jsx($,{children:c.jsx(G,{children:c.jsx(le,{taskId:i,onClose:p})})}):null}const st=()=>[{title:"Codex"}],ut=U(function(){return c.jsx(fe,{})});export{ut as default,st as meta};
//# sourceMappingURL=oyhg77m7412bqkm9.js.map

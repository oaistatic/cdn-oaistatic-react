const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/km44ch1r0uf907fx.js","assets/kfrdmkli83ureki3.js","assets/fx3vo65j1l2o1ay3.js","assets/m6idklazvjc7d344.js","assets/n70q0rscelh7atg0.js","assets/s6fvwzj20sqgu2sq.js","assets/fyw02vlaiv2vq6cj.js","assets/kw08ajijqinojrwh.js","assets/root-fi49nzd2.css","assets/conversation-small-lq38g8zw.css","assets/kcrfstn8nf4rn51p.js","assets/et0kjfzq519mr3zi.js","assets/nvxri8mldbk6o2on.js","assets/hk5ml9l4i4ups2ga.js","assets/fwbhrttgqnv5nm9m.js","assets/o5h7u1aikohecbkt.js","assets/w4rmhhxvug61xnae.js","assets/lg0oi3tmjv8kv2p4.js","assets/b3ungmqo5x8kj4fh.js","assets/nh6x5pasrftsddpw.js","assets/c7lf6x6u521mpx19.js","assets/ck7ltodh2xzj12u2.js"])))=>i.map(i=>d[i]);
var Ve=Object.freeze,vt=Object.defineProperty;var He=(e,t)=>Ve(vt(e,"raw",{value:Ve(t||e.slice())}));import{j as a,h as ee,d as wt,r as s,_ as re,u as tt,o as bt,M as ne,c as pt}from"./kfrdmkli83ureki3.js";import{dR as se,cy as X,aB as xe,dg as yt,e7 as Mt,au as We,kh as $e,vc as St,lX as qe,je as jt,ki as Ke,u as de,dT as It,ak as kt,dj as at,J as nt,d_ as Rt,az as le,cv as Nt,aA as ge,dP as Et,N as st,hB as Ct,hn as At,ho as Gt,aZ as Dt,D as _e,M as Tt,hM as Pt,_ as Ut,V as ve,O as it,R as ue,l as Bt,ab as zt,p as ot,g as Ot,d as Le,j9 as Ft,qp as Vt,br as Ht,bk as Wt}from"./kw08ajijqinojrwh.js";import{I as fe,D as rt,u as $t}from"./br37mqd0to5xlxv3.js";import{b7 as qt,fF as Kt,jH as Lt,jI as Jt,uy as Qt,d_ as Y,dg as Xt,uz as Yt,uA as Zt,uB as ea,bN as lt,d$ as pe,uC as ta,uD as A,uE as aa,h_ as we,it as ct,uF as na,uG as Je,uH as sa,uI as ia}from"./fyw02vlaiv2vq6cj.js";import{C as ut}from"./fxythiulbb2q3qno.js";import{D as oa}from"./c5rze1h9e62gir74.js";import{C as ra}from"./ke280zfvfnrfnfvu.js";import"./f1g778pkk2fhpy9x.js";import"./kzowh6fnaz3z8ldi.js";const dt=({children:e,isDimensionsUnknown:t})=>a.jsxs(se.div,{className:X(["relative max-w-[480px] rounded-2xl",t&&"aspect-square overflow-hidden"]),children:[a.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),a.jsx("div",{className:"relative h-full",children:e})]}),la=({children:e,isDimensionsUnknown:t,width:i,height:n})=>a.jsxs(se.div,{layout:!0,transition:{duration:.3,ease:"easeInOut"},exit:{opacity:0,transition:{duration:.1,ease:"easeInOut"}},className:X(["relative max-w-[480px] overflow-hidden rounded-2xl",t&&"aspect-square"]),style:{width:i!=null?i:"auto",height:n!=null?n:"auto"},children:[a.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),a.jsx("div",{className:"relative h-full",children:e})]}),ca=()=>{const e=ee(),t=wt();return a.jsxs("div",{className:"absolute start-0 bottom-0 flex w-full items-center justify-between bg-white/10 p-4",children:[a.jsxs("div",{className:"flex min-w-0 flex-col",children:[a.jsx("span",{className:"text-sm font-medium text-white",children:e.formatMessage({id:"PlfJ+x",defaultMessage:"Creation might take a moment"})}),a.jsx("span",{className:"text-sm font-normal text-white/80",children:e.formatMessage({id:"4JG8yC",defaultMessage:"Upgrade to create faster"})})]}),a.jsx(xe,{size:"medium",color:"primary-inverse",onClick:()=>qt(t,"Image Gen Latency Upsell"),children:e.formatMessage(yt.getPlus)})]})};function ua(e){const[t,i]=Mt(We.ImageGenProgressUpsellV2,null,r=>r!=null&&typeof r=="object"&&(typeof r.lastSeenUpsellAt=="number"||r.lastSeenUpsellAt==null)&&(typeof r.lastUsedImageGen=="number"||r.lastUsedImageGen==null)&&(typeof r.lastMessageId=="string"||r.lastMessageId==null)&&(typeof r.lastCanBeSeen=="boolean"||r.lastCanBeSeen==null)),n=t&&t.lastSeenUpsellAt?$e(t.lastSeenUpsellAt):null,o=t&&t.lastUsedImageGen?$e(t.lastUsedImageGen):null,d=e?t&&t.lastMessageId===e?t.lastCanBeSeen:(n==null||St(n,qe(new Date,3)))&&o!=null&&jt(o,qe(new Date,1)):!1;return{canBeSeen:d,markImageGenUsed:()=>{var r;if(e){const h={lastSeenUpsellAt:d?Ke(new Date):(r=t==null?void 0:t.lastSeenUpsellAt)!=null?r:null,lastUsedImageGen:Ke(new Date),lastMessageId:e!=null?e:null,lastCanBeSeen:d};i(h),localStorage.setItem(We.ImageGenProgressUpsellV2,JSON.stringify(h))}}}}function da(){const[t,i]=s.useState(new Date);s.useEffect(()=>{i(new Date)},[]);const n=Lt(+t,12e4);return a.jsx(Jt,{percentage:n,sizeOverride:30,thickness:1/15,className:"text-white",backgroundStrokeClassName:"stroke-white/20",transitionDuration:"".concat((100-n)/100*.2,"s"),transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})}const gt=({isGettingStarted:e,messageId:t})=>{var x;const i=de(),n=It(),o=(x=n==null?void 0:n.isFree())!=null?x:!1,{canBeSeen:d,markImageGenUsed:c}=ua(t),r=o&&d&&kt(i,"1997515563").get("should_show_image_gen_latency_upsell",!1);Kt(()=>{c()});const h=ee(),u=s.useMemo(()=>e?h.formatMessage({id:"SxQKjt",defaultMessage:"Getting started"}):h.formatMessage({id:"Y3ETLn",defaultMessage:"Creating image"}),[e,h]),l=at(i,"3019066937").get("should_show_cot_header",!1),f=nt(i,"3018147683"),v=s.useMemo(()=>e?a.jsx(ut,{size:30,arcPercentage:.2,strokeWidth:2}):a.jsx(da,{}),[e]);return a.jsxs("div",{className:X("absolute inset-0 flex justify-between px-6 py-6",r?"items-start":"items-end"),children:[a.jsxs(Rt,{mode:"popLayout",children:[l&&a.jsx(se.span,{className:X("flex items-center gap-1 align-middle text-lg",!e&&"text-white"),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,overflow:"hidden",whiteSpace:"nowrap"},transition:{duration:.1,ease:"easeInOut"},children:u},u),!f&&a.jsx("div",{className:"flex flex-1 items-center justify-end",children:v})]}),r&&a.jsx(ca,{})]})},ga=le(()=>re(()=>import("./km44ch1r0uf907fx.js"),__vite__mapDeps([0,1])),{loading:e=>ge(e)}),ma=le(()=>re(()=>import("./fx3vo65j1l2o1ay3.js"),__vite__mapDeps([2,1])),{loading:e=>ge(e)}),fa=le(()=>re(()=>import("./m6idklazvjc7d344.js"),__vite__mapDeps([3,1])),{loading:e=>ge(e)});var et;const Qe=Nt.div(et||(et=He(["invisible absolute top-3 flex gap-1 group-hover/paragen-image:visible z-2\n  ","\n  ",""])),({$rightAlign:e})=>e?"end-3":"start-3",({$alwaysVisible:e})=>e?"visible":""),ha=({imageUrl:e})=>{const[t,i]=s.useState(void 0),n=ee(),o=Qt(),d=s.useCallback(()=>{const c=new Date,r=n.formatDate(c,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});return"".concat(r,".png")},[n]);return a.jsxs("div",{className:"group/paragen-image absolute inset-0 z-3",children:[a.jsxs(Qe,{$alwaysVisible:!0,children:[t!==!1&&a.jsx(fe,{icon:ga,selected:t===!0,variant:"large",onClick:c=>{c.stopPropagation(),Y.paragenImageRated({liked:!0,analyticsContext:o}),i(!0)}}),t!==!0&&a.jsx(fe,{icon:ma,selected:t===!1,variant:"large",onClick:c=>{c.stopPropagation(),Y.paragenImageRated({liked:!1,analyticsContext:o}),i(!1)}})]}),a.jsx(Qe,{$alwaysVisible:!0,$rightAlign:!0,children:a.jsx(fe,{icon:fa,variant:"large",onClick:c=>{c.stopPropagation(),Y.paragenDownload({analyticsContext:o}),Xt({url:e,fileName:d()})}})})]})};function mt({withLottie:e}){const i=ee().formatMessage({id:"imagegen.progressIndicator.ariaLabel",defaultMessage:"Generating image..."});return a.jsx("div",{className:"absolute start-0 top-0 flex h-full w-full items-center justify-center rounded-full","aria-label":i,children:a.jsx(ut,{size:40,arcPercentage:.2,children:a.jsx(oa,{animate:e,matchTextColor:!0,className:"h-6 w-6"})})})}const ft=300,xa=1.3,Xe=.05,_a=/blur\(([\d.]+)px\)/,va={duration:ft/1e3,ease:"linear"};function he(e,t,i){var c,r,h,u,l;e.sort((f,v)=>f.lastSrcReceivedTime-v.lastSrcReceivedTime);const n=new Array(e.length).fill(0);for(let f=0;f<=e.length;f+=1){const v=f-1,x=f,p=(r=(c=e[v])==null?void 0:c.availablePercentComplete)!=null?r:0,I=(u=(h=e[x])==null?void 0:h.availablePercentComplete)!=null?u:1;if(t>=p&&t<=I&&p!==I){const _=(t-p)/(I-p);n[v]=1-_,n[x]=_}}const o=n[n.length-1],d=n[n.length-2];return o===1&&d===0&&(n[n.length-2]=.01),i&&t<=((l=e[0])==null?void 0:l.availablePercentComplete)&&(n[0]=1),n}const wa=({alt:e,src:t,availablePercentComplete:i,onAnimationUpdate:n,ignoreFirstChunk:o=!1,isTransparent:d=!1,dimensions:c,onError:r,unconstrainedWidth:h=!1,progressLoaderProps:u})=>{const l=Et(),f=s.useMemo(()=>"url(".concat(l?Yt:Zt,")"),[l]),[v,x]=s.useState(!1),[p,I]=s.useState(1e3),[_,b]=s.useState(i!=null?i:0),[j,S]=s.useState(i===1?1:0),R=s.useRef(performance.now()),E=s.useRef(0),k=s.useRef([]),[B,W]=s.useState([0]),[G,T]=s.useState(i===1),z=s.useRef(!1),K=s.useRef(null),C=_===1,P=i===1&&G,O=c?c.width/c.height:1;s.useEffect(()=>{!v&&i&&(x(!0),E.current=performance.now())},[v,i]),s.useEffect(()=>{var M;const w=(M=k.current[k.current.length-1])==null?void 0:M.src;if(t&&t!==w){const N=k.current.findIndex(F=>F.availablePercentComplete===i);N!==-1?k.current[N]={src:t,availablePercentComplete:i!=null?i:0,lastSrcReceivedTime:performance.now()}:k.current.push({src:t,availablePercentComplete:i!=null?i:0,lastSrcReceivedTime:performance.now()}),W(he(k.current,_,o))}},[t,_,o,i]);const L=s.useCallback(()=>{K.current&&i&&(I(P?ft:(performance.now()-R.current)*xa),(!o||z.current||i>=Xe)&&i!==1&&S(i),z.current=!0,R.current=performance.now(),u==null||u.setHasImageReady(!0))},[i,P,o,u]),te=s.useCallback(w=>{const M=parseFloat(w.height)/100;n==null||n(M),b(M),W(he(k.current,parseFloat(w.height)/100,o))},[n,o]),ae=s.useCallback(w=>{var H,J;const M=(J=(H=w.filter.toString().match(_a))==null?void 0:H[1])!=null?J:"0",F=(16-parseFloat(M))/16,Z=1-j,$=j+Z*F;n==null||n($),b($),W(he(k.current,$,o))},[o,j,n]);if(!v)return a.jsx(dt,{isDimensionsUnknown:!0,children:a.jsx(mt,{withLottie:!0})});const m={duration:p/1e3,ease:"linear"},y=i!==1||!d;return a.jsxs("div",{className:X("relative z-0 cursor-pointer overflow-hidden",O<1?"max-w-[400px]":"max-w-[480px]",!C&&"pointer-events-none",!z.current&&"bg-token-main-surface-secondary",h&&"max-w-full"),"aria-label":e,style:{aspectRatio:O},children:[!(u!=null&&u.shouldHideDiagonalShimmer)&&i&&i<Xe&&a.jsx("div",{className:"absolute inset-0 z-3 w-full overflow-hidden",children:a.jsx("div",{className:"absolute start-[-150%] top-[-150%] h-[400%] w-[400%]",children:a.jsx("div",{className:"diagonal-sweep-gradient h-full w-full"})})}),a.jsxs(se.div,{className:"absolute start-0 end-0 top-0 z-2 w-full overflow-hidden transition-[mask] ease-linear",initial:P?!1:{height:"0%"},animate:C?{height:"100%"}:{height:"".concat(j*100,"%")},onUpdate:P?void 0:te,transition:P?{duration:0,ease:"linear"}:m,style:C?void 0:{mask:"linear-gradient(rgb(0,0,0) 0%, rgb(0,0,0) calc(100% - 24px), rgba(0,0,0,0) 100%)"},children:[t&&a.jsx("img",{ref:K,src:t,onLoad:L,onError:r,alt:e,className:"absolute top-0 z-1 w-full",style:{aspectRatio:O}}),d&&a.jsx("div",{className:"absolute inset-0 z-0 w-full overflow-hidden opacity-0 transition-opacity duration-300 group-hover/imagegen-image:opacity-100 group-focus/imagegen-image:opacity-100",children:a.jsx("div",{className:"absolute inset-0 bg-repeat",style:{backgroundImage:f,backgroundSize:"auto"}})})]}),a.jsx(se.div,{className:"relative z-1 w-full overflow-hidden",initial:{filter:"blur(16px)"},animate:P?{filter:"blur(0px)"}:void 0,transition:P?va:void 0,onUpdate:P?ae:void 0,style:{aspectRatio:O},children:k.current.map((w,M)=>{const N=B[M],F=w.availablePercentComplete===1;return N!==0||F?a.jsx("img",{src:w.src,alt:e,style:{opacity:N,willChange:"opacity",aspectRatio:O},className:!P&&(u!=null&&u.shouldShowPulseAnimation)?"bg-scale-pulse":"",onLoad:F?()=>T(!0):void 0},w.src):null})}),a.jsx(se.div,{className:"absolute inset-0 z-0 scale-110 overflow-hidden blur-2xl",style:{aspectRatio:O},children:y&&k.current.filter((w,M)=>B[M]!==0).map(w=>a.jsx("img",{src:w.src,alt:e,className:"absolute top-0 w-full"},w.src))})]})},ba=({imageAssetPointer:e,serverThreadId:t})=>{var u;const[i,n]=s.useState(void 0),o=de(),d=ea(o),c=(u=e.metadata)==null?void 0:u.watermarked_asset_pointer,r=s.useRef(!1),h=!st(o);return s.useEffect(()=>{if(d&&c&&!r.current){r.current=!0;const l=Ct(c);At(l,void 0,h,t,!1).then(f=>{f.status===Gt.Success&&n(f.download_url)}).catch(f=>{f instanceof Dt||_e.addError(new Error("Could not fetch watermarked image with ID ".concat(c," from file service"),{cause:f}))})}},[d,c,h,t]),i},Ye=2,ce=({pointer:e,altLabel:t,isEditorAvailable:i,onPercentageRendered:n,messageId:o,imageIndex:d,clientThreadId:c,serverThreadId:r,onEditorClick:h,compact:u,progressLoaderProps:l})=>{var M,N,F,Z,$,H,J;const f=de(),v=tt(),[x,p]=s.useState(void 0),I=s.useRef(void 0),_=(N=(M=e.metadata)==null?void 0:M.generation)==null?void 0:N.gen_id,b=($=(Z=(F=e.metadata)==null?void 0:F.generation)==null?void 0:Z.height)!=null?$:void 0,j=e.height,S=(b!=null?b:0)/j,R=s.useRef({}),[E]=bt(),k=!st(f),[B,W]=s.useState(!1),G=s.useContext(rt),T=e.width/e.height,z=ba({imageAssetPointer:e,serverThreadId:r}),K=s.useCallback((D=!1)=>{!D&&I.current===e.asset_pointer||(I.current=e.asset_pointer,lt.fetch(v,{asset:e,conversationId:r,force:D,isUnauthenticated:k}).then(q=>{p(q)}).finally(()=>{I.current=void 0}))},[e,v,r,k]);s.useEffect(()=>{const D=e.asset_pointer!==(x==null?void 0:x.asset_pointer);(!x||D)&&K()},[x,e.asset_pointer,K]);const C=s.useMemo(()=>pe({pointer:x,conversationId:r,messageId:o,source:G?"paragen":"chat",imageIndex:d.toString()}),[x,r,o,G,d]),P=s.useRef(S);s.useEffect(()=>{S===1&&P.current<1&&Y.renderingComplete({analyticsContext:C})},[S,C]);const O=s.useCallback(()=>{x&&(h==null||h({image:x,messageId:o,analyticsContext:C}))},[x,o,h,C]),L=s.useMemo(()=>({width:e.width,height:e.height}),[e]),te=s.useCallback(()=>{var q;const D=((q=R.current[e.asset_pointer])!=null?q:0)+1;if(R.current[e.asset_pointer]=D,R.current[e.asset_pointer]>Ye)return _e.addAction("image-gen-asset-error",{name:"retries-exhausted",conversation_id:r,asset_pointer:e.asset_pointer,max_retries:Ye});_e.addAction("image-gen-asset-retry",{name:"retry-attempted",conversation_id:r,asset_pointer:e.asset_pointer,current_retry:D}),R.current[e.asset_pointer]=D,K(!0)},[e.asset_pointer,K,r]),ae=s.useCallback(D=>{D===1&&W(!0),n==null||n(D)},[n]),g=s.useRef(null),m=s.useRef(null);s.useEffect(()=>{if(g.current&&(l!=null&&l.setContainerSize)){const D=g.current.getBoundingClientRect(),q={width:D.width,height:D.height},ie=m.current;(!ie||ie.width!==q.width||ie.height!==q.height)&&(m.current=q,l.setContainerSize(q))}},[l]);const y=x==null?void 0:x.url,w=z!=null?z:y;return a.jsx(ta.Provider,{value:C,children:a.jsxs("div",{ref:g,className:X("group/imagegen-image relative w-full overflow-hidden",T<1?"max-w-[400px]":"max-w-[480px]",u?"rounded-lg":"rounded-2xl",G&&"max-w-full",o===E.get("image")&&"[view-transition-name:var(--vt-active-image)]"),id:"image-".concat(o),style:{aspectRatio:T},onClick:i?O:void 0,tabIndex:0,children:[z&&a.jsx("img",{alt:t,className:"absolute inset-0 z-1 opacity-0",src:z}),a.jsx(wa,{alt:t,src:y,availablePercentComplete:S,onAnimationUpdate:ae,isEditorAvailable:i,ignoreFirstChunk:!0,isTransparent:(J=(H=e.metadata)==null?void 0:H.generation)==null?void 0:J.transparent_background,dimensions:L,onError:te,unconstrainedWidth:G,progressLoaderProps:l},_),(l==null?void 0:l.state)&&(l==null?void 0:l.state)!==A.Complete&&!B&&(l==null?void 0:l.hasImageReady)&&a.jsx(gt,{isGettingStarted:!1,messageId:o}),B&&!u&&(G?a.jsx(ha,{imageUrl:y!=null?y:""}):a.jsx(aa,{imageAssetPointer:y,imageUrl:w,messageId:o,clientThreadId:c,serverThreadId:r,shouldShowOverflow:z!==void 0}))]},_)})},pa=({imageGenerationState:e,isInterrupted:t,asyncMessage:i,imageAssetPointer:n,altLabel:o,clientThreadId:d,serverThreadId:c,onEditorClick:r,isEditorAvailable:h,setAnimationPercentage:u,messageId:l})=>{var j;const[f,v]=s.useState(null),x=f==null,[p,I]=s.useState(!0),_=e===A.Thinking||e===A.AsyncGenerating&&!((j=i==null?void 0:i.metadata)!=null&&j.is_visually_hidden_from_conversation),b=e===A.Generating||e===A.Complete;return s.useEffect(()=>{_&&I(!1)},[_]),t?null:a.jsxs("div",{className:b?"relative pb-2":"relative",children:[(_||!p)&&a.jsx(la,{isDimensionsUnknown:x,width:f==null?void 0:f.width,height:f==null?void 0:f.height,children:x&&a.jsx(gt,{isGettingStarted:!0,messageId:l})}),b&&a.jsx(se.div,{className:p?"relative":"absolute inset-0 w-full",variants:{hidden:{opacity:0},visible:{opacity:1}},initial:"hidden",animate:p?"visible":"hidden",exit:"hidden",children:n&&a.jsx(ce,{pointer:n,altLabel:o,isEditorAvailable:h,onPercentageRendered:u,messageId:l,clientThreadId:d,serverThreadId:c,imageIndex:0,onEditorClick:r,progressLoaderProps:{state:e,setContainerSize:v,hasImageReady:p,setHasImageReady:I,shouldHideDiagonalShimmer:!0,shouldShowPulseAnimation:!0}})})]})};function ya({title:e,description:t,shimmer:i}){return!e&&!t?null:a.jsxs("div",{className:"border-token-border-default my-2 max-w-[480px] min-w-72 rounded-2xl border p-6",children:[!!e&&a.jsx("p",{className:X("text-lg font-medium",i&&"loading-shimmer-pure-text-inverted",!!t&&"mb-1"),children:e}),!!t&&a.jsx("p",{children:t})]})}const Ma=({pointersToRender:e,altLabel:t,isEditorAvailable:i,updatePercentageRendered:n,toolCallMessage:o,toolOutputMessageIds:d,clientThreadId:c,serverThreadId:r,handleEditorClick:h})=>{const u=we.useStore(),l=we.useSelectedIndex();s.useEffect(()=>{u.setSelectedIndex(Math.max(d.findIndex(j=>{var S;return j===((S=o==null?void 0:o.metadata)==null?void 0:S.selected_image_message_id)}),0))},[]);const f=s.useRef({}),v=s.useCallback(j=>S=>{f.current[j]=S;const R=Object.keys(f.current).length,E=Object.values(f.current).reduce((k,B)=>k+B,0);n==null||n(E/R)},[n]),[x,p]=s.useState(null),I=Tt(c,ve.getRequestId),_=Pt(I);s.useEffect(()=>{!_&&x!=null&&o!=null&&r!=null&&(be(o.id,d[x],c,r),p(null))},[_]);const b=s.useCallback(j=>{u.setSelectedIndex(j);const S=Object.values(f.current);Ut.logEventWithStatsig("chatgpt_image_switched","chatgpt_image_switched",{conversationId:r,messageId:d[j],imageIndex:j.toString(),isLoading:(S.length===0||S.some(k=>k<1)).toString()});const R=ve.getConversationLastTurn(it(c)),E=(R==null?void 0:R.messages.find(k=>k.id===(o==null?void 0:o.id)))!=null;o!=null&&r!=null&&(E&&_?p(j):be(o.id,d[j],c,r))},[o,d,c,r,u,_,p]);return a.jsxs("div",{className:"flex gap-2",children:[a.jsx(ce,{pointer:e[l],altLabel:t,isEditorAvailable:i,messageId:d[l],imageIndex:l,clientThreadId:c,serverThreadId:r,onEditorClick:h},d[l]),a.jsx("div",{className:"flex flex-col gap-2",children:e.map((j,S)=>{var R,E;return a.jsx(Sa,{pointer:j,altLabel:t,isSelected:S===l,onClick:()=>b(S),onPercentageRendered:(E=(R=j.metadata)==null?void 0:R.generation)!=null&&E.gen_id?v(j.metadata.generation.gen_id):void 0,messageId:d[S],imageIndex:S,clientThreadId:c,serverThreadId:r},d[S])})})]})},Sa=({pointer:e,altLabel:t,isSelected:i,onClick:n,onPercentageRendered:o,messageId:d,imageIndex:c,clientThreadId:r,serverThreadId:h})=>a.jsxs("button",{type:"button",onClick:n,className:"relative w-14 rounded-lg p-1",children:[a.jsx("div",{className:X(i&&"opacity-70"),children:a.jsx(ce,{pointer:e,altLabel:t,isEditorAvailable:!1,onPercentageRendered:o,messageId:d,imageIndex:c,clientThreadId:r,serverThreadId:h,compact:!0})}),i&&a.jsx("div",{className:"border-token-border-default pointer-events-none absolute inset-0 rounded-xl border-2"})]});async function be(e,t,i,n){const o=await ue.safePost("/image-gen/message-select",{requestBody:{message_id:e,selected_image_message_id:t,conversation_id:n}}),d=o.id;d!=null&&Bt(i,c=>{zt.updateTree(c,r=>{r.updateNodeMessage(d,o)})})}const Ze=le(()=>re(()=>import("./n70q0rscelh7atg0.js"),__vite__mapDeps([4,1])),{loading:e=>ge(e)}),ja=({clientThreadId:e,serverThreadId:t,toolCallMessageId:i,pointers:n,messageIds:o,isEditorAvailable:d,onEditorClick:c,onComplete:r,onPercentageRendered:h})=>{"use no forget";const u=ee(),l=ot(),f=s.useMemo(()=>n.length>0&&o.length===n.length&&n.every(g=>typeof g.width=="number"&&g.width>0&&typeof g.height=="number"&&g.height>0),[o.length,n]),[v,x]=s.useState(()=>n.map(()=>!1)),[p,I]=s.useState(!1),[_,b]=s.useState(null),[j,S]=s.useState(!1),R=s.useRef(null),E=s.useRef(null),k=s.useRef(!1),B=ct.useStore();s.useEffect(()=>{f&&x(g=>g.length===n.length?g:n.map(()=>!1))},[f,n]),s.useEffect(()=>{R.current=Math.floor(Date.now()/1e3),E.current=null},[n,o]),s.useEffect(()=>{v.every(Boolean)&&E.current==null&&(E.current=Math.floor(Date.now()/1e3))},[v]);const G=v.length===n.length&&v.every(Boolean)&&!j;s.useEffect(()=>(B.setIsMultigenParagenVotingActive(G),()=>{B.setIsMultigenParagenVotingActive(!1)}),[B,G]);const T=s.useMemo(()=>{if(n.length<2)return!1;const[g,...m]=n,y=g.width,w=g.height;if(!y||!w)return!1;const M=y/w;return m.every(N=>{if(!N.width||!N.height)return!1;const F=N.width/N.height;return Math.abs(F-M)<.001})},[n]),z=s.useMemo(()=>n.map(g=>{const m=g.width,y=g.height;return!m||!y?1:m/y}),[n]),K=s.useMemo(()=>z.map(g=>"".concat(Number.isFinite(g)&&g>0?g:1,"fr")).join(" "),[z]),C=s.useMemo(()=>n.map((g,m)=>o[m]).filter(g=>typeof g=="string"),[n,o]);s.useEffect(()=>{var M,N;if(k.current||!t||!v.every(Boolean)||C.length!==n.length)return;k.current=!0;const g=(M=R.current)!=null?M:Math.floor(Date.now()/1e3),m=(N=E.current)!=null?N:g,y=Math.floor(Date.now()/1e3),w=T?"horizontal_buttons":"vertical_buttons";ue.safePost("/image-gen/image-paragen-display",{requestBody:{conversation_id:t,displayed_message_ids:C,count:n.length,render_format:w,load_start_ts_utc:g,load_end_ts_utc:m,event_ts_utc:y}}).catch(()=>{})},[v,t,T,C,n.length]);const P=s.useMemo(()=>o.length!==n.length?[]:n.map((g,m)=>pe({pointer:g,conversationId:t,messageId:o[m],source:"paragen",imageIndex:m.toString()})),[o,n,t]),O=s.useCallback(g=>m=>{h==null||h(m),!(m<1)&&x(y=>{if(y[g])return y;const w=[...y];return w[g]=!0,w})},[h]),L=s.useCallback(async g=>{var y,w;if(!t){l.danger(u.formatMessage({id:"imageParagen.multigen.missingConversationError",defaultMessage:"We couldn’t submit your choice because the conversation isn’t saved yet."})),S(!0),r();return}const m=o[g];if(!m){l.danger(u.formatMessage({id:"imageParagen.multigen.missingMessageError",defaultMessage:"We couldn’t submit your choice. Please try again."})),S(!0),r();return}I(!0),b(g);try{const M=(y=R.current)!=null?y:Math.floor(Date.now()/1e3),N=(w=E.current)!=null?w:M,F=Math.floor(Date.now()/1e3),Z=T?"horizontal_buttons":"vertical_buttons";await ue.safePost("/image-gen/image-paragen-submit",{requestBody:{conversation_id:t,selected_message_id:m,count:n.length,render_format:Z,load_start_ts_utc:M,load_end_ts_utc:N,event_ts_utc:F}});const $=P[g];if($&&Y.paragenImageRated({liked:!0,analyticsContext:$}),P.forEach((H,J)=>{!H||J===g||Y.paragenImageRated({liked:!1,analyticsContext:H})}),i&&t)try{await be(i,m,e,t)}catch(H){}I(!1),b(null),S(!0),r()}catch(M){I(!1),b(null),l.danger(u.formatMessage({id:"imageParagen.multigen.submitError",defaultMessage:"We couldn’t submit your choice. Please try again."}))}},[P,e,u,o,r,n.length,t,l,i,T]),te=s.useCallback(async()=>{var g,m;if(!t){l.danger(u.formatMessage({id:"imageParagen.multigen.missingConversationError",defaultMessage:"We couldn’t submit your choice because the conversation isn’t saved yet."})),S(!0),r();return}I(!0);try{const y=(g=R.current)!=null?g:Math.floor(Date.now()/1e3),w=(m=E.current)!=null?m:y,M=Math.floor(Date.now()/1e3),N=T?"horizontal_buttons":"vertical_buttons";await ue.safePost("/image-gen/image-paragen-dismiss",{requestBody:{conversation_id:t,dismissed_message_ids:C,count:n.length,render_format:N,load_start_ts_utc:y,load_end_ts_utc:w,event_ts_utc:M}}),S(!0),r()}catch(y){l.danger(u.formatMessage({id:"imageParagen.multigen.dismissError",defaultMessage:"We couldn’t skip the image comparison. Please try again."}))}finally{I(!1)}},[t,l,u,r,C,n.length,T]),ae=s.useMemo(()=>n.map((g,m)=>u.formatMessage({id:"imageParagen.multigen.imageAlt",defaultMessage:"Generated image {index}"},{index:m+1})),[u,n]);return f?a.jsxs("div",{"data-testid":"image-paragen-multigen",children:[G&&a.jsxs("div",{className:"flex flex-wrap items-start gap-2 pb-4 md:flex-nowrap md:justify-between",children:[a.jsx("div",{className:"flex flex-col gap-1 md:max-w-[70%]",children:a.jsx("p",{className:"text-token-text-primary text-base",children:a.jsx(ne,{id:"imageParagen.multigen.prompt",defaultMessage:"Which image do you like more?"})})}),a.jsx("button",{type:"button",onClick:te,disabled:p,className:X("text-token-text-tertiary hover:text-token-text-primary ms-auto whitespace-nowrap",p&&"pointer-events-none opacity-60"),children:a.jsx("span",{className:"underline decoration-dotted",children:a.jsx(ne,{id:"imageParagen.multigen.skip",defaultMessage:"Skip"})})})]}),a.jsx("div",{className:X("grid [grid-template-columns:var(--paragen-cols)] gap-3",T?"md:gap-2":"md:gap-3"),style:{"--paragen-cols":K},children:n.map((g,m)=>{var y,w,M;return a.jsxs("div",{className:"flex flex-col gap-3",children:[a.jsxs("div",{className:"relative",children:[a.jsx(ce,{pointer:g,altLabel:(y=ae[m])!=null?y:"Generated image",isEditorAvailable:d,onEditorClick:c,onPercentageRendered:O(m),messageId:(w=o[m])!=null?w:String(m),imageIndex:m,clientThreadId:e,serverThreadId:t,compact:!0}),G&&a.jsx("div",{className:"absolute start-0 bottom-0 flex h-6 w-6 items-center justify-center rounded-md bg-black px-1 text-center text-sm font-semibold text-white dark:bg-white dark:text-black",children:a.jsx(ne,{id:"imageParagen.multigen.imageLabel",defaultMessage:"{index, number}",values:{index:m+1}})})]}),T&&G&&a.jsxs(xe,{fullWidth:!0,size:"large",color:"secondary",className:"justify-start gap-2 text-start",disabled:p,loading:_===m&&p,onClick:()=>L(m),children:[a.jsx(Ze,{"aria-hidden":"true",className:"text-token-text-primary me-2"}),a.jsx("span",{className:"sm:hidden",children:a.jsx(ne,{id:"imageParagen.multigen.choiceShort",defaultMessage:"Image {index}",values:{index:m+1}})}),a.jsx("span",{className:"hidden sm:inline",children:a.jsx(ne,{id:"imageParagen.multigen.choice",defaultMessage:"Image {index} is better",values:{index:m+1}})})]})]},(M=o[m])!=null?M:m)})}),!T&&G&&a.jsx("div",{className:"mt-4 flex flex-col gap-2 md:items-start",children:n.map((g,m)=>a.jsxs(xe,{fullWidth:!0,size:"large",color:"secondary",className:"justify-start gap-2 text-start md:w-1/2",disabled:p,loading:_===m&&p,onClick:()=>L(m),children:[a.jsx(Ze,{"aria-hidden":"true",className:"text-token-text-primary me-2"}),a.jsx("span",{className:"sm:hidden",children:a.jsx(ne,{id:"imageParagen.multigen.choiceShort",defaultMessage:"Image {index}",values:{index:m+1}})}),a.jsx("span",{className:"hidden sm:inline",children:a.jsx(ne,{id:"imageParagen.multigen.choice",defaultMessage:"Image {index} is better",values:{index:m+1}})})]},"choice-".concat(m)))}),a.jsx("div",{className:"mt-2"})]}):null},Ia=e=>{"use forget";const t=pt.c(7),{conversation:i,cotMessages:n,visualPercentComplete:o,isInterrupted:d,state:c}=e,r=d===void 0?!1:d,h=ee();let u;t[0]!==h?(u=h.formatMessage({id:"imagegen.thinkingHeader.interrupted",defaultMessage:"Stopped creating image"}),t[0]=h,t[1]=u):u=t[1];const l=u,f=c===A.Complete||o===1;let v;e:{if(r){v=l;break e}else if(!n){v=void 0;break e}if(f){v=n.complete;break e}if(o){const I=Object.keys(n.generating);for(let _=0;_<I.length;_=_+1,_){const b=parseFloat(I[_]);if(o<b){v=n.generating[I[_]];break e}}}else{v=n.thinking;break e}v=n.complete}const x=v;let p;return t[2]!==i||t[3]!==x||t[4]!==r||t[5]!==f?(p=x&&a.jsx(ra,{conversation:i,latestHeadline:x,isComplete:f||r,showChunkIcon:!1,isExpandDisabled:!0}),t[2]=i,t[3]=x,t[4]=r,t[5]=f,t[6]=p):p=t[6],p};function ka(e){const t=e.find(c=>c.author.role==="tool"&&c.author.name===na&&c.content.content_type==="text"),[i,...n]=(t==null?void 0:t.content.content_type)==="text"?t.content.parts:[],o=n.pop(),d=n.length;return i&&o&&n.length>0?{thinking:i,complete:o,generating:n.reduce((c,r,h)=>{const u=(h+1)/d;return c[u.toFixed(2)]=r,c},{})}:void 0}const Ra=e=>{const t=ee(),{size:i="image",count:n=1}=e||{};return n>1?{thinking:t.formatMessage({id:"cdnmKo",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"aTbInH",defaultMessage:"Creating images. May take a moment."}),"0.67":t.formatMessage({id:"WRM3Yw",defaultMessage:"Creating images. May take a moment."}),"1.00":t.formatMessage({id:"8ZydRG",defaultMessage:"Creating images. May take a moment."})},complete:t.formatMessage({id:"XQ81dl",defaultMessage:"Images created"})}:i==="xlimage"?{thinking:t.formatMessage({id:"y7op2E",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"cdrDJH",defaultMessage:"Creating image. May take a moment."}),"0.67":t.formatMessage({id:"RP4bRn",defaultMessage:"Adding details"}),"1.00":t.formatMessage({id:"o36MSQ",defaultMessage:"Finishing touches"})},complete:t.formatMessage({id:"QsnnBN",defaultMessage:"Image created"})}:{thinking:t.formatMessage({id:"6c7+kN",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"DP6/8y",defaultMessage:"Creating image"}),"0.67":t.formatMessage({id:"k9y1TT",defaultMessage:"Creating image"}),"1.00":t.formatMessage({id:"GpR7v3",defaultMessage:"Creating image"})},complete:t.formatMessage({id:"l2Izz4",defaultMessage:"Image created"})}},Na=le(()=>re(()=>import("./s6fvwzj20sqgu2sq.js"),__vite__mapDeps([5,1,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21])).then(e=>e.ImageGenConversationLightboxNew)),Ea=[A.Empty,A.Errored],Ca=e=>e!=null&&typeof e=="object"&&"image_gen_paragen_metadata"in e,Ha=({messages:e,clientThreadId:t,isLastTurnInConversation:i,isParagen:n=!1})=>{"use no forget";var J,D,q,ie,ye,Me,Se,je;const o=de(),d=Ot(o,t),c=Le(d.serverId$),r=ee(),h=r.formatMessage({id:"imagegen.message.altLabel",defaultMessage:"Generated image"}),{messageIds:u,imageAssetPointers:l}=s.useMemo(()=>Je(e),[e]),f=e.find(sa),v=we.useSelectedIndex(),x=(q=(D=(J=l==null?void 0:l[v])==null?void 0:J.metadata)==null?void 0:D.generation)==null?void 0:q.gen_size,p=Ra({size:x!=null?x:"image",count:(ie=l==null?void 0:l.length)!=null?ie:1}),I=s.useMemo(()=>{var U;return(U=ka(e))!=null?U:p},[e,p]),_=e.find(U=>{var Q;return(Q=U.metadata)==null?void 0:Q.image_gen_async}),b=s.useMemo(()=>ia(e,i),[e,i]),j=ot(),S=Ft(),R=s.useRef(!1),E=s.useRef(!1),k=s.useRef(null),B=s.useMemo(()=>pe({pointer:l[v],conversationId:c,messageId:u[v],source:n?"paragen":"chat",imageIndex:v.toString()}),[l,u,v,c,n]);s.useEffect(()=>{if(!R.current&&(b===A.Thinking||b===A.Generating))R.current=!0,k.current=performance.now();else if(R.current&&!E.current)if(b===A.Complete){const U=k.current?performance.now()-k.current:void 0;Y.generationSuccess({analyticsContext:B,durationMs:U}),E.current=!0}else b===A.Errored&&(Y.generationFailure({analyticsContext:B,errorReason:"assistant_error"}),E.current=!0)},[b,B]);const W=e[e.length-1],G=s.useMemo(()=>W&&Vt(W),[W]),T=Le(()=>Wt(d).id),z=at(o,"3019066937").get("should_use_new_ui",!1),K=nt(o,"3175281277")===!1,C=$t({clientThreadId:d.id})&&b===A.Complete,[P,O]=s.useState(0),L=s.useMemo(()=>u.join(","),[u]),[te,ae]=s.useState(null),g=s.useMemo(()=>{const U=new Set(u);return e.filter(Q=>U.has(Q.id))},[u,e]),m=s.useMemo(()=>l.length!==2||u.length!==2||g.length!==2?!1:g.every(U=>{const Q=U.metadata;if(!Ca(Q))return!1;const oe=Q.image_gen_paragen_metadata;return typeof oe=="object"&&(oe==null?void 0:oe.voted)!==!0}),[l.length,g,u.length]),w=K&&m&&i&&!(te===L),M=ct.useIsMultigenParagenVotingActive(),N=n||w,F=w&&M,Z=s.useCallback(()=>{ae(L)},[L]),$=tt(),H=s.useCallback(async({image:U,messageId:Q,analyticsContext:oe})=>{var Ce,Ae,Ge;if(S)return j.warning(r.formatMessage({id:"imagegen.message.editorClick.integratedVoiceMode",defaultMessage:"Exit voice mode to view / edit the image"}));const Ie=it(d.id),ht=Ie?ve.getConversationTurns(Ie).flatMap(V=>V.messages):e,{imageAssetPointers:xt,messageIds:ke}=Je(ht,{skipSort:!0}),Re=await Promise.all(xt.map(V=>V.asset_pointer===U.asset_pointer?Promise.resolve(U):lt.fetch($,{asset:V,conversationId:c}))),me=(Re.length>0?Re:[U]).map((V,De)=>{var Pe,Ue,Be,ze,Oe,Fe;const Te=ke[De]!=null?ke[De]:Q;return{id:(Be=(Ue=(Pe=V.metadata)==null?void 0:Pe.generation)==null?void 0:Ue.gen_id)!=null?Be:Te,archived:!1,transformationId:(Fe=(Oe=(ze=V.metadata)==null?void 0:ze.generation)==null?void 0:Oe.gen_id)!=null?Fe:null,url:V.url,assetPointer:V.asset_pointer,thumbnail:null,width:V.width,height:V.height,title:null,conversationId:c,messageId:Te}});Y.editorClick({sourceOperation:(Ge=(Ae=(Ce=U.metadata)==null?void 0:Ce.dalle)==null?void 0:Ae.edit_op)!=null?Ge:"none",analyticsContext:oe});const Ne=me.findIndex(V=>V.assetPointer===U.asset_pointer),_t=me.findIndex(V=>V.messageId===Q),Ee=Ne!==-1?Ne:_t;Ht(o,Na,{images:me,initialIndex:Ee===-1?0:Ee,conversation:d,currentModelId:T})},[S,d,e,o,j,r,$,c,T]);return Ea.includes(b)?null:a.jsx(rt.Provider,{value:N,children:a.jsx("div",{className:"flex flex-col",children:z?a.jsx(pa,{imageGenerationState:b,isInterrupted:G,asyncMessage:_,imageAssetPointer:l[0],altLabel:h,clientThreadId:d.id,serverThreadId:c,onEditorClick:H,setAnimationPercentage:O,isEditorAvailable:C,messageId:u[0]}):a.jsxs(a.Fragment,{children:[b!==A.Unavailable&&b!==A.AsyncGenerating&&b!==A.AsyncHanging&&!((ye=W==null?void 0:W.metadata)!=null&&ye.async_completion_id)&&!F&&a.jsx("div",{className:"pb-3",children:a.jsx(Ia,{conversation:d,cotMessages:I,visualPercentComplete:P,isInterrupted:G,state:b})}),b===A.Thinking&&!G&&a.jsx(dt,{isDimensionsUnknown:!0,children:a.jsx(mt,{withLottie:!0})}),b===A.AsyncGenerating&&!((Me=_==null?void 0:_.metadata)!=null&&Me.is_visually_hidden_from_conversation)&&a.jsx(ya,{shimmer:!0,title:(Se=_==null?void 0:_.metadata)==null?void 0:Se.ui_card_title,description:(je=_==null?void 0:_.metadata)==null?void 0:je.ui_card_description}),(b===A.Generating||b===A.Complete)&&!G&&a.jsx("div",{className:"pb-2",children:w?a.jsx(ja,{clientThreadId:d.id,serverThreadId:c,toolCallMessageId:f==null?void 0:f.id,pointers:l,messageIds:u,isEditorAvailable:C,onEditorClick:H,onComplete:Z,onPercentageRendered:O},L):l.length>1?a.jsx(Ma,{pointersToRender:l,altLabel:h,isEditorAvailable:C,updatePercentageRendered:O,toolCallMessage:f,toolOutputMessageIds:u,clientThreadId:d.id,serverThreadId:c,handleEditorClick:H}):a.jsx(ce,{pointer:l[0],altLabel:h,isEditorAvailable:C,onPercentageRendered:O,messageId:u[0],imageIndex:0,clientThreadId:d.id,serverThreadId:c,onEditorClick:H})})]})})})};export{Ha as ImageGenMessage};
//# sourceMappingURL=jjgwnthjqih7iirt.js.map

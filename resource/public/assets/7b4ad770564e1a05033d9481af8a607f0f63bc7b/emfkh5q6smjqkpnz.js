const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/iwr3smf9emayvqcc.js","assets/kfrdmkli83ureki3.js"])))=>i.map(i=>d[i]);
import{j as t,r as o,u as Q,M as z,h as V,_ as W}from"./kfrdmkli83ureki3.js";import{cm as B,cn as q,cV as R,gq as H,gr as K,gs as Y,cW as C,gt as J}from"./fyw02vlaiv2vq6cj.js";import{d_ as Z,cy as X,oP as k,av as F,aZ as $,aa as U,D as G,az as ee,aA as te}from"./kw08ajijqinojrwh.js";import{u as se}from"./o106qsyr0ujbylfd.js";import{g as ae,a as ne}from"./es2rtlpx3e8ow3h1.js";function ie({highlightedText:e,shouldShimmer:s,className:a}){return t.jsx(Z,{children:t.jsx("div",{className:X(s&&"loading-shimmer-pure-text","absolute start-0 top-0 flex h-8 gap-1 overflow-hidden",a),children:t.jsx("span",{children:e})})})}const oe=ee(()=>W(()=>import("./iwr3smf9emayvqcc.js"),__vite__mapDeps([0,1])),{loading:e=>te(e)}),O="Too many active automations";function pe({clientThreadId:e,currentGroupedMessage:s,nextMessage:a,isLastMessage:l,isRequestActive:n}){var S,_,M,D;const f=l||a,r=n&&!a,w=o.useRef(r);o.useEffect(()=>{r&&(w.current=r)},[r]);const d=s,h=o.useMemo(()=>{for(const c of(d==null?void 0:d.messages)||[]){const m=k(c.author.name);if((m==null?void 0:m.namespace)===F.DE1D73E)return m}},[d]),i=re(d,r),p=(S=i==null?void 0:i.automationId)!=null?S:"",j=(_=i==null?void 0:i.updatedAt)!=null?_:"0",x=i==null?void 0:i.error,[E,L]=o.useState(!0),{automation:u,error:g}=se(p);o.useEffect(()=>{g&&g instanceof $&&(g.status===404||g.status===410)&&L(!1)},[g]);const A=Q();o.useEffect(()=>{if(!E)return;const c=new Date(j),m=new Date(u==null?void 0:u.updated_at);!isNaN(c.getTime())&&!isNaN(m.getTime())&&m<c&&A.invalidateQueries({queryKey:B.getAutomationQueryKey(p)})},[u,p,j,E,A]);const b=d.messages,N=(D=(M=b[b.length-1])==null?void 0:M.metadata)==null?void 0:D.permissions,P=o.useMemo(()=>N==null?void 0:N.some(c=>c.type==="notification"&&c.status==="requested"),[N]);o.useEffect(()=>(x===O&&w.current&&q.setMaxBannerClientThreadId(e),()=>{q.clearMaxBannerClientThreadId()}),[x,e]),o.useEffect(()=>{R.initIfNeeded()},[]);const T=b[0].create_time,y=o.useRef(!1),v=me();if(o.useEffect(()=>{(async()=>{if(!v){R.clearNotificationRequest();return}if(y.current)return;await ce(u,P,T)&&(y.current=!0,R.setRequestingClientThreadId(e))})()},[u,T,e,P,v]),!r&&x&&x!==O)return t.jsx(ue,{errorUserMessage:i==null?void 0:i.errorUserMessage});if(E&&f){if(p)return u?t.jsx(H,{automation:u}):r?t.jsx(I,{functionName:h==null?void 0:h.functionName}):t.jsx(K,{});if(r&&h)return t.jsx(I,{functionName:h.functionName})}return null}function I({functionName:e}){const s=V();return t.jsx("div",{className:"text-token-text-secondary relative my-2 h-8 first:mt-0",children:t.jsx(ie,{highlightedText:s.formatMessage(e==="update"?C.updatingAutomation:C.makingAutomation),className:"me-1.5 mt-1 items-center justify-start",shouldShimmer:!0})})}function re(e,s){return o.useMemo(()=>{var l;if(s)return;const a=(l=e==null?void 0:e.messages)==null?void 0:l.find(n=>{const f=k(n.author.name);return(f==null?void 0:f.namespace)===F.DE1D73E});if(a)try{const n=JSON.parse(U(a));return n.status==="ERROR"?{error:n.message,errorUserMessage:n.user_message}:{automationId:n.jawbone.id,updatedAt:n.jawbone.updated_at}}catch(n){G.addError("Jawbone: Failed to parse automation message",{cause:n});return}},[e,s])}function ue({errorUserMessage:e}){return t.jsxs("div",{className:"text-token-text-error flex items-center gap-1.5 pb-1",children:[t.jsx(oe,{className:"icon"}),t.jsx("div",{children:e!=null?e:t.jsx(z,{id:"oOQhkY",defaultMessage:"Task scheduling wasn’t completed — please ask again."})})]})}async function ce(e,s,a){if(!e||!s||!a)return!1;const l=new Date(a*1e3);if(!(Math.abs(new Date().getTime()-l.getTime())<=300*1e3))return!1;const r=J.getLastRequestTime();return!(r&&Date.now()-new Date(r).getTime()<1440*60*1e3||J.getPermission()==="denied"||!await ae()||await ne())}function me(){const{data:e}=Y({alwaysRefetchOnMount:!1});return e==null?void 0:e.some(s=>s.category==="tasks"&&s.options.some(a=>a.channel==="push"&&a.enabled))}export{pe as JawboneMessage};
//# sourceMappingURL=emfkh5q6smjqkpnz.js.map

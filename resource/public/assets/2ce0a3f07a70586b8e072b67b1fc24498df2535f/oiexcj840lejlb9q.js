import{r as t,b as z,al as $,j as u,M as j}from"./n97h6so7iblif4c5.js";import{D as L,eq as G,t as O,kT as B,B as W,bj as T,d as D,ap as q,P as H,a6 as V}from"./cim4usely8ixso70.js";import{hZ as P,h_ as N,h$ as U,ao as I}from"./ivbsxyeeopn30y8l.js";function k(s,r){return e=>{L.addAction(`${s}.${r}`,e)}}function Z(s){return(r,e)=>{L.addError(r,{...e,name:s,status:"error"})}}const w={recording:{start:k("whisper-recording","start"),cancel:k("whisper-recording","cancel"),submit:k("whisper-recording","submit")},transcription:{request:k("whisper-transcription","request"),transcriptDelivered:k("whisper-transcription","transcriptDelivered"),error:Z("whisper-transcription"),requestSuccess:k("whisper-transcription","requestSuccess")}};class X{static async transcribe(r,e,S={}){const h=new FormData;h.append("file",r),e&&h.append("language",e);const d={durationMs:S.durationMs,language:e,fileSize:r.size},l=performance.now();return w.transcription.request(d),G.post(`${O}/transcribe`,h).then(n=>{const o=performance.now()-l;return w.transcription.requestSuccess({...d,durationMs:o}),n}).catch(n=>{const o=performance.now()-l;throw w.transcription.error(n,{...d,durationMs:o}),n})}}const J=48e3,K=10,F=J*K,Q=4e3,Y=10*60*1e3,M=s=>P.setState(r=>{r.status=s}),ee=s=>{const r=t.useRef(s);r.current=s;const e=t.useRef(null),S=t.useRef([]),h=t.useRef(null),d=t.useRef(null),l=t.useRef(null),n=t.useRef(new Float32Array(0)),o=t.useRef(null),b=t.useRef(null),v=t.useRef(!1),c=t.useCallback(()=>{n.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),x=t.useCallback(async(a,p)=>{M("transcribing");try{let i;B()?i=new File([a],"whisper.mp3",{type:"audio/mpeg"}):i=new File([a],`whisper.${a.type.split(/[\/;]/)[1]||"mp3"}`,{type:a.type});const f=await X.transcribe(i,void 0,{durationMs:p});M("idle"),w.transcription.transcriptDelivered({durationMs:p,transcriptLength:f.text.length}),r.current.onSuccess(f.text,f.asset_pointer,f.asset_ttl),c()}catch(i){M("error"),w.transcription.error(i,{durationMs:p}),c()}},[c]),R=t.useCallback(a=>{if(!v.current)return;v.current=!1,b.current!==null&&(clearTimeout(b.current),b.current=null);const p=o.current!=null?performance.now()-o.current:void 0;a&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,M("idle"),c(),w.recording.cancel({durationMs:p}),o.current=null),e.current?.stop(),e.current?.stream.getTracks().forEach(i=>i.stop()),e.current=null,l.current?.disconnect(),l.current=null,d.current?.disconnect(),d.current=null,h.current?.close(),h.current=null,a||w.recording.submit({durationMs:p})},[c]),A=t.useCallback(()=>{c(),M("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:Q,channelCount:1}}).then(a=>{o.current=performance.now(),w.recording.start(),e.current=new MediaRecorder(a);const p=B();v.current=!0,p?(S.current=[],e.current.ondataavailable=g=>{g.data.size>0&&S.current.push(g.data)},e.current.onstop=async()=>{const g=new Blob(S.current,{type:"audio/mpeg-3"}),m=o.current!=null?performance.now()-o.current:void 0;await x(g,m)},e.current.start(1e3)):(e.current.ondataavailable=async g=>{const m=o.current!=null?performance.now()-o.current:void 0;await x(g.data,m)},e.current.start()),n.current=new Float32Array(F).fill(r.current.initialValue),r.current.onWaveformDataUpdate(n.current),M("recording"),b.current=window.setTimeout(()=>{R()},Y);const i=new AudioContext;h.current=i;const f=i.createMediaStreamSource(a);d.current=f;const y=i.createScriptProcessor(2048,1,1);l.current=y,y.onaudioprocess=g=>{const m=g.inputBuffer.getChannelData(0);for(let E=0;E<m.length;E++)m[E]=Math.max(m[E],r.current.initialValue);const _=n.current,C=new Float32Array(_.length+m.length);if(C.set(_,0),C.set(m,_.length),C.length>F){const E=C.length-F;n.current=C.slice(E)}else n.current=C;r.current.onWaveformDataUpdate(n.current)},f.connect(y),y.connect(i.destination)}).catch(()=>{M("error"),c(),w.recording.cancel()})},[c,R,x]);return t.useEffect(()=>()=>{R(!0)},[R]),{startRecording:A,stopRecording:R}};function se({disabled:s=!1,initialValue:r,onSuccess:e,onWaveformDataUpdate:S,onExit:h,buttonClassName:d,visualTreatment:l}){const n=z(),o=P(g=>g.status),b=t.useRef(!1),{startRecording:v,stopRecording:c}=ee({onSuccess:e,onWaveformDataUpdate:S,initialValue:r}),x=$();t.useEffect(()=>()=>{c()},[c]),t.useEffect(()=>{b.current||(v(),b.current=!0)},[v]),t.useEffect(()=>{x.state!=="idle"&&c()},[x.state,c]);const R=()=>{c(!0),h()},A=l==="codex"?u.jsx(W,{type:"button",color:"ghost",size:"small",onClick:R,icon:T,disabled:s||o==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},children:u.jsx(j,{id:"wham.whisperModeControls.cancel",defaultMessage:"Cancel"})}):u.jsx("div",{children:u.jsx("button",{"aria-label":n.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:R,disabled:s||o==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:D(l==="composer-btn"?"composer-btn":D(N,s?"opacity-30":U,d)),children:u.jsx(T,{"aria-label":n.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"icon",fontSize:"inherit"})})}),a=o==="transcribing",p=a?u.jsx(q,{}):u.jsx(I,{className:"icon-lg"}),i=a?n.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):n.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),f=()=>{H.logEvent("Whisper on Web/Windows: Clicked to end dictation"),V.logEvent("chatgpt_composer_whisper_button_clicked_end"),c()},y=l==="codex"?u.jsx(W,{type:"button",color:"secondary",size:"small",disabled:s,icon:a?q:I,onClick:f,children:u.jsx(j,{id:"wham.whisperModeControls.done",defaultMessage:"Done"})}):u.jsx("div",{children:u.jsx("button",{type:"button","aria-label":i,disabled:s,className:l==="composer-btn"?"composer-btn":D(N,s?"opacity-30":U,d),onClick:f,children:p})});return u.jsxs("div",{className:"flex gap-x-1.5",children:[A,y]})}export{se as WhisperModeControls};
//# sourceMappingURL=oiexcj840lejlb9q.js.map

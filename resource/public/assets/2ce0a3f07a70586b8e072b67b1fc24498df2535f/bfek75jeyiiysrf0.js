import{b as oe,r as i,j as s,M as B,A as fe,m as L,v as Ie,d as Se,av as ms,as as fs,u as Qe}from"./n97h6so7iblif4c5.js";import{C as Ct,bx as it,cO as Ne,B as re,eO as ps,h7 as xs,D as ue,s as K,N as Z,c as Je,d as w,at as vt,aV as Be,aU as Ue,s7 as Et,e8 as bt,go as St,e5 as $e,R as pe,aw as hs,a as Fe,bw as gs,cQ as Nt,sl as ys,fL as wt,e9 as jt,f3 as kt,mp as Cs,ea as me,eL as vs,de as Es,iV as bs,kT as Ss,h$ as Ns,sm as ws,gt as Tt,aq as _t,bj as et,ge as js,ee as Ve,bv as ks,P as Ts,aG as _s,a4 as Rs,fR as Ms,gK as Is,d5 as Os,ih as Ls,aI as As,ic as Ds,al as se,cT as Ps,b as Bs,bX as Us}from"./cim4usely8ixso70.js";import{lk as $s,ll as Fs,mf as Hs,c5 as Rt,r7 as Ws,qE as Oe,r8 as Gs,o$ as Vs,f6 as qs,lF as zs,ao as Xs,f4 as Ys,f5 as Ks,dn as Zs,lP as Qs,F as Js,r2 as X,r9 as en,bL as Mt,d5 as tn,lo as sn,cO as It,bp as lt}from"./ivbsxyeeopn30y8l.js";import{u as Ot}from"./bcnsse8l7ak9ome8.js";import{T as He,E as nn,m as rn,f as an,g as on,i as ln,d as cn}from"./mrd3z2p5ccxe8mcf.js";import{M as b,a as we,b as ge,c as dn,E as Y,d as je}from"./i8vgytiaizzymmdx.js";import{C as Lt,i as un,L as qe,a as mn}from"./fn23ljzmd7fz7cdu.js";import{a as fn,D as pn,H as xn,Z as _e,N as hn}from"./jy1u8exw8iz2slve.js";import{d as We,c as xe,E as Le,D as de}from"./hd79rgnyf5hfs3gj.js";import{L as gn}from"./gy64pge8qevmvg7e.js";import{S as yn}from"./lnrdu7695dtoyi0c.js";const At=({origin:e,url:t})=>s.jsxs("div",{"aria-label":t,className:"w-full min-w-0 pe-4 text-start whitespace-nowrap",children:[s.jsx("span",{"aria-hidden":!0,className:"text-token-text-primary",children:e}),s.jsx("span",{"aria-hidden":!0,className:"text-token-text-tertiary",children:t.replace(e,"")})]}),Cn=({request:e,isDenied:t=!1,onClick:n})=>{const[{width:r},a]=Ot();return s.jsxs("button",{ref:a,className:"group relative z-0 my-1 flex w-full items-center",onClick:n,children:[s.jsx("div",{className:"sticky start-0 z-[-1] w-0",children:s.jsx("div",{className:"absolute top-0 hidden h-8 -translate-y-1/2 bg-gray-100 group-hover:block",style:{width:r}})}),s.jsx("div",{className:"bg-token-main-surface-primary text-token-text-secondary sticky start-0 z-10 flex h-8 shrink-0 items-center px-2 group-hover:bg-gray-100",children:t?s.jsx(Hs,{className:"icon text-red-500"}):s.jsx(xs,{className:"icon text-green-500"})}),s.jsx(At,{...e})]})},Dt=({title:e,requests:t,onConfirm:n})=>{const r=oe(),[a,o]=i.useState(()=>new Set),l=()=>{for(const{requestId:d,approve:p,deny:u}of t)a.has(d)?u():p();n?.()},c=()=>{for(const d of t)d.deny()},f=d=>{o(p=>{const u=new Set(p);return u.has(d)?u.delete(d):u.add(d),u})},m=t.length-a.size;return s.jsx(Ct,{testId:"modal-confirm-fetch-request",isOpen:!0,shouldIgnoreClickOutside:!0,onClose:l,type:"success",title:s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-xl",children:s.jsx(B,{id:"VmMpF1",defaultMessage:"Allow network access?"})}),s.jsx(Ne,{side:"top",contentClassName:"max-w-2xs!",label:s.jsx(B,{id:"WT7tgj",defaultMessage:"Learn more about network requests in canvas"}),children:s.jsx(re,{icon:ps,openNewTab:!0,onClick:()=>$s.logButtonClick(Fs.LEARN_MODE_ABOUT_NETWORK_REQUESTS),as:"a",color:"ghost",size:"small",className:"text-token-text-secondary aspect-square p-1!",to:"https://help.openai.com/en/articles/9930697-what-is-the-canvas-feature-in-chatgpt-and-how-do-i-use-it#h_cd52fdbc16"})})]}),description:s.jsxs("div",{className:"mt-3 flex flex-col gap-3",children:[s.jsx("span",{className:"text-token-text-primary block",children:s.jsx(B,{id:"qk11AX",defaultMessage:"{title} is trying to connect to the network. If you don’t recognize {numRequests, plural, one {this request} other {any of these requests}}, don’t allow this app access to the network.",values:{title:`"${e}"`,numRequests:t.length}})}),s.jsx("div",{className:"flex max-w-full flex-col",children:t.length>1?s.jsx("ul",{className:"border-token-border-default relative flex max-h-48 flex-col overflow-x-auto overflow-y-auto rounded-lg border",children:t.map(d=>{const{requestId:p}=d;return s.jsx("li",{children:s.jsx(Cn,{request:d,isDenied:a.has(p),onClick:()=>f(p)})},p)})}):s.jsx("div",{className:"no-scrollbar bg-token-main-surface-secondary overflow-x-auto rounded-lg p-2",children:s.jsx(At,{...t[0]})})})]}),primaryButton:s.jsx(it.Button,{disabled:m===0,title:t.length>1?r.formatMessage({id:"xpKkWv",defaultMessage:"Allow selected ({count})"},{count:m}):r.formatMessage({id:"ZeMrpd",defaultMessage:"Allow"}),color:"primary",onClick:l}),secondaryButton:s.jsx(it.Button,{title:r.formatMessage({id:"TjJzqR",defaultMessage:"{count, plural, one {Deny} other {Deny all}}"},{count:t.length}),color:"secondary",onClick:c})})},Pt=({instrument:e})=>{switch(e.type){case"hist":return K.hist(Z.WEB_SANDBOX,e.label,e.tags,e.value);case"count":return K.count(Z.WEB_SANDBOX,e.label,e.tags,e.count);case"error":return ue.addError(e.error)}},vn=e=>Je(e,"1339396487"),Bt=({size:e=60,thickness:t=1/16,checkpoints:n,activeCheckpointId:r,isComplete:a=!1,onTransitionComplete:o,color:l})=>{const[c,f]=i.useState(0),m=n.findIndex(h=>h.id===r),d=i.useRef(null),p=n[m];i.useEffect(()=>{if(!p||a)return;const h=n.length,x=m*100/h,y=(m+1)*100/h;f(x);let E=null,v=null;const g=5/p.estimatedTime,C=M=>{v==null&&(v=M);const N=M-v;if(N!==0){const I=y-x,P=x+I*(1-Math.exp(-g*N));f(Math.min(P,y-1e-4))}E=window.setTimeout(()=>{d.current=requestAnimationFrame(C)},16)};return d.current=requestAnimationFrame(C),()=>{E!=null&&window.clearTimeout(E),d.current!=null&&cancelAnimationFrame(d.current)}},[m,a]);const u=()=>{a&&o?.()};return s.jsx(Rt,{sizeOverride:e,className:w(l==null&&"text-primary",l==="dark"&&"text-back",l==="light"&&"text-white"),thickness:t,backgroundStrokeClassName:w(l==null&&"stroke-[rgba(0,0,0,0.1)] dark:stroke-[rgba(0,0,0,0.32)]",l==="dark"&&"stroke-[rgba(0,0,0,0.32)]",l==="light"&&"stroke-[rgba(0,0,0,0.1)] "),percentage:a?100:c,onTransitionEnd:u,transitionDuration:"50ms",transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})},Ut=({checkpoints:e,activeCheckpointId:t,isIndeterminate:n=!1,isComplete:r})=>{const[a,o]=i.useState(r);return i.useEffect(()=>{o(r)},[t]),s.jsx(fe,{children:(t!=null&&!a||n)&&s.jsxs(L.div,{initial:{opacity:0},exit:{opacity:0},animate:{opacity:1},className:"bg-token-main-surface-primary absolute end-2 bottom-2 flex items-center gap-2 rounded-full px-3 py-1.5 shadow-lg",children:[n?s.jsx(Rt,{percentage:30,thickness:1/12,className:"text-primary animate-spin",backgroundStrokeClassName:"dark:stroke-[rgba(255,255,255,0.4)] stroke-[rgba(0,0,0,0.1)]",sizeOverride:12}):t&&s.jsx(Bt,{size:12,thickness:1/12,checkpoints:e,activeCheckpointId:t,isComplete:r,onTransitionComplete:()=>o(!0)}),s.jsxs("span",{className:"text-token-text-secondary flex items-baseline text-sm",children:[s.jsx(B,{id:"zfcWbe",defaultMessage:"Updating"}),s.jsx(He,{gap:1.5,padding:2,size:2})]})]})})};function En(e){let t=null;const n=[];let r=!1;return e.on("message",a=>{t?(t({value:a,done:r}),t=null):n.push(a),a.type===b.RUN_COMPLETE&&(r=!0)}),{[Symbol.asyncIterator](){return this},next(){if(n.length>0){const a=n.shift();return Promise.resolve({value:a,done:r})}return r?Promise.resolve({value:void 0,done:r}):new Promise(a=>{t=a})}}}const $t=()=>Et(Be.getItem(Ue.CODE_EXECUTION_DOMAIN_ALLOW_LIST),t=>bt(t,{origin:$e,expiresAt:St}),[]).filter(({expiresAt:t})=>t>=Date.now()),bn=(e,t)=>{const{origin:n}=new URL(e);let r=[...Lt];const a=$t().map(({origin:o})=>o);return t&&(r=r.concat(a)),r.includes(n)},Sn=({networkAccessDeniedMessage:e,disableNetworkRequests:t})=>{const n=vt(),r=oe(),[a,o]=i.useState([]);return{onViolation:i.useCallback(({payload:c})=>{const{blockedURI:f}=c;try{if(t)return n.danger(e??r.formatMessage({id:"Lp7cKY",defaultMessage:"Network access is disabled."}),{loggingTitle:"Network access is disabled.",toastId:"network_access_denied"});K.count(Z.WEB_SANDBOX,"network_access_requested");const{origin:m}=new URL(f),d=u=>{K.count(Z.WEB_SANDBOX,`network_access_request.${u?"allow":"deny"}`),o(h=>h.filter(x=>!bn(x.url,!t)&&x.url!==f))},p=()=>{Be.setItem(Ue.CODE_EXECUTION_DOMAIN_ALLOW_LIST,[...$t(),{origin:m,expiresAt:Date.now()+90*24*60*60*1e3}]),d(!0)};o(u=>[...u,{requestId:Ie(),url:f,origin:m,approve:p,deny:()=>d(!1)}])}catch(m){ue.addError(m)}},[t,n,e,r]),pendingFetchRequests:a}};function ct(){let e=null;const t=new Promise(n=>e=n);return{resolve:e,promise:t}}const Ft=()=>{const[e,t]=i.useState(ct);return[e,i.useCallback(()=>t(ct()),[])]},tt=()=>Et(Be.getItem(Ue.CODE_EXECUTION_DOMAIN_ALLOW_LIST),t=>bt(t,{origin:$e,expiresAt:St}),[]).filter(({expiresAt:t})=>t>=Date.now()),dt=(e,t)=>{const{origin:n}=new URL(e);let r=[...Lt];const a=tt().map(({origin:o})=>o);return t&&(r=r.concat(a)),r.includes(n)},Nn=({sessionId:e,networkAccessDeniedMessage:t,disableNetworkRequests:n,unsafeAllowAllNetworkRequests:r})=>{const a=vt(),o=oe(),l=i.useRef(null),c=i.useRef(null),f=i.useRef(null),[m,d]=i.useState([]),p=i.useCallback(v=>c.current?.postMessage(v),[]),u=i.useCallback(v=>f.current?.postMessage(v),[]);i.useEffect(()=>()=>{u({type:we.DISCONNECT,sessionId:e})},[e]);const h=i.useCallback(({url:v,requestId:g})=>{try{if(r||dt(v,!n))return u({type:we.FETCH_RESPONSE,isApproved:!0,requestId:g});if(n)return a.danger(t??o.formatMessage({id:"Lp7cKY",defaultMessage:"Network access is disabled."}),{loggingTitle:"Network access is disabled.",toastId:"network_access_denied"});K.count(Z.WEB_SANDBOX,"network_access_requested");const{origin:C}=new URL(v),M=I=>{K.count(Z.WEB_SANDBOX,`network_access_request.${I?"allow":"deny"}`),u({type:we.FETCH_RESPONSE,isApproved:I,requestId:g}),d(P=>P.filter(A=>!r&&!dt(A.url,!n)&&A.requestId!==g))},N=()=>{Be.setItem(Ue.CODE_EXECUTION_DOMAIN_ALLOW_LIST,[...tt(),{origin:C,expiresAt:Date.now()+90*24*60*60*1e3}]),M(!0)};d(I=>[...I,{url:v,origin:C,requestId:g,approve:N,deny:()=>M(!1)}])}catch(C){ue.addError(C),u({type:we.FETCH_RESPONSE,isApproved:!1,requestId:g})}},[n,u,a,t,o,r]),[x,y]=Ft(),E=i.useCallback(async(v,g)=>{if(v.type===ge.SW_NOT_SUPPORTED)K.count(Z.WEB_SANDBOX,"sw_not_supported"),x.resolve?.();else{c.current=g[0],f.current=g[1],f.current.onmessage=C=>{C.data.type==="ready"?x.resolve?.():h(C.data)};try{const{token:C}=await pe.safeGet("/public/code_execution_challenge",{authOption:hs.Anonymous,parameters:{query:{relay_client_id:v.clientId}}});p({type:dn.SW_RECONNECT_RESPONSE,reconnectId:v.reconnectId,sessionId:e,token:C})}catch(C){ue.addError(C)}}},[h,p,x,e]);return{relayRef:l,relayInitPromise:x,resetRelayInitPromise:y,handleMessageFromRelay:E,pendingFetchRequests:m}},wn="https://persistent.oaistatic.com/canvas/loop-swirl.mp4",jn="https://persistent.oaistatic.com/canvas/loop-swirl-poster.jpg",he=90,Ht=({title:e,checkpoints:t,activeCheckpointId:n,isComplete:r,onTransitionComplete:a})=>{const[o,l]=i.useState(!1),c=t.findIndex(d=>d.id===n),f=t[c],m=()=>{a?.(),l(!0)};return s.jsx(L.div,{className:"relative flex h-full w-full items-center justify-center",transition:{type:"spring",bounce:0},children:s.jsxs(L.div,{className:"flex -translate-y-12 flex-col items-center gap-3",style:{minWidth:he,height:he},initial:{opacity:0},animate:{opacity:1},transition:{type:"spring",duration:.5,bounce:0},children:[s.jsxs(L.div,{className:"bg-token-main-surface-primary absolute overflow-hidden rounded-3xl shadow-2xl",initial:!1,animate:{width:he,height:he,opacity:o?0:1},transition:{type:"spring",duration:.56,bounce:0},children:[s.jsx("video",{muted:!0,loop:!0,autoPlay:!0,playsInline:!0,src:wn,poster:jn,className:w("absolute inset-0 z-0 h-full w-full object-cover transition-opacity duration-200")}),s.jsx("div",{className:w("relative z-10 flex h-full w-full items-center justify-center",o?"opacity-0":"opacity-100"),children:s.jsx(Bt,{color:"light",checkpoints:t,activeCheckpointId:n,isComplete:r,onTransitionComplete:m,thickness:1/12})})]}),s.jsxs(L.div,{className:w("flex flex-col items-center transition-opacity duration-200",r?"opacity-0":"opacity-100"),style:{translateY:he+20},children:[s.jsx("span",{className:"text-token-text-primary font-semibold",children:e}),f&&s.jsx(L.span,{className:"text-token-text-secondary flex items-baseline",children:s.jsx("span",{className:"loading-shimmer",children:f.label})})]})]})})},ut=({sessionId:e})=>"?"+[`sessionId=${e}`,""].filter(Boolean).join("&"),Ae=[{id:Y.INITIALIZING,label:"Initializing environment",estimatedTime:1e3},{id:Y.INSTALLING_PACKAGES,label:"Installing packages",estimatedTime:2e3},{id:Y.RUNNING_CODE,label:"Ready",estimatedTime:1}],kn=()=>vs()?"ios":Es()?"windows":bs()?"android":Ss()?"safari":Ns()||ws()?"chrome":"unknown",Wt=(e,t)=>{K.count(Z.WEB_SANDBOX,`${t}.eval`),kt(e,"chatgpt_web_sandbox_code_run",`${t}`)},Gt=(e,t)=>{kt(e,"chatgpt_web_sandbox_environment_error",`${t.message.error.name}: ${t.message.error.message}`),ue.addError("Code execution environment error",t.message.error),t.message.error.name==="ServiceWorker"&&K.count(Z.WEB_SANDBOX,"service_worker_connection_failure",[{key:"agent",value:kn()},{key:"is_share",value:String(t.isShare)}]),t.message.runId!=null&&t.message.runId===t.activeRun?.runId&&K.count(Z.WEB_SANDBOX,`${t.activeRun.language}.environment_error`)},Tn=({ref:e,isShare:t=!1,disableNetworkRequests:n=!1,unsafeAllowAllNetworkRequests:r=!1,networkAccessDeniedMessage:a,visuallyHidden:o=!1,isCodeUpdating:l=!1,enableTransition:c=!1,disablePermissions:f=!1,title:m,onChangeBackgroundColor:d,onCodeRunComplete:p})=>{const[u,h]=i.useState(0),[x]=i.useState(()=>crypto.randomUUID()),{pendingFetchRequests:y,handleMessageFromRelay:E,relayInitPromise:v,resetRelayInitPromise:g,relayRef:C}=Nn({sessionId:x,disableNetworkRequests:n,networkAccessDeniedMessage:a,unsafeAllowAllNetworkRequests:r}),M=i.useRef(null),[N,I]=Ft(),P=i.useMemo(()=>Promise.all([N.promise,v.promise]),[N,v]),A=Fe(),[W,V]=i.useState(null),[H,G]=i.useState(!1),Q=i.useRef(null),D=i.useRef(new Map),_=i.useRef(null),q=i.useCallback(k=>{Q.current?.postMessage(k)},[]),j=i.useCallback(()=>{const k=D.current.keys();V(null),G(!1),d?.(null);for(const T of k)q({type:je.STOP_CODE,runId:T});_.current=null},[q,d]),U=i.useCallback(()=>{g(),I(),h(k=>k+1),V(null),G(!1),_.current=null},[g,I]),J=i.useCallback(async function*({code:k,language:T}){if(V(Y.INITIALIZING),Wt(A,T),await P,D.current.size!==0)return j();const te=Ie(),ee=new ys;D.current.set(te,ee);const $={code:k,language:T,type:je.RUN_CODE,runId:te};_.current={runId:te,language:T},q($);for await(const F of En(ee))F&&F.type===b.ENVIRONMENT_STATUS&&(V(F.status),c||G(F.status===Y.RUNNING_CODE)),F?.type===b.ERROR?K.count(Z.WEB_SANDBOX,`${T}.error`):F?.type===b.RUN_COMPLETE&&F.wasFatalError&&K.count(Z.WEB_SANDBOX,`${T}.fatal_runtime_error`),F&&!wt([b.READY],F.type)&&(yield F);V(null),G(!1),D.current.delete(te),p?.()},[A,P,c,q,j,p]),z=i.useCallback(async k=>{await P,q({type:je.PREPARE_ENVIRONMENT,language:k})},[P,q]),S=k=>{_.current&&q({type:je.RUN_CODE,code:k,..._.current})};i.useImperativeHandle(e,()=>({stop:j,evalAsync:J,updateCode:S,prepareEnvironment:z})),i.useEffect(()=>jt(window,{message:k=>{const{data:T,ports:te}=k,{type:ee}=T,$=k.source===C.current?.contentWindow,F=k.source===M.current?.contentWindow;if(!$&&!F)return;if(ee===b.ENVIRONMENT_ERROR)return Gt(A,{message:T,isShare:t,activeRun:_.current}),U();if($&&(T.type===ge.SW_NOT_SUPPORTED||T.type===ge.SW_RECONNECT))return E(T,te);if($||!F||ee===ge.SW_RECONNECT||ee===ge.SW_NOT_SUPPORTED)return;if(Q.current=te[0],ee===b.READY)return N.resolve?.();if(ee===b.SET_BACKGROUND_COLOR)return d?.(T.backgroundColor);if(ee===b.INSTRUMENT)return Pt(T);const{runId:at}=T,ot=at&&D.current.get(at);ot?ot.emit("message",T):ue.addError("Code execution error: missing event emitter",{messageData:k.data})}}),[d,U,E,v,C,N,x,t,A]);const O={type:"spring",duration:H&&c?.56:0,delay:H?.12:0,bounce:0},R=f?"":"midi";return s.jsxs(Nt,{children:[s.jsx("iframe",{title:"relay","aria-hidden":"true",className:"fixed h-0 w-0",allow:R,ref:C,src:`${qe}/relay.html${ut({sessionId:x})}`},`relay-${u}`),s.jsxs("div",{className:w("relative flex",o?"fixed h-0 w-0":"h-full w-full"),children:[!o&&W!=null&&c&&s.jsx(Ht,{isComplete:W===Y.RUNNING_CODE,onTransitionComplete:()=>G(!0),activeCheckpointId:W,title:m,checkpoints:Ae}),s.jsx(L.div,{className:w("bg-token-main-surface-primary absolute inset-0 m-auto origin-center overflow-hidden",H?"pointer-events-auto":"pointer-events-none"),animate:{opacity:H?1:0,...H?{scale:1}:{scale:.95}},transition:O,children:s.jsx(L.iframe,{title:m,className:"h-full w-full overflow-hidden",transition:O,"aria-hidden":o?"true":void 0,allow:R,src:`${qe}/index.html${ut({sessionId:x})}`,sandbox:"allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-forms",ref:M,tabIndex:-1},`sandbox-${u}`)}),H&&s.jsx(Ut,{isIndeterminate:l,isComplete:W===Y.RUNNING_CODE,activeCheckpointId:W,checkpoints:Ae})]}),y.length>0&&s.jsx(Dt,{title:m,requests:y})]})},_n=({ref:e,id:t,title:n,visuallyHidden:r,disablePermissions:a,isCodeUpdating:o,onCodeRunComplete:l,disableNetworkRequests:c=!1,networkAccessDeniedMessage:f,unsafeAllowAllNetworkRequests:m,enableTransition:d,onChangeBackgroundColor:p,onRetryCodeRun:u})=>{const[h,x]=i.useState(0),[y]=i.useState(()=>gs(null)),E=i.useRef(null),v=i.useRef(null),g=i.useRef(!1),[C,M]=i.useState(null),[N,I]=i.useState(!1);i.useEffect(()=>{const j=v.current;if(j)return g.current=!0,un(j,{},["runUserCode"]).then(U=>{y.set(U)}),()=>{y.set(null),g.current=!1}},[h]);const P=async()=>(await Cs(()=>y()!=null),me(y())),{onViolation:A,pendingFetchRequests:W}=Sn({disableNetworkRequests:c,networkAccessDeniedMessage:f}),V=()=>{E.current=null,M(null),I(!1),l?.()},H=Fe(),G=async function*({code:j,language:U}){M(Y.INITIALIZING),Wt(H,U);const J=await P(),z=Ie();E.current={runId:z,language:U};const S=tt().map(({origin:R})=>R),O=m?null:c?{resourceDomains:[],connectDomains:[]}:{connectDomains:S,resourceDomains:S};for await(const R of J.runUserCode({code:j,id:t,language:U,csp:O}))switch(R.type){case b.READY:break;case b.SET_BACKGROUND_COLOR:p?.(R.backgroundColor);break;case b.INSTRUMENT:Pt(R);break;case b.ENVIRONMENT_ERROR:Gt(H,{message:R,isShare:!1,activeRun:E.current});break;case b.ERROR:K.count(Z.WEB_SANDBOX,`${U}.error`),yield{...R,runId:z};break;case b.ENVIRONMENT_STATUS:M(R.status),d||I(R.status===Y.RUNNING_CODE),yield{...R,runId:z};break;case b.SECURITY_POLICY_VIOLATION:A(R);break;case b.RUN_COMPLETE:R.type===b.RUN_COMPLETE&&R.wasFatalError&&K.count(Z.WEB_SANDBOX,`${U}.fatal_runtime_error`),yield{...R,runId:z},E.current?.runId===z&&V();break;default:yield{...R,id:Ie(),runId:z}}},Q=async()=>{},D=async()=>{(await P()).stop()};i.useImperativeHandle(e,()=>({stop:D,evalAsync:G,updateCode:()=>{},prepareEnvironment:Q}));const _={type:"spring",duration:N&&d?.56:0,delay:N?.12:0,bounce:0},q=a?"":"midi";return s.jsxs(Nt,{children:[s.jsxs("div",{className:w("relative flex",r?"fixed h-0 w-0":"h-full w-full"),children:[!r&&C!=null&&d&&s.jsx(Ht,{isComplete:C===Y.RUNNING_CODE,onTransitionComplete:()=>I(!0),activeCheckpointId:C,title:n,checkpoints:Ae}),s.jsx(L.div,{className:w("bg-token-main-surface-primary absolute inset-0 m-auto origin-center overflow-hidden",N?"pointer-events-auto":"pointer-events-none"),animate:{opacity:N?1:0,...N?{scale:1}:{scale:.95}},transition:_,children:s.jsx(L.iframe,{title:n,className:"h-full w-full overflow-hidden",transition:_,"aria-hidden":r?"true":void 0,allow:q,src:`${qe}/kanzi-sandbox.html`,sandbox:"allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-forms",ref:v,tabIndex:-1},`sandbox-${h}`)}),N&&s.jsx(Ut,{isIndeterminate:o,isComplete:C===Y.RUNNING_CODE,activeCheckpointId:C,checkpoints:Ae})]}),W.length>0&&s.jsx(Dt,{title:n,requests:W,onConfirm:()=>{x(j=>j+1),M(null),I(!1),setTimeout(()=>{u?.()})}})]})},va=e=>{const t=Fe();return vn(t)?s.jsx(_n,{...e}):s.jsx(Tn,{...e})};function Rn(e,t,n){const r=new Map;return e.forEach((a,o)=>{const l=Ws(a,t,n);l&&r.set(o,l)}),r}function Mn(e,t){const n=Ln(e);if(n.length===0)return t;let r=t;return n.forEach(a=>{r=In(a,r)}),r}function In(e,t){return Rn(t,{start:e.fromA,end:e.toA},On(e))}function On(e){const{fromA:t,toA:n,fromB:r,toB:a}=e;return a-r-(n-t)}function Ln(e){const t=[],n=(r,a,o,l)=>{t.push({fromA:r,toA:a,fromB:o,toB:l})};return e.changes.iterChangedRanges(n,!0),t}function An(e,t){const n=Array.from(e.keys()),r=Array.from(t.keys());if(n.length!==r.length)return!1;n.sort(),r.sort();for(let a=0;a<n.length;a++)if(n[a]!==r[a])return!1;for(const a of n){const o=e.get(a),l=t.get(a);if(!o||!l||o.start!==l.start||o.end!==l.end)return!1}return!0}function Dn(e,t){return{"bg-yellow-100 dark:bg-yellow-400":!0,"bg-yellow-400/40 dark:bg-yellow-400/50":e&&!t,"bg-yellow-400/60 dark:bg-yellow-500/70":t,"bg-yellow-100 dark:bg-yellow-400/30":!e&&!t}}const Pn={"bg-transparent!":!0};function Bn({isHovered:e,isFocused:t,isCode:n,diffStatus:r}){return w(n?fn:pn,"cursor-text group is-comment transition-colors",{...r===Oe.REMOVED?Pn:Dn(e,t)},"group-[.is-comment]:bg-opacity-40")}function Un(e,t){return e.map(n=>{const r=t.get(n.id);return r?{...n,at:r}:null}).filter(Tt)}var le=(e=>(e.ASK="ask",e.CREATE_TEXTDOC="create_textdoc",e.COMMENT="comment",e.EDIT="edit",e))(le||{}),$n=(e=>(e.SELECTION="selection",e.BLOCK="block",e))($n||{});function Ea(e){return e?.type==="selection"}const Fn=_t(()=>({commentingOn:null,hoveredCommentId:null,focusedCommentId:null,visibleBlockCommentLauncher_DEBUG_ONLY:null,hoveredBlockCommentLauncherPos:null})),{setState:ne,getInitialState:Hn}=Fn,De={reset:()=>ne(Hn()),startCommentingOn:e=>ne(t=>({...t,commentingOn:e})),cancelCommentingOn:()=>ne(e=>({...e,commentingOn:null})),focusComment:e=>ne(t=>({...t,focusedCommentId:e})),blurComment:()=>ne(e=>({...e,focusedCommentId:null})),mouseEnterComment:e=>ne(t=>({...t,hoveredCommentId:e})),mouseLeaveComment:()=>ne(e=>({...e,hoveredCommentId:null})),mouseEnterBlock:e=>ne(t=>({...t,hoveredBlockCommentLauncherPos:e})),mouseLeaveBlock:()=>ne(e=>({...e,hoveredBlockCommentLauncherPos:null})),setVisibleBlockComment_DEBUG_ONLY:e=>ne(t=>({...t,visibleBlockCommentLauncher_DEBUG_ONLY:e}))},Vt=We.define(),Wn=We.define(),Gn=We.define(),Vn=We.define();function qn(e){return new Map(e.map(t=>[t.id,t.at]))}const ze=xe.define({create(){return null},update(e,t){for(const n of t.effects)if(n.is(Vt))return n.value;return e}}),Xe=xe.define({create(){return[]},update(e,t){for(const l of t.effects)if(l.is(Wn))return l.value;const n=e,r=qn(n),a=Mn(t,r);return An(r,a)?n:Un(n,a)}}),Ye=xe.define({create(){return null},update(e,t){for(const n of t.effects)if(n.is(Gn))return n.value;return e}}),Ke=xe.define({create(){return null},update(e,t){for(const n of t.effects)if(n.is(Vn))return n.value;return e}});function mt(e){if(!e||e.to-e.from===0)return de.none;const t=de.mark({class:xn.code});return de.set([t.range(e.from,e.to)])}function ft(e,t,n){if(e.length===0)return de.none;const a=[...e].sort((o,l)=>o.at.start-l.at.start).map(o=>{if(o.at.end-o.at.start===0)return null;const l=o.id===t,c=o.id===n,f=Bn({isHovered:l,isFocused:c,isCode:!0,diffStatus:o.diffStatus});return de.mark({class:f,attributes:{"data-comment-id":o.id}}).range(o.at.start,o.at.end)}).filter(Tt);return de.set(a)}const zn=xe.define({create(e){const t=e.field(ze,!1);return mt(t??null)},update(e,t){const n=t.state.field(ze,!1);return mt(n??null)},provide:e=>Le.decorations.from(e)}),Xn=xe.define({create(e){const t=e.field(Xe,!1),n=e.field(Ye,!1),r=e.field(Ke,!1);return ft(t??[],n??null,r??null)},update(e,t){const n=t.state.field(Xe,!1),r=t.state.field(Ye,!1),a=t.state.field(Ke,!1);return ft(n??[],r??null,a??null)},provide:e=>Le.decorations.from(e)});function Yn(e){e.state.selection.main.empty&&e.dispatch({effects:Vt.of(null)})}function qt(e){let t=e.dataset.commentId;for(let n=0;n<10&&!t&&e.parentElement;n++)e=e.parentElement,t=e.dataset.commentId;return t}function Kn(e){const t=e.target,n=qt(t);n&&De.focusComment(n)}function Zn(e){const t=e.target,n=qt(t);n?De.mouseEnterComment(n):De.mouseLeaveComment()}function ba(e,t=null,n=null){return[Xe.init(()=>e),ze,Ye.init(()=>t),Ke.init(()=>n),zn,Xn,Le.updateListener.of(r=>{r.selectionSet&&Yn(r.view)}),Le.domEventHandlers({click:Kn,mouseover:Zn})]}const Qn=({onClose:e,title:t,actions:n,showBorder:r=!1})=>s.jsxs("div",{className:w("bg-token-main-surface-primary flex items-center justify-between border-b py-2 ps-2 pe-2.5",{"border-token-border-xlight":r,"border-transparent":!r}),children:[s.jsx("div",{className:"text-token-text-primary flex items-center gap-2 ps-4 text-sm select-none",children:t}),s.jsxs("div",{className:"flex items-center gap-2",children:[n.map(({tooltip:a,icon:o,onClick:l},c)=>{const f=s.jsx(re,{size:"small",color:"ghost",as:"button",className:"text-token-text-primary aspect-square p-1!",icon:o,onClick:l},c);return a?s.jsx(Ne,{label:a,children:f},c):f}),s.jsx(re,{size:"small",color:"ghost",as:"button",className:"text-token-text-primary aspect-square p-1!",onClick:e,icon:et})]})]}),Jn=({onDrag:e,onDragEnd:t,onDoubleClick:n})=>s.jsx(L.div,{drag:"y",className:"bg-token-text-quaternary absolute top-[-2px] z-10 h-[4px] w-full cursor-ns-resize opacity-0",whileHover:{opacity:.5},whileDrag:{opacity:.75,height:"8px",top:"-4px"},transition:{type:"tween",duration:.1},style:{x:0,y:0,transform:"translateY(0px)"},dragMomentum:!1,dragSnapToOrigin:!1,dragElastic:!1,dragConstraints:{left:0,right:0,top:0,bottom:0},onDrag:(r,a)=>{e?.(a)},onDragEnd:t,onDoubleClick:n}),er=({textdocTitle:e,onClickViewConsole:t,onClickFix:n,onDismiss:r})=>s.jsxs(L.div,{initial:{scale:.95,opacity:0},exit:{scale:.95,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",bounce:.12,duration:.3},className:"border-token-border-default bg-token-main-surface-primary absolute end-2 bottom-2 flex w-fit max-w-80 flex-col gap-4 rounded-xl border px-4 py-4 shadow-xl",children:[s.jsxs("div",{className:"flex items-start",children:[s.jsxs("div",{className:"flex flex-col gap-1",children:[s.jsx("div",{className:"text-sm font-semibold",children:s.jsx(B,{id:"ObCQBq",defaultMessage:"Cannot preview your code"})}),s.jsx("div",{className:"text-sm",children:s.jsx(B,{id:"3ZeoP8",defaultMessage:"An error occured while trying to run {name}",values:{name:e}})})]}),s.jsx(re,{size:"small",color:"ghost",as:"button",className:"text-token-text-tertiary -m-1! aspect-square p-0!",onClick:r,icon:et})]}),s.jsxs("div",{className:"flex items-center justify-end gap-2",children:[s.jsx(re,{size:"small",color:"secondary",onClick:t,children:s.jsx(B,{id:"Fch32I",defaultMessage:"View console"})}),s.jsx(re,{size:"small",color:"primary",onClick:n,children:s.jsx(B,{id:"HRfYX0",defaultMessage:"Fix bug"})})]})]}),zt=(e,{name:t,message:n,line:r,stack:a})=>{const o=r!=null?`

Error occured in:
${e.split(`
`).slice(r-1,r+1).join(`
`)}`:"";return`${t}: ${n}

Stack:
${a.join("")}${o}`},Ge=new gn({capacity:5}),tr=async(e,t,n)=>{const r=zt(t,n.error),a=$e(Ge.get(r));if(Ge.get(r))return a;const{hint:o}=await pe.safePost("/textdoc/{textdoc_id}/code/hint",{parameters:{path:{textdoc_id:e}},requestBody:{error:r,line:n.error.line??-1}});return Ge.set(r,o),o},Xt=e=>wt([b.ERROR,b.LOG,b.OUTPUT],e.type),Yt=e=>e.type===b.OUTPUT&&Kt(e.output),Kt=e=>typeof e=="string"&&e.startsWith("data:image/png;"),ye=({as:e="li",contentBefore:t,contentAfter:n,disableEntryAnimation:r=!1,hasHint:a=!1,bottomBorder:o=!1,isHintOpen:l=!1,isSticky:c=!1,onClick:f,children:m})=>{const d=!!f,p=e==="div"?L.div:L.li;return s.jsxs(p,{initial:r?!1:{opacity:0},animate:{opacity:1},transition:{duration:.32},role:d?"button":void 0,className:w("bg-token-main-surface-primary flex items-start justify-between py-1.5 ps-6 pe-4 font-mono text-sm whitespace-pre",o&&"border-token-border-xlight border-b",c&&"sticky top-0 z-10",d&&"cursor-pointer",d&&a&&"hover:bg-red-500/10",d&&!a&&"hover:bg-gray-50 dark:hover:bg-gray-700",a&&l&&"bg-red-500/10"),onClick:d?f:void 0,children:[t&&s.jsx("div",{className:"me-3 flex h-6 w-5 items-start",children:t}),s.jsx("div",{className:"flex min-h-6 min-w-0 flex-1 items-start justify-start gap-2 leading-6",children:m}),n&&s.jsx("div",{className:"ms-3 flex min-h-6 items-start leading-6",children:n})]})},sr=e=>i.createElement("svg",{width:20,height:20,viewBox:"0 0 20 20",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg","data-rtl-flip":"",...e},i.createElement("path",{d:"M3.16504 9.99969C3.16523 6.49039 6.18893 3.58173 10 3.58173C13.8111 3.58173 16.8348 6.49039 16.835 9.99969C16.835 11.4535 16.3206 12.7965 15.4473 13.8766C15.3248 14.0282 15.2747 14.2262 15.3105 14.4177C15.4061 14.9255 15.5407 15.4197 15.6953 15.904C15.068 15.8203 14.4632 15.6959 13.8721 15.528L13.7461 15.5056C13.6191 15.4949 13.4909 15.5208 13.377 15.5817C12.3827 16.1135 11.2308 16.4186 10 16.4186C6.18881 16.4186 3.16504 13.5091 3.16504 9.99969ZM1.83496 9.99969C1.83496 14.3143 5.52692 17.7487 10 17.7487C11.356 17.7487 12.6371 17.4332 13.7656 16.8757C14.6851 17.118 15.6308 17.2694 16.626 17.3307C16.8517 17.3446 17.0693 17.2426 17.2031 17.0602C17.337 16.8778 17.3682 16.6397 17.2871 16.4284L17.0801 15.863C16.9176 15.3953 16.7809 14.9297 16.6777 14.4606C17.6128 13.202 18.165 11.6626 18.165 9.99969C18.1649 5.68526 14.473 2.25165 10 2.25165C5.52703 2.25165 1.83515 5.68526 1.83496 9.99969Z"}),i.createElement("path",{d:"M10 6.33499C9.63277 6.33503 9.33496 6.63279 9.33496 7.00003V9.33499L7 9.34866L6.86621 9.36234C6.56317 9.42429 6.33504 9.69237 6.33496 10.0137C6.33504 10.335 6.56319 10.6031 6.86621 10.6651L7 10.6787L9.33496 10.6651V13C9.33505 13.3672 9.63282 13.665 10 13.6651C10.3672 13.6651 10.665 13.3672 10.665 13V10.6651L13 10.6787C13.3672 10.6787 13.665 10.3809 13.665 10.0137C13.665 9.64651 13.3672 9.34866 13 9.34866L10.665 9.33499V7.00003C10.665 6.63276 10.3673 6.33499 10 6.33499Z"})),nr=e=>i.createElement("svg",{width:20,height:20,viewBox:"0 0 20 20",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg","data-rtl-flip":"",...e},i.createElement("path",{d:"M3.16504 9.99969C3.16523 6.49039 6.18893 3.58173 10 3.58173C13.8111 3.58173 16.8348 6.49039 16.835 9.99969C16.835 11.4535 16.3206 12.7965 15.4473 13.8766C15.3248 14.0282 15.2747 14.2262 15.3105 14.4177C15.4061 14.9255 15.5407 15.4197 15.6953 15.904C15.068 15.8203 14.4632 15.6959 13.8721 15.528L13.7461 15.5056C13.6191 15.4949 13.4909 15.5208 13.377 15.5817C12.3827 16.1135 11.2308 16.4186 10 16.4186C6.18881 16.4186 3.16504 13.5091 3.16504 9.99969ZM1.83496 9.99969C1.83496 14.3143 5.52692 17.7487 10 17.7487C11.356 17.7487 12.6371 17.4332 13.7656 16.8757C14.6851 17.118 15.6308 17.2694 16.626 17.3307C16.8517 17.3446 17.0693 17.2426 17.2031 17.0602C17.337 16.8778 17.3682 16.6397 17.2871 16.4284L17.0801 15.863C16.9176 15.3953 16.7809 14.9297 16.6777 14.4606C17.6128 13.202 18.165 11.6626 18.165 9.99969C18.1649 5.68526 14.473 2.25165 10 2.25165C5.52703 2.25165 1.83515 5.68526 1.83496 9.99969Z"}));function rr(e){switch(e){case"dark_gray":return{normal:"text-token-text-secondary dark:text-white-400",hover:"cursor-pointer hover:text-token-text-primary group-hover:text-token-text-primary"};case"light_gray":return{normal:"text-gray-400",hover:"cursor-pointer hover:text-token-text-secondary group-hover:text-token-text-secondary"};case"error":return{normal:"text-red-500",hover:"cursor-pointer hover:text-red-500 group-hover:text-red-500"}}}function st({children:e,className:t,onClick:n,isClickable:r=!1,theme:a="dark_gray"}){const o=rr(a),l=(n!=null||r)&&o.hover;return s.jsxs("div",{className:w("icon relative inline-block transition-opacity",t,l,o.normal),onClick:n,children:[e?s.jsx(nr,{className:"icon"}):s.jsx(sr,{className:"icon"}),s.jsx("span",{className:w("absolute inset-0 flex items-center justify-center text-[8px] font-black",l,o.normal),children:e})]})}function nt(){return s.jsx(st,{theme:"light_gray",children:s.jsx(He,{})})}function ar({count:e,isLoading:t,onClick:n,isError:r=!1}){return t?s.jsx(nt,{}):s.jsx(st,{onClick:n,theme:r?"error":"dark_gray",children:e})}function Sa({isLoading:e=!1,onClick:t}){return e?s.jsx(nt,{}):s.jsx(st,{isClickable:!0,onClick:t,theme:"light_gray"})}const Zt={type:"spring",bounce:.12,duration:.5},Qt="opacity-50",or=({position:e="absolute",count:t,offsetY:n,isLoading:r=!1,onClick:a,isError:o=!1})=>s.jsx(L.div,{className:w("flex",e,_e.collapsedComment),initial:{opacity:0},animate:{opacity:1},style:{translateY:n},transition:Zt,exit:{opacity:0},children:s.jsx(ar,{count:t,isLoading:r,onClick:a,isError:o})}),ir=({isFocused:e,isHovered:t})=>{const n=e||t?"grow font-medium text-token-text-primary transition-colors":"grow font-medium text-token-text-secondary transition-colors",r=e||t?"opacity-100 transition":"opacity-75 transition";return s.jsxs(s.Fragment,{children:[s.jsx("div",{className:r,children:s.jsx("div",{className:"gizmo-bot-avatar rounded-full",children:s.jsx(Gs,{iconName:"openai"})})}),s.jsx("span",{className:n,children:"ChatGPT"})]})},lr=({comment:{diffStatus:e,content:t},isFocused:n,isSomeCommentFocused:r,isHovered:a})=>{const o=e===Oe.REMOVED;return s.jsx("div",{className:w("text-token-text-primary mt-2 transition-all",{"opacity-80":!n&&!r&&!a&&!o,"opacity-40":!n&&r&&!a&&!o,[Qt]:o}),children:s.jsx(Vs,{text:t})})},cr=({acceptButtonLabel:e,position:t="absolute",left:n,right:r,comment:a,disableAnimations:o=!1,onClick:l,onMouseEnter:c,onMouseLeave:f,onAccept:m,onDismiss:d,translateY:p,isFocused:u=!1,isSomeCommentFocused:h=!1,disableActions:x=!1,isHovered:y=!1},E)=>{const[v,g]=i.useState(!1),C=a.diffStatus===Oe.ADDED,M=a.diffStatus===Oe.REMOVED,N=a.diffStatus!=null,I=()=>{g(!0),c?.()},P=()=>{g(!1),f?.()},A=oe(),W=u||v&&!h;return s.jsx(L.div,{ref:E,className:w(t,_e.expandedComment,{"cursor-default":u,"cursor-pointer":!u,[_e.expandedCommentFocused]:u,[_e.expandedCommentHovered]:y}),style:{left:n,right:r},initial:o?!1:{translateY:p,scale:.85,opacity:0},animate:o?void 0:{translateY:p,scale:u?1:.97,opacity:1},exit:o?void 0:{scale:.85,opacity:0,filter:"blur(16px)"},transition:Zt,onClick:l,onMouseEnter:x?void 0:I,onMouseLeave:x?void 0:P,"data-comment-id":a.id,children:s.jsxs("div",{className:w("flex min-h-8 flex-col overflow-hidden rounded-2xl border p-4 pt-2 text-start text-sm transition-all",{"border-transparent bg-gray-50 dark:bg-gray-800":!u&&!y,"border-token-border-default bg-token-main-surface-primary":y&&!u,"border-token-border-default bg-token-main-surface-primary shadow-xl":u||v&&!h,"relative after:absolute after:start-0 after:top-0 after:bottom-0 after:w-1":N,"after:bg-green-500":C,"after:bg-red-500":M}),style:{width:nn},children:[s.jsxs("div",{className:w("flex h-8 flex-row items-center gap-2.5",{[Qt]:M}),children:[s.jsx(ir,{isFocused:u,isHovered:y}),s.jsx("button",{className:w("text-token-text-secondary -me-1 rounded-full bg-transparent p-1",{"hover:text-token-text-primary cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700":!x,"cursor-not-allowed":x}),onClick:d,disabled:x,"aria-label":A.formatMessage({id:"fYDa3C",defaultMessage:"Dismiss comment"}),children:s.jsx(js,{className:"icon-sm"})})]}),s.jsx(lr,{comment:a,isFocused:u,isHovered:y,isSomeCommentFocused:h}),s.jsx(fe,{initial:!1,children:W&&s.jsx(L.div,{initial:o?!1:{opacity:0,height:0},animate:{opacity:1,height:"auto",transition:{opacity:{delay:.14,duration:.2},height:{bounce:0,duration:.2}}},exit:o?void 0:{opacity:0,height:0,transition:{opacity:{duration:.08},height:{bounce:0,duration:.2}}},className:"flex items-center justify-start",children:s.jsx("div",{className:"mt-2.5",children:s.jsx(re,{color:"secondary",onClick:m,disabled:x,children:e??A.formatMessage({id:"WIW5OL",defaultMessage:"Apply"})})})})})]})})},Jt=i.forwardRef(cr),Na=({offsetY:e,opensOverDocument:t=!1,disableActions:n=!1,isFocused:r=!1,isSomeCommentFocused:a=!1,onAccept:o,onClick:l,onDismiss:c,onMouseEnter:f,onMouseLeave:m,comment:d,isHovered:p=!1})=>{const u=i.useRef(null);return i.useEffect(()=>jt(document,{mousedown:({target:h})=>{h instanceof HTMLElement&&!h.closest("[data-comment-id]")&&!u.current?.contains(h)&&De.blurComment()}})),s.jsx(Jt,{ref:u,comment:d,disableActions:n,onAccept:o,onDismiss:c,onMouseEnter:f,onMouseLeave:m,isSomeCommentFocused:a,isHovered:p,onClick:l,translateY:e,isFocused:r,left:t?void 0:an,right:t?rn:void 0})};var ae=(e=>(e.LOADING="loading",e.READY="ready",e.RESOLVED="resolved",e))(ae||{});const es=({hint:e,onClickFix:t,isOpen:n,onOpenChange:r})=>{const a=i.useRef(null),o=oe();return e?s.jsx("div",{className:"relative flex items-center font-sans",onClick:l=>l.stopPropagation(),children:s.jsxs(qs,{open:n,onOpenChange:r,children:[s.jsx(zs,{asChild:!0,ref:a,children:e.status==="resolved"?s.jsx("div",{className:"flex h-5 w-5 items-center",children:s.jsx(Xs,{className:"text-token-text-tertiary",size:16})}):s.jsx("button",{className:"h-5 w-5",disabled:e.status==="loading",children:e.status==="loading"?s.jsx(nt,{}):s.jsx(or,{position:"static",isError:!0,count:1,offsetY:0})})}),s.jsx(fe,{children:n&&s.jsx(Ys,{forceMount:!0,container:a.current?.ownerDocument.body,children:s.jsx(Ks,{side:"top",align:"start",alignOffset:-4,sideOffset:10,children:s.jsx(Jt,{position:"static",translateY:0,right:0,isFocused:!0,onDismiss:()=>r?.(!1),onAccept:l=>{r?.(!1),t?.(l)},comment:e,acceptButtonLabel:o.formatMessage({id:"Dl9vBh",defaultMessage:"Fix bug"})})})})})]})}):s.jsx("div",{className:"w-5"})},dr="module:",Ze=({log:e,isDisabled:t=!1,onClick:n})=>s.jsx("div",{className:"flex items-center",children:"line"in e&&e.line!=null&&s.jsxs("button",{onClick:()=>e.line!=null&&n?.(e.line),className:"text-token-text-tertiary select-none enabled:hover:underline",disabled:t,children:[dr,e.line]})}),ur=({isPreview:e=!1,log:t,level:n})=>s.jsxs("span",{className:w("text-token-text-primary flex min-w-0 flex-wrap gap-1",e?"shrink truncate":"whitespace-pre-wrap",n==="warn"&&"text-yellow-600"),children:[n==="warn"&&"[warn]: ",typeof t=="string"?t:t.map((r,a)=>s.jsx(mn,{isPreview:e,value:r},a))]}),ts=({error:e,isPreview:t=!1,isResolved:n=!1})=>{const r=e.name+":";return s.jsxs("span",{className:w("whitespace-pre-wrap",n?"text-token-text-primary":"text-red-500"),children:[s.jsx("span",{className:"font-semibold",children:r})," ",e.message,s.jsx("div",{children:e.stack.length>0&&!t?e.stack.join(`
`):""})]})},mr=({output:e,isPreview:t=!1})=>{const n=oe();return e==null?null:Kt(e)?s.jsx("img",{alt:n.formatMessage(pr.imgAlt),className:w(t&&"border-token-border-xlight h-6 rounded-lg border"),src:e}):s.jsx("span",{className:"flex items-center gap-2",children:$e(e)})},rt=({log:e,isHintResolved:t,isPreview:n=!1})=>{switch(e.type){case b.LOG:return s.jsx(ur,{isPreview:n,...e});case b.ERROR:return s.jsx(ts,{isPreview:n,isResolved:t,...e});case b.OUTPUT:return s.jsx(mr,{isPreview:n,...e});default:return null}},fr=({log:e,isStale:t=!1,onClickFix:n,onClickLineNumber:r,hint:a})=>{const[o,l]=i.useState(!1);if(e.type===b.RUN_COMPLETE)return null;const c=a?.status===ae.RESOLVED,f=e.type===b.ERROR&&a?.status===ae.READY;return s.jsx(ye,{hasHint:f,isHintOpen:o,bottomBorder:!0,onClick:a&&!c&&(()=>l(!0)),contentBefore:s.jsx(es,{hint:a,isOpen:o,onOpenChange:l,onClickFix:m=>e.type===b.ERROR&&a&&n?.(m,a.id,e.error)}),contentAfter:s.jsx(Ze,{log:e,isDisabled:t,onClick:r}),children:s.jsx(rt,{log:e,isHintResolved:c})})},pr=Se({imgAlt:{id:"L6t7Yb",defaultMessage:"Plot"},ranCode:{id:"ffa9Nt",defaultMessage:"Ran code"},askForHelp:{id:"wMZco9",defaultMessage:"Ask ChatGPT for help"},askForFix:{id:"A9pxgT",defaultMessage:"Fix it for me"}}),xr=({timestamp:e,duration:t})=>{const[,n]=i.useState(0);i.useEffect(()=>{setInterval(()=>{n(o=>o+1)},5e3)},[]);const r=Date.now(),a=Math.round((r-e)/1e3);return s.jsx(Ne,{label:s.jsx(B,{id:"bFO21A",defaultMessage:"Code ran {count, plural, =0 {instantly} one {in # second} other {in # seconds}}",values:{count:Math.floor(t/1e3)}}),children:s.jsx("span",{className:"text-token-text-tertiary",children:a>=60?s.jsx(ms,{value:-a,updateIntervalInSeconds:60,numeric:"auto"}):s.jsx(B,{id:"bRCEFN",defaultMessage:"Just now"})})})},ss=({isComplete:e,timestamp:t,duration:n})=>e&&t!=null&&n!=null?s.jsx(xr,{timestamp:t,duration:n}):e&&n==null?s.jsx("span",{className:"text-token-text-tertiary",children:s.jsx(B,{id:"EMebM9",defaultMessage:"Stopped"})}):s.jsx(He,{gap:2}),hr=e=>{switch(e){case Y.INITIALIZING:return s.jsx(B,{id:"J183Z0",defaultMessage:"initializing environment"});case Y.INSTALLING_PACKAGES:return s.jsx(B,{id:"21sQ8o",defaultMessage:"installing packages"});case Y.RUNNING_CODE:return s.jsx(B,{id:"nHITHk",defaultMessage:"running code"})}},Re=({message:e,isComplete:t,statusLogs:n})=>{const r=Ve(n);return s.jsxs("span",{className:"flex items-center",children:[s.jsx("span",{className:"text-token-text-secondary font-semibold",children:s.jsx(B,{...e})}),!t&&r&&s.jsxs(L.span,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{delay:.3,duration:.1},className:"text-token-text-tertiary ms-2 flex items-baseline",children:[hr(r.status),s.jsx(He,{gap:2,size:2})]})]})},gr=({children:e,firstLog:t,lastLog:n,isHintResolved:r,duration:a,isComplete:o=!1,isLast:l=!1,statusLogs:c})=>{const[f,m]=i.useState(!0),[d,p]=i.useState(!1),u=i.useRef(null),h=()=>{m(!f)};return i.useEffect(()=>{const{current:x}=u;if(!x)return;const y=new IntersectionObserver(E=>{E[0].intersectionRatio===0?p(!0):p(!1)},{threshold:0});return y.observe(x),()=>y.unobserve(x)},[]),s.jsxs("li",{className:"relative flex flex-col",children:[s.jsx("div",{"aria-hidden":"true",className:"pointer-events-none absolute h-[1px] bg-transparent",ref:u}),s.jsxs(ye,{as:"div",disableEntryAnimation:!0,isSticky:!0,bottomBorder:d||!l&&!f,contentAfter:s.jsx(ss,{isComplete:o,duration:a,timestamp:t?.timestamp}),contentBefore:s.jsx("button",{className:"text-token-text-tertiary",onClick:()=>h(),children:s.jsx(Zs,{className:w("icon transition-transform",f&&"rotate-90")})}),onClick:()=>h(),children:[s.jsx(Re,{isComplete:o,message:Me.run,statusLogs:c}),!f&&n&&s.jsx(rt,{isPreview:!0,isHintResolved:r,log:n})]}),f&&e]})},yr=({runMessages:e,onClickFix:t,onClickLineNumber:n,hints:r,isStale:a,isLast:o,includeContentBefore:l=!1})=>{const[c,f]=i.useState(!1),m=e.filter(g=>g.type===b.ENVIRONMENT_STATUS),d=e.filter(Xt),p=Ve(e),u=p?.type===b.RUN_COMPLETE,h=u?p.duration:null,x=d[0];if(u){if(d.length===0)return s.jsx(ye,{isHintOpen:c,bottomBorder:!0,contentBefore:l,contentAfter:s.jsx(ss,{isComplete:u,duration:h,timestamp:x?.timestamp}),children:s.jsx(Re,{isComplete:u,message:Me.success,statusLogs:m})});if(d.length===1&&x?.type===b.ERROR){const g=r.get(x.id);return s.jsxs(ye,{hasHint:!!g,isHintOpen:c,bottomBorder:!0,contentBefore:(l||!!g)&&s.jsx(es,{hint:g,isOpen:c,onOpenChange:f,onClickFix:C=>t?.(C,x.id,x.error)}),contentAfter:s.jsx(Ze,{log:x,isDisabled:a,onClick:n}),onClick:g&&g.status!==ae.RESOLVED&&(()=>f(!0)),children:[s.jsx(Re,{isComplete:u,message:Me.run,statusLogs:m}),s.jsx(ts,{isResolved:g?.status===ae.RESOLVED,...x})]})}else if(d.length===1&&x&&!Yt(d[0]))return s.jsxs(ye,{bottomBorder:!0,contentBefore:l,contentAfter:s.jsx(Ze,{log:x,isDisabled:a,onClick:n}),children:[s.jsx(Re,{isComplete:u,message:Me.run,statusLogs:m}),s.jsx(rt,{log:x})]})}const y=Ve(d.filter(g=>g.type!==b.RUN_COMPLETE)),v=(y&&r.get(y.id))?.status===ae.RESOLVED;return s.jsx(gr,{statusLogs:m,firstLog:x??null,lastLog:y??null,duration:h,isComplete:u,isHintResolved:v,isLast:o,children:s.jsx("ol",{children:d.map(g=>s.jsx(fr,{log:g,isStale:a,onClickLineNumber:n,onClickFix:t,hint:r.get(g.id)},g.id))})})},Me=Se({success:{id:"laZI5H",defaultMessage:"Run successfully"},run:{id:"o7dgBT",defaultMessage:"Run"}}),Cr=`You're a professional developer highly skilled in debugging. The user ran the textdoc's code, and an error was thrown.
Please think carefully about how to fix the error`,vr=(e,t,n)=>{const r=zt(e,n);return`
${Cr}, and then rewrite the textdoc to fix it.

- NEVER change existing test cases unless they're clearly wrong.
- ALWAYS add more test cases if there aren't any yet.
- ALWAYS ask the user what the expected behavior is in the chat if the code is not clear.

${t?`# Hint

${t}

`:""}
# Error

${r}`.trim()},Er=({codeRunMessages:e,scrollRef:t,onClose:n,onClickLineNumber:r,onClickFix:a,title:o,headerActions:l,lastRunId:c,hints:f})=>{const m=f.size>0,d=i.useMemo(()=>Object.entries(ks(e,"runId")),[e]),p=d.some(([,u])=>{const h=u.filter(Xt);return h.length>1||h.length===1&&Yt(h[0])});return s.jsxs(s.Fragment,{children:[s.jsx(Qn,{title:o,actions:l,onClose:n,showBorder:e.length>0}),s.jsx("div",{ref:t,className:"bg-token-main-surface-primary flex flex-1 flex-col-reverse overflow-auto",children:s.jsx("ol",{className:"flex flex-1 flex-col justify-start pb-4",children:s.jsx(fe,{children:d.map(([u,h],x)=>s.jsx(yr,{runMessages:h,includeContentBefore:p||m,onClickFix:a,onClickLineNumber:r,hints:f,isStale:u!==c,isLast:x===d.length-1},u))})})})]})},br=({sandboxRef:e,textdocContent:t,textdocTitle:n,textdocId:r,isOpen:a,isTextdocAttachedPending:o,headerActions:l=[],highlightLine:c,createTextdocTurn:f,onOpenChange:m},d)=>{const[p,u]=i.useState(!1),[h,x]=i.useState(!1),[y,E]=i.useState([]),[v,g]=i.useState(0),[C,M]=i.useState(null),[N,I]=i.useState(null),[P,A]=i.useState(()=>new Map),[W,V]=i.useState(320),H=i.useRef(null),G=oe();i.useEffect(()=>I(null),[t]);const Q=y.filter(S=>[b.LOG,b.ERROR,b.OUTPUT].includes(S.type)).length;i.useEffect(()=>{a&&g(Q)},[a]);const D=i.useMemo(()=>{for(let S=y.length-1;S>=0;S--){const O=y[S];if(O.runId!==N)return null;if(O.type===b.ERROR)return O}return null},[y,N]),_=(S,O,R)=>{const k=P.get(O);if(k){const{id:T,content:te}=k;A(ee=>{const $=new Map(ee);return $.set(T,{id:T,content:te,status:ae.RESOLVED}),$})}M(O),f({sourceEvent:S,action:le.EDIT,userMessageType:X.CONSOLE,content:vr(t,k?.content??null,R)})},q=async(S,O)=>{if(!o){A(R=>{const k=new Map(R);return k.set(S,{id:S,status:ae.LOADING,content:""}),k});try{const R=await tr(r,t,O);A(k=>{const T=new Map(k);return T.set(S,{id:S,status:ae.READY,content:R}),T})}catch{A(k=>{const T=new Map(k);return T.delete(S),T})}}},j=async(S,O)=>{const R=on(S,O),k=ln(S,O),T=cn(S);if(!R||!T&&!k)return;T&&m?.(!0),x(!0),E($=>$.map(F=>({...F,isStale:!0})));let te=!1;const ee=me(e.current).evalAsync({code:O,language:R});for await(const $ of ee){if($.type===b.RUN_START&&requestAnimationFrame(()=>{H.current?.scrollTo({top:0,behavior:"smooth"})}),$.type===b.ERROR){if($.line!=null){const{line:F}=$;requestAnimationFrame(()=>c(F))}te=!0,q($.id,$)}I($.runId),E(F=>[...F,{...$,isStale:!1}])}te&&m?.(!0),x(!1)};i.useImperativeHandle(d,()=>({runCode:j,stopCode:()=>e.current?.stop()}));const U=!a&&h,J=U&&D&&D.id!==C,z=!J&&U&&Q>v;return s.jsxs(fe,{children:[p&&s.jsx("div",{className:"pointer-events-auto absolute inset-0 bg-transparent"},"drag-overlay"),z&&s.jsx(L.button,{initial:{scale:.95,opacity:0},exit:{scale:.95,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",bounce:.12,duration:.3},className:"bg-token-main-surface-primary hover:bg-token-main-surface-secondary absolute end-2 bottom-2 flex items-center gap-2 rounded-full px-3 py-1.5 shadow-lg",onClick:()=>m?.(!0),children:s.jsxs("span",{className:"text-token-text-secondary flex items-center gap-1 text-sm",children:[s.jsx(Qs,{className:"icon-sm"}),s.jsx(B,{id:"etzFTa",defaultMessage:"{numLogs, plural, one {{numLogs} message} other {{numLogs} messages}}",values:{numLogs:Q}})]})},"view-console"),J&&s.jsx(er,{textdocTitle:n,onClickViewConsole:()=>m?.(!0),onDismiss:()=>M(D.id),onClickFix:S=>{_(S,D.id,D.error)}},"error-modal"),a&&s.jsxs(L.div,{initial:{translateY:"100%",opacity:0},animate:{translateY:"0%",opacity:1},exit:{translateY:"100%",opacity:0},transition:{type:"spring",bounce:0,duration:.48},className:"border-token-border-default relative z-10 w-full border-t shadow-[0px_0px_32px_rgba(0,0,0,0.08)]",children:[s.jsx(Jn,{onDragEnd:()=>u(!1),onDrag:({delta:{y:S}})=>{u(!0),V(O=>O-S)}}),s.jsx("div",{className:"flex flex-col",style:{height:W},children:s.jsx(Er,{scrollRef:H,codeRunMessages:y,onClose:()=>m?.(!1),onClickLineNumber:c,onClickFix:_,title:G.formatMessage({id:"P9VJDk",defaultMessage:"Console"}),headerActions:[...l,{tooltip:G.formatMessage({id:"gAICYK",defaultMessage:"Clear console"}),icon:Js,onClick:()=>{g(0),E([]),A(new Map)}}],lastRunId:N,hints:P})})]},"console")]})},wa=i.forwardRef(br);class Sr{dependencies(){return[]}unifiedInitializationHook(t){return t}}class ns extends Sr{unistToProseMirrorTest(t){return t.type===this.unistNodeName()}proseMirrorInputRules(t){return[]}proseMirrorKeymap(t){return{}}postUnistToProseMirrorHook(t){}customDirectiveName(){return null}}class ja extends ns{proseMirrorToUnistTest(t){return this.proseMirrorNodeName()===t.type.name}proseMirrorNodeView(){return null}proseMirrorNodeName(){return this.constructor.proseMirrorNodeName()}static proseMirrorNodeName(){throw new Error("Method not implemented.")}}class Nr extends ns{proseMirrorMarkName(){return this.constructor.proseMirrorMarkName()}static proseMirrorMarkName(){throw new Error("Method not implemented.")}}class wr extends Nr{unistNodeName(){return"startend"}static proseMirrorMarkName(){return"startend"}proseMirrorMarkSpec(){return{attrs:{start:{},end:{}},toDOM(){return["span",0]}}}unistNodeToProseMirrorNodes({schema:t,convertedChildren:n,attrs:r}){return n.map(a=>a.mark(a.marks.concat([t.marks[this.proseMirrorMarkName()].create(r)])))}processConvertedUnistNode(t){return{type:this.unistNodeName(),children:[t]}}}function Pe(e){if(e.type.name!=="text"){const{start:a,end:o}=e.attrs;return a==null||o==null?null:{start:a,end:o}}const t=e.marks.find(a=>a.type.name===wr.proseMirrorMarkName());if(!t)return null;const{start:n,end:r}=t.attrs;return n==null||r==null?null:{start:n,end:r}}function jr(e,t){const{parent:n,textOffset:r}=t,a=e.nodeAt(t.pos);if(!a)return me(Pe(n)).end;const{start:o}=me(Pe(a));return o+r}function kr(e,t){const n=e.nodeAt(t.pos);if(n){const{start:r}=me(Pe(n));return r+t.textOffset}return me(Pe(t.parent)).end}function ka(e,t){const n=new Map;for(const[r,a]of t){const o=jr(e,e.resolve(a.start)),l=kr(e,e.resolve(a.end));n.set(r,{start:o,end:l})}return n}const Tr=i.createContext(()=>null),_r=i.createContext(null),Rr=i.createContext(0),Ta=()=>i.useContext(Tr),_a=()=>i.useContext(_r),Ra=()=>i.useContext(Rr),Mr=i.createContext(()=>null),Ir=i.createContext(null),Ma=i.createContext(0),Ia=()=>i.useContext(Mr),Oa=()=>i.useContext(Ir);function La({isDisabled:e=!1,isCodePreviewable:t=!1,isCodeRunning:n,disabledTooltip:r,clientThreadId:a,onClick:o}){const[l,c]=i.useState(n),[{width:f},m]=Ot();i.useEffect(()=>{let x=null;return!n||t?c(n):(x=setTimeout(()=>{c(n)},200),()=>clearTimeout(x))},[n,t]);const d=()=>({conversation_id:a?_s(a):void 0}),p=()=>{Ts.logEventWithStatsig("Canvas Run Code Button Clicked","chatgpt_canvas_run_code_button_clicked",d()),setTimeout(()=>o?.())},u=s.jsx(L.button,{disabled:e||n&&!l,onClick:p,className:w("btn rounded-full border transition-colors",l?w(hn,"border-transparent"):"border-token-border-default hover:bg-token-surface-hover bg-transparent"),animate:{width:f??0},initial:{width:f??0},transition:{type:"spring",bounce:.24,duration:.4},children:s.jsx("div",{ref:m,children:l?s.jsxs(L.div,{className:"flex items-center gap-2 px-3 sm:px-4",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},children:[s.jsx(yn,{className:"icon"}),s.jsx("span",{className:"hidden sm:inline",children:s.jsx(B,{...ke.stopCode})})]}):s.jsxs(L.div,{className:"flex items-center gap-2 px-3 sm:px-4",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},children:[s.jsx(en,{className:"icon"}),s.jsx("span",{className:"hidden whitespace-nowrap sm:inline",children:s.jsx(B,{...ke.runCode})})]})})}),h=e&&r?r:n?null:s.jsx(B,{...t?ke.previewCodeTooltip:ke.runCodeTooltip});return h?s.jsx(Ne,{label:h,children:u}):u}const ke=Se({runCode:{id:"37troW",defaultMessage:"Run code"},stopCode:{id:"nCwG4+",defaultMessage:"Stop"},runCodeTooltip:{id:"UeNB/S",defaultMessage:"See output and debug"},previewCodeTooltip:{id:"xAotrE",defaultMessage:"Run your code in canvas"}}),Or=/\s/,Lr=30;function pt(e,t){const n=e.indexOf(t);return n===-1?!1:e.indexOf(t,n+t.length)===-1}function ie(e,t){return Or.test(e[t])}function xt(e,t,n=!1){if(t===0||n&&ie(e,t-1))return t;for(;t>0&&ie(e,t-1);)t--;for(;t>0&&!ie(e,t-1);)t--;return ie(e,t)&&t++,t}function ht(e,t,n=!1){if(t===e.length||n&&ie(e,t))return t;for(;t<e.length&&ie(e,t);)t++;for(;t<e.length&&!ie(e,t);)t++;return ie(e,t-1)&&t--,t}function Ar(e,t,n=!0,r=Lr){if(e.start<0||e.end>t.length||e.start>e.end)throw new Error("Invalid commentSourceRange provided.");const a=t.substring(e.start,e.end);let o=e.start,l=e.end;n&&(o=xt(t,o,!0),l=ht(t,l,!0));let c=t.substring(o,e.start),f=t.substring(e.end,l),m=`${c}${a}${f}`;if(pt(t,m)&&(r==null||m.length>=r))return{before:c,after:f,allSurrounding:m};let d=o,p=l,u=!0;for(;u&&(r==null||m.length<r);){let h=!1;const x=d>0?xt(t,d):d;x<d&&(d=x,h=!0);const y=p<t.length?ht(t,p):p;if(y>p&&(p=y,h=!0),h){const E=t.substring(d,e.start),v=t.substring(e.end,p),g=`${E}${a}${v}`;if(pt(t,g)&&(r==null||g.length>=r))return{before:E,after:v,allSurrounding:g};c=E,f=v,m=g}else u=!1}return{before:c,after:f,allSurrounding:m}}const Ce="# Context",ve="# Instructions";function Ee(e,t,n){if(t==null||n==null)return`The user is referring to the entire text of "${e}".`;const r=`
## Selected Text
The user has selected this text in "${e}" in particular:
${t}
`.trim();return n.allSurrounding===t?r:`
${r}

## Surrounding Context
Here is the surrounding context:
${n.allSurrounding}
`.trim()}function rs(e,t){return e==null||t==null?"entire document":e===t.allSurrounding?"selected text":"surrounding context"}function as(e){return`For the update pattern, create a regex which exactly matches the ${e}. Edit just this string in order to fullfill the user's request. NEVER rewrite the entire document. Instead, ALWAYS edit ONLY the ${e}. The only exception to this rule is if the ${e} includes markdown lists or tables. In that case, fully rewrite the document using ".*" as the regex update pattern.`.trim()}function Dr(e,t,n,r){if(!Mt(t)&&n&&r){const a=rs(n,r);return`
${Ce}
The user requests that you directly edit the document.

${Ee(e,n,r)}

${ve}
Use the update_textdoc tool to make this edit. ${as(a)}`.trim()}return`
${Ce}
The user requests that you directly edit the document.

${Ee(e,n,r)}

${ve}
Use the update_textdoc tool to make this edit. You MUST fully rewrite the entire document by using ".*" as the update regex pattern.`.trim()}function Pr(e,t,n){return`
${Ce}
The user requests that you add comments about some text.

${Ee(e,t,n)}

${ve}
Do not respond to the user's question directly, just leave comments.`.trim()}function Br(e,t){return Mt(e)?t==="entire document"?` If you choose to update the ${t}, you MUST fully rewrite the ${t} by using ".*" as the update regex pattern.`:` If you choose to update the ${t}, you MUST fully rewrite the entire document by using ".*" as the update regex pattern. When you do so, ONLY modify the ${t} and rewrite other sections exactly as is, except for parts that must change based on this update`:t==="entire document"?"":` If you choose to update the ${t}, follow these instructions: ${as(t)}`}function Ur(e,t,n,r){const a=rs(n,r),o=Br(t,a);return`
${Ce}
${Ee(e,n,r)}

${ve}
The user would like you perform one of the following actions:
- Update the ${a} via the \`update_textdoc\` tool.${o}
- Explain the selected text via chat, or answer a general question about the selected text (no tool call required).
- Comment on the ${a} with feedback via the \`comment_textdoc\` tool. This should only be used if the user very explicitly asks for feedback, critique, or comments.

Based on the user's request, choose the appropriate action.
`.trim()}function $r(e,t,n){return`
${Ce}
${Ee(e,t,n)}

${ve}
The user would like you to create a new textdoc.
`.trim()}function Fr(e,t,n,r=null,a=null){switch(n){case le.ASK:return Ur(e,t,r,a);case le.CREATE_TEXTDOC:return $r(e,r,a);case le.EDIT:return Dr(e,t,r,a);case le.COMMENT:return Pr(e,r,a)}}function Hr(e){switch(e){case X.ACCELERATOR:case X.CONSOLE:case X.ACCEPT_COMMENT:case X.HIVE_SPEAKER_EDIT:return!0;case X.ASK_CHATGPT:case X.FULL_SCREEN_SUBMIT:return!1}}function Wr(e,t){switch(t){case X.ASK_CHATGPT:case X.ACCEPT_COMMENT:case X.FULL_SCREEN_SUBMIT:return e.formatMessage(Vr.askChatGPT);case X.ACCELERATOR:case X.CONSOLE:case X.HIVE_SPEAKER_EDIT:return}}const Gr=(e,t)=>{const n=oe(),r=Rs(e),a=tn(e),o=Ms();return i.useCallback(async({content:l,sourceRange:c,action:f,userMessageType:m,acceleratorMetadata:d,selectionMetadata:p,sourceEvent:u})=>{if(t?.versionInt==null||o)return;const{textdocId:h,type:x,versionInt:y,content:E}=t;let v,g=null;c&&c.start!==c.end&&(v=E.slice(c.start,c.end),g=Ar(c,E));const C=Fr(h,x,f,v,g),N=Is(C,{exclude_after_next_user_message:!0});a({sourceEvent:u,promptMessage:Os(l,{canvas:{textdoc_id:h,textdoc_type:x,version:y,textdoc_content_length:E.length,user_message_type:m,accelerator_metadata:d,selection_metadata:p},is_visually_hidden_from_conversation:Hr(m),targeted_reply:v,targeted_reply_label:Wr(n,m),open_in_canvas_view:{type:"canvas_textdoc",id:h}}),completionMetadata:r?{conversationMode:r}:void 0,appendMessages:[N]})},[t,o,a,r,n])},Vr=Se({askChatGPT:{id:"h5ANdM",defaultMessage:"Asked ChatGPT"}}),be=_t(e=>({currentTime:0,setCurrentTime:t=>e(()=>({currentTime:t})),isOpen:!1,openSidebar:()=>e({isOpen:!0}),closeSidebar:()=>e({isOpen:!1}),hoveringSpeakerId:null,setHoveringSpeakerId:t=>e({hoveringSpeakerId:t}),editingSpeaker:null,setEditingSpeaker:t=>e({editingSpeaker:t}),speakers:new Map,setSpeakers:t=>e({speakers:t}),enableDebugger:!1,setEnableDebugger:t=>e(()=>({enableDebugger:t})),selectedFilters:["default","revive"],setSelectedFilters:t=>e(()=>({selectedFilters:t}))})),Aa=e=>t=>As.findNode(t,({message:n})=>{const r=n.metadata?.canvas;return r?.create_source===sn.HIVE&&r.textdoc_id===e&&!!r.hive_id})?.message.metadata?.canvas?.hive_id,qr=e=>{const t=Math.floor(e/3600),n=Math.floor(e%3600/60),r=e%60,a=t.toString().padStart(2,"0"),o=n.toString().padStart(2,"0"),l=r.toString().padStart(2,"0");return t>0?`${a}:${o}:${l}`:`${o}:${l}`},os=e=>{const{setSpeakers:t}=be.getState(),n=e.compact_transcript,r=Object.values(e.compact_transcript?.speakers??{}),a=new Map(r?.map(c=>[c.id,{name:void 0,storedName:c.updated_name,placeholderName:c.name,isEdited:!1}]));return t(a),(n?.segments??[]).map(c=>({speakerId:c.speaker_id,range:{min:c.start_seconds,max:c.end_seconds},content:c.content,filterDecision:c.filter_decision}))},Da=()=>Je(Ls(),"1804926979"),zr=(e,t,n=1)=>{fs(e.scrollTop,t,{duration:n,ease:"easeInOut",onUpdate:r=>{e.scrollTop=r}})},is=se.div`flex w-full grow flex-col gap-1 rounded-xl p-2 pe-5 text-sm`,Xr=se.input`ms-[-2px] w-auto rounded-none border-none bg-[#E5F3FF] p-0 px-0.5 text-sm font-semibold outline-none focus:outline-none`,Yr=se(L.span)`start border-token-text-tertiary absolute -bottom-0.5 w-full origin-left border-b border-solid`,Kr=se(L.span)`start border-token-text-tertiary absolute -bottom-0.5 w-full border-b border-dashed`,Te=se.div`w-full loading-results-shimmer bg-token-bg-secondary h-2 rounded-full`,Zr=()=>s.jsxs(is,{className:"gap-2",children:[" ",s.jsx(Te,{className:"w-[48px]"})," ",s.jsx(Te,{})," ",s.jsx(Te,{})," ",s.jsx(Te,{className:"w-1/2"})]}),Qr={initial:{scaleX:0,opacity:1},animate:{scaleX:1,opacity:0,transition:{scaleX:{duration:.85,ease:[.65,0,.35,1]},opacity:{delay:.85,duration:.1}}}},Jr={initial:{opacity:0},animate:{opacity:1,transition:{delay:.85,duration:.1}}};se.div`ms-2 rounded-full px-2 py-0.5 text-xs font-medium`;const ls=({speakerId:e,content:t,range:n,filterDecision:r,isEditing:a,isSaving:o,containerRef:l,measuredTextContainerRef:c,isEditingEnabled:f})=>{const m=i.useRef(null),{setSpeakers:d,setEditingSpeaker:p,hoveringSpeakerId:u,setHoveringSpeakerId:h,speakers:x,editingSpeaker:y,enableDebugger:E}=be.getState(),v=be(_=>_.currentTime),g=n.max==null?v===n.min:v>=n.min&&v<=n.max;i.useEffect(()=>{if(g&&m.current&&l.current){const _=l.current,q=m.current,j=_.getBoundingClientRect().top,J=q.getBoundingClientRect().top-j+_.scrollTop-20;zr(_,J,.3)}},[n.min,n.max,g,l]);const C=x.get(e),M=!!C?.storedName&&C.storedName!==C?.placeholderName||(C?.isEdited??!1),N=C?.name??C?.storedName??C?.placeholderName??"Unidentified Speaker",I=i.useRef(null),P=e===y?.id,A=e===u,[W,V]=i.useState(!1),[H,G]=i.useState(!1);i.useEffect(()=>{I.current&&(!P||!H||(I.current?.focus(),M&&(I.current.value=N)))},[M,P,H,N]),Ds(()=>{if(c?.current&&I.current){const _=c.current.offsetWidth;I.current.style.width=`${_}px`}},[y?.name]);const Q=i.useCallback(()=>{if(!y||!C)return;p(null),G(!1),V(!1),h(null);const _=x.set(e,{...C,name:y.name?y.name:C.placeholderName,isEdited:!!y.name});d(_)},[y,C,p,h,x,e,d]),D=!a||o;return s.jsxs(is,{ref:m,className:w(g&&"animate-[hive-log-fadeout_0.3s_1.5s_forwards] bg-blue-500/10",!1,!1),children:[!1,s.jsxs("div",{className:"mb-[1px] flex w-full items-center justify-between",children:[f&&(P?s.jsx(Xr,{ref:I,disabled:!H,onBlur:Q,className:w(!P&&"hidden w-0"),placeholder:C?.isEdited?void 0:C?.placeholderName,value:y?.name,onKeyDown:_=>{_.key==="Enter"&&Q()},onChange:_=>p({id:e,name:_.target.value})}):s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsxs("div",{onClick:()=>{D||(p({id:e,name:M?N:""}),G(!0))},onMouseEnter:()=>{D||(h(e),V(!0))},onMouseLeave:()=>{D||(h(null),V(!1))},className:w("relative flex font-semibold transition-colors",{"text-blue-400!":A&&!D},{"cursor-pointer":!D},{"text-token-text-tertiary":!D&&!M}),children:[N,!D&&!M&&s.jsxs(s.Fragment,{children:[s.jsx(Yr,{...Qr}),s.jsx(Kr,{...Jr,className:w(A&&!D&&"border-blue-400!")})]})]}),W&&!D&&s.jsx(It,{className:"h-4 w-4 text-blue-400"}),!1]})),s.jsx("div",{className:"text-xs text-[#5D5D5D]",children:qr(n.min)})]}),s.jsx("div",{className:"flex",children:t})]})},ea=e=>Qe({queryKey:["sharedHiveLog",e],queryFn:()=>pe.safeGet("/hive/textdoc/shared/{shared_textdoc_id}/transcript",{parameters:{path:{shared_textdoc_id:e}}}),select:os}),ta=e=>Qe({queryKey:["hiveLog",e],queryFn:()=>pe.safeGet("/hive/{hive_id}/transcript",{parameters:{path:{hive_id:e}}}),enabled:!!e,select:os}),sa=()=>Qe({queryKey:["hiveLogPrompts"],queryFn:()=>pe.safeGet("/hive/prompts"),enabled:!0}),na=(e,t)=>pe.safePost("/hive/{hive_id}/speakers",{parameters:{path:{hive_id:e}},requestBody:{speakers:t}}),ra=se.div`invisible absolute start-0 top-0 rounded-md border px-0.5 text-sm font-semibold whitespace-pre`,aa=(e,t)=>!t||!e?"":t.isEdited||e.name&&e.name!==t.placeholderName?e.name:t.placeholderName,cs=()=>s.jsx(Us,{children:s.jsx(B,{...ce.researchPreview})}),oa=se.div`flex h-full w-full max-w-[360px] min-w-[240px] flex-col border-l border-gray-200`,ia=se.div`flex w-full max-w-[360px] min-w-[240px] flex-col border-l border-gray-200`,la=se.div`bg-token-bg-primary mt-[0.5px] flex h-18 w-full items-center justify-between border-b-[0.5px] border-gray-200 p-4`,ds=se.div`flex h-full w-full flex-col gap-2 overflow-y-auto p-2`,gt=se(L.div)`flex items-center gap-2`,yt={initial:{opacity:0,y:-4},animate:{opacity:1,y:0,transition:{duration:.2}},exit:{opacity:0,y:-4,transition:{duration:.2}}},Pa="ts",Ba=({sharedTextDocId:e})=>{const t=ea(e),n=i.useRef(null),r=Ps(),{selectedFilters:a,isOpen:o,currentTime:l,closeSidebar:c}=be(),f=i.useMemo(()=>t.data?.filter(({filterDecision:p})=>!p||a?.includes(p)),[t.data,a]);if(t.isError)return null;const m=s.jsxs("div",{className:"text-token-text-secondary flex items-center gap-1.5 px-2 py-2 text-base font-medium md:px-0",children:[s.jsx(B,{...ce.transcript}),s.jsx(cs,{})]}),d=s.jsxs(s.Fragment,{children:[t.isLoading&&Array.from({length:16}).map((p,u)=>s.jsx(Zr,{},`loading-${u}`)),f?.map(p=>s.jsx(ls,{isEditingEnabled:!1,containerRef:n,...p},us(p)))]});return!o||!l?null:r?s.jsxs(ia,{children:[s.jsxs(la,{children:[m,s.jsx(Bs,{onClick:c})]}),s.jsx(ds,{ref:n,children:d})]}):s.jsx(Ct,{contentRef:n,testId:"modal-shared-canvas-transcript-modal",isOpen:o,title:m,contentClassName:"overflow-y-auto gap-2 p-2 flex flex-col",showCloseButton:!0,onClose:c,children:d})},Ua=({hiveId:e,clientThreadId:t,ts:n,textdocVersion:r})=>{const a=ta(e),o=sa(),l=oe(),[c,f]=i.useState(!1),m=i.useRef(null),d=Fe(),p=Je(d,"2986567482"),{isOpen:u,closeSidebar:h,openSidebar:x,setCurrentTime:y,speakers:E,setSpeakers:v,editingSpeaker:g,enableDebugger:C,setEnableDebugger:M,selectedFilters:N,setSelectedFilters:I}=be();i.useEffect(()=>{n!==void 0&&(x(),y(n))},[n,x,y]);const P=i.useRef(null),[A,W]=i.useState(!1),V=Gr(t,r);if(a.isLoading||o.isLoading||a.isError||o.isError||!a.data||!o.data)return null;const H=g?E.get(g.id):null,G=Array.from(E.values()).some(({isEdited:j})=>j),Q=()=>{const j=new Map(Array.from(E.entries()).map(([U,J])=>[U,{...J,name:void 0,isEdited:!1}]));v(j),f(!1)},D=j=>{if(!o.data.speaker_edits)return;const U=o.data.speaker_edits.replace("{speakers}",JSON.stringify(Array.from(E.entries())));return V({sourceEvent:j,action:le.EDIT,content:U,userMessageType:X.HIVE_SPEAKER_EDIT,selectionMetadata:void 0})},_=async j=>{if(G){W(!0);try{const U=[];Array.from(E.entries()).forEach(([S,O])=>{!O.isEdited||!O.name||U.push({id:S,updated_name:O.name})});const J=await na(e,U);if(!J)throw new Error("Failed to update hive content");const z=new Map(E);for(const S of J.updated_speakers){if(!z.has(S.id))continue;const O=z.get(S.id);O&&z.set(S.id,{...O,storedName:S.updated_name,isEdited:!1})}await D(j),v(z),f(!1)}catch{}finally{W(!1)}}},q=a.data.filter(({filterDecision:j})=>!j||N?.includes(j));return s.jsxs(oa,{className:w(u?"visible":"invisible hidden"),children:[s.jsxs("div",{className:"flex h-14 w-full items-center justify-between border-b border-gray-200 p-4",children:[s.jsxs("div",{className:"text-token-text-secondary group/debug flex items-center gap-1.5 py-2 text-base font-medium",children:[s.jsx(B,{...ce[c?"edit":"transcript"]}),s.jsx(cs,{}),!1]}),s.jsx("div",{className:"flex h-10 items-center gap-2",children:s.jsx(fe,{mode:"wait",children:c?s.jsxs(gt,{...yt,children:[s.jsx(re,{onClick:Q,color:"secondary",disabled:A,children:s.jsx(B,{...ce.cancelButton})}),s.jsx(re,{color:"primary",onClick:_,disabled:!G,loading:A,children:s.jsx(B,{...ce.saveButton})})]},"edit-buttons"):s.jsxs(gt,{...yt,children:[p&&s.jsx(Ne,{className:"h-10",label:l.formatMessage(ce.editButtonTooltip),children:s.jsx(lt,{icon:It,onClick:()=>f(!0)})}),s.jsx(lt,{icon:et,onClick:()=>h()})]},"non-edit-buttons")})})]}),!1,s.jsxs(ds,{ref:m,children:[p&&g&&s.jsx(ra,{ref:P,children:aa(g,H)}),q.map(j=>s.jsx(ls,{isEditingEnabled:p,measuredTextContainerRef:P,containerRef:m,isEditing:c,isSaving:A,...j},us(j)))]})]})},us=e=>{const{speakerId:t,content:n,range:r}=e;return`${t}-${r.min}-${r.max}-${n.slice(0,2)}`},ce=Se({researchPreview:{id:"HiveLogSidebar.researchPreview",defaultMessage:"Research Preview"},edit:{id:"HiveLogSidebar.edit",defaultMessage:"Edit"},transcript:{id:"HiveLogSidebar.transcript",defaultMessage:"Transcript"},editButtonTooltip:{id:"HiveLogSidebar.editButtonTooltip",defaultMessage:"Edit speakers"},cancelButton:{id:"HiveLogSidebar.cancelButton",defaultMessage:"Cancel"},saveButton:{id:"HiveLogSidebar.saveButton",defaultMessage:"Save"}});export{nt as A,Jt as B,va as C,wr as D,Na as E,Sr as F,Da as G,qr as H,ka as I,Mr as J,Ir as K,Ma as L,Nr as M,ja as N,jr as O,kr as P,Gr as Q,vn as R,Ba as S,La as T,Pa as U,Ua as V,Xe as W,Aa as X,_a as a,Ra as b,Fn as c,be as d,wa as e,Rn as f,Pe as g,De as h,Un as i,$n as j,Bn as k,Ia as l,Oa as m,ba as n,Ea as o,Vt as p,Gn as q,Vn as r,Wn as s,Tr as t,Ta as u,_r as v,Rr as w,Sa as x,le as y,or as z};
//# sourceMappingURL=bfek75jeyiiysrf0.js.map

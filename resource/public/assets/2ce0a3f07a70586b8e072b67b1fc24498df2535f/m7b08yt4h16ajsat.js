import{jP as E,jJ as i,jK as I,bv as R,nn as v,R as w,no as O,np as N,jL as h,jW as A}from"./cim4usely8ixso70.js";import{r as S}from"./n97h6so7iblif4c5.js";import{m as k}from"./oydmias8dmdlkk45.js";import{b4 as d,b5 as f}from"./ivbsxyeeopn30y8l.js";function re({composerController:o,parsedDocumentHandler:s}){const{connectorConfig:n}=E();return S.useEffect(()=>{const t=()=>{const e=P(o,n);s(e)};return t(),o.subscribe("change",t)},[o,n,s]),null}function P(o,s){const n=o.getCurrentText(),t=[];for(const e of s.values())switch(e.type){case i.GDRIVE:{if(e.link_enabled??!0){const r=x(n,e);t.push(...r),e.access_token&&r.reduce((c,l)=>c.replace(l.url,""),n)!==n&&r.forEach(({url:c})=>o.replaceAll(c,""))}break}case i.O365:break;case i.O365_BUSINESS:{const r=z(n,e).filter(a=>a!=null);e.access_token&&r.forEach(({url:a})=>o.replaceAll(a,"")),t.push(...r);break}case i.O365_PERSONAL:{const r=j(n,e).filter(a=>a!=null);e.access_token&&r.forEach(({url:a})=>o.replaceAll(a,"")),t.push(...r);break}case i.CONFLUENCE:{const r=F(n,e).filter(a=>a!=null);e.access_token&&r.forEach(({url:a})=>o.replaceAll(a,"")),t.push(...r);break}case i.JIRA:{const r=M(n,e).filter(a=>a!=null);e.access_token&&r.forEach(({url:a})=>o.replaceAll(a,"")),t.push(...r);break}case i.NOTION_OPEN_CONNECTOR:{const r=Z(n,e).filter(a=>a!=null);e.access_token&&r.forEach(({url:a})=>o.replaceAll(a,"")),t.push(...r);break}case i.SLACK_OPEN_CONNECTOR:{const r=K(n,e).filter(a=>a!=null);e.access_token&&r.forEach(({url:a})=>o.replaceAll(a,"")),t.push(...r);break}}return t.length&&I.linkPasted(k(R(t,e=>e.type),e=>e.length)),t}const C=/\bhttps:\/\/docs\.google\.com\/(document|spreadsheets|presentation)\/d\/([\w-]+)\/?(?:(?:edit|view)\/?)?(?:\?[\w\-.~%=]*)?(?:#[\w\-.~%=]*)?/gm,b=/\bhttps:\/\/drive\.google\.com\/(file)\/d\/([\w-]+)\/?(?:(?:edit|view)\/?)?(?:\?[\w\-.~%=]*)?(?:#[\w\-.~%=]*)?/gm,T="https://www.googleapis.com/auth/drive.readonly";function x(o,s){return[...o.matchAll(C),...o.matchAll(b)].map(n=>{const t={url:n[0],id:n[2],type:i.GDRIVE};return s.access_token&&s.scopes&&s.scopes.includes(T)?{...t,handler:{type:"fetch",tryFetch:async()=>{f.logAttemptIfAccessTokenIsExpired(s,h.Link);const r=`https://www.googleapis.com/drive/v3/files/${t.id}?fields=name,mimeType`,a=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${s.access_token}`,"Content-Type":"application/json"}});if(!a.ok)return Promise.reject(new Error(`HTTP ${a.status}`));const{name:c,mimeType:l}=await a.json(),u=A(l);return{connector:i.GDRIVE,id:t.id,title:c,mimeType:l,url:t.url,syntheticExtension:u}}}}:{...t,handler:{type:"prompt",message:"not-connected"}}})}function g(o){let s;try{s=new URL(o).toString()}catch{return null}return`u!${btoa(s).replaceAll("=","").replaceAll("/","_").replaceAll("+","-")}`}const D=/\bhttps:\/\/onedrive\.live\.com\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm,U=/\bhttps:\/\/photos\.onedrive\.com\/(?:share|photo)\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm,$=/\bhttps:\/\/1drv\.ms\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm;function j(o,s){return[...o.matchAll(D),...o.matchAll($),...o.matchAll(U)].map(n=>{const t=g(n[0]);if(!t)return null;const e={url:n[0],id:t,type:i.O365_PERSONAL};return s.access_token?{...e,handler:{type:"fetch",tryFetch:y(d.OneDrive_PERSONAL_SHARES,t,s.access_token,s)}}:{...e,handler:{type:"prompt",message:"not-connected"}}})}const L=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/wiki\/spaces\/[^\s]+\/pages\/(\d+)\/([^\s]+)?/gm;function F(o,s){return[...o.matchAll(L)].map(n=>{const t=n[1],e=n[2],r=n[3];if(!e)return null;const a={url:n[0],id:e,type:i.CONFLUENCE};return s.access_token?{...a,handler:{type:"fetch",tryFetch:async()=>{let c=r;return!r&&s.access_token&&(c=await Q(s.access_token,`https://${t}`,s,e)),{connector:s.type,id:e,title:c,mimeType:"text/html",url:a.url,syntheticExtension:null,manifest:{id:e,domain:t,type:N.PAGE,manifest_type:i.CONFLUENCE}}}}}:{...a,handler:{type:"prompt",message:"not-connected"}}})}const B=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/browse\/([^\s]+)\??/gm,G=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/jira\/(?:[^\s]+\/)*projects\/(?:[^\s]+\/)+(?:[^\s]+\/?)\?selectedIssue=([^\s]+)&?/gm;function M(o,s){return[...o.matchAll(B),...o.matchAll(G)].map(n=>{const t=n[1],e=n[2];if(!e||!t)return null;const r={url:n[0],id:e,type:i.JIRA};return s.access_token?{...r,handler:{type:"fetch",tryFetch:async()=>{const a=await X(s.access_token,`https://${t}`,s,e);return Promise.resolve({connector:s.type,id:e,title:a,mimeType:"text/markdown",url:r.url,syntheticExtension:null,manifest:{id_or_key:e,domain:t,manifest_type:i.JIRA}})}}}:{...r,handler:{type:"prompt",message:"not-connected"}}})}const J=/\bhttps:\/\/[^\s]+?\.sharepoint\.com\/[^\s]*/gm;function z(o,s){return[...o.matchAll(J)].map(n=>{const t=g(n[0]),e=d.OneDrive_BUSINESS_SHARES;if(!t)return null;const r={url:n[0],id:t,type:i.O365_BUSINESS};return s.access_token?{...r,handler:{type:"fetch",tryFetch:y(e,t,s.access_token,s)}}:{...r,handler:{type:"prompt",message:"not-connected"}}})}const H=/\bhttps:\/\/(?<domain>[^\s]+?\.(?:enterprise\.)?slack\.com)\/archives\/(?<conversation_id>[^\s/]+)\/?\??$/gm,V=/\bhttps:\/\/(?<domain>[^\s]+?\.(?:enterprise\.)?slack\.com)\/archives\/(?<conversation_id>[^\s/]+)\/p(?<message_id>[^\s?&]+)(?:\?(?:.*thread_ts=(?<thread_id>[^\s&]+)(?:&.*))?)?/gm;function K(o,s){return[...o.matchAll(V),...o.matchAll(H)].map(n=>{const t=n.groups?.domain;if(!t)throw new Error(`No domain found in match ${JSON.stringify(n)}`);const e=n.groups?.conversation_id;if(!e)throw new Error(`No conversation ID found in match ${JSON.stringify(n)}`);const r=n.groups?.message_id;let a=null;r&&(a=`${r.slice(0,10)}.${r.slice(10)}`);const c=n.groups?.thread_id??null;let l="Conversation",u=`conversation-${e}`;a?(l="Message",u=`message-${a}`):c?(l="Thread",u=`thread-${c}`):e[0]==="D"&&(l="Direct message");const p={id:u,url:n[0],domain:t,conversationId:e,messageId:a,threadId:c,type:i.SLACK_OPEN_CONNECTOR};return s.access_token?{...p,handler:{type:"fetch",tryFetch:async()=>s.access_token?Promise.resolve({connector:s.type,id:p.id,title:l,mimeType:"application/json",url:p.url,syntheticExtension:null,manifest:{conversation_id:p.conversationId,domain:p.domain,manifest_type:i.SLACK_OPEN_CONNECTOR,message_id:p.messageId,thread_id:c,type:v.MESSAGE}}):Promise.reject(new Error("Not connected"))}}:{...p,handler:{type:"prompt",message:"not-connected"}}})}function y(o,s,n,t,e){switch(o){case d.OneDrive_BUSINESS_SHARES:case d.OneDrive_PERSONAL_SHARES:return()=>m(`${o}/${encodeURIComponent(s)}/driveItem`,n,t);case d.OneDrive_BUSINESS_DRIVE_ITEMS:return()=>m(`${o}/${encodeURIComponent(s)}`,n,t);case d.OneDrive_BUSINESS_DRIVE_ROOT:return async()=>{const r=await q(n,s);if(!r)return Promise.reject(null);const a=`${o}:${encodeURIComponent(r)}`;return m(a,n,t)};case d.OneDrive_PERSONAL_DRIVE_ITEMS:return()=>Promise.reject(null)}}async function q(o,s){const t=await fetch("https://graph.microsoft.com/v1.0/me/drive/root",{method:"GET",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(!t.ok)return null;const{webUrl:e}=await t.json(),a=new URL(e).pathname;return s.startsWith(a)?s.substring(a.length):s}async function m(o,s,n,t){f.logAttemptIfAccessTokenIsExpired(n,h.Link);const e=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});if(!e.ok)return Promise.reject(new Error(`HTTP ${e.status}`));const{id:r,name:a,file:c,webUrl:l,...u}=await e.json();return t||(t=u.parentReference?.driveId),{connector:n.type,id:r,title:a??"",mimeType:c?.mimeType??"",url:l??"",syntheticExtension:null,o365DriveId:t}}const W="https://api.atlassian.com/oauth/token/accessible-resources";async function _(o,s,n){f.logAttemptIfAccessTokenIsExpired(n,h.Link);const e=(await fetch(W,{headers:{Authorization:`Bearer ${o}`}}).then(r=>r.json())).find(r=>r.url===s)?.id;return e||Promise.reject(new Error("Cloud ID not found"))}async function Q(o,s,n,t){const e=await _(o,s,n);return(await fetch(`https://api.atlassian.com/ex/confluence/${e}/wiki/api/v2/pages/${t}?include-version=false`,{headers:{Authorization:`Bearer ${o}`}}).then(c=>c.json())).title??"Confluence Page"}async function X(o,s,n,t){const e=await _(o,s,n);return(await fetch(`https://api.atlassian.com/ex/jira/${e}/rest/api/2/issue/${t}?fields=summary`,{headers:{Authorization:`Bearer ${o}`}}).then(c=>c.json())).fields.summary??"Jira Issue"}const Y=/\bhttps:\/\/www\.notion\.so\/(?:.*?)?(?<page_id>[a-f0-9]{32})(?:\?[\x21-\x7e]*)?/gm;function Z(o,s){return[...o.matchAll(Y)].map(n=>{const t=n.groups?.page_id;if(!t)return null;const e={url:n[0],id:t,type:i.NOTION_OPEN_CONNECTOR};return s.access_token?{...e,handler:{type:"fetch",tryFetch:async()=>{const r=await w.safePost("/connectors/metadata",{requestBody:{manifest:{id:t,manifest_type:i.NOTION_OPEN_CONNECTOR}}});return Promise.resolve({connector:s.type,id:t,title:r.title??"Notion Page",mimeType:"application/json",url:e.url,syntheticExtension:null,manifest:{id:t,type:O.PAGE,manifest_type:i.NOTION_OPEN_CONNECTOR}})}}}:{...e,handler:{type:"prompt",message:"not-connected"}}})}export{re as ContextConnectorDocumentParser,g as encodeOneDriveShareUrl,P as parseDocumentURLsAndStripFromInput};
//# sourceMappingURL=m7b08yt4h16ajsat.js.map

import{r as n,u as R,h as I,d as L,l as K,j as c,aj as B,a as U,ac as q,y as N}from"./bubexfvksfr7893o.js";import{jO as z,p as H,rr as Q,fO as $}from"./ncw8zw682jinppua.js";import{W as G}from"./m6ljv8pxljtc7j4d.js";import{y as V,z as J,k as X,W as Y,r as Z,t as D,A as ee}from"./o0dw43fppqvaf7ws.js";import{cw as te,aV as P,aW as A}from"./lm3g1zm00rp6al39.js";import{u as re}from"./k3w19w5sa48fujqs.js";import{useSetupBaseWhamKeyboardActions as ne}from"./kry998ghqvvi5h0n.js";import{b as oe,g as se,T as ue,W as ae,c as ie}from"./bezlbl32xw9oguw1.js";import{u as me}from"./cxhvc6trae8s9e85.js";import"./fum95d46v8d5jv8u.js";import"./n2u3q2i5341kdx8j.js";import"./nzkkesm2p4dklarf.js";import"./iv5xwnwraxd9v7zq.js";import"./icif99f9c6x3iitu.js";import"./f1ucdf2dx4ztfnd4.js";import"./kou7k14ueo6peaoq.js";import"./gfhyoobo4q8q2pzd.js";import"./n8w61inav9kre7iu.js";import"./n630qnacd2oui4py.js";import"./n117ifjno76hbo3f.js";import"./gqlpgmzguho9n5oh.js";import"./h1em0bjkpkjv8ykw.js";import"./m609xwboj0zo059y.js";import"./eifqzljcxkeg8zns.js";import"./o6p9t02t81236kdb.js";import"./hu1bt0oauegdhua6.js";import"./fy4l2kpcbjlox0ps.js";import"./cxp76v1gv71u5chl.js";import"./ha3yj3u2f1w16goy.js";import"./fyy6o8kal64rtpos.js";import"./e5q3f3k67x71csb7.js";import"./lptwpbjabrvjmhsj.js";import"./nnaau44w7pxfjjn3.js";import"./lv98i5lrm8g24nlg.js";import"./ffjw65gjnc6j0nz8.js";import"./ffvjxtmoqooghm1t.js";import"./eqqsnl6kprwt6kvn.js";import"./iqtpdwh2n8o5iyd7.js";import"./ckeauhcg4pu33xfw.js";import"./m214aojas5i8u5ss.js";import"./i8ns2k0nyu6k62qc.js";import"./owg1t5lbjzwpi0hd.js";import"./gc5zntv10x5pyl7r.js";import"./knfzy5vszhnec9ql.js";function ce(){return n.useSyncExternalStore(t=>(document.addEventListener("focusin",t),document.addEventListener("focusout",t),()=>{document.removeEventListener("focusin",t),document.removeEventListener("focusout",t)}),()=>{var t;return typeof document<"u"&&((t=document.activeElement)==null?void 0:t.hasAttribute("data-wham-comment-textarea"))===!0},()=>!1)}function de(t){var b,_,k,T,h,w,W;const a=R(),i=z(),m=ce(),{data:e,error:p}=V(t,{refetchOnWindowFocus:!0,refetchOnMount:!0}),{isLoading:d}=J(t),o=X(n.useCallback(({getTurnsForTask:s})=>{var u;return(u=s(t))!=null?u:[]},[t])),{focusedAssistantTurn:r,setFocusedAssistantTurnId:S}=oe({taskId:t,task:e==null?void 0:e.task,currentUserTurn:(b=e==null?void 0:e.current_user_turn)!=null?b:null,currentAssistantTurn:(_=e==null?void 0:e.current_assistant_turn)!=null?_:null}),v=n.useMemo(()=>{var s,u;return se({focusedAssistantTurn:r,pastTurns:o,currentDiffTaskTurnId:(u=(s=e==null?void 0:e.current_diff_task_turn)==null?void 0:s.id)!=null?u:null})},[r,(k=e==null?void 0:e.current_diff_task_turn)==null?void 0:k.id,o]),l=(T=e==null?void 0:e.task)==null?void 0:T.current_turn_id,C=!!(e!=null&&e.task.has_unread_turn)&&l===((h=e==null?void 0:e.current_assistant_turn)==null?void 0:h.id),g=((w=e==null?void 0:e.current_assistant_turn)==null?void 0:w.turn_status)==="completed";n.useEffect(()=>{var f;if(!i)return;const s=(f=e==null?void 0:e.task)==null?void 0:f.title;if(!s)return;const u=document.title;return document.title=s,()=>{document.title=u}},[i,(W=e==null?void 0:e.task)==null?void 0:W.title]),n.useEffect(()=>{!C||!g||Y.markTurnAsRead(t).then(()=>{a.invalidateQueries({queryKey:["wham","tasks"]}),a.invalidateQueries({queryKey:["wham","task",t]})})},[C,g,t,a]);const M=n.useMemo(()=>{var E,x,j,y;const s=r?Z(r.turn_status):!1,u=((j=r==null?void 0:r.sibling_turn_ids)==null?void 0:j.includes((x=(E=e==null?void 0:e.current_assistant_turn)==null?void 0:E.id)!=null?x:""))||(r==null?void 0:r.id)===((y=e==null?void 0:e.current_assistant_turn)==null?void 0:y.id),f=!(e!=null&&e.current_diff_task_turn);return s&&(u||f)},[r,e==null?void 0:e.current_assistant_turn,e==null?void 0:e.current_diff_task_turn]);return{taskDetails:e,taskDetailsError:p,loadingTurnMapping:d,turns:o,focusedAssistantTurn:r,setFocusedAssistantTurnId:S,currentDiffTaskTurn:v,canFollowUp:M,isCommentFocused:m}}function pe(){const[t,a]=n.useState([]),[i,m]=n.useState(!1),e=n.useCallback(()=>{a([])},[]),p=n.useCallback(({onClose:d,isComposerEmpty:o})=>({force:r=!1}={})=>{if(r||t.length===0&&o){e(),d();return}m(!0)},[t.length,e]);return{comments:t,setComments:a,confirmClose:i,setConfirmClose:m,clearComments:e,createCloseHandler:p}}function le({taskId:t,onClose:a}){"use no forget";var y,F;const i=H(),m=I(),e=L(),{composerController:p,isComposerEmpty:d}=me(),{taskDetails:o,taskDetailsError:r,loadingTurnMapping:S,turns:v,focusedAssistantTurn:l,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g,canFollowUp:M,isCommentFocused:b}=de(t),_=n.useMemo(()=>D(l),[l]),k=n.useMemo(()=>({taskId:t,task:o==null?void 0:o.task,pastTurns:v,canFollowUp:M,focusedAssistantTurn:l,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g}),[t,o,v,M,l,C,g]),{comments:T,setComments:h,confirmClose:w,setConfirmClose:W,clearComments:s,createCloseHandler:u}=pe(),f=n.useMemo(()=>({comments:T,setComments:h,clearComments:s,readonlyComments:_}),[T,h,s,_]),E=te.useCurrentImage()!=null,x=u({onClose:a,isComposerEmpty:d});ne(),re([{key:"newTask",action:()=>{e("/codex",{state:{focusComposer:!0}})},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.newTask",defaultMessage:"New task"}),group:A.Chat,keyboardBinding:[P.Mod,P.Shift,"o"]},{key:"closeTask",action:()=>{e("/codex")},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.closeTask",defaultMessage:"Close task"}),group:A.Chat,keyboardBinding:[P.Escape],enabled:!E&&!b}]);const j=n.useCallback(({force:O=!1}={})=>{x({force:O})},[x]);return r?(i.danger(K({id:"wham.task-details.error",defaultMessage:"Error loading task"}),{id:"wham-task-details-error-".concat(t),hasCloseButton:!0,duration:3,toastId:"wham_task_page_content_error"}),c.jsx(B,{to:"/codex"})):c.jsx(Q.Provider,{value:p,children:c.jsx(ue,{value:f,children:c.jsx(ae,{value:k,children:c.jsx(ie,{permissions:"write",turnId:(F=(y=o==null?void 0:o.current_assistant_turn)==null?void 0:y.id)!=null?F:"",confirmClose:w,setConfirmClose:W,handleClose:j,loadingTurnMapping:S})})})})}function fe(){var d;const t=L(),a=U(),{taskId:i}=q();ee();const m=(d=a.state)!=null?d:{},{backgroundLocation:e}=m,p=n.useCallback(()=>{t(e?-1:"/codex")},[e,t]);return i?c.jsx($,{children:c.jsx(G,{children:c.jsx(le,{taskId:i,onClose:p})})}):null}const st=()=>[{title:"Codex"}],ut=N(function(){return c.jsx(fe,{})});export{ut as default,st as meta};
//# sourceMappingURL=n9dpiuqp2264xyli.js.map

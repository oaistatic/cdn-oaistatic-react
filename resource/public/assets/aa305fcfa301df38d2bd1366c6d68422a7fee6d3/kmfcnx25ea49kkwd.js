var xn=Object.defineProperty,Rn=Object.defineProperties;var On=Object.getOwnPropertyDescriptors;var je=Object.getOwnPropertySymbols;var wt=Object.prototype.hasOwnProperty,Tt=Object.prototype.propertyIsEnumerable;var nt=(e,n,t)=>n in e?xn(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,le=(e,n)=>{for(var t in n||(n={}))wt.call(n,t)&&nt(e,t,n[t]);if(je)for(var t of je(n))Tt.call(n,t)&&nt(e,t,n[t]);return e},ge=(e,n)=>Rn(e,On(n));var kt=(e,n)=>{var t={};for(var r in e)wt.call(e,r)&&n.indexOf(r)<0&&(t[r]=e[r]);if(e!=null&&je)for(var r of je(e))n.indexOf(r)<0&&Tt.call(e,r)&&(t[r]=e[r]);return t};var J=(e,n,t)=>nt(e,typeof n!="symbol"?n+"":n,t);import{p as qt,b1 as Ln,aX as ze,a as Vn,io as N,lg as Gt,vz as Nn,c as Un,r as pt,cp as Bt,jb as Qt,vA as $n,p5 as Fn,u as Yt,I as Wn,eB as jn,ll as zn,T as qn,n as st,bm as Gn,V as Bn,O as Qn,bn as Yn,t7 as at,fX as Hn,w as Jn,vB as Kn,aP as Xn,au as Zn,vC as Ct}from"./ncw8zw682jinppua.js";import{gB as ne,n2 as Ht,m_ as er,uM as tr,nZ as K,uN as nr,uO as rr,uP as Ce,uQ as _t,uR as or,uS as ir,uT as cr,uU as sr,uV as Jt,uW as ut,uX as ar,uY as ur,uZ as lr,u_ as dr,u$ as fr,v0 as pr,v1 as hr,v2 as vr,v3 as mr,qk as Kt,qh as re,ql as Sr,v4 as xe,v5 as Ye,n1 as me,gC as ye,h as gr,nI as q,v6 as yr,v7 as Xt,bc as br,q3 as wr,v8 as Tr,v9 as de,oQ as kr,va as Cr,vb as _r,vc as Ir,vd as Er,ve as Mr,q8 as It,q7 as Pr,q6 as Dr,q5 as Et,la as Ar,vf as xr,vg as Rr,q4 as Or}from"./lm3g1zm00rp6al39.js";import{r as u,j as lt,d as Lr,u as Zt,h as Vr}from"./bubexfvksfr7893o.js";import{d as Nr,a as b,T as ie,P as A,e as te,C as X}from"./bxgk09qvxvkate6l.js";const Ur=()=>{const e=qt(),n=ne(),t=u.useCallback(()=>n.getState().isVoiceModeActive,[n]);return u.useMemo(()=>new Proxy(e,{get(r,o){const i=r[o];return t()||o==="closeAll"?i:()=>{}}}),[t,e])},Mt=async(e,n)=>{var r;n||(n=await Ht.getLocalDevices());const t=(r=n.find(o=>o.deviceId===e))==null?void 0:r.label;return t!=null?t:e};function en(){var t,r,o,i;const e=er();if(!e)return{video:!1,screenshare:!1};const n=tr(e);return{video:(r=(t=n==null?void 0:n.features)==null?void 0:t.video)!=null?r:!1,screenshare:(i=(o=n==null?void 0:n.features)==null?void 0:o.screen_sharing)!=null?i:!1}}var $r=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Fr(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var tn={exports:{}};(function(e){(function(n,t){e.exports?e.exports=t():n.log=t()})($r,function(){var n=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),o=["trace","debug","info","warn","error"],i={},c=null;function a(f,x){var h=f[x];if(typeof h.bind=="function")return h.bind(f);try{return Function.prototype.bind.call(h,f)}catch(k){return function(){return Function.prototype.apply.apply(h,[f,arguments])}}}function s(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(f){return f==="debug"&&(f="log"),typeof console===t?!1:f==="trace"&&r?s:console[f]!==void 0?a(console,f):console.log!==void 0?a(console,"log"):n}function d(){for(var f=this.getLevel(),x=0;x<o.length;x++){var h=o[x];this[h]=x<f?n:this.methodFactory(h,f,this.name)}if(this.log=this.debug,typeof console===t&&f<this.levels.SILENT)return"No console available for logging"}function T(f){return function(){typeof console!==t&&(d.call(this),this[f].apply(this,arguments))}}function w(f,x,h){return l(f)||T.apply(this,arguments)}function m(f,x){var h=this,k,R,z,U="loglevel";typeof f=="string"?U+=":"+f:typeof f=="symbol"&&(U=void 0);function se(E){var L=(o[E]||"silent").toUpperCase();if(!(typeof window===t||!U)){try{window.localStorage[U]=L;return}catch(Y){}try{window.document.cookie=encodeURIComponent(U)+"="+L+";"}catch(Y){}}}function W(){var E;if(!(typeof window===t||!U)){try{E=window.localStorage[U]}catch(M){}if(typeof E===t)try{var L=window.document.cookie,Y=encodeURIComponent(U),g=L.indexOf(Y+"=");g!==-1&&(E=/^([^;]+)/.exec(L.slice(g+Y.length+1))[1])}catch(M){}return h.levels[E]===void 0&&(E=void 0),E}}function oe(){if(!(typeof window===t||!U)){try{window.localStorage.removeItem(U)}catch(E){}try{window.document.cookie=encodeURIComponent(U)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(E){}}}function Q(E){var L=E;if(typeof L=="string"&&h.levels[L.toUpperCase()]!==void 0&&(L=h.levels[L.toUpperCase()]),typeof L=="number"&&L>=0&&L<=h.levels.SILENT)return L;throw new TypeError("log.setLevel() called with invalid level: "+E)}h.name=f,h.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},h.methodFactory=x||w,h.getLevel=function(){var E;return(E=z!=null?z:R)!=null?E:k},h.setLevel=function(E,L){return z=Q(E),L!==!1&&se(z),d.call(h)},h.setDefaultLevel=function(E){R=Q(E),W()||h.setLevel(E,!1)},h.resetLevel=function(){z=null,oe(),d.call(h)},h.enableAll=function(E){h.setLevel(h.levels.TRACE,E)},h.disableAll=function(E){h.setLevel(h.levels.SILENT,E)},h.rebuild=function(){if(c!==h&&(k=Q(c.getLevel())),d.call(h),c===h)for(var E in i)i[E].rebuild()},k=Q(c?c.getLevel():"WARN");var ee=W();ee!=null&&(z=Q(ee)),d.call(h)}c=new m,c.getLogger=function(f){if(typeof f!="symbol"&&typeof f!="string"||f==="")throw new TypeError("You must supply a name when creating a logger.");var x=i[f];return x||(x=i[f]=new m(f,c.methodFactory)),x};var _=typeof window!==t?window.log:void 0;return c.noConflict=function(){return typeof window!==t&&window.log===c&&(window.log=_),c},c.getLoggers=function(){return i},c.default=c,c})})(tn);var Wr=tn.exports;const jr=Fr(Wr);var dt=function(e,n){return dt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(t[o]=r[o])},dt(e,n)};function he(e,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");dt(e,n);function t(){this.constructor=e}e.prototype=n===null?Object.create(n):(t.prototype=n.prototype,new t)}function zr(e,n,t,r){function o(i){return i instanceof t?i:new t(function(c){c(i)})}return new(t||(t=Promise))(function(i,c){function a(d){try{l(r.next(d))}catch(T){c(T)}}function s(d){try{l(r.throw(d))}catch(T){c(T)}}function l(d){d.done?i(d.value):o(d.value).then(a,s)}l((r=r.apply(e,[])).next())})}function nn(e,n){var t={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},r,o,i,c=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return c.next=a(0),c.throw=a(1),c.return=a(2),typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function a(l){return function(d){return s([l,d])}}function s(l){if(r)throw new TypeError("Generator is already executing.");for(;c&&(c=0,l[0]&&(t=0)),t;)try{if(r=1,o&&(i=l[0]&2?o.return:l[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,l[1])).done)return i;switch(o=0,i&&(l=[l[0]&2,i.value]),l[0]){case 0:case 1:i=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,o=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(i=t.trys,!(i=i.length>0&&i[i.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!i||l[1]>i[0]&&l[1]<i[3])){t.label=l[1];break}if(l[0]===6&&t.label<i[1]){t.label=i[1],i=l;break}if(i&&t.label<i[2]){t.label=i[2],t.ops.push(l);break}i[2]&&t.ops.pop(),t.trys.pop();continue}l=n.call(e,t)}catch(d){l=[6,d],o=0}finally{r=i=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function Ee(e){var n=typeof Symbol=="function"&&Symbol.iterator,t=n&&e[n],r=0;if(t)return t.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")}function He(e,n){var t=typeof Symbol=="function"&&e[Symbol.iterator];if(!t)return e;var r=t.call(e),o,i=[],c;try{for(;(n===void 0||n-- >0)&&!(o=r.next()).done;)i.push(o.value)}catch(a){c={error:a}}finally{try{o&&!o.done&&(t=r.return)&&t.call(r)}finally{if(c)throw c.error}}return i}function Je(e,n,t){if(arguments.length===2)for(var r=0,o=n.length,i;r<o;r++)(i||!(r in n))&&(i||(i=Array.prototype.slice.call(n,0,r)),i[r]=n[r]);return e.concat(i||Array.prototype.slice.call(n))}function Ie(e){return this instanceof Ie?(this.v=e,this):new Ie(e)}function qr(e,n,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(e,n||[]),o,i=[];return o=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",c),o[Symbol.asyncIterator]=function(){return this},o;function c(m){return function(_){return Promise.resolve(_).then(m,T)}}function a(m,_){r[m]&&(o[m]=function(f){return new Promise(function(x,h){i.push([m,f,x,h])>1||s(m,f)})},_&&(o[m]=_(o[m])))}function s(m,_){try{l(r[m](_))}catch(f){w(i[0][3],f)}}function l(m){m.value instanceof Ie?Promise.resolve(m.value.v).then(d,T):w(i[0][2],m)}function d(m){s("next",m)}function T(m){s("throw",m)}function w(m,_){m(_),i.shift(),i.length&&s(i[0][0],i[0][1])}}function Gr(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=e[Symbol.asyncIterator],t;return n?n.call(e):(e=typeof Ee=="function"?Ee(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(i){t[i]=e[i]&&function(c){return new Promise(function(a,s){c=e[i](c),o(a,s,c.done,c.value)})}}function o(i,c,a,s){Promise.resolve(s).then(function(l){i({value:l,done:a})},c)}}function F(e){return typeof e=="function"}function ht(e){var n=function(r){Error.call(r),r.stack=new Error().stack},t=e(n);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var rt=ht(function(e){return function(n){e(this),this.message=n?n.length+" errors occurred during unsubscription:\n"+n.map(function(t,r){return r+1+") "+t.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=n}});function Ke(e,n){if(e){var t=e.indexOf(n);0<=t&&e.splice(t,1)}}var Re=(function(){function e(n){this.initialTeardown=n,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var n,t,r,o,i;if(!this.closed){this.closed=!0;var c=this._parentage;if(c)if(this._parentage=null,Array.isArray(c))try{for(var a=Ee(c),s=a.next();!s.done;s=a.next()){var l=s.value;l.remove(this)}}catch(f){n={error:f}}finally{try{s&&!s.done&&(t=a.return)&&t.call(a)}finally{if(n)throw n.error}}else c.remove(this);var d=this.initialTeardown;if(F(d))try{d()}catch(f){i=f instanceof rt?f.errors:[f]}var T=this._finalizers;if(T){this._finalizers=null;try{for(var w=Ee(T),m=w.next();!m.done;m=w.next()){var _=m.value;try{Pt(_)}catch(f){i=i!=null?i:[],f instanceof rt?i=Je(Je([],He(i)),He(f.errors)):i.push(f)}}}catch(f){r={error:f}}finally{try{m&&!m.done&&(o=w.return)&&o.call(w)}finally{if(r)throw r.error}}}if(i)throw new rt(i)}},e.prototype.add=function(n){var t;if(n&&n!==this)if(this.closed)Pt(n);else{if(n instanceof e){if(n.closed||n._hasParent(this))return;n._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(n)}},e.prototype._hasParent=function(n){var t=this._parentage;return t===n||Array.isArray(t)&&t.includes(n)},e.prototype._addParent=function(n){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(n),t):t?[t,n]:n},e.prototype._removeParent=function(n){var t=this._parentage;t===n?this._parentage=null:Array.isArray(t)&&Ke(t,n)},e.prototype.remove=function(n){var t=this._finalizers;t&&Ke(t,n),n instanceof e&&n._removeParent(this)},e.EMPTY=(function(){var n=new e;return n.closed=!0,n})(),e})(),rn=Re.EMPTY;function on(e){return e instanceof Re||e&&"closed"in e&&F(e.remove)&&F(e.add)&&F(e.unsubscribe)}function Pt(e){F(e)?e():e.unsubscribe()}var Br={Promise:void 0},Qr={setTimeout:function(e,n){for(var t=[],r=2;r<arguments.length;r++)t[r-2]=arguments[r];return setTimeout.apply(void 0,Je([e,n],He(t)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function cn(e){Qr.setTimeout(function(){throw e})}function Dt(){}function Ge(e){e()}var vt=(function(e){he(n,e);function n(t){var r=e.call(this)||this;return r.isStopped=!1,t?(r.destination=t,on(t)&&t.add(r)):r.destination=Jr,r}return n.create=function(t,r,o){return new ft(t,r,o)},n.prototype.next=function(t){this.isStopped||this._next(t)},n.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},n.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},n.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},n.prototype._next=function(t){this.destination.next(t)},n.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},n.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},n})(Re),Yr=(function(){function e(n){this.partialObserver=n}return e.prototype.next=function(n){var t=this.partialObserver;if(t.next)try{t.next(n)}catch(r){qe(r)}},e.prototype.error=function(n){var t=this.partialObserver;if(t.error)try{t.error(n)}catch(r){qe(r)}else qe(n)},e.prototype.complete=function(){var n=this.partialObserver;if(n.complete)try{n.complete()}catch(t){qe(t)}},e})(),ft=(function(e){he(n,e);function n(t,r,o){var i=e.call(this)||this,c;return F(t)||!t?c={next:t!=null?t:void 0,error:r!=null?r:void 0,complete:o!=null?o:void 0}:c=t,i.destination=new Yr(c),i}return n})(vt);function qe(e){cn(e)}function Hr(e){throw e}var Jr={closed:!0,next:Dt,error:Hr,complete:Dt},mt=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function sn(e){return e}function Kr(e){return e.length===0?sn:e.length===1?e[0]:function(n){return e.reduce(function(t,r){return r(t)},n)}}var Z=(function(){function e(n){n&&(this._subscribe=n)}return e.prototype.lift=function(n){var t=new e;return t.source=this,t.operator=n,t},e.prototype.subscribe=function(n,t,r){var o=this,i=Zr(n)?n:new ft(n,t,r);return Ge(function(){var c=o,a=c.operator,s=c.source;i.add(a?a.call(i,s):s?o._subscribe(i):o._trySubscribe(i))}),i},e.prototype._trySubscribe=function(n){try{return this._subscribe(n)}catch(t){n.error(t)}},e.prototype.forEach=function(n,t){var r=this;return t=At(t),new t(function(o,i){var c=new ft({next:function(a){try{n(a)}catch(s){i(s),c.unsubscribe()}},error:i,complete:o});r.subscribe(c)})},e.prototype._subscribe=function(n){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(n)},e.prototype[mt]=function(){return this},e.prototype.pipe=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return Kr(n)(this)},e.prototype.toPromise=function(n){var t=this;return n=At(n),new n(function(r,o){var i;t.subscribe(function(c){return i=c},function(c){return o(c)},function(){return r(i)})})},e.create=function(n){return new e(n)},e})();function At(e){var n;return(n=e!=null?e:Br.Promise)!==null&&n!==void 0?n:Promise}function Xr(e){return e&&F(e.next)&&F(e.error)&&F(e.complete)}function Zr(e){return e&&e instanceof vt||Xr(e)&&on(e)}function eo(e){return F(e==null?void 0:e.lift)}function Oe(e){return function(n){if(eo(n))return n.lift(function(t){try{return e(t,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}function Xe(e,n,t,r,o){return new to(e,n,t,r,o)}var to=(function(e){he(n,e);function n(t,r,o,i,c,a){var s=e.call(this,t)||this;return s.onFinalize=c,s.shouldUnsubscribe=a,s._next=r?function(l){try{r(l)}catch(d){t.error(d)}}:e.prototype._next,s._error=i?function(l){try{i(l)}catch(d){t.error(d)}finally{this.unsubscribe()}}:e.prototype._error,s._complete=o?function(){try{o()}catch(l){t.error(l)}finally{this.unsubscribe()}}:e.prototype._complete,s}return n.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;e.prototype.unsubscribe.call(this),!r&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},n})(vt),no=ht(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),an=(function(e){he(n,e);function n(){var t=e.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return n.prototype.lift=function(t){var r=new xt(this,this);return r.operator=t,r},n.prototype._throwIfClosed=function(){if(this.closed)throw new no},n.prototype.next=function(t){var r=this;Ge(function(){var o,i;if(r._throwIfClosed(),!r.isStopped){r.currentObservers||(r.currentObservers=Array.from(r.observers));try{for(var c=Ee(r.currentObservers),a=c.next();!a.done;a=c.next()){var s=a.value;s.next(t)}}catch(l){o={error:l}}finally{try{a&&!a.done&&(i=c.return)&&i.call(c)}finally{if(o)throw o.error}}}})},n.prototype.error=function(t){var r=this;Ge(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=t;for(var o=r.observers;o.length;)o.shift().error(t)}})},n.prototype.complete=function(){var t=this;Ge(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var r=t.observers;r.length;)r.shift().complete()}})},n.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(n.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),n.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},n.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},n.prototype._innerSubscribe=function(t){var r=this,o=this,i=o.hasError,c=o.isStopped,a=o.observers;return i||c?rn:(this.currentObservers=null,a.push(t),new Re(function(){r.currentObservers=null,Ke(a,t)}))},n.prototype._checkFinalizedStatuses=function(t){var r=this,o=r.hasError,i=r.thrownError,c=r.isStopped;o?t.error(i):c&&t.complete()},n.prototype.asObservable=function(){var t=new Z;return t.source=this,t},n.create=function(t,r){return new xt(t,r)},n})(Z),xt=(function(e){he(n,e);function n(t,r){var o=e.call(this)||this;return o.destination=t,o.source=r,o}return n.prototype.next=function(t){var r,o;(o=(r=this.destination)===null||r===void 0?void 0:r.next)===null||o===void 0||o.call(r,t)},n.prototype.error=function(t){var r,o;(o=(r=this.destination)===null||r===void 0?void 0:r.error)===null||o===void 0||o.call(r,t)},n.prototype.complete=function(){var t,r;(r=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||r===void 0||r.call(t)},n.prototype._subscribe=function(t){var r,o;return(o=(r=this.source)===null||r===void 0?void 0:r.subscribe(t))!==null&&o!==void 0?o:rn},n})(an);(function(e){he(n,e);function n(t){var r=e.call(this)||this;return r._value=t,r}return Object.defineProperty(n.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),n.prototype._subscribe=function(t){var r=e.prototype._subscribe.call(this,t);return!r.closed&&t.next(this._value),r},n.prototype.getValue=function(){var t=this,r=t.hasError,o=t.thrownError,i=t._value;if(r)throw o;return this._throwIfClosed(),i},n.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},n})(an);var ro={now:function(){return Date.now()}},oo=(function(e){he(n,e);function n(t,r){return e.call(this)||this}return n.prototype.schedule=function(t,r){return this},n})(Re),Rt={setInterval:function(e,n){for(var t=[],r=2;r<arguments.length;r++)t[r-2]=arguments[r];return setInterval.apply(void 0,Je([e,n],He(t)))},clearInterval:function(e){return clearInterval(e)},delegate:void 0},io=(function(e){he(n,e);function n(t,r){var o=e.call(this,t,r)||this;return o.scheduler=t,o.work=r,o.pending=!1,o}return n.prototype.schedule=function(t,r){var o;if(r===void 0&&(r=0),this.closed)return this;this.state=t;var i=this.id,c=this.scheduler;return i!=null&&(this.id=this.recycleAsyncId(c,i,r)),this.pending=!0,this.delay=r,this.id=(o=this.id)!==null&&o!==void 0?o:this.requestAsyncId(c,this.id,r),this},n.prototype.requestAsyncId=function(t,r,o){return o===void 0&&(o=0),Rt.setInterval(t.flush.bind(t,this),o)},n.prototype.recycleAsyncId=function(t,r,o){if(o===void 0&&(o=0),o!=null&&this.delay===o&&this.pending===!1)return r;r!=null&&Rt.clearInterval(r)},n.prototype.execute=function(t,r){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var o=this._execute(t,r);if(o)return o;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},n.prototype._execute=function(t,r){var o=!1,i;try{this.work(t)}catch(c){o=!0,i=c||new Error("Scheduled action threw falsy error")}if(o)return this.unsubscribe(),i},n.prototype.unsubscribe=function(){if(!this.closed){var t=this,r=t.id,o=t.scheduler,i=o.actions;this.work=this.state=this.scheduler=null,this.pending=!1,Ke(i,this),r!=null&&(this.id=this.recycleAsyncId(o,r,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},n})(oo),Ot=(function(){function e(n,t){t===void 0&&(t=e.now),this.schedulerActionCtor=n,this.now=t}return e.prototype.schedule=function(n,t,r){return t===void 0&&(t=0),new this.schedulerActionCtor(this,n).schedule(r,t)},e.now=ro.now,e})(),co=(function(e){he(n,e);function n(t,r){r===void 0&&(r=Ot.now);var o=e.call(this,t,r)||this;return o.actions=[],o._active=!1,o}return n.prototype.flush=function(t){var r=this.actions;if(this._active){r.push(t);return}var o;this._active=!0;do if(o=t.execute(t.state,t.delay))break;while(t=r.shift());if(this._active=!1,o){for(;t=r.shift();)t.unsubscribe();throw o}},n})(Ot);new co(io);function so(e){return e&&F(e.schedule)}function ao(e){return e[e.length-1]}function un(e){return so(ao(e))?e.pop():void 0}var ln=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function dn(e){return F(e==null?void 0:e.then)}function fn(e){return F(e[mt])}function pn(e){return Symbol.asyncIterator&&F(e==null?void 0:e[Symbol.asyncIterator])}function hn(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function uo(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var vn=uo();function mn(e){return F(e==null?void 0:e[vn])}function Sn(e){return qr(this,arguments,function(){var n,t,r,o;return nn(this,function(i){switch(i.label){case 0:n=e.getReader(),i.label=1;case 1:i.trys.push([1,,9,10]),i.label=2;case 2:return[4,Ie(n.read())];case 3:return t=i.sent(),r=t.value,o=t.done,o?[4,Ie(void 0)]:[3,5];case 4:return[2,i.sent()];case 5:return[4,Ie(r)];case 6:return[4,i.sent()];case 7:return i.sent(),[3,2];case 8:return[3,10];case 9:return n.releaseLock(),[7];case 10:return[2]}})})}function gn(e){return F(e==null?void 0:e.getReader)}function Le(e){if(e instanceof Z)return e;if(e!=null){if(fn(e))return lo(e);if(ln(e))return fo(e);if(dn(e))return po(e);if(pn(e))return yn(e);if(mn(e))return ho(e);if(gn(e))return vo(e)}throw hn(e)}function lo(e){return new Z(function(n){var t=e[mt]();if(F(t.subscribe))return t.subscribe(n);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function fo(e){return new Z(function(n){for(var t=0;t<e.length&&!n.closed;t++)n.next(e[t]);n.complete()})}function po(e){return new Z(function(n){e.then(function(t){n.closed||(n.next(t),n.complete())},function(t){return n.error(t)}).then(null,cn)})}function ho(e){return new Z(function(n){var t,r;try{for(var o=Ee(e),i=o.next();!i.done;i=o.next()){var c=i.value;if(n.next(c),n.closed)return}}catch(a){t={error:a}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}n.complete()})}function yn(e){return new Z(function(n){mo(e,n).catch(function(t){return n.error(t)})})}function vo(e){return yn(Sn(e))}function mo(e,n){var t,r,o,i;return zr(this,void 0,void 0,function(){var c,a;return nn(this,function(s){switch(s.label){case 0:s.trys.push([0,5,6,11]),t=Gr(e),s.label=1;case 1:return[4,t.next()];case 2:if(r=s.sent(),!!r.done)return[3,4];if(c=r.value,n.next(c),n.closed)return[2];s.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=s.sent(),o={error:a},[3,11];case 6:return s.trys.push([6,,9,10]),r&&!r.done&&(i=t.return)?[4,i.call(t)]:[3,8];case 7:s.sent(),s.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return n.complete(),[2]}})})}function be(e,n,t,r,o){r===void 0&&(r=0),o===void 0&&(o=!1);var i=n.schedule(function(){t(),o?e.add(this.schedule(null,r)):this.unsubscribe()},r);if(e.add(i),!o)return i}function bn(e,n){return n===void 0&&(n=0),Oe(function(t,r){t.subscribe(Xe(r,function(o){return be(r,e,function(){return r.next(o)},n)},function(){return be(r,e,function(){return r.complete()},n)},function(o){return be(r,e,function(){return r.error(o)},n)}))})}function wn(e,n){return n===void 0&&(n=0),Oe(function(t,r){r.add(e.schedule(function(){return t.subscribe(r)},n))})}function So(e,n){return Le(e).pipe(wn(n),bn(n))}function go(e,n){return Le(e).pipe(wn(n),bn(n))}function yo(e,n){return new Z(function(t){var r=0;return n.schedule(function(){r===e.length?t.complete():(t.next(e[r++]),t.closed||this.schedule())})})}function bo(e,n){return new Z(function(t){var r;return be(t,n,function(){r=e[vn](),be(t,n,function(){var o,i,c;try{o=r.next(),i=o.value,c=o.done}catch(a){t.error(a);return}c?t.complete():t.next(i)},0,!0)}),function(){return F(r==null?void 0:r.return)&&r.return()}})}function Tn(e,n){if(!e)throw new Error("Iterable cannot be null");return new Z(function(t){be(t,n,function(){var r=e[Symbol.asyncIterator]();be(t,n,function(){r.next().then(function(o){o.done?t.complete():t.next(o.value)})},0,!0)})})}function wo(e,n){return Tn(Sn(e),n)}function To(e,n){if(e!=null){if(fn(e))return So(e,n);if(ln(e))return yo(e,n);if(dn(e))return go(e,n);if(pn(e))return Tn(e,n);if(mn(e))return bo(e,n);if(gn(e))return wo(e,n)}throw hn(e)}function ko(e,n){return n?To(e,n):Le(e)}ht(function(e){return function(n){n===void 0&&(n=null),e(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=n}});function Ve(e,n){return Oe(function(t,r){var o=0;t.subscribe(Xe(r,function(i){r.next(e.call(n,i,o++))}))})}function Co(e,n,t,r,o,i,c,a){var s=[],l=0,d=0,T=!1,w=function(){T&&!s.length&&!l&&n.complete()},m=function(f){return l<r?_(f):s.push(f)},_=function(f){l++;var x=!1;Le(t(f,d++)).subscribe(Xe(n,function(h){n.next(h)},function(){x=!0},void 0,function(){if(x)try{l--;for(var h=function(){var k=s.shift();c||_(k)};s.length&&l<r;)h();w()}catch(k){n.error(k)}}))};return e.subscribe(Xe(n,m,function(){T=!0,w()})),function(){}}function kn(e,n,t){return t===void 0&&(t=1/0),F(n)?kn(function(r,o){return Ve(function(i,c){return n(r,i,o,c)})(Le(e(r,o)))},t):(typeof n=="number"&&(t=n),Oe(function(r,o){return Co(r,o,e,t)}))}function _o(e){return kn(sn,e)}function Io(){return _o(1)}function Lt(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return Io()(ko(e,un(e)))}function Ne(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var t=un(e);return Oe(function(r,o){(t?Lt(e,r,t):Lt(e,r)).subscribe(o)})}var Eo="lk";function Cn(e){return typeof e>"u"?!1:Mo(e)||Po(e)}function Mo(e){var n;return e?e.hasOwnProperty("participant")&&e.hasOwnProperty("source")&&e.hasOwnProperty("track")&&typeof((n=e.publication)==null?void 0:n.track)<"u":!1}function Po(e){return e?e.hasOwnProperty("participant")&&e.hasOwnProperty("source")&&e.hasOwnProperty("publication")&&typeof e.publication<"u":!1}function Do(e){return e?e.hasOwnProperty("participant")&&e.hasOwnProperty("source")&&typeof e.publication>"u":!1}function Mi(e){if(typeof e=="string"||typeof e=="number")return"".concat(e);if(Do(e))return"".concat(e.participant.identity,"_").concat(e.source,"_placeholder");if(Cn(e))return"".concat(e.participant.identity,"_").concat(e.publication.source,"_").concat(e.publication.trackSid);throw new Error("Can't generate a id for the given track reference: ".concat(e))}function Pi(e){return e instanceof Nr}var Ao=[b.ConnectionStateChanged,b.RoomMetadataChanged,b.ActiveSpeakersChanged,b.ConnectionQualityChanged,b.ParticipantConnected,b.ParticipantDisconnected,b.ParticipantPermissionsChanged,b.ParticipantMetadataChanged,b.ParticipantNameChanged,b.ParticipantAttributesChanged,b.TrackMuted,b.TrackUnmuted,b.TrackPublished,b.TrackUnpublished,b.TrackStreamStateChanged,b.TrackSubscriptionFailed,b.TrackSubscriptionPermissionChanged,b.TrackSubscriptionStatusChanged],xo=[...Ao,b.LocalTrackPublished,b.LocalTrackUnpublished];A.TrackPublished,A.TrackUnpublished,A.TrackMuted,A.TrackUnmuted,A.TrackStreamStateChanged,A.TrackSubscribed,A.TrackUnsubscribed,A.TrackSubscriptionPermissionChanged,A.TrackSubscriptionFailed,A.LocalTrackPublished,A.LocalTrackUnpublished;var Ro=[A.ConnectionQualityChanged,A.IsSpeakingChanged,A.ParticipantMetadataChanged,A.ParticipantPermissionsChanged,A.TrackMuted,A.TrackUnmuted,A.TrackPublished,A.TrackUnpublished,A.TrackStreamStateChanged,A.TrackSubscriptionFailed,A.TrackSubscriptionPermissionChanged,A.TrackSubscriptionStatusChanged];[...Ro,A.LocalTrackPublished,A.LocalTrackUnpublished];var Ze=jr.getLogger("lk-components-js");Ze.setDefaultLevel("WARN");function _n(e){return typeof e=="object"}function In(e){return Array.isArray(e)&&e.filter(_n).length>0}function Oo(e){return"".concat(Eo,"-").concat(e)}function Di(e){const n=Vt(e),t=En(e.participant).pipe(Ve(()=>Vt(e)),Ne(n));return{className:Oo(e.source===ie.Source.Camera||e.source===ie.Source.ScreenShare?"participant-media-video":"participant-media-audio"),trackObserver:t}}function Vt(e){if(Cn(e))return e.publication;{const{source:n,name:t,participant:r}=e;if(n&&t)return r.getTrackPublications().find(o=>o.source===n&&o.trackName===t);if(t)return r.getTrackPublicationByName(t);if(n)return r.getTrackPublication(n);throw new Error("At least one of source and name needs to be defined")}}function Lo(e,...n){return new Z(t=>{const r=()=>{t.next(e)};return n.forEach(o=>{e.on(o,r)}),()=>{n.forEach(o=>{e.off(o,r)})}}).pipe(Ne(e))}function Vo(e,n){return new Z(t=>{const r=(...o)=>{t.next(o)};return e.on(n,r),()=>{e.off(n,r)}})}function No(e){return Vo(e,b.ConnectionStateChanged).pipe(Ve(([n])=>n),Ne(e.state))}function Uo(e,...n){return new Z(t=>{const r=()=>{t.next(e)};return n.forEach(o=>{e.on(o,r)}),()=>{n.forEach(o=>{e.off(o,r)})}}).pipe(Ne(e))}function En(e){return Uo(e,A.TrackMuted,A.TrackUnmuted,A.ParticipantPermissionsChanged,A.TrackPublished,A.TrackUnpublished,A.LocalTrackPublished,A.LocalTrackUnpublished,A.MediaDevicesError,A.TrackSubscriptionStatusChanged).pipe(Ve(n=>{const{isMicrophoneEnabled:t,isCameraEnabled:r,isScreenShareEnabled:o}=n,i=n.getTrackPublication(ie.Source.Microphone),c=n.getTrackPublication(ie.Source.Camera);return{isCameraEnabled:r,isMicrophoneEnabled:t,isScreenShareEnabled:o,cameraTrack:c,microphoneTrack:i,participant:n}}))}new TextEncoder;new TextDecoder;function Ai(){return{className:"lk-room-container"}}function Nt(e,n,t=!0){const r=[e.localParticipant,...Array.from(e.remoteParticipants.values())],o=[];return r.forEach(i=>{n.forEach(c=>{const a=Array.from(i.trackPublications.values()).filter(s=>s.source===c&&(!t||s.track)).map(s=>({participant:i,publication:s,source:s.source}));o.push(...a)})}),{trackReferences:o,participants:r}}function $o(e,n,t){var r,o;const i=(r=t.additionalRoomEvents)!=null?r:xo,c=(o=t.onlySubscribed)!=null?o:!0,a=Array.from(new Set([b.ParticipantConnected,b.ParticipantDisconnected,b.ConnectionStateChanged,b.LocalTrackPublished,b.LocalTrackUnpublished,b.TrackPublished,b.TrackUnpublished,b.TrackSubscriptionStatusChanged,...i]).values());return Lo(e,...a).pipe(Ve(s=>{const l=Nt(s,n,c);return Ze.debug("TrackReference[] was updated. (length ".concat(l.trackReferences.length,")"),l),l}),Ne(Nt(e,n,c)))}u.createContext(void 0);const Fo=u.createContext(void 0);function Wo(){return u.useContext(Fo)}function xi(e){const n=Wo(),t=e!=null?e:n;if(!t)throw new Error("No TrackRef, make sure you are inside a TrackRefContext or pass the TrackRef explicitly");return t}u.createContext(void 0);const jo=u.createContext(void 0);function Mn(){return u.useContext(jo)}function St(e){const n=Mn(),t=e!=null?e:n;if(!t)throw new Error("No room provided, make sure you are inside a Room context or pass the room explicitly");return t}const Ri=u.createContext(void 0);function zo(e,n,t=!0){const[r,o]=u.useState(n);return u.useEffect(()=>{if(t&&o(n),typeof window>"u"||!e)return;const i=e.subscribe(o);return()=>i.unsubscribe()},[e,t]),r}function qo(e){const n=St(e),t=u.useMemo(()=>No(n),[n]);return zo(t,n.state)}function Oi(e={}){const n=St(e.room),[t,r]=u.useState(n.localParticipant),[o,i]=u.useState(t.isMicrophoneEnabled),[c,a]=u.useState(t.isMicrophoneEnabled),[s,l]=u.useState(t.lastMicrophoneError),[d,T]=u.useState(t.lastCameraError),[w,m]=u.useState(t.isMicrophoneEnabled),[_,f]=u.useState(void 0),[x,h]=u.useState(void 0),k=R=>{a(R.isCameraEnabled),i(R.isMicrophoneEnabled),m(R.isScreenShareEnabled),h(R.cameraTrack),f(R.microphoneTrack),l(R.participant.lastMicrophoneError),T(R.participant.lastCameraError),r(R.participant)};return u.useEffect(()=>{const R=En(n.localParticipant).subscribe(k);return()=>R.unsubscribe()},[n]),{isMicrophoneEnabled:o,isScreenShareEnabled:w,isCameraEnabled:c,microphoneTrack:_,cameraTrack:x,lastMicrophoneError:s,lastCameraError:d,localParticipant:t}}function Go(e=[ie.Source.Camera,ie.Source.Microphone,ie.Source.ScreenShare,ie.Source.ScreenShareAudio,ie.Source.Unknown],n={}){const t=St(n.room),[r,o]=u.useState([]),[i,c]=u.useState([]),a=u.useMemo(()=>e.map(s=>_n(s)?s.source:s),[JSON.stringify(e)]);return u.useEffect(()=>{const s=$o(t,a,{additionalRoomEvents:n.updateOnlyOn,onlySubscribed:n.onlySubscribed}).subscribe(({trackReferences:l,participants:d})=>{Ze.debug("setting track bundles",l,d),o(l),c(d)});return()=>s.unsubscribe()},[t,JSON.stringify(n.onlySubscribed),JSON.stringify(n.updateOnlyOn),JSON.stringify(e)]),u.useMemo(()=>{if(In(e)){const s=Qo(e,i),l=Array.from(r);return i.forEach(d=>{var T;s.has(d.identity)&&((T=s.get(d.identity))!=null?T:[]).forEach(w=>{if(r.find(({participant:_,publication:f})=>d.identity===_.identity&&f.source===w))return;Ze.debug("Add ".concat(w," placeholder for participant ").concat(d.identity,"."));const m={participant:d,source:w};l.push(m)})}),l}else return r},[r,i,e])}function Bo(e,n){const t=new Set(e);for(const r of n)t.delete(r);return t}function Qo(e,n){const t=new Map;if(In(e)){const r=e.filter(o=>o.withPlaceholder).map(o=>o.source);n.forEach(o=>{const i=o.getTrackPublications().map(a=>{var s;return(s=a.track)==null?void 0:s.source}).filter(a=>a!==void 0),c=Array.from(Bo(new Set(r),new Set(i)));c.length>0&&t.set(o.identity,c)})}return t}var Be=(e=>(e.Local="local",e.Remote="remote",e))(Be||{}),Pn=(e=>(e.Audio="audio",e.Video="video",e))(Pn||{}),Ae=(e=>(e.Camera="camera",e.Microphone="microphone",e.ScreenShare="screen_share",e))(Ae||{});const Yo=e=>e.flatMap(n=>{const t=[],r=n.publication.trackName,o=n.participant.identity,i=n.participant.isLocal?"local":"remote";let c;n.publication.source===ie.Source.Camera?c="camera":n.publication.source===ie.Source.ScreenShare?c="screen_share":c="microphone";const a=(s,l)=>{s&&t.push({id:s.mediaStreamTrack.id,source:c,name:r,userName:o,origin:i,media:l,track:s.mediaStreamTrack,isMuted:s.isMuted,isSystemMuted:s.mediaStreamTrack.muted,setMuted:d=>{s.mediaStreamTrack.enabled=!d},onEnded:d=>{s.on("ended",d)},offEnded:d=>{s.off("ended",d)}})};return a(n.publication.audioTrack,"audio"),a(n.publication.videoTrack,"video"),t}),ot=(e,n)=>{var r;const t={id:e.id,source:n.source,name:n.name,userName:n.userName,media:e.kind==="audio"?"audio":"video",origin:n.origin,track:e,get isMuted(){return!e.enabled||e.muted},get isSystemMuted(){return e.muted},setMuted:o=>{var i;e.enabled=!o,(i=n.mutedCb)==null||i.call(n,t.isMuted,t.isSystemMuted)},onEnded:o=>{e.onended=o},offEnded:o=>{e.onended=null}};return e.onmute=()=>{var o;(o=n.mutedCb)==null||o.call(n,t.isMuted,t.isSystemMuted)},e.onunmute=()=>{var o;(o=n.mutedCb)==null||o.call(n,t.isMuted,t.isSystemMuted)},(r=n.mutedCb)==null||r.call(n,t.isMuted,t.isSystemMuted),t};class Ho{constructor(){J(this,"mediaDevicesPromises",[])}getUserMedia(...n){const t=navigator.mediaDevices.getUserMedia(...n);return this.mediaDevicesPromises.push(t),t}getDisplayMedia(...n){const t=navigator.mediaDevices.getDisplayMedia(...n);return this.mediaDevicesPromises.push(t),t}closeAllStreams(){const n=this.mediaDevicesPromises.map(t=>t.then(r=>{r.getTracks().forEach(o=>{o.readyState==="live"&&o.stop()})}));return this.mediaDevicesPromises=[],Promise.all(n)}}const Jo=500,Ko=1e3,Xo=3,Zo=2e3;function Ut({packets:e,packetsLost:n,fractionLost:t,rtt:r}){let o;if(e!==void 0&&n!==void 0?o=n*100/e:t!==void 0&&(o=t*100),o===void 0||r===void 0||isNaN(o))return;const i=r*1e3/2;let c=i/40;i>160&&(c=(i-120)/10);const a=100-c-o;return Math.max(a,0)}function $t(e){if(e===void 0)return te.Unknown;let n;return e<=0?n=1:e>=100?n=4.5:n=1+.035*e+7e-6*e*(e-60)*(100-e),n>4?te.Excellent:n>3.5?te.Good:te.Poor}class _e{constructor(n,t){J(this,"size");J(this,"type");J(this,"buf");this.size=n,this.type=t,this.buf=[]}push(n){n!==void 0&&(this.buf.length===this.size&&this.buf.shift(),this.buf.push(n))}get(){if(this.buf.length!==0)switch(this.type){case"cumulative":{const n=this.buf[0];return(this.buf[this.buf.length-1]-n)/this.buf.length}case"individual":return this.buf.reduce((n,t)=>n+t,0)/this.buf.length}}}class ei{constructor(n,t){J(this,"pc");J(this,"cb");J(this,"reportTimerId");J(this,"pollingTimerId");J(this,"localWindow");J(this,"remoteWindow");J(this,"reportTimestamps");J(this,"stale",!1);const r=Xo;this.pc=n,this.cb=t,this.reportTimerId=void 0,this.localWindow={packetsLost:new _e(r,"cumulative"),fractionLost:new _e(r,"individual"),rtt:new _e(r,"individual")},this.remoteWindow={packetsSent:new _e(r,"cumulative"),packetsLost:new _e(r,"cumulative"),rtt:new _e(r,"individual")},this.reportTimestamps={}}start(){this.reportTimerId||this.pollingTimerId||(this.reportTimerId=window.setInterval(this.report.bind(this),Jo),this.pollingTimerId=window.setInterval(this.poll.bind(this),Ko))}stop(){window.clearInterval(this.reportTimerId),window.clearInterval(this.pollingTimerId),this.reportTimerId=void 0,this.pollingTimerId=void 0}isFresh(n){let t=!0;if(this.reportTimestamps[n.type]!==void 0){const o=Date.now()-this.reportTimestamps[n.type]<Zo;t=n.timestamp!==this.reportTimestamps[n.type]||o}return this.reportTimestamps[n.type]=n.timestamp,t}async poll(){const n=await this.pc.getStats();let t;const r={};let o=!1;n.forEach(c=>{const a=c.kind||c.mediaType;c.type==="transport"&&c.selectedCandidatePairId&&(t=c.selectedCandidatePairId),c.type==="remote-inbound-rtp"&&a==="audio"&&(o||(o=!this.isFresh(c)),this.localWindow.packetsLost.push(c.packetsLost),this.localWindow.fractionLost.push(c.fractionLost)),c.type==="inbound-rtp"&&a==="audio"&&(o||(o=!this.isFresh(c)),this.remoteWindow.packetsSent.push(c.packetsReceived+c.packetsLost),this.remoteWindow.packetsLost.push(c.packetsLost)),c.type==="candidate-pair"&&(r[c.id]=c)}),this.stale=o;const i=t!==void 0&&r[t];i?(this.remoteWindow.rtt.push(i.currentRoundTripTime),this.localWindow.rtt.push(i.currentRoundTripTime)):K.error("QualityMonitor no candidate-pair found!")}report(){if(this.stale)return this.cb({local:te.Unknown,general:te.Unknown});const n=Ut({packets:void 0,packetsLost:this.localWindow.packetsLost.get(),fractionLost:this.localWindow.fractionLost.get(),rtt:this.localWindow.rtt.get()}),t=Ut({packets:this.remoteWindow.packetsSent.get(),packetsLost:this.remoteWindow.packetsLost.get(),fractionLost:void 0,rtt:this.remoteWindow.rtt.get()}),r=[n,t].filter(a=>a!==void 0),o=r.length>0?Math.min(...r):void 0,i=$t(n),c=$t(o);this.cb({local:i,general:c})}}class Qe{static abortPendingNegotiation(n){this._controller&&(this._controller.abort("[abort] ".concat(n)),this._controller=null)}static clearNegotiation(){this._controller=null}static beginNegotiation(){this._controller&&this._controller.abort("[abort] Starting new negotiation");const n=new AbortController;return this._controller=n,n.signal}}J(Qe,"_controller",null);const Ft="User",Wt="Assistant",jt=0,ti=[],gt=u.createContext({room:void 0,getTracks:()=>ti,getConnectionState:()=>null,selectVoiceModeMetadata:()=>{throw new Error("Null implementation - please provide a proper context")},getTokenSetup:()=>{},initVoiceMode:()=>Promise.reject(new Error("Null implementation - please provide a proper context"))}),yt=()=>u.useContext(gt),Li=({children:e})=>{const n=Mn(),t=Go(),r=qo(n),o=ne(),i=u.useCallback(d=>{const T=Yo(t);return d?T.filter(w=>d.includes(w.source)):T},[t]),c=u.useCallback(()=>r,[r]),a=u.useCallback(d=>{const{default_voice_mode:T,modes:w}=d,m=w.find(_=>_.mode===T);if(!m)throw new Error("No voice status mode found for default mode "+T);return m},[]),s=u.useCallback(async(d,T)=>{var m;const w=await Jt.startLivekitSession(d,T.eventSource,T.proofOfWorkAnswer);return w.token&&w.url&&w.e2ee_key?(ut({conversationId:(m=d.conversation_id)!=null?m:T.clientThreadId,voiceSessionId:d.voice_session_id,voiceMode:w.voice_mode_decision.voice_mode,credentials:ge(le({},w),{e2eeKey:w.e2ee_key})},o),{type:"livekit",success:!0}):{type:"livekit",success:!1,error:"get_token failed to return expected fields .token, .url and .e2ee_key",response:w}},[o]),l=u.useMemo(()=>({room:n,getTracks:i,getConnectionState:c,getTokenSetup:()=>{},initVoiceMode:s,selectVoiceModeMetadata:a}),[n,i,c,s,a]);return lt.jsx(gt.Provider,{value:l,children:e})};let it;const ni=()=>(it===void 0&&(it=new TextEncoder),it);function ri(e){switch(e){case"checking":return X.Connecting;case"connected":case"completed":return X.Connected;case"disconnected":return X.Reconnecting;case"new":case"failed":case"closed":return X.Disconnected}}const Vi=({children:e})=>{const n=ne(),t=Ln(Vn()),r=u.useRef(null),o=u.useRef(void 0),i=u.useRef(void 0),c=u.useCallback(async({avmTrack:C,initialSetup:v=!1})=>{const p=C.media===Pn.Audio?o:i;if(p.current&&!p.current.stopped)await p.current.sender.replaceTrack(C.track);else if(v)p.current=ue().addTransceiver(C.track);else throw new Error("Cannot replace track on ".concat(C.media," transceiver that was not initialized."))},[]),[a,s]=u.useState(void 0),[l,d]=u.useState(void 0),[T,w]=u.useState(void 0),m=u.useRef(void 0),_=u.useRef(void 0),f=u.useRef(void 0),x=n(C=>C.voiceMode),[h,k]=u.useState(null),R=u.useCallback(()=>h,[h]),z=u.useCallback(C=>{fe(v=>ze(v,p=>{p&&(p.activeSpeakers.some(S=>S.identity===C)||p.activeSpeakers.push({identity:C}))}))},[]),U=u.useCallback(C=>{fe(v=>ze(v,p=>{p&&(p.activeSpeakers=p.activeSpeakers.filter(S=>S.identity!==C))}))},[]),se=u.useRef(null),W=u.useRef([]),oe=u.useRef([]),Q=u.useRef([]),ee=u.useRef([]),E=u.useRef([]),L=u.useRef(!1),Y=u.useRef([]),g=u.useCallback(C=>{Y.current.forEach(v=>v(C))},[]),M=u.useRef(h);u.useEffect(()=>{M.current=h},[h]);const y=u.useRef(void 0);u.useEffect(()=>{y.current=a},[a]);const I=u.useRef(void 0);u.useEffect(()=>{I.current=T},[T]);const G=u.useRef(new Ho).current,O=u.useRef(void 0),$=u.useRef(void 0),V=u.useRef(void 0),[j,fe]=u.useState(()=>({localParticipant:{isMicrophoneEnabled:!1,setMicrophoneEnabled:function(v){var p;return(p=y.current)==null||p.setMuted(!v),Promise.resolve(void 0)},setCameraEnabled:async function(v,p,S){if(v)try{const P=await we("camera");await c({avmTrack:P}),g(P)}catch(P){throw K.error("[transceiver] Error acquiring camera input",P),P}else await Fe();return Promise.resolve(void 0)},setScreenShareEnabled:async function(v,p,S){if(v)try{const P=await we("screenshare");await c({avmTrack:P}),g(P)}catch(P){throw K.error("[transceiver] Error acquiring screen share input",P),P}else await Fe();return Promise.resolve(void 0)},publishData:async function(v,p){const S=se.current;if(!S||S.readyState!=="open")throw new Error("Data channel is not open");const P=new TextDecoder().decode(v),D=JSON.stringify({type:"data_message",data:P});S.send(D)},on:function(v,p){v===b.ConnectionQualityChanged&&oe.current.push(p)},off:function(v,p){v===b.ConnectionQualityChanged&&(oe.current=oe.current.filter(S=>S!==p))}},getActiveDevice:v=>{switch(v){case"audioinput":return m.current;case"videoinput":return _.current;case"audiooutput":return f.current}},disconnect:async function(v=!0){var p;Qe.abortPendingNegotiation("Disconnecting"),(p=O.current)==null||p.stop(),L.current=!0,v&&G.closeAllStreams(),Se.current&&(Se.current.close(),Se.current=void 0),r.current&&(r.current.srcObject=null),await Fe(),k(X.Disconnected),M.current=X.Disconnected,E.current.forEach(S=>S())},name:"",switchActiveDevice:async(v,p,S)=>{var P;if(M.current!==X.Connected)return K.debug("[transceiver] Attempt to switch device when not connected, current state is",M.current),!1;try{switch(v){case"audioinput":{const D=await $e(p);return await c({avmTrack:D}),g(D),!0}case"videoinput":{const D=await we("camera",p);return await c({avmTrack:D}),g(D),!0}case"audiooutput":return await((P=r.current)==null?void 0:P.setSinkId(p)),f.current=p,!0}}catch(D){return K.error("[transceiver] Failed to switch ".concat(v," device"),D),!1}},on:function(v,p){switch(v){case b.DataReceived:Q.current.push(p);break;case b.Disconnected:E.current.push(p);break;case b.Connected:ee.current.push(p);break;case b.TrackPublished:Y.current.push(p);break;case b.ConnectionQualityChanged:W.current.push(p);break}},off:function(v,p){switch(v){case b.DataReceived:Q.current=Q.current.filter(S=>S!==p);break;case b.Disconnected:E.current=E.current.filter(S=>S!==p);break;case b.Connected:ee.current=ee.current.filter(S=>S!==p);break;case b.TrackPublished:Y.current=Y.current.filter(S=>S!==p);break;case b.ConnectionQualityChanged:W.current=W.current.filter(S=>S!==p);break}},state:X.Disconnected,numParticipants:0,activeSpeakers:[]})),ae=u.useRef(!1),Se=u.useRef(void 0),ue=()=>(Se.current===void 0&&(Se.current=nr.getFreshPeerConnection("voice-mode")),Se.current),Ue=u.useCallback((C,v)=>{fe(p=>ze(p,S=>{S&&(S.localParticipant.isMicrophoneEnabled=!C,S.localParticipant.isMicrophoneForceMuted=v,C?U(Ft):z(Ft))}))},[z,U]),et=u.useCallback(C=>{const v=[a,l,T].filter(p=>p!==void 0);return C?v.filter(p=>C.includes(p.source)):v},[a,l,T]),$e=u.useCallback(async C=>{C||(C=await rr());const p=(await G.getUserMedia({audio:C?{deviceId:{exact:C}}:!0})).getTracks();if(p.length!==1)throw K.error("[transceiver] Only one input is supported for now, detected these tracks",p),new Error("Only one input is supported for now");const[S]=p;m.current=S.getSettings().deviceId,y.current&&y.current.track!==S&&y.current.track.stop();const P=ot(S,{source:Ae.Microphone,name:"user",userName:"User",origin:Be.Local,mutedCb:Ue});return s(P),Ue(P.isMuted,P.isSystemMuted),P},[Ue,G]),we=u.useCallback(async(C,v)=>{const S=(C==="camera"?await G.getUserMedia({video:v?{deviceId:{exact:v}}:!0}):await G.getDisplayMedia()).getTracks();if(S.length!==1)throw K.error("[transceiver] Only one video input is supported for now, detected these tracks",S),new Error("Only one video input is supported for now");const[P]=S;C==="camera"&&(_.current=P.getSettings().deviceId),I.current&&I.current.track!==P&&I.current.track.stop();const D=ot(P,{source:C==="camera"?Ae.Camera:Ae.ScreenShare,name:"user",userName:"User",origin:Be.Local});return w(D),D},[G]),Fe=u.useCallback(async()=>{if(I.current&&(K.debug("[transceiver] Stop and clear video track"),I.current.track.stop(),w(void 0),i.current&&!i.current.stopped)){K.debug("[transceiver] Stop the video transceiver");try{await i.current.sender.replaceTrack(null)}catch(C){K.debug("[transceiver] Failed to stop transceiver on disconnect due to",C)}}},[]),Me=u.useCallback(C=>{const{default_voice_mode:v,modes:p}=C,S=p.find(P=>P.mode===v);if(!S)throw new Error("No voice status mode found for default mode ".concat(v));return S},[]),Te=u.useCallback(async()=>{const C=performance.now(),v=Ce(dr,()=>ue()),p=Ce(ar,()=>ue().createDataChannel("",{negotiated:!0,id:jt}));se.current=p,Ce(fr,()=>{p.onopen=()=>{n.setState(D=>{D.metrics.dataChannelOpenTime||(D.metrics.dataChannelOpenTime=new Date)})},p.onmessage=D=>{const H=JSON.parse(D.data);if(H.type==="data_message"){const pe=ni().encode(H.data);Q.current.forEach(ke=>ke(pe))}},p.onclose=()=>{L.current?L.current=!1:E.current.forEach(D=>D()),U(Wt)},v.oniceconnectionstatechange=()=>{const D=ue().iceConnectionState,H=ri(D);H===X.Connected&&ee.current.forEach(pe=>pe()),k(H),n.setState(pe=>{pe.server.connectionState=H})},v.ontrack=D=>{if(r.current!=null){r.current.srcObject=D.streams[0];const H=D.streams[0].getTracks();if(H.length!==1)throw K.error("[transceiver] Only one remote track is supported for now, detected these tracks",H),new Error("Only one remote track is supported for transceiver");const[pe]=H,ke=ot(pe,{source:Ae.Microphone,name:x==="advanced"?"audio":"shout",userName:"Assistant",origin:Be.Remote});d(ke),g(ke),fe(Pe=>ze(Pe,De=>{De&&(De.numParticipants=2)})),z(Wt)}}}),Ce(pr,()=>{o.current=v.addTransceiver("audio"),i.current&&!i.current.stopped&&(i.current.stop(),v.removeTrack(i.current.sender)),i.current=v.addTransceiver("video",{direction:"sendonly"})});const S=await _t(ur,async()=>{const D=await v.createOffer();return v.setLocalDescription(D),D}),P=performance.now();return or.set({start_time:C,end_time:P}),{offer:S}},[z,g,U,x,n]),ve=u.useCallback(()=>{const C=performance.now(),v=$e();return v.then(()=>{const S=performance.now();ir.set({start_time:C,end_time:S})}),{completeAudioSetup:async()=>{const S=await v,P=performance.now();await c({avmTrack:S,initialSetup:!0});const D=performance.now();return lr.set({start_time:P,end_time:D}),{microphoneTrack:S}}}},[$e,c]),We=u.useCallback(()=>{const C=performance.now(),v=ue();O.current&&O.current.stop(),O.current=new ei(v,S=>{const P=M.current&&[X.Disconnected,X.Reconnecting,X.SignalReconnecting].includes(M.current);W.current.forEach(D=>D(P?te.Lost:S.general)),oe.current.forEach(D=>D(P?te.Lost:S.local))}),O.current.start();const p=performance.now();cr.set({start_time:C,end_time:p})},[]),tt=u.useCallback(()=>{V.current=ve(),$.current=Te()},[Te,ve]),B=u.useCallback(async(C,v,p)=>{const S=performance.now(),P=await _t(vr,()=>p.text()),D=ue();Ce(mr,()=>{D.setRemoteDescription({sdp:P,type:"answer"})}),V.current||(K.error("[transceiver] Audio input setup step not executed for initial TC offer!"),V.current=ve());const{completeAudioSetup:H}=V.current,{microphoneTrack:pe}=await H();g(pe),n.setState(Pe=>{var De;Pe.conversationId=(De=C.conversation_id)!=null?De:v.clientThreadId,Pe.voiceSessionId=C.voice_session_id,Pe.voiceMode=C.voice_mode}),ae.current=!1,k(X.Connected);const ke=performance.now();sr.set({start_time:S,end_time:ke})},[ve,V,g,n]),bt=u.useCallback(async(C,v)=>{var D,H;if(ae.current)throw new Error("Not ready to connect, ".concat(JSON.stringify({isConnecting:ae.current})));ae.current=!0,(D=$.current)!=null||($.current=Te()),(H=V.current)!=null||(V.current=ve());const{offer:p}=await $.current,S=Ce(hr,()=>Qe.beginNegotiation()),P=await Jt.startTransceiverSession({payload:C,accessToken:t,proofOfWorkAnswer:v.proofOfWorkAnswer,eventSource:v.eventSource,signal:S,dataChannelId:jt,offer:p});return Qe.clearNegotiation(),We(),B(C,v,P),{type:"transceiver",success:!0}},[Te,ve,t,We,B]),An=u.useMemo(()=>({room:j,getTracks:et,getConnectionState:R,initVoiceMode:bt,selectVoiceModeMetadata:Me,getTokenSetup:tt}),[j,et,R,bt,Me,tt]);return lt.jsxs(gt.Provider,{value:An,children:[lt.jsx("audio",{ref:r,autoPlay:!0,playsInline:!0}),e]})};function ce(){const{room:e}=yt(),n=u.useRef({debug:(...t)=>{var r;return K.debug("[".concat((r=e==null?void 0:e.name)!=null?r:"no room","]"),...t)},encoder:new TextEncoder,decoder:new TextDecoder}).current;return le({room:e},n)}function oi(){ci(),si(),ai(),ii()}function ii(){const{room:e,debug:n}=ce(),{cameraTrackState:t}=Kt(),o=en().video,i=u.useMemo(()=>{const c=["audioinput","audiooutput"];return o&&c.push("videoinput"),c},[o]);u.useEffect(()=>{function c(){Promise.all(i.map(async a=>{if(t!==re.Started&&a==="videoinput")return;const s=await Ht.getLocalDevices(a),l=e==null?void 0:e.getActiveDevice(a),d=await xe(a);if(!(l===(d==null?void 0:d.deviceId))){let w=null;if(d?w=d.deviceId:s[0]&&(w=s[0].deviceId),w){const m=await Mt(w,s),_=await Mt(l,s);n("Current active ".concat(a,' device "').concat(_,'" doesn\'t match default "').concat(m,'", switching to that instead')),await(e==null?void 0:e.switchActiveDevice(a,w)),N.defaultMediaDeviceChanged.success({kind:a})}}})).catch(a=>{N.defaultMediaDeviceChanged.failure(a)})}if(navigator)return navigator.mediaDevices.addEventListener("devicechange",c),()=>{navigator.mediaDevices.removeEventListener("devicechange",c)}},[e,n,i,t])}function ci(){const{room:e,debug:n}=ce(),t=e==null?void 0:e.getActiveDevice("audioinput"),r=e==null?void 0:e.getActiveDevice("audiooutput");u.useEffect(()=>{async function o(){var l,d;const i=(l=await xe("audioinput"))==null?void 0:l.deviceId,c=(d=await xe("audiooutput"))==null?void 0:d.deviceId,a=async()=>{i&&t!==i&&(n("switching audio input to default"),await(e==null?void 0:e.switchActiveDevice("audioinput",i)))},s=async()=>{if(c&&r!==c){n("switching audio output to default");try{await(e==null?void 0:e.switchActiveDevice("audiooutput",c))}catch(T){n("failed to switch audio output",T)}}};await Promise.all([a(),s()])}o()},[t,r,n,e])}function si(){const{cameraTrackState:e,finalizeCameraState:n}=Kt(),{room:t,debug:r}=ce(),o=ne(),c=en().video,a=c?t==null?void 0:t.getActiveDevice("videoinput"):void 0;u.useEffect(()=>{async function s(){if(t)if(e===re.Starting)try{await t.localParticipant.setCameraEnabled(!0),Ye(t,o,"camera_front","live"),n(re.Started)}catch(l){n(re.Stopped)}else e===re.Stopping&&(await t.localParticipant.setCameraEnabled(!1),Ye(t,o,"camera_front","ended"),n(re.Stopped))}s()},[e,n,t,o]),u.useEffect(()=>{async function s(){var T;const l=(T=await xe("videoinput"))==null?void 0:T.deviceId;await(async()=>{l&&a!==l&&(r("switching video input to default"),await(t==null?void 0:t.switchActiveDevice("videoinput",l)))})()}c&&e===re.Started&&s()},[a,r,t,c,e])}function ai(){const{room:e}=ce(),{screenshareTrackState:n,finalizeScreenshareState:t}=Sr(),r=ne();u.useEffect(()=>{async function o(){if(e)if(n===re.Starting)try{await e.localParticipant.setScreenShareEnabled(!0,{video:{displaySurface:"monitor"}}),Ye(e,r,"screen_share","live"),t(re.Started)}catch(i){t(re.Stopped)}else n===re.Stopping&&(await e.localParticipant.setScreenShareEnabled(!1),Ye(e,r,"screen_share","ended"),t(re.Stopped))}o()},[e,n,t,r])}const ui=async({serverThreadId:e,message:n})=>{const t=await Gt(Nn);if(t)switch(n.type){case"full_chat_message":{const r=Un(n.payload.message);t.handleResponse({type:"message",message:r,conversationId:e});break}case me.ConversationUpdate:{t.handleConversationUpdate(n.payload.conversation_id);break}}};function Dn(){const{debug:e}=ce(),n=ye(r=>r.conversationId),t=qt();return u.useCallback(async r=>{const o=r,i=n&&!pt(n)?n:void 0,c=o!=null?o:i;if(c){e("refetch conversationId ".concat(c));try{await gr(c)}catch(a){const s="Failed to update conversation";e(s,a),t.danger(s,{toastId:"refetch_conversation"})}}},[n,e,t])}var li=(e=>(e.EXCELLENT="excellent",e.GOOD="good",e.POOR="poor",e.LOST="lost",e.UNKNOWN="unknown",e))(li||{});const di={[te.Excellent]:"excellent",[te.Good]:"good",[te.Poor]:"poor",[te.Lost]:"lost",[te.Unknown]:"unknown"},fi=5e3,pi=2e3,hi=500,vi=e=>{var x;const n=ne(),{room:t}=ce(),r=ye(h=>h.disconnectPending),o=ye(h=>h.server.remoteState===q.Speaking),i=(x=ye(h=>h.conversationId))!=null?x:void 0,c=Bt(i),a=u.useRef(!1),s=Dn(),l=Lr(),d=Zt(),T=ye(h=>h.server.connectionState),w=Qt();a.current=o||a.current;const m=u.useCallback(async h=>{clearTimeout(r),n.setState(R=>{R.disconnectPending=void 0}),t==null||t.disconnect(),await s(c),n.setState(yr);const k=c!=null?c:h;k?Xt(l,d,k):i&&w&&!pt(i)&&l("/c/".concat(i)),Gt(()=>{$n()},hi),e!=null&&e.refetchLater&&window.setTimeout(()=>{s(c)},pi),Fn.set(!1)},[r,t,s,c,e==null?void 0:e.refetchLater,l,d,n,i,w]),_=a.current&&!c&&T===X.Connected,f=u.useCallback(()=>{n.setState(h=>{h.disconnectPending=window.setTimeout(m,fi)})},[m,n]);return{disconnectPending:r!==void 0,shouldDelayDisconnect:_,delayDisconnect:f,immediateDisconnect:m}};function zt(e){performance.mark("voice_mode.end");const n=performance.measure("voice_mode","voice_mode.start","voice_mode.end").duration.toFixed(0);N.voiceMode.connect({durationMs:n}),e.metrics.sessionConnectedTime=new Date}function mi(){var z,U,se;const e=Yt(),n=Zt(),t=ne(),{room:r,debug:o,decoder:i}=ce(),{disconnectPending:c,shouldDelayDisconnect:a,delayDisconnect:s,immediateDisconnect:l}=vi(),d=Dn(),T=u.useRef(!1),w=u.useRef(!1),m=u.useRef(!1),{session:_}=Wn(e),f=Qt(),x=(z=ye(W=>W.conversationId))!=null?z:void 0,h=Bt(x),k=jn(W=>W.lastVoiceSessionStartTime),R=zn()==="livekit";u.useEffect(()=>{const W=async M=>{const{new_state:y}=M;if(t.setState(I=>{(I.voiceMode!=="advanced"||y!==q.Thinking)&&(I.server.remoteState=y)}),y===q.Listening&&!T.current&&k instanceof Date){const G=new Date().getTime()-k.getTime();N.firstListeningLatency.success({durationMs:G}),T.current=!0}if(y===q.ListeningIntently)N.voiceSessionListeningIntently.stateChange();else if(y===q.Listening){if(t.setState(I=>{I.metrics.numListening+=1}),!w.current){const I=t.getState().voiceSessionId;N.voiceSessionFirstListening.stateChange({voice_session_id:I!=null?I:"unknown"}),w.current=!0}w.current=!0,N.voiceSessionListening.stateChange()}else if(y===q.Thinking)t.setState(I=>{I.metrics.numThinking+=1}),N.voiceSessionThinking.stateChange();else if(y===q.Speaking){if(t.setState(I=>{I.metrics.numSpeaking+=1}),!m.current){const I=t.getState().voiceSessionId;N.voiceSessionFirstSpeaking.stateChange({voice_session_id:I!=null?I:"unknown"}),m.current=!0}N.voiceSessionSpeaking.stateChange()}else y===q.Halted&&N.voiceSessionHalted.stateChange()},oe=async M=>{t.setState(y=>{y.server.usage=M})},Q=async M=>{if(t.setState(y=>{y.server.toolUpdate=le({},M)}),M.update_type==="hangup")a?s():l();else if(M.update_type==="mute"){const y=t.getState().dev.room,I=y==null?void 0:y.localParticipant;if(!y||!I){o("mute update received without active room/local participant");return}if(!I.isMicrophoneEnabled)return;try{await I.setMicrophoneEnabled(!1),Tr(y,t,"microphone","muted"),N.toggleMuteButton.click({toggleTo:"mute",source:"tool"})}catch(G){o("mute update failed to mute microphone",G),N.toggleMuteButton.error(G,{toggleTo:"mute",source:"tool"})}}},ee=async M=>{var I,G;let y;try{y=JSON.parse(i.decode(M)),o("data received",y)}catch(O){o("error parsing data",O);return}switch(t.setState(O=>(O.server.messages.push(ge(le({},y),{timestamp:new Date,source:"remote"})),O)),y.type){case me.StateUpdate:{o("state update",y.payload);const{new_state:O,delay_s:$}=y.payload,V=!!t.getState().metrics.sessionConnectedTime;[q.Thinking,q.Speaking].includes(O)&&t.getState().server.turnContext.clear(),O===q.Listening&&!V&&t.setState(j=>{zt(j)}),O===q.Thinking&&$&&(o("".concat(r==null?void 0:r.name," delay thinking state by ").concat($," seconds")),W({new_state:q.ListeningIntently}),await new Promise(j=>setTimeout(j,$*1e3))),W(y.payload);break}case me.ConversationUpdate:{o("conversation update",y.payload);const O=t.getState().conversationId,{conversation_id:$}=y.payload;if(O&&pt(O)){if(t.setState(fe=>{fe.conversationId=$}),f)break;qn.initThread({clientThreadId:O,conversationMode:{kind:st.PrimaryAssistant},userId:(I=_==null?void 0:_.user)==null?void 0:I.id,accountId:(G=_==null?void 0:_.account)==null?void 0:G.id});const V=t.getState().conversationId;V!=null&&Gn(e,V,$),Xt(br,n,$);const j=Bn.getGizmoId(Qn(O));Yn(n,j)}f||await d($),c&&l($);break}case me.UsageUpdate:oe(y.payload);break;case me.ToolUpdate:Q(y.payload);break;case me.Performance:{const O=y.payload.metrics;t.setState($=>{O.forEach(V=>{V.name==="total_latency_ms"?$.metrics.totalLatencyMs.push(V.ms):V.name==="current_rtt_ms"&&$.metrics.currentRttMs.push(V.ms)})});break}case me.StartupTelemetry:{const[O]=y.payload.metrics,$=y.payload.success;o("conversation loaded (startup telemetry)"),t.setState(V=>{var j;$?(V.server.relayReady=!0,V.metrics.conversationStartSuccessTime=new Date):V.metrics.conversationStartFailTime=new Date,V.metrics.conversationLatency=(j=O==null?void 0:O.ms)!=null?j:-1});break}}ui({serverThreadId:h,message:y})},E=(M,y)=>{o("track published",M,y)},L=()=>{o("disconnected"),t.setState(M=>{M.metrics.sessionEndTime=new Date}),wr(t),N.voiceSessionDisconnected.stateChange()},Y=(M,y)=>{o("Connection quality changed for participant ".concat(y==null?void 0:y.identity,": ").concat(M)),t.setState(I=>{I.server.voiceConnectionQuality=di[M]})},g=()=>{t.setState(M=>{o("WebRTC connection established"),M.metrics.livekitConnectSuccessTime||(M.metrics.livekitConnectSuccessTime=new Date),R&&!M.metrics.sessionConnectedTime&&zt(M),M.hasConnectedOnce=!0})};return r==null||r.on(b.Connected,g),r==null||r.on(b.DataReceived,ee),r==null||r.on(b.TrackPublished,E),r==null||r.on(b.ConnectionQualityChanged,Y),r==null||r.on(b.Disconnected,L),()=>{r==null||r.off(b.Connected,g),r==null||r.off(b.DataReceived,ee),r==null||r.off(b.TrackPublished,E),r==null||r.off(b.ConnectionQualityChanged,Y),r==null||r.off(b.Disconnected,L)}},[e,o,i,s,c,l,k,n,d,r,(U=_==null?void 0:_.account)==null?void 0:U.id,(se=_==null?void 0:_.user)==null?void 0:se.id,a,t,R,h,f])}function Si(){gi(),yi(),bi(),wi(),Ti()}function gi(){const{room:e}=ce(),n=ne();u.useEffect(()=>{n.setState(t=>{t.dev.room=e})},[e,n])}function yi(){const{getConnectionState:e}=yt(),n=e(),t=ne();u.useEffect(()=>{t.setState(r=>{r.server.connectionState=n})},[n,t])}function bi(){const{room:e,debug:n,encoder:t}=ce(),r=ne();u.useEffect(()=>{const o=!!r.getState().server.actions;if(e&&!o){const i=async c=>{n("publishing action",c);const a={type:me.ActionRequest,payload:{action:c}};await e.localParticipant.publishData(t.encode(JSON.stringify(a)),{reliable:!0}),r.setState(s=>{s.server.messages.push(ge(le({},a),{timestamp:new Date,source:"local"}))})};r.setState(c=>{c.server.actions={[de.StartListeningIntently]:()=>i(de.StartListeningIntently),[de.StopListeningIntently]:()=>i(de.StopListeningIntently),[de.HaltAllActivity]:()=>i(de.HaltAllActivity),[de.ResumeListening]:()=>i(de.ResumeListening),[de.RelayMessage]:()=>i(de.RelayMessage)}})}},[e,n,t,r])}function wi(){const n=ne()(r=>r.isVoiceModeActive);u.useEffect(()=>(at({isVoiceActive:n}),()=>{at({isVoiceActive:!1})}),[n]);const t=Yt();u.useEffect(()=>{if(n)return Hn(t).limitActionGroups([])},[t,n])}function Ti(){const e=ne(),{room:n,encoder:t}=ce(),r=u.useCallback(async o=>{await(n==null?void 0:n.localParticipant.publishData(t.encode(JSON.stringify(o)),{reliable:!0})),e.setState(i=>{i.server.messages.push(ge(le({},o),{timestamp:new Date,source:"local"}))})},[n,t,e]);u.useEffect(()=>{e.setState(o=>{o.server.turnContext.setPublisher(r)})},[r,e])}const Ni=u.memo(function(){return mi(),Si(),oi(),null});function ct(e){return[...e].sort().join(", ")}function Ui(e){return le({conversation_id:e.serverThreadId,parent_message_id:e.parentMessageId,voice_mode:e.isAdvancedMode?"advanced":"standard",eventSource:e.eventSource,clientThreadId:e.clientThreadId,gizmo_id:e.gizmoId,voice:e.voice},e.skipCacheReason?{useVoiceStatusCache:!1,skipCacheReason:e.skipCacheReason}:{useVoiceStatusCache:!0})}function $i({requestMicPermissions:e}={requestMicPermissions:!1}){const n=Vr(),t=ne(),r=Ur(),{voiceName:o,voiceMainLanguage:i}=kr(),c=ye(k=>k.isVoiceModeActive),a=Cr(),{room:s}=ce(),{initVoiceMode:l,selectVoiceModeMetadata:d,getTokenSetup:T}=yt(),w=_r(),m=Ir(),_=Jn(),f=n.formatMessage({id:"useVoiceModeButtonAction.error",defaultMessage:"Failed to start voice mode"}),x=u.useCallback(async()=>{a&&(await(s==null?void 0:s.disconnect()),ut(null,t),t.setState(k=>{k.server.remoteState=q.Halted}))},[a,s,t]);return{startVoiceMode:u.useCallback(async k=>{var se,W,oe,Q,E,L,Y;Kn(),Xn.setItem(Zn.VoiceLastUsed,new Date().toUTCString());let R="unset-".concat(Er());Ct.set(R),(a||k.forceDisconnect)&&(await(s==null?void 0:s.disconnect()),ut(null,t)),e&&await m();const z=await xe("audioinput");T(),t.setState(g=>{g.audioInputDevice=z,g.isVoiceModeActive=!0,g.voiceMode=k.voice_mode,g.server.remoteState=q.Connecting,g.metrics.sessionCreateTime=new Date,g.metrics.totalLatencyMs=[],g.metrics.currentRttMs=[],g.metrics.numSpeaking=0,g.metrics.numThinking=0,g.metrics.numListening=0,g.metrics.getStatusSentTime=void 0,g.metrics.getStatusSuccessTime=void 0,g.metrics.getStatusFailedTime=void 0,g.metrics.proofOfWorkStartTime=void 0,g.metrics.proofOfWorkEndTime=void 0,g.metrics.getTokenSentTime=void 0,g.metrics.getTokenSuccessTime=void 0,g.metrics.getTokenFailedTime=void 0,g.metrics.livekitConnectTime=void 0,g.metrics.livekitConnectSuccessTime=void 0,g.metrics.livekitConnectFailTime=void 0,g.metrics.conversationStartSuccessTime=void 0,g.metrics.conversationStartFailTime=void 0,g.metrics.sessionConnectedTime=void 0});const U=performance.now();try{N.livekit.connectCalled(),t.setState(B=>{B.metrics.getStatusSentTime=new Date});const g=Mr(),M=ct(It()),y=ct(Pr()),I=ct(Dr()),G=M.length>0,O=y.length>0;!k.useVoiceStatusCache?(N.voiceStatusCache.skipped({reason:k.skipCacheReason}),Et.set(k.skipCacheReason)):(Et.set(void 0),O?N.voiceStatusCache.ineligible({reason:y}):G?N.voiceStatusCache.failed({reason:M}):g?N.voiceStatusCache.hit({allowlisted:I||!1}):It.set(["unexpected-empty-cache"]));const V=g==null?void 0:g.proofOfWorkPromise,j=k.useVoiceStatusCache&&g?g:await w({conversation_id:(se=k.conversation_id)!=null?se:null,requested_voice_mode:(W=k.voice_mode)!=null?W:null,gizmo_id:(oe=k.gizmo_id)!=null?oe:null,voice:k.voice,requested_default_model:(Q=k.requested_default_model)!=null?Q:null},k.eventSource);R=j.voice_session_id,Ct.set(j.voice_session_id),t.setState(B=>{B.metrics.getStatusSuccessTime=new Date,B.metrics.proofOfWorkStartTime=new Date});const{default_voice_mode:fe,chatreq:ae}=j;performance.mark("livekit.start"),performance.mark("voice_mode.start");const ee=k,{eventSource:Se,voice:ue,clientThreadId:Ue,voice_mode:et,gizmo_id:$e}=ee,we=kt(ee,["eventSource","voice","clientThreadId","voice_mode","gizmo_id"]),Me=d(j).default_model_slug,Te=fe==="advanced"?Me:void 0,ve=k.useVoiceStatusCache&&V?await V:ae?await Ar.getEnforcementToken(ae):null,We=k.gizmo_id?{kind:st.GizmoInteraction,gizmo_id:k.gizmo_id}:{kind:st.PrimaryAssistant};t.setState(B=>{B.metrics.proofOfWorkEndTime=new Date,B.voiceStatus=j,B.metrics.getTokenSentTime=new Date}),xr(we),(await l(ge(le({},we),{voice:ue!=null?ue:o,language_code:i,voice_session_id:R,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,voice_mode:fe,model_slug:Me,model_slug_advanced:Te,chatreq_token:ae==null?void 0:ae.token,history_and_training_disabled:_,conversation_mode:We}),{eventSource:k.eventSource,clientThreadId:k.clientThreadId,proofOfWorkAnswer:ve})).success&&(t.setState(B=>{B.metrics.getTokenSuccessTime=new Date,B.metrics.livekitConnectTime=new Date}),at({lastVoiceSessionStartTime:new Date}),t.setState(B=>{B.server.remoteState=q.Listening}),performance.mark("livekit.end"),N.livekit.success({durationMs:performance.measure("livekit","livekit.start","livekit.end").duration.toFixed(0),voice_session_id:R}),N.connectionLatency.success({durationMs:performance.now()-U}))}catch(g){const M=Rr(g);t.setState(I=>{M||(I.metrics.getStatusSuccessTime||(I.metrics.getStatusFailedTime=new Date),I.metrics.getTokenSuccessTime||(I.metrics.getTokenFailedTime=new Date))});const y=Or(t.getState());throw N.livekit.failure(g,ge(le({},y),{voice_session_id:R,eventSource:k.eventSource,voice:(E=k.voice)!=null?E:"(undefined)",requested_voice_mode:(L=k.voice_mode)!=null?L:"(undefined)",gizmo_id:(Y=k.gizmo_id)!=null?Y:"(undefined)",user_aborted:M})),K.debug("failed to get voice token",g),t.setState(I=>{I.server.remoteState=q.Halted}),N.connectionLatency.failure(g,{durationMs:performance.now()-U,voice_session_id:R,user_aborted:M}),r.danger(f,{toastId:"start_voice_mode_failure"}),g}},[m,f,w,a,_,e,s,r,i,o,t,l,d,T]),stopVoiceMode:x,isConnected:a,isVoiceModeActive:c}}export{jo as $,Ae as A,Ri as C,Cn as F,xi as I,Li as L,Mi as N,Pi as O,Vt as R,$r as S,Vi as T,Ni as V,Go as W,Di as Y,Ze as _,Ur as a,vi as b,li as c,en as d,Oi as e,yt as f,Ui as g,Be as h,ce as i,$i as u,Ai as y};
//# sourceMappingURL=kmfcnx25ea49kkwd.js.map

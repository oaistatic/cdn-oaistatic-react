import{u as I,r as o,b as K,g as R,j as c,ak as L,s as O,ad as B,G as U}from"./jj85rqzpbnvv3emr.js";import{k2 as N,f as H,qd as Q,fl as z}from"./lef5ym39glv4981l.js";import{W as G}from"./dzxl2udm7ibdp6jw.js";import{q as $,s as J,m as V,W as X,l as Y,n as Z,o as D,t as ee}from"./ef92qx749w9klz4o.js";import{lP as re,kt as S,ku as A}from"./mclphevd122040jw.js";import{u as te}from"./nk7ydxm8ptxusvbt.js";import{a as oe,g as ne,T as se,W as ae,b as ue}from"./kf5isiqcpnpe4fhv.js";import{b as ie}from"./k6xevgslgqxumalm.js";import{u as me}from"./chkdmiqd2p7k2syq.js";import"./cncd8uuk5eicbkeu.js";import"./dta5t6ifyam55mk9.js";import"./jt0fc5oel309hgy2.js";import"./l45tzjfw41ny1oxj.js";import"./2dhqllc5pireni9q.js";import"./jza9spsuu2f7ynxb.js";import"./ht7of10t76s6p5h9.js";import"./efsl2tpd3w39q64v.js";import"./kxedrjbxv2qblujd.js";import"./k059n59kmbyb9lsl.js";import"./ojb4d4bxj44fs0l8.js";import"./oz589d7sqtxcbljf.js";import"./lbaueofbjv8jfqwm.js";import"./nel1ztt16rssielp.js";import"./kir2grr1yju5p5db.js";import"./kkl7694f44ns8yp6.js";import"./i40tl4cuke87hmzs.js";import"./bx2wdn43543b9ysc.js";import"./n5wrqpcxv1sjah44.js";import"./h0u5robawxnqftug.js";import"./hcsjwjl2ji65i21r.js";import"./ogcl7v93rii15rrg.js";import"./beyyb659nwss2eea.js";import"./d9xs85pwcfjntwwg.js";import"./lptwpbjabrvjmhsj.js";import"./d488vdccsjfd5637.js";import"./lj9gcg948eq0zvwr.js";import"./fzrn137102spawew.js";import"./c631j8z7keqfibnl.js";import"./f3wj76d1ulqyss85.js";import"./hzcock7l6ec8fnr2.js";import"./fue7kd61xxcv74sk.js";function ce(r){var M,_,W,T,h,w,P;const u=I(),i=N(),m=ie(),{data:e,error:l}=$(r,{refetchOnWindowFocus:!0,refetchOnMount:!0}),{isLoading:d}=J(r),n=V(o.useCallback(({getTurnsForTask:s})=>{var a;return(a=s(r))!=null?a:[]},[r])),{focusedAssistantTurn:t,setFocusedAssistantTurnId:F}=oe({taskId:r,task:e==null?void 0:e.task,currentUserTurn:(M=e==null?void 0:e.current_user_turn)!=null?M:null,currentAssistantTurn:(_=e==null?void 0:e.current_assistant_turn)!=null?_:null}),k=o.useMemo(()=>{var s,a;return ne({focusedAssistantTurn:t,pastTurns:n,currentDiffTaskTurnId:(a=(s=e==null?void 0:e.current_diff_task_turn)==null?void 0:s.id)!=null?a:null})},[t,(W=e==null?void 0:e.current_diff_task_turn)==null?void 0:W.id,n]),p=(T=e==null?void 0:e.task)==null?void 0:T.current_turn_id,C=!!(e!=null&&e.task.has_unread_turn)&&p===((h=e==null?void 0:e.current_assistant_turn)==null?void 0:h.id),g=((w=e==null?void 0:e.current_assistant_turn)==null?void 0:w.turn_status)==="completed";o.useEffect(()=>{var f;if(!i)return;const s=(f=e==null?void 0:e.task)==null?void 0:f.title;if(!s)return;const a=document.title;return document.title=s,()=>{document.title=a}},[i,(P=e==null?void 0:e.task)==null?void 0:P.title]),o.useEffect(()=>{!C||!g||X.markTurnAsRead(r).then(()=>{u.invalidateQueries({queryKey:["wham","tasks"]}),u.invalidateQueries({queryKey:["wham","task",r]})})},[C,g,r,u]);const y=o.useMemo(()=>{var v,x,j,b;const s=t?Y(t.turn_status):!1,a=((j=t==null?void 0:t.sibling_turn_ids)==null?void 0:j.includes((x=(v=e==null?void 0:e.current_assistant_turn)==null?void 0:v.id)!=null?x:""))||(t==null?void 0:t.id)===((b=e==null?void 0:e.current_assistant_turn)==null?void 0:b.id),f=!(e!=null&&e.current_diff_task_turn);return s&&(a||f)},[t,e==null?void 0:e.current_assistant_turn,e==null?void 0:e.current_diff_task_turn]);return{taskDetails:e,taskDetailsError:l,loadingTurnMapping:d,turns:n,focusedAssistantTurn:t,setFocusedAssistantTurnId:F,currentDiffTaskTurn:k,canFollowUp:y,isCommentFocused:m}}function de(){const[r,u]=o.useState([]),[i,m]=o.useState(!1),e=o.useCallback(()=>{u([])},[]),l=o.useCallback(({onClose:d,isComposerEmpty:n})=>({force:t=!1}={})=>{if(t||r.length===0&&n){e(),d();return}m(!0)},[r.length,e]);return{comments:r,setComments:u,confirmClose:i,setConfirmClose:m,clearComments:e,createCloseHandler:l}}function le({taskId:r,onClose:u}){var b,E;const i=H(),m=K(),e=R(),{composerController:l,isComposerEmpty:d}=me(),{taskDetails:n,taskDetailsError:t,loadingTurnMapping:F,turns:k,focusedAssistantTurn:p,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g,canFollowUp:y,isCommentFocused:M}=ce(r),_=o.useMemo(()=>Z(p),[p]),W=o.useMemo(()=>({taskId:r,task:n==null?void 0:n.task,pastTurns:k,canFollowUp:y,focusedAssistantTurn:p,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g}),[r,n,k,y,p,C,g]),{comments:T,setComments:h,confirmClose:w,setConfirmClose:P,clearComments:s,createCloseHandler:a}=de(),f=o.useMemo(()=>({comments:T,setComments:h,clearComments:s,readonlyComments:_}),[T,h,s,_]),v=re.useCurrentImage()!=null,x=a({onClose:u,isComposerEmpty:d});te(),D([{key:"newTask",action:()=>{e("/codex",{state:{focusComposer:!0}})},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.newTask",defaultMessage:"New task"}),group:A.Chat,keyboardBinding:[S.Mod,S.Shift,"o"]},{key:"closeTask",action:()=>{e("/codex")},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.closeTask",defaultMessage:"Close task"}),group:A.Chat,keyboardBinding:[S.Escape],enabled:!v&&!M}]);const j=o.useCallback(({force:q=!1}={})=>{x({force:q})},[x]);return t?(i.danger({id:"wham.task-details.error",defaultMessage:"Error loading task",description:"Error message for failed to load task details"},{id:"wham-task-details-error-".concat(r),hasCloseButton:!0,duration:3,toastId:"wham_task_page_content_error"}),c.jsx(L,{to:"/codex"})):c.jsx(Q.Provider,{value:l,children:c.jsx(se,{value:f,children:c.jsx(ae,{value:W,children:c.jsx(ue,{permissions:"write",turnId:(E=(b=n==null?void 0:n.current_assistant_turn)==null?void 0:b.id)!=null?E:"",confirmClose:w,setConfirmClose:P,handleClose:j,loadingTurnMapping:F})})})})}function pe(){var d;const r=R(),u=O(),{taskId:i}=B();ee();const m=(d=u.state)!=null?d:{},{backgroundLocation:e}=m,l=o.useCallback(()=>{r(e?-1:"/codex")},[e,r]);return i?c.jsx(z,{children:c.jsx(G,{children:c.jsx(le,{taskId:i,onClose:l})})}):null}const rr=()=>[{title:"Codex"}],tr=U(function(){return c.jsx(pe,{})});export{tr as default,rr as meta};
//# sourceMappingURL=hqhpqyxb22gp1466.js.map

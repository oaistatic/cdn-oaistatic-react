var z=Object.defineProperty,F=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var C=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var T=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e);var P=(e,t,r)=>t in e?z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,$=(e,t)=>{for(var r in t||(t={}))H.call(t,r)&&P(e,r,t[r]);if(C)for(var r of C(t))L.call(t,r)&&P(e,r,t[r]);return e},j=(e,t)=>F(e,G(t));var w=function(e,t){this[0]=e,this[1]=t},O=(e,t,r)=>{var a=(m,s,i,l)=>{try{var S=r[m](s),f=(s=S.value)instanceof w,c=S.done;Promise.resolve(f?s[0]:s).then(n=>f?a(m==="return"?m:"next",s[1]?{done:n.done,value:n.value}:n,i,l):i({value:n,done:c})).catch(n=>a("throw",n,i,l))}catch(n){l(n)}},o=m=>u[m]=s=>new Promise((i,l)=>a(m,s,i,l)),u={};return r=r.apply(e,t),u[T("asyncIterator")]=()=>u,o("next"),o("throw"),o("return"),u};var v=(e,t,r)=>(t=e[T("asyncIterator")])?t.call(e):(e=e[T("iterator")](),t={},r=(a,o)=>(o=e[a])&&(t[a]=u=>new Promise((m,s,i)=>(u=o.call(e,u),i=u.done,Promise.resolve(u.value).then(l=>m({value:l,done:i}),s)))),r("next"),r("return"),t);import{l as q,j as W}from"./ef92qx749w9klz4o.js";import{aj as X,ak as Y,be as x,cK as B,w as J}from"./lef5ym39glv4981l.js";import{hO as Q,hP as N}from"./mclphevd122040jw.js";import{r as E,u as V,b as Z}from"./jj85rqzpbnvv3emr.js";function I(e){const t=E.useMemo(()=>e.join("\0"),[e]);return E.useMemo(()=>e,[t])}const ee=["task_turn_event","work_log_message","log","task_title_generated"];function me(e,t,r){"use no forget";const a=Z(),[o,u]=E.useState(r?a.formatMessage({id:"wham.useStreamTurn.preparingTask",defaultMessage:"Working on your task"}):""),[m,s]=E.useState(o);E.useEffect(()=>{const l=x(()=>s(o),200);return l(),l.cancel},[o]);const i=E.useMemo(()=>"last-event-".concat(e,"-").concat(r!=null?r:"","-").concat(Math.random().toString(36).slice(2)),[e,r]);return te(e,r,["task_turn_event"],{enabled:!!r&&!q(t),subscriberId:i,onEvent:l=>u(l.task_turn_event.text)}),m}function te(e,t,r,{enabled:a=!0,subscriberId:o,onEvent:u,onComplete:m}){"use no forget";const s=Q(u),i=Q(m),l=I(r),S=V(),f=E.useCallback(n=>{s.current(n)},[s]),c=E.useCallback(()=>{var n;(n=i.current)==null||n.call(i)},[i]);E.useEffect(()=>{if(!(!t||!a))return U.retainTurnStream(S,e,t,o,l,f,c),()=>{U.releaseTurnStream(e,t,o)}},[e,t,o,l,a,S,f,c])}function re(o){return O(this,arguments,function*({taskId:e,turnId:t,abortSignal:r,types:a}){let m="".concat(window.location.origin+"/backend-api","/wham/tasks/").concat(e,"/turns/").concat(t,"/stream");if(a.length>0){const c=a.map(n=>"item_type=".concat(encodeURIComponent(n))).join("&");m+="?".concat(c)}const s=N(m,{method:"GET",signal:r,headers:j($({},B({isAuthOptional:!1})),{"Content-Type":"text/event-stream"}),observer:{onClose:(c,n)=>{if(n&&!k(n))throw n}}});try{try{for(var i=v(s),l,S,f;l=!(S=yield new w(i.next())).done;l=!1){const c=S.value;const n=ne(c);n&&(!a||a.includes(n.item_type)?yield n:J.warn("Unknown event type",{event:c}))}}catch(S){f=[S]}finally{try{l&&(S=i.return)&&(yield new w(S.call(i)))}finally{if(f)throw f[0]}}}catch(c){if(k(c))return;throw c}})}function ne(e){return!("data"in e)||!e.data||e.event==="heartbeat"?null:e.data}function k(e){return!!e&&typeof e=="object"&&e.name==="AbortError"}const D=X(Y(()=>({turnStreams:{}}))),A=D.getState,g=D.setState;function R(e,t){return"".concat(e,":").concat(t)}const K=20;function se(e,t,r,a){var u,m;let o;return g(s=>{const i=s.turnStreams[t];if(!i)return;if(i.initPromise){o=i.initPromise;return}const{abortController:l}=i,f=(async()=>{var M;let c=0;const n=b=>{const y=[];g(p=>{const d=p.turnStreams[t];d&&(d.seenEventIds.has(b.id)||(d.seenEventIds.add(b.id),d.emittedEvents.push(b),Object.values(d.subscribers).forEach(h=>{if(!h.types.includes(b.item_type))return;const _=h.lastTimestamps[b.item_type];_&&b.timestamp<=_||(h.lastTimestamps[b.item_type]=b.timestamp,y.push(h.onEvent))})))}),y.forEach(p=>p(b))};for(;!l.signal.aborted&&c<K;){try{const h=re({taskId:r,turnId:a,abortSignal:l.signal,types:ee});try{for(var Se=v(h),he,pe,Ee;he=!(pe=await Se.next()).done;he=!1){const _=pe.value;if(l.signal.aborted)break;n(_)}}catch(pe){Ee=[pe]}finally{try{he&&(pe=Se.return)&&await pe.call(Se)}finally{if(Ee)throw Ee[0]}}}catch(h){if(k(h)||l.signal.aborted)break}const b=W(r,a),y=await e.fetchQuery(b),p=q(y.turn.turn_status);if(p&&await Promise.all([e.refetchQueries({queryKey:["wham","task",r]}),e.invalidateQueries({queryKey:["wham","tasks"]})]),c+=1,c>=K||l.signal.aborted||p)break;const d=Math.min(16e3,1e3*2**c)+Math.random()*500;await new Promise(h=>setTimeout(h,d))}if(!l.signal.aborted){const b=(M=A().turnStreams[t])==null?void 0:M.subscribers;Object.values(b!=null?b:{}).forEach(y=>{var p;(p=y.onComplete)==null||p.call(y)})}})().finally(()=>{g(c=>{const n=c.turnStreams[t];n&&n.initPromise===f&&(n.initPromise=null,Object.keys(n.subscribers).length||delete c.turnStreams[t])})});i.initPromise=f,o=f}),(m=o!=null?o:(u=A().turnStreams[t])==null?void 0:u.initPromise)!=null?m:Promise.resolve()}const U={async retainTurnStream(e,t,r,a,o,u,m){const s=R(t,r);let i=!1;g(S=>{let f=S.turnStreams[s];f?f.initPromise||(i=!0,f.abortController=new AbortController):(i=!0,f={subscribers:{},abortController:new AbortController,initPromise:null,emittedEvents:[],seenEventIds:new Set},S.turnStreams[s]=f);const c=f.subscribers[a];c?(c.types=Array.from(o),c.onEvent=u,c.onComplete=m):f.subscribers[a]={subscriberId:a,types:Array.from(o),onEvent:u,onComplete:m,lastTimestamps:{}}});const l=A().turnStreams[s].emittedEvents;for(const S of l)o.includes(S.item_type)&&u(S);i&&await se(e,s,t,r)},releaseTurnStream(e,t,r){const a=R(e,t);let o=!1,u;g(m=>{const s=m.turnStreams[a];!s||!s.subscribers[r]||(delete s.subscribers[r],Object.keys(s.subscribers).length||(o=!0,u=s.abortController,delete m.turnStreams[a]))}),o&&u&&u.abort()}};function le(e,t){return!e||e.length<=t?e:e.slice(0,t/2)+"â€¦"+e.slice(-t/2)}export{te as a,k as i,le as m,me as u};
//# sourceMappingURL=oz589d7sqtxcbljf.js.map

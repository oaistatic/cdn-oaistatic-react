const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/dpaj0n43y3yxbl8z.js","assets/jj85rqzpbnvv3emr.js","assets/mclphevd122040jw.js","assets/lef5ym39glv4981l.js","assets/root-ogjlcpyy.css","assets/conversation-small-g7l5datj.css","assets/fr4ckts5oz9jhhs0.js","assets/cdk0cmbgnafohb1q.js","assets/gyvvad7btmtz1x9o.js","assets/n6vmm5pyahusdy8e.js","assets/l041el2tch1t3nkf.js","assets/dta5t6ifyam55mk9.js","assets/easgat082167v0i8.js","assets/cncd8uuk5eicbkeu.js"])))=>i.map(i=>d[i]);
var Ie=Object.freeze,We=Object.defineProperty;var pe=(e,t)=>Ie(We(e,"raw",{value:Ie(t||e.slice())}));import{e as W,B as Ke,H as Ve,z as Qe,af as Je,p as ve,kR as _e,sF as Ye,mk as be,ji as Xe,kS as je,i as Ge,aE as Le,a9 as Ze,q as Ee,F as Pe,_ as et,a6 as Ae,ik as tt,im as nt,io as at,k as st,ax as oe,cj as it,P as ot,bI as re,bJ as De,R as rt,bM as lt,bQ as ct,fW as ut,nj as dt,gi as mt,bi as gt,ex as ft,ey as ht}from"./lef5ym39glv4981l.js";import{j as n,m as X,b as Z,g as xt,r,A as wt,u as Ue,i as St,c as It}from"./jj85rqzpbnvv3emr.js";import{I as se,D as Te,u as pt}from"./fkmcro1vpivj0aq3.js";import{or as vt,kw as _t,fH as bt,uI as jt,dG as kt,dz as L,dI as yt,dK as Rt,dB as Mt,uJ as Ct,uK as Nt,uL as Gt,ce as Be,dA as ze,uM as Et,uN as _,n9 as At,uO as le,c$ as Dt,uP as Ut,uQ as ke,uR as Tt,uS as Bt,m as zt}from"./mclphevd122040jw.js";import{C as Oe}from"./k059n59kmbyb9lsl.js";import{D as Ot}from"./o9hdwp5tn0xu3mwp.js";import{C as Ft}from"./l31shxiia7uxyucr.js";const Fe=({children:e,isDimensionsUnknown:t})=>n.jsxs(X.div,{className:W(["relative max-w-[480px] rounded-2xl",t&&"aspect-square overflow-hidden"]),children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]}),Ht=({children:e,isDimensionsUnknown:t,width:a,height:s})=>n.jsxs(X.div,{layout:!0,transition:{duration:.3,ease:"easeInOut"},exit:{opacity:0,transition:{duration:.1,ease:"easeInOut"}},className:W(["relative max-w-[480px] overflow-hidden rounded-2xl",t&&"aspect-square"]),style:{width:a!=null?a:"auto",height:s!=null?s:"auto"},children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]}),qt=()=>{const e=Z(),t=xt();return n.jsxs("div",{className:"absolute start-0 bottom-0 flex w-full items-center justify-between bg-white/10 p-4",children:[n.jsxs("div",{className:"flex min-w-0 flex-col",children:[n.jsx("span",{className:"text-sm font-medium text-white",children:e.formatMessage({id:"PlfJ+x",defaultMessage:"Creation might take a moment"})}),n.jsx("span",{className:"text-sm font-normal text-white/80",children:e.formatMessage({id:"4JG8yC",defaultMessage:"Upgrade to create faster"})})]}),n.jsx(Ke,{size:"medium",color:"primary-inverse",onClick:()=>Ve(t,"Image Gen Latency Upsell"),children:e.formatMessage(Qe.getPlus)})]})};function $t(e){const[t,a]=Je(ve.ImageGenProgressUpsellV2,null,o=>o!=null&&typeof o=="object"&&(typeof o.lastSeenUpsellAt=="number"||o.lastSeenUpsellAt==null)&&(typeof o.lastUsedImageGen=="number"||o.lastUsedImageGen==null)&&(typeof o.lastMessageId=="string"||o.lastMessageId==null)&&(typeof o.lastCanBeSeen=="boolean"||o.lastCanBeSeen==null)),s=t&&t.lastSeenUpsellAt?_e(t.lastSeenUpsellAt):null,i=t&&t.lastUsedImageGen?_e(t.lastUsedImageGen):null,m=e?t&&t.lastMessageId===e?t.lastCanBeSeen:(s==null||Ye(s,be(new Date,3)))&&i!=null&&Xe(i,be(new Date,1)):!1;return{canBeSeen:m,markImageGenUsed:()=>{var o;if(e){const d={lastSeenUpsellAt:m?je(new Date):(o=t==null?void 0:t.lastSeenUpsellAt)!=null?o:null,lastUsedImageGen:je(new Date),lastMessageId:e!=null?e:null,lastCanBeSeen:m};a(d),localStorage.setItem(ve.ImageGenProgressUpsellV2,JSON.stringify(d))}}}}function Wt(){const[t,a]=r.useState(new Date);r.useEffect(()=>{a(new Date)},[]);const s=_t(+t,12e4);return n.jsx(bt,{percentage:s,sizeOverride:30,thickness:1/15,className:"text-white",backgroundStrokeClassName:"stroke-white/20",transitionDuration:"".concat((100-s)/100*.2,"s"),transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})}const He=({isGettingStarted:e,messageId:t})=>{var g;const a=Ge(),s=Le(),i=(g=s==null?void 0:s.isFree())!=null?g:!1,{canBeSeen:m,markImageGenUsed:l}=$t(t),o=i&&m&&Ze(a,"1997515563").get("should_show_image_gen_latency_upsell",!1);vt(()=>{l()});const d=Z(),h=r.useMemo(()=>e?d.formatMessage({id:"SxQKjt",defaultMessage:"Getting started"}):d.formatMessage({id:"Y3ETLn",defaultMessage:"Creating image"}),[e,d]),c=Ee(a,"3019066937").get("should_show_cot_header",!1),u=r.useMemo(()=>e?n.jsx(Oe,{size:30,arcPercentage:.2,strokeWidth:2}):n.jsx(Wt,{}),[e]);return n.jsxs("div",{className:W("absolute inset-0 flex justify-between px-6 py-6",o?"items-start":"items-end"),children:[n.jsxs(wt,{mode:"popLayout",children:[c&&n.jsx(X.span,{className:W("flex items-center gap-1 align-middle text-lg",!e&&"text-white"),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,overflow:"hidden",whiteSpace:"nowrap"},transition:{duration:.1,ease:"easeInOut"},children:h},h),n.jsx("div",{className:"flex flex-1 items-center justify-end",children:u})]}),o&&n.jsx(qt,{})]})};var Ne;const ye=Pe.div(Ne||(Ne=pe(["invisible absolute top-3 flex gap-1 group-hover/paragen-image:visible z-2\n  ","\n  ",""])),({$rightAlign:e})=>e?"end-3":"start-3",({$alwaysVisible:e})=>e?"visible":""),Kt=({imageUrl:e})=>{const[t,a]=r.useState(void 0),s=Z(),i=jt(),m=r.useCallback(()=>{const l=new Date,o=s.formatDate(l,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});return"".concat(o,".png")},[s]);return n.jsxs("div",{className:"group/paragen-image absolute inset-0 z-3",children:[n.jsxs(ye,{$alwaysVisible:!0,children:[t!==!1&&n.jsx(se,{icon:kt,selected:t===!0,variant:"large",onClick:l=>{l.stopPropagation(),L.paragenImageRated({liked:!0,analyticsContext:i}),a(!0)}}),t!==!0&&n.jsx(se,{icon:yt,selected:t===!1,variant:"large",onClick:l=>{l.stopPropagation(),L.paragenImageRated({liked:!1,analyticsContext:i}),a(!1)}})]}),n.jsx(ye,{$alwaysVisible:!0,$rightAlign:!0,children:n.jsx(se,{icon:Rt,variant:"large",onClick:l=>{l.stopPropagation(),L.paragenDownload({analyticsContext:i}),Mt({url:e,fileName:m()})}})})]})};function qe({withLottie:e}){const a=Z().formatMessage({id:"imagegen.progressIndicator.ariaLabel",defaultMessage:"Generating image..."});return n.jsx("div",{className:"absolute start-0 top-0 flex h-full w-full items-center justify-center rounded-full","aria-label":a,children:n.jsx(Oe,{size:40,arcPercentage:.2,children:n.jsx(Ot,{animate:e,matchTextColor:!0,className:"h-6 w-6"})})})}const $e=300,Vt=1.3,Re=.05,Qt=/blur\(([\d.]+)px\)/,Jt={duration:$e/1e3,ease:"linear"};function ie(e,t,a){var l,o,d,h,c;e.sort((u,g)=>u.lastSrcReceivedTime-g.lastSrcReceivedTime);const s=new Array(e.length).fill(0);for(let u=0;u<=e.length;u+=1){const g=u-1,b=u,x=(o=(l=e[g])==null?void 0:l.availablePercentComplete)!=null?o:0,f=(h=(d=e[b])==null?void 0:d.availablePercentComplete)!=null?h:1;if(t>=x&&t<=f&&x!==f){const S=(t-x)/(f-x);s[g]=1-S,s[b]=S}}const i=s[s.length-1],m=s[s.length-2];return i===1&&m===0&&(s[s.length-2]=.01),a&&t<=((c=e[0])==null?void 0:c.availablePercentComplete)&&(s[0]=1),s}const Yt=({alt:e,src:t,availablePercentComplete:a,onAnimationUpdate:s,ignoreFirstChunk:i=!1,isTransparent:m=!1,dimensions:l,onError:o,unconstrainedWidth:d=!1,progressLoaderProps:h})=>{const c=et(),u=r.useMemo(()=>"url(".concat(c?Ct:Nt,")"),[c]),[g,b]=r.useState(!1),[x,f]=r.useState(1e3),[S,D]=r.useState(a!=null?a:0),[w,I]=r.useState(a===1?1:0),k=r.useRef(performance.now()),R=r.useRef(0),p=r.useRef([]),[O,E]=r.useState([0]),[K,z]=r.useState(a===1),H=r.useRef(!1),F=r.useRef(null),A=S===1,C=a===1&&K,U=l?l.width/l.height:1;r.useEffect(()=>{!g&&a&&(b(!0),R.current=performance.now())},[g,a]),r.useEffect(()=>{var y;const j=(y=p.current[p.current.length-1])==null?void 0:y.src;if(t&&t!==j){const v=p.current.findIndex(N=>N.availablePercentComplete===a);v!==-1?p.current[v]={src:t,availablePercentComplete:a!=null?a:0,lastSrcReceivedTime:performance.now()}:p.current.push({src:t,availablePercentComplete:a!=null?a:0,lastSrcReceivedTime:performance.now()}),E(ie(p.current,S,i))}},[t,S,i,a]);const P=r.useCallback(()=>{F.current&&a&&(f(C?$e:(performance.now()-k.current)*Vt),(!i||H.current||a>=Re)&&a!==1&&I(a),H.current=!0,k.current=performance.now(),h==null||h.setHasImageReady(!0))},[a,C,i,h]),ee=r.useCallback(j=>{const y=parseFloat(j.height)/100;s==null||s(y),D(y),E(ie(p.current,parseFloat(j.height)/100,i))},[s,i]),te=r.useCallback(j=>{var Y,$;const y=($=(Y=j.filter.toString().match(Qt))==null?void 0:Y[1])!=null?$:"0",N=(16-parseFloat(y))/16,J=1-w,q=w+J*N;s==null||s(q),D(q),E(ie(p.current,q,i))},[i,w,s]);if(!g)return n.jsx(Fe,{isDimensionsUnknown:!0,children:n.jsx(qe,{withLottie:!0})});const Q={duration:x/1e3,ease:"linear"},B=a!==1||!m;return n.jsxs("div",{className:W("relative z-0 cursor-pointer overflow-hidden",U<1?"max-w-[400px]":"max-w-[480px]",!A&&"pointer-events-none",!H.current&&"bg-token-main-surface-secondary",d&&"max-w-full"),"aria-label":e,style:{aspectRatio:U},children:[!(h!=null&&h.shouldHideDiagonalShimmer)&&a&&a<Re&&n.jsx("div",{className:"absolute inset-0 z-3 w-full overflow-hidden",children:n.jsx("div",{className:"absolute start-[-150%] top-[-150%] h-[400%] w-[400%]",children:n.jsx("div",{className:"diagonal-sweep-gradient h-full w-full"})})}),n.jsxs(X.div,{className:"absolute start-0 end-0 top-0 z-2 w-full overflow-hidden transition-[mask] ease-linear",initial:C?!1:{height:"0%"},animate:A?{height:"100%"}:{height:"".concat(w*100,"%")},onUpdate:C?void 0:ee,transition:C?{duration:0,ease:"linear"}:Q,style:A?void 0:{mask:"linear-gradient(rgb(0,0,0) 0%, rgb(0,0,0) calc(100% - 24px), rgba(0,0,0,0) 100%)"},children:[t&&n.jsx("img",{ref:F,src:t,onLoad:P,onError:o,alt:e,className:"absolute top-0 z-1 w-full",style:{aspectRatio:U}}),m&&n.jsx("div",{className:"absolute inset-0 z-0 w-full overflow-hidden opacity-0 transition-opacity duration-300 group-hover/imagegen-image:opacity-100 group-focus/imagegen-image:opacity-100",children:n.jsx("div",{className:"absolute inset-0 bg-repeat",style:{backgroundImage:u,backgroundSize:"auto"}})})]}),n.jsx(X.div,{className:"relative z-1 w-full overflow-hidden",initial:{filter:"blur(16px)"},animate:C?{filter:"blur(0px)"}:void 0,transition:C?Jt:void 0,onUpdate:C?te:void 0,style:{aspectRatio:U},children:p.current.map((j,y)=>{const v=O[y],N=j.availablePercentComplete===1;return v!==0||N?n.jsx("img",{src:j.src,alt:e,style:{opacity:v,willChange:"opacity",aspectRatio:U},className:!C&&(h!=null&&h.shouldShowPulseAnimation)?"bg-scale-pulse":"",onLoad:N?()=>z(!0):void 0},j.src):null})}),n.jsx(X.div,{className:"absolute inset-0 z-0 scale-110 overflow-hidden blur-2xl",style:{aspectRatio:U},children:B&&p.current.filter((j,y)=>O[y]!==0).map(j=>n.jsx("img",{src:j.src,alt:e,className:"absolute top-0 w-full"},j.src))})]})},Xt=({imageAssetPointer:e,serverThreadId:t})=>{var h;const[a,s]=r.useState(void 0),i=Gt(),m=(h=e.metadata)==null?void 0:h.watermarked_asset_pointer,l=r.useRef(!1),{isUnauthenticated:o}=Ae();return r.useEffect(()=>{if(i&&m&&!l.current){l.current=!0;const c=tt(m);nt(c,void 0,o,t,!1).then(u=>{u.status===at.Success&&s(u.download_url)}).catch(u=>{u instanceof st||oe.addError(new Error("Could not fetch watermarked image with ID ".concat(m," from file service"),{cause:u}))})}},[i,m,o,t,null]),a},Me=2,ae=({pointer:e,altLabel:t,isEditorAvailable:a,onPercentageRendered:s,messageId:i,imageIndex:m,clientThreadId:l,serverThreadId:o,onEditorClick:d,compact:h,progressLoaderProps:c})=>{var y,v,N,J,q,Y,$;const u=Ue(),[g,b]=r.useState(void 0),x=r.useRef(void 0),f=(v=(y=e.metadata)==null?void 0:y.generation)==null?void 0:v.gen_id,S=(q=(J=(N=e.metadata)==null?void 0:N.generation)==null?void 0:J.height)!=null?q:void 0,D=e.height,w=(S!=null?S:0)/D,I=r.useRef({}),[k]=St(),{isUnauthenticated:R}=Ae(),[p,O]=r.useState(!1),E=r.useContext(Te),K=e.width/e.height,z=Xt({imageAssetPointer:e,serverThreadId:o}),F=r.useCallback((M=!1)=>{!M&&x.current===e.asset_pointer||(x.current=e.asset_pointer,Be.fetch(u,{asset:e,conversationId:o,force:M,isUnauthenticated:R}).then(T=>{b(T)}).finally(()=>{x.current=void 0}))},[e,u,o,R,null]);r.useEffect(()=>{const M=e.asset_pointer!==(g==null?void 0:g.asset_pointer);(!g||M)&&F()},[g,e.asset_pointer,F]);const A=r.useMemo(()=>ze({pointer:g,conversationId:o,messageId:i,source:E?"paragen":"chat",imageIndex:m.toString()}),[g,o,i,E,m]),C=r.useRef(w);r.useEffect(()=>{w===1&&C.current<1&&L.renderingComplete({analyticsContext:A})},[w,A]);const U=r.useCallback(()=>{g&&(d==null||d({image:g,messageId:i,analyticsContext:A}))},[g,i,d,A]),P=r.useMemo(()=>({width:e.width,height:e.height}),[e]),ee=r.useCallback(()=>{var T;const M=((T=I.current[e.asset_pointer])!=null?T:0)+1;if(I.current[e.asset_pointer]=M,I.current[e.asset_pointer]>Me)return oe.addAction("image-gen-asset-error",{name:"retries-exhausted",conversation_id:o,asset_pointer:e.asset_pointer,max_retries:Me});oe.addAction("image-gen-asset-retry",{name:"retry-attempted",conversation_id:o,asset_pointer:e.asset_pointer,current_retry:M}),I.current[e.asset_pointer]=M,F(!0)},[e.asset_pointer,F,o]),te=r.useCallback(M=>{M===1&&O(!0),s==null||s(M)},[s]),V=r.useRef(null),Q=r.useRef(null);r.useEffect(()=>{if(V.current&&(c!=null&&c.setContainerSize)){const M=V.current.getBoundingClientRect(),T={width:M.width,height:M.height},ne=Q.current;(!ne||ne.width!==T.width||ne.height!==T.height)&&(Q.current=T,c.setContainerSize(T))}},[c]);const B=g==null?void 0:g.url,j=z!=null?z:B;return n.jsx(Et.Provider,{value:A,children:n.jsxs("div",{ref:V,className:W("group/imagegen-image relative w-full overflow-hidden",K<1?"max-w-[400px]":"max-w-[480px]",h?"rounded-lg":"rounded-2xl",E&&"max-w-full",i===k.get("image")&&"[view-transition-name:var(--vt-active-image)]"),id:"image-".concat(i),style:{aspectRatio:K},onClick:a?U:void 0,tabIndex:0,children:[z&&n.jsx("img",{alt:t,className:"absolute inset-0 z-1 opacity-0",src:z}),n.jsx(Yt,{alt:t,src:B,availablePercentComplete:w,onAnimationUpdate:te,isEditorAvailable:a,ignoreFirstChunk:!0,isTransparent:($=(Y=e.metadata)==null?void 0:Y.generation)==null?void 0:$.transparent_background,dimensions:P,onError:ee,unconstrainedWidth:E,progressLoaderProps:c},f),(c==null?void 0:c.state)&&(c==null?void 0:c.state)!==_.Complete&&!p&&(c==null?void 0:c.hasImageReady)&&n.jsx(He,{isGettingStarted:!1,messageId:i}),p&&!h&&(E?n.jsx(Kt,{imageUrl:B!=null?B:""}):n.jsx(At,{imageAssetPointer:B,imageUrl:j,messageId:i,clientThreadId:l,serverThreadId:o,shouldShowOverflow:z!==void 0}))]},f)})},Lt=({imageGenerationState:e,isInterrupted:t,asyncMessage:a,imageAssetPointer:s,altLabel:i,clientThreadId:m,serverThreadId:l,onEditorClick:o,isEditorAvailable:d,setAnimationPercentage:h,messageId:c})=>{var w;const[u,g]=r.useState(null),b=u==null,[x,f]=r.useState(!0),S=e===_.Thinking||e===_.AsyncGenerating&&!((w=a==null?void 0:a.metadata)!=null&&w.is_visually_hidden_from_conversation),D=e===_.Generating||e===_.Complete;return r.useEffect(()=>{S&&f(!1)},[S]),t?null:n.jsxs(n.Fragment,{children:[(S||!x)&&n.jsx(Ht,{isDimensionsUnknown:b,width:u==null?void 0:u.width,height:u==null?void 0:u.height,children:b&&n.jsx(He,{isGettingStarted:!0,messageId:c})}),D&&n.jsx(X.div,{className:"pb-2",variants:{hidden:{opacity:0},visible:{opacity:1}},initial:"hidden",animate:x?"visible":"hidden",exit:"hidden",children:s&&n.jsx(ae,{pointer:s,altLabel:i,isEditorAvailable:d,onPercentageRendered:h,messageId:c,clientThreadId:m,serverThreadId:l,imageIndex:0,onEditorClick:o,progressLoaderProps:{state:e,setContainerSize:g,hasImageReady:x,setHasImageReady:f,shouldHideDiagonalShimmer:!0,shouldShowPulseAnimation:!0}})})]})};function Zt({title:e,description:t,shimmer:a}){return!e&&!t?null:n.jsxs("div",{className:"border-token-border-default my-2 max-w-[480px] min-w-72 rounded-2xl border p-6",children:[!!e&&n.jsx("p",{className:W("text-lg font-medium",a&&"loading-shimmer-pure-text-inverted",!!t&&"mb-1"),children:e}),!!t&&n.jsx("p",{children:t})]})}const Pt=e=>{"use forget";const t=It.c(6),{cotMessages:a,visualPercentComplete:s,isInterrupted:i,state:m}=e,l=i===void 0?!1:i,o=Z();let d;t[0]!==o?(d=o.formatMessage({id:"imagegen.thinkingHeader.interrupted",defaultMessage:"Stopped creating image"}),t[0]=o,t[1]=d):d=t[1];const h=d,c=m===_.Complete||s===1;let u;e:{if(l){u=h;break e}else if(!a){u=void 0;break e}if(c){u=a.complete;break e}if(s){const x=Object.keys(a.generating);for(let f=0;f<x.length;f=f+1,f){const S=parseFloat(x[f]);if(s<S){u=a.generating[x[f]];break e}}}else{u=a.thinking;break e}u=a.complete}const g=u;let b;return t[2]!==g||t[3]!==l||t[4]!==c?(b=g&&n.jsx(Ft,{latestHeadline:g,isComplete:c||l,showChunkIcon:!1,isExpandDisabled:!0}),t[2]=g,t[3]=l,t[4]=c,t[5]=b):b=t[5],b},en=({pointersToRender:e,altLabel:t,isEditorAvailable:a,updatePercentageRendered:s,toolCallMessage:i,toolOutputMessageIds:m,clientThreadId:l,serverThreadId:o,handleEditorClick:d})=>{const h=le.useStore(),c=le.useSelectedIndex();r.useEffect(()=>{h.setSelectedIndex(Math.max(m.findIndex(w=>{var I;return w===((I=i==null?void 0:i.metadata)==null?void 0:I.selected_image_message_id)}),0))},[]);const u=r.useRef({}),g=r.useCallback(w=>I=>{u.current[w]=I;const k=Object.keys(u.current).length,R=Object.values(u.current).reduce((p,O)=>p+O,0);s==null||s(R/k)},[s]),[b,x]=r.useState(null),f=it(l,re.getRequestId),S=Dt(f);r.useEffect(()=>{!S&&b!=null&&i!=null&&o!=null&&(Ce(i.id,m[b],l,o),x(null))},[S]);const D=r.useCallback(w=>{h.setSelectedIndex(w);const I=Object.values(u.current);ot.logEventWithStatsig("chatgpt_image_switched","chatgpt_image_switched",{conversationId:o,messageId:m[w],imageIndex:w.toString(),isLoading:(I.length===0||I.some(p=>p<1)).toString()});const k=re.getConversationLastTurn(De(l)),R=(k==null?void 0:k.messages.find(p=>p.id===(i==null?void 0:i.id)))!=null;i!=null&&o!=null&&(R&&S?x(w):Ce(i.id,m[w],l,o))},[i,m,l,o,h,S,x]);return n.jsxs("div",{className:"flex gap-2",children:[n.jsx(ae,{pointer:e[c],altLabel:t,isEditorAvailable:a,messageId:m[c],imageIndex:c,clientThreadId:l,serverThreadId:o,onEditorClick:d},m[c]),n.jsx("div",{className:"flex flex-col gap-2",children:e.map((w,I)=>{var k,R;return n.jsx(tn,{pointer:w,altLabel:t,isSelected:I===c,onClick:()=>D(I),onPercentageRendered:(R=(k=w.metadata)==null?void 0:k.generation)!=null&&R.gen_id?g(w.metadata.generation.gen_id):void 0,messageId:m[I],imageIndex:I,clientThreadId:l,serverThreadId:o},m[I])})})]})},tn=({pointer:e,altLabel:t,isSelected:a,onClick:s,onPercentageRendered:i,messageId:m,imageIndex:l,clientThreadId:o,serverThreadId:d})=>n.jsxs("button",{type:"button",onClick:s,className:"relative w-14 rounded-lg p-1",children:[n.jsx("div",{className:W(a&&"opacity-70"),children:n.jsx(ae,{pointer:e,altLabel:t,isEditorAvailable:!1,onPercentageRendered:i,messageId:m,imageIndex:l,clientThreadId:o,serverThreadId:d,compact:!0})}),a&&n.jsx("div",{className:"border-token-border-default pointer-events-none absolute inset-0 rounded-xl border-2"})]});async function Ce(e,t,a,s){const i=await rt.safePost("/image-gen/message-select",{requestBody:{message_id:e,selected_image_message_id:t,conversation_id:s}}),m=i.id;m!=null&&lt(a,l=>{ct.updateTree(l,o=>{o.updateNodeMessage(m,i)})})}function nn(e){const t=e.find(l=>l.author.role==="tool"&&l.author.name===Ut&&l.content.content_type==="text"),[a,...s]=(t==null?void 0:t.content.content_type)==="text"?t.content.parts:[],i=s.pop(),m=s.length;return a&&i&&s.length>0?{thinking:a,complete:i,generating:s.reduce((l,o,d)=>{const h=(d+1)/m;return l[h.toFixed(2)]=o,l},{})}:void 0}const an=e=>{const t=Z(),{size:a="image",count:s=1}=e||{};return s>1?{thinking:t.formatMessage({id:"cdnmKo",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"aTbInH",defaultMessage:"Creating images. May take a moment."}),"0.67":t.formatMessage({id:"WRM3Yw",defaultMessage:"Creating images. May take a moment."}),"1.00":t.formatMessage({id:"8ZydRG",defaultMessage:"Creating images. May take a moment."})},complete:t.formatMessage({id:"XQ81dl",defaultMessage:"Images created"})}:a==="xlimage"?{thinking:t.formatMessage({id:"y7op2E",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"cdrDJH",defaultMessage:"Creating image. May take a moment."}),"0.67":t.formatMessage({id:"RP4bRn",defaultMessage:"Adding details"}),"1.00":t.formatMessage({id:"o36MSQ",defaultMessage:"Finishing touches"})},complete:t.formatMessage({id:"QsnnBN",defaultMessage:"Image created"})}:{thinking:t.formatMessage({id:"6c7+kN",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"DP6/8y",defaultMessage:"Creating image"}),"0.67":t.formatMessage({id:"k9y1TT",defaultMessage:"Creating image"}),"1.00":t.formatMessage({id:"GpR7v3",defaultMessage:"Creating image"})},complete:t.formatMessage({id:"l2Izz4",defaultMessage:"Image created"})}},sn=ft(()=>ht(()=>import("./dpaj0n43y3yxbl8z.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])).then(e=>e.ImageGenConversationLightboxNew)),on=[_.Empty,_.Errored],hn=({messages:e,clientThreadId:t,isLastTurnInConversation:a,isParagen:s=!1})=>{var P,ee,te,V,Q,B,j,y;const i=ut(t),l=Z().formatMessage({id:"imagegen.message.altLabel",defaultMessage:"Generated image"}),{messageIds:o,imageAssetPointers:d}=r.useMemo(()=>ke(e),[e]),h=e.find(Tt),c=le.useSelectedIndex(),u=(te=(ee=(P=d==null?void 0:d[c])==null?void 0:P.metadata)==null?void 0:ee.generation)==null?void 0:te.gen_size,g=an({size:u!=null?u:"image",count:(V=d==null?void 0:d.length)!=null?V:1}),b=r.useMemo(()=>{var v;return(v=nn(e))!=null?v:g},[e,g]),x=e.find(v=>{var N;return(N=v.metadata)==null?void 0:N.image_gen_async}),f=r.useMemo(()=>Bt(e,a),[e,a]),S=r.useRef(!1),D=r.useRef(!1),w=r.useRef(null),I=r.useMemo(()=>ze({pointer:d[c],conversationId:i,messageId:o[c],source:s?"paragen":"chat",imageIndex:c.toString()}),[d,o,c,i,s]);r.useEffect(()=>{if(!S.current&&(f===_.Thinking||f===_.Generating))S.current=!0,w.current=performance.now();else if(S.current&&!D.current)if(f===_.Complete){const v=w.current?performance.now()-w.current:void 0;L.generationSuccess({analyticsContext:I,durationMs:v}),D.current=!0}else f===_.Errored&&(L.generationFailure({analyticsContext:I,errorReason:"assistant_error"}),D.current=!0)},[f,I]);const k=e[e.length-1],R=r.useMemo(()=>k&&dt(k),[k]),p=Ge(),{onRequestCompletion:O}=zt(),E=mt(t),K=(Q=E==null?void 0:E.id)!=null?Q:null,z=Ee(p,"3019066937").get("should_use_new_ui",!1),H=pt({clientThreadId:t})&&f===_.Complete,[F,A]=r.useState(0),C=Ue(),U=r.useCallback(async({image:v,analyticsContext:N})=>{var ce,ue,de;const J=De(t),q=J?re.getConversationTurns(J).flatMap(G=>G.messages):e,{imageAssetPointers:Y,messageIds:$}=ke(q,{skipSort:!0}),T=(s?[v]:await Promise.all(Y.map(G=>Be.fetch(C,{asset:G,conversationId:i})))).map((G,me)=>{var ge,fe,he,xe,we,Se;return{id:(he=(fe=(ge=G.metadata)==null?void 0:ge.generation)==null?void 0:fe.gen_id)!=null?he:$[me],archived:!1,transformationId:(Se=(we=(xe=G.metadata)==null?void 0:xe.generation)==null?void 0:we.gen_id)!=null?Se:null,url:G.url,assetPointer:G.asset_pointer,thumbnail:null,width:G.width,height:G.height,title:null,conversationId:i,messageId:$[me]}});L.editorClick({sourceOperation:(de=(ue=(ce=v.metadata)==null?void 0:ce.dalle)==null?void 0:ue.edit_op)!=null?de:"none",analyticsContext:N});const ne=T.findIndex(G=>G.assetPointer===v.asset_pointer);gt(p,({onClose:G})=>n.jsx(sn,{images:T,initialIndex:ne===-1?0:ne,onClose:G,onRequestCompletion:O,clientThreadId:t,currentModelId:K}))},[e,i,p,O,t,K,C,s]);return on.includes(f)?null:n.jsx(Te.Provider,{value:s,children:n.jsx("div",{className:"flex flex-col",children:z?n.jsx(Lt,{imageGenerationState:f,isInterrupted:R,asyncMessage:x,imageAssetPointer:d[0],altLabel:l,clientThreadId:t,serverThreadId:i,onEditorClick:U,setAnimationPercentage:A,isEditorAvailable:H,messageId:o[0]}):n.jsxs(n.Fragment,{children:[f!==_.Unavailable&&f!==_.AsyncGenerating&&f!==_.AsyncHanging&&n.jsx("div",{className:"pb-3",children:n.jsx(Pt,{cotMessages:b,visualPercentComplete:F,isInterrupted:R,state:f})}),f===_.Thinking&&!R&&n.jsx(Fe,{isDimensionsUnknown:!0,children:n.jsx(qe,{withLottie:!0})}),f===_.AsyncGenerating&&!((B=x==null?void 0:x.metadata)!=null&&B.is_visually_hidden_from_conversation)&&n.jsx(Zt,{shimmer:!0,title:(j=x==null?void 0:x.metadata)==null?void 0:j.ui_card_title,description:(y=x==null?void 0:x.metadata)==null?void 0:y.ui_card_description}),(f===_.Generating||f===_.Complete)&&!R&&n.jsx("div",{className:"pb-2",children:d.length>1?n.jsx(en,{pointersToRender:d,altLabel:l,isEditorAvailable:H,updatePercentageRendered:A,toolCallMessage:h,toolOutputMessageIds:o,clientThreadId:t,serverThreadId:i,handleEditorClick:U}):n.jsx(ae,{pointer:d[0],altLabel:l,isEditorAvailable:H,onPercentageRendered:A,messageId:o[0],imageIndex:0,clientThreadId:t,serverThreadId:i,onEditorClick:U})})]})})})};export{hn as ImageGenMessage};
//# sourceMappingURL=e00w0hl6b7kjuyzc.js.map

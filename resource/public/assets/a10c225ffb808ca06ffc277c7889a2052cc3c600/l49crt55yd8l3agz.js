var T=Object.defineProperty,D=Object.defineProperties;var b=Object.getOwnPropertyDescriptors;var y=Object.getOwnPropertySymbols;var v=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var k=(s,e,t)=>e in s?T(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,p=(s,e)=>{for(var t in e||(e={}))v.call(e,t)&&k(s,t,e[t]);if(y)for(var t of y(e))O.call(e,t)&&k(s,t,e[t]);return s},d=(s,e)=>D(s,b(e));var w=(s,e)=>{var t={};for(var n in s)v.call(s,n)&&e.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&y)for(var n of y(s))e.indexOf(n)<0&&O.call(s,n)&&(t[n]=s[n]);return t};import{kt as U,ow as $,gz as L,kn as l,ko as j,h5 as F,ox as B,R as G,oy as M,oz as J,kp as E,kA as z,oA as H,oB as N}from"./lef5ym39glv4981l.js";import{r as q}from"./jj85rqzpbnvv3emr.js";import{m as K}from"./l5n8sav08y32nia1.js";import{cV as g,cW as I}from"./mclphevd122040jw.js";function ve({composerController:s,parsedDocumentHandler:e}){const{connectorConfig:t}=U();return q.useEffect(()=>{$(L(s),{transformPasted:(n,o)=>{const{allDocIds:r,nextSlice:a}=W(n,o,t);return requestAnimationFrame(()=>{e(r)}),a}})},[s,t,e]),null}function W(s,e,t){const n=[],o=e.state.schema,r=i=>{var h;if(i.isText){let u=(h=i.text)!=null?h:"";const m=Q(u,t);if(m.length===0)return i;for(const f of m)n.push(f),f.isConnected&&(u=u.replaceAll(f.url,""));return u===""?null:o.text(u,i.marks)}if(i.isLeaf)return i;const c=[];return i.forEach(u=>{const m=r(u);m&&c.push(m)}),i.copy(N.fromArray(c))},a=[];return s.content.forEach(i=>{const c=r(i);c&&a.push(c)}),{allDocIds:n,nextSlice:new H(N.fromArray(a),s.openStart,s.openEnd)}}function Q(s,e){var n;const t=[];for(const o of e.values())switch(o.type){case l.GDRIVE:{if((n=o.link_enabled)==null||n){const r=V(s,o);t.push(...r)}break}case l.O365:break;case l.O365_BUSINESS:{const r=ue(s,o).filter(a=>a!=null);t.push(...r);break}case l.O365_PERSONAL:{const r=ne(s,o).filter(a=>a!=null);t.push(...r);break}case l.CONFLUENCE:{const r=re(s,o).filter(a=>a!=null);t.push(...r);break}case l.JIRA:{const r=ce(s,o).filter(a=>a!=null);t.push(...r);break}case l.NOTION_OPEN_CONNECTOR:{const r=Ee(s,o).filter(a=>a!=null);t.push(...r);break}case l.SLACK_OPEN_CONNECTOR:{const r=me(s,o).filter(a=>a!=null);t.push(...r);break}}return t.length&&j.linkPasted(K(F(t,o=>o.type),o=>o.length)),t}const X=/\bhttps:\/\/docs\.google\.com\/(document|spreadsheets|presentation)\/d\/([\w-]+)\/?(?:(?:edit|view)\/?)?(?:\?[\w\-.~%=]*)?(?:#[\w\-.~%=]*)?/gm,Y=/\bhttps:\/\/drive\.google\.com\/(file)\/d\/([\w-]+)\/?(?:(?:edit|view)\/?)?(?:\?[\w\-.~%=]*)?(?:#[\w\-.~%=]*)?/gm,Z="https://www.googleapis.com/auth/drive.readonly";function V(s,e){return[...s.matchAll(X),...s.matchAll(Y)].map(t=>{const n={url:t[0],id:t[2],type:l.GDRIVE,isConnected:e.access_token!=null};return e.access_token&&e.scopes&&e.scopes.includes(Z)?d(p({},n),{handler:{type:"fetch",tryFetch:async()=>{I.logAttemptIfAccessTokenIsExpired(e,E.Link);const r="https://www.googleapis.com/drive/v3/files/".concat(n.id,"?fields=name,mimeType"),a=await fetch(r,{method:"GET",headers:{Authorization:"Bearer ".concat(e.access_token),"Content-Type":"application/json"}});if(!a.ok)return Promise.reject(new Error("HTTP ".concat(a.status)));const{name:i,mimeType:c}=await a.json(),h=z(c);return{connector:l.GDRIVE,id:n.id,title:i,mimeType:c,url:n.url,syntheticExtension:h}}}}):d(p({},n),{handler:{type:"prompt",message:"not-connected"}})})}function A(s){let e;try{e=new URL(s).toString()}catch(t){return null}return"u!".concat(btoa(e).replaceAll("=","").replaceAll("/","_").replaceAll("+","-"))}const ee=/\bhttps:\/\/onedrive\.live\.com\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm,te=/\bhttps:\/\/photos\.onedrive\.com\/(?:share|photo)\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm,se=/\bhttps:\/\/1drv\.ms\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm;function ne(s,e){return[...s.matchAll(ee),...s.matchAll(se),...s.matchAll(te)].map(t=>{const n=A(t[0]);if(!n)return null;const o={url:t[0],id:n,type:l.O365_PERSONAL,isConnected:e.access_token!=null};return e.access_token?d(p({},o),{handler:{type:"fetch",tryFetch:P(g.OneDrive_PERSONAL_SHARES,n,e.access_token,e)}}):d(p({},o),{handler:{type:"prompt",message:"not-connected"}})})}const oe=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/wiki\/spaces\/[^\s]+\/pages\/(\d+)\/([^\s]+)?/gm;function re(s,e){return[...s.matchAll(oe)].map(t=>{const n=t[1],o=t[2],r=t[3];if(!o)return null;const a={url:t[0],id:o,type:l.CONFLUENCE,isConnected:e.access_token!=null};return e.access_token?d(p({},a),{handler:{type:"fetch",tryFetch:async()=>{let i=r;return!r&&e.access_token&&(i=await ge(e.access_token,"https://".concat(n),e,o)),{connector:e.type,id:o,title:i,mimeType:"text/html",url:a.url,syntheticExtension:null,manifest:{id:o,domain:n,type:J.PAGE,manifest_type:l.CONFLUENCE}}}}}):d(p({},a),{handler:{type:"prompt",message:"not-connected"}})})}const ae=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/browse\/([^\s]+)\??/gm,ie=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/jira\/(?:[^\s]+\/)*projects\/(?:[^\s]+\/)+(?:[^\s]+\/?)\?selectedIssue=([^\s]+)&?/gm;function ce(s,e){return[...s.matchAll(ae),...s.matchAll(ie)].map(t=>{const n=t[1],o=t[2];if(!o||!n)return null;const r={url:t[0],id:o,type:l.JIRA,isConnected:e.access_token!=null};return e.access_token?d(p({},r),{handler:{type:"fetch",tryFetch:async()=>{const a=await ye(e.access_token,"https://".concat(n),e,o);return Promise.resolve({connector:e.type,id:o,title:a,mimeType:"text/markdown",url:r.url,syntheticExtension:null,manifest:{id_or_key:o,domain:n,manifest_type:l.JIRA}})}}}):d(p({},r),{handler:{type:"prompt",message:"not-connected"}})})}const le=/\bhttps:\/\/[^\s]+?\.sharepoint\.com\/[^\s]*/gm;function ue(s,e){return[...s.matchAll(le)].map(t=>{const n=A(t[0]),o=g.OneDrive_BUSINESS_SHARES;if(!n)return null;const r={url:t[0],id:n,type:l.O365_BUSINESS,isConnected:e.access_token!=null};return e.access_token?d(p({},r),{handler:{type:"fetch",tryFetch:P(o,n,e.access_token,e)}}):d(p({},r),{handler:{type:"prompt",message:"not-connected"}})})}const pe=new RegExp("\\bhttps:\\/\\/(?<domain>[^\\s]+?\\.(?:enterprise\\.)?slack\\.com)\\/archives\\/(?<conversation_id>[^\\s/]+)\\/?\\??$","gm"),de=new RegExp("\\bhttps:\\/\\/(?<domain>[^\\s]+?\\.(?:enterprise\\.)?slack\\.com)\\/archives\\/(?<conversation_id>[^\\s/]+)\\/p(?<message_id>[^\\s?&]+)(?:\\?(?:.*thread_ts=(?<thread_id>[^\\s&]+)(?:&.*))?)?","gm");function me(s,e){return[...s.matchAll(de),...s.matchAll(pe)].map(t=>{var m,f,C,R,S;const n=(m=t.groups)==null?void 0:m.domain;if(!n)throw new Error("No domain found in match ".concat(JSON.stringify(t)));const o=(f=t.groups)==null?void 0:f.conversation_id;if(!o)throw new Error("No conversation ID found in match ".concat(JSON.stringify(t)));const r=(C=t.groups)==null?void 0:C.message_id;let a=null;r&&(a="".concat(r.slice(0,10),".").concat(r.slice(10)));const i=(S=(R=t.groups)==null?void 0:R.thread_id)!=null?S:null;let c="Conversation",h="conversation-".concat(o);a?(c="Message",h="message-".concat(a)):i?(c="Thread",h="thread-".concat(i)):o[0]==="D"&&(c="Direct message");const u={id:h,url:t[0],domain:n,conversationId:o,messageId:a,threadId:i,type:l.SLACK_OPEN_CONNECTOR,isConnected:e.access_token!=null};return e.access_token?d(p({},u),{handler:{type:"fetch",tryFetch:async()=>e.access_token?Promise.resolve({connector:e.type,id:u.id,title:c,mimeType:"application/json",url:u.url,syntheticExtension:null,manifest:{conversation_id:u.conversationId,domain:u.domain,manifest_type:l.SLACK_OPEN_CONNECTOR,message_id:u.messageId,thread_id:i,type:B.MESSAGE}}):Promise.reject(new Error("Not connected"))}}):d(p({},u),{handler:{type:"prompt",message:"not-connected"}})})}function P(s,e,t,n,o){switch(s){case g.OneDrive_BUSINESS_SHARES:case g.OneDrive_PERSONAL_SHARES:return()=>_("".concat(s,"/").concat(encodeURIComponent(e),"/driveItem"),t,n);case g.OneDrive_BUSINESS_DRIVE_ITEMS:return()=>_("".concat(s,"/").concat(encodeURIComponent(e)),t,n);case g.OneDrive_BUSINESS_DRIVE_ROOT:return async()=>{const r=await he(t,e);if(!r)return Promise.reject(null);const a="".concat(s,":").concat(encodeURIComponent(r));return _(a,t,n)};case g.OneDrive_PERSONAL_DRIVE_ITEMS:return()=>Promise.reject(null)}}async function he(s,e){const n=await fetch("https://graph.microsoft.com/v1.0/me/drive/root",{method:"GET",headers:{Authorization:"Bearer ".concat(s),"Content-Type":"application/json"}});if(!n.ok)return null;const{webUrl:o}=await n.json(),a=new URL(o).pathname;return e.startsWith(a)?e.substring(a.length):e}async function _(s,e,t,n){var m,f;I.logAttemptIfAccessTokenIsExpired(t,E.Link);const o=await fetch(s,{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(!o.ok)return Promise.reject(new Error("HTTP ".concat(o.status)));const u=await o.json(),{id:r,name:a,file:i,webUrl:c}=u,h=w(u,["id","name","file","webUrl"]);return n||(n=(m=h.parentReference)==null?void 0:m.driveId),{connector:t.type,id:r,title:a!=null?a:"",mimeType:(f=i==null?void 0:i.mimeType)!=null?f:"",url:c!=null?c:"",syntheticExtension:null,o365DriveId:n}}const fe="https://api.atlassian.com/oauth/token/accessible-resources";async function x(s,e,t){var r;I.logAttemptIfAccessTokenIsExpired(t,E.Link);const o=(r=(await fetch(fe,{headers:{Authorization:"Bearer ".concat(s)}}).then(a=>a.json())).find(a=>a.url===e))==null?void 0:r.id;return o||Promise.reject(new Error("Cloud ID not found"))}async function ge(s,e,t,n){var i;const o=await x(s,e,t);return(i=(await fetch("https://api.atlassian.com/ex/confluence/".concat(o,"/wiki/api/v2/pages/").concat(n,"?include-version=false"),{headers:{Authorization:"Bearer ".concat(s)}}).then(c=>c.json())).title)!=null?i:"Confluence Page"}async function ye(s,e,t,n){var i;const o=await x(s,e,t);return(i=(await fetch("https://api.atlassian.com/ex/jira/".concat(o,"/rest/api/2/issue/").concat(n,"?fields=summary"),{headers:{Authorization:"Bearer ".concat(s)}}).then(c=>c.json())).fields.summary)!=null?i:"Jira Issue"}const _e=new RegExp("\\bhttps:\\/\\/www\\.notion\\.so\\/(?:.*?)?(?<page_id>[a-f0-9]{32})(?:\\?[\\x21-\\x7e]*)?","gm");function Ee(s,e){return[...s.matchAll(_e)].map(t=>{var r;const n=(r=t.groups)==null?void 0:r.page_id;if(!n)return null;const o={url:t[0],id:n,type:l.NOTION_OPEN_CONNECTOR,isConnected:e.access_token!=null};return e.access_token?d(p({},o),{handler:{type:"fetch",tryFetch:async()=>{var i;const a=await G.safePost("/connectors/metadata",{requestBody:{manifest:{id:n,manifest_type:l.NOTION_OPEN_CONNECTOR}}});return Promise.resolve({connector:e.type,id:n,title:(i=a.title)!=null?i:"Notion Page",mimeType:"application/json",url:o.url,syntheticExtension:null,manifest:{id:n,type:M.PAGE,manifest_type:l.NOTION_OPEN_CONNECTOR}})}}}):d(p({},o),{handler:{type:"prompt",message:"not-connected"}})})}export{ve as ContextConnectorDocumentParser,A as encodeOneDriveShareUrl,Q as parseDocumentURLs};
//# sourceMappingURL=l49crt55yd8l3agz.js.map

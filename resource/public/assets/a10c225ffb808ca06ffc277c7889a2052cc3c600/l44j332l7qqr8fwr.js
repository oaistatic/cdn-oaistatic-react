import{j as t,A as L,r as o,u as B,M as H,b as K}from"./jj85rqzpbnvv3emr.js";import{e as W,ot as I,ce as _,k as Y,bP as z,ax as V,fv as X}from"./lef5ym39glv4981l.js";import{cD as Z,cE as C,cS as j,h6 as $,h7 as U,h8 as G,cT as J,h9 as k}from"./mclphevd122040jw.js";import{u as ee}from"./caf1sdj80uq0brjb.js";import{g as te,a as se}from"./gfh3fgyqv0cpuikj.js";function ne({highlightedText:e,shouldShimmer:s,className:n}){return t.jsx(L,{children:t.jsx("div",{className:W(s&&"loading-shimmer-pure-text","absolute start-0 top-0 flex h-8 gap-1 overflow-hidden",n),children:t.jsx("span",{children:e})})})}const O="Too many active automations";function he({clientThreadId:e,currentGroupedMessage:s,nextMessage:n,isLastMessage:h,isRequestActive:a}){var y,M,D,q;const m=h||n,r=a&&!n,w=o.useRef(r);o.useEffect(()=>{r&&(w.current=r)},[r]);const d=s,l=o.useMemo(()=>{for(const c of(d==null?void 0:d.messages)||[]){const f=I(c.author.name);if((f==null?void 0:f.namespace)===_.DE1D73E)return f}},[d]),i=ae(d,r),p=(y=i==null?void 0:i.automationId)!=null?y:"",R=(M=i==null?void 0:i.updatedAt)!=null?M:"0",x=i==null?void 0:i.error,[b,Q]=o.useState(!0),{automation:u,error:g}=ee(p);o.useEffect(()=>{g&&g instanceof Y&&(g.status===404||g.status===410)&&Q(!1)},[g]);const A=B();o.useEffect(()=>{if(!b)return;const c=new Date(R),f=new Date(u==null?void 0:u.updated_at);!isNaN(c.getTime())&&!isNaN(f.getTime())&&f<c&&A.invalidateQueries({queryKey:Z.getAutomationQueryKey(p)})},[u,p,R,b,A]);const E=d.messages,N=(q=(D=E[E.length-1])==null?void 0:D.metadata)==null?void 0:q.permissions,T=o.useMemo(()=>N==null?void 0:N.some(c=>c.type==="notification"&&c.status==="requested"),[N]);o.useEffect(()=>(x===O&&w.current&&C.setMaxBannerClientThreadId(e),()=>{C.clearMaxBannerClientThreadId()}),[x,e]),o.useEffect(()=>{j.initIfNeeded()},[]);const S=E[0].create_time,P=o.useRef(!1),v=re();if(o.useEffect(()=>{(async()=>{if(!v){j.clearNotificationRequest();return}if(P.current)return;await oe(u,T,S)&&(P.current=!0,j.setRequestingClientThreadId(e))})()},[u,S,e,T,v]),!r&&x&&x!==O)return t.jsx(ie,{errorUserMessage:i==null?void 0:i.errorUserMessage});if(b&&m){if(p)return u?t.jsx($,{automation:u}):r?t.jsx(F,{functionName:l==null?void 0:l.functionName}):t.jsx(U,{});if(r&&l)return t.jsx(F,{functionName:l.functionName})}return null}function F({functionName:e}){const s=K();return t.jsx("div",{className:"text-token-text-secondary relative my-2 h-8 first:mt-0",children:t.jsx(ne,{highlightedText:s.formatMessage(e==="update"?J.updatingAutomation:J.makingAutomation),className:"me-1.5 mt-1 items-center justify-start",shouldShimmer:!0})})}function ae(e,s){return o.useMemo(()=>{var h;if(s)return;const n=(h=e==null?void 0:e.messages)==null?void 0:h.find(a=>{const m=I(a.author.name);return(m==null?void 0:m.namespace)===_.DE1D73E});if(n)try{const a=JSON.parse(z(n));return a.status==="ERROR"?{error:a.message,errorUserMessage:a.user_message}:{automationId:a.jawbone.id,updatedAt:a.jawbone.updated_at}}catch(a){V.addError("Jawbone: Failed to parse automation message",{cause:a});return}},[e,s])}function ie({errorUserMessage:e}){return t.jsxs("div",{className:"text-token-text-error flex items-center gap-1.5 pb-1",children:[t.jsx(X,{className:"icon"}),t.jsx("div",{children:e!=null?e:t.jsx(H,{id:"oOQhkY",defaultMessage:"Task scheduling wasn’t completed — please ask again."})})]})}async function oe(e,s,n){if(!e||!s||!n)return!1;const h=new Date(n*1e3);if(!(Math.abs(new Date().getTime()-h.getTime())<=5*60*1e3))return!1;const r=k.getLastRequestTime();return!(r&&Date.now()-new Date(r).getTime()<24*60*60*1e3||k.getPermission()==="denied"||!await te()||await se())}function re(){const{data:e}=G({alwaysRefetchOnMount:!1});return e==null?void 0:e.some(s=>s.category==="tasks"&&s.options.some(n=>n.channel==="push"&&n.enabled))}export{he as JawboneMessage};
//# sourceMappingURL=l44j332l7qqr8fwr.js.map

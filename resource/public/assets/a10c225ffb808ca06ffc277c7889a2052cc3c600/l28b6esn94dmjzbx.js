var K=Object.defineProperty,X=Object.defineProperties;var Z=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var Y=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var R=(a,l,t)=>l in a?K(a,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[l]=t,v=(a,l)=>{for(var t in l||(l={}))Y.call(l,t)&&R(a,t,l[t]);if(O)for(var t of O(l))J.call(l,t)&&R(a,t,l[t]);return a},N=(a,l)=>X(a,Z(l));import{d as $,b as B,r as S,j as e,M as I}from"./jj85rqzpbnvv3emr.js";import{ch as D,cg as F,f as ee,oH as se,qb as G,R as te,k as ae}from"./lef5ym39glv4981l.js";import{cP as q,cM as Q,dF as z,dG as ne,dH as V,dI as re,lY as oe,bf as H,lZ as le,l_ as ie,cN as ce,di as de,d9 as ue}from"./mclphevd122040jw.js";import{T as L}from"./fvmxudg74tbhlabl.js";const me=["Not relevant","Inaccurate","Incomplete","Missing sources","I don't like it","Shouldn't have searched Google Drive","Prompt was misunderstood","Didn't like the response style","Other"],fe=["Good sources","Answered my question","I like it","Other"],ge=["Not relevant","Out of date","Content is wrong"],he=["Relevant","Up to date","Accurate"];function xe(a){switch(a){case"Not relevant":return m.tagNotRelevant;case"Inaccurate":return m.tagInaccurate;case"Incomplete":return m.tagIncomplete;case"Missing sources":return m.tagMissingSources;case"I don't like it":return m.tagDontLikeIt;case"Shouldn't have searched Google Drive":return m.tagShouldntHaveSearched;case"Prompt was misunderstood":return m.tagPromptMisunderstood;case"Didn't like the response style":return m.tagDidntLikeResponseStyle;case"Other":return m.tagOther;case"Good sources":return m.tagGoodSources;case"Answered my question":return m.tagAnsweredMyQuestion;case"I like it":return m.tagLike;case"Out of date":return m.tagOutOfDate;case"Content is wrong":return m.tagContentWrong;case"Relevant":return m.tagRelevant;case"Up to date":return m.tagUpToDate;case"Accurate":return m.tagAccurate}}function W(a,l){let t;try{t=xe(a)}catch(g){}return t?l.formatMessage(t):a}function P(a,l){return a.map(t=>({label:W(t,l),value:t}))}const m=$({tagNotRelevant:{id:"T24lap",defaultMessage:"Not relevant"},tagInaccurate:{id:"USOv/g",defaultMessage:"Inaccurate"},tagIncomplete:{id:"Lk26Q8",defaultMessage:"Incomplete"},tagMissingSources:{id:"Fng4pl",defaultMessage:"Missing sources"},tagDontLikeIt:{id:"6eAB3A",defaultMessage:"I don't like it"},tagShouldntHaveSearched:{id:"Y22bKM",defaultMessage:"Shouldn't have searched Google Drive"},tagPromptMisunderstood:{id:"NjmgTt",defaultMessage:"Prompt was misunderstood"},tagDidntLikeResponseStyle:{id:"np+P/8",defaultMessage:"Didn't like the response style"},tagOther:{id:"BK4DWm",defaultMessage:"Other"},tagGoodSources:{id:"SpXc0X",defaultMessage:"Good sources"},tagAnsweredMyQuestion:{id:"jbur49",defaultMessage:"Answered my question"},tagLike:{id:"w9iwLl",defaultMessage:"I like it"},tagOutOfDate:{id:"qzHvzr",defaultMessage:"Out of date"},tagContentWrong:{id:"gGDbwI",defaultMessage:"Content is wrong"},tagRelevant:{id:"G4D31U",defaultMessage:"Relevant"},tagUpToDate:{id:"CsRBPs",defaultMessage:"Up to date"},tagAccurate:{id:"ohD9UA",defaultMessage:"Accurate"}});function pe({citationMetadata:a,noBottomBorder:l=!1,sourceFeedback:t,setSourceFeedback:g}){var k;const u=B(),[j,h]=S.useMemo(()=>{if(a.type!=="file")return["",""];const d=a.name.split(".");return d.length>1?[d.slice(0,-1).join("."),d[d.length-1]]:[a.name,""]},[a]),x=S.useMemo(()=>{var C,_,A;if(a.type!=="file")return()=>null;const d=(_=a.cloud_doc_url)!=null?_:(C=a.extra)==null?void 0:C.cloud_doc_url;if(!d)return q;const p=Q(d);return(A=p==null?void 0:p.Icon)!=null?A:()=>null},[a]),f=S.useMemo(()=>{var d;if(a.type==="file"&&((d=a.extra)!=null&&d.cloud_doc_url))try{return new URL(a.extra.cloud_doc_url).hostname}catch(p){return}},[a]),b=S.useCallback(d=>{g({rating:d,tags:[]})},[g]);return a.type!=="file"?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full me-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(x,{className:"icon me-1.5"}),e.jsx("a",{href:(k=a.extra)==null?void 0:k.cloud_doc_url,className:"text-token-primary flex-shrink-1 flex-grow-1 overflow-hidden text-sm text-ellipsis whitespace-nowrap",target:"_blank",rel:"noreferrer",children:j}),f&&e.jsx("div",{className:"text-token-text-secondary ms-2 text-sm",children:f})]}),e.jsxs("div",{className:"flex shrink-0 flex-row items-center",children:[e.jsx("button",{className:"hover:bg-token-main-surface-secondary rounded-md p-1",children:(t==null?void 0:t.rating)==="thumbsUp"?e.jsx(z,{className:"icon text-token-text-primary",onClick:()=>b(void 0)}):e.jsx(ne,{className:"icon text-token-text-secondary",onClick:()=>b("thumbsUp")})}),e.jsx("button",{className:"hover:bg-token-main-surface-secondary rounded-md p-1",children:(t==null?void 0:t.rating)==="thumbsDown"?e.jsx(V,{className:"icon text-token-text-primary",onClick:()=>b(void 0)}):e.jsx(re,{className:"icon text-token-text-secondary",onClick:()=>b("thumbsDown")})})]})]}),(t==null?void 0:t.rating)&&e.jsx("div",{className:"mb-4 flex flex-row",children:(t.rating==="thumbsDown"?ge:he).map(d=>e.jsx(oe,{className:"me-2",$selected:t.tags.includes(d),onClick:()=>g(N(v({},t),{tags:t.tags.includes(d)?t.tags.filter(p=>p!==d):[...t.tags,d]})),children:W(d,u)},d))}),!l&&e.jsx("div",{className:"border-token-border-default w-full border-[0.5px]"})]})}function ye({documentId:a,title:l,externalUrl:t,noBottomBorder:g=!1,shouldHaveBeenIncluded:u,setShouldHaveBeenIncluded:j}){const h=S.useMemo(()=>{var k;const f=t;if(!f)return q;const b=Q(f);return(k=b==null?void 0:b.Icon)!=null?k:()=>null},[t]),x=S.useMemo(()=>{if(t)try{return new URL(t).hostname}catch(f){return}},[t]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full me-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(h,{className:"icon me-1.5"}),e.jsx("a",{href:t,className:"text-token-primary flex-shrink-1 flex-grow-1 overflow-hidden text-sm text-ellipsis whitespace-nowrap",target:"_blank",rel:"noreferrer",children:l}),x&&e.jsx("div",{className:"text-token-text-secondary ms-2 text-sm",children:x})]}),e.jsx("div",{className:"flex shrink-0 flex-row items-center px-2",children:e.jsx(H,{checked:u,onChange:f=>j==null?void 0:j(f.currentTarget.checked),id:"should-have-been-included-".concat(a)})})]}),!g&&e.jsx("div",{className:"border-token-border-default w-full border-[0.5px]"})]})}function be(a,l){var j,h,x,f,b,k,d,p,C,_,A;const{messageId:t}=l;let g=t;const u=[];for(;g;){const E=a.getNodeByIdOrMessageId(g);if(!E){g=null;break}const n=E.message;if(!n)continue;const y=(j=le(n))!=null?j:"",U=Array.isArray((h=n.metadata)==null?void 0:h.citations)?n.metadata.citations:[],s=Array.isArray((x=n.metadata)==null?void 0:x.attachments)?n.metadata.attachments:[],i={id:String(n.id),author:n.author.role,recipient:(f=n.recipient)!=null?f:"",createTime:n.create_time,updateTime:n.update_time};switch(n.author.role){case D.System:u.push(N(v({},i),{type:"system",content:n.content,citations:U,attachments:s}));break;case D.Assistant:if(n.recipient&&["user","all"].includes(n.recipient)&&y)u.push(N(v({},i),{type:"visible_text",text:y,citations:U,attachments:s}));else if(n.recipient&&n.recipient.includes("file_search")){const o=(k=(b=n.metadata)==null?void 0:b.command)!=null?k:"";let r=[];try{const c=JSON.parse(y);typeof c=="object"&&c!=null&&Array.isArray(c.queries)&&(r=c.queries.map(M=>String(M)))}catch(c){}r?u.push(N(v({},i),{type:"query",command:o,content:n.content,queries:r})):u.push(N(v({},i),{type:"generic_file_search_tool",command:o,content:n.content}))}break;case D.User:(y||s.length>0)&&u.push(N(v({},i),{type:"visible_text",text:y,citations:U,attachments:s}));break;case D.Tool:if((d=n.author.name)!=null&&d.includes("file_search")&&n.recipient==="all"){const o=(C=(p=n.metadata)==null?void 0:p.command)!=null?C:"";if(o==="msearch"&&n.content.content_type===F.TetherBrowsingDisplay){const r=n.content.result,c=(_=n.metadata)==null?void 0:_.cloud_doc_urls;if(r){let M=null;const w=(A=n.metadata)==null?void 0:A.raw_response;if(typeof w=="object"&&w!=null)try{M=ie(w)}catch(T){}u.push(N(v({},i),{type:"result",command:o,content:n.content,result:ce(r,c),searchResponse:M}))}}else o==="context_stuff"&&n.content.content_type===F.TetherQuote?u.push(N(v({},i),{type:"fetch",command:o,content:n.content})):u.push(N(v({},i),{type:"generic_file_search_tool",command:o,content:n.content}))}break}g=E.parentId||null}return l.orderRootToLeaf&&u.reverse(),{messages:u}}const ve="considered-source-should-have-been-used";function we({citations:a,rating:l,onClose:t,messageId:g,conversationId:u,nodeId:j,conversationTree:h}){const x=B(),f=ee(),b=se(),[k,d]=S.useState(""),[p,C]=S.useState(()=>{var i,o;const s={};for(const r of a)((i=r.metadata)==null?void 0:i.type)==="file"&&(s[r.metadata.id]={rating:void 0,tags:[],url:(o=r.metadata.extra)==null?void 0:o.cloud_doc_url});return s}),_=h==null?void 0:h.getNodeByIdOrMessageId(g).message,A=S.useMemo(()=>{var o,r,c,M;const s=new Set,i=[];for(const w of(r=(o=_==null?void 0:_.metadata)==null?void 0:o.citations)!=null?r:[])!w.metadata||w.metadata.type!=="file"||s.has(w.metadata.id)||(i.push(w.metadata),s.add(w.metadata.id));for(const w of(M=(c=_==null?void 0:_.metadata)==null?void 0:c.content_references)!=null?M:[])if(w.type==="file_navlist")for(const T of w.items)s.has(T.id)||(i.push({type:"file",id:T.id,name:T.name,source:"my_files",text:T.description,cloud_doc_url:T.cloud_doc_url,extra:{cloud_doc_url:T.cloud_doc_url}}),s.add(T.id));return i},[_]),[E,n]=S.useState(!0),y=S.useMemo(()=>{const s={hasQuery:!1,lastAssistantMessage:null,lastUserMessage:null,referencedSyncedFiles:[]};if(!h||!j||!h.containsNodeOrMessageId(j))return s;const i=be(h,{messageId:j});for(const o of i.messages)switch(o.type){case"fetch":case"generic_file_search_tool":case"system":continue;case"result":{o.result.chunks.forEach(r=>{r.documentId&&!s.referencedSyncedFiles.some(c=>c.fileId===r.documentId)&&!A.some(c=>c.type==="file"&&c.id===r.documentId)&&s.referencedSyncedFiles.push({fileId:r.documentId,title:r.title,url:r.cloudDocUrl})});continue}case"query":{s.hasQuery=!0;continue}case"visible_text":{if(o.author===D.User){if(!s.lastUserMessage){const r=G(h,o.id),c=r[r.length-1].messages,M=c[c.length-1];s.lastUserMessage=M}}else if(o.author===D.Assistant&&!s.lastAssistantMessage){const r=G(h,o.id),c=r[r.length-1].messages,M=c[c.length-1];s.lastAssistantMessage=M,s.lastUserMessage=null}continue}}return s},[h,A,j]),U=S.useCallback(async s=>{const i=N(v({},s),{additionalSources:k,sourcesFeedback:p,consentedToShareConvoLink:E});try{await te.safePost("/ca/feedback",{requestBody:{feedback_format:b,message_id:g,conversation_id:u,text:i.textFeedback,rating:l,tags:i.tags.map(o=>o.value),tag_choices:i.tagChoices,additional_sources:i.additionalSources,sources_feedback:i.sourcesFeedback,consented_to_share_convo_link:i.consentedToShareConvoLink}}),f.success(x.formatMessage({id:"ZzqQBa",defaultMessage:"Thanks for providing feedback!"})),t()}catch(o){o instanceof ae&&f.danger(x.formatMessage({id:"4d5bOS",defaultMessage:"There was an error submitting your feedback. Please try again later."}))}},[k,p,E,b,g,u,l,f,x,t]);return e.jsxs(de,{multiple:!0,allowEmptySubmit:!0,onSubmit:U,onCancel:t,tagOptions:P(l==="thumbsDown"?me:fe,x),modalOnly:!0,modalTitle:e.jsxs("div",{className:"flex items-center gap-2",children:[l==="thumbsDown"?e.jsx(V,{className:"mb-[-6px]"}):e.jsx(z,{className:"mb-[-6px]"}),e.jsx(I,{id:"h5nasL",defaultMessage:"Provide feedback"})]}),children:[A.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(I,{id:"G6+7UX",defaultMessage:"Sources"})}),e.jsx("div",{children:A.map((s,i)=>(s==null?void 0:s.type)!=="file"?null:e.jsx(pe,{citationMetadata:s,noBottomBorder:i===A.length-1,sourceFeedback:p[s.id],setSourceFeedback:o=>C(r=>{var c;return N(v({},r),{[s.id]:N(v({},o),{url:(c=s.extra)==null?void 0:c.cloud_doc_url})})})},s.id))})]}),y.referencedSyncedFiles.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 flex items-baseline justify-between",children:[e.jsxs("div",{className:"flex-start flex",children:[e.jsx("h3",{className:"text-base font-semibold",children:e.jsx(I,{id:"xvBe/T",defaultMessage:"Considered Sources"})}),e.jsx("p",{className:"text-token-text-secondary ms-2",children:e.jsx(I,{id:"nX81fN",defaultMessage:"({numSources} sources)",values:{numSources:y.referencedSyncedFiles.length}})})]}),e.jsx("p",{className:"text-token-text-tertiary text-sm",children:e.jsx(I,{id:"0+Uivl",defaultMessage:"Good Source?"})})]}),e.jsx("div",{className:"mt-2 max-h-[200px] overflow-auto",children:y.referencedSyncedFiles.map((s,i)=>e.jsx(ye,{title:s.title,documentId:s.fileId,externalUrl:s.url,noBottomBorder:i===y.referencedSyncedFiles.length-1,shouldHaveBeenIncluded:!!p[s.fileId],setShouldHaveBeenIncluded:o=>C(r=>{const c=v({},Object.fromEntries(Object.entries(r).filter(([M])=>M!==s.fileId)));return o&&(c[s.fileId]={tags:[ve],rating:"thumbsUp",url:s.url}),c})},s.fileId))})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("p",{className:"text-token-text-primary text-sm",children:e.jsx(I,{id:"1ApJVo",defaultMessage:"Add any additional sources"})}),e.jsx(ue,{name:"feedback",className:"mt-2",placeholder:x.formatMessage({id:"CAFeedbackModal.additionalSourcePlaceholder",defaultMessage:"(Optional) Additional sources"}),value:k,onChange:s=>d(s.target.value)})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"mb-2 text-base font-semibold",children:e.jsx(I,{id:"9NcQBu",defaultMessage:"Latest Exchange"})}),e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"mb-4",children:[y.lastUserMessage&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-token-text-secondary mb-1 ps-4 text-xs",children:e.jsx(I,{id:"QTWrtR",defaultMessage:"Your message"})}),e.jsx("div",{className:"flex justify-start",children:e.jsx("p",{className:"dark:bg-token-main-surface-secondary relative max-w-[var(--user-chat-width,70%)] rounded-3xl bg-[#f4f4f4] px-5 py-2.5",children:y.lastUserMessage?e.jsx(L,{message:y.lastUserMessage,isCompletionInProgress:!1,hasActiveRequest:!1,clientThreadId:u,isFinalUserTurn:!1,isUserTurn:!1,turnIndex:0,isFeedbackEnabled:!1}):null})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("p",{className:"text-token-text-secondary mb-1 ps-4 text-xs",children:e.jsx(I,{id:"ZCTm4h",defaultMessage:"ChatGPT's response"})}),e.jsx("div",{className:"bg-token-main-surface-secondary relative rounded-lg p-4 text-sm",children:y.lastAssistantMessage?e.jsx(L,{message:y.lastAssistantMessage,isCompletionInProgress:!1,hasActiveRequest:!1,clientThreadId:u,isFinalUserTurn:!1,isUserTurn:!1,turnIndex:1,isFeedbackEnabled:!1}):null})]})]})}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(I,{id:"c95uEW",defaultMessage:"Full conversation"})}),e.jsx("p",{className:"text-token-text-secondary mt-1 mb-2 text-sm",children:e.jsx(I,{id:"3E3ZSm",defaultMessage:"If previous portions of this conversation are important to understand your feedback, we encourage you to include it."})}),e.jsx(H,{id:"consented-to-share-entire-convo",label:x.formatMessage({id:"5CC8r8",defaultMessage:"Share Entire Conversation"}),checked:E,onChange:s=>{n(s.currentTarget.checked)}})]})]})]})}export{we as C,ve as a,W as g};
//# sourceMappingURL=l28b6esn94dmjzbx.js.map

const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ond9wpwgalpt07e1.js","assets/jj85rqzpbnvv3emr.js","assets/k6xevgslgqxumalm.js","assets/lef5ym39glv4981l.js","assets/root-ogjlcpyy.css","assets/h0u5robawxnqftug.js","assets/mclphevd122040jw.js","assets/conversation-small-g7l5datj.css","assets/hcsjwjl2ji65i21r.js","assets/ogcl7v93rii15rrg.js","assets/ansi-1f6vhsjh.css","assets/beyyb659nwss2eea.js","assets/d9xs85pwcfjntwwg.js","assets/ef92qx749w9klz4o.js","assets/kxedrjbxv2qblujd.js","assets/oz589d7sqtxcbljf.js","assets/lptwpbjabrvjmhsj.js","assets/d488vdccsjfd5637.js","assets/lj9gcg948eq0zvwr.js","assets/fzrn137102spawew.js","assets/c631j8z7keqfibnl.js","assets/jt0fc5oel309hgy2.js","assets/l45tzjfw41ny1oxj.js","assets/2dhqllc5pireni9q.js","assets/jza9spsuu2f7ynxb.js","assets/ht7of10t76s6p5h9.js","assets/efsl2tpd3w39q64v.js","assets/f3wj76d1ulqyss85.js","assets/hzcock7l6ec8fnr2.js","assets/fue7kd61xxcv74sk.js","assets/nel1ztt16rssielp.js","assets/wham-task-page-content-layout-ihk5sr3r.css","assets/lbaueofbjv8jfqwm.js","assets/kir2grr1yju5p5db.js","assets/kkl7694f44ns8yp6.js","assets/nk7ydxm8ptxusvbt.js","assets/k059n59kmbyb9lsl.js","assets/ojb4d4bxj44fs0l8.js","assets/i40tl4cuke87hmzs.js","assets/bx2wdn43543b9ysc.js","assets/n5wrqpcxv1sjah44.js"])))=>i.map(i=>d[i]);
var Lt=Object.defineProperty,Rt=Object.defineProperties;var Dt=Object.getOwnPropertyDescriptors;var st=Object.getOwnPropertySymbols;var Et=Object.prototype.hasOwnProperty,Ot=Object.prototype.propertyIsEnumerable;var rt=(a,e,o)=>e in a?Lt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[e]=o,U=(a,e)=>{for(var o in e||(e={}))Et.call(e,o)&&rt(a,o,e[o]);if(st)for(var o of st(e))Ot.call(e,o)&&rt(a,o,e[o]);return a},Ie=(a,e)=>Rt(a,Dt(e));import{e$ as xt,e as ye,E as wt,x as Bt,fw as qt,eE as ne,gn as Wt,ex as _t,ey as vt,C as Ht,B as ke,f as Se,dJ as Ut,gG as Gt,i as Ue,j as je,iK as Qt,rX as Kt,gz as Vt,R as tt,eN as Ge,aE as $t,t2 as zt,T as bt,i6 as Me,af as Yt,p as Xt,nR as Jt,aI as Zt}from"./lef5ym39glv4981l.js";import{r as g,j as t,b as pe,M as I,c as At,g as at,m as yt,a as Pe,f as Tt,u as Qe,A as ea,d as ta,h as aa}from"./jj85rqzpbnvv3emr.js";import{bb as oa,gW as ia,kt as qe,ku as Je,cA as sa,N as Ze,au as ra,k1 as na,uY as la,w as nt,j$ as da,k0 as ca,av as Ke,a4 as ua,vF as Ve,bv as ha,ds as ma,uW as lt,uX as dt,vG as fa,vH as pa,lm as ga,dn as xa}from"./mclphevd122040jw.js";import{M as $e,c as Ae,W as wa,I as _a,f as va,p as Oe,d as ba,e as ct,a as ya,h as ka}from"./k6xevgslgqxumalm.js";import{U as Le,l as kt,q as Ca,c as We,o as Ct,V as Ma,W as ue,k as Te,w as et,h as ja,g as _e,m as He,X as Re,j as Pa,u as Sa,b as Ia}from"./ef92qx749w9klz4o.js";import{u as Na}from"./lbaueofbjv8jfqwm.js";import{T as Fa,a as La,b as Ra}from"./nel1ztt16rssielp.js";import{a as ut,S as Da}from"./kir2grr1yju5p5db.js";import{S as Ea}from"./kkl7694f44ns8yp6.js";import{u as Oa,c as ot,W as Ba,d as Mt}from"./jt0fc5oel309hgy2.js";import{d as qa,g as Wa,N as Ha}from"./nk7ydxm8ptxusvbt.js";import{W as ht,D as Ne,O as Ua}from"./i40tl4cuke87hmzs.js";import{s as Be,B as Ga}from"./bx2wdn43543b9ysc.js";const jt=g.createContext(null);function Uo({value:a,children:e}){return t.jsx(jt.Provider,{value:a,children:e})}function De(){const a=g.useContext(jt);if(!a)throw new Error("useWhamTaskPageContext must be used within its provider");return a}function Qa(a){var l,u;const e={},o={};let i;for(const n of a)Le(n)?n.previous_turn_id?o[n.previous_turn_id]=n:i=n:n.previous_turn_id&&((u=e[l=n.previous_turn_id])!=null?u:e[l]=[]).push(n);if(!i)return null;const r=n=>{var d;const c=(d=e[n.id])!=null?d:[],s={};for(const h of c){const x=o[h.id];x&&(s[h.id]=r(x))}return{userTurn:n,assistantTurns:c,children:s}};return r(i)}function Ka(a){for(let e=a.length-1;e>=0;e--){const o=a[e];if(Le(o)&&o.previous_turn_id)return o.previous_turn_id}return null}function Va(a,e){var r,l,u,n;if(!a)return[];const o=[];if(e){const c=d=>{for(const h of d.assistantTurns){if(h.id===e)return[{node:d,activeId:h.id}];const x=d.children[h.id],w=x&&c(x);if(w)return[{node:d,activeId:h.id},...w]}return null},s=c(a);s&&o.push(...s)}o.length===0&&o.push({node:a,activeId:(l=(r=a.assistantTurns[0])==null?void 0:r.id)!=null?l:null});let i=o[o.length-1];for(;i!=null&&i.activeId;){const c=i.node.children[i.activeId];if(!c)break;o.push({node:c,activeId:(n=(u=c.assistantTurns[0])==null?void 0:u.id)!=null?n:null}),i=o[o.length-1]}return o}function $a(a){return a==null?void 0:a.assistantTurns.some(e=>kt(e.turn_status))}function za({className:a,focusedAssistantTurn:e,currentTab:o,permissions:i,task:r,turns:l,containerHeight:u,onClickFile:n,setFocusedAssistantTurnId:c,onTabChange:s,latestTurnRef:d,latestUserMessageRef:h,hasComments:x,clearComments:w,showFullDiff:p,loadingTurnMapping:m,reserveComposerSpace:y=!0}){var G;g.useEffect(()=>{if(!e){const j=Ka(l);j&&c(j)}},[e,l,c]);const v=g.useMemo(()=>Qa(l),[l]),C=g.useMemo(()=>{var j;return Va(v,(j=e==null?void 0:e.id)!=null?j:null)},[v,e==null?void 0:e.id]),W=C.length-1,H=C.slice(0,W),B=xt(C),D=y&&$a(B==null?void 0:B.node),{data:f}=Ca(r==null?void 0:r.id),M=g.useMemo(()=>{var Z,te,V;if(!m||!(f!=null&&f.current_assistant_turn))return null;const j=f.current_assistant_turn,Q=((te=(Z=j.sibling_turn_ids)==null?void 0:Z.length)!=null?te:0)+1,K=(V=j.attempt_placement)!=null?V:0,J=Array.from({length:Q},(O,q)=>q===K?j.id:"placeholder-".concat(q)),E={};return J.forEach((O,q)=>E[O]=q),{attemptIds:J,idToIdxMap:E}},[m,f==null?void 0:f.current_assistant_turn]);return t.jsx("div",{className:ye("relative flex h-full w-full flex-col",a),children:t.jsx("div",{className:"flex h-fit min-h-full shrink-0 flex-col gap-6 pt-6 text-sm",children:m&&r&&(f!=null&&f.current_user_turn)&&(f!=null&&f.current_assistant_turn)?t.jsxs("div",{ref:d,className:ye("flex min-h-full shrink-0 flex-col gap-6",D&&"pb-36"),style:{minHeight:u-24},children:[t.jsx("div",{className:"text-token-text-secondary flex w-full items-center justify-center gap-2",children:t.jsx(wt,{className:"text-xl"})}),t.jsx($e,{isLatest:!0,task:r,userTurn:f.current_user_turn,assistantTurns:[f.current_assistant_turn],selectedAssistantId:f.current_assistant_turn.id,focusedAssistantTurn:f.current_assistant_turn,setFocusedAssistantTurnId:c,onClickFile:n,currentTab:o,onTabChange:s,permissions:i,startOpen:!0,hasComments:x,clearComments:w,showFullDiff:p,attemptIdsOverride:M==null?void 0:M.attemptIds,idToIndexMapOverride:M==null?void 0:M.idToIdxMap,latestUserMessageRef:h})]}):t.jsxs(t.Fragment,{children:[H.length>0&&t.jsx("div",{className:"flex flex-col gap-6",children:H.map(({node:j,activeId:Q},K)=>t.jsx($e,{isLatest:K===W,task:r,userTurn:j.userTurn,assistantTurns:j.assistantTurns,selectedAssistantId:Q,focusedAssistantTurn:e,setFocusedAssistantTurnId:c,onClickFile:n,startOpen:K===W,currentTab:o,onTabChange:s,permissions:i,hasComments:x,clearComments:w,showFullDiff:p},j.userTurn.id))}),B&&t.jsx("div",{ref:d,className:ye("flex min-h-full shrink-0 flex-col gap-6",D&&"pb-36"),style:{minHeight:u-24},children:t.jsx($e,{isLatest:!0,task:r,userTurn:B.node.userTurn,assistantTurns:B.node.assistantTurns,selectedAssistantId:(G=e==null?void 0:e.id)!=null?G:null,focusedAssistantTurn:e,setFocusedAssistantTurnId:c,onClickFile:n,currentTab:o,onTabChange:s,permissions:i,startOpen:!0,hasComments:x,clearComments:w,showFullDiff:p,latestUserMessageRef:h})})]})})})}const Pt=g.createContext(null);function Go({value:a,children:e}){return t.jsx(Pt.Provider,{value:a,children:e})}function it(){const a=g.useContext(Pt);if(!a)throw new Error("useTaskComments must be used within a TaskCommentsProvider");return a}function Ya({currentTab:a,permissions:e,onClickFile:o,onTabChange:i,showFullDiff:r,loadingTurnMapping:l,footer:u}){const{task:n,focusedAssistantTurn:c,pastTurns:s,setFocusedAssistantTurnId:d}=De(),{comments:h,clearComments:x}=it(),[{height:w},p]=Na(),m=g.useRef(null),y=g.useRef(null),v=g.useRef(null);return Bt(()=>{const C=m.current,W=v.current;!C||!W||!C.contains(W)||W.scrollIntoView({block:"start",behavior:"auto"})},[s.length,l]),t.jsx("div",{ref:oa(p,m),className:"flex h-full w-full scroll-pt-3 flex-col items-center overflow-y-auto px-6",children:t.jsxs("div",{className:ye("@container w-full",Ae),children:[t.jsx(za,{focusedAssistantTurn:c,currentTab:a,permissions:e,task:n,turns:s,containerHeight:w,onClickFile:o,setFocusedAssistantTurnId:d,onTabChange:i,latestTurnRef:y,latestUserMessageRef:v,hasComments:h.length>0,clearComments:x,showFullDiff:r,loadingTurnMapping:l,reserveComposerSpace:u!=null}),u&&t.jsx("div",{className:"keyboard-open:fixed absolute start-0 end-0 bottom-0",children:u})]})})}function Xa({unifiedDiff:a,setUnifiedDiff:e,showFullDiff:o,setShowFullDiff:i}){const r=pe(),[l,u]=g.useState(!1);return t.jsxs(qt,{open:l,onOpenChange:u,contentAlign:"end",sideOffset:8,modal:!0,triggerButton:t.jsx("button",{type:"button",onClick:()=>u(!0),className:"hover:bg-token-border-light flex items-center justify-center rounded p-3","aria-label":r.formatMessage({id:"wham.diffModeDropdown.openMenu",defaultMessage:"Open diff settings menu"}),children:t.jsx(ut,{className:"icon"})}),children:[t.jsxs(ne.RadioGroup,{value:a?"unified":"split",onValueChange:n=>e(n==="unified"),onClick:n=>n.stopPropagation(),children:[t.jsx(ne.RadioItem,{value:"split",onClick:n=>n.stopPropagation(),children:t.jsxs("div",{className:"text-token-text-primary flex items-center gap-3",children:[t.jsx(ut,{className:"icon"}),t.jsx(I,{id:"wham.message.modal.footer.splitDiff",defaultMessage:"Split diff"})]})}),t.jsx(ne.RadioItem,{value:"unified",onClick:n=>n.stopPropagation(),children:t.jsxs("div",{className:"text-token-text-primary flex items-center gap-3",children:[t.jsx(Da,{className:"icon"}),t.jsx(I,{id:"wham.message.modal.footer.unifiedDiff",defaultMessage:"Unified diff"})]})})]}),t.jsx(ne.Separator,{}),t.jsxs(ne.RadioGroup,{value:o?"full":"latest",onValueChange:n=>i(n==="full"),onClick:n=>{n.stopPropagation()},children:[t.jsx(ne.RadioItem,{value:"full",children:t.jsx(I,{id:"wham.copyFile.showFullDiff",defaultMessage:"Full diff"})}),t.jsx(ne.RadioItem,{value:"latest",children:t.jsx(I,{id:"wham.copyFile.showLatestCommit",defaultMessage:"Incremental diff"})})]})]})}function Ja({previewImages:a}){var d;const e=pe(),o=ia(a.map(h=>{var x,w,p,m;return{content_type:Wt.ImageAssetPointer,asset_pointer:(x=h.asset_pointer)!=null?x:"",size_bytes:(w=h.size_bytes)!=null?w:0,width:(p=h.width)!=null?p:0,height:(m=h.height)!=null?m:0}})),i=g.useMemo(()=>o.filter(h=>h.data),[o]),[r,l]=g.useState(0),u=Math.min(Math.max(r,0),Math.max(i.length-1,0)),n=g.useCallback(()=>{i.length<=1||(l(h=>(h-1+i.length)%i.length),We.recordPreviewImagesCarouselPrev())},[i.length]),c=g.useCallback(()=>{i.length<=1||(l(h=>(h+1)%i.length),We.recordPreviewImagesCarouselNext())},[i.length]);Ct([{key:"previewCarouselPrev",action:n,actionMessageDescriptor:e.formatMessage({id:"wham.keyboardActions.previousPreviewImage",defaultMessage:"Select previous image"}),group:Je.Chat,keyboardBinding:[qe.ArrowLeft],enabled:i.length>1},{key:"previewCarouselNext",action:c,actionMessageDescriptor:e.formatMessage({id:"wham.keyboardActions.nextPreviewImage",defaultMessage:"Select next image"}),group:Je.Chat,keyboardBinding:[qe.ArrowRight],enabled:i.length>1}]);const s=(d=i[u])==null?void 0:d.data;return t.jsxs("div",{className:"relative flex h-full w-full items-center justify-center overflow-hidden p-4",children:[s?t.jsx("img",{src:s.url,width:s.width,height:s.height,alt:e.formatMessage({id:"wham.whamTaskPageContentLoaded.previewImageAlt",defaultMessage:"Generated image"}),className:"max-h-full max-w-full object-contain"},u):t.jsx("div",{className:"text-secondary text-sm",children:e.formatMessage({id:"wham.whamPreviewImageCarousel.loading",defaultMessage:"Loading preview…"})}),i.length>1&&t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button","aria-label":e.formatMessage({id:"wham.whamPreviewImageCarousel.prev",defaultMessage:"Previous image"}),onClick:n,className:"absolute start-2 top-1/2 -translate-y-1/2 rounded-md bg-black/40 px-2 py-1 text-white hover:bg-black/60 focus:ring-2 focus:ring-white/70 focus:outline-none",children:"‹"}),t.jsx("button",{type:"button","aria-label":e.formatMessage({id:"wham.whamPreviewImageCarousel.next",defaultMessage:"Next image"}),onClick:c,className:"absolute end-2 top-1/2 -translate-y-1/2 rounded-md bg-black/40 px-2 py-1 text-white hover:bg-black/60 focus:ring-2 focus:ring-white/70 focus:outline-none",children:"›"}),t.jsxs("div",{className:"pointer-events-none absolute start-1/2 bottom-2 -translate-x-1/2 rounded-md bg-black/40 px-2 py-0.5 text-xs text-white",children:[u+1," / ",i.length]})]})]})}const St=_t(()=>vt(()=>import("./ond9wpwgalpt07e1.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40])).then(a=>a.WhamTaskPageCodeDiffContent),{loading:()=>t.jsx("div",{className:"flex-1"})});function Za(a){"use forget";var re,ve;const e=At.c(97),{currentTab:o,setCurrentTab:i,defaultTab:r,isMobile:l,hasDiff:u,previewImages:n,diffFiles:c,unifiedDiff:s,handleDiffModeChange:d,showFullDiff:h,setShowFullDiff:x,isPreferencesLoading:w,isSharedExampleTask:p,focusedAssistantTurn:m,leftContent:y}=a,{taskId:v,task:C,canFollowUp:W,pastTurns:H}=De(),{comments:B,setComments:D}=it(),f=pe();let M;e[0]!==w?(M=[w],e[0]=w,e[1]=M):M=e[1],g.useEffect(eo,M);let G;e:{if(!m){G=null;break e}let _;e[2]!==H?(_=H!=null?H:[],e[2]=H,e[3]=_):_=e[3];const z=_,ge=z.findIndex(X=>X.id===m.id);if(ge>0)for(let X=ge-1;X>=0;X=X-1,X){const we=z[X];if(Le(we)){G=we;break e}}if(m.previous_turn_id){let X;if(e[4]!==m.previous_turn_id||e[5]!==z){let be;e[7]!==m.previous_turn_id?(be=Ee=>Le(Ee)&&Ee.id===m.previous_turn_id,e[7]=m.previous_turn_id,e[8]=be):be=e[8],X=z.find(be),e[4]=m.previous_turn_id,e[5]=z,e[6]=X}else X=e[6];const we=X;if(we){G=we;break e}}let xe;e[9]!==z?(xe=[...z].reverse().find(Ta),e[9]=z,e[10]=xe):xe=e[10];const Y=xe;G=Y!=null?Y:null}const j=G,Q=(re=m==null?void 0:m.id)!=null?re:v,K=!l;let J;e[11]!==f?(J=f.formatMessage({id:"wham.whamTaskPageContentLoaded.conversation",defaultMessage:"Conversation"}),e[11]=f,e[12]=J):J=e[12];let E;e[13]!==f?(E=f.formatMessage({id:"wham.whamTaskPageContentLoaded.conversationAriaLabel",defaultMessage:"Tab to view the conversation with the assistant"}),e[13]=f,e[14]=E):E=e[14];let Z;e[15]!==y||e[16]!==K||e[17]!==J||e[18]!==E?(Z={key:"chat",isHidden:K,label:J,ariaLabel:E,children:y},e[15]=y,e[16]=K,e[17]=J,e[18]=E,e[19]=Z):Z=e[19];const te=n.length===0;let V;e[20]!==f?(V=f.formatMessage({id:"wham.whamTaskPageContentLoaded.preview",defaultMessage:"Preview"}),e[20]=f,e[21]=V):V=e[21];let O;e[22]!==f?(O=f.formatMessage({id:"wham.whamTaskPageContentLoaded.previewAriaLabel",defaultMessage:"Tab to view preview images"}),e[22]=f,e[23]=O):O=e[23];let q;e[24]!==n?(q=t.jsx(Ja,{previewImages:n}),e[24]=n,e[25]=q):q=e[25];let he;e[26]!==O||e[27]!==q||e[28]!==te||e[29]!==V?(he={key:"preview",isHidden:te,label:V,ariaLabel:O,children:q},e[26]=O,e[27]=q,e[28]=te,e[29]=V,e[30]=he):he=e[30];const me=!u;let le;e[31]!==f?(le=f.formatMessage({id:"wham.whamTaskPageContentLoaded.diff",defaultMessage:"Diff"}),e[31]=f,e[32]=le):le=e[32];let de;e[33]!==f?(de=f.formatMessage({id:"wham.whamTaskPageContentLoaded.diffAriaLabel",defaultMessage:"Tab to view the code diff"}),e[33]=f,e[34]=de):de=e[34];let ae;e[35]!==W||e[36]!==B||e[37]!==c||e[38]!==u||e[39]!==w||e[40]!==D||e[41]!==s?(ae=!w&&u&&t.jsx(St,{diffFiles:c,unifiedDiff:s,enableComments:W,comments:B,setComments:D}),e[35]=W,e[36]=B,e[37]=c,e[38]=u,e[39]=w,e[40]=D,e[41]=s,e[42]=ae):ae=e[42];let oe;e[43]!==me||e[44]!==le||e[45]!==de||e[46]!==ae?(oe={key:"diff",isHidden:me,label:le,ariaLabel:de,children:ae},e[43]=me,e[44]=le,e[45]=de,e[46]=ae,e[47]=oe):oe=e[47];let ie;e[48]!==f?(ie=f.formatMessage({id:"wham.whamTaskPageContentLoaded.logs",defaultMessage:"Logs"}),e[48]=f,e[49]=ie):ie=e[49];let A;e[50]!==f?(A=f.formatMessage({id:"wham.whamTaskPageContentLoaded.logsAriaLabel",defaultMessage:"Tab to view the work logs"}),e[50]=f,e[51]=A):A=e[51];const ce=(ve=m==null?void 0:m.environment)==null?void 0:ve.agent_network_access;let T;e[52]!==m||e[53]!==ce||e[54]!==v?(T=t.jsx(wa,{taskId:v,focusedAssistantTurn:m,agentNetworkAccess:ce}),e[52]=m,e[53]=ce,e[54]=v,e[55]=T):T=e[55];let P;e[56]!==p||e[57]!==ie||e[58]!==A||e[59]!==T?(P={key:"logs",isHidden:p,label:ie,ariaLabel:A,children:T},e[56]=p,e[57]=ie,e[58]=A,e[59]=T,e[60]=P):P=e[60];let L;e[61]!==f?(L=f.formatMessage({id:"wham.whamTaskPageContentLoaded.internalDataModels",defaultMessage:"Internal Data Models"}),e[61]=f,e[62]=L):L=e[62];let N;e[63]!==f?(N=f.formatMessage({id:"wham.whamTaskPageContentLoaded.internalDataModelsAriaLabel",defaultMessage:"Tab to view internal data models"}),e[63]=f,e[64]=N):N=e[64];const fe=m==null?void 0:m.internal_only_rollouts;let ee;e[65]!==m||e[66]!==fe||e[67]!==C||e[68]!==j?(ee=t.jsx(_a,{task:C,userTurn:j,assistantTurn:m,rollout:fe}),e[65]=m,e[66]=fe,e[67]=C,e[68]=j,e[69]=ee):ee=e[69];let se;e[70]!==L||e[71]!==N||e[72]!==ee?(se={key:"internal_data_models",isHidden:!0,label:L,ariaLabel:N,children:ee},e[70]=L,e[71]=N,e[72]=ee,e[73]=se):se=e[73];let $;e[74]!==he||e[75]!==oe||e[76]!==P||e[77]!==se||e[78]!==Z?($=[Z,he,oe,P,se],e[74]=he,e[75]=oe,e[76]=P,e[77]=se,e[78]=Z,e[79]=$):$=e[79];let b;e[80]!==d||e[81]!==u||e[82]!==x||e[83]!==h||e[84]!==s?(b=u&&t.jsx(Xa,{unifiedDiff:s,setUnifiedDiff:d,showFullDiff:h,setShowFullDiff:x}),e[80]=d,e[81]=u,e[82]=x,e[83]=h,e[84]=s,e[85]=b):b=e[85];let S;e[86]!==l||e[87]!==b?(S=t.jsx(Fa,{withUnderline:l,className:"items-center border-b p-3 pe-16 max-md:py-0",children:b}),e[86]=l,e[87]=b,e[88]=S):S=e[88];let k;e[89]===Symbol.for("react.memo_cache_sentinel")?(k=t.jsx(La,{children:Aa}),e[89]=k):k=e[89];let R;return e[90]!==o||e[91]!==r||e[92]!==i||e[93]!==$||e[94]!==Q||e[95]!==S?(R=t.jsx("div",{className:"relative flex h-full w-full flex-col",children:t.jsxs(Ra,{onChange:i,currentTab:o,defaultTab:r,tabs:$,children:[S,k]},Q)}),e[90]=o,e[91]=r,e[92]=i,e[93]=$,e[94]=Q,e[95]=S,e[96]=R):R=e[96],R}function Aa(a){const{content:e}=a;return t.jsx("div",{className:"flex h-full w-full",children:e})}function Ta(a){return Le(a)}function eo(){St.prefetch()}function to({isOpen:a,onConfirm:e,onClose:o,loading:i}){return t.jsx(Ht,{isOpen:a,onClose:o,testId:"modal-wham-retry-all-turns",type:"warning",title:t.jsx("p",{className:"text-token-text-primary font-semibold",children:t.jsx(I,{id:"wham.retryAllTurnsModal.title",defaultMessage:"Retry all turns"})}),primaryButton:t.jsx(ke,{color:"primary",loading:i,onClick:e,children:t.jsx(I,{id:"wham.retryAllTurnsModal.confirm",defaultMessage:"Retry all turns"})}),secondaryButton:t.jsx(ke,{color:"secondary",onClick:o,children:t.jsx(I,{id:"wham.retryAllTurnsModal.cancel",defaultMessage:"Cancel"})}),children:t.jsx("div",{className:"text-sm",children:t.jsx(I,{id:"wham.retryAllTurnsModal.message",defaultMessage:"All latest turns will restart, including any siblings turns that are in progress or completed."})})})}function ao({focusedAssistantTurn:a,lastTurn:e,siblings:o}){const i=(e==null?void 0:e.type)==="assistant"?e.turn_status:"completed";return a&&((e==null?void 0:e.id)===a.id||o.some(l=>l.id===(e==null?void 0:e.id)))?a.turn_status:i}function oo({turnId:a,comments:e,clearComments:o,lastTurn:i,focusedAssistantTurn:r,retry:l,attemptIndex:u,siblings:n}){var oe,ie,A,ce,T;const{taskId:c,task:s,setFocusedAssistantTurnId:d}=De(),h=at(),x=pe(),w=Se(),p=Ut(),m=Gt(),y=Oa(),v=P=>{Kt(Vt(m)),o(),d(P.turn.id)},C=async()=>{var P,L;if(l){M(!0);try{if(l.previousTurnId){const N=await ue.createFollowUpTask(c,l.previousTurnId,l.prompt,(P=l.comments)!=null?P:[],!1,E?(L=l.bestOfN)!=null?L:1:void 0,y?l.attachments:[]);v(N)}else{const N=await ue.createNewTask(l.environmentId,l.branch,l.prompt,!1,E?l.bestOfN:void 0,y?l.attachments:[]);h("/codex/tasks/".concat(N.task.id))}j(!1)}catch(N){N instanceof Te?et(N,a,x,w):w.danger({id:"wham.whamTaskPageFooter.errorRetryingTask",defaultMessage:"Error retrying task",description:"Error retrying task"},{toastId:"wham_task_page_footer_error_retrying_task"})}finally{M(!1)}}},W=!!r&&ot(r.output_items).outputDiffs.length>0,H=!i||!r||i.id===(r==null?void 0:r.id)||!W,B=l&&H&&(r==null?void 0:r.turn_status)==="failed",D=(r==null?void 0:r.previous_turn_id)&&(i==null?void 0:i.type)==="assistant"&&r.previous_turn_id===i.previous_turn_id,[f,M]=g.useState(!1),[G,j]=g.useState(!1),Q=Ue(),K=je(Q,"1406552515"),J=je(Q,"879591222")||void 0,E=je(Q,"3492040717"),Z=g.useMemo(()=>{var N,fe,ee,se,$,b,S;const P=[...(ee=(fe=(N=r==null?void 0:r.output_items)==null?void 0:N.find(k=>k.type==="review"))==null?void 0:fe.suggested_followup_tasks)!=null?ee:[],...($=(se=r==null?void 0:r.output_items)==null?void 0:se.filter(k=>k.type==="suggested_task"))!=null?$:[]],L=va((S=(b=r==null?void 0:r.child_turns)==null?void 0:b.filter(k=>k.source.type==="suggested_task"))==null?void 0:S.map(k=>[k.source.suggested_task_id,k]));return P.map(k=>{var R,re,ve,_;return{suggestion:k,userTurnId:k.id&&(re=(R=L[k.id])==null?void 0:R.assistant_turn_id)!=null?re:null,assistantTurnId:k.id&&(_=(ve=L[k.id])==null?void 0:ve.user_turn_id)!=null?_:null}})},[r]),te=(oe=r==null?void 0:r.id)!=null?oe:a,V=g.useMemo(()=>{var P,L;return(L=(P=r==null?void 0:r.output_items)==null?void 0:P.filter(Ma))!=null?L:[]},[r]),O=g.useMemo(()=>V.reduce((P,L)=>P+L.comments.filter(N=>N.priority===0||N.priority===1).length,0),[V]),q=((A=(ie=s==null?void 0:s.task_status_display)==null?void 0:ie.latest_turn_status_display)==null?void 0:A.intent)==="cr",he=(H||D)&&V.length>0,me=qa({taskId:c,latestTurnId:te}),le=me.isPending||!te||O===0||K,de=ao({focusedAssistantTurn:r,lastTurn:i,siblings:n}),ae=(ce=n==null?void 0:n.map(P=>P.turn_status))!=null?ce:[];return(i==null?void 0:i.type)==="assistant"&&["pending","in_progress"].includes(i.turn_status)&&!J?null:t.jsxs(t.Fragment,{children:[t.jsxs("div",{id:"wham-message-modal-footer",className:"z-50 flex w-full justify-center",children:[(H||D)&&t.jsx("div",{className:"flex w-full justify-center px-4",children:t.jsx("div",{className:ye("relative z-1 flex w-full flex-col pt-2 pb-4",Ae),children:B?t.jsx(ke,{className:"w-full",color:"primary",size:"large",loading:f&&!G,onClick:()=>{var P;((P=l==null?void 0:l.bestOfN)!=null?P:1)>1?j(!0):C()},children:((T=l.bestOfN)!=null?T:1)>1?x.formatMessage({id:"wham.whamTaskPageFooter.retryAllTurns",defaultMessage:"Retry all turns"}):x.formatMessage({id:"wham.whamTaskPageFooter.retry",defaultMessage:"Retry"})}):he?t.jsxs("div",{className:"flex w-full flex-col gap-3",children:[t.jsx(ht,{}),t.jsx(ke,{className:"w-full",color:"primary",size:"large",disabled:le,loading:me.isPending,onClick:()=>{le||me.mutateAsync(void 0)},children:t.jsx(I,{id:"wham.whamTaskPageFooter.fixIssues",defaultMessage:"{count, plural, one {Fix issue} other {Fix issues}}",values:{count:O}})})]}):o&&!q&&t.jsxs("div",{className:"flex w-full flex-col gap-3",children:[t.jsx(ht,{}),!K&&t.jsx(Ba,{disableAutoFocus:!0,disableDuringSubmit:!0,onSuccess:v,onClearComments:o,followUp:{taskId:c,turnId:a,comments:e,turnStatus:de,siblingTurnStatuses:ae,followUpSuggestions:Z},attemptIndex:u,ariaLabel:x.formatMessage({id:"wham.whamTaskPageFooter.composerAriaLabel",defaultMessage:"Composer to enter a follow up prompt to the task"})})]})})}),!H&&!D&&t.jsx(yt.div,{layout:!0,className:ye("dark mx-6 mb-6 w-full",Ae),initial:{opacity:0,translateY:10},animate:{opacity:1,translateY:0},exit:{opacity:0,translateY:10},transition:{duration:p?0:.25},children:t.jsx(Qt,{title:t.jsx(I,{id:"wham.whamTaskPageFooter.previousTurn",defaultMessage:"You are viewing a previous turn"}),primaryCtaText:t.jsx(I,{id:"wham.whamTaskPageFooter.viewLatestTurn",defaultMessage:"View latest"}),content:t.jsx(I,{id:"wham.whamTaskPageFooter.followUpsLatestTurn",defaultMessage:"Follow-ups are only available for the latest turn"}),icon:t.jsx(Ea,{className:"icon"}),onPrimaryCtaClick:()=>d(i.id)})})]}),t.jsx(to,{isOpen:G,onClose:()=>j(!1),onConfirm:C,loading:f})]})}const It=window.location.origin+"/s/";function io(a){return"".concat(It).concat(a)}function Nt(a){var e,o;return!a||!a.attachments||a.attachments.length===0||a.attachments[0].kind!=="codex"?null:{postId:a.id,permalink:(e=a.permalink)!=null?e:io(a.id),permissions:(o=a.permissions.share_setting)!=null?o:"public",codexTask:a.attachments[0].task,codexTurn:a.attachments[0].turns}}function Fe(a){return["codex_tasks","result","share",a]}function so({taskId:a,enabled:e}){return Tt({enabled:!!a&&e,queryKey:Fe(a),queryFn:async()=>{const o=await tt.safeGet("/share/post/by_codex_task/{codex_task_id}",{parameters:{path:{codex_task_id:a}}});return o.post?Nt(o.post):null}})}function ro({taskId:a,onSuccess:e,onError:o}){return Pe({scope:{id:a},mutationFn:()=>ue.forkSharedTask(a),onSuccess:e,onError:o})}function no({taskId:a,turnId:e,onSuccess:o,onError:i}){return Pe({scope:{id:a},mutationFn:async()=>{const r=await tt.safePost("/share/post",{requestBody:{attachments_to_create:[{kind:"codex",codex_task_id:a,current_codex_turn_id:e}]}});return Nt(r.post)},onSuccess:o,onError:i})}function lo({taskId:a,sharedResult:e}){var i;const o=Qe();return Pe({scope:{id:(i=e==null?void 0:e.postId)!=null?i:""},mutationFn:async({sharedResultId:r,access:l})=>(await tt.safePost("/share/post/update_access",{requestBody:{post_id:r,share_settings:l}})).share_setting,onMutate:({access:r})=>{const l=Fe(a),u=o.getQueryData(l);return o.setQueryData(l,u&&Ie(U({},u),{permissions:r})),{previousAccess:u==null?void 0:u.permissions}},onSuccess:r=>{const l=Fe(a),u=o.getQueryData(l);u&&o.setQueryData(l,Ie(U({},u),{permissions:r}))},onError:(r,l,u)=>{var s;const n=Fe(a),c=o.getQueryData(n);o.setQueryData(n,c&&Ie(U({},c),{permissions:(s=u==null?void 0:u.previousAccess)!=null?s:"public"}))}})}function co({taskId:a}){const e=pe(),o=Se(),i=at(),{mutate:r}=ro({taskId:a,onSuccess:l=>{var u,n;(u=l==null?void 0:l.task)!=null&&u.id&&i("/codex/tasks/".concat((n=l==null?void 0:l.task)==null?void 0:n.id))},onError:()=>{o.danger(e.formatMessage({id:"wham.codexForkButton.failedToFork",defaultMessage:"Failed to fork task"}))}});return t.jsx(ke,{size:"small",color:"secondary",type:"button",className:"px-3 py-2",onClick:()=>r(),children:t.jsx(I,{id:"wham.share.taskForkButton",defaultMessage:"Fork"})})}const uo="".concat(It,"...");function ho({taskId:a,turnId:e,isLoading:o,sharedResult:i,title:r}){const[l,u]=g.useState(!1),n=(v,C)=>{v&&ua(v,void 0,C).then(()=>{u(!0),setTimeout(()=>u(!1),1500)}).catch(()=>{})},c=Qe(),s=Se(),{mutate:d,isPending:h}=no({taskId:a,turnId:e,onSuccess:v=>{if(!v){s.danger("Failed to create share link");return}c.setQueryData(Fe(a),v),n(v.permalink)}}),{mutate:x}=lo({taskId:a,sharedResult:i}),w=g.useRef(null),p=v=>{var C;(C=w.current)==null||C.focus(),i?n(i.permalink,v):d()},m=v=>{i&&x({sharedResultId:i.postId,access:v})},y=v=>{switch(v){case"public":return Ke.PUBLIC;case"private":return Ke.PRIVATE;case"workspace":return Ke.WORKSPACE}};return t.jsx(Ga,{inputRef:w,isLoading:o,isPublishedVersionLatest:!0,sharedObject:i&&{id:i.postId,title:r,access:y(i.permissions)},title:r,shareTextPlaceholder:uo,shareUrl:i==null?void 0:i.permalink,isCopySuccessful:l,isCreateLinkRequestInProgress:h,handlePrivacyChange:m,handlePrimaryButtonClick:p})}function mo({taskId:a,turnId:e,isDisabled:o,title:i}){const r=Ge(),l=$t(),u=pe(),[n,c]=g.useState(!1),{data:s,isLoading:d}=so({taskId:a,enabled:n&&!o}),{triggerRef:h,container:x}=zt({isOpen:n,onClose:()=>c(!1)}),w=(l==null?void 0:l.isWorkspaceAccount())&&!(l!=null&&l.features.includes(sa.WorkspaceShareLinks));return o||w?t.jsx(bt,{label:w?u.formatMessage(Be.workspaceSharingDisabled):u.formatMessage(Be.share),children:t.jsx(Ze,{disabled:!0,icon:ra,"aria-label":u.formatMessage(w?Be.workspaceSharingDisabled:Be.share)})}):t.jsxs(na,{open:n,onOpenChange:c,children:[t.jsx(la,{ref:h,asChild:!0,children:r?t.jsx(Ze,{icon:nt,"aria-label":u.formatMessage({id:"wham.whamTaskPageHeader.shareAriaLabel",defaultMessage:"Share task"})}):t.jsx(ke,{icon:nt,color:"ghost","aria-label":u.formatMessage({id:"wham.whamTaskPageHeader.shareAriaLabel",defaultMessage:"Share task"}),children:t.jsx(I,{id:"wham.whamTaskPageHeader.share",defaultMessage:"Share"})})}),t.jsx(ea,{children:n&&t.jsx(da,{forceMount:!0,container:x,children:t.jsx(ca,{align:"end",className:"z-50",sideOffset:8,collisionPadding:8,children:t.jsx(ho,{title:i,taskId:a,turnId:e,sharedResult:s,isLoading:d})})})})]})}function fo({assistantTurn:a}){var w,p,m,y,v,C;const e=pe(),o=Se(),i=Ge(),r=(m=(p=(w=a==null?void 0:a.pull_request_data)==null?void 0:w.head)!=null?p:a==null?void 0:a.branch)!=null?m:"",l=Wa(r),u=r&&r!==l,{outputDiffs:n}=ot(a==null?void 0:a.output_items),c=n[0],s=(C=(v=a==null?void 0:a.base_commit_sha)!=null?v:(y=a==null?void 0:a.pull_request_data)==null?void 0:y.base_sha)!=null?C:c==null?void 0:c.base_commit_sha;if(i||!r)return null;const d=s!=null&&r!==s,x=d?t.jsx("span",{className:"text-token-text-secondary hover:text-token-text-primary cursor-pointer",onClick:()=>{navigator.clipboard.writeText(s!=null?s:""),o.success(e.formatMessage({id:"wham.baseSha.copied",defaultMessage:"Copied branch commit SHA to clipboard"}))},children:s}):u?r:void 0;return t.jsx(bt,{label:x,side:"bottom",disabled:!x,interactive:d,children:t.jsx("span",{className:"text-token-text-secondary hover:text-token-text-primary cursor-pointer truncate",onClick:()=>{navigator.clipboard.writeText(r),o.success(e.formatMessage({id:"wham.branchName.copied",defaultMessage:"Copied branch name to clipboard"}))},children:l})})}const po=({assistantTurn:a})=>{const e=pe(),o=g.useMemo(()=>a!=null&&a.created_at?new Date(a.created_at*1e3):null,[a==null?void 0:a.created_at]),i=g.useMemo(()=>(o==null?void 0:o.getFullYear())===new Date().getFullYear(),[o]);return o?o.toLocaleDateString(e.locale,{month:"short",day:"numeric",year:i?void 0:"numeric"}):null},go=" · ";function xo({title:a,assistantTurn:e}){var c,s,d,h;const{linesAdded:o,linesRemoved:i}=Mt(e),r=(c=e==null?void 0:e.environment)==null?void 0:c.label,l=(h=(d=(s=e==null?void 0:e.pull_request_data)==null?void 0:s.head)!=null?d:e==null?void 0:e.branch)!=null?h:"",n=[{key:"created-at",element:t.jsx("span",{className:"text-token-text-secondary truncate empty:hidden max-md:hidden",children:t.jsx(po,{assistantTurn:e})}),hideOnMobile:!0,shouldShow:!!(e!=null&&e.created_at)},{key:"environment",element:t.jsx("span",{className:"text-token-text-secondary truncate",children:r}),hideOnMobile:!1,shouldShow:!!r},{key:"branch",element:t.jsx(fo,{assistantTurn:e}),hideOnMobile:!0,shouldShow:!!l,noSeparator:!0},{key:"stats",element:t.jsx("span",{className:"max-md:hidden",children:t.jsx(ja,{linesAdded:o,linesRemoved:i})}),hideOnMobile:!0,shouldShow:!!(o||i)}].filter(x=>x.shouldShow);return t.jsxs("div",{className:"flex min-w-0 flex-col text-sm",children:[t.jsx("div",{className:"flex items-center gap-1",children:t.jsx("span",{className:"truncate font-medium",children:a})}),t.jsx("div",{className:"flex gap-2 max-md:flex-wrap max-md:gap-1",children:n.map((x,w)=>{const p=n[w-1],m=(p==null?void 0:p.hideOnMobile)||x.hideOnMobile||x.noSeparator;return t.jsxs(g.Fragment,{children:[w>0&&t.jsx("span",{"aria-hidden":"true",className:ye("text-token-text-secondary",m?"max-md:hidden":""),children:go}),x.element]},x.key)})})]})}const wo=({copyApplyToClipboard:a,copyPatchToClipboard:e,createPr:o,updateBranch:i,navigateToCreatingPrPage:r,canCreatePr:l,isCreatingPr:u,permissions:n,assistantTurn:c,showOnlyViewPr:s})=>{var p,m;const d=Ue(),h=pe(),x=je(d,"296452287"),w=t.jsxs(t.Fragment,{children:[i&&l&&t.jsx(ne.Item,{icon:Me,onClick:()=>o(),"aria-label":h.formatMessage(F.createNewPr),children:t.jsx("div",{className:"flex items-center gap-1.5",children:t.jsx(I,U({},F.createNewPr))})}),t.jsx(ne.Item,{icon:Ve,onClick:()=>a(),"aria-label":h.formatMessage(F.copyGitApply),children:t.jsx(I,U({},F.copyGitApply))}),t.jsx(ne.Item,{icon:Ve,onClick:()=>e(),"aria-label":h.formatMessage(F.copyPatch),children:t.jsx(I,U({},F.copyPatch))})]});return s?(p=c==null?void 0:c.pull_request_data)!=null&&p.url?t.jsx(ke,{icon:Me,onClick:()=>{var y;(y=c==null?void 0:c.pull_request_data)!=null&&y.url&&window.open(c.pull_request_data.url,"_blank")},children:t.jsx(I,U({},F.viewPullRequest))}):null:!l||n==="read"?t.jsx(Ne,{buttonIcon:ha,onClick:()=>a(),triggerButtonAriaLabel:F.openDropdown,dropdownContent:t.jsx(ne.Item,{icon:Ve,onClick:()=>e(),"aria-label":h.formatMessage(F.copyPatch),children:t.jsx(I,U({},F.copyPatch))}),children:t.jsx(I,U({},F.copyGitApply))}):u?t.jsx(Ne,{buttonIcon:wt,onClick:r,dropdownContent:w,triggerButtonAriaLabel:F.openDropdown,children:t.jsx(I,U({},F.viewPullRequest))}):(m=c==null?void 0:c.pull_request_data)!=null&&m.url&&(c==null?void 0:c.pull_request_status)!=="externally_created"?t.jsx(Ne,{buttonIcon:Me,as:"a",href:c.pull_request_data.url,dropdownContent:w,triggerButtonAriaLabel:F.openDropdown,children:t.jsx(I,U({},F.viewPullRequest))}):i?t.jsx(Ne,{buttonIcon:Me,onClick:()=>i(),dropdownContent:w,triggerButtonAriaLabel:F.openDropdown,children:t.jsx(I,U({},F.updateExistingBranch))}):t.jsx(Ne,{buttonIcon:Me,onClick:()=>o(),"aria-label":h.formatMessage(F.createPr),triggerButtonAriaLabel:F.openDropdown,dropdownContent:t.jsxs(t.Fragment,{children:[t.jsx(ne.Item,{icon:Me,onClick:()=>o("draft"),"aria-label":h.formatMessage(F.createDraftPr),children:t.jsx(I,U({},F.createDraftPr))}),x&&t.jsx(ne.Item,{icon:Me,onClick:()=>o("auto_merge"),"aria-label":h.formatMessage(F.createAutoMergePr),children:t.jsx(I,U({},F.createAutoMergePr))}),t.jsx(ne.Separator,{}),w]}),children:t.jsx(I,U({},F.createPr))})},F=ta({copyGitApply:{id:"wham.whamTaskPushDiffDropdown.copyGitApply",defaultMessage:"Copy git apply"},copyPatch:{id:"wham.whamTaskPushDiffDropdown.copyPatch",defaultMessage:"Copy patch"},viewPullRequest:{id:"wham.message.modal.footer.viewPr",defaultMessage:"View PR"},createPr:{id:"wham.message.modal.footer.createPrItem",defaultMessage:"Create PR"},createNewPr:{id:"wham.whamTaskPushDiffDropdown.createNewPr",defaultMessage:"Create new PR"},createDraftPr:{id:"wham.message.modal.footer.createDraftPr",defaultMessage:"Create draft PR"},createAutoMergePr:{id:"wham.message.modal.footer.createAutoMergePr",defaultMessage:"Create auto-merged PR"},updateExistingBranch:{id:"wham.whamTaskPushDiffDropdown.updateExistingBranch",defaultMessage:"Update branch"},openDropdown:{id:"wham.whamTaskPushDiffDropdown.openDropdown",defaultMessage:"Open git action menu"}});var ze,mt;function _o(){if(mt)return ze;mt=1;function a(e){return e&&e.length?e[0]:void 0}return ze=a,ze}var Ye,ft;function vo(){return ft||(ft=1,Ye=_o()),Ye}var bo=vo();const yo=aa(bo);function ko({focusedAssistantTurn:a,onClose:e,shouldShowShare:o,shouldShowFork:i,permissions:r,title:l,isSharedExampleTask:u=!1}){var se,$;const{taskId:n,task:c,currentDiffTaskTurn:s}=De(),[d,h]=g.useState((s==null?void 0:s.pull_request_status)==="creating"),[x,w]=g.useState(void 0),p=Se(),m=Qe(),y=pe(),v=yo(_e(s)),C=r==="write",W=He(b=>b.getTurnsForTask(n).filter(Re)),H=He(b=>b.getTurnsForTask(n)),B=new Map(H.map(b=>[b.id,b])),D=b=>{if(Re(b)){const k=c==null?void 0:c.external_pull_requests;if(k&&k.length)for(let R=k.length-1;R>=0;R--){const re=k[R];if(re.assistant_turn_id===b.id)return re}}const S=b.previous_turn_id?B.get(b.previous_turn_id):void 0;return S?D(S):void 0},f=s!=null?s:a,M=f?D(f):void 0,{linesAdded:G,linesRemoved:j}=Mt(s),{outputDiffs:Q,hasPreApplyPatch:K}=ot(s==null?void 0:s.output_items),J=C&&!K,E=(($=(se=c==null?void 0:c.task_status_display)==null?void 0:se.latest_turn_status_display)==null?void 0:$.intent)==="cr",Z=at(),te=Ue(),O=(je(te,"2665240312")||void 0)&&!!(a!=null&&a.id)&&C&&!E,q=je(te,"369193424"),me=W.filter(b=>{var S;return(S=s==null?void 0:s.sibling_turn_ids)==null?void 0:S.includes(b.id)}).some(b=>{var S;return(S=b.pull_request_data)==null?void 0:S.url}),le=q&&r==="write"&&M&&!M.pull_request.merged&&M.pull_request.state!=="closed"&&M.codex_updated_sha!==""&&((s==null?void 0:s.id)!==M.assistant_turn_id||(s==null?void 0:s.pull_request_status)==="externally_created")&&!me,de=g.useRef(null),{mutate:ae,isPending:oe}=Pe({mutationFn:async()=>{n&&await ue.archiveTask(n)},onSuccess:async()=>{await m.invalidateQueries({queryKey:["wham","tasks"]}),await m.invalidateQueries({queryKey:["wham","task",n]}),Z("/codex")},onError:()=>{p.danger({id:"wham.whamTaskPageHeader.failedToArchiveTask",defaultMessage:"Failed to archive task",description:"Toast when archive request fails"},{toastId:"wham_task_page_header_failed_to_archive_task"})}}),{mutate:ie,isPending:A}=Pe({mutationFn:async()=>{n&&await ue.recoverTask(n)},onSuccess:async()=>{await m.invalidateQueries({queryKey:["wham","tasks"]}),await m.invalidateQueries({queryKey:["wham","task",n]})},onError:()=>{p.danger({id:"wham.whamTaskPageHeader.failedToArchiveTask",defaultMessage:"Failed to archive task",description:"Toast when archive request fails"},{toastId:"wham_task_page_header_failed_to_archive_task"})}}),ce=oe||A;g.useEffect(()=>{(s==null?void 0:s.pull_request_status)==="creating"?(h(!0),m.invalidateQueries({queryKey:["wham","task",n,"turns"]})):h(!1)},[n,s==null?void 0:s.pull_request_status,m]),Ct([{key:"copyApplyToClipboard",action:()=>{T()},actionMessageDescriptor:y.formatMessage({id:"wham.keyboardActions.copyApplyToClipboard",defaultMessage:"Copy git apply"}),group:Je.Chat,keyboardBinding:[qe.Mod,qe.Shift,";"],enabled:!!v}]);const T=async()=>{v&&(await navigator.clipboard.writeText(" (cd \"$(git rev-parse --show-toplevel)\" && git apply --3way <<'EOF' \n".concat(v," \nEOF\n)")),p.success(y.formatMessage({id:"wham.message.modal.footer.copiedToClipboard",defaultMessage:"Copied git apply command to clipboard"}),{duration:3,hasCloseButton:!0}),s!=null&&s.id&&(We.recordGitAction("diff-copied",G,j,n,s.id,"regular"),ue.copyGitApply(n,s.id,!0)))},P=async()=>{v&&(await navigator.clipboard.writeText(v),p.success(y.formatMessage({id:"wham.whamTaskPageHeader.copiedPatchToClipboard",defaultMessage:"Copied patch to clipboard"}),{duration:3,hasCloseButton:!0}),s!=null&&s.id&&await ue.copyGitApply(n,s.id,!1))},L=async()=>{if(!M||!(s!=null&&s.id)){p.danger({id:"wham.whamTaskPageHeader.noPrToUpdate",defaultMessage:"No PR to update",description:"Toast when no PR is found to update"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_no_pr_to_update"});return}h(!0);try{await ue.updatePr(n,s.id,M.id)}catch(b){h(!1),await ue.getTaskTurnPR(n,M.assistant_turn_id),b instanceof Te?et(b,s.id,y,p):p.danger({id:"wham.whamTaskPageHeader.failedToUpdatePr",defaultMessage:"Failed to update PR",description:"Toast when failed to update PR"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_failed_to_update_pr"})}finally{await m.refetchQueries({queryKey:["wham","tasks"]}),await m.refetchQueries({queryKey:["wham","task",n]}),h(!1)}},N=async b=>{if(!(s!=null&&s.id))return;w(b);const S=de.current;try{h(!0),await ue.createPr(n,s.id,b),await m.refetchQueries({queryKey:["wham","task"]}),await m.fetchQuery(Pa(n,s.id)).then(k=>{const R=k;R.turn.pull_request_data!=null&&(S&&!S.closed&&R.turn.pull_request_data.url&&S.location.assign(R.turn.pull_request_data.url),fa({title:R.task.title,clientThreadId:R.turn.conversation_id,subtitle:y.formatMessage({id:"wham.message.modal.footer.prCreatedSuccess",defaultMessage:"Click to view your pull request."}),onClick:()=>{var re;window.open((re=R.turn.pull_request_data)==null?void 0:re.url,"_blank")}}))}),We.recordGitAction("pr-created",G,j,n,s.id,b!=null?b:"regular")}catch(k){h(!1),S==null||S.close(),k instanceof Te?et(k,s.id,y,p):p.danger({id:"wham.message.modal.footer.createPrError",defaultMessage:"Failed to create PR",description:"Error message for failed to create PR"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_failed_to_create_pr"})}},fe=()=>{if(!(s!=null&&s.id))return;const b=x?"?mode=".concat(x):"";de.current=window.open("/codex/tasks/".concat(n,"/turns/").concat(s.id,"/pr").concat(b),"_blank")},ee=!!Ge();return t.jsxs("div",{className:"border-b-token-border-default flex w-full justify-between gap-2 border-b p-3 transition-colors duration-50",children:[t.jsxs("div",{className:"flex min-w-0 flex-shrink max-md:gap-2",children:[e?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"hover:bg-token-bg-tertiary group-radix-state-open:bg-token-bg-tertiary rounded-sm p-2 font-semibold",onClick:e,"aria-label":y.formatMessage({id:"wham.taskPageHeader.goBack",defaultMessage:"Go back to tasks"}),children:t.jsx(ma,{className:"icon-lg text-token-text-secondary"})}),t.jsx("div",{className:"bg-token-border-default my-auto ms-[11px] me-4 h-4 w-[1px] max-md:hidden"})]}):t.jsx("div",{className:"ms-3"}),t.jsx(xo,{title:l,assistantTurn:a})]}),t.jsxs("div",{className:"relative flex h-10 items-center gap-1.5",children:[!1,i&&(a==null?void 0:a.id)&&t.jsx(co,{taskId:n}),O&&(ee?t.jsx(Ze,{icon:c!=null&&c.archived?lt:dt,onClick:()=>c!=null&&c.archived?ie():ae(),disabled:ce,"aria-label":c!=null&&c.archived?y.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelUnarchive",defaultMessage:"Unarchive Task"}):y.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelArchive",defaultMessage:"Archive Task"})}):t.jsx(ke,{color:"ghost",icon:c!=null&&c.archived?lt:dt,loading:ce,onClick:()=>c!=null&&c.archived?ie():ae(),"aria-label":c!=null&&c.archived?y.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelUnarchive",defaultMessage:"Unarchive Task"}):y.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelArchive",defaultMessage:"Archive Task"}),children:c!=null&&c.archived?t.jsx(I,{id:"wham.whamTaskPageHeader.unarchive",defaultMessage:"Unarchive"}):t.jsx(I,{id:"wham.whamTaskPageHeader.archive",defaultMessage:"Archive"})})),o&&(a==null?void 0:a.id)&&t.jsx(mo,{taskId:n,turnId:a==null?void 0:a.id,isDisabled:!1,title:l!=null?l:""}),r==="write"&&!ee&&t.jsx(Ua,{taskId:n}),Q.length>0&&!E&&t.jsx(wo,{isCreatingPr:d,assistantTurn:s,copyApplyToClipboard:T,copyPatchToClipboard:P,createPr:N,navigateToCreatingPrPage:fe,canCreatePr:J,updateBranch:le?L:void 0,permissions:r,showOnlyViewPr:u}),!ee&&!u&&t.jsx(Ha,{})]})]})}function Co({focusedAssistantTurn:a,showFullDiff:e,currentDiffTaskTurn:o}){if(!a)return[];const i=!e;if(_e(a,i).length>0)return Oe({assistantTurn:a,followUp:i});if(_e(a,!1).length>0)return Oe({assistantTurn:a,followUp:!1});if(_e(a,!0).length>0)return Oe({assistantTurn:a,followUp:!0});if(!o||o.id===a.id)return[];const n=_e(o,!1),c=_e(o,!0);if(n.length===0&&c.length===0)return[];const s=n.length===0&&c.length>0;return Oe({assistantTurn:o,followUp:s})}const pt=new Set,Mo=_t(()=>vt(()=>import("./ond9wpwgalpt07e1.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40])).then(a=>a.WhamTaskPageCodeDiffContent),{loading:()=>t.jsx("div",{className:"flex-1"})});function Qo({turnId:a,permissions:e,confirmClose:o,setConfirmClose:i,handleClose:r,showForkButton:l,loadingTurnMapping:u,isSharedExampleTask:n=!1}){"use forget";var R,re,ve;const{taskId:c,task:s,focusedAssistantTurn:d,pastTurns:h,canFollowUp:x,currentDiffTaskTurn:w}=De(),{comments:p,clearComments:m,setComments:y}=it(),v=pe(),{data:C,isLoading:W}=Sa(),H=Qe(),[B,D]=g.useState(void 0),f=g.useMemo(()=>_e(d,!0).length>0,[d]),[M,G]=Yt(Xt.WhamShowFullDiff,!f,pa),j=g.useMemo(()=>Co({focusedAssistantTurn:d,showFullDiff:M,currentDiffTaskTurn:w}),[d,M,w]),Q=g.useMemo(()=>d?d.output_items.filter(_=>_.type==="message").flatMap(_=>_.content).filter(_=>_.content_type==="image_asset_pointer_citation").map(_=>({content_type:"image_asset_pointer_citation",asset_pointer:_.asset_pointer,width:_.width,height:_.height,size_bytes:_.size_bytes})):[],[d]),K=(d==null?void 0:d.turn_status)==="failed",J=Q.length>0,E=j.length>0,Z=xt(h),te=s?(R=s.title)!=null?R:v.formatMessage({id:"wham.whamTaskPageContentLoaded.newTask",defaultMessage:"New Task"}):null,V=Se(),O=!!Ge(),q=O||(C==null?void 0:C.git_diff_mode)==="unified",he=Ue(),me=je(he,"3673716873");g.useEffect(()=>{const _=d==null?void 0:d.id;_&&!pt.has(_)&&(d==null?void 0:d.turn_status)==="completed"&&(pt.add(_),ue.markTurnViewed(c,_))},[d==null?void 0:d.id,c,d==null?void 0:d.turn_status]);const{mutate:le}=Pe({mutationFn:_=>ue.updateUserPreferences(_),onSuccess:async()=>{await Ia(H)},onError:()=>{V.danger({id:"wham.whamTaskPageContentLoaded.failedToUpdatePreferences",defaultMessage:"Failed to update preferences",description:"Failed to update preferences error message"},{toastId:"wham_task_page_content_loaded_failed_to_update_preferences"})}}),de=_=>{le({diffView:_?"unified":"split"})},ae=J?"preview":O?"chat":E?"diff":void 0,[oe,ie]=g.useState(!1);!oe&&s&&(ie(!0),D(ae));const A=d!=null&&d.turn_status?kt(d==null?void 0:d.turn_status):null,ce=g.useRef(!1),T=g.useRef({}),P=(re=d==null?void 0:d.id)!=null?re:a,L=g.useCallback(_=>T.current[_],[]),N=g.useCallback((_,z)=>{T.current[_]=z},[]),fe=g.useMemo(()=>({versionKey:P,getOpenState:L,setOpenState:N}),[P,L,N]);g.useEffect(()=>{A===!1?ce.current=!0:A===!0&&ce.current&&E&&D("diff")},[A]);const ee=g.useMemo(()=>{var _,z,ge,xe;if(K&&(d!=null&&d.environment_id)&&(d!=null&&d.branch)){const Y=[...h].reverse().find(Ce=>Ce.type==="user"),X=(_=Y==null?void 0:Y.input_items.find(Ce=>Ce.type==="message"))==null?void 0:_.content.find(Ce=>Ce.content_type==="text"),we=X==null?void 0:X.text,be=Y==null?void 0:Y.input_items.filter(Ce=>Ce.type==="comment"),Ee=((ge=(z=d==null?void 0:d.sibling_turn_ids)==null?void 0:z.length)!=null?ge:0)+1,Ft=ba((xe=Y==null?void 0:Y.input_items)!=null?xe:[]);return{environmentId:d==null?void 0:d.environment_id,branch:d==null?void 0:d.branch,previousTurnId:Y==null?void 0:Y.previous_turn_id,prompt:we!=null?we:"",comments:be!=null?be:[],bestOfN:Ee,attachments:Ft}}},[K,d,h]),{attemptIndex:se,siblings:$}=g.useMemo(()=>{if(!d)return{attemptIndex:null,hasSiblingTurns:!1};const _=h.filter(ge=>{var xe;return Re(ge)&&!!((xe=ge.sibling_turn_ids)!=null&&xe.includes(d.id))}),z=_.findIndex(ge=>ge.id===d.id);return{attemptIndex:z===-1?null:z+1,siblings:_}},[d,h]),b=e==="write"?t.jsx(oo,{turnId:(ve=d==null?void 0:d.id)!=null?ve:a,comments:p,clearComments:m,focusedAssistantTurn:d,lastTurn:Z,retry:ee,attemptIndex:se,siblings:$!=null?$:[]}):null,S=t.jsx(Ya,{currentTab:B,permissions:e,onClickFile:()=>D("diff"),onTabChange:_=>D(_),showFullDiff:M,loadingTurnMapping:u,footer:b}),k=t.jsx(ct.Provider,{value:fe,children:t.jsx(Za,{currentTab:B,setCurrentTab:_=>D(_),defaultTab:ae,isMobile:O,hasDiff:E,previewImages:Q,diffFiles:j,unifiedDiff:q,handleDiffModeChange:de,showFullDiff:M,setShowFullDiff:G,isPreferencesLoading:W,isSharedExampleTask:n,focusedAssistantTurn:d,leftContent:S})});return t.jsxs(t.Fragment,{children:[t.jsxs(yt.div,Ie(U({className:ye("relative flex size-full flex-1 flex-col items-center",O?"[--right-bg:var(--bg-primary)]":"[--right-bg:var(--bg-tertiary)] dark:[--right-bg:black]")},ga),{children:[t.jsx(ko,{title:te,focusedAssistantTurn:d,onClose:r?()=>r==null?void 0:r({force:!0}):void 0,permissions:e,shouldShowShare:me&&e==="write",shouldShowFork:!!l,isSharedExampleTask:n}),t.jsx("div",{className:"bg-token-bg-primary flex min-h-0 w-full flex-1",children:!s||!oe?t.jsx(Jt,{}):O?k:t.jsx(ya,{leftContent:S,rightContent:n&&E?t.jsx("div",{className:"relative h-full w-full bg-[var(--right-bg)]",children:t.jsx(ct.Provider,{value:fe,children:t.jsx(Mo,{diffFiles:j,unifiedDiff:q,enableComments:x,comments:p,setComments:y})})}):B?t.jsxs("div",{className:"relative h-full w-full bg-[var(--right-bg)]",children:[k,t.jsx(xa,{className:"absolute end-3 top-2.5",icon:t.jsx(Zt,{}),label:v.formatMessage({id:"wham.whamTaskPageContentLoaded.close",defaultMessage:"Close"}),onClick:()=>D(void 0)})]}):void 0})})]})),o&&i&&r&&t.jsx(ka,{setConfirmClose:i,handleClose:r})]})}function Ko({taskId:a,task:e,currentUserTurn:o,currentAssistantTurn:i}){var d,h,x,w;const r=He(p=>p.addTurnToTaskMap),l=He(p=>p.getTurnsForTask),[u,n]=g.useState((h=(d=i==null?void 0:i.id)!=null?d:e==null?void 0:e.current_turn_id)!=null?h:null);g.useEffect(()=>{var p;a&&(i&&["pending","in_progress","failed"].includes(i.turn_status)?n(i.id):n((p=i==null?void 0:i.id)!=null?p:null),o&&r(a,o),i&&r(a,i))},[i,o,a,r]);const c=l(a!=null?a:"");let s=(w=(x=c==null?void 0:c.filter(p=>p.type==="assistant"))==null?void 0:x.find(p=>p.id===u))!=null?w:null;return s||(s=i),{focusedAssistantTurn:s,setFocusedAssistantTurnId:n}}function Vo({focusedAssistantTurn:a,pastTurns:e,currentDiffTaskTurnId:o}){if(!a)return null;if(Xe(a))return a;const i=jo(e);if(o){const l=i.get(o);if(l&&Re(l)&&Xe(l))return l}let r=gt(a,i);for(;r;){const l=i.get(r);if(!l||!Re(l))return null;if(Xe(l))return l;r=gt(l,i)}return null}function Xe(a){return _e(a,!1).length>0||_e(a,!0).length>0}function jo(a){const e=new Map;for(const o of a)e.set(o.id,o);return e}function gt(a,e){var i,r;const o=e.get((i=a.previous_turn_id)!=null?i:"");return o&&(r=o.previous_turn_id)!=null?r:null}export{Go as T,Uo as W,Ko as a,Qo as b,Vo as g,it as u};
//# sourceMappingURL=kf5isiqcpnpe4fhv.js.map

import{c as V,j as i,aw as L,au as A,r as c}from"./l6lryjpkt8rv0lpy.js";import{d as j,c6 as re,ba as le,a0 as z,a1 as P,P as U,a as R,cg as ce,q as ue,o as de}from"./mnkup87aq6tfilq5.js";import{F as fe,s as me}from"./kz4w238t2tuvnfm1.js";import{dE as N,dF as S,gL as pe,dP as G,k4 as he}from"./dvllb5fed1b4y7k1.js";import{g as ge}from"./lj8vn5ziwxf900b0.js";import{u as Ce}from"./ffxduo863rikjmz1.js";import"./chwpaxfxk9st7eq2.js";import"./dssqb33wed4i78fb.js";import"./cbms2jcglp4b707f.js";import"./1e3kywkhcjn5spyo.js";import"./jm8zus0mi88xmv2y.js";import"./b4zl6usbni9k59c7.js";import"./hklpkipqhzi68oi6.js";import"./i822scwyjyzhmdym.js";import"./h4jw8c63q447uotc.js";import"./eivflkxhgemu4u0k.js";import"./fzmi0zkr0dvmhwns.js";import"./no74ca53mzecj421.js";import"./o8w0b09azms3av0p.js";import"./nxg0mr2frwehg6na.js";import"./cu56xogs1b4sjtcp.js";import"./jse5gib798yh273j.js";const O=24,K=16,w=12,xe=5e3,F=20,_e=400,ke=({isExpanded:e=!1,isExpandDisabled:s=!1,isComplete:n=!1,activeHeadline:a,finishedText:t,onToggleExpanded:r})=>{const o=V(),m=o.formatMessage({id:"/4+t6i",defaultMessage:"Reasoned"});t||=m;const u=n?t:!e&&a?a:o.formatMessage({id:"Guu3mD",defaultMessage:"Reasoning"});return i.jsxs("button",{disabled:s,onClick:r,className:"relative inline w-full text-start",children:[i.jsx(L,{mode:"popLayout",children:i.jsx(A.span,{className:j("align-middle",n?"text-token-text-primary":"loading-shimmer"),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,overflow:"hidden",whiteSpace:"nowrap"},transition:{duration:.3},children:u},u)}),!s&&i.jsx(re,{className:j("icon-sm inline align-middle text-token-text-secondary transition-transform",e&&"rotate-90")})]})},ye="_fadeIn_eiknz_10",Te="_fade_eiknz_10",H={fadeIn:ye,fade:Te},X=e=>Array.from(e.match(/\s*\S+(?:\s+|$)/g)??[]),W=e=>({"--duration":`${_e}ms`,"--delay":`${e}ms`}),Z=({children:e,delay:s,onComplete:n})=>{const a=X(e);return i.jsx(i.Fragment,{children:a.map((t,r)=>i.jsx("span",{className:j(H.fadeIn,"whitespace-prewrap"),style:W(s+r*F),onAnimationEnd:r===a.length-1?n:void 0,children:t},r))})},q=({tag:e,isDisabled:s=!1,onComplete:n,children:a})=>{if(s)return i.jsx(e,{children:a});let t=0;return i.jsx(e,{children:typeof a=="string"?i.jsx(Z,{delay:t,onComplete:n,children:a}):Array.isArray(a)?a.map((r,o)=>{const m=t;return typeof r=="string"?t+=X(r).length*F:t+=F,typeof r=="string"?i.jsx(Z,{delay:m,onComplete:o===a.length-1?n:void 0,children:r},o):i.jsx("span",{className:H.fadeIn,style:W(t),onAnimationEnd:n,children:r},o)}):i.jsx("span",{className:H.fadeIn,style:W(t),onAnimationEnd:n,children:a})})},Ee="_markdown_1frq2_10",Me="_fade_1frq2_1",ve={markdown:Ee,fade:Me},je=({children:e,onMeasure:s})=>{const[{height:n},a]=pe();return le(()=>{n&&s?.(n)},[n]),i.jsx("div",{className:"flex",ref:a,children:e})};var J=(e=>(e.STATIC="static",e.ENTER="enter",e.STAGE="stage",e))(J||{});const Ie=({showStreamPreviewWhenCollapsed:e=!1,isAnimationComplete:s=!1,isExpanded:n=!1,isLast:a=!1,index:t,content:r,onClick:o,onMeasure:m,onAnimationComplete:u})=>{const _=a||n;let g="static",x="static";a&&!s?(g="enter",x="stage"):x="static";const k=c.useRef(null);k.current=()=>{u?.(t,"enter")},c.useEffect(()=>{if(g!=="enter")return;const h=setTimeout(()=>{N.count(S.COT_SUMMARIZER,"cot_chunk_timeout"),k.current?.()},xe);return()=>clearTimeout(h)},[g]);const f=c.useCallback(()=>{k.current?.()},[]),p=g==="static",I=c.useMemo(()=>({li:({children:h})=>i.jsx(q,{tag:"li",isDisabled:p,onComplete:f,children:h}),p:({children:h})=>i.jsx(q,{tag:"p",isDisabled:p,onComplete:f,children:h})}),[p,f]);return i.jsx(A.div,{role:e&&!n?"button":void 0,variants:{static:{opacity:1,scale:1,position:"static",translateY:0},enter:{position:"static",translateY:0,scale:1,opacity:1},stage:{position:"absolute",translateY:-O,scale:.95,opacity:0}},initial:x,animate:g,exit:e&&!n?{opacity:0,pointerEvents:"none",position:"absolute",translateY:O,filter:"blur(8px)"}:void 0,style:{zIndex:t},transition:s||g==="static"?{duration:0}:{type:"spring",bounce:.05},className:j("top-0 origin-left text-token-text-secondary",!_&&"pointer-events-none"),onAnimationComplete:h=>h!=="enter"&&u(t,h),onClick:o,children:i.jsx(je,{onMeasure:h=>{m(t,h*(x==="stage"?1/.95:1))},children:i.jsx(fe,{className:j(ve.markdown,"text-token-text-secondary"),componentOverrides:I,children:r})})})},Re=c.memo(Ie);var v=(e=>(e.HEADLINE="headline",e.COT="CoT",e))(v||{});const E=e=>({key:e,type:"CoT",content:"",isComplete:!0}),Ae=(e,s=!1)=>{const n=[],a=e.split(/( {2}\n)|(\n\n)/).filter(o=>o!=null&&o.trim());if(!s&&a.length<2)return n;let t=E(n.length),r=!1;for(let o=0;o<a.length;o++){const u=a[o].trim();if(u.toLowerCase()==="none")continue;const _=u.match(/^\*\*(.*)\*\*$/);if(_)t.content.trim()&&(t.isComplete=!0,n.push(t),t=E(n.length)),n.push({key:n.length,type:"headline",content:_[1]??"",isComplete:!0}),t=E(n.length);else if(u){if(u.startsWith("```"))if(!r)t.isComplete=!0,n.push(t),t=E(n.length),r=!0;else{t.content+=t.content?`
${u}`:u,t.isComplete=!0,n.push(t),t=E(n.length),r=!1;continue}t.content.trim()&&!u.startsWith("\\[")&&!u.startsWith("\\(")&&!r&&(t.isComplete=!0,n.push(t),t=E(n.length)),t.content+=t.content?`
${u}`:u,t.isComplete=!1}}return t.content.trim()&&(t.isComplete=s,n.push(t)),n},Ne=(e,s)=>{const n=!s,a=c.useMemo(()=>Ae(e,n),[e,n]);return c.useEffect(()=>{n&&N.hist(S.COT_SUMMARIZER,"num_cot_chunks",void 0,a.length)},[n]),{chunks:a,isComplete:n}},B=({type:e,isComplete:s})=>e===v.HEADLINE&&s,Se={duration:.3,ease:"easeInOut"},be=({isStreaming:e=!1,showStreamPreviewWhenCollapsed:s=!1,expandByDefault:n=!1,finishedText:a,summaryText:t,onAnimationComplete:r})=>{const{chunks:o,isComplete:m}=Ne(t,e),[u,_]=c.useState(()=>new Map),g=o.findLast(({type:l})=>l===v.COT)?.key??null,[x,k]=c.useState(()=>e?null:g),f=m&&x===g,[p,I]=c.useState(()=>{const l=z.getItem(P.ExpandSummarizedCoT);return e?l!=null?!!l:n:!1}),h=c.useCallback((l,d)=>{I(l),e&&z.setItem(P.ExpandSummarizedCoT,l),N.count(S.COT_SUMMARIZER,l?"expand":"collapse",[{key:"is_streaming",value:String(e)},{key:"source",value:d}]),U.logEventWithStatsig(l?R.chatgptCoTExpanded:R.chatgptCoTCollapsed,l?"chatgpt_cot_expanded":"chatgpt_cot_collapsed",{is_streaming:String(e),source:d})},[e]),y=c.useMemo(()=>{const l=[];for(let d=0;d<o.length;d++){const C=o[d];C.type===v.COT&&C.content&&C.isComplete&&l.push(d)}return l.find((d,C)=>x==null||d>x||C===l.length-1)??-1},[o,x]),Q=c.useCallback((l,d)=>{_(C=>{const $=new Map(C);return $.set(l,d),$})},[]),ee=c.useCallback(()=>{h(!0,"chunk")},[h]),b=Array.from(u.values()),M=o.slice(0,y+1),te=(ce(M,B)??o.find(B))?.content;let T=M.filter(l=>l.type===v.COT);s&&!p&&(T=T.slice(-1));const D=c.useRef(null);Ce(y);const Y=()=>{if(D.current!=null){const l=performance.now()-D.current;N.hist(S.COT_SUMMARIZER,"cot_chunk_display_time",void 0,l)}};c.useEffect(()=>{if(f)return Y();y!==-1&&(Y(),D.current=performance.now())},[y]),c.useEffect(()=>{f||y<0||U.logEventWithStatsig(p?R.chatgptStreamedCoTChunkViewed:R.chatgptStreamedCoTChunkIgnored,p?"chatgpt_streamed_cot_chunk_viewed":"chatgpt_streamed_cot_chunk_ignored")},[y,f,p,e]);const ne=c.useCallback((l,d)=>{d===J.ENTER&&(k(C=>C!=null?Math.max(C,l):l),m&&l===g&&r?.())},[m,g,r]);c.useEffect(()=>{if(m&&!f){I(!1),k(g),r?.();return}!m||!f||(!T.length||!p&&!s)&&r?.()},[m,f,T]);const se=M.length>0&&(!f&&s||p),ae=me(b)+(b.length-1)*K+2*w,oe=f?"auto":p?ae:s?(ue(b)??0)+2*w:0,ie=M.length===0||!m&&s&&M.length<2;return i.jsxs(A.div,{className:"my-1 flex flex-col",children:[i.jsx(ke,{activeHeadline:te,finishedText:a,onToggleExpanded:()=>h(!p,"header"),isExpanded:p,isExpandDisabled:ie,isComplete:f}),i.jsx(L,{children:se&&i.jsxs(A.div,{className:"relative z-0 whitespace-pre-wrap pl-4 md:pl-7",initial:f?{opacity:0,height:0,overflowY:"hidden"}:!1,animate:{opacity:1,height:oe},exit:{height:0,opacity:0,pointerEvents:"none",overflowY:"hidden",translateY:-O},transition:Se,children:[i.jsx("div",{className:"absolute bottom-4 left-0 top-4 w-1 rounded-full bg-token-border-light"}),i.jsx("div",{className:"relative flex h-full flex-col",style:{gap:K,margin:`${w}px 0`},children:i.jsx(L,{children:T.map(({content:l,key:d},C)=>i.jsx(Re,{index:d,content:l,isLast:T.length-1===C,onClick:ee,onAnimationComplete:ne,onMeasure:Q,isAnimationComplete:f,isExpanded:p,showStreamPreviewWhenCollapsed:s},d))})})]})})]})},nt=({messages:e,isStreaming:s})=>{const n=V(),a=e.map(({message:o})=>de(o)).join(`

`);c.useEffect(()=>{if(s)for(const{message:o}of e)G.addDelayedRenderingMessage(o.id)},[s,e]);const t=()=>{for(const{message:o}of e)G.removeDelayedRenderingMessage(o.id)},r=he();return i.jsx(be,{showStreamPreviewWhenCollapsed:r?.showPreviewWhenCollapsed,expandByDefault:r?.expandByDefault,finishedText:ge(n,e),summaryText:a,isStreaming:s,onAnimationComplete:t})};export{be as CoT,nt as CoTMessage};
//# sourceMappingURL=mjk2tmzbeggshn4d.js.map

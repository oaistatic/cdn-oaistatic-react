import{r as t,i as z,ae as $,j as u,M as D}from"./ci5tkrccytan34lo.js";import{aj as I,bX as G,bT as O,gR as j,B as W,c as _,y as T,e as X,aP as H}from"./ccccre6vnqbb7l94.js";import{iF as N,b$ as U,c0 as q,iG as L}from"./fztttvm3qzdvif1h.js";import{u as P}from"./lngkec8b64kqtwx6.js";function k(s,r){return e=>{I.addAction(`${s}.${r}`,e)}}function V(s){return(r,e)=>{I.addError(r,{...e,name:s,status:"error"})}}const w={recording:{start:k("whisper-recording","start"),cancel:k("whisper-recording","cancel"),submit:k("whisper-recording","submit")},transcription:{request:k("whisper-transcription","request"),transcriptDelivered:k("whisper-transcription","transcriptDelivered"),error:V("whisper-transcription"),requestSuccess:k("whisper-transcription","requestSuccess")}};class Z{static async transcribe(r,e,b={}){const m=new FormData;m.append("file",r),e&&m.append("language",e);const d={durationMs:b.durationMs,language:e,fileSize:r.size},l=performance.now();return w.transcription.request(d),G.post(`${O}/transcribe`,m).then(n=>{const c=performance.now()-l;return w.transcription.requestSuccess({...d,durationMs:c}),n}).catch(n=>{const c=performance.now()-l;throw w.transcription.error(n,{...d,durationMs:c}),n})}}const J=48e3,K=10,B=J*K,Q=4e3,Y=10*60*1e3,M=s=>P.setState(r=>{r.status=s}),ee=s=>{const r=t.useRef(s);r.current=s;const e=t.useRef(null),b=t.useRef([]),m=t.useRef(null),d=t.useRef(null),l=t.useRef(null),n=t.useRef(new Float32Array(0)),c=t.useRef(null),S=t.useRef(null),v=t.useRef(!1),o=t.useCallback(()=>{n.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),x=t.useCallback(async(a,p)=>{M("transcribing");try{let i;j()?i=new File([a],"whisper.mp3",{type:"audio/mpeg"}):i=new File([a],`whisper.${a.type.split(/[\/;]/)[1]||"mp3"}`,{type:a.type});const f=await Z.transcribe(i,void 0,{durationMs:p});M("idle"),w.transcription.transcriptDelivered({durationMs:p,transcriptLength:f.text.length}),r.current.onSuccess(f.text,f.asset_pointer,f.asset_ttl),o()}catch(i){M("error"),w.transcription.error(i,{durationMs:p}),o()}},[o]),R=t.useCallback(a=>{if(!v.current)return;v.current=!1,S.current!==null&&(clearTimeout(S.current),S.current=null);const p=c.current!=null?performance.now()-c.current:void 0;a&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,M("idle"),o(),w.recording.cancel({durationMs:p}),c.current=null),e.current?.stop(),e.current?.stream.getTracks().forEach(i=>i.stop()),e.current=null,l.current?.disconnect(),l.current=null,d.current?.disconnect(),d.current=null,m.current?.close(),m.current=null,a||w.recording.submit({durationMs:p})},[o]),A=t.useCallback(()=>{o(),M("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:Q,channelCount:1}}).then(a=>{c.current=performance.now(),w.recording.start(),e.current=new MediaRecorder(a);const p=j();v.current=!0,p?(b.current=[],e.current.ondataavailable=g=>{g.data.size>0&&b.current.push(g.data)},e.current.onstop=async()=>{const g=new Blob(b.current,{type:"audio/mpeg-3"}),h=c.current!=null?performance.now()-c.current:void 0;await x(g,h)},e.current.start(1e3)):(e.current.ondataavailable=async g=>{const h=c.current!=null?performance.now()-c.current:void 0;await x(g.data,h)},e.current.start()),n.current=new Float32Array(B).fill(r.current.initialValue),r.current.onWaveformDataUpdate(n.current),M("recording"),S.current=window.setTimeout(()=>{R()},Y);const i=new AudioContext;m.current=i;const f=i.createMediaStreamSource(a);d.current=f;const y=i.createScriptProcessor(2048,1,1);l.current=y,y.onaudioprocess=g=>{const h=g.inputBuffer.getChannelData(0);for(let E=0;E<h.length;E++)h[E]=Math.max(h[E],r.current.initialValue);const F=n.current,C=new Float32Array(F.length+h.length);if(C.set(F,0),C.set(h,F.length),C.length>B){const E=C.length-B;n.current=C.slice(E)}else n.current=C;r.current.onWaveformDataUpdate(n.current)},f.connect(y),y.connect(i.destination)}).catch(()=>{M("error"),o(),w.recording.cancel()})},[o,R,x]);return t.useEffect(()=>()=>{R(!0)},[R]),{startRecording:A,stopRecording:R}};function ce({disabled:s=!1,initialValue:r,onSuccess:e,onWaveformDataUpdate:b,onExit:m,buttonClassName:d,visualTreatment:l}){const n=z(),c=P(g=>g.status),S=t.useRef(!1),{startRecording:v,stopRecording:o}=ee({onSuccess:e,onWaveformDataUpdate:b,initialValue:r}),x=$();t.useEffect(()=>()=>{o()},[o]),t.useEffect(()=>{S.current||(v(),S.current=!0)},[v]),t.useEffect(()=>{x.state!=="idle"&&o()},[x.state,o]);const R=()=>{o(!0),m()},A=l==="codex"?u.jsx(W,{type:"button",color:"ghost",size:"small",onClick:R,icon:N,disabled:s||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},children:u.jsx(D,{id:"wham.whisperModeControls.cancel",defaultMessage:"Cancel"})}):u.jsx("div",{children:u.jsx("button",{"aria-label":n.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:R,disabled:s||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:_(l==="composer-btn"?"composer-btn":_(U,s?"opacity-30":q,d)),children:u.jsx(N,{"aria-label":n.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"h-[18px] w-[18px]",fontSize:"inherit"})})}),a=c==="transcribing",p=a?u.jsx(T,{}):u.jsx(L,{className:"icon-lg"}),i=a?n.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):n.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),f=()=>{X.logEvent("Whisper on Web/Windows: Clicked to end dictation"),H.logEvent("chatgpt_composer_whisper_button_clicked_end"),o()},y=l==="codex"?u.jsx(W,{type:"button",color:"secondary",size:"small",disabled:s,icon:a?T:L,onClick:f,children:u.jsx(D,{id:"wham.whisperModeControls.done",defaultMessage:"Done"})}):u.jsx("div",{children:u.jsx("button",{type:"button","aria-label":i,disabled:s,className:l==="composer-btn"?"composer-btn":_(U,s?"opacity-30":q,d),onClick:f,children:p})});return u.jsxs("div",{className:"flex gap-x-1.5",children:[A,y]})}export{ce as WhisperModeControls};
//# sourceMappingURL=nv8a97k8qfxbknv8.js.map

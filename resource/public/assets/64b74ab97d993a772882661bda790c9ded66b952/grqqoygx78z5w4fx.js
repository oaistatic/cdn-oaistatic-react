import{r as M,c as A,j as I}from"./ci5tkrccytan34lo.js";import{s as Z,a as $,g as B,t as Q,m as X,p as Y,b as J,k as ee,c as te,d as ne,P as se,u as re}from"./hapan2fx2czn21gi.js";import{d6 as oe,e7 as ae,o as ie,I as le,h3 as pe,bi as ue,bW as de,L as ce,at as me,K as fe,aL as P,aZ as ge,ds as he,M as ve}from"./ccccre6vnqbb7l94.js";import{P as we,d as K,M as Ce,e as U,g as Me,E as Se,h as Te,n as be,i as xe,j as Ee}from"./kzhevji8i57j71hk.js";import{k as O,g as Pe}from"./h2gd34k3oh53zw7p.js";import{kR as L,kS as ye,hA as ke,cK as Ie,iW as Oe,bi as He,gb as De,bj as Re,kT as Fe,kU as Ue,kV as je,kW as Ne,U as Ae,kX as Ke,hP as Le,hO as _e,kY as Ve,kZ as Ge,fh as We,k_ as qe}from"./fztttvm3qzdvif1h.js";const ze=500;class g{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let o=this.items.length;for(;;o--)if(this.items.get(o-1).selection){--o;break}let s,r;t&&(s=this.remapping(o,this.items.length),r=s.maps.length);let a=e.tr,i,l,u=[],d=[];return this.items.forEach((p,c)=>{if(!p.step){s||(s=this.remapping(o,c+1),r=s.maps.length),r--,d.push(p);return}if(s){d.push(new h(p.map));let m=p.step.map(s.slice(r)),f;m&&a.maybeStep(m).doc&&(f=a.mapping.maps[a.mapping.maps.length-1],u.push(new h(f,void 0,void 0,u.length+d.length))),r--,f&&s.appendMap(f,r)}else a.maybeStep(p.step);if(p.selection)return i=s?p.selection.map(s.slice(r)):p.selection,l=new g(this.items.slice(0,o).append(d.reverse().concat(u)),this.eventCount-1),!1},this.items.length,0),{remaining:l,transform:a,selection:i}}addTransform(e,t,o,s){let r=[],a=this.eventCount,i=this.items,l=!s&&i.length?i.get(i.length-1):null;for(let d=0;d<e.steps.length;d++){let p=e.steps[d].invert(e.docs[d]),c=new h(e.mapping.maps[d],p,t),m;(m=l&&l.merge(c))&&(c=m,d?r.pop():i=i.slice(0,i.length-1)),r.push(c),t&&(a++,t=void 0),s||(l=c)}let u=a-o.depth;return u>$e&&(i=Ze(i,u),a-=u),new g(i.append(r),a)}remapping(e,t){let o=new Ce;return this.items.forEach((s,r)=>{let a=s.mirrorOffset!=null&&r-s.mirrorOffset>=e?o.maps.length-s.mirrorOffset:void 0;o.appendMap(s.map,a)},e,t),o}addMaps(e){return this.eventCount==0?this:new g(this.items.append(e.map(t=>new h(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let o=[],s=Math.max(0,this.items.length-t),r=e.mapping,a=e.steps.length,i=this.eventCount;this.items.forEach(c=>{c.selection&&i--},s);let l=t;this.items.forEach(c=>{let m=r.getMirror(--l);if(m==null)return;a=Math.min(a,m);let f=r.maps[m];if(c.step){let S=e.steps[m].invert(e.docs[m]),v=c.selection&&c.selection.map(r.slice(l+1,m));v&&i++,o.push(new h(f,S,v))}else o.push(new h(f))},s);let u=[];for(let c=t;c<a;c++)u.push(new h(r.maps[c]));let d=this.items.slice(0,s).append(u).append(o),p=new g(d,i);return p.emptyItemCount()>ze&&(p=p.compress(this.items.length-o.length)),p}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),o=t.maps.length,s=[],r=0;return this.items.forEach((a,i)=>{if(i>=e)s.push(a),a.selection&&r++;else if(a.step){let l=a.step.map(t.slice(o)),u=l&&l.getMap();if(o--,u&&t.appendMap(u,o),l){let d=a.selection&&a.selection.map(t.slice(o));d&&r++;let p=new h(u.invert(),l,d),c,m=s.length-1;(c=s.length&&s[m].merge(p))?s[m]=c:s.push(p)}}else a.map&&o--},this.items.length,0),new g(L.from(s.reverse()),r)}}g.empty=new g(L.empty,0);function Ze(n,e){let t;return n.forEach((o,s)=>{if(o.selection&&e--==0)return t=s,!1}),n.slice(t)}class h{constructor(e,t,o,s){this.map=e,this.step=t,this.selection=o,this.mirrorOffset=s}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new h(t.getMap().invert(),t,this.selection)}}}class w{constructor(e,t,o,s,r){this.done=e,this.undone=t,this.prevRanges=o,this.prevTime=s,this.prevComposition=r}}const $e=20;function Be(n,e,t,o){let s=t.getMeta(C),r;if(s)return s.historyState;t.getMeta(Ye)&&(n=new w(n.done,n.undone,null,0,-1));let a=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(a&&a.getMeta(C))return a.getMeta(C).redo?new w(n.done.addTransform(t,void 0,o,x(e)),n.undone,j(t.mapping.maps),n.prevTime,n.prevComposition):new w(n.done,n.undone.addTransform(t,void 0,o,x(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(a&&a.getMeta("addToHistory")===!1)){let i=t.getMeta("composition"),l=n.prevTime==0||!a&&n.prevComposition!=i&&(n.prevTime<(t.time||0)-o.newGroupDelay||!Qe(t,n.prevRanges)),u=a?y(n.prevRanges,t.mapping):j(t.mapping.maps);return new w(n.done.addTransform(t,l?e.selection.getBookmark():void 0,o,x(e)),g.empty,u,t.time,i??n.prevComposition)}else return(r=t.getMeta("rebased"))?new w(n.done.rebased(t,r),n.undone.rebased(t,r),y(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new w(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),y(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function Qe(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((o,s)=>{for(let r=0;r<e.length;r+=2)o<=e[r+1]&&s>=e[r]&&(t=!0)}),t}function j(n){let e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((o,s,r,a)=>e.push(r,a));return e}function y(n,e){if(!n)return null;let t=[];for(let o=0;o<n.length;o+=2){let s=e.map(n[o],1),r=e.map(n[o+1],-1);s<=r&&t.push(s,r)}return t}function Xe(n,e,t){let o=x(e),s=C.get(e).spec.config,r=(t?n.undone:n.done).popEvent(e,o);if(!r)return null;let a=r.selection.resolve(r.transform.doc),i=(t?n.done:n.undone).addTransform(r.transform,e.selection.getBookmark(),s,o),l=new w(t?i:r.remaining,t?r.remaining:i,null,0,-1);return r.transform.setSelection(a).setMeta(C,{redo:t,historyState:l})}let k=!1,N=null;function x(n){let e=n.plugins;if(N!=e){k=!1,N=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){k=!0;break}}return k}const C=new K("history"),Ye=new K("closeHistory");function Je(n={}){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new we({key:C,state:{init(){return new w(g.empty,g.empty,null,0,-1)},apply(e,t,o){return Be(t,o,e,n)}},config:n,props:{handleDOMEvents:{beforeinput(e,t){let o=t.inputType,s=o=="historyUndo"?V:o=="historyRedo"?H:null;return s?(t.preventDefault(),s(e.state,e.dispatch)):!1}}}})}function _(n,e){return(t,o)=>{let s=C.getState(t);if(!s||(n?s.undone:s.done).eventCount==0)return!1;if(o){let r=Xe(s,t,n);r&&o(e?r.scrollIntoView():r)}return!0}}const V=_(!1,!0),H=_(!0,!0);function et(){return O({"Shift-Enter":(n,e)=>U(n,e),Enter:(n,e)=>window.innerWidth>ye[ke.Medium]||oe||ae()?!1:U(n,e)})}const tt=["p",0],nt=["br"],st=new Me({nodes:{paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p",preserveWhitespace:"full"}],toDOM(){return tt}},text:{group:"inline"},hard_break:{inline:!0,group:"inline",selectable:!1,parseDOM:[{tag:"br"}],toDOM(){return nt}},[$]:Z,doc:{content:"block+"}},marks:{}});function rt(n=null,e){const t=new EventTarget,o=B(e).enabled,s=new Se(null,{state:Te.create({schema:st,plugins:[Je(),X(),Y(""),J(),...o?[ee()]:[],et(),O({"Mod-z":V,"Mod-y":H,"Mod-Shift-z":H}),te(),O(Ee),ne(t),Pe()]}),dispatchTransaction(r){const a=s.state.apply(r);s.updateState(a),r.docChanged&&t.dispatchEvent(new Event(Q))},handlePaste(r,a){const i=a.clipboardData?.getData("text/plain");return i===void 0?!1:(a.defaultPrevented||xe(r,i),!0)},clipboardTextSerializer(r){return be(r.content).content}});return n!=null&&s.state.doc.textContent.trim().length===0&&s.dispatch(s.state.tr.insertText(n)),s}const D=M.createContext(null),ot=n=>{"use forget";const e=A.c(8),{children:t,clientThreadId:o,ignoreParentComposerController:s}=n,r=s===void 0?!1:s,a=M.useContext(D),i=le();let l,u;e[0]!==o||e[1]!==a||e[2]!==i||e[3]!==r?(u=a&&!r?a:new se(rt(o?pe(ue(o))?.content??null:null,i)),e[0]=o,e[1]=a,e[2]=i,e[3]=r,e[4]=u):u=e[4],l=u;const d=l;let p;return e[5]!==t||e[6]!==d?(p=I.jsx(D.Provider,{value:d,children:t}),e[5]=t,e[6]=d,e[7]=p):p=e[7],p},ft=()=>{"use forget";const n=A.c(2),e=M.useContext(D);let t;return n[0]!==e?(t=ie(e),n[0]=e,n[1]=t):t=n[1],t};function G(){return{clientThreadId:"",isLoggedInUser:!1,focusedObject:null,currentModelId:"",isModelLoaded:!1,isEmbeddedInFocusedView:!1,isInstalledApp:!1,onNewThread:()=>{throw new Error("onNewThread not implemented")},onRequestCompletion:()=>{throw new Error("onRequestCompletion not implemented")},resetThread:()=>{throw new Error("resetThread not implemented")}}}const W=M.createContext(G());function at(){try{return M.use(W)}catch{return G()}}function gt({children:n,clientThreadId:e,setClientThreadId:t,routeType:o,prefetchSearchPromises:s}){const{createNewThread:r,resetThread:a}=Ie({clientThreadId:e,setClientThreadId:t}),{data:i}=de(),l=Oe(i),u=ce(e,b=>b?.modelId),d=He(),p=l.id,c=u??p,m=De(),f=Re(),{isUnauthenticated:S}=me(),v=!S,T=re(e),E=M.useMemo(()=>({clientThreadId:e,currentModelId:c,isModelLoaded:!!u,isEmbeddedInFocusedView:d,isInstalledApp:m,isLoggedInUser:v,focusedObject:f,onNewThread:r,onRequestCompletion:T,resetThread:a,prefetchSearchPromises:s,routeType:o}),[e,c,u,d,m,v,f,r,T,a,s,o]);return I.jsx(W.Provider,{value:E,children:I.jsx(ot,{clientThreadId:e,children:n})})}function ht(){const{store:n}=Fe(),e=Ue(),{clearSystemHintModeTrigger:t,getSystemHintModeTrigger:o}=je(),{value:s}=fe("1988730211"),r=!Ne.useDisabledGlobally(),{onRequestCompletion:a}=at();return M.useCallback((i,l,u,d)=>{const p=n.getSharedProps();if(!p)return;const{clientThreadId:c,onResetState:m,conversationMode:f}=p;Ae.hideThreadHeader();const S=e.has(P.Search),v=S?o(P.Search):void 0,T=ge(c),{systemHints:E,extraStreamParams:b}=Ke(l)?{systemHints:[l.categoryId],extraStreamParams:l.modelOverride?{model:l.modelOverride}:{}}:s?Le(Array.from(e)):{systemHints:Array.from(e),extraStreamParams:{}};r&&(b.enableMessageFollowups=!0);const R=_e(),F={is_starter_prompt:!0,suggestion_type:l.type,starter_prompt_id:"id"in l?l.id:void 0};R&&(F.__internal={search_settings:R});const q=he(Ve(l),F);a({promptMessage:q,sourceEvent:i,extraStreamParams:b,completionMetadata:{suggestions:u,suggestion:l,suggestionIndex:d,conversationMode:f??T?.mode,systemHints:E,searchSource:v}});const z=ve.getCurrentNode(T).message.id;m(),Ge(l,d,c,z),We()||qe(),v&&S&&t(P.Search)},[n,e,o,s,r,a,t])}export{ot as C,gt as a,rt as b,D as c,ft as d,ht as e,at as u};
//# sourceMappingURL=grqqoygx78z5w4fx.js.map

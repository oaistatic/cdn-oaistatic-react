import{ak as Pe,cV as Ye,aY as Ze,aL as ve,aG as B,I as De,b0 as Xe,f5 as Ke,c8 as V,L as Ve,e as et,s as H,N as L,aZ as qe,M as U,bX as tt,ag as nt,gW as st,J as it,bi as ot,e6 as rt,E as _e,he as at,cz as ct,bk as Te,cs as ut,bl as dt,ch as lt,hf as ht,gY as gt,ew as be,g7 as Ce,e3 as ft,aS as mt,ck as pt,hg as wt}from"./ccccre6vnqbb7l94.js";import{av as yt,d as St,bo as vt,dZ as _t,J as Tt,mV as ke,mW as bt,ii as Ct,mX as kt,mY as Et,iW as xt,mZ as Rt,m_ as At,m$ as Mt,n0 as Pt,n1 as Dt,n2 as Kt,lq as qt,jb as Ee,n3 as Ht,n4 as Lt,n5 as Ft,n6 as It}from"./fztttvm3qzdvif1h.js";import{r as S,a as Nt,f as zt}from"./ci5tkrccytan34lo.js";import{d as F,P as I,D as W,a as He,T as ae,p as Ot}from"./kzhevji8i57j71hk.js";const Le=new F("transactionEventPlugin"),xe="prosemirrorDispatchTransaction";function Re(n,e){const{eventTarget:t}=Le.getState(n.state);return t.addEventListener(xe,e),()=>{t.removeEventListener(xe,e)}}function on(n){return new I({key:Le,state:{init(){return{eventTarget:n}},apply(e,t){return t}}})}const ee=new F("customKeymapPlugin");function $t(n,e){n.dispatch(n.state.tr.setMeta(ee,{handlers:e}))}function rn(n={handlers:{}}){return new I({key:ee,state:{init(){return{...n}},apply(e,t){const s=e.getMeta(ee);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const o=ee.getState(e.state).handlers[t.key];return o?o(t):!1}}})}const an=n=>n?{enabled:!!Pe(n,"463092697").value?.softmentionEnabled}:{enabled:!1};function Ut(){return{trackingKeywordsRegex:void 0,decorations:W.empty,highlightedKeywords:new Set,matchedKeywords:new Set}}const Fe=({tr:n,regex:e,prevHighlightedKeywords:t,prevMatchedKeywords:s})=>{const o=[],i=new Set,r=new Set;return e?(n.doc.descendants((a,c)=>{if(!a.isText||!a.text)return;const u=a.text;for(const h of u.matchAll(e)){if(i.add(h[1]),!t.has(h[1])&&s.has(h[1]))continue;r.add(h[1]);const v=c+h.index,b=v+h[0].length;o.push(He.inline(v,b,{class:"hint-pill"},{keyword:h[1]}))}}),{decorations:W.create(n.doc,o),matchedKeywords:i,highlightedKeywords:r}):{decorations:W.empty,matchedKeywords:i,highlightedKeywords:r}},Gt=(n,e)=>{const{state:t,dispatch:s}=e,o=t.tr,i=T.getState(t);if(i){const r=n.length>0?new RegExp(`\\b(${n.join("|")})\\b`,"gi"):void 0,{decorations:a,highlightedKeywords:c,matchedKeywords:u}=Fe({tr:o,regex:r,prevHighlightedKeywords:i.highlightedKeywords,prevMatchedKeywords:i.matchedKeywords});o.setMeta(T,{...i,trackingKeywordsRegex:r,decorations:a,highlightedKeywords:c,matchedKeywords:u})}s(o)},Wt=(n,e)=>{if(n.length===0)return;const{state:t,dispatch:s}=e,o=t.tr,i=T.getState(t);if(i){const r=i.decorations.remove(i.decorations.find(void 0,void 0,a=>a.keyword&&n.includes(a.keyword)));o.setMeta(T,{...i,decorations:r,highlightedKeywords:new Set([...i.highlightedKeywords].filter(a=>!n.includes(a)))})}s(o)},T=new F("keywordPlugin");function cn(){return new I({key:T,state:{init(){return Ut()},apply(n,e){if(n.getMeta(T))return{...e,...n.getMeta(T)};if(!n.docChanged)return e;const{decorations:t,matchedKeywords:s,highlightedKeywords:o}=Fe({tr:n,regex:e.trackingKeywordsRegex,prevHighlightedKeywords:e.highlightedKeywords,prevMatchedKeywords:e.matchedKeywords});return{...e,decorations:t,highlightedKeywords:o,matchedKeywords:s}}},props:{decorations(n){const e=this.getState(n);return e?e.decorations:W.empty}}})}const R=new F("menuSelectorPlugin");function Ae(n){n.dispatch(n.state.tr.setMeta(R,{active:!1,onMenuAction:void 0}))}function un(n,e){n.dispatch(n.state.tr.setMeta(R,{active:!0,onMenuAction:e}))}function dn(n={submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[" "]}){return new I({key:R,state:{init(){return{...n,active:!1}},apply(e,t){const s=e.getMeta(R);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const s=R.getState(e.state);if(!s.active)return!1;if(!t.isComposing)return s.submitKeys.includes(t.key)?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),Ae(e),s.onMenuAction?.("submit")??!0):s.cancelKeys.includes(t.key)?(t.preventDefault(),s.onMenuAction?.("cancel"),Ae(e),!0):t.key==="ArrowUp"?(t.preventDefault(),s.onMenuAction?.("up"),!0):t.key==="ArrowDown"?(t.preventDefault(),s.onMenuAction?.("down"),!0):s.checkStrictMatchKeys.includes(t.key)&&s.onMenuAction?.("checkMatch")?(t.preventDefault(),!0):!1},handleDOMEvents:{blur:e=>{R.getState(e.state).onMenuAction?.("cancel")}}}})}const G=new F("placeholderPlugin");function ln(n){return new I({key:G,state:{init(){return{placeholder:n}},apply(e,t){return e.getMeta(G)?{placeholder:e.getMeta(G).placeholder}:t}},props:{decorations(e){const{doc:t}=e;if(t.childCount===1&&t.firstChild?.isTextblock&&t.firstChild.content.size===0){const o=[],{placeholder:i}=G.getState(e);return e.doc.descendants((r,a)=>{const c=He.node(a,a+r.nodeSize,{class:"placeholder","data-placeholder":i});o.push(c)}),W.create(t,o)}}}})}const te="command_token",hn={group:"inline",inline:!0,atom:!0,content:"text*",attrs:{id:"",hint:""},selectable:!1,draggable:!1,toDOM:n=>["span",{"data-mention-id":n.attrs.id,"data-mention-hint":n.attrs.hint,class:"hint-pill"},n.attrs.hint],parseDOM:[{tag:"span[data-mention-id][data-mention-hint]",getAttrs:n=>{const e=n.getAttribute("data-mention-id"),t=n.getAttribute("data-mention-hint");return{id:e,hint:t}}}]};function Ie(n,e){if(n.depth===0)return;const t=n.nodeBefore?.text?.match(/(?:^|\s)(\/(\w*))$/);if(t?.[1].length!==void 0){const s=n.pos-t[1].length,o=n.pos,i=s===e?.from;return{range:{from:s,to:o},queryText:t[2],isDismissed:i}}}const ce=new F("systemHintPlugin");function Ne(n,e){return n.setMeta(ce,e),n}function gn(n){const t=n.state.selection.$from,s=Ie(t,void 0);n.dispatch(Ne(n.state.tr,{...ne(),dismissedRange:s?.range}))}function ne(){return{queryText:"",active:!1,range:void 0,dismissedRange:void 0}}function Bt(n,e,t,s,o){const i=n.state.tr;Ne(i,ne());const r=t+" ",a=n.state.schema.nodes[te].create({id:e,hint:r},n.state.schema.text(r));if(o===s){const c=i.doc.resolve(s).nodeAfter;if(c?.isText){const u=c?.textContent.match(new RegExp(`^(?:${t}) ?`));u&&(o=s+u[0].length)}}i.replaceWith(s,o,a),i.doc.descendants((c,u)=>{c.type.name===te&&c!==a&&(s===1&&u===s+a.nodeSize||u===1&&s===u+c.nodeSize?i.delete(u,u+c.nodeSize):i.insertText(c.textContent,u,u+c.nodeSize))}),n.dispatch(i)}function Qt(n){const e=n.state.tr;e.doc.descendants((t,s)=>{if(t.type.name===te){const o=s+t.nodeSize;s===1&&e.doc.resolve(o).nodeAfter==null?e.delete(s,o):e.insertText(t.textContent,s,s+t.nodeSize)}}),e.steps.length>0&&n.dispatch(e)}function Me(n){const{active:e,range:t,queryText:s,onHintMatch:o}=n;if(o)return o(!e||!t?void 0:{text:s,range:t})}function Jt(n){const e=[];return n.descendants(t=>{t.type.name===te&&typeof t.attrs?.id=="string"&&e.push(t.attrs.id)}),e}function fn(){return new I({key:ce,state:{init(){return ne()},apply(n,e,t,s){const o=n.getMeta(ce),i={...ne(),...e,...o},r=n.selection;if(r.from!==r.to||s.doc.eq(t.doc))return Me(i),i;const a=r.$from,c=Ie(a,e.dismissedRange);return i.active=!!c&&!c.isDismissed,c&&(i.queryText=c.queryText,i.range=c.range,c.isDismissed&&(c.queryText===""&&e.queryText!==""?i.dismissedRange=void 0:i.dismissedRange=c.range)),Me(i),i}}})}class jt extends Ye{constructor(e){super(),this.view=e,this.subscribe("focus",()=>this._store.setState({isFocused:!0})),this.subscribe("blur",()=>this._store.setState({isFocused:!1}))}fileInputHandle=null;_store=Ze(e=>({isFocused:!1,autocompletions:[],showTaggingDropdown:!1,waveWidth:300,isInReasonMode:!1,rateLimitBannerFeature:null,setShowTaggingDropdown:t=>e({showTaggingDropdown:t})}));get store(){return this._store}_usedDictation=!1;_dictationEdited=!1;_dictationAssetPointer=null;_dictationAssetTTL=null;get usedDictation(){return this._usedDictation}set usedDictation(e){this._usedDictation=e}get dictationEdited(){return this._dictationEdited}set dictationEdited(e){this._dictationEdited=e}get dictationAssetPointer(){return this._dictationAssetPointer}set dictationAssetPointer(e){this._dictationAssetPointer=e}get dictationAssetTTL(){return this._dictationAssetTTL}set dictationAssetTTL(e){this._dictationAssetTTL=e}get element(){return this.view.dom}get document(){return this.view.dom.ownerDocument}isEmpty(){return this.view.state.doc.textContent.trim().length===0}isFocused(){return this.view.hasFocus()}trimLeadingText(e){const s=this.view.state.tr;let o=0;return s.doc.descendants((i,r)=>{if(i.isText&&i.text){if(typeof e=="string"&&i.text.startsWith(e))o=e.length;else if(e instanceof RegExp){const a=i.text.match(e);a?.index===0&&(o=a[0].length)}if(o){const a=i.text.substring(o).trimStart();o=i.text.length-a.length,s.delete(r,r+o)}}return!i.isLeaf}),o>0?(this.view.dispatch(s),!0):!1}replaceAll(e,t){const o=this.view.state.tr,i=[];o.doc.descendants((r,a)=>{!r.isText||r.text===void 0||i.push({node:r,pos:a})}),i.reverse(),i.forEach(({node:r,pos:a})=>{!r.isText||r.text===void 0||r.text.includes(e)&&o.insertText(r.text.replaceAll(e,t),a,a+r.text.length)}),this.view.dispatch(o)}appendText(e){this.view.dispatch(this.view.state.tr.insertText(e))}delete(e,t){this.view.dispatch(this.view.state.tr.delete(e,t))}focus(){this.view.hasFocus()||(this.view.focus(),this.view.dispatch(this.view.state.tr.setSelection(ae.atEnd(this.view.state.doc)).scrollIntoView()))}setText(e){const{tr:t,schema:s}=this.view.state,o=e?s.nodes.paragraph.create(null,s.text(e)):s.nodes.paragraph.create();this.view.dispatch(t.replaceWith(0,this.view.state.doc.content.size,o)),this.view.hasFocus()&&this.view.dispatch(this.view.state.tr.setSelection(ae.atEnd(this.view.state.doc)))}getContentLength(){return this.view.state.doc.content.size}getCurrentText(){return this.view.state.doc.textContent}hasMultipleLines(){let e=0;return this.view.state.doc.descendants(t=>{t.isBlock&&e++}),e>1}getContentToSend(){return Ot(this.view)}resize(){}isReady(){return!!this.view.state.doc}setPlaceholder(e){this.view.dispatch(this.view.state.tr.setMeta(G,{placeholder:e}))}getSelectionStart(){return this.view.state.selection.ranges[0].$from.pos}setSelection(e,t){this.view.dispatch(this.view.state.tr.setSelection(ae.create(this.view.state.doc,e,t))),this.view.focus()}isMenuSelectorActive(){return R.getState(this.view.state).active}registerKeyHandlers(e){$t(this.view,e)}registerFileInput(e){this.fileInputHandle=e}openFileDialog(){this.fileInputHandle?.openFileDialog()}acceptLegacyKeydown(){return!1}subscribe(e,t){if(e==="change"){const s=()=>{this.usedDictation&&(this._dictationEdited=!0),t(void 0)};return Re(this.view,s)}return this.view.dom?.addEventListener(e,t,{capture:!0}),()=>{this.view.dom?.removeEventListener(e,t,{capture:!0})}}useState(e){return S.useSyncExternalStore(t=>Re(this.view,t),()=>e(this),()=>e(this))}getSystemHint(){return Jt(this.view.state.tr.doc)[0]??null}getKeywords(){return[...T.getState(this.view.state)?.matchedKeywords??[]]}removeKeywordDecorations(e){e.length!==0&&Wt(e,this.view)}resetTrackingKeywords(e){Gt(e,this.view)}addSystemHint(e,t,s=1,o=1){Bt(this.view,e,t,s,o)}removeSystemHints(){Qt(this.view)}canShowAutocompletion(){const e=this.getSystemHint();return e===ve.PictureV2||e===ve.Tatertot||!this.isMenuSelectorActive()&&!e}}const Yt=B({}),ze=B(void 0),Zt=B(void 0),ue=B(0),de=B(0),mn=({serverThreadId:n,clientThreadId:e,getIsDisabled:t,composerController:s,currentModelId:o,account:i,onReset:r,onInfer:a,isInferEnabledForModel:c})=>{const[u,h]=S.useState(!1),v=De(),b=Pe(v,"657118093").value,Q=Number(b?.web_debounce_ms??400),A=Xe(v,"209963048")&&["gpt-4o","auto"].includes(o),N=Ke(),_=S.useRef(null),C=yt(({enableInferredJuice:g})=>g)||A||c,M=S.useRef(a);M.current=a;const k=S.useRef(0),z=S.useRef(0),P=V(()=>Zt()),f=Ve(e,g=>g?.modelId),D=S.useCallback(St(g=>{if(t())return;et.logEventWithStatsig("chatgpt_web_autoswitch_infer_called","chatgpt_web_autoswitch_infer_called",{is_paid_user:i?.hasPaidSubscription()});const p=g.length,J=p<5?"<5":p<=10?"5-10":p<=20?"10-20":p<=50?"30-50":"50+";if(H.count(L.DEFAULT,"chatgpt_web_autoswitch_infer_called",{prompt_length:J,is_paid_user:i?.hasPaidSubscription()?"true":"false"}),A)return;const j=++k.current,Y=Date.now();h(Y);const O=qe(e),oe=U.getCurrentNode(O);tt.postAnonAware("/conversation/infer",{prompt:g,conversation_id:n??null,is_history_and_training_disabled:N,parent_message_id:oe.message.id,auto_switcher_treatment_override:P,model_id:f},{additionalHeaders:{"x-conduit-token":_.current??""}}).then(w=>{if(_.current=w.conduit_token,t()||z.current>j||s.getContentToSend().content.length<g.length)return;z.current=j;const{effort_mode:re,debug_info:Z,request_id:E}=w;Z&&Yt.set(Z),E&&ze.set(E),ue.set(d=>d+1),de.set(g.length),M.current(re)}).finally(()=>{h(w=>w&&Y<w?w:!1)})},Q),[t,n,P]),m=S.useRef(void 0);return S.useEffect(()=>{if(!C||!(s instanceof jt)){f&&f!==m.current&&(m.current=f);return}const g=()=>{const{content:p}=s.getContentToSend();t()||!C||(p?D(p):(_.current=null,r(),h(!1),++k.current,z.current=k.current))};return f&&f!==m.current&&(m.current=f,g()),s.subscribe("change",()=>{g()})},[C,t,s,D,a,r,n,N,f]),u!==!1};function pn(n){const e=De(),t=Nt(),s=nt(),o=Ke(),i=st(),r=zt(),a=vt(),c=_t(n),u=c&&"gizmo"in c?c.gizmo?.gizmo.id:void 0,h=Tt(u),v=u?h?ke.PROJECT:ke.GPT:void 0,b=bt(),Q=V(()=>ze()),se=V(()=>ue()),A=V(()=>de()),N=Ct(C=>C.threads[n]?.modelSelection),_=N?.type===kt.EFFORT_MODE?N.effortMode:void 0,ie=it(e,"269676899",{disableExposureLog:!0}).get("clear_all",!1);return S.useCallback(async function({requestedModelId:C,completionType:M=ct.Next,sourceEvent:k,eventSource:z,completionMetadata:P,extraStreamParams:f,parentMessageId:D,promptMessage:m,existingMessages:g,prependMessages:p,appendMessages:J,profiler:j,skipNotification:Y}){const O=k?.timeStamp??performance.now(),oe=z??(k?Et(k):"mouse"),w=new AbortController,re=at(),Z=ot(n),E=`request-${n}-${re}`,d=qe(n),{conduitToken:le=null,prepareState:he="none",lastPrepareTimestamp:ge=null}=d??{},X=C??d?.modelId??xt(rt(t)).id,fe=U.findNode(d,l=>l.message.author.role===_e.Assistant||l.message.author.role===_e.Tool)==null,Oe=d?.continuingFromSharedConversationId!=null,$e=!!d?.continuingFromSharedPostId,me=D?U.getNode(d,D):g?.[0]?U.getParentNode(d,g[0].id):U.getCurrentNode(d),Ue=me.message.id??me.id,pe=[...g??[],...p??[],...m?[m]:[],...J??[]],$=new Rt({clientRequestId:E,gizmoType:v,preflightTime:O});if($.onUserMessages(pe),h&&fe&&!ie){const l=P?.systemHints;At(e).set(je=>({...je,[n]:l??[]}))}const K=new Mt(e,E,t,d,n,D,p,m,J,M,X,_??d?.effortMode,oe,o,O,r,h,fe,Oe,$,Y??!1,i,$e),Ge=Pt(n);Dt(n)?.value===Te.REALTIME&&await Ge,ut.publish({kind:"requestCompletion"}),Kt(n,{source:dt.CLIENT,value:Te.STREAMING}),lt.addRequest(E,w,$),qt.onCompletionRequestStarted(E),K.updateBeforeRequest();const We=performance.now(),x=[],q=ht()??(x.push("chatReq"),await gt());q.force_login&&a({authType:"login"});const Be=Ee.getEnforcementTokenSync(q)??(x.push("turnstile"),await Ee.getEnforcementToken(q)),Qe=be.getEnforcementTokenSync(q)??(x.push("proofofwork"),await be.getEnforcementToken(q));t.getQueriesData(Ce)==null&&await t.ensureQueryData(Ce);const we=x.includes("chatReq")?"false":"true",ye=x.includes("turnstile")?"false":"true",Se=x.includes("proofofwork")?"false":"true";H.hist(L.DEFAULT,"chat_req_time",[{key:"wasChatReqSync",value:we},{key:"wasTurnstileSync",value:ye},{key:"wasProofofworkSync",value:Se}],performance.now()-We),ft(mt(),{eventName:"chatgpt_web_completion_integrity_checks",value:x.length===0?"true":"false",metadata:{wasChatReqSync:we,wasTurnstileSync:ye,wasProofofworkSync:Se}}),Ht()&&await Lt();const y=Ft();if($.onCompletionStarted(M,X),K.preflightTime=performance.now()-O,b&&ge!=null){const l=performance.now()-ge;l<=6e4&&H.hist(L.DEFAULT,"fast_conversation_last_prepare_to_convo_client",[{key:"model_id",value:X},{key:"prepare_state",value:String(he)},{key:"has_conduit_token",value:le!=null?"true":"false"}],l)}(_??d?.effortMode)&&(H.hist(L.DEFAULT,"chatgpt_web_autoswitcher_infer_calls_per_message",[],se),ue.set(0),A!==0&&m?H.hist(L.DEFAULT,"chatgpt_web_autoswitcher_prompt_length_difference",[],pt(m).length-A):H.count(L.DEFAULT,"chatgpt_web_autoswitcher_message_before_infer_completed"),de.set(0));const Je=It(e,{conversationOrigin:d?.conversationOrigin??null,model:X,completionType:M,prepareState:he,conduitToken:le,threadId:Z,effortMode:_??d?.effortMode??void 0,inferRequestId:Q,continueFromSharedConversationId:d?.continuingFromSharedConversationId,continueFromSharedPostId:d?.continuingFromSharedPostId,forkFromSharedPost:d?.forkFromSharedPost,historyDisabled:o,isAnonModeEnabled:i,parentMessageId:Ue,messages:pe,chatReq:q,turnstileToken:Be,proofToken:Qe,completionMetadata:P,contextualInfo:{is_dark_mode:s,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window.innerHeight,page_width:window.innerWidth,pixel_ratio:window.devicePixelRatio,screen_height:window.screen.height,screen_width:window.screen.width},isOnboardingConversation:P?.isOnboardingConversation,forceParagen:y.forceParagen,forceParagenModel:y.forceParagen?y.forceParagenModel.value:void 0,forceRateLimit:y.forceRateLimit,resetRateLimits:y.resetRateLimits,recordRendering:y.recordRendering,disableSystemContentToggling:y.rebaseSystemMessageContent!=null,forceUseSearch:y.forceUseSearch??void 0,paragenStreamType:y.paragenStreamType,paragenCotSummaryDisplay:y.paragenCotSummaryDisplay,...b?{f_completion:!0}:{},...f},$,j,w.signal,n);try{for await(const l of Je)l.type==="connected"?K.handleStreamConnected(l):l.type!=="perf_stats"&&l.type!=="server_ste_metadata"&&K.handleResponse(l)}catch(l){wt(l)||w.signal.aborted?K.handleAbort(l):K.handleError(l)}},[n,t,v,h,ie,e,_,o,r,i,b,Q,s,a,se,A])}export{jt as P,te as a,fn as b,rn as c,on as d,Ne as e,un as f,an as g,Ae as h,gn as i,mn as j,cn as k,dn as m,ln as p,hn as s,xe as t,pn as u};
//# sourceMappingURL=hapan2fx2czn21gi.js.map

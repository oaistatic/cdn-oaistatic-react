import{i as ne,r as o,j as e,M as T,a6 as me,a5 as I,v as rt,e as Ie,at as ot}from"./ci5tkrccytan34lo.js";import{ai as Se,iB as it,bL as lt,iC as ct,iH as dt,nu as ut,cN as mt,ei as Ae,u2 as xt,u3 as ft,me as pt,t as xe,o4 as Le,u4 as _e,fS as gt,fT as ht,iG as yt,fV as jt,fW as Nt,u5 as K,fL as De,g4 as bt,g3 as wt,fZ as Et,eb as St,u6 as Rt,pE as vt}from"./fztttvm3qzdvif1h.js";import{aa as kt,ab as ke,B as V,aj as se,s as W,N as z,c as E,ac as Pe,aH as Be,aE as Fe,b as Ue,d as Ct,hu as Ot,bg as Mt,fd as Tt,dc as It,fy as At,eC as Lt,gR as _t,e8 as Dt,hv as Pt,bR as je,o as Bt}from"./ccccre6vnqbb7l94.js";import{T as Re,M as j,l as le,n as ee,o as Ft,p as ce,q as H,g as Ut,i as Wt,d as zt}from"./jm451ka9dh0zq0oh.js";import{a6 as Ht,a5 as $t,a8 as Gt,e as Xt}from"./ehn8yucug7pv4ztd.js";import{L as qt}from"./gy64pge8qevmvg7e.js";const We=({origin:t,url:s})=>e.jsxs("div",{"aria-label":s,className:"w-full min-w-0 pe-4 text-start whitespace-nowrap",children:[e.jsx("span",{"aria-hidden":!0,className:"text-token-text-primary",children:t}),e.jsx("span",{"aria-hidden":!0,className:"text-token-text-tertiary",children:s.replace(t,"")})]}),Yt=({request:t,isDenied:s=!1,onClick:n})=>{const[{width:a},r]=dt();return e.jsxs("button",{ref:r,className:"group relative z-0 my-1 flex w-full items-center",onClick:n,children:[e.jsx("div",{className:"sticky start-0 z-[-1] w-0",children:e.jsx("div",{className:"absolute top-0 hidden h-8 -translate-y-1/2 bg-gray-100 group-hover:block",style:{width:a}})}),e.jsx("div",{className:"bg-token-main-surface-primary text-token-text-secondary sticky start-0 z-10 flex h-8 shrink-0 items-center px-2 group-hover:bg-gray-100",children:s?e.jsx(ut,{className:"icon-md text-red-500"}):e.jsx(mt,{className:"icon-md text-green-500"})}),e.jsx(We,{...t})]})},Kt=({title:t,requests:s})=>{const n=ne(),[a,r]=o.useState(()=>new Set),l=()=>{for(const{requestId:i,approve:u,deny:g}of s)a.has(i)?g():u()},c=()=>{for(const i of s)i.deny()},m=i=>{r(u=>{const g=new Set(u);return g.has(i)?g.delete(i):g.add(i),g})},d=s.length-a.size;return e.jsx(kt,{testId:"modal-confirm-fetch-request",isOpen:!0,shouldIgnoreClickOutside:!0,onClose:l,type:"success",title:e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-xl",children:e.jsx(T,{id:"VmMpF1",defaultMessage:"Allow network access?"})}),e.jsx(Se,{side:"top",contentClassName:"max-w-2xs!",label:e.jsx(T,{id:"WT7tgj",defaultMessage:"Learn more about network requests in canvas"}),children:e.jsx(V,{icon:lt,openNewTab:!0,onClick:()=>it.logButtonClick(ct.LEARN_MODE_ABOUT_NETWORK_REQUESTS),as:"a",color:"ghost",size:"small",className:"text-token-text-secondary aspect-square p-1!",to:"https://help.openai.com/en/articles/9930697-what-is-the-canvas-feature-in-chatgpt-and-how-do-i-use-it#h_cd52fdbc16"})})]}),description:e.jsxs("div",{className:"mt-3 flex flex-col gap-3",children:[e.jsx("span",{className:"text-token-text-primary block",children:e.jsx(T,{id:"qk11AX",defaultMessage:"{title} is trying to connect to the network. If you don’t recognize {numRequests, plural, one {this request} other {any of these requests}}, don’t allow this app access to the network.",values:{title:`"${t}"`,numRequests:s.length}})}),e.jsx("div",{className:"flex max-w-full flex-col",children:s.length>1?e.jsx("ul",{className:"border-token-border-default relative flex max-h-48 flex-col overflow-x-auto overflow-y-auto rounded-lg border",children:s.map(i=>{const{requestId:u}=i;return e.jsx("li",{children:e.jsx(Yt,{request:i,isDenied:a.has(u),onClick:()=>m(u)})},u)})}):e.jsx("div",{className:"no-scrollbar bg-token-main-surface-secondary overflow-x-auto rounded-lg p-2",children:e.jsx(We,{...s[0]})})})]}),primaryButton:e.jsx(ke.Button,{disabled:d===0,title:s.length>1?n.formatMessage({id:"xpKkWv",defaultMessage:"Allow selected ({count})"},{count:d}):n.formatMessage({id:"ZeMrpd",defaultMessage:"Allow"}),color:"primary",onClick:l}),secondaryButton:e.jsx(ke.Button,{title:n.formatMessage({id:"TjJzqR",defaultMessage:"{count, plural, one {Deny} other {Deny all}}"},{count:s.length}),color:"secondary",onClick:c})})},Zt=({instrument:t})=>{switch(t.type){case"hist":return W.hist(z.WEB_SANDBOX,t.label,t.tags,t.value);case"count":return W.count(z.WEB_SANDBOX,t.label,t.tags,t.count);case"error":return se.addError(t.error)}},ze=({size:t=60,thickness:s=1/16,checkpoints:n,activeCheckpointId:a,isComplete:r=!1,onTransitionComplete:l,color:c})=>{const[m,d]=o.useState(0),i=n.findIndex(N=>N.id===a),u=o.useRef(null),g=n[i];o.useEffect(()=>{if(!g||r)return;const N=n.length,f=i*100/N,v=(i+1)*100/N;d(f);let O=null,w=null;const p=5/g.estimatedTime,S=_=>{w==null&&(w=_);const B=_-w;if(B!==0){const A=v-f,P=f+A*(1-Math.exp(-p*B));d(Math.min(P,v-1e-4))}O=window.setTimeout(()=>{u.current=requestAnimationFrame(S)},16)};return u.current=requestAnimationFrame(S),()=>{O!=null&&window.clearTimeout(O),u.current!=null&&cancelAnimationFrame(u.current)}},[i,r]);const x=()=>{r&&l?.()};return e.jsx(Ae,{sizeOverride:t,className:E(c==null&&"text-primary",c==="dark"&&"text-back",c==="light"&&"text-white"),thickness:s,backgroundStrokeClassName:E(c==null&&"stroke-[rgba(0,0,0,0.1)] dark:stroke-[rgba(0,0,0,0.32)]",c==="dark"&&"stroke-[rgba(0,0,0,0.32)]",c==="light"&&"stroke-[rgba(0,0,0,0.1)] "),percentage:r?100:m,onTransitionEnd:x,transitionDuration:"50ms",transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})},Vt=({checkpoints:t,activeCheckpointId:s,isIndeterminate:n=!1,isComplete:a})=>{const[r,l]=o.useState(a);return o.useEffect(()=>{l(a)},[s]),e.jsx(me,{children:(s!=null&&!r||n)&&e.jsxs(I.div,{initial:{opacity:0},exit:{opacity:0},animate:{opacity:1},className:"bg-token-main-surface-primary absolute end-2 bottom-2 flex items-center gap-2 rounded-full px-3 py-1.5 shadow-lg",children:[n?e.jsx(Ae,{percentage:30,thickness:1/12,className:"text-primary animate-spin",backgroundStrokeClassName:"dark:stroke-[rgba(255,255,255,0.4)] stroke-[rgba(0,0,0,0.1)]",sizeOverride:12}):s&&e.jsx(ze,{size:12,thickness:1/12,checkpoints:t,activeCheckpointId:s,isComplete:a,onTransitionComplete:()=>l(!0)}),e.jsxs("span",{className:"text-token-text-secondary flex items-baseline text-sm",children:[e.jsx(T,{id:"zfcWbe",defaultMessage:"Updating"}),e.jsx(Re,{gap:1.5,padding:2,size:2})]})]})})};function Jt(t){let s=null;const n=[];let a=!1;return t.on("message",r=>{s?(s({value:r,done:a}),s=null):n.push(r),r.type===j.RUN_COMPLETE&&(a=!0)}),{[Symbol.asyncIterator](){return this},next(){if(n.length>0){const r=n.shift();return Promise.resolve({value:r,done:a})}return a?Promise.resolve({value:void 0,done:a}):new Promise(r=>{s=r})}}}const Qt="web-sandbox.oaiusercontent.com",Ne=`https://${Qt}`,{origin:es}=new URL(Ne),ts=[es,"https://cdn.jsdelivr.net","https://cdn.tailwindcss.com","https://esm.sh","https://unpkg.com","https://pypi.org","https://files.pythonhosted.org"];function Ce(){let t=null;const s=new Promise(n=>t=n);return{resolve:t,promise:s}}const He=()=>{const[t,s]=o.useState(Ce);return[t,o.useCallback(()=>s(Ce()),[])]},$e=()=>xt(Be.getItem(Fe.CODE_EXECUTION_DOMAIN_ALLOW_LIST),s=>ft(s,{origin:xe,expiresAt:pt}),[]).filter(({expiresAt:s})=>s>=Date.now()),Oe=(t,s)=>{const{origin:n}=new URL(t);let a=[...ts];const r=$e().map(({origin:l})=>l);return s&&(a=a.concat(r)),a.includes(n)},ss=({sessionId:t,networkAccessDeniedMessage:s,disableNetworkRequests:n,unsafeAllowAllNetworkRequests:a})=>{const r=Pe(),l=ne(),c=o.useRef(null),m=o.useRef(null),d=o.useRef(null),[i,u]=o.useState([]),g=o.useCallback(w=>m.current?.postMessage(w),[]),x=o.useCallback(w=>d.current?.postMessage(w),[]);o.useEffect(()=>()=>{x({type:le.DISCONNECT,sessionId:t})},[t]);const N=o.useCallback(({url:w,requestId:p})=>{try{if(a||Oe(w,!n))return x({type:le.FETCH_RESPONSE,isApproved:!0,requestId:p});if(n)return r.danger(s??l.formatMessage({id:"Lp7cKY",defaultMessage:"Network access is disabled."}));W.count(z.WEB_SANDBOX,"network_access_requested");const{origin:S}=new URL(w),_=A=>{W.count(z.WEB_SANDBOX,`network_access_request.${A?"allow":"deny"}`),x({type:le.FETCH_RESPONSE,isApproved:A,requestId:p}),u(P=>P.filter(L=>!a&&!Oe(L.url,!n)&&L.requestId!==p))},B=()=>{Be.setItem(Fe.CODE_EXECUTION_DOMAIN_ALLOW_LIST,[...$e(),{origin:S,expiresAt:Date.now()+90*24*60*60*1e3}]),_(!0)};u(A=>[...A,{url:w,origin:S,requestId:p,approve:B,deny:()=>_(!1)}])}catch(S){se.addError(S),x({type:le.FETCH_RESPONSE,isApproved:!1,requestId:p})}},[n,x,r,s,l,a]),[f,v]=He(),O=o.useCallback(async(w,p)=>{if(w.type===ee.SW_NOT_SUPPORTED)W.count(z.WEB_SANDBOX,"sw_not_supported"),f.resolve?.();else{m.current=p[0],d.current=p[1],d.current.onmessage=S=>{S.data.type==="ready"?f.resolve?.():N(S.data)};try{const{token:S}=await Ue.safeGet("/public/code_execution_challenge",{authOption:Ct.Anonymous,parameters:{query:{relay_client_id:w.clientId}}});g({type:Ft.SW_RECONNECT_RESPONSE,reconnectId:w.reconnectId,sessionId:t,token:S})}catch(S){se.addError(S)}}},[N,g,f,t]);return{relayRef:c,relayInitPromise:f,resetRelayInitPromise:v,handleMessageFromRelay:O,pendingFetchRequests:i}},ns="https://persistent.oaistatic.com/canvas/loop-swirl.mp4",as="https://persistent.oaistatic.com/canvas/loop-swirl-poster.jpg",Q=90,rs=({title:t,checkpoints:s,activeCheckpointId:n,isComplete:a,onTransitionComplete:r})=>{const[l,c]=o.useState(!1),m=s.findIndex(u=>u.id===n),d=s[m],i=()=>{r?.(),c(!0)};return e.jsx(I.div,{className:"relative flex h-full w-full items-center justify-center",transition:{type:"spring",bounce:0},children:e.jsxs(I.div,{className:"flex -translate-y-12 flex-col items-center gap-3",style:{minWidth:Q,height:Q},initial:{opacity:0},animate:{opacity:1},transition:{type:"spring",duration:.5,bounce:0},children:[e.jsxs(I.div,{className:"bg-token-main-surface-primary absolute overflow-hidden rounded-3xl shadow-2xl",initial:!1,animate:{width:Q,height:Q,opacity:l?0:1},transition:{type:"spring",duration:.56,bounce:0},children:[e.jsx("video",{muted:!0,loop:!0,autoPlay:!0,playsInline:!0,src:ns,poster:as,className:E("absolute inset-0 z-0 h-full w-full object-cover transition-opacity duration-200")}),e.jsx("div",{className:E("relative z-10 flex h-full w-full items-center justify-center",l?"opacity-0":"opacity-100"),children:e.jsx(ze,{color:"light",checkpoints:s,activeCheckpointId:n,isComplete:a,onTransitionComplete:i,thickness:1/12})})]}),e.jsxs(I.div,{className:E("flex flex-col items-center transition-opacity duration-200",a?"opacity-0":"opacity-100"),style:{translateY:Q+20},children:[e.jsx("span",{className:"text-token-text-primary font-semibold",children:t}),d&&e.jsx(I.span,{className:"text-token-text-secondary flex items-baseline",children:e.jsx("span",{className:"loading-shimmer",children:d.label})})]})]})})},Me=({sessionId:t})=>"?"+[`sessionId=${t}`,""].filter(Boolean).join("&"),Te=[{id:H.INITIALIZING,label:"Initializing environment",estimatedTime:1e3},{id:H.INSTALLING_PACKAGES,label:"Installing packages",estimatedTime:2e3},{id:H.RUNNING_CODE,label:"Ready",estimatedTime:1}],os=()=>It()?"ios":At()?"windows":Lt()?"android":_t()?"safari":Dt()||Pt()?"chrome":"unknown",is=({isShare:t=!1,disableNetworkRequests:s=!1,unsafeAllowAllNetworkRequests:n=!1,networkAccessDeniedMessage:a,visuallyHidden:r=!1,isCodeUpdating:l=!1,enableTransition:c=!1,disablePermissions:m=!1,title:d,onChangeBackgroundColor:i},u)=>{const[g,x]=o.useState(0),[N]=o.useState(()=>crypto.randomUUID()),{pendingFetchRequests:f,handleMessageFromRelay:v,relayInitPromise:O,resetRelayInitPromise:w,relayRef:p}=ss({sessionId:N,disableNetworkRequests:s,networkAccessDeniedMessage:a,unsafeAllowAllNetworkRequests:n}),S=o.useRef(null),[_,B]=He(),A=o.useMemo(()=>Promise.all([_.promise,O.promise]),[_,O]),[P,L]=o.useState(null),[G,Y]=o.useState(!1),J=o.useRef(null),X=o.useRef(new Map),F=o.useRef(null),D=o.useCallback(h=>{J.current?.postMessage(h)},[]),Z=o.useCallback(()=>{const h=X.current.keys();L(null),Y(!1),i?.(null);for(const y of h)D({type:ce.STOP_CODE,runId:y});F.current=null},[D,i]),ae=o.useCallback(()=>{w(),B(),x(h=>h+1),L(null),Y(!1),F.current=null},[w,B]),he=o.useCallback(async function*({code:h,language:y}){if(L(H.INITIALIZING),W.count(z.WEB_SANDBOX,`${y}.eval`),await A,X.current.size!==0)return Z();const k=rt(),R=new Ot;X.current.set(k,R);const U={code:h,language:y,type:ce.RUN_CODE,runId:k};F.current={runId:k,language:y},D(U);for await(const C of Jt(R))C&&C.type===j.ENVIRONMENT_STATUS&&(L(C.status),c||Y(C.status===H.RUNNING_CODE)),C?.type===j.ERROR?W.count(z.WEB_SANDBOX,`${y}.error`):C?.type===j.RUN_COMPLETE&&C.wasFatalError&&W.count(z.WEB_SANDBOX,`${y}.fatal_runtime_error`),C&&!Le([j.READY],C.type)&&(yield C);L(null),Y(!1),X.current.delete(k)},[A,c,D,Z]),re=o.useCallback(async h=>{await A,D({type:ce.PREPARE_ENVIRONMENT,language:h})},[A,D]),oe=h=>{F.current&&D({type:ce.RUN_CODE,code:h,...F.current})};o.useImperativeHandle(u,()=>({stop:Z,evalAsync:he,updateCode:oe,prepareEnvironment:re})),o.useEffect(()=>Mt(window,{message:h=>{const{data:y,ports:k}=h,{type:R}=y,U=h.source===p.current?.contentWindow,C=h.source===S.current?.contentWindow;if(!U&&!C)return;if(R===j.ENVIRONMENT_ERROR)return se.addError("Code execution environment error",y.error),y.error.name==="ServiceWorker"&&W.count(z.WEB_SANDBOX,"service_worker_connection_failure",[{key:"agent",value:os()},{key:"is_share",value:String(t)}]),y.runId!=null&&y.runId===F.current?.runId&&W.count(z.WEB_SANDBOX,`${F.current.language}.environment_error`),ae();if(U&&(y.type===ee.SW_NOT_SUPPORTED||y.type===ee.SW_RECONNECT))return v(y,k);if(U||!C||R===ee.SW_RECONNECT||R===ee.SW_NOT_SUPPORTED)return;if(J.current=k[0],R===j.READY)return _.resolve?.();if(R===j.SET_BACKGROUND_COLOR)return i?.(y.backgroundColor);if(R===j.INSTRUMENT)return Zt(y);const{runId:M}=y,q=M&&X.current.get(M);q?q.emit("message",y):se.addError("Code execution error: missing event emitter",{messageData:h.data})}}),[i,ae,v,O,p,_,N,t]);const ie={type:"spring",duration:G&&c?.56:0,delay:G?.12:0,bounce:0},b=m?"":"midi";return e.jsxs(Tt,{children:[e.jsx("iframe",{title:"relay","aria-hidden":"true",className:"fixed h-0 w-0",allow:b,ref:p,src:`${Ne}/relay.html${Me({sessionId:N})}`},`relay-${g}`),e.jsxs("div",{className:E("relative flex",r?"fixed h-0 w-0":"h-full w-full"),children:[!r&&P!=null&&c&&e.jsx(rs,{isComplete:P===H.RUNNING_CODE,onTransitionComplete:()=>Y(!0),activeCheckpointId:P,title:d,checkpoints:Te}),e.jsx(I.div,{className:E("bg-token-main-surface-primary absolute inset-0 m-auto origin-center overflow-hidden",G?"pointer-events-auto":"pointer-events-none"),animate:{opacity:G?1:0,...G?{scale:1}:{scale:.95}},transition:ie,children:e.jsx(I.iframe,{title:d,className:"h-full w-full overflow-hidden",transition:ie,"aria-hidden":r?"true":void 0,allow:b,src:`${Ne}/index.html${Me({sessionId:N})}`,sandbox:"allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox",ref:S,tabIndex:-1},`sandbox-${g}`)}),G&&e.jsx(Vt,{isIndeterminate:l,isComplete:P===H.RUNNING_CODE,activeCheckpointId:P,checkpoints:Te})]}),f.length>0&&e.jsx(Kt,{title:d,requests:f})]})},Ls=o.forwardRef(is),ls=({onClose:t,title:s,actions:n,showBorder:a=!1})=>e.jsxs("div",{className:E("bg-token-main-surface-primary flex items-center justify-between border-b py-2 ps-2 pe-2.5",{"border-token-border-xlight":a,"border-transparent":!a}),children:[e.jsx("div",{className:"text-token-text-primary flex items-center gap-2 ps-4 text-sm select-none",children:s}),e.jsxs("div",{className:"flex items-center gap-2",children:[n.map(({tooltip:r,icon:l,onClick:c},m)=>{const d=e.jsx(V,{size:"small",color:"ghost",as:"button",className:"text-token-text-primary aspect-square p-1!",icon:l,onClick:c},m);return r?e.jsx(Se,{label:r,children:d},m):d}),e.jsx(V,{size:"small",color:"ghost",as:"button",className:"text-token-text-primary aspect-square p-1!",onClick:t,icon:_e})]})]}),cs=({onDrag:t,onDragEnd:s,onDoubleClick:n})=>e.jsx(I.div,{drag:"y",className:"bg-token-text-quaternary absolute top-[-2px] z-10 h-[4px] w-full cursor-ns-resize opacity-0",whileHover:{opacity:.5},whileDrag:{opacity:.75,height:"8px",top:"-4px"},transition:{type:"tween",duration:.1},style:{x:0,y:0,transform:"translateY(0px)"},dragMomentum:!1,dragSnapToOrigin:!1,dragElastic:!1,dragConstraints:{left:0,right:0,top:0,bottom:0},onDrag:(a,r)=>{t?.(r)},onDragEnd:s,onDoubleClick:n}),ds=({textdocTitle:t,onClickViewConsole:s,onClickFix:n,onDismiss:a})=>e.jsxs(I.div,{initial:{scale:.95,opacity:0},exit:{scale:.95,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",bounce:.12,duration:.3},className:"border-token-border-default bg-token-main-surface-primary absolute end-2 bottom-2 flex w-fit max-w-80 flex-col gap-4 rounded-xl border px-4 py-4 shadow-xl",children:[e.jsxs("div",{className:"flex items-start",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"text-sm font-semibold",children:e.jsx(T,{id:"ObCQBq",defaultMessage:"Cannot preview your code"})}),e.jsx("div",{className:"text-sm",children:e.jsx(T,{id:"3ZeoP8",defaultMessage:"An error occured while trying to run {name}",values:{name:t}})})]}),e.jsx(V,{size:"small",color:"ghost",as:"button",className:"text-token-text-tertiary -m-1! aspect-square p-0!",onClick:a,icon:_e})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(V,{size:"small",color:"secondary",onClick:s,children:e.jsx(T,{id:"Fch32I",defaultMessage:"View console"})}),e.jsx(V,{size:"small",color:"primary",onClick:n,children:e.jsx(T,{id:"HRfYX0",defaultMessage:"Fix bug"})})]})]}),Ge=(t,{name:s,message:n,line:a,stack:r})=>{const l=a!=null?`

Error occured in:
${t.split(`
`).slice(a-1,a+1).join(`
`)}`:"";return`${s}: ${n}

Stack:
${r.join("")}${l}`},ye=new qt({capacity:5}),us=async(t,s,n)=>{const a=Ge(s,n.error),r=xe(ye.get(a));if(ye.get(a))return r;const{hint:l}=await Ue.safePost("/textdoc/{textdoc_id}/code/hint",{parameters:{path:{textdoc_id:t}},requestBody:{error:a,line:n.error.line??-1}});return ye.set(a,l),l},Xe=t=>Le([j.ERROR,j.LOG,j.OUTPUT],t.type),qe=t=>t.type===j.OUTPUT&&Ye(t.output),Ye=t=>typeof t=="string"&&t.startsWith("data:image/png;"),te=({as:t="li",contentBefore:s,contentAfter:n,disableEntryAnimation:a=!1,hasHint:r=!1,bottomBorder:l=!1,isHintOpen:c=!1,isSticky:m=!1,onClick:d,children:i})=>{const u=!!d,g=t==="div"?I.div:I.li;return e.jsxs(g,{initial:a?!1:{opacity:0},animate:{opacity:1},transition:{duration:.32},role:u?"button":void 0,className:E("bg-token-main-surface-primary flex items-start justify-between py-1.5 ps-6 pe-4 font-mono text-sm whitespace-pre",l&&"border-token-border-xlight border-b",m&&"sticky top-0 z-10",u&&"cursor-pointer",u&&r&&"hover:bg-red-500/10",u&&!r&&"hover:bg-gray-50 dark:hover:bg-gray-700",r&&c&&"bg-red-500/10"),onClick:u?d:void 0,children:[s&&e.jsx("div",{className:"me-3 flex h-6 w-5 items-start",children:s}),e.jsx("div",{className:"flex min-h-6 min-w-0 flex-1 items-start justify-start gap-2 leading-6",children:i}),n&&e.jsx("div",{className:"ms-3 flex min-h-6 items-start leading-6",children:n})]})};var $=(t=>(t.LOADING="loading",t.READY="ready",t.RESOLVED="resolved",t))($||{});const Ke=({hint:t,onClickFix:s,isOpen:n,onOpenChange:a})=>{const r=o.useRef(null),l=ne();return t?e.jsx("div",{className:"relative flex items-center font-sans",onClick:c=>c.stopPropagation(),children:e.jsxs(gt,{open:n,onOpenChange:a,children:[e.jsx(ht,{asChild:!0,ref:r,children:t.status==="resolved"?e.jsx("div",{className:"flex h-5 w-5 items-center",children:e.jsx(yt,{className:"text-token-text-tertiary",size:16})}):e.jsx("button",{className:"h-5 w-5",disabled:t.status==="loading",children:t.status==="loading"?e.jsx(Ht,{}):e.jsx($t,{position:"static",isError:!0,count:1,offsetY:0})})}),e.jsx(me,{children:n&&e.jsx(jt,{forceMount:!0,container:r.current?.ownerDocument.body,children:e.jsx(Nt,{side:"top",align:"start",alignOffset:-4,sideOffset:10,children:e.jsx(Gt,{position:"static",translateY:0,right:0,isFocused:!0,onDismiss:()=>a?.(!1),onAccept:c=>{a?.(!1),s?.(c)},comment:t,acceptButtonLabel:l.formatMessage({id:"Dl9vBh",defaultMessage:"Fix bug"})})})})})]})}):e.jsx("div",{className:"w-5"})},ms=t=>o.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...t},o.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M18.7071 12.7071C19.0976 12.3166 19.0976 11.6834 18.7071 11.2929L13.7071 6.29289C13.3166 5.90237 12.6834 5.90237 12.2929 6.29289C11.9024 6.68342 11.9024 7.31658 12.2929 7.70711L15.5858 11H6C5.44771 11 5 11.4477 5 12C5 12.5523 5.44771 13 6 13H15.5858L12.2929 16.2929C11.9024 16.6834 11.9024 17.3166 12.2929 17.7071C12.6834 18.0976 13.3166 18.0976 13.7071 17.7071L18.7071 12.7071Z",fill:"currentColor"})),fe=t=>Array.isArray(t)||K(t)||t instanceof Map||t instanceof Set,pe=t=>t==null||typeof t=="string"||typeof t=="number"||typeof t=="boolean",Ze=t=>K(t)?Object.entries(t):Array.from(t.entries()),Ve=t=>`${typeof t}:${typeof t=="object"?JSON.stringify(t):t}`,xs=({isPreview:t=!1,value:s})=>{const[n,a]=o.useState(!1);return pe(s)?e.jsx(ge,{value:s,depth:0}):fe(s)?e.jsxs("span",{className:E("relative z-0 max-w-full font-mono text-sm leading-6",n&&"w-full flex-auto"),children:[e.jsxs("span",{role:"button",className:"group/row flex flex-wrap items-center gap-x-1 italic",onClick:()=>a(!n),children:[!t&&e.jsx(st,{isExpanded:n}),e.jsx(Qe,{value:s,depth:0}),e.jsx(we,{value:s})]}),n&&!t&&e.jsx("div",{className:"ps-6",children:e.jsx(et,{value:s,depth:0})})]}):e.jsx("span",{className:"truncate",children:String(s)})},Je=({value:t,depth:s=0})=>fe(t)?e.jsx(et,{depth:s,value:t}):pe(t)?e.jsx(ge,{depth:s,value:t}):e.jsx("span",{className:"truncate",children:String(t)}),Qe=({value:t,depth:s=0})=>{const n=Array.isArray(t),a=Ze(t);return e.jsxs("div",{className:"inline-flex max-w-fit min-w-0 grow basis-0",children:[!K(t)&&e.jsx(be,{isShort:!0,isSecondary:!0,collection:t}),n?"[":"{",e.jsx("span",{className:"inline-flex max-w-fit min-w-0 shrink grow basis-0 overflow-hidden",children:a.map(([r,l],c)=>{let m=null;return fe(l)?m=e.jsx(be,{collection:l}):pe(l)?m=e.jsx(ge,{truncate:!0,depth:s+1,value:l}):m=e.jsx(Je,{depth:s+1,value:l}),e.jsxs(o.Fragment,{children:[(K(t)||t instanceof Map)&&e.jsx("span",{className:"text-token-text-secondary min-w-[2em] shrink truncate whitespace-pre",children:e.jsx(tt,{value:t,propertyKey:r})}),m,c<a.length-1&&e.jsx("span",{className:"whitespace-pre",children:", "})]},Ve(r))})}),n?"]":"}"]})},et=({value:t,depth:s=0})=>{const[n,a]=o.useState(()=>new Set),r=Ze(t);return e.jsx("ol",{className:"flex flex-col ps-6 font-mono",children:r.map(([l,c])=>{const m=Ve(l),d=n.has(m),i=fe(c),u=()=>{a(g=>{const x=new Set(g);return x.has(m)?x.delete(m):x.add(m),x})};return e.jsxs("li",{className:E("flex ps-1 whitespace-nowrap",i&&"flex-col",!i&&"group/row flex-wrap"),onClick:g=>g.stopPropagation(),children:[e.jsxs("span",{onClick:i?u:void 0,role:i?"button":void 0,className:E("group/row z-10 -ms-1 min-w-0 items-center gap-x-1",i?"flex":"inline-flex"),children:[i&&e.jsxs(e.Fragment,{children:[e.jsx(fs,{}),e.jsx(st,{shiftLeft:!0,isExpanded:d})]}),e.jsx("span",{className:E("font-bold",(K(t)||Array.isArray(t))&&"text-red-900 dark:text-blue-400"),children:e.jsx(tt,{value:t,propertyKey:l})}),i&&!d&&e.jsx(Qe,{value:c,depth:s+1}),i&&d&&e.jsx(be,{isSecondary:!0,collection:c}),i&&e.jsx(we,{value:c})]}),(!i||d)&&e.jsx(Je,{value:c,depth:s+1}),(typeof c=="string"||typeof c=="number")&&e.jsx(we,{value:c})]},m)})})},ge=({value:t,truncate:s=!1})=>typeof t=="string"?e.jsxs("span",{className:E("dark:text-blue-75 text-red-500",s&&"max-w-fit min-w-[2em] shrink-0 grow basis-0 overflow-hidden text-ellipsis whitespace-nowrap",!s&&"break-words break-all whitespace-normal"),children:["'",t,"'"]}):e.jsx("span",{className:E("whitespace-nowrap",t==null?"text-token-text-secondary":"dark:text-brand-purple-600 text-blue-500"),children:String(t)}),fs=()=>e.jsx("span",{className:"absolute start-0 end-0 z-[-1] h-6 rounded-md group-hover/row:bg-gray-50 dark:group-hover/row:bg-gray-700"}),be=({collection:t,isSecondary:s=!1,isShort:n=!1})=>{let a=null;return Array.isArray(t)&&t.length>0?a=n?`(${t.length})`:`Array(${t.length})`:t instanceof Set?a=`Set(${t.size})`:t instanceof Map?a=`Map(${t.size})`:K(t)&&(a="{…}"),a&&e.jsx("span",{className:E(s&&"text-token-text-secondary"),children:a})},tt=({value:t,propertyKey:s})=>K(t)||Array.isArray(t)?`${xe(s)}: `:t instanceof Map?e.jsxs("span",{className:"inline-flex items-center gap-1",children:[pe(s)?e.jsx(ge,{value:s,depth:0}):e.jsx("span",{className:"text-token-text-secondary",children:JSON.stringify(s)}),e.jsx(ms,{className:"icon-sm text-token-text-secondary"})]}):null,st=({isExpanded:t,shiftLeft:s=!1})=>e.jsx("button",{className:E("flex h-5 shrink-0 items-center overflow-hidden",s&&"ms-[-16px]"),children:e.jsx(De,{className:E("icon-sm text-token-text-secondary transition-transform",t&&"rotate-90")})}),we=({value:t})=>{const s=Pe(),n=()=>{wt(JSON.stringify(t),s)};return e.jsx("span",{className:E("text-token-text-secondary relative inline-block h-4 self-center opacity-0 transition-opacity","group-hover/row:opacity-100 group-hover/row:delay-500","hover:after:bg-token-main-surface-tertiary after:pointer-events-none after:absolute after:inset-[-4px] after:z-0 after:rounded-lg after:content-['']"),children:e.jsx(bt,{iconClassName:"icon-sm z-10",iconOnly:!0,onCopy:n})})},ps="module:",Ee=({log:t,isDisabled:s=!1,onClick:n})=>e.jsx("div",{className:"flex items-center",children:"line"in t&&t.line!=null&&e.jsxs("button",{onClick:()=>t.line!=null&&n?.(t.line),className:"text-token-text-tertiary select-none enabled:hover:underline",disabled:s,children:[ps,t.line]})}),gs=({isPreview:t=!1,log:s,level:n})=>e.jsxs("span",{className:E("text-token-text-primary flex min-w-0 flex-wrap gap-1",t?"shrink truncate":"whitespace-pre-wrap",n==="warn"&&"text-yellow-600"),children:[n==="warn"&&"[warn]: ",typeof s=="string"?s:s.map((a,r)=>e.jsx(xs,{isPreview:t,value:a},r))]}),nt=({error:t,isPreview:s=!1,isResolved:n=!1})=>{const a=t.name+":";return e.jsxs("span",{className:E("whitespace-pre-wrap",n?"text-token-text-primary":"text-red-500"),children:[e.jsx("span",{className:"font-semibold",children:a})," ",t.message,e.jsx("div",{children:t.stack.length>0&&!s?t.stack.join(`
`):""})]})},hs=({output:t,isPreview:s=!1})=>{const n=ne();return t==null?null:Ye(t)?e.jsx("img",{alt:n.formatMessage(js.imgAlt),className:E(s&&"border-token-border-xlight h-6 rounded-lg border"),src:t}):e.jsx("span",{className:"flex items-center gap-2",children:xe(t)})},ve=({log:t,isHintResolved:s,isPreview:n=!1})=>{switch(t.type){case j.LOG:return e.jsx(gs,{isPreview:n,...t});case j.ERROR:return e.jsx(nt,{isPreview:n,isResolved:s,...t});case j.OUTPUT:return e.jsx(hs,{isPreview:n,...t});default:return null}},ys=({log:t,isStale:s=!1,onClickFix:n,onClickLineNumber:a,hint:r})=>{const[l,c]=o.useState(!1);if(t.type===j.RUN_COMPLETE)return null;const m=r?.status===$.RESOLVED,d=t.type===j.ERROR&&r?.status===$.READY;return e.jsx(te,{hasHint:d,isHintOpen:l,bottomBorder:!0,onClick:r&&!m&&(()=>c(!0)),contentBefore:e.jsx(Ke,{hint:r,isOpen:l,onOpenChange:c,onClickFix:i=>t.type===j.ERROR&&r&&n?.(i,r.id,t.error)}),contentAfter:e.jsx(Ee,{log:t,isDisabled:s,onClick:a}),children:e.jsx(ve,{log:t,isHintResolved:m})})},js=Ie({imgAlt:{id:"L6t7Yb",defaultMessage:"Plot"},ranCode:{id:"ffa9Nt",defaultMessage:"Ran code"},askForHelp:{id:"wMZco9",defaultMessage:"Ask ChatGPT for help"},askForFix:{id:"A9pxgT",defaultMessage:"Fix it for me"}}),Ns=({timestamp:t,duration:s})=>{const[,n]=o.useState(0);o.useEffect(()=>{setInterval(()=>{n(l=>l+1)},5e3)},[]);const a=Date.now(),r=Math.round((a-t)/1e3);return e.jsx(Se,{label:e.jsx(T,{id:"bFO21A",defaultMessage:"Code ran {count, plural, =0 {instantly} one {in # second} other {in # seconds}}",values:{count:Math.floor(s/1e3)}}),children:e.jsx("span",{className:"text-token-text-tertiary",children:r>=60?e.jsx(ot,{value:-r,updateIntervalInSeconds:60,numeric:"auto"}):e.jsx(T,{id:"bRCEFN",defaultMessage:"Just now"})})})},at=({isComplete:t,timestamp:s,duration:n})=>t&&s!=null&&n!=null?e.jsx(Ns,{timestamp:s,duration:n}):t&&n==null?e.jsx("span",{className:"text-token-text-tertiary",children:e.jsx(T,{id:"EMebM9",defaultMessage:"Stopped"})}):e.jsx(Re,{gap:2}),bs=t=>{switch(t){case H.INITIALIZING:return e.jsx(T,{id:"J183Z0",defaultMessage:"initializing environment"});case H.INSTALLING_PACKAGES:return e.jsx(T,{id:"21sQ8o",defaultMessage:"installing packages"});case H.RUNNING_CODE:return e.jsx(T,{id:"nHITHk",defaultMessage:"running code"})}},de=({message:t,isComplete:s,statusLogs:n})=>{const a=je(n);return e.jsxs("span",{className:"flex items-center",children:[e.jsx("span",{className:"text-token-text-secondary font-semibold",children:e.jsx(T,{...t})}),!s&&a&&e.jsxs(I.span,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{delay:.3,duration:.1},className:"text-token-text-tertiary ms-2 flex items-baseline",children:[bs(a.status),e.jsx(Re,{gap:2,size:2})]})]})},ws=({children:t,firstLog:s,lastLog:n,isHintResolved:a,duration:r,isComplete:l=!1,isLast:c=!1,statusLogs:m})=>{const[d,i]=o.useState(!0),[u,g]=o.useState(!1),x=o.useRef(null),N=()=>{i(!d)};return o.useEffect(()=>{const{current:f}=x;if(!f)return;const v=new IntersectionObserver(O=>{O[0].intersectionRatio===0?g(!0):g(!1)},{threshold:0});return v.observe(f),()=>v.unobserve(f)},[]),e.jsxs("li",{className:"relative flex flex-col",children:[e.jsx("div",{"aria-hidden":"true",className:"pointer-events-none absolute h-[1px] bg-transparent",ref:x}),e.jsxs(te,{as:"div",disableEntryAnimation:!0,isSticky:!0,bottomBorder:u||!c&&!d,contentAfter:e.jsx(at,{isComplete:l,duration:r,timestamp:s?.timestamp}),contentBefore:e.jsx("button",{className:"text-token-text-tertiary",onClick:()=>N(),children:e.jsx(De,{className:E("icon-md transition-transform",d&&"rotate-90")})}),onClick:()=>N(),children:[e.jsx(de,{isComplete:l,message:ue.run,statusLogs:m}),!d&&n&&e.jsx(ve,{isPreview:!0,isHintResolved:a,log:n})]}),d&&t]})},Es=({runMessages:t,onClickFix:s,onClickLineNumber:n,hints:a,isStale:r,isLast:l,includeContentBefore:c=!1})=>{const[m,d]=o.useState(!1),i=t.filter(p=>p.type===j.ENVIRONMENT_STATUS),u=t.filter(Xe),g=je(t),x=g?.type===j.RUN_COMPLETE,N=x?g.duration:null,f=u[0];if(x){if(u.length===0)return e.jsx(te,{isHintOpen:m,bottomBorder:!0,contentBefore:c,contentAfter:e.jsx(at,{isComplete:x,duration:N,timestamp:f?.timestamp}),children:e.jsx(de,{isComplete:x,message:ue.success,statusLogs:i})});if(u.length===1&&f?.type===j.ERROR){const p=a.get(f.id);return e.jsxs(te,{hasHint:!!p,isHintOpen:m,bottomBorder:!0,contentBefore:(c||!!p)&&e.jsx(Ke,{hint:p,isOpen:m,onOpenChange:d,onClickFix:S=>s?.(S,f.id,f.error)}),contentAfter:e.jsx(Ee,{log:f,isDisabled:r,onClick:n}),onClick:p&&p.status!==$.RESOLVED&&(()=>d(!0)),children:[e.jsx(de,{isComplete:x,message:ue.run,statusLogs:i}),e.jsx(nt,{isResolved:p?.status===$.RESOLVED,...f})]})}else if(u.length===1&&f&&!qe(u[0]))return e.jsxs(te,{bottomBorder:!0,contentBefore:c,contentAfter:e.jsx(Ee,{log:f,isDisabled:r,onClick:n}),children:[e.jsx(de,{isComplete:x,message:ue.run,statusLogs:i}),e.jsx(ve,{log:f})]})}const v=je(u.filter(p=>p.type!==j.RUN_COMPLETE)),w=(v&&a.get(v.id))?.status===$.RESOLVED;return e.jsx(ws,{statusLogs:i,firstLog:f??null,lastLog:v??null,duration:N,isComplete:x,isHintResolved:w,isLast:l,children:e.jsx("ol",{children:u.map(p=>e.jsx(ys,{log:p,isStale:r,onClickLineNumber:n,onClickFix:s,hint:a.get(p.id)},p.id))})})},ue=Ie({success:{id:"laZI5H",defaultMessage:"Run successfully"},run:{id:"o7dgBT",defaultMessage:"Run"}}),Ss=`You're a professional developer highly skilled in debugging. The user ran the textdoc's code, and an error was thrown.
Please think carefully about how to fix the error`,Rs=(t,s,n)=>{const a=Ge(t,n);return`
${Ss}, and then rewrite the textdoc to fix it.

- NEVER change existing test cases unless they're clearly wrong.
- ALWAYS add more test cases if there aren't any yet.
- ALWAYS ask the user what the expected behavior is in the chat if the code is not clear.

${s?`# Hint

${s}

`:""}
# Error

${a}`.trim()},vs=({codeRunMessages:t,scrollRef:s,onClose:n,onClickLineNumber:a,onClickFix:r,title:l,headerActions:c,lastRunId:m,hints:d})=>{const i=d.size>0,u=o.useMemo(()=>Object.entries(vt(t,"runId")),[t]),g=u.some(([,x])=>{const N=x.filter(Xe);return N.length>1||N.length===1&&qe(N[0])});return e.jsxs(e.Fragment,{children:[e.jsx(ls,{title:l,actions:c,onClose:n,showBorder:t.length>0}),e.jsx("div",{ref:s,className:"bg-token-main-surface-primary flex flex-1 flex-col-reverse overflow-auto",children:e.jsx("ol",{className:"flex flex-1 flex-col justify-start pb-4",children:e.jsx(me,{children:u.map(([x,N],f)=>e.jsx(Es,{runMessages:N,includeContentBefore:g||i,onClickFix:r,onClickLineNumber:a,hints:d,isStale:x!==m,isLast:f===u.length-1},x))})})})]})},ks=({sandboxRef:t,textdocContent:s,textdocTitle:n,textdocId:a,isOpen:r,isTextdocAttachedPending:l,headerActions:c=[],highlightLine:m,createTextdocTurn:d,onOpenChange:i},u)=>{const[g,x]=o.useState(!1),[N,f]=o.useState(!1),[v,O]=o.useState([]),[w,p]=o.useState(0),[S,_]=o.useState(null),[B,A]=o.useState(null),[P,L]=o.useState(()=>new Map),[G,Y]=o.useState(320),J=o.useRef(null),X=ne();o.useEffect(()=>A(null),[s]);const F=v.filter(b=>[j.LOG,j.ERROR,j.OUTPUT].includes(b.type)).length;o.useEffect(()=>{r&&p(F)},[r]);const D=o.useMemo(()=>{for(let b=v.length-1;b>=0;b--){const h=v[b];if(h.runId!==B)return null;if(h.type===j.ERROR)return h}return null},[v,B]),Z=(b,h,y)=>{const k=P.get(h);if(k){const{id:R,content:U}=k;L(C=>{const M=new Map(C);return M.set(R,{id:R,content:U,status:$.RESOLVED}),M})}_(h),d({sourceEvent:b,action:Xt.EDIT,userMessageType:Rt.CONSOLE,content:Rs(s,k?.content??null,y)})},ae=async(b,h)=>{if(!l){L(y=>{const k=new Map(y);return k.set(b,{id:b,status:$.LOADING,content:""}),k});try{const y=await us(a,s,h);L(k=>{const R=new Map(k);return R.set(b,{id:b,status:$.READY,content:y}),R})}catch{L(k=>{const R=new Map(k);return R.delete(b),R})}}},he=async(b,h)=>{const y=Ut(b,h),k=Wt(b,h),R=zt(b);if(!y||!R&&!k)return;R&&i?.(!0),f(!0),O(M=>M.map(q=>({...q,isStale:!0})));let U=!1;const C=Bt(t.current).evalAsync({code:h,language:y});for await(const M of C){if(M.type===j.RUN_START&&requestAnimationFrame(()=>{J.current?.scrollTo({top:0,behavior:"smooth"})}),M.type===j.ERROR){if(M.line!=null){const{line:q}=M;requestAnimationFrame(()=>m(q))}U=!0,ae(M.id,M)}A(M.runId),O(q=>[...q,{...M,isStale:!1}])}U&&i?.(!0),f(!1)};o.useImperativeHandle(u,()=>({runCode:he,stopCode:()=>t.current?.stop()}));const re=!r&&N,oe=re&&D&&D.id!==S,ie=!oe&&re&&F>w;return e.jsxs(me,{children:[g&&e.jsx("div",{className:"pointer-events-auto absolute inset-0 bg-transparent"},"drag-overlay"),ie&&e.jsx(I.button,{initial:{scale:.95,opacity:0},exit:{scale:.95,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",bounce:.12,duration:.3},className:"bg-token-main-surface-primary hover:bg-token-main-surface-secondary absolute end-2 bottom-2 flex items-center gap-2 rounded-full px-3 py-1.5 shadow-lg",onClick:()=>i?.(!0),children:e.jsxs("span",{className:"text-token-text-secondary flex items-center gap-1 text-sm",children:[e.jsx(Et,{className:"icon-sm"}),e.jsx(T,{id:"etzFTa",defaultMessage:"{numLogs, plural, one {{numLogs} message} other {{numLogs} messages}}",values:{numLogs:F}})]})},"view-console"),oe&&e.jsx(ds,{textdocTitle:n,onClickViewConsole:()=>i?.(!0),onDismiss:()=>_(D.id),onClickFix:b=>{Z(b,D.id,D.error)}},"error-modal"),r&&e.jsxs(I.div,{initial:{translateY:"100%",opacity:0},animate:{translateY:"0%",opacity:1},exit:{translateY:"100%",opacity:0},transition:{type:"spring",bounce:0,duration:.48},className:"border-token-border-default relative z-10 w-full border-t shadow-[0px_0px_32px_rgba(0,0,0,0.08)]",children:[e.jsx(cs,{onDragEnd:()=>x(!1),onDrag:({delta:{y:b}})=>{x(!0),Y(h=>h-b)}}),e.jsx("div",{className:"flex flex-col",style:{height:G},children:e.jsx(vs,{scrollRef:J,codeRunMessages:v,onClose:()=>i?.(!1),onClickLineNumber:m,onClickFix:Z,title:X.formatMessage({id:"P9VJDk",defaultMessage:"Console"}),headerActions:[...c,{tooltip:X.formatMessage({id:"gAICYK",defaultMessage:"Clear console"}),icon:St,onClick:()=>{p(0),O([]),L(new Map)}}],lastRunId:B,hints:P})})]},"console")]})},_s=o.forwardRef(ks);export{Ls as C,_s as a};
//# sourceMappingURL=ripbggolk2hb9coi.js.map

import{j as e,r as o,i as F,f as Q,a6 as U,a as V,M as G}from"./ci5tkrccytan34lo.js";import{hG as Y,bX as S,hH as z,eb as X,hI as Z,hJ as $,hK as ee,fK as se,cq as te,cr as J,bW as A,hL as ae,bL as ne,hM as D}from"./fztttvm3qzdvif1h.js";import{J as _,a as oe,c as w,S as ie,d as re}from"./ffsp1o78v8949lnz.js";import{J as ce,S as ue}from"./7ek1xya4a58vgvu1.js";import{ac as B,s as le,N as me,c as E,gP as L,cu as H,aT as de,ck as fe,aj as he}from"./ccccre6vnqbb7l94.js";import{u as ge}from"./ka0et6663iazot39.js";import{g as xe,a as pe}from"./l9vpjmbivd4kh2pb.js";function je({icon:s,children:t,isOpen:a,setIsOpen:n}){return e.jsx(se,{className:"p-0",alignAgainstAnchor:"start",triggerButton:e.jsx("button",{className:E("hover:bg-token-main-surface-secondary flex h-[34px] w-[34px] items-center justify-center rounded-lg",a&&"bg-token-main-surface-secondary"),children:s}),open:a,onOpenChange:n,children:t})}function M({label:s,icon:t,disabled:a=!1,onClick:n}){return e.jsxs("button",{className:"hover:bg-token-main-surface-secondary flex w-full items-center gap-2 rounded-sm p-2",disabled:a,onClick:n,children:[e.jsx("div",{className:"flex h-7 w-7 items-center justify-center",children:t}),e.jsx("div",{className:"text-sm",children:s})]})}function be(){return e.jsx(W,{children:e.jsx(K,{children:e.jsxs("div",{className:"my-2 flex flex-col justify-center",children:[e.jsx("div",{className:"loading-results-shimmer bg-token-main-surface-secondary h-2 w-1/2 rounded-full"}),e.jsx("div",{className:"loading-results-shimmer bg-token-main-surface-secondary mt-3 h-2 w-2/5 rounded-full"})]})})})}function W({children:s}){return e.jsx("div",{className:E("border-token-border-default relative inline-block max-w-[360px] min-w-[320px] overflow-hidden rounded-2xl border shadow-[0_2px_16px_0_rgba(0,0,0,0.04)]"),children:s})}function K({children:s}){return e.jsx("div",{className:"h-full w-full py-4 ps-5 pe-3",children:s})}function Ne({automation:s}){return s?e.jsx(we,{item:s}):null}function we({item:s}){const t=B();o.useEffect(()=>{le.count(me.JAWBONE,"jawbone_message_attachment.open")},[]);const{id:a,is_enabled:n,title:h}=s,[l,i]=o.useState(!1),m=o.useRef(null);o.useEffect(()=>{if(m.current){const u=m.current.clientHeight,p=parseFloat(getComputedStyle(m.current).lineHeight);i(u>p)}},[h]);const c=s.next_run_times.length===0,[d,f]=o.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(W,{children:[e.jsx("button",{className:"hover:bg-token-main-surface-secondary h-full w-full",onClick:()=>f(!0),children:e.jsx(K,{children:e.jsx("div",{className:E("flex cursor-pointer justify-between",l?"items-start":"items-center"),children:e.jsxs("div",{className:"flex flex-col gap-[2px] pe-12 text-sm",children:[e.jsx("div",{ref:m,className:"line-clamp-2 text-start font-medium",children:h}),e.jsx("div",{className:"text-token-text-secondary text-start",children:e.jsx(_,{initialScheduleComponents:s.schedule_components,nextRunTimes:s.next_run_times,children:e.jsx(ce,{item:s})})})]})})})}),e.jsx("div",{className:"absolute end-3 top-1/2 -translate-y-1/2 transform",children:e.jsx("div",{className:"ms-4 flex",children:e.jsx(ve,{automation_id:a,is_enabled:n,item:s,isFinished:c,onEditModalOpen:()=>f(!0)})})})]}),d&&e.jsx(_,{initialScheduleComponents:s.schedule_components,nextRunTimes:s.next_run_times,children:e.jsx(oe,{item:s,source:"chat",onClose:u=>{u&&t.success(u,{hasCloseButton:!0}),f(!1)}})})]})}function ve({automation_id:s,is_enabled:t,item:a,isFinished:n,onEditModalOpen:h}){const l=F(),i=Q(),m=B(),[c,d]=o.useState(t);o.useEffect(()=>d(t),[t]);const{mutate:f,isPending:u}=Y({automation_id:s,onError:r=>{m.danger(l.formatMessage(r?w.messages.enableFailure:w.messages.pauseFailure),{hasCloseButton:!0}),d(!r)}}),[p,g]=o.useState(!1),[b,v]=o.useState(!1);return e.jsxs(je,{icon:e.jsx(ee,{className:"icon-md"}),isOpen:b,setIsOpen:v,children:[e.jsxs("div",{className:"m-2",children:[!n&&e.jsxs(e.Fragment,{children:[e.jsx(M,{icon:e.jsx(z,{className:"icon-md"}),label:l.formatMessage(S.attachmentEdit),onClick:h}),e.jsx(M,{icon:c?e.jsx(ie,{className:"icon-md"}):e.jsx(ue,{className:"icon-md"}),label:l.formatMessage(c?w.messages.pause:w.messages.resume),onClick:()=>{const r=!c;d(r),f({is_enabled:r}),v(!1)},disabled:u})]}),n&&e.jsx(M,{icon:e.jsx(X,{className:"icon-md"}),label:l.formatMessage(w.messages.delete),onClick:()=>{g(!0)}})]}),e.jsx("hr",{className:"border-token-border-default w-full"}),e.jsx("div",{className:"m-2",children:e.jsx(M,{icon:e.jsx($,{className:"icon-md"}),label:l.formatMessage(S.attachmentViewAll),onClick:()=>{i(Z())}})}),p&&e.jsx(re,{item:a,onClose:()=>g(!1),onConfirm:()=>g(!1)})]})}function Me({highlightedText:s,shouldShimmer:t,className:a}){return e.jsx(U,{children:e.jsx("div",{className:E(t&&"loading-shimmer-pure-text","absolute start-0 top-0 flex h-8 gap-1 overflow-hidden",a),children:e.jsx("span",{children:s})})})}const O="Too many active automations";function De({clientThreadId:s,currentGroupedMessage:t,nextMessage:a,isLastMessage:n,isRequestActive:h}){const l=n||a,i=h&&!a,m=o.useRef(i);o.useEffect(()=>{i&&(m.current=i)},[i]);const c=t,d=o.useMemo(()=>{for(const x of c?.messages||[]){const j=L(x.author.name);if(j?.namespace===H.DE1D73E)return j}},[c]),f=Se(c,i),u=f?.automationId??"",p=f?.updatedAt??"0",g=f?.error,[b,v]=o.useState(!0),{automation:r,error:N}=ge(u);o.useEffect(()=>{N&&N instanceof de&&(N.status===404||N.status===410)&&v(!1)},[N]);const C=V();o.useEffect(()=>{if(!b)return;const x=new Date(p),j=new Date(r?.updated_at);!isNaN(x.getTime())&&!isNaN(j.getTime())&&j<x&&C.invalidateQueries({queryKey:te.getAutomationQueryKey(u)})},[r,u,p,b,C]);const y=c.messages,P=y[y.length-1]?.metadata?.permissions,T=o.useMemo(()=>P?.some(x=>x.type==="notification"&&x.status==="requested"),[P]);o.useEffect(()=>(g===O&&m.current&&J.setMaxBannerClientThreadId(s),()=>{J.clearMaxBannerClientThreadId()}),[g,s]),o.useEffect(()=>{A.initIfNeeded()},[]);const k=y[0].create_time,R=o.useRef(!1),I=Ae();if(o.useEffect(()=>{(async()=>{if(!I){A.clearNotificationRequest();return}if(R.current)return;await ye(r,T,k)&&(R.current=!0,A.setRequestingClientThreadId(s))})()},[r,k,s,T,I]),!i&&g&&g!==O)return e.jsx(Ee,{errorUserMessage:f?.errorUserMessage});if(b&&l){if(u)return e.jsx("div",{className:"mb-3",children:r?e.jsx(Ne,{automation:r}):i?e.jsx(q,{functionName:d?.functionName}):e.jsx(be,{})});if(i&&d)return e.jsx(q,{functionName:d.functionName})}return null}function q({functionName:s}){const t=F();return e.jsx("div",{className:"text-token-text-secondary relative h-8 first:mt-0",children:e.jsx(Me,{highlightedText:t.formatMessage(s==="update"?S.updatingAutomation:S.makingAutomation),className:"me-1.5 mt-1 items-center justify-start",shouldShimmer:!0})})}function Se(s,t){return o.useMemo(()=>{if(t)return;const a=s?.messages?.find(n=>L(n.author.name)?.namespace===H.DE1D73E);if(a)try{const n=JSON.parse(fe(a));return n.status==="ERROR"?{error:n.message,errorUserMessage:n.user_message}:{automationId:n.jawbone.id,updatedAt:n.jawbone.updated_at}}catch(n){he.addError("Jawbone: Failed to parse automation message",{cause:n});return}},[s,t])}function Ee({errorUserMessage:s}){return e.jsxs("div",{className:"text-token-text-error flex items-center gap-2 pb-1",children:[e.jsx(ne,{className:"icon-sidebar"}),e.jsx("div",{children:s??e.jsx(G,{id:"oOQhkY",defaultMessage:"Task scheduling wasn’t completed — please ask again."})})]})}async function ye(s,t,a){if(!s||!t||!a)return!1;const n=new Date(a*1e3);if(!(Math.abs(new Date().getTime()-n.getTime())<=5*60*1e3))return!1;const i=D.getLastRequestTime();return!(i&&Date.now()-new Date(i).getTime()<24*60*60*1e3||D.getPermission()==="denied"||!await xe()||await pe())}function Ae(){const{data:s}=ae({alwaysRefetchOnMount:!1});return s?.some(t=>t.category==="tasks"&&t.options.some(a=>a.channel==="push"&&a.enabled))}export{De as JawboneMessage};
//# sourceMappingURL=jji0tgdil6wdx1s4.js.map

import{j as t,A as O,r as o,f as _,M as F,e as Q}from"./cs7toih8jegb7teq.js";import{z as L,pq as C,g_ as J,$ as U,e8 as z,a0 as B,pr as H,eg as K}from"./dmck639k4dv7claj.js";import{cg as W,ch as T,cj as M,f0 as Y,f1 as G,ck as y,f2 as v}from"./hnw079jsdm76umup.js";import{u as V}from"./lrrqf1wrtr1tx2vp.js";import{g as $,a as X}from"./hlzwxj9o6a2p2agm.js";function Z({highlightedText:e,shouldShimmer:s,className:a}){return t.jsx(O,{children:t.jsx("div",{className:L(s&&"loading-shimmer-pure-text","absolute start-0 top-0 flex h-8 gap-1 overflow-hidden",a),children:t.jsx("span",{children:e})})})}const I="Too many active automations";function ce({clientThreadId:e,currentGroupedMessage:s,nextMessage:a,isLastMessage:n,isRequestActive:d}){const b=n||a,i=d&&!a,x=o.useRef(i);o.useEffect(()=>{i&&(x.current=i)},[i]);const f=s,l=o.useMemo(()=>{for(const r of f?.messages||[]){const c=C(r.author.name);if(c?.namespace===J.DE1D73E)return c}},[f]),g=ee(f,i),h=g?.automationId??"",E=g?.updatedAt??"0",p=g?.error,[N,k]=o.useState(!0),{automation:u,error:m}=V(h);o.useEffect(()=>{m&&m instanceof U&&(m.status===404||m.status===410)&&k(!1)},[m]);const j=_();o.useEffect(()=>{if(!N)return;const r=new Date(E),c=new Date(u?.updated_at);!isNaN(r.getTime())&&!isNaN(c.getTime())&&c<r&&j.invalidateQueries({queryKey:W.getAutomationQueryKey(h)})},[u,h,E,N,j]);const w=f.messages,R=w[w.length-1]?.metadata?.permissions,A=o.useMemo(()=>R?.some(r=>r.type==="notification"&&r.status==="requested"),[R]);o.useEffect(()=>(p===I&&x.current&&T.setMaxBannerClientThreadId(e),()=>{T.clearMaxBannerClientThreadId()}),[p,e]),o.useEffect(()=>{M.initIfNeeded()},[]);const S=w[0].create_time,D=o.useRef(!1),P=ae();if(o.useEffect(()=>{(async()=>{if(!P){M.clearNotificationRequest();return}if(D.current)return;await se(u,A,S)&&(D.current=!0,M.setRequestingClientThreadId(e))})()},[u,S,e,A,P]),!i&&p&&p!==I)return t.jsx(te,{errorUserMessage:g?.errorUserMessage});if(N&&b){if(h)return u?t.jsx(Y,{automation:u}):i?t.jsx(q,{functionName:l?.functionName}):t.jsx(G,{});if(i&&l)return t.jsx(q,{functionName:l.functionName})}return null}function q({functionName:e}){const s=Q();return t.jsx("div",{className:"text-token-text-secondary relative my-2 h-8 first:mt-0",children:t.jsx(Z,{highlightedText:s.formatMessage(e==="update"?y.updatingAutomation:y.makingAutomation),className:"me-1.5 mt-1 items-center justify-start",shouldShimmer:!0})})}function ee(e,s){return o.useMemo(()=>{if(s)return;const a=e?.messages?.find(n=>C(n.author.name)?.namespace===J.DE1D73E);if(a)try{const n=JSON.parse(z(a));return n.status==="ERROR"?{error:n.message,errorUserMessage:n.user_message}:{automationId:n.jawbone.id,updatedAt:n.jawbone.updated_at}}catch(n){B.addError("Jawbone: Failed to parse automation message",{cause:n});return}},[e,s])}function te({errorUserMessage:e}){return t.jsxs("div",{className:"text-token-text-error flex items-center gap-1.5 pb-1",children:[t.jsx(K,{className:"icon"}),t.jsx("div",{children:e??t.jsx(F,{id:"oOQhkY",defaultMessage:"Task scheduling wasn’t completed — please ask again."})})]})}async function se(e,s,a){if(!e||!s||!a)return!1;const n=new Date(a*1e3);if(!(Math.abs(new Date().getTime()-n.getTime())<=5*60*1e3))return!1;const i=v.getLastRequestTime();return!(i&&Date.now()-new Date(i).getTime()<24*60*60*1e3||v.getPermission()==="denied"||!await $()||await X())}function ae(){const{data:e}=H({alwaysRefetchOnMount:!1});return e?.some(s=>s.category==="tasks"&&s.options.some(a=>a.channel==="push"&&a.enabled))}export{ce as JawboneMessage};
//# sourceMappingURL=ebf4wf8pzc5pbhny.js.map

const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ngzpxzu7w2fnqlwt.js","assets/cs7toih8jegb7teq.js","assets/iu45eaes85w805k2.js","assets/hnw079jsdm76umup.js","assets/dmck639k4dv7claj.js","assets/root-mdlgku96.css","assets/conversation-small-b5ztx8w5.css","assets/foi4i86wi4yrq0wp.js","assets/21ei6cu23fdeusdh.js","assets/gu3kz9694iumz76j.js","assets/ansi-1f6vhsjh.css","assets/dvi0n1hal1hb8zit.js","assets/mggn820eodl8mh7p.js","assets/crerkmhvihiw48az.js","assets/mntlin6h4lg868yr.js","assets/dr58d0qi3ke74zcr.js","assets/dp7t1jmnbbend843.js","assets/cvjqnnll0s8g7pb7.js","assets/c9fo3bbas9eanfzk.js","assets/fzrn137102spawew.js","assets/h3nlvxow81w42tha.js","assets/mcpubm63u255wsr6.js","assets/g9gr3l5lwhb3z8y8.js","assets/d2w9ht1jp4bj9t28.js","assets/ig3euz6ql417cw29.js","assets/g0qqcme5h04p667m.js","assets/isvc0syyvbx2i79u.js","assets/g7h4esjesus5ngav.js","assets/cm813h9bptrniota.js","assets/lg7g3n7e6pizuyzp.js","assets/parse-diff-iz0raby8.css","assets/icwejktgx2db5g2x.js","assets/epuqxu07prihsdka.js","assets/fsblv7a42b4xl30f.js","assets/code-diff-krvv6lyt.css","assets/kwms1ugj73bjxgnk.js","assets/gl21c0qqyu3lkg8e.js","assets/d0qctmhgeexj40hp.js","assets/b72akmtywhypzcgo.js","assets/lyxm37ljpwg11a5m.js","assets/yf0i1e6tgcrdg1ll.js","assets/mcuu3cegz8rmschr.js","assets/o12mkc4t9o2t0ta8.js","assets/na0t6wj09rfp0awn.js","assets/liqaqj2w179grtbv.js"])))=>i.map(i=>d[i]);
import{dq as ut,z as $,S as ze,c as mt,ej as ft,d1 as D,fw as ht,aw as Ye,ax as Xe,C as gt,B as Y,bV as ee,bu as pt,b9 as xt,e as _e,p as z,rv as wt,bb as vt,R as Be,aE as ke,bQ as _t,t9 as kt,m as bt,de as Je,hz as V,dg as yt,K as Ct,L as Pt,nP as jt,c3 as Mt}from"./dmck639k4dv7claj.js";import{r as h,j as e,e as A,M as w,a as Ee,m as Ze,i as Z,u as Tt,f as be,A as St,d as It,g as Nt}from"./cs7toih8jegb7teq.js";import{jk as Dt,eX as Ft,hP as pe,hQ as Ne,b1 as Lt,N as De,ak as Rt,hE as Bt,lu as Et,S as Oe,hC as qt,hD as At,al as je,X as Ot,ls as Me,bg as Ut,ro as Ue,rl as He,s6 as Ht,iP as Wt,cG as Qt}from"./hnw079jsdm76umup.js";import{M as Te,C as Fe,W as Gt,f as Vt,p as he,c as Kt,b as $t,d as zt}from"./foi4i86wi4yrq0wp.js";import{O as et,l as tt,s as Yt,x as at,W as q,f as Le,w as Re,k as Xt,g as K,h as xe,P as we,e as Jt,u as Zt,b as ea}from"./crerkmhvihiw48az.js";import{u as ta}from"./kwms1ugj73bjxgnk.js";import{JsonViewer as aa}from"./cvjqnnll0s8g7pb7.js";import{T as sa,a as ra,b as na}from"./lg7g3n7e6pizuyzp.js";import{a as We,S as oa}from"./gl21c0qqyu3lkg8e.js";import{W as ve}from"./g9gr3l5lwhb3z8y8.js";import{S as ia}from"./d0qctmhgeexj40hp.js";import{u as la,g as qe,W as ca,a as st}from"./mcpubm63u255wsr6.js";import{W as da,D as ne,O as ua}from"./b72akmtywhypzcgo.js";import{S as ma}from"./lyxm37ljpwg11a5m.js";import{g as fa,N as ha}from"./yf0i1e6tgcrdg1ll.js";import{s as ge,B as ga}from"./na0t6wj09rfp0awn.js";const rt=h.createContext(null);function ds({value:t,children:s}){return e.jsx(rt.Provider,{value:t,children:s})}function ie(){const t=h.useContext(rt);if(!t)throw new Error("useWhamTaskPageContext must be used within its provider");return t}function pa(t){const s={},r={};let a;for(const i of t)et(i)?i.previous_turn_id?r[i.previous_turn_id]=i:a=i:i.previous_turn_id&&(s[i.previous_turn_id]??=[]).push(i);if(!a)return null;const n=i=>{const u=s[i.id]??[],o={};for(const c of u){const d=r[c.id];d&&(o[c.id]=n(d))}return{userTurn:i,assistantTurns:u,children:o}};return n(a)}function xa(t){for(let s=t.length-1;s>=0;s--){const r=t[s];if(et(r)&&r.previous_turn_id)return r.previous_turn_id}return null}function wa(t,s){if(!t)return[];const r=[];if(s){const n=u=>{for(const o of u.assistantTurns){if(o.id===s)return[{node:u,activeId:o.id}];const c=u.children[o.id],d=c&&n(c);if(d)return[{node:u,activeId:o.id},...d]}return null},i=n(t);i&&r.push(...i)}r.length===0&&r.push({node:t,activeId:t.assistantTurns[0]?.id??null});let a=r[r.length-1];for(;a?.activeId;){const n=a.node.children[a.activeId];if(!n)break;r.push({node:n,activeId:n.assistantTurns[0]?.id??null}),a=r[r.length-1]}return r}function va(t){return t?.assistantTurns.some(s=>tt(s.turn_status))}function _a({className:t,focusedAssistantTurn:s,currentTab:r,permissions:a,task:n,turns:i,containerHeight:u,onClickFile:o,setFocusedAssistantTurnId:c,onTabChange:d,latestTurnRef:l,hasComments:f,clearComments:_,showFullDiff:p,loadingTurnMapping:k,reserveComposerSpace:x=!0}){h.useEffect(()=>{if(!s){const S=xa(i);S&&c(S)}},[s,i,c]);const C=h.useMemo(()=>pa(i),[i]),g=h.useMemo(()=>wa(C,s?.id??null),[C,s?.id]),T=g.length-1,P=g.slice(0,T),N=ut(g),I=x&&va(N?.node),{data:y}=Yt(n?.id),F=h.useMemo(()=>{if(!k||!y?.current_assistant_turn)return null;const S=y.current_assistant_turn,L=(S.sibling_turn_ids?.length??0)+1,R=S.attempt_placement??0,H=Array.from({length:L},(B,O)=>O===R?S.id:`placeholder-${O}`),W={};return H.forEach((B,O)=>W[B]=O),{attemptIds:H,idToIdxMap:W}},[k,y?.current_assistant_turn]);return e.jsx("div",{className:$("relative flex h-full w-full flex-col",t),children:e.jsx("div",{className:"flex h-fit min-h-full shrink-0 flex-col gap-6 pt-6 text-sm",children:k&&n&&y?.current_user_turn&&y?.current_assistant_turn?e.jsxs("div",{ref:l,className:$("flex min-h-full shrink-0 flex-col gap-6",I&&"pb-72"),style:{minHeight:u-24},children:[e.jsx("div",{className:"text-token-text-secondary flex w-full items-center justify-center gap-2",children:e.jsx(ze,{className:"text-xl"})}),e.jsx(Te,{isLatest:!0,task:n,userTurn:y.current_user_turn,assistantTurns:[y.current_assistant_turn],selectedAssistantId:y.current_assistant_turn.id,focusedAssistantTurn:y.current_assistant_turn,setFocusedAssistantTurnId:c,onClickFile:o,currentTab:r,onTabChange:d,permissions:a,startOpen:!0,hasComments:f,clearComments:_,showFullDiff:p,attemptIdsOverride:F?.attemptIds,idToIndexMapOverride:F?.idToIdxMap})]}):e.jsxs(e.Fragment,{children:[P.length>0&&e.jsx("div",{className:"flex flex-col gap-6",children:P.map(({node:S,activeId:L},R)=>e.jsx(Te,{isLatest:R===T,task:n,userTurn:S.userTurn,assistantTurns:S.assistantTurns,selectedAssistantId:L,focusedAssistantTurn:s,setFocusedAssistantTurnId:c,onClickFile:o,startOpen:R===T,currentTab:r,onTabChange:d,permissions:a,hasComments:f,clearComments:_,showFullDiff:p},S.userTurn.id))}),N&&e.jsx("div",{ref:l,className:$("flex min-h-full shrink-0 flex-col gap-6",I&&"pb-72"),style:{minHeight:u-24},children:e.jsx(Te,{isLatest:!0,task:n,userTurn:N.node.userTurn,assistantTurns:N.node.assistantTurns,selectedAssistantId:s?.id??null,focusedAssistantTurn:s,setFocusedAssistantTurnId:c,onClickFile:o,currentTab:r,onTabChange:d,permissions:a,startOpen:!0,hasComments:f,clearComments:_,showFullDiff:p})})]})})})}const nt=h.createContext(null);function us({value:t,children:s}){return e.jsx(nt.Provider,{value:t,children:s})}function Ae(){const t=h.useContext(nt);if(!t)throw new Error("useTaskComments must be used within a TaskCommentsProvider");return t}function ka({currentTab:t,permissions:s,onClickFile:r,onTabChange:a,showFullDiff:n,loadingTurnMapping:i,footer:u}){const{task:o,focusedAssistantTurn:c,pastTurns:d,setFocusedAssistantTurnId:l}=ie(),{comments:f,clearComments:_}=Ae(),[{height:p},k]=ta(),x=h.useRef(null),C=h.useRef(null);return mt(()=>{const g=x.current,T=C.current;!g||!T||(g.scrollTop=g.scrollHeight,g.clientHeight>=T.clientHeight&&(g.scrollTop=T.offsetTop))},[d.length,i]),h.useEffect(()=>{const g=x.current;if(!g)return;g.scrollHeight-g.scrollTop-g.clientHeight<5&&g.scrollTo({top:g.scrollHeight,behavior:"smooth"})},[d.length]),e.jsx("div",{ref:Dt(k,x),className:"flex h-full w-full flex-col items-center overflow-y-auto px-6",children:e.jsxs("div",{className:$("@container w-full",Fe),children:[e.jsx(_a,{focusedAssistantTurn:c,currentTab:t,permissions:s,task:o,turns:d,containerHeight:p,onClickFile:r,setFocusedAssistantTurnId:l,onTabChange:a,latestTurnRef:C,hasComments:f.length>0,clearComments:_,showFullDiff:n,loadingTurnMapping:i,reserveComposerSpace:u!=null}),u&&e.jsx("div",{className:"keyboard-open:fixed absolute start-0 end-0 bottom-0",children:u})]})})}function ba({unifiedDiff:t,setUnifiedDiff:s,showFullDiff:r,setShowFullDiff:a}){const n=A(),[i,u]=h.useState(!1);return e.jsxs(ft,{open:i,onOpenChange:u,contentAlign:"end",sideOffset:8,modal:!0,triggerButton:e.jsx("button",{type:"button",onClick:()=>u(!0),className:"hover:bg-token-border-light flex items-center justify-center rounded p-3","aria-label":n.formatMessage({id:"wham.diffModeDropdown.openMenu",defaultMessage:"Open diff settings menu"}),children:e.jsx(We,{className:"icon"})}),children:[e.jsxs(D.RadioGroup,{value:t?"unified":"split",onValueChange:o=>s(o==="unified"),onClick:o=>o.stopPropagation(),children:[e.jsx(D.RadioItem,{value:"split",onClick:o=>o.stopPropagation(),children:e.jsxs("div",{className:"text-token-text-primary flex items-center gap-3",children:[e.jsx(We,{className:"icon"}),e.jsx(w,{id:"wham.message.modal.footer.splitDiff",defaultMessage:"Split diff"})]})}),e.jsx(D.RadioItem,{value:"unified",onClick:o=>o.stopPropagation(),children:e.jsxs("div",{className:"text-token-text-primary flex items-center gap-3",children:[e.jsx(oa,{className:"icon"}),e.jsx(w,{id:"wham.message.modal.footer.unifiedDiff",defaultMessage:"Unified diff"})]})})]}),e.jsx(D.Separator,{}),e.jsxs(D.RadioGroup,{value:r?"full":"latest",onValueChange:o=>a(o==="full"),onClick:o=>{o.stopPropagation()},children:[e.jsx(D.RadioItem,{value:"full",children:e.jsx(w,{id:"wham.copyFile.showFullDiff",defaultMessage:"Full diff"})}),e.jsx(D.RadioItem,{value:"latest",children:e.jsx(w,{id:"wham.copyFile.showLatestCommit",defaultMessage:"Incremental diff"})})]})]})}function ya({previewImages:t}){const s=A(),r=Ft(t.map(l=>({content_type:ht.ImageAssetPointer,asset_pointer:l.asset_pointer??"",size_bytes:l.size_bytes??0,width:l.width??0,height:l.height??0}))),a=h.useMemo(()=>r.filter(l=>l.data),[r]),[n,i]=h.useState(0),u=Math.min(Math.max(n,0),Math.max(a.length-1,0)),o=h.useCallback(()=>{a.length<=1||(i(l=>(l-1+a.length)%a.length),ve.recordPreviewImagesCarouselPrev())},[a.length]),c=h.useCallback(()=>{a.length<=1||(i(l=>(l+1)%a.length),ve.recordPreviewImagesCarouselNext())},[a.length]);at([{key:"previewCarouselPrev",action:o,actionMessageDescriptor:s.formatMessage({id:"wham.keyboardActions.previousPreviewImage",defaultMessage:"Select previous image"}),group:Ne.Chat,keyboardBinding:[pe.ArrowLeft],enabled:a.length>1},{key:"previewCarouselNext",action:c,actionMessageDescriptor:s.formatMessage({id:"wham.keyboardActions.nextPreviewImage",defaultMessage:"Select next image"}),group:Ne.Chat,keyboardBinding:[pe.ArrowRight],enabled:a.length>1}]);const d=a[u]?.data;return e.jsxs("div",{className:"relative flex h-full w-full items-center justify-center overflow-hidden p-4",children:[d?e.jsx("img",{src:d.url,width:d.width,height:d.height,alt:s.formatMessage({id:"wham.whamTaskPageContentLoaded.previewImageAlt",defaultMessage:"Generated image"}),className:"max-h-full max-w-full object-contain"},u):e.jsx("div",{className:"text-secondary text-sm",children:s.formatMessage({id:"wham.whamPreviewImageCarousel.loading",defaultMessage:"Loading preview…"})}),a.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button","aria-label":s.formatMessage({id:"wham.whamPreviewImageCarousel.prev",defaultMessage:"Previous image"}),onClick:o,className:"absolute start-2 top-1/2 -translate-y-1/2 rounded-md bg-black/40 px-2 py-1 text-white hover:bg-black/60 focus:ring-2 focus:ring-white/70 focus:outline-none",children:"‹"}),e.jsx("button",{type:"button","aria-label":s.formatMessage({id:"wham.whamPreviewImageCarousel.next",defaultMessage:"Next image"}),onClick:c,className:"absolute end-2 top-1/2 -translate-y-1/2 rounded-md bg-black/40 px-2 py-1 text-white hover:bg-black/60 focus:ring-2 focus:ring-white/70 focus:outline-none",children:"›"}),e.jsxs("div",{className:"pointer-events-none absolute start-1/2 bottom-2 -translate-x-1/2 rounded-md bg-black/40 px-2 py-0.5 text-xs text-white",children:[u+1," / ",a.length]})]})]})}const Qe=Ye(()=>Xe(()=>import("./ngzpxzu7w2fnqlwt.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44])).then(t=>t.WhamTaskPageCodeDiffContent),{loading:()=>e.jsx("div",{className:"flex-1"})});function Ca({currentTab:t,setCurrentTab:s,defaultTab:r,isMobile:a,hasDiff:n,previewImages:i,diffFiles:u,unifiedDiff:o,handleDiffModeChange:c,showFullDiff:d,setShowFullDiff:l,isPreferencesLoading:f,isSharedExampleTask:_,focusedAssistantTurn:p,leftContent:k}){const{taskId:x,canFollowUp:C}=ie(),{comments:g,setComments:T}=Ae(),P=A();return h.useEffect(()=>{Qe.prefetch()},[f]),e.jsx("div",{className:"relative flex h-full w-full flex-col",children:e.jsxs(sa,{onChange:s,currentTab:t,defaultTab:r,tabs:[{key:"chat",isHidden:!a,label:P.formatMessage({id:"wham.whamTaskPageContentLoaded.conversation",defaultMessage:"Conversation"}),ariaLabel:P.formatMessage({id:"wham.whamTaskPageContentLoaded.conversationAriaLabel",defaultMessage:"Tab to view the conversation with the assistant"}),children:k},{key:"preview",isHidden:i.length===0,label:P.formatMessage({id:"wham.whamTaskPageContentLoaded.preview",defaultMessage:"Preview"}),ariaLabel:P.formatMessage({id:"wham.whamTaskPageContentLoaded.previewAriaLabel",defaultMessage:"Tab to view preview images"}),children:e.jsx(ya,{previewImages:i})},{key:"diff",isHidden:!n,label:P.formatMessage({id:"wham.whamTaskPageContentLoaded.diff",defaultMessage:"Diff"}),ariaLabel:P.formatMessage({id:"wham.whamTaskPageContentLoaded.diffAriaLabel",defaultMessage:"Tab to view the code diff"}),children:!f&&n&&e.jsx(Qe,{diffFiles:u,unifiedDiff:o,enableComments:C,comments:g,setComments:T})},{key:"logs",isHidden:_,label:P.formatMessage({id:"wham.whamTaskPageContentLoaded.logs",defaultMessage:"Logs"}),ariaLabel:P.formatMessage({id:"wham.whamTaskPageContentLoaded.logsAriaLabel",defaultMessage:"Tab to view the work logs"}),children:e.jsx(Gt,{taskId:x,focusedAssistantTurn:p,agentNetworkAccess:p?.environment?.agent_network_access})},{key:"internal_rollout",isHidden:p?.internal_only_rollouts==null||!0,label:P.formatMessage({id:"wham.whamTaskPageContentLoaded.internalRollout",defaultMessage:"Internal Rollout"}),ariaLabel:P.formatMessage({id:"wham.whamTaskPageContentLoaded.internalRolloutAriaLabel",defaultMessage:"Tab to view the internal rollout information"}),children:e.jsx("div",{className:"flex h-full w-full overflow-auto p-4",children:e.jsx(aa,{json:p?.internal_only_rollouts??void 0,jsonViewProps:{collapsed:5}})})}],children:[e.jsx(ra,{withUnderline:a,className:"items-center border-b p-3 pe-16 max-md:py-0",children:n&&e.jsx(ba,{unifiedDiff:o,setUnifiedDiff:c,showFullDiff:d,setShowFullDiff:l})}),e.jsx(na,{children:({content:N})=>e.jsx("div",{className:"flex h-full w-full",children:N})})]},p?.id??x)})}function Pa({isOpen:t,onConfirm:s,onClose:r,loading:a}){return e.jsx(gt,{isOpen:t,onClose:r,testId:"modal-wham-retry-all-turns",type:"warning",title:e.jsx("p",{className:"text-token-text-primary font-semibold",children:e.jsx(w,{id:"wham.retryAllTurnsModal.title",defaultMessage:"Retry all turns"})}),primaryButton:e.jsx(Y,{color:"primary",loading:a,onClick:s,children:e.jsx(w,{id:"wham.retryAllTurnsModal.confirm",defaultMessage:"Retry all turns"})}),secondaryButton:e.jsx(Y,{color:"secondary",onClick:r,children:e.jsx(w,{id:"wham.retryAllTurnsModal.cancel",defaultMessage:"Cancel"})}),children:e.jsx("div",{className:"text-sm",children:e.jsx(w,{id:"wham.retryAllTurnsModal.message",defaultMessage:"All latest turns will restart, including any siblings turns that are in progress or completed."})})})}function ja({turnId:t,comments:s,clearComments:r,lastTurn:a,focusedAssistantTurn:n,retry:i,attemptIndex:u,siblings:o}){const{taskId:c,setFocusedAssistantTurnId:d}=ie(),l=Ee(),f=A(),_=ee(),p=pt(),k=xt(),x=la(),C=j=>{wt(vt(k)),r(),d(j.turn.id)},g=async()=>{if(i){F(!0);try{if(i.previousTurnId){const j=await q.createFollowUpTask(c,i.previousTurnId,i.prompt,i.comments??[],!1,B?i.bestOfN??1:void 0,x?i.attachments:[]);C(j)}else{const j=await q.createNewTask(i.environmentId,i.branch,i.prompt,!1,B?i.bestOfN:void 0,x?i.attachments:[]);l(`/codex/tasks/${j.task.id}`)}L(!1)}catch(j){j instanceof Le?Re(j,t,f,_):_.danger({id:"wham.whamTaskPageFooter.errorRetryingTask",defaultMessage:"Error retrying task",description:"Error retrying task"},{toastId:"wham_task_page_footer_error_retrying_task"})}finally{F(!1)}}},T=!!n&&qe(n.output_items).outputDiffs.length>0,P=!a||!n||a.id===n?.id||!T,N=i&&P&&n?.turn_status==="failed",I=n?.previous_turn_id&&a?.type==="assistant"&&n.previous_turn_id===a.previous_turn_id,[y,F]=h.useState(!1),[S,L]=h.useState(!1),R=_e(),H=z(R,"1406552515"),W=z(R,"879591222")||void 0,B=z(R,"3492040717"),O=h.useMemo(()=>{const j=[...n?.output_items?.find(M=>M.type==="review")?.suggested_followup_tasks??[],...n?.output_items?.filter(M=>M.type==="suggested_task")??[]],Q=Vt(n?.child_turns?.filter(M=>M.source.type==="suggested_task")?.map(M=>[M.source.suggested_task_id,M]));return j.map(M=>({suggestion:M,userTurnId:M.id?Q[M.id]?.assistant_turn_id??null:null,assistantTurnId:M.id?Q[M.id]?.user_turn_id??null:null}))},[n]),te=a?.type==="assistant"?a.turn_status:"completed",le=o?.map(j=>j.turn_status)??[];return a?.type==="assistant"&&["pending","in_progress"].includes(a.turn_status)&&!W?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"wham-message-modal-footer",className:"z-50 flex w-full justify-center",children:[(P||I)&&e.jsx("div",{className:"flex w-full justify-center px-4",children:e.jsx("div",{className:$("relative z-1 flex w-full flex-col pt-2 pb-4",Fe),children:N?e.jsx(Y,{className:"w-full",color:"primary",size:"large",loading:y&&!S,onClick:()=>{(i?.bestOfN??1)>1?L(!0):g()},children:(i.bestOfN??1)>1?f.formatMessage({id:"wham.whamTaskPageFooter.retryAllTurns",defaultMessage:"Retry all turns"}):f.formatMessage({id:"wham.whamTaskPageFooter.retry",defaultMessage:"Retry"})}):r&&e.jsxs("div",{className:"flex w-full flex-col gap-3",children:[e.jsx(da,{}),!H&&e.jsx(ca,{disableAutoFocus:!0,disableDuringSubmit:!0,onSuccess:C,onClearComments:r,followUp:{taskId:c,turnId:t,comments:s,turnStatus:te,siblingTurnStatuses:le,followUpSuggestions:O},attemptIndex:u,ariaLabel:f.formatMessage({id:"wham.whamTaskPageFooter.composerAriaLabel",defaultMessage:"Composer to enter a follow up prompt to the task"})})]})})}),!P&&!I&&e.jsx(Ze.div,{layout:!0,className:$("dark mx-6 mb-6 w-full",Fe),initial:{opacity:0,translateY:10},animate:{opacity:1,translateY:0},exit:{opacity:0,translateY:10},transition:{duration:p?0:.25},children:e.jsx(Lt,{title:e.jsx(w,{id:"wham.whamTaskPageFooter.previousTurn",defaultMessage:"You are viewing a previous turn"}),primaryCtaText:e.jsx(w,{id:"wham.whamTaskPageFooter.viewLatestTurn",defaultMessage:"View latest"}),content:e.jsx(w,{id:"wham.whamTaskPageFooter.followUpsLatestTurn",defaultMessage:"Follow-ups are only available for the latest turn"}),icon:e.jsx(ia,{className:"icon"}),onPrimaryCtaClick:()=>d(a.id)})})]}),e.jsx(Pa,{isOpen:S,onClose:()=>L(!1),onConfirm:g,loading:y})]})}const ot=window.location.origin+"/s/";function Ma(t){return`${ot}${t}`}function it(t){return!t||!t.attachments||t.attachments.length===0||t.attachments[0].kind!=="codex"?null:{postId:t.id,permalink:t.permalink??Ma(t.id),permissions:t.permissions.share_setting??"public",codexTask:t.attachments[0].task,codexTurn:t.attachments[0].turns}}function oe(t){return["codex_tasks","result","share",t]}function Ta({taskId:t,enabled:s}){return Tt({enabled:!!t&&s,queryKey:oe(t),queryFn:async()=>{const r=await Be.safeGet("/share/post/by_codex_task/{codex_task_id}",{parameters:{path:{codex_task_id:t}}});return r.post?it(r.post):null}})}function Sa({taskId:t,onSuccess:s,onError:r}){return Z({scope:{id:t},mutationFn:()=>q.forkSharedTask(t),onSuccess:s,onError:r})}function Ia({taskId:t,turnId:s,onSuccess:r,onError:a}){return Z({scope:{id:t},mutationFn:async()=>{const n=await Be.safePost("/share/post",{requestBody:{attachments_to_create:[{kind:"codex",codex_task_id:t,current_codex_turn_id:s}]}});return it(n.post)},onSuccess:r,onError:a})}function Na({taskId:t,sharedResult:s}){const r=be();return Z({scope:{id:s?.postId??""},mutationFn:async({sharedResultId:a,access:n})=>(await Be.safePost("/share/post/update_access",{requestBody:{post_id:a,share_settings:n}})).share_setting,onMutate:({access:a})=>{const n=oe(t),i=r.getQueryData(n);return r.setQueryData(n,i&&{...i,permissions:a}),{previousAccess:i?.permissions}},onSuccess:a=>{const n=oe(t),i=r.getQueryData(n);i&&r.setQueryData(n,{...i,permissions:a})},onError:(a,n,i)=>{const u=oe(t),o=r.getQueryData(u);r.setQueryData(u,o&&{...o,permissions:i?.previousAccess??"public"})}})}function Da({taskId:t}){const s=A(),r=ee(),a=Ee(),{mutate:n}=Sa({taskId:t,onSuccess:i=>{i?.task?.id&&a(`/codex/tasks/${i?.task?.id}`)},onError:()=>{r.danger(s.formatMessage({id:"wham.codexForkButton.failedToFork",defaultMessage:"Failed to fork task"}))}});return e.jsx(Y,{size:"small",color:"secondary",type:"button",className:"px-3 py-2",onClick:()=>n(),children:e.jsx(w,{id:"wham.share.taskForkButton",defaultMessage:"Fork"})})}const Fa=`${ot}...`;function La({taskId:t,turnId:s,isLoading:r,sharedResult:a,title:n}){const[i,u]=h.useState(!1),o=(g,T)=>{g&&Ot(g,void 0,T).then(()=>{u(!0),setTimeout(()=>u(!1),1500)}).catch(()=>{})},c=be(),d=ee(),{mutate:l,isPending:f}=Ia({taskId:t,turnId:s,onSuccess:g=>{if(!g){d.danger("Failed to create share link");return}c.setQueryData(oe(t),g),o(g.permalink)}}),{mutate:_}=Na({taskId:t,sharedResult:a}),p=h.useRef(null),k=g=>{p.current?.focus(),a?o(a.permalink,g):l()},x=g=>{a&&_({sharedResultId:a.postId,access:g})},C=g=>{switch(g){case"public":return je.PUBLIC;case"private":return je.PRIVATE;case"workspace":return je.WORKSPACE}};return e.jsx(ga,{inputRef:p,isLoading:r,isPublishedVersionLatest:!0,sharedObject:a&&{id:a.postId,title:n,access:C(a.permissions)},title:n,shareTextPlaceholder:Fa,shareUrl:a?.permalink,isCopySuccessful:i,isCreateLinkRequestInProgress:f,handlePrivacyChange:x,handlePrimaryButtonClick:k})}function Ra({taskId:t,turnId:s,isDisabled:r,title:a}){const n=ke(),i=_t(),u=A(),[o,c]=h.useState(!1),{data:d,isLoading:l}=Ta({taskId:t,enabled:o&&!r}),{triggerRef:f,container:_}=kt({isOpen:o,onClose:()=>c(!1)}),p=i?.isWorkspaceAccount()&&!i?.features.includes(bt.WorkspaceShareLinks);return r||p?e.jsx(Je,{label:p?u.formatMessage(ge.workspaceSharingDisabled):u.formatMessage(ge.share),children:e.jsx(De,{disabled:!0,icon:Rt,"aria-label":u.formatMessage(p?ge.workspaceSharingDisabled:ge.share)})}):e.jsxs(Bt,{open:o,onOpenChange:c,children:[e.jsx(Et,{ref:f,asChild:!0,children:n?e.jsx(De,{icon:Oe,"aria-label":u.formatMessage({id:"wham.whamTaskPageHeader.shareAriaLabel",defaultMessage:"Share task"})}):e.jsx(Y,{icon:Oe,color:"ghost","aria-label":u.formatMessage({id:"wham.whamTaskPageHeader.shareAriaLabel",defaultMessage:"Share task"}),children:e.jsx(w,{id:"wham.whamTaskPageHeader.share",defaultMessage:"Share"})})}),e.jsx(St,{children:o&&e.jsx(qt,{forceMount:!0,container:_,children:e.jsx(At,{align:"end",className:"z-50",sideOffset:8,collisionPadding:8,children:e.jsx(La,{title:a,taskId:t,turnId:s,sharedResult:d,isLoading:l})})})})]})}function Ba({assistantTurn:t}){const s=A(),r=ee(),a=ke(),n=t?.pull_request_data?.head??t?.branch??"",i=fa(n),u=n&&n!==i,{outputDiffs:o}=qe(t?.output_items),c=o[0],d=t?.base_commit_sha??t?.pull_request_data?.base_sha??c?.base_commit_sha;if(a||!n)return null;const l=d!=null&&n!==d,_=l?e.jsx("span",{className:"text-token-text-secondary hover:text-token-text-primary cursor-pointer",onClick:()=>{navigator.clipboard.writeText(d??""),r.success(s.formatMessage({id:"wham.baseSha.copied",defaultMessage:"Copied branch commit SHA to clipboard"}))},children:d}):u?n:void 0;return e.jsx(Je,{label:_,side:"bottom",disabled:!_,interactive:l,children:e.jsx("span",{className:"text-token-text-secondary hover:text-token-text-primary cursor-pointer truncate",onClick:()=>{navigator.clipboard.writeText(n),r.success(s.formatMessage({id:"wham.branchName.copied",defaultMessage:"Copied branch name to clipboard"}))},children:i})})}const Ea=({assistantTurn:t})=>{const s=A(),r=h.useMemo(()=>t?.created_at?new Date(t.created_at*1e3):null,[t?.created_at]),a=h.useMemo(()=>r?.getFullYear()===new Date().getFullYear(),[r]);return r?r.toLocaleDateString(s.locale,{month:"short",day:"numeric",year:a?void 0:"numeric"}):null},qa=({title:t,assistantTurn:s})=>{const{linesAdded:r,linesRemoved:a}=st(s),n=s?.environment?.label;return e.jsxs("div",{className:"flex min-w-0 flex-col text-sm",children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"truncate font-medium",children:t})}),e.jsxs("div",{className:"flex gap-2 max-md:flex-wrap max-md:gap-1",children:[e.jsx("span",{className:"text-token-text-secondary truncate empty:hidden max-md:hidden",children:e.jsx(Ea,{assistantTurn:s})}),e.jsx("span",{className:"text-token-text-secondary max-md:hidden","aria-hidden":"true",children:" · "}),e.jsx("span",{className:"text-token-text-secondary truncate",children:n}),!!n&&e.jsx("span",{className:"text-token-text-secondary","aria-hidden":"true",children:" · "}),e.jsx(Ba,{assistantTurn:s}),e.jsx("span",{className:"max-md:hidden",children:e.jsx(Xt,{linesAdded:r,linesRemoved:a})})]})]})},Aa=({copyApplyToClipboard:t,copyPatchToClipboard:s,createPr:r,updateBranch:a,navigateToCreatingPrPage:n,canCreatePr:i,isCreatingPr:u,permissions:o,assistantTurn:c,showOnlyViewPr:d})=>{const l=_e(),f=A(),_=z(l,"296452287"),p=e.jsxs(e.Fragment,{children:[a&&i&&e.jsx(D.Item,{icon:V,onClick:()=>r(),"aria-label":f.formatMessage(b.createNewPr),children:e.jsx("div",{className:"flex items-center gap-1.5",children:e.jsx(w,{...b.createNewPr})})}),e.jsx(D.Item,{icon:Me,onClick:()=>t(),"aria-label":f.formatMessage(b.copyGitApply),children:e.jsx(w,{...b.copyGitApply})}),e.jsx(D.Item,{icon:Me,onClick:()=>s(),"aria-label":f.formatMessage(b.copyPatch),children:e.jsx(w,{...b.copyPatch})})]});return d?c?.pull_request_data?.url?e.jsx(Y,{icon:V,onClick:()=>{c?.pull_request_data?.url&&window.open(c.pull_request_data.url,"_blank")},children:e.jsx(w,{...b.viewPullRequest})}):null:!i||o==="read"?e.jsx(ne,{buttonIcon:Ut,onClick:()=>t(),triggerButtonAriaLabel:b.openDropdown,dropdownContent:e.jsx(D.Item,{icon:Me,onClick:()=>s(),"aria-label":f.formatMessage(b.copyPatch),children:e.jsx(w,{...b.copyPatch})}),children:e.jsx(w,{...b.copyGitApply})}):u?e.jsx(ne,{buttonIcon:ze,onClick:n,dropdownContent:p,triggerButtonAriaLabel:b.openDropdown,children:e.jsx(w,{...b.viewPullRequest})}):c?.pull_request_data?.url&&c?.pull_request_status!=="not_created"?e.jsx(ne,{buttonIcon:V,as:"a",href:c.pull_request_data.url,dropdownContent:p,triggerButtonAriaLabel:b.openDropdown,children:e.jsx(w,{...b.viewPullRequest})}):a?e.jsx(ne,{buttonIcon:V,onClick:()=>a(),dropdownContent:p,triggerButtonAriaLabel:b.openDropdown,children:e.jsx(w,{...b.updateExistingBranch})}):e.jsx(ne,{buttonIcon:V,onClick:()=>r(),"aria-label":f.formatMessage(b.createPr),triggerButtonAriaLabel:b.openDropdown,dropdownContent:e.jsxs(e.Fragment,{children:[e.jsx(D.Item,{icon:V,onClick:()=>r("draft"),"aria-label":f.formatMessage(b.createDraftPr),children:e.jsx(w,{...b.createDraftPr})}),_&&e.jsx(D.Item,{icon:V,onClick:()=>r("auto_merge"),"aria-label":f.formatMessage(b.createAutoMergePr),children:e.jsx(w,{...b.createAutoMergePr})}),e.jsx(D.Separator,{}),p]}),children:e.jsx(w,{...b.createPr})})},b=It({copyGitApply:{id:"wham.whamTaskPushDiffDropdown.copyGitApply",defaultMessage:"Copy git apply"},copyPatch:{id:"wham.whamTaskPushDiffDropdown.copyPatch",defaultMessage:"Copy patch"},viewPullRequest:{id:"wham.message.modal.footer.viewPr",defaultMessage:"View PR"},createPr:{id:"wham.message.modal.footer.createPrItem",defaultMessage:"Create PR"},createNewPr:{id:"wham.whamTaskPushDiffDropdown.createNewPr",defaultMessage:"Create new PR"},createDraftPr:{id:"wham.message.modal.footer.createDraftPr",defaultMessage:"Create draft PR"},createAutoMergePr:{id:"wham.message.modal.footer.createAutoMergePr",defaultMessage:"Create auto-merged PR"},updateExistingBranch:{id:"wham.whamTaskPushDiffDropdown.updateExistingBranch",defaultMessage:"Update branch"},openDropdown:{id:"wham.whamTaskPushDiffDropdown.openDropdown",defaultMessage:"Open git action menu"}});var Se,Ge;function Oa(){if(Ge)return Se;Ge=1;function t(s){return s&&s.length?s[0]:void 0}return Se=t,Se}var Ie,Ve;function Ua(){return Ve||(Ve=1,Ie=Oa()),Ie}var Ha=Ua();const Wa=Nt(Ha);function Qa({focusedAssistantTurn:t,onClose:s,shouldShowShare:r,shouldShowFork:a,permissions:n,title:i,isSharedExampleTask:u=!1}){const{taskId:o,task:c}=ie(),[d,l]=h.useState(t?.pull_request_status==="creating"),[f,_]=h.useState(void 0),p=ee(),k=be(),x=A(),C=Wa(K(t)),g=n==="write",T=xe(v=>v.getTurnsForTask(o).filter(we)),P=xe(v=>v.getTurnsForTask(o)),N=new Map(P.map(v=>[v.id,v])),I=v=>{if(we(v)){const E=c?.external_pull_requests;if(E&&E.length)for(let m=E.length-1;m>=0;m--){const X=E[m];if(X.assistant_turn_id===v.id)return X}}const U=v.previous_turn_id?N.get(v.previous_turn_id):void 0;return U?I(U):void 0},y=t?I(t):void 0,{linesAdded:F,linesRemoved:S}=st(t),{outputDiffs:L,hasPreApplyPatch:R}=qe(t?.output_items),H=g&&!R,W=Ee(),B=_e(),O=z(B,"2665240312")||void 0,te=z(B,"369193424"),j=T.filter(v=>t?.sibling_turn_ids?.includes(v.id)).some(v=>v.pull_request_data?.url),Q=te&&n==="write"&&y&&!y.pull_request.merged&&y.pull_request.state!=="closed"&&y.codex_updated_sha!==""&&(t?.id!==y.assistant_turn_id||t?.pull_request_status==="not_created")&&!j,M=h.useRef(null),{mutate:ce,isPending:ye}=Z({mutationFn:async()=>{o&&await q.archiveTask(o)},onSuccess:async()=>{await k.invalidateQueries({queryKey:["wham","tasks"]}),await k.invalidateQueries({queryKey:["wham","task",o]}),W("/codex")},onError:()=>{p.danger({id:"wham.whamTaskPageHeader.failedToArchiveTask",defaultMessage:"Failed to archive task",description:"Toast when archive request fails"},{toastId:"wham_task_page_header_failed_to_archive_task"})}}),{mutate:de,isPending:ue}=Z({mutationFn:async()=>{o&&await q.recoverTask(o)},onSuccess:async()=>{await k.invalidateQueries({queryKey:["wham","tasks"]}),await k.invalidateQueries({queryKey:["wham","task",o]})},onError:()=>{p.danger({id:"wham.whamTaskPageHeader.failedToArchiveTask",defaultMessage:"Failed to archive task",description:"Toast when archive request fails"},{toastId:"wham_task_page_header_failed_to_archive_task"})}}),ae=ye||ue;h.useEffect(()=>{t?.pull_request_status==="creating"?(l(!0),k.invalidateQueries({queryKey:["wham","task",o,"turns"]})):l(!1)},[o,t?.pull_request_status,k]),at([{key:"copyApplyToClipboard",action:()=>{me()},actionMessageDescriptor:x.formatMessage({id:"wham.keyboardActions.copyApplyToClipboard",defaultMessage:"Copy git apply"}),group:Ne.Chat,keyboardBinding:[pe.Mod,pe.Shift,";"],enabled:!!C}]);const me=async()=>{C&&(await navigator.clipboard.writeText(` (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
${C} 
EOF
)`),p.success(x.formatMessage({id:"wham.message.modal.footer.copiedToClipboard",defaultMessage:"Copied git apply command to clipboard"}),{duration:3,hasCloseButton:!0}),t?.id&&(ve.recordGitAction("diff-copied",F,S,o,t.id,"regular"),q.copyGitApply(o,t.id,!0)))},se=async()=>{C&&(await navigator.clipboard.writeText(C),p.success(x.formatMessage({id:"wham.whamTaskPageHeader.copiedPatchToClipboard",defaultMessage:"Copied patch to clipboard"}),{duration:3,hasCloseButton:!0}),t?.id&&await q.copyGitApply(o,t.id,!1))},fe=async()=>{if(!y||!t?.id){p.danger({id:"wham.whamTaskPageHeader.noPrToUpdate",defaultMessage:"No PR to update",description:"Toast when no PR is found to update"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_no_pr_to_update"});return}l(!0);try{await q.updatePr(o,t.id,y.id)}catch(v){l(!1),await q.getTaskTurnPR(o,y.assistant_turn_id),v instanceof Le?Re(v,t.id,x,p):p.danger({id:"wham.whamTaskPageHeader.failedToUpdatePr",defaultMessage:"Failed to update PR",description:"Toast when failed to update PR"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_failed_to_update_pr"})}finally{await k.refetchQueries({queryKey:["wham","tasks"]}),await k.refetchQueries({queryKey:["wham","task",o]}),l(!1)}},Ce=async v=>{if(!t?.id)return;_(v);const U=M.current;try{l(!0),await q.createPr(o,t.id,v),await k.refetchQueries({queryKey:["wham","task"]}),await k.fetchQuery(Jt(o,t.id)).then(E=>{const m=E;m.turn.pull_request_data!=null&&(U&&!U.closed&&m.turn.pull_request_data.url&&U.location.assign(m.turn.pull_request_data.url),yt({title:m.task.title,clientThreadId:m.turn.conversation_id,subtitle:x.formatMessage({id:"wham.message.modal.footer.prCreatedSuccess",defaultMessage:"Click to view your pull request."}),onClick:()=>{window.open(m.turn.pull_request_data?.url,"_blank")}}))}),ve.recordGitAction("pr-created",F,S,o,t.id,v??"regular")}catch(E){l(!1),U?.close(),E instanceof Le?Re(E,t.id,x,p):p.danger({id:"wham.message.modal.footer.createPrError",defaultMessage:"Failed to create PR",description:"Error message for failed to create PR"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_failed_to_create_pr"})}},Pe=()=>{if(!t?.id)return;const v=f?`?mode=${f}`:"";M.current=window.open(`/codex/tasks/${o}/turns/${t.id}/pr${v}`,"_blank")},re=!!ke();return e.jsxs("div",{className:"border-b-token-border-default flex w-full justify-between gap-2 border-b p-3 transition-colors duration-50",children:[e.jsxs("div",{className:"flex min-w-0 flex-shrink max-md:gap-2",children:[s?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"hover:bg-token-bg-tertiary group-radix-state-open:bg-token-bg-tertiary rounded-sm p-2 font-semibold",onClick:s,"aria-label":x.formatMessage({id:"wham.taskPageHeader.goBack",defaultMessage:"Go back to tasks"}),children:e.jsx(ma,{className:"icon-lg text-token-text-secondary"})}),e.jsx("div",{className:"bg-token-border-default my-auto ms-[11px] me-4 h-4 w-[1px] max-md:hidden"})]}):e.jsx("div",{className:"ms-3"}),e.jsx(qa,{title:i,assistantTurn:t})]}),e.jsxs("div",{className:"relative flex h-10 items-center gap-1.5",children:[!1,a&&t?.id&&e.jsx(Da,{taskId:o}),O&&t?.id&&g&&(re?e.jsx(De,{icon:c?.archived?Ue:He,onClick:()=>c?.archived?de():ce(),disabled:ae,"aria-label":c?.archived?x.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelUnarchive",defaultMessage:"Unarchive Task"}):x.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelArchive",defaultMessage:"Archive Task"})}):e.jsx(Y,{color:"ghost",icon:c?.archived?Ue:He,loading:ae,onClick:()=>c?.archived?de():ce(),"aria-label":c?.archived?x.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelUnarchive",defaultMessage:"Unarchive Task"}):x.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelArchive",defaultMessage:"Archive Task"}),children:c?.archived?e.jsx(w,{id:"wham.whamTaskPageHeader.unarchive",defaultMessage:"Unarchive"}):e.jsx(w,{id:"wham.whamTaskPageHeader.archive",defaultMessage:"Archive"})})),r&&t?.id&&e.jsx(Ra,{taskId:o,turnId:t?.id,isDisabled:!1,title:i??""}),n==="write"&&!re&&e.jsx(ua,{taskId:o}),L.length>0&&e.jsx(Aa,{isCreatingPr:d,assistantTurn:t,copyApplyToClipboard:me,copyPatchToClipboard:se,createPr:Ce,navigateToCreatingPrPage:Pe,canCreatePr:H,updateBranch:Q?fe:void 0,permissions:n,showOnlyViewPr:u}),!re&&!u&&e.jsx(ha,{})]})]})}function Ga({focusedAssistantTurn:t,pastTurns:s,showFullDiff:r}){if(!t)return[];const a=Va(s),n=!r;if(K(t,n).length>0)return he({assistantTurn:t,followUp:n});if(K(t,!1).length>0)return he({assistantTurn:t,followUp:!1});if(K(t,!0).length>0)return he({assistantTurn:t,followUp:!0});let c=Ke(t,a);for(;c;){const d=a.get(c);if(d&&we(d)){const l=K(d,!1),f=K(d,!0);if(l.length>0||f.length>0){const _=l.length===0&&f.length>0;return he({assistantTurn:d,followUp:_})}c=Ke(d,a)}else break}return[]}function Va(t){const s=new Map;for(const r of t)s.set(r.id,r);return s}function Ke(t,s){const r=s.get(t.previous_turn_id??"");return r?r.previous_turn_id??null:null}const $e=new Set,Ka=Ye(()=>Xe(()=>import("./ngzpxzu7w2fnqlwt.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44])).then(t=>t.WhamTaskPageCodeDiffContent),{loading:()=>e.jsx("div",{className:"flex-1"})});function ms({turnId:t,permissions:s,confirmClose:r,setConfirmClose:a,handleClose:n,showForkButton:i,loadingTurnMapping:u,isSharedExampleTask:o=!1}){const{taskId:c,task:d,focusedAssistantTurn:l,pastTurns:f,canFollowUp:_}=ie(),{comments:p,clearComments:k,setComments:x}=Ae(),C=A(),{data:g,isLoading:T}=Zt(),P=be(),[N,I]=h.useState(void 0),y=h.useMemo(()=>K(l,!0).length>0,[l]),[F,S]=Ct(Pt.WhamShowFullDiff,!y,Ht),L=h.useMemo(()=>Ga({focusedAssistantTurn:l,pastTurns:f,showFullDiff:F}),[l,f,F]),R=h.useMemo(()=>l?l.output_items.filter(m=>m.type==="message").flatMap(m=>m.content).filter(m=>m.content_type==="image_asset_pointer_citation").map(m=>({content_type:"image_asset_pointer_citation",asset_pointer:m.asset_pointer,width:m.width,height:m.height,size_bytes:m.size_bytes})):[],[l]),H=l?.turn_status==="failed",W=R.length>0,B=L.length>0,O=f[f.length-1],te=d?d.title??C.formatMessage({id:"wham.whamTaskPageContentLoaded.newTask",defaultMessage:"New Task"}):null,le=ee(),j=!!ke(),Q=j||g?.git_diff_mode==="unified",M=_e(),ce=z(M,"3673716873");h.useEffect(()=>{const m=l?.id;m&&!$e.has(m)&&l?.turn_status==="completed"&&($e.add(m),q.markTurnViewed(c,m))},[l?.id,c,l?.turn_status]);const{mutate:ye}=Z({mutationFn:m=>q.updateUserPreferences(m),onSuccess:async()=>{await ea(P)},onError:()=>{le.danger({id:"wham.whamTaskPageContentLoaded.failedToUpdatePreferences",defaultMessage:"Failed to update preferences",description:"Failed to update preferences error message"},{toastId:"wham_task_page_content_loaded_failed_to_update_preferences"})}}),de=m=>{ye({diffView:m?"unified":"split"})},ue=W?"preview":j?"chat":B?"diff":void 0,[ae,me]=h.useState(!1);!ae&&d&&(me(!0),I(ue));const se=l?.turn_status?tt(l?.turn_status):null,fe=h.useRef(!1);h.useEffect(()=>{se===!1?fe.current=!0:se===!0&&fe.current&&B&&I("diff")},[se]);const Ce=h.useMemo(()=>{if(H&&l?.environment_id&&l?.branch){const m=[...f].reverse().find(G=>G.type==="user"),J=m?.input_items.find(G=>G.type==="message")?.content.find(G=>G.content_type==="text")?.text,lt=m?.input_items.filter(G=>G.type==="comment"),ct=(l?.sibling_turn_ids?.length??0)+1,dt=Kt(m?.input_items??[]);return{environmentId:l?.environment_id,branch:l?.branch,previousTurnId:m?.previous_turn_id,prompt:J??"",comments:lt??[],bestOfN:ct,attachments:dt}}},[H,l,f]),{attemptIndex:Pe,siblings:re}=h.useMemo(()=>{if(!l)return{attemptIndex:null,hasSiblingTurns:!1};const m=f.filter(J=>we(J)&&!!J.sibling_turn_ids?.includes(l.id)),X=m.findIndex(J=>J.id===l.id);return{attemptIndex:X===-1?null:X+1,siblings:m}},[l,f]),v=s==="write"?e.jsx(ja,{turnId:l?.id??t,comments:p,clearComments:k,focusedAssistantTurn:l,lastTurn:O,retry:Ce,attemptIndex:Pe,siblings:re??[]}):null,U=e.jsx(ka,{currentTab:N,permissions:s,onClickFile:()=>I("diff"),onTabChange:m=>I(m),showFullDiff:F,loadingTurnMapping:u,footer:v}),E=e.jsx(Ca,{currentTab:N,setCurrentTab:m=>I(m),defaultTab:ue,isMobile:j,hasDiff:B,previewImages:R,diffFiles:L,unifiedDiff:Q,handleDiffModeChange:de,showFullDiff:F,setShowFullDiff:S,isPreferencesLoading:T,isSharedExampleTask:o,focusedAssistantTurn:l,leftContent:U});return e.jsxs(e.Fragment,{children:[e.jsxs(Ze.div,{className:$("relative flex size-full flex-1 flex-col items-center",j?"[--right-bg:var(--bg-primary)]":"[--right-bg:var(--bg-tertiary)] dark:[--right-bg:black]"),...Wt,children:[e.jsx(Qa,{title:te,focusedAssistantTurn:l,onClose:n?()=>n?.({force:!0}):void 0,permissions:s,shouldShowShare:ce&&s==="write",shouldShowFork:!!i,isSharedExampleTask:o}),e.jsx("div",{className:"bg-token-bg-primary flex min-h-0 w-full flex-1",children:!d||!ae?e.jsx(jt,{}):j?E:e.jsx($t,{leftContent:U,rightContent:o&&B?e.jsx("div",{className:"relative h-full w-full bg-[var(--right-bg)]",children:e.jsx(Ka,{diffFiles:L,unifiedDiff:Q,enableComments:_,comments:p,setComments:x})}):N?e.jsxs("div",{className:"relative h-full w-full bg-[var(--right-bg)]",children:[E,e.jsx(Qt,{className:"absolute end-3 top-2.5",icon:e.jsx(Mt,{}),label:C.formatMessage({id:"wham.whamTaskPageContentLoaded.close",defaultMessage:"Close"}),onClick:()=>I(void 0)})]}):void 0})})]}),r&&a&&n&&e.jsx(zt,{setConfirmClose:a,handleClose:n})]})}function fs({taskId:t,task:s,currentUserTurn:r,currentAssistantTurn:a}){const n=xe(l=>l.addTurnToTaskMap),i=xe(l=>l.getTurnsForTask),[u,o]=h.useState(a?.id??s?.current_turn_id??null);h.useEffect(()=>{t&&(a&&["pending","in_progress","failed"].includes(a.turn_status)?o(a.id):o(a?.id??null),r&&n(t,r),a&&n(t,a))},[a,r,t,n]);let d=i(t??"")?.filter(l=>l.type==="assistant")?.find(l=>l.id===u)??null;return d||(d=a),{focusedAssistantTurn:d,setFocusedAssistantTurnId:o}}export{us as T,ds as W,fs as a,ms as b,Ae as u};
//# sourceMappingURL=e2yc8higqjump39r.js.map

var W=Object.defineProperty,q=Object.defineProperties;var z=Object.getOwnPropertyDescriptors;var C=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable;var T=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e);var P=(e,t,r)=>t in e?W(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,x=(e,t)=>{for(var r in t||(t={}))L.call(t,r)&&P(e,r,t[r]);if(C)for(var r of C(t))G.call(t,r)&&P(e,r,t[r]);return e},$=(e,t)=>q(e,z(t));var w=function(e,t){this[0]=e,this[1]=t},R=(e,t,r)=>{var o=(c,n,i,m)=>{try{var b=r[c](n),f=(n=b.value)instanceof w,l=b.done;Promise.resolve(f?n[0]:n).then(s=>f?o(c==="return"?c:"next",n[1]?{done:s.done,value:s.value}:s,i,m):i({value:s,done:l})).catch(s=>o("throw",s,i,m))}catch(s){m(s)}},a=c=>u[c]=n=>new Promise((i,m)=>o(c,n,i,m)),u={};return r=r.apply(e,t),u[T("asyncIterator")]=()=>u,a("next"),a("throw"),a("return"),u};var M=(e,t,r)=>(t=e[T("asyncIterator")])?t.call(e):(e=e[T("iterator")](),t={},r=(o,a)=>(a=e[o])&&(t[o]=u=>new Promise((c,n,i)=>(u=a.call(e,u),i=u.done,Promise.resolve(u.value).then(m=>c({value:m,done:i}),n)))),r("next"),r("return"),t);import{j as y,M as O,r as h,h as H,u as V}from"./mw35uwhq4g8r9eam.js";import{cF as X,e as Y,f as B,L as J,b3 as Z,a4 as I}from"./d0xa318sl7ywi0za.js";import{kV as Q,f0 as ee}from"./g2euln7v5pbm31qa.js";import{m as N,k as te}from"./ldtpmsnzn9ens47o.js";function de(e,t){return!e||e.length<=t?e:e.slice(0,t/2)+"â€¦"+e.slice(-t/2)}function be({className:e,linesAdded:t,linesRemoved:r}){return!t&&!r?null:y.jsxs("div",{className:X("flex flex-row gap-1 font-medium",e),children:[y.jsx("span",{className:"text-green-500",children:y.jsx(O,{id:"wham.message.modal.repoAndDiffStats.linesAdded",defaultMessage:"+{linesAdded}",values:{linesAdded:t}})}),y.jsx("span",{className:"text-red-500",children:y.jsx(O,{id:"wham.message.modal.repoAndDiffStats.linesRemoved",defaultMessage:"-{linesRemoved}",values:{linesRemoved:r}})})]})}function re(e){const t=h.useMemo(()=>e.join("\0"),[e]);return h.useMemo(()=>e,[t])}const se=["task_turn_event","work_log_message","log","task_title_generated","rollout_event","app_server_event"];function Se(e,t,r){"use no forget";const o=H(),[a,u]=h.useState(r?o.formatMessage({id:"wham.useStreamTurn.preparingTask",defaultMessage:"Working on your task"}):""),[c,n]=h.useState(a);h.useEffect(()=>{const m=J(()=>n(a),200);return m(),m.cancel},[a]);const i=h.useMemo(()=>"last-event-".concat(e,"-").concat(r!=null?r:"","-").concat(Math.random().toString(36).slice(2)),[e,r]);return ne(e,r,["task_turn_event"],{enabled:!!r&&!N(t),subscriberId:i,onEvent:m=>u(m.task_turn_event.text)}),c}function ne(e,t,r,{enabled:o=!0,subscriberId:a,onEvent:u,onComplete:c}){"use no forget";const n=Q(u),i=Q(c),m=re(r),b=V(),f=h.useCallback(s=>{n.current(s)},[n]),l=h.useCallback(()=>{var s;(s=i.current)==null||s.call(i)},[i]);h.useEffect(()=>{if(!(!t||!o))return K.retainTurnStream(b,e,t,a,m,f,l),()=>{K.releaseTurnStream(e,t,a)}},[e,t,a,m,o,b,f,l])}function ae(a){return R(this,arguments,function*({taskId:e,turnId:t,abortSignal:r,types:o}){let c="".concat(window.location.origin+"/backend-api","/wham/tasks/").concat(e,"/turns/").concat(t,"/stream");if(o.length>0){const l=o.map(s=>"item_type=".concat(encodeURIComponent(s))).join("&");c+="?".concat(l)}const n=ee(c,{method:"GET",signal:r,headers:$(x({},Z({isAuthOptional:!1})),{"Content-Type":"text/event-stream"}),observer:{onClose:(l,s)=>{if(s&&!A(s))throw s}}});try{try{for(var i=M(n),m,b,f;m=!(b=yield new w(i.next())).done;m=!1){const l=b.value;const s=oe(l);s&&(!o||o.includes(s.item_type)?yield s:I.warn("Unknown event type",{event:l}))}}catch(b){f=[b]}finally{try{m&&(b=i.return)&&(yield new w(b.call(i)))}finally{if(f)throw f[0]}}}catch(l){if(A(l))return;throw l}})}function oe(e){return!("data"in e)||!e.data||e.event==="heartbeat"?null:e.data}function A(e){return!!e&&typeof e=="object"&&e.name==="AbortError"}const U=Y(B(()=>({turnStreams:{}}))),k=U.getState,v=U.setState;function D(e,t){return"".concat(e,":").concat(t)}const F=20;function ie(e,t,r,o){var u,c;let a;return v(n=>{const i=n.turnStreams[t];if(!i)return;if(i.initPromise){a=i.initPromise;return}const{abortController:m}=i,f=(async()=>{var j;let l=0;const s=d=>{const g=[];v(p=>{const E=p.turnStreams[t];E&&(E.seenEventIds.has(d.id)||(E.seenEventIds.add(d.id),E.emittedEvents.push(d),Object.values(E.subscribers).forEach(S=>{if(!S.types.includes(d.item_type))return;const _=S.lastTimestamps[d.item_type];_&&d.timestamp<=_||(S.lastTimestamps[d.item_type]=d.timestamp,g.push(S.onEvent))})))}),g.forEach(p=>p(d))};for(;!m.signal.aborted&&l<F;){try{const S=ae({taskId:r,turnId:o,abortSignal:m.signal,types:se});try{for(var ge=M(S),Ee,ye,ve;Ee=!(ye=await ge.next()).done;Ee=!1){const _=ye.value;if(m.signal.aborted)break;s(_)}}catch(ye){ve=[ye]}finally{try{Ee&&(ye=ge.return)&&await ye.call(ge)}finally{if(ve)throw ve[0]}}}catch(S){if(A(S)||m.signal.aborted)break}const d=te(r,o),g=await e.fetchQuery(d),p=N(g.turn.turn_status);if(p&&await Promise.all([e.refetchQueries({queryKey:["wham","task",r]}),e.invalidateQueries({queryKey:["wham","tasks"]})]),l+=1,l>=F||m.signal.aborted||p)break;const E=Math.min(16e3,1e3*2**l)+Math.random()*500;await new Promise(S=>setTimeout(S,E))}if(!m.signal.aborted){const d=(j=k().turnStreams[t])==null?void 0:j.subscribers;Object.values(d!=null?d:{}).forEach(g=>{var p;(p=g.onComplete)==null||p.call(g)})}})().finally(()=>{v(l=>{const s=l.turnStreams[t];s&&s.initPromise===f&&(s.initPromise=null,Object.keys(s.subscribers).length||delete l.turnStreams[t])})});i.initPromise=f,a=f}),(c=a!=null?a:(u=k().turnStreams[t])==null?void 0:u.initPromise)!=null?c:Promise.resolve()}const K={async retainTurnStream(e,t,r,o,a,u,c){const n=D(t,r);let i=!1;v(b=>{let f=b.turnStreams[n];f?f.initPromise||(i=!0,f.abortController=new AbortController):(i=!0,f={subscribers:{},abortController:new AbortController,initPromise:null,emittedEvents:[],seenEventIds:new Set},b.turnStreams[n]=f);const l=f.subscribers[o];l?(l.types=Array.from(a),l.onEvent=u,l.onComplete=c):f.subscribers[o]={subscriberId:o,types:Array.from(a),onEvent:u,onComplete:c,lastTimestamps:{}}});const m=k().turnStreams[n].emittedEvents;for(const b of m)a.includes(b.item_type)&&u(b);i&&await ie(e,n,t,r)},releaseTurnStream(e,t,r){const o=D(e,t);let a=!1,u;v(c=>{const n=c.turnStreams[o];!n||!n.subscribers[r]||(delete n.subscribers[r],Object.keys(n.subscribers).length||(a=!0,u=n.abortController,delete c.turnStreams[o]))}),a&&u&&u.abort()}};export{be as W,ne as a,A as i,de as m,Se as u};
//# sourceMappingURL=kx64af29hscb23w7.js.map

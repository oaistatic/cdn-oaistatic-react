var K=Object.defineProperty,H=Object.defineProperties;var A=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable;var k=(n,t,e)=>t in n?K(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,S=(n,t)=>{for(var e in t||(t={}))F.call(t,e)&&k(n,e,t[e]);if(b)for(var e of b(t))G.call(t,e)&&k(n,e,t[e]);return n},D=(n,t)=>H(n,A(t));var d=(n,t,e)=>k(n,typeof t!="symbol"?t+"":t,e);import{uM as j,uN as I,uO as U,ux as q,uP as W,uQ as J,uR as Q,bk as V,uS as R,D as X,kA as Z,iq as Y}from"./d0xa318sl7ywi0za.js";import{f5 as $,pw as _}from"./g2euln7v5pbm31qa.js";import{C as ee,M as te}from"./l57v5lxkpqo9adh3.js";import{E as ne,M as se,N as re}from"./f76gy0b8ieo4s693.js";import{stripDirectivePlugin as oe}from"./mzril1pzbts3gz7n.js";import{i as ie}from"./b9m0h1g72p9whl0h.js";import{u as ae}from"./iknugp00locgtve5.js";const ue=500,g=class g{constructor(t,e){this.items=t,this.eventCount=e}popEvent(t,e){if(this.eventCount==0)return null;let s=this.items.length;for(;;s--)if(this.items.get(s-1).selection){--s;break}let r,o;e&&(r=this.remapping(s,this.items.length),o=r.maps.length);const i=t.tr;let a,u;const m=[],c=[];return this.items.forEach((l,p)=>{if(!l.step){r||(r=this.remapping(s,p+1),o=r.maps.length),o--,c.push(l);return}if(r){c.push(new h(l.map));const f=l.step.map(r.slice(o));let M;f&&i.maybeStep(f).doc&&(M=i.mapping.maps[i.mapping.maps.length-1],m.push(new h(M,void 0,void 0,m.length+c.length))),o--,M&&r.appendMap(M,o)}else i.maybeStep(l.step);if(l.selection)return a=r?l.selection.map(r.slice(o)):l.selection,u=new g(this.items.slice(0,s).append(c.reverse().concat(m)),this.eventCount-1),!1},this.items.length,0),{remaining:u,transform:i,selection:a}}addTransform(t,e,s,r){const o=[];let i=this.eventCount,a=this.items,u=!r&&a.length?a.get(a.length-1):null;for(let c=0;c<t.steps.length;c++){const l=t.steps[c].invert(t.docs[c]);let p=new h(t.mapping.maps[c],l,e),f;(f=u&&u.merge(p))&&(p=f,c?o.pop():a=a.slice(0,a.length-1)),o.push(p),e&&(i++,e=void 0),r||(u=p)}const m=i-s.depth;return m>le&&(a=ce(a,m),i-=m),new g(a.append(o),i)}remapping(t,e){const s=new j;return this.items.forEach((r,o)=>{const i=r.mirrorOffset!=null&&o-r.mirrorOffset>=t?s.maps.length-r.mirrorOffset:void 0;s.appendMap(r.map,i)},t,e),s}addMaps(t){return this.eventCount==0?this:new g(this.items.append(t.map(e=>new h(e))),this.eventCount)}rebased(t,e){if(!this.eventCount)return this;const s=[],r=Math.max(0,this.items.length-e),o=t.mapping;let i=t.steps.length,a=this.eventCount;this.items.forEach(p=>{p.selection&&a--},r);let u=e;this.items.forEach(p=>{const f=o.getMirror(--u);if(f==null)return;i=Math.min(i,f);const M=o.maps[f];if(p.step){const x=t.steps[f].invert(t.docs[f]),T=p.selection&&p.selection.map(o.slice(u+1,f));T&&a++,s.push(new h(M,x,T))}else s.push(new h(M))},r);const m=[];for(let p=e;p<i;p++)m.push(new h(o.maps[p]));const c=this.items.slice(0,r).append(m).append(s);let l=new g(c,a);return l.emptyItemCount()>ue&&(l=l.compress(this.items.length-s.length)),l}emptyItemCount(){let t=0;return this.items.forEach(e=>{e.step||t++}),t}compress(t=this.items.length){const e=this.remapping(0,t);let s=e.maps.length;const r=[];let o=0;return this.items.forEach((i,a)=>{if(a>=t)r.push(i),i.selection&&o++;else if(i.step){const u=i.step.map(e.slice(s)),m=u&&u.getMap();if(s--,m&&e.appendMap(m,s),u){const c=i.selection&&i.selection.map(e.slice(s));c&&o++;const l=new h(m.invert(),u,c),p=r.length-1;let f;(f=r.length&&r[p].merge(l))?r[p]=f:r.push(l)}}else i.map&&s--},this.items.length,0),new g(I.from(r.reverse()),o)}};d(g,"empty",new g(I.empty,0));let E=g;function ce(n,t){let e;return n.forEach((s,r)=>{if(s.selection&&t--==0)return e=r,!1}),n.slice(e)}class h{constructor(t,e,s,r){this.map=t,this.step=e,this.selection=s,this.mirrorOffset=r}merge(t){if(this.step&&t.step&&!t.selection){const e=t.step.merge(this.step);if(e)return new h(e.getMap().invert(),e,this.selection)}}}class v{constructor(t,e,s,r,o){this.done=t,this.undone=e,this.prevRanges=s,this.prevTime=r,this.prevComposition=o}}const le=20;function pe(n,t,e,s){const r=e.getMeta(w);let o;if(r)return r.historyState;e.getMeta(fe)&&(n=new v(n.done,n.undone,null,0,-1));const i=e.getMeta("appendedTransaction");if(e.steps.length==0)return n;if(i&&i.getMeta(w))return i.getMeta(w).redo?new v(n.done.addTransform(e,void 0,s,y(t)),n.undone,B(e.mapping.maps),n.prevTime,n.prevComposition):new v(n.done,n.undone.addTransform(e,void 0,s,y(t)),null,n.prevTime,n.prevComposition);if(e.getMeta("addToHistory")!==!1&&!(i&&i.getMeta("addToHistory")===!1)){const a=e.getMeta("composition"),u=n.prevTime==0||!i&&n.prevComposition!=a&&(n.prevTime<(e.time||0)-s.newGroupDelay||!me(e,n.prevRanges)),m=i?N(n.prevRanges,e.mapping):B(e.mapping.maps);return new v(n.done.addTransform(e,u?t.selection.getBookmark():void 0,s,y(t)),E.empty,m,e.time,a==null?n.prevComposition:a)}else return(o=e.getMeta("rebased"))?new v(n.done.rebased(e,o),n.undone.rebased(e,o),N(n.prevRanges,e.mapping),n.prevTime,n.prevComposition):new v(n.done.addMaps(e.mapping.maps),n.undone.addMaps(e.mapping.maps),N(n.prevRanges,e.mapping),n.prevTime,n.prevComposition)}function me(n,t){if(!t)return!1;if(!n.docChanged)return!0;let e=!1;return n.mapping.maps[0].forEach((s,r)=>{for(let o=0;o<t.length;o+=2)s<=t[o+1]&&r>=t[o]&&(e=!0)}),e}function B(n){const t=[];for(let e=n.length-1;e>=0&&t.length==0;e--)n[e].forEach((s,r,o,i)=>t.push(o,i));return t}function N(n,t){if(!n)return null;const e=[];for(let s=0;s<n.length;s+=2){const r=t.map(n[s],1),o=t.map(n[s+1],-1);r<=o&&e.push(r,o)}return e}function de(n,t,e){const s=y(t),r=w.get(t).spec.config,o=(e?n.undone:n.done).popEvent(t,s);if(!o)return null;const i=o.selection.resolve(o.transform.doc),a=(e?n.done:n.undone).addTransform(o.transform,t.selection.getBookmark(),r,s),u=new v(e?a:o.remaining,e?o.remaining:a,null,0,-1);return o.transform.setSelection(i).setMeta(w,{redo:e,historyState:u})}let C=!1,L=null;function y(n){const t=n.plugins;if(L!=t){C=!1,L=t;for(let e=0;e<t.length;e++)if(t[e].spec.historyPreserveItems){C=!0;break}}return C}const w=new U("history"),fe=new U("closeHistory");function Ve(n={},t=void 0){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new q({key:w,state:{init(){return t!=null?t:new v(E.empty,E.empty,null,0,-1)},apply(e,s,r){return pe(s,r,e,n)}},config:n,props:{handleDOMEvents:{beforeinput(e,s){const r=s.inputType,o=r=="historyUndo"?he:r=="historyRedo"?ge:null;return!o||!e.editable?!1:(s.preventDefault(),o(e.state,e.dispatch))}}}})}function z(n,t){return(e,s)=>{const r=w.getState(e);if(!r||(n?r.undone:r.done).eventCount==0)return!1;if(s){const o=de(r,e,n);o&&s(t?o.scrollIntoView():o)}return!0}}const he=z(!1,!0),ge=z(!0,!0);class Me extends ne{unifiedInitializationHook(t){return t.use(oe)}}class ve{constructor(t,e){d(this,"rules");this.rules=[].concat.apply([],t.syntaxExtensions().map(s=>s.proseMirrorInputRules(e)))}build(){return ie({rules:this.rules})}}class we{constructor(t,e){d(this,"keymap");this.keymap=new Map;for(const s of t.syntaxExtensions())this.addKeymap(s.proseMirrorKeymap(e));this.addKeymap(W)}build(){const t={};return this.keymap.forEach((e,s)=>{t[s]=J(...e)}),Q(t)}addKeymap(t){for(const e in t)this.keymap.get(e)||this.keymap.set(e,[]),V(this.keymap.get(e)).push(t[e])}}class xe{constructor(t){d(this,"nodeViews");this.nodeViews={};for(const e of t.nodeExtensions()){const s=e.proseMirrorNodeName(),r=e.proseMirrorNodeView();s!==ee.proseMirrorNodeName()&&s!=null&&r!=null&&(this.nodeViews[s]=r)}}build(){return this.nodeViews}}class Ee{constructor(t){d(this,"nodes",{});d(this,"marks",{});for(const e of t.nodeExtensions()){const s=e.proseMirrorNodeName(),r=e.proseMirrorNodeSpec();s!=null&&r!=null&&(s!=="text"&&(r.attrs=D(S({},r.attrs),{start:{default:void 0},end:{default:void 0}})),this.nodes[s]=r)}for(const e of t.markExtensions()){const s=e.proseMirrorMarkName(),r=e.proseMirrorMarkSpec();s!=null&&r!=null&&(this.marks[s]=r)}}build(){try{return new R({nodes:this.nodes,marks:this.marks})}catch(t){X.addError(t,{nodes:this.nodes})}return new R({nodes:{doc:{content:"block+"},paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p",preserveWhitespace:"full"}],toDOM:()=>["p",0]},text:{group:"inline"}},marks:this.marks})}}class ye{constructor(t){d(this,"extensionManager");this.extensionManager=t}build(){let t=ae();for(const e of this.extensionManager.extensions())t=e.unifiedInitializationHook(t);return t}}function ke(n){return n instanceof re}function Ne(n){return n instanceof se}class Ce{constructor(t){d(this,"markExtensionList");d(this,"nodeExtensionList");d(this,"otherExtensionList");this.markExtensionList=new Map,this.nodeExtensionList=new Map,this.otherExtensionList=new Map;for(const e of t)this.add(e)}extensions(){return this.syntaxExtensions().concat(Array.from(this.otherExtensionList.values()))}markExtensions(){return Array.from(this.markExtensionList.values())}nodeExtensions(){return Array.from(this.nodeExtensionList.values())}syntaxExtensions(){return this.nodeExtensions().concat(this.markExtensions())}add(t){for(const e of t.dependencies())this.add(e);if(Ne(t)){this.markExtensionList.set(t.constructor,t);return}if(ke(t)){this.nodeExtensionList.set(t.constructor,t);return}this.otherExtensionList.set(t.constructor,t)}}class Pe{constructor(t){d(this,"extensionManager");this.extensionManager=t}convert(t){const e=this.convertNode(t);if(e.length!==1)throw new Error("Couldn't find any way to convert the root ProseMirror node.");return e[0]}convertNode(t){let e=null;const s=[];for(const r of this.extensionManager.nodeExtensions()){if(!r.proseMirrorToUnistTest(t))continue;s.push(r);let o=[];for(let i=0;i<t.childCount;++i)o=o.concat(this.convertNode(t.child(i)));e=r.proseMirrorNodeToUnistNodes(t,o)}return e==null?(console.warn("Couldn't find any way to convert ProseMirror node of type \""+t.type.name+'" to a unist node.'),[]):e.map(r=>{for(const o of t.marks){const{type:{name:i}}=o;if(s.some(m=>{var l;const c=(l=m.proseMirrorNodeSpec())==null?void 0:l.marks;return c!=null&&!c.includes(i)}))continue;let u=!1;for(const m of this.extensionManager.markExtensions())o.type.name===m.proseMirrorMarkName()&&(r=m.processConvertedUnistNode(r,o),u=!0);u||console.warn("Couldn't find any way to convert ProseMirror mark of type \""+i+'" to a unist node.')}return r})}}class P{constructor(t,e){d(this,"extensionManager");d(this,"proseMirrorSchema");this.extensionManager=t,this.proseMirrorSchema=e}static unistNodeIsParent(t){return"children"in t}convert(t){const e={},s=this.convertNode(t,e);for(const r of this.extensionManager.syntaxExtensions())r.postUnistToProseMirrorHook(e);if(s.length!==1)throw new Error("Couldn't find any way to convert the root unist node.");return s[0]}convertNode(t,e){let s=0;const r=(o,i)=>{var a;for(const u of this.extensionManager.syntaxExtensions()){if(!u.unistToProseMirrorTest(o)||$(o)&&u.customDirectiveName()!=null&&u.customDirectiveName()!==o.name)continue;let m=[];P.unistNodeIsParent(o)&&(m=o.children.flatMap(x=>r(x,i)));const{position:c}=o,l=(a=c==null?void 0:c.start.offset)!=null?a:s;let p=c==null?void 0:c.end.offset;if(p==null&&"value"in o&&typeof o.value=="string"){const{value:x}=o;p=l+x.length}p==null&&(p=l),s=p;const f={start:l,end:p};return Z(u.unistNodeToProseMirrorNodes({node:o,schema:this.proseMirrorSchema,convertedChildren:m,context:i,attrs:f})).filter(Y)}return console.warn("Couldn't find any way to convert unist node of type \""+o.type+'" to a ProseMirror node.'),[]};return r(t,e)}}const Te=5;class be{constructor(t=[]){d(this,"builtSchema");d(this,"inputRulesBuilder");d(this,"keymapBuilder");d(this,"nodeViewBuilder");d(this,"unistToProseMirrorConverter");d(this,"proseMirrorToUnistConverter");d(this,"unified");d(this,"memoizedProsemirrorDocs",new Map);const e=new Ce(t);this.builtSchema=new Ee(e).build(),this.inputRulesBuilder=new ve(e,this.builtSchema),this.keymapBuilder=new we(e,this.builtSchema),this.nodeViewBuilder=new xe(e),this.unistToProseMirrorConverter=new P(e,this.builtSchema),this.proseMirrorToUnistConverter=new Pe(e),this.unified=new ye(e).build()}parse(t){try{if(this.memoizedProsemirrorDocs.has(t))return V(this.memoizedProsemirrorDocs.get(t));const e=this.unistToProseMirrorConverter.convert(this.parseUnist(t));if(this.memoizedProsemirrorDocs.set(t,e),this.memoizedProsemirrorDocs.size>Te){const s=this.memoizedProsemirrorDocs.keys().next().value;s&&this.memoizedProsemirrorDocs.delete(s)}return e}catch(e){_.logError("Failed to parse document",e)}return this.schema().text(" ")}parseUnist(t){return this.unified.runSync(this.unified.parse(t))}schema(){return this.builtSchema}inputRulesPlugin(){return this.inputRulesBuilder.build()}keymapPlugin(){return this.keymapBuilder.build()}nodeViews(){return this.nodeViewBuilder.build()}serialize(t){const e=this.proseMirrorToUnistConverter.convert(t);return this.unified.stringify(e)}}const O=new Map;function ze(n={}){const t=JSON.stringify(n);let e=O.get(t);return e==null&&(e=new be([new te,...n!=null&&n.shouldStripDirectives?[new Me]:[]]),O.set(t,e)),e}export{be as P,Me as S,w as a,ze as g,Ve as h,ge as r,he as u};
//# sourceMappingURL=mojznsm1zll43nmv.js.map

import{r as o,u as I,h as K,d as A,n as O,j as c,ah as B,a as U,a9 as q,y as N}from"./mw35uwhq4g8r9eam.js";import{kZ as H,p as Q,t2 as z,gi as $}from"./d0xa318sl7ywi0za.js";import{W as G}from"./okqanfqoj3a09oj8.js";import{s as Z,t as J,j as V,v as X,o as Y,x as D}from"./ldtpmsnzn9ens47o.js";import{ni as ee,d3 as te,b4 as P,b5 as L}from"./g2euln7v5pbm31qa.js";import{u as re}from"./mlgj7gsfvuk1e8bn.js";import{useSetupBaseWhamKeyboardActions as oe}from"./qyj59gvnqjp5wm2y.js";import{b as ne,g as se,T as ue,W as ae,c as ie}from"./lkt2qv7ib8tsqf90.js";import{W as me}from"./baz4b8nlf8t2lb95.js";import"./gl4f6lge29au0ljx.js";import"./iio0zgk2sqlxbcjy.js";import"./c5k9gv36gzuxi0am.js";import"./hdw58d7g4tx8n6s4.js";import"./lw2hpe6y5hhfte4k.js";import"./k6k3ilbqdb73kxkm.js";import"./ksb30nvrqfrocrgu.js";import"./h38m9m9rf2db1qpt.js";import"./mpk4drhv3szxuvkj.js";import"./fljft0gbsnm1ovqa.js";import"./k527f0oyvlppyfoy.js";import"./krfycj1ruc6rihlj.js";import"./ohau9tqj1fpdibg0.js";import"./iknugp00locgtve5.js";import"./h1em0bjkpkjv8ykw.js";import"./cv4afpu20gjb9dll.js";import"./h4yh1661qhhbu5v5.js";import"./hu1bt0oauegdhua6.js";import"./nxan4e3brpzak2la.js";import"./i2f5gqqndy3iowkc.js";import"./ipoljkkwhes3fgxa.js";import"./jxdumrq8vfk5kk1c.js";import"./oftnd9rlobxeh2e2.js";import"./kx64af29hscb23w7.js";import"./brzhn6w36e0ait35.js";import"./lptwpbjabrvjmhsj.js";import"./gkerdwj307fj3n4u.js";import"./h9z1eo55yfy9l6t8.js";import"./ee6pijsbu8dfevmi.js";import"./dxkl0433k1u8ypnz.js";import"./ox7635ffwodpca7w.js";import"./nr9k12yditsrjrdm.js";import"./eder15khh2fy5wd2.js";import"./lgfmpb0my7e1aj31.js";import"./c8dilzb1umlthpuq.js";import"./cmsg2ikilns8l0ug.js";import"./m4z0737cb20mwzwc.js";import"./ddina39kz3r81pp7.js";import"./w3hi9hzc7twqpn11.js";import"./ga8rhh96wttk8d8h.js";import"./f89v9mtyvakgmoul.js";import"./f3alhksm9dfhscbq.js";function ce(){return o.useSyncExternalStore(t=>(document.addEventListener("focusin",t),document.addEventListener("focusout",t),()=>{document.removeEventListener("focusin",t),document.removeEventListener("focusout",t)}),()=>{var t;return typeof document<"u"&&((t=document.activeElement)==null?void 0:t.hasAttribute("data-wham-comment-textarea"))===!0},()=>!1)}function de(t){var M,h,k,T,_,w,E;const a=I(),i=H(),m=ce(),{data:e,error:p}=Z(t,{refetchOnWindowFocus:!0,refetchOnMount:!0}),{isLoading:d}=J(t),n=V(o.useCallback(({getTurnsForTask:s})=>{var u;return(u=s(t))!=null?u:[]},[t])),{focusedAssistantTurn:r,setFocusedAssistantTurnId:j}=ne({taskId:t,task:e==null?void 0:e.task,currentUserTurn:(M=e==null?void 0:e.current_user_turn)!=null?M:null,currentAssistantTurn:(h=e==null?void 0:e.current_assistant_turn)!=null?h:null}),v=o.useMemo(()=>{var s,u;return se({focusedAssistantTurn:r,pastTurns:n,currentDiffTaskTurnId:(u=(s=e==null?void 0:e.current_diff_task_turn)==null?void 0:s.id)!=null?u:null})},[r,(k=e==null?void 0:e.current_diff_task_turn)==null?void 0:k.id,n]),l=(T=e==null?void 0:e.task)==null?void 0:T.current_turn_id,C=!!(e!=null&&e.task.has_unread_turn)&&l===((_=e==null?void 0:e.current_assistant_turn)==null?void 0:_.id),g=((w=e==null?void 0:e.current_assistant_turn)==null?void 0:w.turn_status)==="completed";o.useEffect(()=>{var f;if(!i)return;const s=(f=e==null?void 0:e.task)==null?void 0:f.title;if(!s)return;const u=document.title;return document.title=s,()=>{document.title=u}},[i,(E=e==null?void 0:e.task)==null?void 0:E.title]),o.useEffect(()=>{!C||!g||me.markTurnAsRead(t).then(()=>{a.invalidateQueries({queryKey:["wham","tasks"]}),a.invalidateQueries({queryKey:["wham","task",t]})})},[C,g,t,a]);const b=o.useMemo(()=>{var W,x,S,y;const s=X(r),u=((S=r==null?void 0:r.sibling_turn_ids)==null?void 0:S.includes((x=(W=e==null?void 0:e.current_assistant_turn)==null?void 0:W.id)!=null?x:""))||(r==null?void 0:r.id)===((y=e==null?void 0:e.current_assistant_turn)==null?void 0:y.id),f=!(e!=null&&e.current_diff_task_turn);return s&&(u||f)},[r,e==null?void 0:e.current_assistant_turn,e==null?void 0:e.current_diff_task_turn]);return{taskDetails:e,taskDetailsError:p,loadingTurnMapping:d,turns:n,focusedAssistantTurn:r,setFocusedAssistantTurnId:j,currentDiffTaskTurn:v,canFollowUp:b,isCommentFocused:m}}function pe(){const[t,a]=o.useState([]),[i,m]=o.useState(!1),e=o.useCallback(()=>{a([])},[]),p=o.useCallback(({onClose:d,isComposerEmpty:n})=>({force:r=!1}={})=>{if(r||t.length===0&&n){e(),d();return}m(!0)},[t.length,e]);return{comments:t,setComments:a,confirmClose:i,setConfirmClose:m,clearComments:e,createCloseHandler:p}}function le({taskId:t,onClose:a}){"use no forget";var y,F;const i=Q(),m=K(),e=A(),{composerController:p,isComposerEmpty:d}=ee(),{taskDetails:n,taskDetailsError:r,loadingTurnMapping:j,turns:v,focusedAssistantTurn:l,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g,canFollowUp:b,isCommentFocused:M}=de(t),h=o.useMemo(()=>Y(l),[l]),k=o.useMemo(()=>({taskId:t,task:n==null?void 0:n.task,pastTurns:v,canFollowUp:b,focusedAssistantTurn:l,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g}),[t,n,v,b,l,C,g]),{comments:T,setComments:_,confirmClose:w,setConfirmClose:E,clearComments:s,createCloseHandler:u}=pe(),f=o.useMemo(()=>({comments:T,setComments:_,clearComments:s,readonlyComments:h}),[T,_,s,h]),W=te.useCurrentImage()!=null,x=u({onClose:a,isComposerEmpty:d});oe(),re([{key:"newTask",action:()=>{e("/codex",{state:{focusComposer:!0}})},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.newTask",defaultMessage:"New task"}),group:L.Chat,keyboardBinding:[P.Mod,P.Shift,"o"]},{key:"closeTask",action:()=>{e("/codex")},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.closeTask",defaultMessage:"Close task"}),group:L.Chat,keyboardBinding:[P.Escape],enabled:!W&&!M}]);const S=o.useCallback(({force:R=!1}={})=>{x({force:R})},[x]);return r?(i.danger(O({id:"wham.task-details.error",defaultMessage:"Error loading task"}),{id:"wham-task-details-error-".concat(t),hasCloseButton:!0,duration:3,toastId:"wham_task_page_content_error"}),c.jsx(B,{to:"/codex"})):c.jsx(z.Provider,{value:p,children:c.jsx(ue,{value:f,children:c.jsx(ae,{value:k,children:c.jsx(ie,{permissions:"write",turnId:(F=(y=n==null?void 0:n.current_assistant_turn)==null?void 0:y.id)!=null?F:"",confirmClose:w,setConfirmClose:E,handleClose:S,loadingTurnMapping:j})})})})}function fe(){var d;const t=A(),a=U(),{taskId:i}=q();D();const m=(d=a.state)!=null?d:{},{backgroundLocation:e}=m,p=o.useCallback(()=>{t(e?-1:"/codex")},[e,t]);return i?c.jsx($,{children:c.jsx(G,{children:c.jsx(le,{taskId:i,onClose:p})})}):null}const pt=()=>[{title:"Codex"}],lt=N(function(){return c.jsx(fe,{})});export{lt as default,pt as meta};
//# sourceMappingURL=mb2bovl18qtrakp4.js.map

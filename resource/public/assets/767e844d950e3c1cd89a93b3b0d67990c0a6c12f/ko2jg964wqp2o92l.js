var h2=Object.defineProperty,d2=Object.defineProperties;var f2=Object.getOwnPropertyDescriptors;var um=Object.getOwnPropertySymbols;var q0=Object.prototype.hasOwnProperty,$0=Object.prototype.propertyIsEnumerable;var H0=(F,q,ne)=>q in F?h2(F,q,{enumerable:!0,configurable:!0,writable:!0,value:ne}):F[q]=ne,yr=(F,q)=>{for(var ne in q||(q={}))q0.call(q,ne)&&H0(F,ne,q[ne]);if(um)for(var ne of um(q))$0.call(q,ne)&&H0(F,ne,q[ne]);return F},on=(F,q)=>d2(F,f2(q));var cf=(F,q)=>{var ne={};for(var me in F)q0.call(F,me)&&q.indexOf(me)<0&&(ne[me]=F[me]);if(F!=null&&um)for(var me of um(F))q.indexOf(me)<0&&$0.call(F,me)&&(ne[me]=F[me]);return ne};import{R as Zo,r as tt,o as uf,j as Wr,M as zg}from"./mw35uwhq4g8r9eam.js";import{M as p2}from"./kx34yg3blv92o8xp.js";import{cw as m2,D as _2,eu as g2,ek as y2,e5 as x2}from"./d0xa318sl7ywi0za.js";import{d as v2}from"./fdzi2sym03eufaos.js";import{c as Lg,E as Jn}from"./na97s5us80xgwiaa.js";import{E as Z0,i as vg}from"./ko1u2otqsfwa0ohy.js";import{a as b2}from"./e1t6unu3olubcgkg.js";import{vl as w2}from"./g2euln7v5pbm31qa.js";import{s as T2}from"./cfmv4ozi0jyg6itn.js";import"./hwa6pbq6i57ntwuh.js";import"./bxq8qdjlrkpqhzqu.js";import"./nyxqrh4m1u1hf7xm.js";const bg="#3B82F6",Ba=12;function pf(F,q){return F.width/(q.widthEmu*Jn)}function S2(F,q,ne){return q>=F.x&&q<=F.x+F.width&&ne>=F.y&&ne<=F.y+F.height}function ab(F,q,ne,me,Pe){var rt;if(!F)return null;const we=cb(F,q,ne);return(rt=["nw","ne","sw","se"].find(s=>S2(we[s],me,Pe)))!=null?rt:null}function lb(F,q,ne){var me;return(me=[...F.elements].sort((Pe,we)=>{var rt,s;return((rt=we.zIndex)!=null?rt:0)-((s=Pe.zIndex)!=null?s:0)}).find(({bbox:Pe})=>{if(!Pe||!Pe.xEmu||!Pe.yEmu||!Pe.widthEmu||!Pe.heightEmu)return!1;const{xEmu:we,yEmu:rt,widthEmu:s,heightEmu:et}=Pe,nt=we*Jn,It=rt*Jn,At=s*Jn,Xt=et*Jn;return q>=nt&&q<=nt+At&&ne>=It&&ne<=It+Xt}))!=null?me:null}function E2(F,q,ne,me,Pe,we){F.save(),F.lineJoin="miter";const rt=(s,et,nt,It=null)=>{const{x:At,y:Xt,width:ei,height:Vi}=Lg(s,q,we);It&&F.setLineDash(It),F.lineWidth=et,F.strokeStyle=nt,F.strokeRect(At,Xt,ei,Vi),F.setLineDash([])};if(ne&&ne!==me&&rt(ne,2,bg),me&&!Pe){rt(me,2,bg);const s=cb(me,q,we);Object.values(s).forEach(et=>{F.fillStyle="#FFFFFF",F.strokeStyle=bg,F.lineWidth=2,F.fillRect(et.x,et.y,et.width,et.height),F.strokeRect(et.x,et.y,et.width,et.height)})}F.restore()}function cb(F,q,ne){const{x:me,y:Pe,width:we,height:rt}=Lg(F,q,ne),s=Ba/2;return{nw:new DOMRect(me-s,Pe-s,Ba,Ba),ne:new DOMRect(me+we-s,Pe-s,Ba,Ba),sw:new DOMRect(me-s,Pe+rt-s,Ba,Ba),se:new DOMRect(me+we-s,Pe+rt-s,Ba,Ba)}}const I2=Zo[typeof document<"u"&&document.createElement!==void 0?"useLayoutEffect":"useEffect"],A2=F=>{const q=tt.useRef(F);return tt.useEffect(()=>{q.current=F}),q};function M2(){}function C2(F,q,ne={}){const me=R2(ne.polyfill),Pe=A2(q);return I2(()=>{let we=!1;const rt=F&&"current"in F?F.current:F;if(!rt)return M2;function s(et,nt){we||Pe.current(et,nt)}return me.subscribe(rt,s),()=>{we=!0,me.unsubscribe(rt,s)}},[F,me,Pe]),me.observer}function P2(F){let q=!1,ne=[];const me=new Map,Pe=new(F||window.ResizeObserver)((we,rt)=>{ne=ne.concat(we);function s(){const et=new Set;for(let nt=0;nt<ne.length;nt++){if(et.has(ne[nt].target))continue;et.add(ne[nt].target);const It=me.get(ne[nt].target);It==null||It.forEach(At=>At(ne[nt],rt))}ne=[],q=!1}q||window.requestAnimationFrame(s),q=!0});return{observer:Pe,subscribe(we,rt){var s;Pe.observe(we);const et=(s=me.get(we))!==null&&s!==void 0?s:[];et.push(rt),me.set(we,et)},unsubscribe(we,rt){var s;const et=(s=me.get(we))!==null&&s!==void 0?s:[];if(et.length===1){Pe.unobserve(we),me.delete(we);return}const nt=et.indexOf(rt);nt!==-1&&et.splice(nt,1),me.set(we,et)}}}let wg;const R2=F=>wg||(wg=P2(F));function D2(F,q=100){const[ne,me]=tt.useState({width:0,height:0});C2(F,we=>{const{width:rt,height:s}=we.contentRect;me({width:rt,height:s})});const[Pe]=b2(ne,q);return Pe}const z2=(F,q,ne,me,Pe,we,rt)=>tt.useCallback(s=>{if(!F||!q||!ne.current||!me.current)return;const et=s.currentTarget.getBoundingClientRect(),nt=pf(et,q),It=ne.current.getBoundingClientRect(),At=me.current.getBoundingClientRect(),Xt=At.left-It.left,ei=At.top-It.top,Vi=(s.clientX-et.left)/nt,Tt=(s.clientY-et.top)/nt,Dt=we.find(vi=>Vi>=vi.x&&Vi<=vi.x+vi.width&&Tt>=vi.y&&Tt<=vi.y+vi.height);if(!Dt)return;if(s.stopPropagation(),Dt.action==="ppaction://hlinksldjump"){const vi=Dt.url.match(/slide(\d+)\.xml$/);if(vi){const Ti=Number(vi[1])-1;Ti>=0&&Ti<F.slides.length&&rt(Ti)}return}const Mi=Dt.x*nt+Xt,Yt=(Dt.x+Dt.width)*nt+Xt,wi=(Dt.y+Dt.height/2)*nt+ei,Ci=It.width-Yt>=Mi?"right":"left",tr=Ci==="right"?Yt:Mi;Pe({url:Dt.url,x:tr,y:wi,placement:Ci})},[F,q,we,me,Pe,ne,rt]),L2=(F,q,ne,me,Pe,we,rt,s,et)=>tt.useCallback(nt=>{if(!F||!q||!ne.current||!me.current)return;const It=nt.currentTarget.getBoundingClientRect(),At=pf(It,q),Xt=(nt.clientX-It.left)/At,ei=(nt.clientY-It.top)/At;if(!Pe)return;let Vi="move",Tt=null;we&&(Tt=ab(we,F,q,Xt,ei),Tt&&(Vi="resize"));const Dt=Vi==="move"?lb(q,Xt,ei):we;if(!Dt){rt(null),s(null);return}rt(Dt),s(Dt);const{x:Mi,y:Yt,width:wi,height:Ci}=Lg(Dt,F,q);et({element:Dt,origin:{x:Mi,y:Yt,w:wi,h:Ci},mouseStart:{x:Xt,y:ei},mode:Vi,corner:Tt,preserveRatio:nt.shiftKey,moved:!1})},[F,q,we,Pe,me,et,s,rt,ne]),O2=(F,q,ne,me,Pe,we,rt,s)=>tt.useCallback(et=>{if(!F||!q||!ne.current)return;if(me){if(!me.element.bbox)return;const Tt=et.currentTarget.getBoundingClientRect(),Dt=pf(Tt,q),Mi=(et.clientX-Tt.left)/Dt,Yt=(et.clientY-Tt.top)/Dt,wi=Mi-me.mouseStart.x,Ci=Yt-me.mouseStart.y;if(me.mode==="move"){if(wi===0&&Ci===0)return;me.element.bbox.xEmu=(me.origin.x+wi)/Jn,me.element.bbox.yEmu=(me.origin.y+Ci)/Jn}else if(me.mode==="resize"){const tr=me.preserveRatio||et.shiftKey,{x:vi,y:Ti,w:Si,h:hr}=me.origin;let Sr=vi,br=Ti,Or=Si,Jt=hr;const On=Si/hr;switch(me.corner){case"nw":Sr=vi+wi,br=Ti+Ci,Or=Si-wi,Jt=hr-Ci;break;case"ne":br=Ti+Ci,Or=Si+wi,Jt=hr-Ci;break;case"sw":Sr=vi+wi,Or=Si-wi,Jt=hr+Ci;break;case"se":default:Or=Si+wi,Jt=hr+Ci;break}tr&&(Math.abs(Or/Jt)>On?Jt=Or/On:Or=Jt*On,(me.corner==="nw"||me.corner==="sw")&&(Sr=vi+(Si-Or)),(me.corner==="nw"||me.corner==="ne")&&(br=Ti+(hr-Jt))),Or=Math.max(1,Or),Jt=Math.max(1,Jt),me.element.bbox.xEmu=Sr/Jn,me.element.bbox.yEmu=br/Jn,me.element.bbox.widthEmu=Or/Jn,me.element.bbox.heightEmu=Jt/Jn}Pe(on(yr({},me),{moved:!0}));return}const nt=et.currentTarget.getBoundingClientRect(),It=pf(nt,q),At=(et.clientX-nt.left)/It,Xt=(et.clientY-nt.top)/It,ei=ab(we,F,q,At,Xt);ei?(ne.current.style.cursor="".concat(ei,"-resize"),rt(we)):(ne.current.style.cursor="",rt(lb(q,At,Xt)));const Vi=s.find(Tt=>At>=Tt.x&&At<=Tt.x+Tt.width&&Xt>=Tt.y&&Xt<=Tt.y+Tt.height);ne.current.style.cursor=Vi?"pointer":""},[F,q,me,we,ne,rt,Pe,s]),F2=(F,q,ne)=>{tt.useEffect(()=>{if(!F.current)return;const me=F.current;if(me.querySelectorAll("video[data-slide-video]").forEach(we=>{const rt=we.dataset.url;rt&&(URL.revokeObjectURL(rt),we.remove())}),!q)return;const Pe=pf(me.getBoundingClientRect(),q);q.elements.filter(we=>we.video).forEach(we=>{var ei,Vi;if(!we.bbox||!we.bbox.xEmu||!we.bbox.yEmu||!we.bbox.widthEmu||!we.bbox.heightEmu)return;const{xEmu:rt,yEmu:s,widthEmu:et,heightEmu:nt}=we.bbox;if(!we.video)return;const It=new Blob([w2(we.video.data)],{type:we.video.contentType}),At=URL.createObjectURL(It),Xt=document.createElement("video");Xt.src=At,Xt.dataset.slideVideo="true",Xt.dataset.url=At,Xt.autoplay=!0,Xt.loop=!0,Xt.muted=!0,Xt.playsInline=!0,Object.assign(Xt.style,{position:"absolute",left:"".concat(rt*Jn*Pe,"px"),top:"".concat(s*Jn*Pe,"px"),width:"".concat(et*Jn*Pe,"px"),height:"".concat(nt*Jn*Pe,"px"),objectFit:"cover",zIndex:(Vi=(ei=we.zIndex)==null?void 0:ei.toString())!=null?Vi:"0",pointerEvents:"none"}),me.appendChild(Xt)})},[q,ne,F])};var hm={exports:{}},k2=hm.exports,W0;function B2(){return W0||(W0=1,(function(F,q){(function(ne,me){F.exports=me()})(k2,(function(){var ne,me,Pe;function we(s,et){if(!ne)ne=et;else if(!me)me=et;else{var nt="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+ne+")(sharedChunk); ("+me+")(sharedChunk); self.onerror = null;",It={};ne(It),Pe=et(It),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(Pe.workerUrl=window.URL.createObjectURL(new Blob([nt],{type:"text/javascript"})))}}we(["exports"],(function(s){var et=1e-6,nt=typeof Float32Array<"u"?Float32Array:Array;function It(r,e){var i=e[0],o=e[1],a=e[2],u=e[3],h=i*u-a*o;return h?(r[0]=u*(h=1/h),r[1]=-o*h,r[2]=-a*h,r[3]=i*h,r):null}function At(){var r=new nt(9);return nt!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function Xt(r,e){var i=e[0],o=e[1],a=e[2],u=e[3],h=e[4],f=e[5],_=e[6],g=e[7],v=e[8];return r[0]=h*v-f*g,r[1]=a*g-o*v,r[2]=o*f-a*h,r[3]=f*_-u*v,r[4]=i*v-a*_,r[5]=a*u-i*f,r[6]=u*g-h*_,r[7]=o*_-i*g,r[8]=i*h-o*u,r}function ei(r,e,i){var o=e[0],a=e[1],u=e[2],h=e[3],f=e[4],_=e[5],g=e[6],v=e[7],b=e[8],w=i[0],I=i[1],A=i[2],P=i[3],D=i[4],L=i[5],V=i[6],j=i[7],H=i[8];return r[0]=w*o+I*h+A*g,r[1]=w*a+I*f+A*v,r[2]=w*u+I*_+A*b,r[3]=P*o+D*h+L*g,r[4]=P*a+D*f+L*v,r[5]=P*u+D*_+L*b,r[6]=V*o+j*h+H*g,r[7]=V*a+j*f+H*v,r[8]=V*u+j*_+H*b,r}function Vi(){var r=new nt(16);return nt!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function Tt(r){var e=new nt(16);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e}function Dt(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Mi(r,e){var i=e[0],o=e[1],a=e[2],u=e[3],h=e[4],f=e[5],_=e[6],g=e[7],v=e[8],b=e[9],w=e[10],I=e[11],A=e[12],P=e[13],D=e[14],L=e[15],V=i*f-o*h,j=i*_-a*h,H=i*g-u*h,te=o*_-a*f,K=o*g-u*f,oe=a*g-u*_,le=v*P-b*A,ue=v*D-w*A,Me=v*L-I*A,ye=b*D-w*P,Ce=b*L-I*P,Oe=w*L-I*D,Ne=V*Oe-j*Ce+H*ye+te*Me-K*ue+oe*le;return Ne?(r[0]=(f*Oe-_*Ce+g*ye)*(Ne=1/Ne),r[1]=(a*Ce-o*Oe-u*ye)*Ne,r[2]=(P*oe-D*K+L*te)*Ne,r[3]=(w*K-b*oe-I*te)*Ne,r[4]=(_*Me-h*Oe-g*ue)*Ne,r[5]=(i*Oe-a*Me+u*ue)*Ne,r[6]=(D*H-A*oe-L*j)*Ne,r[7]=(v*oe-w*H+I*j)*Ne,r[8]=(h*Ce-f*Me+g*le)*Ne,r[9]=(o*Me-i*Ce-u*le)*Ne,r[10]=(A*K-P*H+L*V)*Ne,r[11]=(b*H-v*K-I*V)*Ne,r[12]=(f*ue-h*ye-_*le)*Ne,r[13]=(i*ye-o*ue+a*le)*Ne,r[14]=(P*j-A*te-D*V)*Ne,r[15]=(v*te-b*j+w*V)*Ne,r):null}function Yt(r,e,i){var o=e[0],a=e[1],u=e[2],h=e[3],f=e[4],_=e[5],g=e[6],v=e[7],b=e[8],w=e[9],I=e[10],A=e[11],P=e[12],D=e[13],L=e[14],V=e[15],j=i[0],H=i[1],te=i[2],K=i[3];return r[0]=j*o+H*f+te*b+K*P,r[1]=j*a+H*_+te*w+K*D,r[2]=j*u+H*g+te*I+K*L,r[3]=j*h+H*v+te*A+K*V,r[4]=(j=i[4])*o+(H=i[5])*f+(te=i[6])*b+(K=i[7])*P,r[5]=j*a+H*_+te*w+K*D,r[6]=j*u+H*g+te*I+K*L,r[7]=j*h+H*v+te*A+K*V,r[8]=(j=i[8])*o+(H=i[9])*f+(te=i[10])*b+(K=i[11])*P,r[9]=j*a+H*_+te*w+K*D,r[10]=j*u+H*g+te*I+K*L,r[11]=j*h+H*v+te*A+K*V,r[12]=(j=i[12])*o+(H=i[13])*f+(te=i[14])*b+(K=i[15])*P,r[13]=j*a+H*_+te*w+K*D,r[14]=j*u+H*g+te*I+K*L,r[15]=j*h+H*v+te*A+K*V,r}function wi(r,e,i){var o,a,u,h,f,_,g,v,b,w,I,A,P=i[0],D=i[1],L=i[2];return e===r?(r[12]=e[0]*P+e[4]*D+e[8]*L+e[12],r[13]=e[1]*P+e[5]*D+e[9]*L+e[13],r[14]=e[2]*P+e[6]*D+e[10]*L+e[14],r[15]=e[3]*P+e[7]*D+e[11]*L+e[15]):(a=e[1],u=e[2],h=e[3],f=e[4],_=e[5],g=e[6],v=e[7],b=e[8],w=e[9],I=e[10],A=e[11],r[0]=o=e[0],r[1]=a,r[2]=u,r[3]=h,r[4]=f,r[5]=_,r[6]=g,r[7]=v,r[8]=b,r[9]=w,r[10]=I,r[11]=A,r[12]=o*P+f*D+b*L+e[12],r[13]=a*P+_*D+w*L+e[13],r[14]=u*P+g*D+I*L+e[14],r[15]=h*P+v*D+A*L+e[15]),r}function Ci(r,e,i){var o=i[0],a=i[1],u=i[2];return r[0]=e[0]*o,r[1]=e[1]*o,r[2]=e[2]*o,r[3]=e[3]*o,r[4]=e[4]*a,r[5]=e[5]*a,r[6]=e[6]*a,r[7]=e[7]*a,r[8]=e[8]*u,r[9]=e[9]*u,r[10]=e[10]*u,r[11]=e[11]*u,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function tr(r,e,i){var o=Math.sin(i),a=Math.cos(i),u=e[4],h=e[5],f=e[6],_=e[7],g=e[8],v=e[9],b=e[10],w=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=u*a+g*o,r[5]=h*a+v*o,r[6]=f*a+b*o,r[7]=_*a+w*o,r[8]=g*a-u*o,r[9]=v*a-h*o,r[10]=b*a-f*o,r[11]=w*a-_*o,r}function vi(r,e,i){var o=Math.sin(i),a=Math.cos(i),u=e[0],h=e[1],f=e[2],_=e[3],g=e[8],v=e[9],b=e[10],w=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=u*a-g*o,r[1]=h*a-v*o,r[2]=f*a-b*o,r[3]=_*a-w*o,r[8]=u*o+g*a,r[9]=h*o+v*a,r[10]=f*o+b*a,r[11]=_*o+w*a,r}function Ti(r,e,i){var o=Math.sin(i),a=Math.cos(i),u=e[0],h=e[1],f=e[2],_=e[3],g=e[4],v=e[5],b=e[6],w=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=u*a+g*o,r[1]=h*a+v*o,r[2]=f*a+b*o,r[3]=_*a+w*o,r[4]=g*a-u*o,r[5]=v*a-h*o,r[6]=b*a-f*o,r[7]=w*a-_*o,r}function Si(r,e){return r[0]=e[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function hr(r,e,i){var o,a,u,h=i[0],f=i[1],_=i[2],g=Math.sqrt(h*h+f*f+_*_);return g<et?null:(h*=g=1/g,f*=g,_*=g,o=Math.sin(e),a=Math.cos(e),r[0]=h*h*(u=1-a)+a,r[1]=f*h*u+_*o,r[2]=_*h*u-f*o,r[3]=0,r[4]=h*f*u-_*o,r[5]=f*f*u+a,r[6]=_*f*u+h*o,r[7]=0,r[8]=h*_*u+f*o,r[9]=f*_*u-h*o,r[10]=_*_*u+a,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}function Sr(r,e){var i=e[0],o=e[1],a=e[2],u=e[4],h=e[5],f=e[6],_=e[8],g=e[9],v=e[10];return r[0]=Math.sqrt(i*i+o*o+a*a),r[1]=Math.sqrt(u*u+h*h+f*f),r[2]=Math.sqrt(_*_+g*g+v*v),r}function br(r,e){var i=e[0],o=e[1],a=e[2],u=e[3],h=i+i,f=o+o,_=a+a,g=i*h,v=o*h,b=o*f,w=a*h,I=a*f,A=a*_,P=u*h,D=u*f,L=u*_;return r[0]=1-b-A,r[1]=v+L,r[2]=w-D,r[3]=0,r[4]=v-L,r[5]=1-g-A,r[6]=I+P,r[7]=0,r[8]=w+D,r[9]=I-P,r[10]=1-g-b,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}var Or=Yt;function Jt(){var r=new nt(3);return nt!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function On(r){var e=new nt(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function yn(r){var e=r[0],i=r[1],o=r[2];return Math.sqrt(e*e+i*i+o*o)}function rr(r,e,i){var o=new nt(3);return o[0]=r,o[1]=e,o[2]=i,o}function Li(r,e,i,o){return r[0]=e,r[1]=i,r[2]=o,r}function Er(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r[2]=e[2]+i[2],r}function en(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],r}function Zn(r,e,i){return r[0]=e[0]*i[0],r[1]=e[1]*i[1],r[2]=e[2]*i[2],r}function lo(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r}function xn(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r}function Wi(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r}function Fn(r,e,i,o){return r[0]=e[0]+i[0]*o,r[1]=e[1]+i[1]*o,r[2]=e[2]+i[2]*o,r}function Wo(r,e){var i=e[0]-r[0],o=e[1]-r[1],a=e[2]-r[2];return Math.sqrt(i*i+o*o+a*a)}function En(r,e){var i=e[0]-r[0],o=e[1]-r[1],a=e[2]-r[2];return i*i+o*o+a*a}function us(r){var e=r[0],i=r[1],o=r[2];return e*e+i*i+o*o}function Qn(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r}function Oi(r,e){var i=e[0],o=e[1],a=e[2],u=i*i+o*o+a*a;return u>0&&(u=1/Math.sqrt(u)),r[0]=e[0]*u,r[1]=e[1]*u,r[2]=e[2]*u,r}function Gi(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function Cr(r,e,i){var o=e[0],a=e[1],u=e[2],h=i[0],f=i[1],_=i[2];return r[0]=a*_-u*f,r[1]=u*h-o*_,r[2]=o*f-a*h,r}function fn(r,e,i,o){var a=e[0],u=e[1],h=e[2];return r[0]=a+o*(i[0]-a),r[1]=u+o*(i[1]-u),r[2]=h+o*(i[2]-h),r}function nr(r,e,i){var o=e[0],a=e[1],u=e[2],h=i[3]*o+i[7]*a+i[11]*u+i[15];return r[0]=(i[0]*o+i[4]*a+i[8]*u+i[12])/(h=h||1),r[1]=(i[1]*o+i[5]*a+i[9]*u+i[13])/h,r[2]=(i[2]*o+i[6]*a+i[10]*u+i[14])/h,r}function kn(r,e,i){var o=e[0],a=e[1],u=e[2];return r[0]=o*i[0]+a*i[3]+u*i[6],r[1]=o*i[1]+a*i[4]+u*i[7],r[2]=o*i[2]+a*i[5]+u*i[8],r}function In(r,e,i){var o=i[0],a=i[1],u=i[2],h=i[3],f=e[0],_=e[1],g=e[2],v=a*g-u*_,b=u*f-o*g,w=o*_-a*f;return r[0]=f+h*(v+=v)+a*(w+=w)-u*(b+=b),r[1]=_+h*b+u*v-o*w,r[2]=g+h*w+o*b-a*v,r}function An(r){return r[0]=0,r[1]=0,r[2]=0,r}function co(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]}var Pr=en,hs=Zn,Bn=yn;function vn(){var r=new nt(4);return nt!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function uo(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r[3]=e[3]*i,r}function vs(r,e){var i=e[0],o=e[1],a=e[2],u=e[3],h=i*i+o*o+a*a+u*u;return h>0&&(h=1/Math.sqrt(h)),r[0]=i*h,r[1]=o*h,r[2]=a*h,r[3]=u*h,r}function pn(r,e,i){var o=e[0],a=e[1],u=e[2],h=e[3];return r[0]=i[0]*o+i[4]*a+i[8]*u+i[12]*h,r[1]=i[1]*o+i[5]*a+i[9]*u+i[13]*h,r[2]=i[2]*o+i[6]*a+i[10]*u+i[14]*h,r[3]=i[3]*o+i[7]*a+i[11]*u+i[15]*h,r}function Po(){var r=new nt(4);return nt!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function Rt(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r}function qt(r,e,i){i*=.5;var o=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),_=Math.cos(i);return r[0]=o*_+h*f,r[1]=a*_+u*f,r[2]=u*_-a*f,r[3]=h*_-o*f,r}function bi(r,e,i){i*=.5;var o=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),_=Math.cos(i);return r[0]=o*_-u*f,r[1]=a*_+h*f,r[2]=u*_+o*f,r[3]=h*_-a*f,r}Jt(),vn();var ci,xr,ar,hi=vs,Xo=(ci=Jt(),xr=rr(1,0,0),ar=rr(0,1,0),function(r,e,i){var o=Gi(e,i);return o<-.999999?(Cr(ci,xr,e),Bn(ci)<1e-6&&Cr(ci,ar,e),Oi(ci,ci),(function(a,u,h){h*=.5;var f=Math.sin(h);a[0]=f*u[0],a[1]=f*u[1],a[2]=f*u[2],a[3]=Math.cos(h)})(r,ci,Math.PI),r):o>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(Cr(ci,e,i),r[0]=ci[0],r[1]=ci[1],r[2]=ci[2],r[3]=1+o,hi(r,r))});function Nr(){var r=new nt(2);return nt!=Float32Array&&(r[0]=0,r[1]=0),r}function yo(r,e){var i=new nt(2);return i[0]=r,i[1]=e,i}function Yo(r,e,i){return r[0]=e,r[1]=i,r}function xo(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r}function Wn(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r}function Mn(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r}function cr(r){var e=r[0],i=r[1];return Math.sqrt(e*e+i*i)}function Xr(r,e){var i=e[0],o=e[1],a=i*i+o*o;return a>0&&(a=1/Math.sqrt(a)),r[0]=e[0]*a,r[1]=e[1]*a,r}function ho(r,e){return r[0]*e[0]+r[1]*e[1]}Po(),Po(),At();var Yr,Kr,Un=Wn;function vo(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}Nr();var eo=(function(){if(Kr)return Yr;function r(e,i,o,a){this.cx=3*e,this.bx=3*(o-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(a-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=o,this.p2y=a}return Kr=1,Yr=r,r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var o=e,a=0;a<8;a++){var u=this.sampleCurveX(o)-e;if(Math.abs(u)<i)return o;var h=this.sampleCurveDerivativeX(o);if(Math.abs(h)<1e-6)break;o-=u/h}var f=0,_=1;for(o=e,a=0;a<20&&(u=this.sampleCurveX(o),!(Math.abs(u-e)<i));a++)e>u?f=o:_=o,o=.5*(_-f)+f;return o},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},Yr})(),Cn=vo(eo);function Be(r,e){this.x=r,this.y=e}function to(r,e){if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(!to(r[i],e[i]))return!1;return!0}if(typeof r=="object"&&r!==null&&e!==null){if(typeof e!="object"||Object.keys(r).length!==Object.keys(e).length)return!1;for(const i in r)if(!to(r[i],e[i]))return!1;return!0}return r===e}Be.prototype={clone(){return new Be(this.x,this.y)},add(r){return this.clone()._add(r)},sub(r){return this.clone()._sub(r)},multByPoint(r){return this.clone()._multByPoint(r)},divByPoint(r){return this.clone()._divByPoint(r)},mult(r){return this.clone()._mult(r)},div(r){return this.clone()._div(r)},rotate(r){return this.clone()._rotate(r)},rotateAround(r,e){return this.clone()._rotateAround(r,e)},matMult(r){return this.clone()._matMult(r)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(r){return this.x===r.x&&this.y===r.y},dist(r){return Math.sqrt(this.distSqr(r))},distSqr(r){const e=r.x-this.x,i=r.y-this.y;return e*e+i*i},angle(){return Math.atan2(this.y,this.x)},angleTo(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith(r){return this.angleWithSep(r.x,r.y)},angleWithSep(r,e){return Math.atan2(this.x*e-this.y*r,this.x*r+this.y*e)},_matMult(r){const e=r[2]*this.x+r[3]*this.y;return this.x=r[0]*this.x+r[1]*this.y,this.y=e,this},_add(r){return this.x+=r.x,this.y+=r.y,this},_sub(r){return this.x-=r.x,this.y-=r.y,this},_mult(r){return this.x*=r,this.y*=r,this},_div(r){return this.x/=r,this.y/=r,this},_multByPoint(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint(r){return this.x/=r.x,this.y/=r.y,this},_unit(){return this._div(this.mag()),this},_perp(){const r=this.y;return this.y=this.x,this.x=-r,this},_rotate(r){const e=Math.cos(r),i=Math.sin(r),o=i*this.x+e*this.y;return this.x=e*this.x-i*this.y,this.y=o,this},_rotateAround(r,e){const i=Math.cos(r),o=Math.sin(r),a=e.y+o*(this.x-e.x)+i*(this.y-e.y);return this.x=e.x+i*(this.x-e.x)-o*(this.y-e.y),this.y=a,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Be},Be.convert=function(r){if(r instanceof Be)return r;if(Array.isArray(r))return new Be(+r[0],+r[1]);if(r.x!==void 0&&r.y!==void 0)return new Be(+r.x,+r.y);throw new Error("Expected [x, y] or {x, y} point format")};const cn=Math.PI/180,bo=180/Math.PI;function ii(r){return r*cn}function Jr(r){return r*bo}const Ps=[[0,0],[1,0],[1,1],[0,1]];function ds(r){if(r<=0)return 0;if(r>=1)return 1;const e=r*r,i=e*r;return 4*(r<.5?i:3*(r-e)+i-.75)}function fe(r,e,i,o){const a=new Cn(r,e,i,o);return function(u){return a.solve(u)}}const O=fe(.25,.1,.25,1);function B(r,e,i){return Math.min(i,Math.max(e,r))}function X(r,e,i){return(i=B((i-r)/(e-r),0,1))*i*(3-2*i)}function ae(r,e,i){const o=i-e,a=((r-e)%o+o)%o+e;return a===e?i:a}function se(r,e,i){if(!r.length)return i(null,[]);let o=r.length;const a=new Array(r.length);let u=null;r.forEach(((h,f)=>{e(h,((_,g)=>{_&&(u=_),a[f]=g,--o==0&&i(u,a)}))}))}let de=1;function Ee(){return de++}function pe(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log2(r)))}function Te(r,e){r.forEach((i=>{e[i]&&(e[i]=e[i].bind(e))}))}function We(r,e,i){const o={};for(const a in r)o[a]=e.call(this,r[a],a,r);return o}function je(r,e,i){const o={};for(const a in r)e.call(this,r[a],a,r)&&(o[a]=r[a]);return o}function bt(r){return Array.isArray(r)?r.map(bt):typeof r=="object"&&r?We(r,bt):r}function Vt(r,e){for(let i=0;i<r.length;i++)if(e.indexOf(r[i])>=0)return!0;return!1}const kt={};function Mt(r){kt[r]||(typeof console<"u"&&console.warn(r),kt[r]=!0)}function ni(r,e,i){return(i.y-r.y)*(e.x-r.x)>(e.y-r.y)*(i.x-r.x)}function si(r){let e=0;for(let i,o,a=0,u=r.length,h=u-1;a<u;h=a++)i=r[a],o=r[h],e+=(o.x-i.x)*(i.y+o.y);return e}function Xi([r,e,i]){const o=ii(e+90),a=ii(i);return{x:r*Math.cos(o)*Math.sin(a),y:r*Math.sin(o)*Math.sin(a),z:r*Math.cos(a),azimuthal:e,polar:i}}function Fr(r){return(typeof self<"u"||r!==void 0)&&typeof WorkerGlobalScope<"u"&&(r!==void 0?r:self)instanceof WorkerGlobalScope}function tn(r){const e={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((i,o,a,u)=>{const h=a||u;return e[o]=!h||h.toLowerCase(),""})),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let Hr=null;function Ur(r,e){return[r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]]}function $i(r,e,i,o){for(;e<i;){const a=e+i>>1;r[a]<o?e=a+1:i=a}return e}function di(r,e,i,o){for(;e<i;){const a=e+i>>1;r[a]<=o?e=a+1:i=a}return e}function dr(r){return r>0?1/(1.001-r):1+r}function Rr(r){return r>0?1-1/(1.001-r):-r}function Ki(r,e,i){return(r-e.min)*(i.max-i.min)/(e.max-e.min)+i.min}const fr={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!fr.API_URL)return null;try{const r=new URL(fr.API_URL);return r.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":r.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch(r){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.3.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function un(r){return fr.API_URL_REGEX.test(r)}function Xn(r){return fr.API_SPRITE_REGEX.test(r)}let Ko,pa,mn,Jo,io,fs;function wo(){return Ko==null&&(Ko=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),Ko}const To={now:()=>Jo!==void 0?Jo:performance.now(),setNow(r){Jo=r},restoreNow(){Jo=void 0},frame(r){const e=requestAnimationFrame(r);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(r,e=0){const{width:i,height:o}=r;io||(io=document.createElement("canvas"));const a=io.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("failed to create canvas 2d context");return(i>io.width||o>io.height)&&(io.width=i,io.height=o),a.clearRect(-e,-e,i+2*e,o+2*e),a.drawImage(r,0,0,i,o),a.getImageData(-e,-e,i+2*e,o+2*e)},resolveURL:r=>(pa||(pa=document.createElement("a")),pa.href=r,pa.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(mn==null&&(mn=window.matchMedia("(prefers-reduced-motion: reduce)")),mn.matches)},hasCanvasFingerprintNoise(){if(fs!==void 0)return fs;if(!wo())return fs=!1,!1;const r=new OffscreenCanvas(85,1),e=r.getContext("2d",{willReadFrequently:!0});let i=0;for(let a=0;a<r.width;++a)e.fillStyle="rgba(".concat(i++,",").concat(i++,",").concat(i++,", 255)"),e.fillRect(a,0,1,1);const o=e.getImageData(0,0,r.width,r.height);i=0;for(let a=0;a<o.data.length;++a)if(a%4!=3&&i++!==o.data[a])return fs=!0,!0;return fs=!1,!1}};function Pc(r,e){const i=r.indexOf("?");if(i<0)return"".concat(r,"?").concat(new URLSearchParams(e).toString());const o=new URLSearchParams(r.slice(i));for(const a in e)o.set(a,e[a]);return"".concat(r.slice(0,i),"?").concat(o.toString())}function Dl(r,e={persistentParams:[]}){const i=r.indexOf("?");if(i<0)return r;const o=new URLSearchParams,a=new URLSearchParams(r.slice(i));for(const h of e.persistentParams){const f=a.get(h);f&&o.set(h,f)}const u=o.toString();return"".concat(r.slice(0,i)).concat(u.length>0?"?".concat(u):"")}const zl="mapbox-tiles";let Ll=500,fo=50;const ps=["language","worldview","jobid"];let ro,Ro;function Rs(){try{return caches}catch(r){}}function ma(){const r=Rs();r&&ro==null&&(ro=r.open(zl))}let Rc=1/0;const Dc={supported:!1,testSupport:function(r){!sh&&Ys&&(xf?ah(r):bs=r)}};let bs,Ys,sh=!1,xf=!1;const Qo=typeof self<"u"?self:{};function ah(r){const e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,Ys),r.isContextLost())return;Dc.supported=!0}catch(i){}r.deleteTexture(e),sh=!0}Qo.document&&(Ys=Qo.document.createElement("img"),Ys.onload=function(){bs&&ah(bs),bs=null,xf=!0},Ys.onerror=function(){sh=!0,bs=null},Ys.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const _a={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(_a);class ga extends Error{constructor(e,i,o){i===401&&un(o)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=o}toString(){return"".concat(this.name,": ").concat(this.message," (").concat(this.status,"): ").concat(this.url)}}const lh=Fr()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Ol=function(r,e){if(!(/^file:/.test(i=r.url)||/^file:/.test(lh())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return(function(o,a){const u=new AbortController,h=new Request(o.url,{method:o.method||"GET",body:o.body,credentials:o.credentials,headers:o.headers,referrer:lh(),referrerPolicy:o.referrerPolicy,signal:u.signal});let f=!1,_=!1;const g=(v=h.url).indexOf("sku=")>0&&un(v);var v;o.type==="json"&&h.headers.set("Accept","application/json");const b=(I,A,P)=>{if(_)return;if(I&&I.message!=="SecurityError"&&Mt(I.toString()),A&&P)return w(A);const D=Date.now();fetch(h).then((L=>{if(L.ok){const V=g?L.clone():null;return w(L,V,D)}return a(new ga(L.statusText,L.status,o.url))})).catch((L=>{L.name!=="AbortError"&&a(new Error("".concat(L.message," ").concat(o.url)))}))},w=(I,A,P)=>{(o.type==="arrayBuffer"?I.arrayBuffer():o.type==="json"?I.json():I.text()).then((D=>{_||(A&&P&&(function(L,V,j){if(ma(),ro==null)return;const H=tn(V.headers.get("Cache-Control")||"");if(H["no-store"])return;const te={status:V.status,statusText:V.statusText,headers:new Headers};V.headers.forEach(((le,ue)=>te.headers.set(ue,le))),H["max-age"]&&te.headers.set("Expires",new Date(j+1e3*H["max-age"]).toUTCString());const K=te.headers.get("Expires");if(!K||new Date(K).getTime()-j<42e4)return;let oe=Dl(L.url,{persistentParams:ps});if(V.status===206){const le=L.headers.get("Range");if(!le)return;te.status=200,oe=Pc(oe,{range:le})}(function(le,ue){if(Ro===void 0)try{new Response(new ReadableStream),Ro=!0}catch(Me){Ro=!1}Ro?ue(le.body):le.blob().then(ue).catch((Me=>Mt(Me.message)))})(V,(le=>{const ue=new Response((Me=V.status)!==200&&Me!==404&&[101,103,204,205,304].includes(Me)?null:le,te);var Me;ma(),ro!=null&&ro.then((ye=>ye.put(oe,ue))).catch((ye=>Mt(ye.message)))}))})(h,A,P),f=!0,a(null,D,I.headers))})).catch((D=>{_||a(new Error(D.message))}))};return g?(function(I,A){if(ma(),ro==null)return A(null);ro.then((P=>{let D=Dl(I.url,{persistentParams:ps});const L=I.headers.get("Range");L&&(D=Pc(D,{range:L})),P.match(D).then((V=>{const j=(function(H){if(!H)return!1;const te=new Date(H.headers.get("Expires")||0),K=tn(H.headers.get("Cache-Control")||"");return Number(te)>Date.now()&&!K["no-cache"]})(V);P.delete(D).catch(A),j&&P.put(D,V.clone()).catch(A),A(null,V,j)})).catch(A)})).catch(A)})(h,b):b(null,null),{cancel:()=>{_=!0,f||u.abort()}}})(r,e);if(Fr(self)&&self.worker.actor)return self.worker.actor.send("getResource",r,e,void 0,!0)}var i;return(function(o,a){const u=new XMLHttpRequest;u.open(o.method||"GET",o.url,!0),o.type==="arrayBuffer"&&(u.responseType="arraybuffer");for(const h in o.headers)u.setRequestHeader(h,o.headers[h]);return o.type==="json"&&(u.responseType="text",u.setRequestHeader("Accept","application/json")),u.withCredentials=o.credentials==="include",u.onerror=()=>{a(new Error(u.statusText))},u.onload=()=>{if((u.status>=200&&u.status<300||u.status===0)&&u.response!==null){let h=u.response;if(o.type==="json")try{h=JSON.parse(u.response)}catch(_){return a(_)}const f=new Headers;u.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach((_=>{const g=_.split(": "),v=g.shift(),b=g.join(": ");f.append(v,b)})),a(null,h,f)}else a(new ga(u.statusText,u.status,o.url))},u.send(o.body),{cancel:()=>u.abort()}})(r,e)},Na=function(r,e){return Ol(Object.assign(r,{type:"arrayBuffer"}),e)};function Fi(r){const e=document.createElement("a");return e.href=r,e.protocol===location.protocol&&e.host===location.host}const ch="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Fl,kl;Fl=[],kl=0;const uh=function(r,e){if(Dc.supported&&(r.headers||(r.headers={}),r.headers.accept="image/webp,*/*"),kl>=fr.MAX_PARALLEL_IMAGE_REQUESTS){const u={requestParameters:r,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Fl.push(u),u}kl++;let i=!1;const o=()=>{if(!i)for(i=!0,kl--;Fl.length&&kl<fr.MAX_PARALLEL_IMAGE_REQUESTS;){const u=Fl.shift(),{requestParameters:h,callback:f,cancelled:_}=u;_||(u.cancel=uh(h,f).cancel)}},a=Na(r,((u,h,f)=>{o(),u?e(u):h&&(self.createImageBitmap?(function(_,g){const v=new Blob([new Uint8Array(_)],{type:"image/png"});createImageBitmap(v).then((b=>{g(null,b)})).catch((b=>{g(new Error("Could not load image because of ".concat(b.message,". Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.")))}))})(h,((_,g)=>e(_,g,f))):(function(_,g){const v=new Image;v.onload=()=>{g(null,v),URL.revokeObjectURL(v.src),v.onload=null,requestAnimationFrame((()=>{v.src=ch}))},v.onerror=()=>g(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const b=new Blob([new Uint8Array(_)],{type:"image/png"});v.src=_.byteLength?URL.createObjectURL(b):ch})(h,((_,g)=>e(_,g,f))))}));return{cancel:()=>{a.cancel(),o()}}};var Bl,Nl,Vl,ya={exports:{}},vf={exports:{}},zc={exports:{}},gm=(function(){if(Vl)return ya.exports;Vl=1;var r=(Bl||(Bl=1,vf.exports=function(i,o){var a,u,h,f,_,g,v,b;for(u=i.length-(a=3&i.length),h=o,_=3432918353,g=461845907,b=0;b<u;)v=255&i.charCodeAt(b)|(255&i.charCodeAt(++b))<<8|(255&i.charCodeAt(++b))<<16|(255&i.charCodeAt(++b))<<24,++b,h=27492+(65535&(f=5*(65535&(h=(h^=v=(65535&(v=(v=(65535&v)*_+(((v>>>16)*_&65535)<<16)&4294967295)<<15|v>>>17))*g+(((v>>>16)*g&65535)<<16)&4294967295)<<13|h>>>19))+((5*(h>>>16)&65535)<<16)&4294967295))+((58964+(f>>>16)&65535)<<16);switch(v=0,a){case 3:v^=(255&i.charCodeAt(b+2))<<16;case 2:v^=(255&i.charCodeAt(b+1))<<8;case 1:h^=v=(65535&(v=(v=(65535&(v^=255&i.charCodeAt(b)))*_+(((v>>>16)*_&65535)<<16)&4294967295)<<15|v>>>17))*g+(((v>>>16)*g&65535)<<16)&4294967295}return h^=i.length,h=2246822507*(65535&(h^=h>>>16))+((2246822507*(h>>>16)&65535)<<16)&4294967295,h=3266489909*(65535&(h^=h>>>13))+((3266489909*(h>>>16)&65535)<<16)&4294967295,(h^=h>>>16)>>>0}),vf.exports),e=(Nl||(Nl=1,zc.exports=function(i,o){for(var a,u=i.length,h=o^u,f=0;u>=4;)a=1540483477*(65535&(a=255&i.charCodeAt(f)|(255&i.charCodeAt(++f))<<8|(255&i.charCodeAt(++f))<<16|(255&i.charCodeAt(++f))<<24))+((1540483477*(a>>>16)&65535)<<16),h=1540483477*(65535&h)+((1540483477*(h>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),u-=4,++f;switch(u){case 3:h^=(255&i.charCodeAt(f+2))<<16;case 2:h^=(255&i.charCodeAt(f+1))<<8;case 1:h=1540483477*(65535&(h^=255&i.charCodeAt(f)))+((1540483477*(h>>>16)&65535)<<16)}return h=1540483477*(65535&(h^=h>>>13))+((1540483477*(h>>>16)&65535)<<16),(h^=h>>>15)>>>0}),zc.exports);return ya.exports=r,ya.exports.murmur3=r,ya.exports.murmur2=e,ya.exports})(),Ul=vo(gm);class Do{constructor(e,...i){Object.assign(this,i[0]||{}),this.type=e}}class jl extends Do{constructor(e,i={}){super("error",Object.assign({error:e},i))}}function Va(r,e,i){i[r]&&i[r].indexOf(e)!==-1||(i[r]=i[r]||[],i[r].push(e))}function Gl(r,e,i){if(i&&i[r]){const o=i[r].indexOf(e);o!==-1&&i[r].splice(o,1)}}class Ds{on(e,i){return this._listeners=this._listeners||{},Va(e,i,this._listeners),this}off(e,i){return Gl(e,i,this._listeners),Gl(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},Va(e,i,this._oneTimeListeners),this):new Promise((o=>{this.once(e,o)}))}fire(e,i){const o=typeof e=="string"?new Do(e,i):e,a=o.type;if(this.listens(a)){o.target=this;const u=this._listeners&&this._listeners[a]?this._listeners[a].slice():[];for(const _ of u)_.call(this,o);const h=this._oneTimeListeners&&this._oneTimeListeners[a]?this._oneTimeListeners[a].slice():[];for(const _ of h)Gl(a,_,this._oneTimeListeners),_.call(this,o);const f=this._eventedParent;if(f){const _=typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData;Object.assign(o,_),f.fire(o)}}else o instanceof jl&&console.error(o.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}class hn{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new hn(e)}static toString(e){return e.iconsetId?"".concat(e.name,"").concat(e.iconsetId):e.name}static parse(e){const[i,o]=e.split("");return new hn({name:i,iconsetId:o})}static isEqual(e,i){return e.name===i.name&&e.iconsetId===i.iconsetId}toString(){return hn.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var hh,dh={},fh=(function(){if(hh)return dh;hh=1;var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(u){return(u=Math.round(u))<0?0:u>255?255:u}function i(u){return e(u[u.length-1]==="%"?parseFloat(u)/100*255:parseInt(u))}function o(u){return(h=u[u.length-1]==="%"?parseFloat(u)/100:parseFloat(u))<0?0:h>1?1:h;var h}function a(u,h,f){return f<0?f+=1:f>1&&(f-=1),6*f<1?u+(h-u)*f*6:2*f<1?h:3*f<2?u+(h-u)*(2/3-f)*6:u}try{dh.parseCSSColor=function(u){var h,f=u.replace(/ /g,"").toLowerCase();if(f in r)return r[f].slice();if(f[0]==="#")return f.length===4?(h=parseInt(f.substr(1),16))>=0&&h<=4095?[(3840&h)>>4|(3840&h)>>8,240&h|(240&h)>>4,15&h|(15&h)<<4,1]:null:f.length===7&&(h=parseInt(f.substr(1),16))>=0&&h<=16777215?[(16711680&h)>>16,(65280&h)>>8,255&h,1]:null;var _=f.indexOf("("),g=f.indexOf(")");if(_!==-1&&g+1===f.length){var v=f.substr(0,_),b=f.substr(_+1,g-(_+1)).split(","),w=1;switch(v){case"rgba":if(b.length!==4)return null;w=o(b.pop());case"rgb":return b.length!==3?null:[i(b[0]),i(b[1]),i(b[2]),w];case"hsla":if(b.length!==4)return null;w=o(b.pop());case"hsl":if(b.length!==3)return null;var I=(parseFloat(b[0])%360+360)%360/360,A=o(b[1]),P=o(b[2]),D=P<=.5?P*(A+1):P+A-P*A,L=2*P-D;return[e(255*a(L,D,I+1/3)),e(255*a(L,D,I)),e(255*a(L,D,I-1/3)),w];default:return null}}return null}}catch(u){}return dh})();class Ui{constructor(e,i,o,a=1){this.r=e,this.g=i,this.b=o,this.a=a}static parse(e){if(!e)return;if(e instanceof Ui)return e;if(typeof e!="string")return;const i=fh.parseCSSColor(e);return i?new Ui(i[0]/255,i[1]/255,i[2]/255,i[3]):void 0}toString(){const[e,i,o,a]=[this.r,this.g,this.b,this.a];return"rgba(".concat(Math.round(255*e),",").concat(Math.round(255*i),",").concat(Math.round(255*o),",").concat(a,")")}toNonPremultipliedRenderColor(e){const{r:i,g:o,b:a,a:u}=this;return new bf(e,i,o,a,u)}toPremultipliedRenderColor(e){const{r:i,g:o,b:a,a:u}=this;return new wf(e,i*u,o*u,a*u,u)}clone(){return new Ui(this.r,this.g,this.b,this.a)}}class ph{constructor(e,i,o,a,u,h=!1){if(this.premultiplied=!1,this.premultiplied=h,e){const f=e.image.height,_=f*f;this.premultiplied?(i=u===0?0:i/u*(f-1),o=u===0?0:o/u*(f-1),a=u===0?0:a/u*(f-1)):(i*=f-1,o*=f-1,a*=f-1);const g=Math.floor(i),v=Math.floor(o),b=Math.floor(a),w=Math.ceil(i),I=Math.ceil(o),A=Math.ceil(a),P=i-g,D=o-v,L=a-b,V=e.image.data,j=4*(g+v*_+b*f),H=4*(g+v*_+A*f),te=4*(g+I*_+b*f),K=4*(g+I*_+A*f),oe=4*(w+v*_+b*f),le=4*(w+v*_+A*f),ue=4*(w+I*_+b*f),Me=4*(w+I*_+A*f);if(j<0||Me>=V.length)throw new Error("out of range");this.r=Ft(Ft(Ft(V[j],V[H],L),Ft(V[te],V[K],L),D),Ft(Ft(V[oe],V[le],L),Ft(V[ue],V[Me],L),D),P)/255*(this.premultiplied?u:1),this.g=Ft(Ft(Ft(V[j+1],V[H+1],L),Ft(V[te+1],V[K+1],L),D),Ft(Ft(V[oe+1],V[le+1],L),Ft(V[ue+1],V[Me+1],L),D),P)/255*(this.premultiplied?u:1),this.b=Ft(Ft(Ft(V[j+2],V[H+2],L),Ft(V[te+2],V[K+2],L),D),Ft(Ft(V[oe+2],V[le+2],L),Ft(V[ue+2],V[Me+2],L),D),P)/255*(this.premultiplied?u:1),this.a=u}else this.r=i,this.g=o,this.b=a,this.a=u}toArray(){const{r:e,g:i,b:o,a}=this;return[255*e,255*i,255*o,a]}toHslaArray(){let{r:e,g:i,b:o,a}=this;if(this.premultiplied){if(a===0)return[0,0,0,0];const A=1/a;e*=A,i*=A,o*=A}const u=Math.min(Math.max(e,0),1),h=Math.min(Math.max(i,0),1),f=Math.min(Math.max(o,0),1),_=Math.min(u,h,f),g=Math.max(u,h,f),v=g-_,b=.5*(_+g);if(v===0)return[0,0,100*b,a];const w=b>.5?v/(2-g-_):v/(g+_);let I;switch(g){case u:I=60*((h-f)/v+(h<f?6:0));break;case h:I=60*((f-u)/v+2);break;default:I=60*((u-h)/v+4)}return[I,100*w,100*b,a]}toArray01(){const{r:e,g:i,b:o,a}=this;return[e,i,o,a]}toArray01Scaled(e){const{r:i,g:o,b:a}=this;return[i*e,o*e,a*e]}toArray01Linear(){const{r:e,g:i,b:o,a}=this;return[Math.pow(e,2.2),Math.pow(i,2.2),Math.pow(o,2.2),a]}}class bf extends ph{constructor(e,i,o,a,u){super(e,i,o,a,u,!1)}}class wf extends ph{constructor(e,i,o,a,u){super(e,i,o,a,u,!0)}}function Ft(r,e,i){return r*(1-i)+e*i}function Hl(r,e,i){return r.map(((o,a)=>Ft(o,e[a],i)))}Ui.black=new Ui(0,0,0,1),Ui.white=new Ui(1,1,1,1),Ui.transparent=new Ui(0,0,0,0),Ui.red=new Ui(1,0,0,1),Ui.blue=new Ui(0,0,1,1);var zs=Object.freeze({__proto__:null,array:Hl,color:function(r,e,i){return new Ui(Ft(r.r,e.r,i),Ft(r.g,e.g,i),Ft(r.b,e.b,i),Ft(r.a,e.a,i))},number:Ft});class es extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class ts{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[o,a]of i)this.bindings[o]=a}concat(e){return new ts(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error("".concat(e," not found in scope."))}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const Ua={kind:"null"},St={kind:"number"},Ei={kind:"string"},Bi={kind:"boolean"},So={kind:"color"},ja={kind:"object"},Hi={kind:"value"},ql={kind:"collator"},xa={kind:"formatted"},$l={kind:"resolvedImage"};function Pn(r,e){return{kind:"array",itemType:r,N:e}}function an(r){if(r.kind==="array"){const e=an(r.itemType);return typeof r.N=="number"?"array<".concat(e,", ").concat(r.N,">"):r.itemType.kind==="value"?"array":"array<".concat(e,">")}return r.kind}const ym=[Ua,St,Ei,Bi,So,xa,ja,Pn(Hi),$l];function Zl(r,e){if(e.kind==="error")return null;if(r.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Zl(r.itemType,e.itemType))&&(typeof r.N!="number"||r.N===e.N))return null}else{if(r.kind===e.kind)return null;if(r.kind==="value"){for(const i of ym)if(!Zl(i,e))return null}}return"Expected ".concat(an(r)," but found ").concat(an(e)," instead.")}function mh(r,e){return e.some((i=>i.kind===r.kind))}function Wl(r,e){return e.some((i=>i==="null"?r===null:i==="array"?Array.isArray(r):i==="object"?r&&!Array.isArray(r)&&typeof r=="object":i===typeof r))}function Lc(r,e){return r.kind==="array"&&e.kind==="array"?r.N===e.N&&Lc(r.itemType,e.itemType):r.kind===e.kind}class _h{constructor(e,i,o){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=o,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Xl{constructor(e,i,o,a,u){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=o,this.fontStack=a,this.textColor=u}}class bn{constructor(e){this.sections=e}static fromString(e){return new bn([new Xl(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some((e=>e.text.length!==0||!!e.image&&e.image.hasPrimary()))}static factory(e){return e instanceof bn?e:bn.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map((e=>e.text)).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){const a=i.image.getPrimary().id.toString();e.push(["image",a]);continue}e.push(i.text);const o={};i.fontStack&&(o["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(o["font-scale"]=i.scale),i.textColor&&(o["text-color"]=["rgba"].concat(i.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(o)}return e}}class Ls{constructor(e,i={}){if(this.id=hn.from(e),this.options=Object.assign({},i),i.transform){const{a:o,b:a,c:u,d:h,e:f,f:_}=i.transform;this.options.transform=new DOMMatrix([o,a,u,h,f,_])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:e,b:i,c:o,d:a,e:u,f:h}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:i,c:o,d:a,e:u,f:h}})}static parse(e){let i,o,a,u;try{({name:i,iconsetId:o,params:a,transform:u}=JSON.parse(e)||{})}catch(w){return null}if(!i)return null;const{a:h,b:f,c:_,d:g,e:v,f:b}=u||{};return new Ls({name:i,iconsetId:o},{params:a,transform:new DOMMatrix([h,f,_,g,v,b])})}scaleSelf(e,i){return this.options.transform.scaleSelf(e,i),this}}class po{constructor(e,i,o,a,u=!1){this.primaryId=hn.from(e),this.primaryOptions=i,o&&(this.secondaryId=hn.from(o)),this.secondaryOptions=a,this.available=u}toString(){return this.primaryId&&this.secondaryId?"[".concat(this.primaryId.name,",").concat(this.secondaryId.name,"]"):this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Ls(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Ls(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?po.build({name:e}):e}static build(e,i,o,a){return!e||typeof e=="object"&&!("name"in e)?null:new po(e,o,i,a)}}function Oc(r,e,i,o){return typeof r=="number"&&r>=0&&r<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?o===void 0||typeof o=="number"&&o>=0&&o<=1?null:"Invalid rgba value [".concat([r,e,i,o].join(", "),"]: 'a' must be between 0 and 1."):"Invalid rgba value [".concat((typeof o=="number"?[r,e,i,o]:[r,e,i]).join(", "),"]: 'r', 'g', and 'b' must be between 0 and 255.")}function Ga(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof Ui||r instanceof _h||r instanceof bn||r instanceof po)return!0;if(Array.isArray(r)){for(const e of r)if(!Ga(e))return!1;return!0}if(typeof r=="object"){for(const e in r)if(!Ga(r[e]))return!1;return!0}return!1}function _n(r){if(r===null)return Ua;if(typeof r=="string")return Ei;if(typeof r=="boolean")return Bi;if(typeof r=="number")return St;if(r instanceof Ui)return So;if(r instanceof _h)return ql;if(r instanceof bn)return xa;if(r instanceof po)return $l;if(Array.isArray(r)){const e=r.length;let i;for(const o of r){const a=_n(o);if(i){if(i===a)continue;i=Hi;break}i=a}return Pn(i||Hi,e)}return ja}function ws(r){const e=typeof r;return r===null?"":e==="string"||e==="number"||e==="boolean"?String(r):r instanceof bn||r instanceof po||r instanceof Ui?r.toString():JSON.stringify(r)}class Os{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error("'literal' expression requires exactly one argument, but found ".concat(e.length-1," instead."));if(!Ga(e[1]))return i.error("invalid value");const o=e[1];let a=_n(o);const u=i.expectedType;return a.kind!=="array"||a.N!==0||!u||u.kind!=="array"||typeof u.N=="number"&&u.N!==0||(a=u),new Os(a,o)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Ui?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof bn?this.value.serialize():this.value}}class qr{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const ti={string:Ei,number:St,boolean:Bi,object:ja};class xt{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let o,a=1;const u=e[0];if(u==="array"){let f,_;if(e.length>2){const g=e[1];if(typeof g!="string"||!(g in ti)||g==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);f=ti[g],a++}else f=Hi;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);_=e[2],a++}o=Pn(f,_)}else o=ti[u];const h=[];for(;a<e.length;a++){const f=i.parse(e[a],a,Hi);if(!f)return null;h.push(f)}return new xt(o,h)}evaluate(e){for(let i=0;i<this.args.length;i++){const o=this.args[i].evaluate(e);if(!Zl(this.type,_n(o)))return o;if(i===this.args.length-1)throw new qr("The expression ".concat(JSON.stringify(this.args[i].serialize())," evaluated to ").concat(an(_n(o))," but was expected to be of type ").concat(an(this.type),"."))}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=this.type,i=[e.kind];if(e.kind==="array"){const o=e.itemType;if(o.kind==="string"||o.kind==="number"||o.kind==="boolean"){i.push(o.kind);const a=e.N;(typeof a=="number"||this.args.length>1)&&i.push(a)}}return i.concat(this.args.map((o=>o.serialize())))}}class va{constructor(e){this.type=xa,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const o=e[1];if(!Array.isArray(o)&&typeof o=="object")return i.error("First argument must be an image or text section.");const a=[];let u=!1;for(let h=1;h<=e.length-1;++h){const f=e[h];if(u&&typeof f=="object"&&!Array.isArray(f)){u=!1;let _=null;if(f["font-scale"]&&(_=i.parseObjectValue(f["font-scale"],h,"font-scale",St),!_))return null;let g=null;if(f["text-font"]&&(g=i.parseObjectValue(f["text-font"],h,"text-font",Pn(Ei)),!g))return null;let v=null;if(f["text-color"]&&(v=i.parseObjectValue(f["text-color"],h,"text-color",So),!v))return null;const b=a[a.length-1];b.scale=_,b.font=g,b.textColor=v}else{const _=i.parse(e[h],h,Hi);if(!_)return null;const g=_.type.kind;if(g!=="string"&&g!=="value"&&g!=="null"&&g!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");u=!0,a.push({content:_,scale:null,font:null,textColor:null})}}return new va(a)}evaluate(e){return new bn(this.sections.map((i=>{const o=i.content.evaluate(e);return Lc(_n(o),$l)?new Xl("",o,null,null,null):new Xl(ws(o),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)})))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const o={};i.scale&&(o["font-scale"]=i.scale.serialize()),i.font&&(o["text-font"]=i.font.serialize()),i.textColor&&(o["text-color"]=i.textColor.serialize()),e.push(o)}return e}}class Gt{constructor(e,i,o,a){this._imageWarnHistory={},this.type=$l,this.namePrimary=e,this.nameSecondary=i,o&&(this.paramsPrimary=o.params,this.iconsetIdPrimary=o.iconset?o.iconset.id:void 0),a&&(this.paramsSecondary=a.params,this.iconsetIdSecondary=a.iconset?a.iconset.id:void 0)}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let o=1;const a=[];function u(){if(o<e.length){const f=i.parse(e[o],o++,Ei);return f?(a.push({image:f,options:{}}),!0):(i.error(a.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function h(){if(o<e.length){const _=e[o];if((f=_)===null||typeof f!="object"||Array.isArray(f))return!0;const g=_.params,v=_.iconset,b=i.concat(o);if(!g&&!v)return o++,!0;if(g){if(typeof g!="object"||g.constructor!==Object)return b.error('Image options "params" should be an object'),!1;const w={},I=b.concat(void 0,"params");for(const A in g){if(!A)return I.error("Image parameter name should be non-empty"),!1;const P=I.concat(void 0,A).parse(g[A],void 0,So,void 0,{typeAnnotation:"coerce"});if(!P)return!1;w[A]=P}a[a.length-1].options.params=w}if(v){if(typeof v!="object"||v.constructor!==Object)return b.error('Image options "iconset" should be an object'),!1;if(!v.id)return b.error('Image options "iconset" should have an "id" property'),!1;a[a.length-1].options.iconset=v}return o++,!0}var f;return!0}for(let f=0;f<2;f++)if(!u()||!h())return;return new Gt(a[0].image,a[1]?a[1].image:void 0,a[0].options,a[1]?a[1].options:void 0)}evaluateParams(e,i){const o={};if(i){for(const a in i)if(i[a])try{o[a]=i[a].evaluate(e)}catch(u){continue}if(Object.keys(o).length!==0)return{params:o}}}evaluate(e){const i={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},o=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,a=po.build(i,o,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(a&&e.availableImages){const u=a.getPrimary().id;if(a.available=e.availableImages.some((h=>hn.isEqual(h,u))),a.available){const h=a.getSecondary()?a.getSecondary().id:null;h&&(a.available=e.availableImages.some((f=>hn.isEqual(f,h))))}}return a}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const i in this.paramsPrimary)this.paramsPrimary[i]&&e(this.paramsPrimary[i]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const i in this.paramsSecondary)this.paramsSecondary[i]&&e(this.paramsSecondary[i])}outputDefined(){return!1}serializeOptions(e,i){const o={};if(i&&(o.iconset={id:i}),e){o.params={};for(const a in e)e[a]&&(o.params[a]=e[a].serialize())}return Object.keys(o).length>0?o:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const i=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);i&&e.push(i)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const i=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);i&&e.push(i)}return e}}function Ha(r){return Bt(r)?"string":Yl(r)?"number":kc(r)?"boolean":Array.isArray(r)?"array":r===null?"null":Fc(r)?"object":typeof r}function Fc(r){return r!=null&&!Array.isArray(r)&&typeof r!="function"&&!(r instanceof String||r instanceof Number||r instanceof Boolean)&&typeof r=="object"}function Bt(r){return typeof r=="string"||r instanceof String}function Yl(r){return typeof r=="number"||r instanceof Number}function kc(r){return typeof r=="boolean"||r instanceof Boolean}const Tf={"to-boolean":Bi,"to-color":So,"to-number":St,"to-string":Ei};class Ts{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const o=e[0],a=[];let u=Ua;if(o==="to-array"){if(!Array.isArray(e[1]))return null;const h=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error("Expected ".concat(i.expectedType.kind," but found array."));u=Pn(i.expectedType.itemType,h)}else{if(!(h>0&&Ga(e[1][0])))return null;u=Pn(_n(e[1][0]),h)}for(let f=0;f<h;f++){const _=e[1][f];let g;if(Array.isArray(_))g=i.parse(_,void 0,u.itemType);else{const v=Ha(_);if(v!==u.itemType.kind)return i.error("Expected ".concat(u.itemType.kind," but found ").concat(v,"."));g=i.registry.literal.parse(["literal",_===void 0?null:_],i)}if(!g)return null;a.push(g)}}else{if((o==="to-boolean"||o==="to-string")&&e.length!==2)return i.error("Expected one argument.");u=Tf[o];for(let h=1;h<e.length;h++){const f=i.parse(e[h],h,Hi);if(!f)return null;a.push(f)}}return new Ts(u,a)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,o;for(const a of this.args){if(i=a.evaluate(e),o=null,i instanceof Ui)return i;if(typeof i=="string"){const u=e.parseColor(i);if(u)return u}else if(Array.isArray(i)&&(o=i.length<3||i.length>4?"Invalid rbga value ".concat(JSON.stringify(i),": expected an array containing either three or four numeric values."):Oc(i[0],i[1],i[2],i[3]),!o))return new Ui(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new qr(o||"Could not parse color from value '".concat(typeof i=="string"?i:String(JSON.stringify(i)),"'"))}if(this.type.kind==="number"){let i=null;for(const o of this.args){if(i=o.evaluate(e),i===null)return 0;const a=Number(i);if(!isNaN(a))return a}throw new qr("Could not convert ".concat(JSON.stringify(i)," to number."))}return this.type.kind==="formatted"?bn.fromString(ws(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?po.build(ws(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map((i=>i.evaluate(e))):ws(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){if(this.type.kind==="formatted")return new va([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new Gt(this.args[0]).serialize();const e=this.type.kind==="array"?[]:["to-".concat(this.type.kind)];return this.eachChild((i=>{e.push(i.serialize())})),e}}const Bc=["Unknown","Point","LineString","Polygon"];class Rn{constructor(e,i,o){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i,this.iconImageUseTheme=o}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Bc[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:o,y:a}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(o*i-e[0])+this.featureDistanceData.bearing[1]*(a*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=Ui.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class Yn{constructor(e,i,o,a,u){this.name=e,this.type=i,this._evaluate=o,this.args=a,this._overloadIndex=u}evaluate(e){if(!this._evaluate){const i=Yn.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((e=>e.serialize())))}static parse(e,i){const o=e[0],a=Yn.definitions[o];if(!a)return i.error('Unknown expression "'.concat(o,'". If you wanted a literal array, use ["literal", [...]].'),0);const u=Array.isArray(a)?a[0]:a.type,h=Array.isArray(a)?[[a[1],a[2]]]:a.overloads,f=[];let _=null,g=-1;for(const[v,b]of h){if(Array.isArray(v)&&v.length!==e.length-1)continue;f.push(v),g++,_=new Wc(i.registry,i.path,null,i.scope,void 0,i._scope,i.options,i.iconImageUseTheme);const w=[];let I=!1;for(let A=1;A<e.length;A++){const P=e[A],D=Array.isArray(v)?v[A-1]:v.type,L=_.parse(P,1+w.length,D);if(!L){I=!0;break}w.push(L)}if(!I)if(Array.isArray(v)&&v.length!==w.length)_.error("Expected ".concat(v.length," arguments, but found ").concat(w.length," instead."));else{for(let A=0;A<w.length;A++){const P=Array.isArray(v)?v[A]:v.type,D=w[A];_.concat(A+1).checkSubtype(P,D.type)}if(_.errors.length===0)return new Yn(o,u,b,w,g)}}if(f.length===1)i.errors.push(..._.errors);else{const v=(f.length?f:h.map((([w])=>w))).map(ba).join(" | "),b=[];for(let w=1;w<e.length;w++){const I=i.parse(e[w],1+b.length);if(!I)return null;b.push(an(I.type))}i.error("Expected arguments of type ".concat(v,", but found (").concat(b.join(", "),") instead."))}return null}static register(e,i){Yn.definitions=i;for(const o in i)e[o]=Yn}}function ba(r){return Array.isArray(r)?"(".concat(r.map(an).join(", "),")"):"(".concat(an(r.type),"...)")}class qa{constructor(e,i,o){this.type=ql,this.locale=o,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");const o=e[1];if(typeof o!="object"||Array.isArray(o))return i.error("Collator options argument must be an object.");const a=o["case-sensitive"]===void 0?i.parse(!1,1,Bi):i.parseObjectValue(o["case-sensitive"],1,"case-sensitive",Bi);if(!a)return null;const u=o["diacritic-sensitive"]===void 0?i.parse(!1,1,Bi):i.parseObjectValue(o["diacritic-sensitive"],1,"diacritic-sensitive",Bi);if(!u)return null;let h=null;return o.locale&&(h=i.parseObjectValue(o.locale,1,"locale",Ei),!h)?null:new qa(a,u,h)}evaluate(e){return new _h(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Fs(r,e,i=0,o=r.length-1,a=xm){for(;o>i;){if(o-i>600){const _=o-i+1,g=e-i+1,v=Math.log(_),b=.5*Math.exp(2*v/3),w=.5*Math.sqrt(v*b*(_-b)/_)*(g-_/2<0?-1:1);Fs(r,e,Math.max(i,Math.floor(e-g*b/_+w)),Math.min(o,Math.floor(e+(_-g)*b/_+w)),a)}const u=r[e];let h=i,f=o;for(Dn(r,i,e),a(r[o],u)>0&&Dn(r,i,o);h<f;){for(Dn(r,h,f),h++,f--;a(r[h],u)<0;)h++;for(;a(r[f],u)>0;)f--}a(r[i],u)===0?Dn(r,i,f):(f++,Dn(r,f,o)),f<=e&&(i=f+1),e<=f&&(o=f-1)}}function Dn(r,e,i){const o=r[e];r[e]=r[i],r[i]=o}function xm(r,e){return r<e?-1:r>e?1:0}function vm(r){let e=0;for(let i,o,a=0,u=r.length,h=u-1;a<u;h=a++)i=r[a],o=r[h],e+=(o.x-i.x)*(i.y+o.y);return e}function Kl(r,e){r[0]=Math.min(r[0],e[0]),r[1]=Math.min(r[1],e[1]),r[2]=Math.max(r[2],e[0]),r[3]=Math.max(r[3],e[1])}function Ks(r,e){return!(r[0]<=e[0]||r[2]>=e[2]||r[1]<=e[1]||r[3]>=e[3])}function Sf(r,e,i){const o=r[0]-e[0],a=r[1]-e[1],u=r[0]-i[0],h=r[1]-i[1];return o*h-u*a==0&&o*u<=0&&a*h<=0}function is(r,e,i=!1){let o=!1;for(let f=0,_=e.length;f<_;f++){const g=e[f];for(let v=0,b=g.length,w=b-1;v<b;w=v++){const I=g[w],A=g[v];if(Sf(r,I,A))return i;(u=I)[1]>(a=r)[1]!=(h=A)[1]>a[1]&&a[0]<(h[0]-u[0])*(a[1]-u[1])/(h[1]-u[1])+u[0]&&(o=!o)}}var a,u,h;return o}function Ef(r,e,i,o){const a=o[0]-i[0],u=o[1]-i[1],h=(r[0]-i[0])*u-a*(r[1]-i[1]),f=(e[0]-i[0])*u-a*(e[1]-i[1]);return h>0&&f<0||h<0&&f>0}function Nc(r,e,i,o){return(a=[o[0]-i[0],o[1]-i[1]])[0]*(u=[e[0]-r[0],e[1]-r[1]])[1]-a[1]*u[0]!=0&&!(!Ef(r,e,i,o)||!Ef(i,o,r,e));var a,u}function Jl(r){const e=new Be(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new Be(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const o of r[0])e.x>o.x&&(e.x=o.x),e.y>o.y&&(e.y=o.y),i.x<o.x&&(i.x=o.x),i.y<o.y&&(i.y=o.y);return{min:e,max:i}}const Js=8192;function bm(r,e){const i=(180+r[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,a=Math.pow(2,e.z);return[Math.round(i*a*Js),Math.round(o*a*Js)]}function If(r,e){for(let i=0;i<e.length;i++)if(is(r,e[i]))return!0;return!1}function wm(r,e,i){for(const o of i)for(let a=0,u=o.length,h=u-1;a<u;h=a++)if(Nc(r,e,o[h],o[a]))return!0;return!1}function Qs(r,e){for(let i=0;i<r.length;++i)if(!is(r[i],e))return!1;for(let i=0;i<r.length-1;++i)if(wm(r[i],r[i+1],e))return!1;return!0}function Tm(r,e){for(let i=0;i<e.length;i++)if(Qs(r,e[i]))return!0;return!1}function gh(r,e,i){const o=[];for(let a=0;a<r.length;a++){const u=[];for(let h=0;h<r[a].length;h++){const f=bm(r[a][h],i);Kl(e,f),u.push(f)}o.push(u)}return o}function Vc(r,e,i){const o=[];for(let a=0;a<r.length;a++){const u=gh(r[a],e,i);o.push(u)}return o}function yh(r,e,i,o){if(r[0]<i[0]||r[0]>i[2]){const a=.5*o;let u=r[0]-i[0]>a?-o:i[0]-r[0]>a?o:0;u===0&&(u=r[0]-i[2]>a?-o:i[2]-r[0]>a?o:0),r[0]+=u}Kl(e,r)}function xh(r,e,i,o){const a=Math.pow(2,o.z)*Js,u=[o.x*Js,o.y*Js],h=[];if(!r)return h;for(const f of r)for(const _ of f){const g=[_.x+u[0],_.y+u[1]];yh(g,e,i,a),h.push(g)}return h}function rs(r,e,i,o){const a=Math.pow(2,o.z)*Js,u=[o.x*Js,o.y*Js],h=[];if(!r)return h;for(const _ of r){const g=[];for(const v of _){const b=[v.x+u[0],v.y+u[1]];Kl(e,b),g.push(b)}h.push(g)}if(e[2]-e[0]<=a/2){(f=e)[0]=f[1]=1/0,f[2]=f[3]=-1/0;for(const _ of h)for(const g of _)yh(g,e,i,a)}var f;return h}class wa{constructor(e,i){this.type=Bi,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error("'within' expression requires exactly one argument, but found ".concat(e.length-1," instead."));if(Ga(e[1])){const o=e[1];if(o.type==="FeatureCollection")for(let a=0;a<o.features.length;++a){const u=o.features[a].geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new wa(o,o.features[a].geometry)}else if(o.type==="Feature"){const a=o.geometry.type;if(a==="Polygon"||a==="MultiPolygon")return new wa(o,o.geometry)}else if(o.type==="Polygon"||o.type==="MultiPolygon")return new wa(o,o)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return(function(i,o){const a=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(o.type==="Polygon"){const f=gh(o.coordinates,u,h),_=xh(i.geometry(),a,u,h);if(!Ks(a,u))return!1;for(const g of _)if(!is(g,f))return!1}if(o.type==="MultiPolygon"){const f=Vc(o.coordinates,u,h),_=xh(i.geometry(),a,u,h);if(!Ks(a,u))return!1;for(const g of _)if(!If(g,f))return!1}return!0})(e,this.geometries);if(e.geometryType()==="LineString")return(function(i,o){const a=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(o.type==="Polygon"){const f=gh(o.coordinates,u,h),_=rs(i.geometry(),a,u,h);if(!Ks(a,u))return!1;for(const g of _)if(!Qs(g,f))return!1}if(o.type==="MultiPolygon"){const f=Vc(o.coordinates,u,h),_=rs(i.geometry(),a,u,h);if(!Ks(a,u))return!1;for(const g of _)if(!Tm(g,f))return!1}return!0})(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Ql={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},vh=1/298.257223563,bh=vh*(2-vh),$a=Math.PI/180;class Za{static fromTile(e,i,o){const a=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),u=Math.atan(.5*(Math.exp(a)-Math.exp(-a)))/$a;return new Za(u,o)}static get units(){return Ql}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!Ql[i])throw new Error("Unknown unit ".concat(i,". Use one of: ").concat(Object.keys(Ql).join(", ")));const o=6378.137*$a*(i?Ql[i]:1),a=Math.cos(e*$a),u=1/(1-bh*(1-a*a)),h=Math.sqrt(u);this.kx=o*h*a,this.ky=o*h*u*(1-bh)}distance(e,i){const o=zo(e[0]-i[0])*this.kx,a=(e[1]-i[1])*this.ky;return Math.sqrt(o*o+a*a)}bearing(e,i){const o=zo(i[0]-e[0])*this.kx;return Math.atan2(o,(i[1]-e[1])*this.ky)/$a}destination(e,i,o){const a=o*$a;return this.offset(e,Math.sin(a)*i,Math.cos(a)*i)}offset(e,i,o){return[e[0]+i/this.kx,e[1]+o/this.ky]}lineDistance(e){let i=0;for(let o=0;o<e.length-1;o++)i+=this.distance(e[o],e[o+1]);return i}area(e){let i=0;for(let o=0;o<e.length;o++){const a=e[o];for(let u=0,h=a.length,f=h-1;u<h;f=u++)i+=zo(a[u][0]-a[f][0])*(a[u][1]+a[f][1])*(o?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let o=0;if(i<=0)return e[0];for(let a=0;a<e.length-1;a++){const u=e[a],h=e[a+1],f=this.distance(u,h);if(o+=f,o>i)return Uc(u,h,(i-(o-f))/f)}return e[e.length-1]}pointToSegmentDistance(e,i,o){let[a,u]=i,h=zo(o[0]-a)*this.kx,f=(o[1]-u)*this.ky;if(h!==0||f!==0){const _=(zo(e[0]-a)*this.kx*h+(e[1]-u)*this.ky*f)/(h*h+f*f);_>1?(a=o[0],u=o[1]):_>0&&(a+=h/this.kx*_,u+=f/this.ky*_)}return h=zo(e[0]-a)*this.kx,f=(e[1]-u)*this.ky,Math.sqrt(h*h+f*f)}pointOnLine(e,i){let o=1/0,a=e[0][0],u=e[0][1],h=0,f=0;for(let _=0;_<e.length-1;_++){let g=e[_][0],v=e[_][1],b=zo(e[_+1][0]-g)*this.kx,w=(e[_+1][1]-v)*this.ky,I=0;b===0&&w===0||(I=(zo(i[0]-g)*this.kx*b+(i[1]-v)*this.ky*w)/(b*b+w*w),I>1?(g=e[_+1][0],v=e[_+1][1]):I>0&&(g+=b/this.kx*I,v+=w/this.ky*I)),b=zo(i[0]-g)*this.kx,w=(i[1]-v)*this.ky;const A=b*b+w*w;A<o&&(o=A,a=g,u=v,h=_,f=I)}return{point:[a,u],index:h,t:Math.max(0,Math.min(1,f))}}lineSlice(e,i,o){let a=this.pointOnLine(o,e),u=this.pointOnLine(o,i);if(a.index>u.index||a.index===u.index&&a.t>u.t){const g=a;a=u,u=g}const h=[a.point],f=a.index+1,_=u.index;!wh(o[f],h[0])&&f<=_&&h.push(o[f]);for(let g=f+1;g<=_;g++)h.push(o[g]);return wh(o[_],u.point)||h.push(u.point),h}lineSliceAlong(e,i,o){let a=0;const u=[];for(let h=0;h<o.length-1;h++){const f=o[h],_=o[h+1],g=this.distance(f,_);if(a+=g,a>e&&u.length===0&&u.push(Uc(f,_,(e-(a-g))/g)),a>=i)return u.push(Uc(f,_,(i-(a-g))/g)),u;a>e&&u.push(_)}return u}bufferPoint(e,i){const o=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-o,e[0]+a,e[1]+o]}bufferBBox(e,i){const o=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-o,e[2]+a,e[3]+o]}insideBBox(e,i){return zo(e[0]-i[0])>=0&&zo(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function wh(r,e){return r[0]===e[0]&&r[1]===e[1]}function Uc(r,e,i){const o=zo(e[0]-r[0]);return[r[0]+o*i,r[1]+(e[1]-r[1])*i]}function zo(r){for(;r<-180;)r+=360;for(;r>180;)r-=360;return r}class jc{constructor(e=[],i=((o,a)=>o<a?-1:o>a?1:0)){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let o=(this.length>>1)-1;o>=0;o--)this._down(o)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:i,compare:o}=this,a=i[e];for(;e>0;){const u=e-1>>1,h=i[u];if(o(a,h)>=0)break;i[e]=h,e=u}i[e]=a}_down(e){const{data:i,compare:o}=this,a=this.length>>1,u=i[e];for(;e<a;){let h=1+(e<<1);const f=h+1;if(f<this.length&&o(i[f],i[h])<0&&(h=f),o(i[h],u)>=0)break;i[e]=i[h],e=h}i[e]=u}}var Je=8192;function Th(r,e){return e.dist-r.dist}const Wa=100,Xa=50;function ec(r){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==r.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==r[i])return!1;return!0}function tc(r){return r[1]-r[0]+1}function Ss(r,e){const i=r[1]>=r[0]&&r[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function Gc(r,e){if(r[0]>r[1])return[null,null];const i=tc(r);if(e){if(i===2)return[r,null];const o=Math.floor(i/2);return[[r[0],r[0]+o],[r[0]+o,r[1]]]}{if(i===1)return[r,null];const o=Math.floor(i/2)-1;return[[r[0],r[0]+o],[r[0]+o+1,r[1]]]}}function ns(r,e){const i=[1/0,1/0,-1/0,-1/0];if(!Ss(e,r.length))return i;for(let o=e[0];o<=e[1];++o)Kl(i,r[o]);return i}function ui(r){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<r.length;++i)for(let o=0;o<r[i].length;++o)Kl(e,r[i][o]);return e}function Ya(r,e,i){if(ec(r)||ec(e))return NaN;let o=0,a=0;return r[2]<e[0]&&(o=e[0]-r[2]),r[0]>e[2]&&(o=r[0]-e[2]),r[1]>e[3]&&(a=r[1]-e[3]),r[3]<e[1]&&(a=e[1]-r[3]),i.distance([0,0],[o,a])}function Sm(r){return 360*r-180}function Em(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function Hc(r,e){const i=Math.pow(2,e.z),o=(r.y/Je+e.y)/i;return[Sm((r.x/Je+e.x)/i),Em(o)]}function Im(r,e){const i=[];for(let o=0;o<r.length;++o)i.push(Hc(r[o],e));return i}function Ir(r,e,i){const o=i.pointOnLine(e,r).point;return i.distance(r,o)}function Af(r,e,i,o,a){const u=i.slice(o[0],o[1]+1);let h=1/0;for(let f=e[0];f<=e[1];++f)if((h=Math.min(h,Ir(r[f],u,a)))===0)return 0;return h}function Sh(r,e,i,o,a){const u=Math.min(a.pointToSegmentDistance(r,i,o),a.pointToSegmentDistance(e,i,o)),h=Math.min(a.pointToSegmentDistance(i,r,e),a.pointToSegmentDistance(o,r,e));return Math.min(u,h)}function Am(r,e,i,o,a){if(!Ss(e,r.length)||!Ss(o,i.length))return NaN;let u=1/0;for(let h=e[0];h<e[1];++h)for(let f=o[0];f<o[1];++f){if(Nc(r[h],r[h+1],i[f],i[f+1]))return 0;u=Math.min(u,Sh(r[h],r[h+1],i[f],i[f+1],a))}return u}function Mm(r,e,i,o,a){if(!Ss(e,r.length)||!Ss(o,i.length))return NaN;let u=1/0;for(let h=e[0];h<=e[1];++h)for(let f=o[0];f<=o[1];++f)if((u=Math.min(u,a.distance(r[h],i[f])))===0)return u;return u}function Cm(r,e,i){if(is(r,e,!0))return 0;let o=1/0;for(const a of e){const u=a.length;if(u<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(a[0]!==a[u-1]&&(o=Math.min(o,i.pointToSegmentDistance(r,a[u-1],a[0])))===0||(o=Math.min(o,Ir(r,a,i)))===0)return o}return o}function Pm(r,e,i,o){if(!Ss(e,r.length))return NaN;for(let u=e[0];u<=e[1];++u)if(is(r[u],i,!0))return 0;let a=1/0;for(let u=e[0];u<e[1];++u)for(const h of i)for(let f=0,_=h.length,g=_-1;f<_;g=f++){if(Nc(r[u],r[u+1],h[g],h[f]))return 0;a=Math.min(a,Sh(r[u],r[u+1],h[g],h[f],o))}return a}function Mf(r,e){for(const i of r)for(let o=0;o<=i.length-1;++o)if(is(i[o],e,!0))return!0;return!1}function Rm(r,e,i,o=1/0){const a=ui(r),u=ui(e);if(o!==1/0&&Ya(a,u,i)>=o)return o;if(Ks(a,u)){if(Mf(r,e))return 0}else if(Mf(e,r))return 0;let h=o;for(const f of r)for(let _=0,g=f.length,v=g-1;_<g;v=_++)for(const b of e)for(let w=0,I=b.length,A=I-1;w<I;A=w++){if(Nc(f[v],f[_],b[A],b[w]))return 0;h=Math.min(h,Sh(f[v],f[_],b[A],b[w],i))}return h}function qc(r,e,i,o,a,u,h){if(u===null||h===null)return;const f=Ya(ns(o,u),ns(a,h),i);f<e&&r.push({dist:f,range1:u,range2:h})}function Dm(r,e,i,o,a=1/0){let u=Math.min(o.distance(r[0],i[0][0]),a);if(u===0)return u;const h=new jc([{dist:0,range1:[0,r.length-1],range2:[0,0]}],Th),f=e?Xa:Wa,_=ui(i);for(;h.length;){const g=h.pop();if(g.dist>=u)continue;const v=g.range1;if(tc(v)<=f){if(!Ss(v,r.length))return NaN;if(e){const b=Pm(r,v,i,o);if((u=Math.min(u,b))===0)return u}else for(let b=v[0];b<=v[1];++b){const w=Cm(r[b],i,o);if((u=Math.min(u,w))===0)return u}}else{const b=Gc(v,e);if(b[0]!==null){const w=Ya(ns(r,b[0]),_,o);w<u&&h.push({dist:w,range1:b[0],range2:[0,0]})}if(b[1]!==null){const w=Ya(ns(r,b[1]),_,o);w<u&&h.push({dist:w,range1:b[1],range2:[0,0]})}}}return u}function Cf(r,e,i,o,a,u=1/0){let h=Math.min(u,a.distance(r[0],i[0]));if(h===0)return h;const f=new jc([{dist:0,range1:[0,r.length-1],range2:[0,i.length-1]}],Th),_=e?Xa:Wa,g=o?Xa:Wa;for(;f.length;){const v=f.pop();if(v.dist>=h)continue;const b=v.range1,w=v.range2;if(tc(b)<=_&&tc(w)<=g){if(!Ss(b,r.length)||!Ss(w,i.length))return NaN;if(e&&o?h=Math.min(h,Am(r,b,i,w,a)):e||o?e&&!o?h=Math.min(h,Af(i,w,r,b,a)):!e&&o&&(h=Math.min(h,Af(r,b,i,w,a))):h=Math.min(h,Mm(r,b,i,w,a)),h===0)return h}else{const I=Gc(b,e),A=Gc(w,o);qc(f,h,a,r,i,I[0],A[0]),qc(f,h,a,r,i,I[0],A[1]),qc(f,h,a,r,i,I[1],A[0]),qc(f,h,a,r,i,I[1],A[1])}}return h}function Eh(r,e,i,o,a=1/0){let u=a;const h=ns(r,[0,r.length-1]);for(const f of i)if(!(u!==1/0&&Ya(h,ns(f,[0,f.length-1]),o)>=u)&&(u=Math.min(u,Cf(r,e,f,!0,o,u)),u===0))return u;return u}function $c(r,e,i,o,a=1/0){let u=a;const h=ns(r,[0,r.length-1]);for(const f of i){if(u!==1/0&&Ya(h,ui(f),o)>=u)continue;const _=Dm(r,e,f,o,u);if(isNaN(_))return _;if((u=Math.min(u,_))===0)return u}return u}function Ih(r){return r==="Point"||r==="MultiPoint"||r==="LineString"||r==="MultiLineString"||r==="Polygon"||r==="MultiPolygon"}class Ta{constructor(e,i){this.type=St,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error("'distance' expression requires either one argument, but found ' ".concat(e.length-1," instead."));if(Ga(e[1])){const o=e[1];if(o.type==="FeatureCollection"){for(let a=0;a<o.features.length;++a)if(Ih(o.features[a].geometry.type))return new Ta(o,o.features[a].geometry)}else if(o.type==="Feature"){if(Ih(o.geometry.type))return new Ta(o,o.geometry)}else if(Ih(o.type))return new Ta(o,o)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),o=e.canonicalID();if(i!=null&&o!=null){if(e.geometryType()==="Point")return(function(a,u,h){const f=[];for(const g of a)for(const v of g)f.push(Hc(v,u));const _=new Za(f[0][1],"meters");return h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString"?Cf(f,!1,h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",_):h.type==="MultiLineString"?Eh(f,!1,h.coordinates,_):h.type==="Polygon"||h.type==="MultiPolygon"?$c(f,!1,h.type==="Polygon"?[h.coordinates]:h.coordinates,_):null})(i,o,this.geometries);if(e.geometryType()==="LineString")return(function(a,u,h){const f=[];for(const g of a){const v=[];for(const b of g)v.push(Hc(b,u));f.push(v)}const _=new Za(f[0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return Eh(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",f,_);if(h.type==="MultiLineString"){let g=1/0;for(let v=0;v<h.coordinates.length;v++){const b=Eh(h.coordinates[v],!0,f,_,g);if(isNaN(b))return b;if((g=Math.min(g,b))===0)return g}return g}if(h.type==="Polygon"||h.type==="MultiPolygon"){let g=1/0;for(let v=0;v<f.length;v++){const b=$c(f[v],!0,h.type==="Polygon"?[h.coordinates]:h.coordinates,_,g);if(isNaN(b))return b;if((g=Math.min(g,b))===0)return g}return g}return null})(i,o,this.geometries);if(e.geometryType()==="Polygon")return(function(a,u,h){const f=[];for(const g of(function(v,b){const w=v.length;if(w<=1)return[v];const I=[];let A,P;for(let D=0;D<w;D++){const L=vm(v[D]);L!==0&&(v[D].area=Math.abs(L),P===void 0&&(P=L<0),P===L<0?(A&&I.push(A),A=[v[D]]):A.push(v[D]))}return A&&I.push(A),I})(a)){const v=[];for(let b=0;b<g.length;++b)v.push(Im(g[b],u));f.push(v)}const _=new Za(f[0][0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return $c(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",f,_);if(h.type==="MultiLineString"){let g=1/0;for(let v=0;v<h.coordinates.length;v++){const b=$c(h.coordinates[v],!0,f,_,g);if(isNaN(b))return b;if((g=Math.min(g,b))===0)return g}return g}return h.type==="Polygon"||h.type==="MultiPolygon"?(function(g,v,b){let w=1/0;for(const I of g)for(const A of v){const P=Rm(I,A,b,w);if(isNaN(P))return P;if((w=Math.min(w,P))===0)return w}return w})(h.type==="Polygon"?[h.coordinates]:h.coordinates,f,_):null})(i,o,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function Ka(r){if(r instanceof Yn&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof wa||r instanceof Ta)return!1;if(r instanceof Qa)return r.featureConstant;let e=!0;return r.eachChild((i=>{e&&!Ka(i)&&(e=!1)})),e}function ic(r){if(r instanceof Yn&&r.name==="feature-state")return!1;let e=!0;return r.eachChild((i=>{e&&!ic(i)&&(e=!1)})),e}function Ja(r,e){if(r instanceof Yn&&e.indexOf(r.name)>=0)return!1;let i=!0;return r.eachChild((o=>{i&&!Ja(o,e)&&(i=!1)})),i}function Pf(r,e,i){return[r,e,i].filter(Boolean).join("")}function Ah(r,e){switch(r){case"string":return ws(e);case"number":return+e;case"boolean":return!!e;case"color":return Ui.parse(e);case"formatted":return bn.fromString(ws(e));case"resolvedImage":return po.build(ws(e))}return e}function Rf(r,e,i,o){return o!==void 0&&(r=o*Math.round(r/o)),e!==void 0&&r<e&&(r=e),i!==void 0&&r>i&&(r=i),r}class Qa{constructor(e,i,o,a=!1){this.type=e,this.key=i,this.scope=o,this.featureConstant=a}static parse(e,i){let o=i.expectedType;if(o==null&&(o=Hi),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const a=i.parse(e[1],1);if(!(a instanceof Os))return i.error("Key name of 'config' expression must be a string literal.");let u,h=!0;const f=ws(a.value);if(e.length>=3){const _=i.parse(e[2],2);if(!(_ instanceof Os))return i.error("Scope of 'config' expression must be a string literal.");u=ws(_.value)}if(i.options){const _=Pf(f,u,i._scope),g=i.options.get(_);g&&(h=Ka(g.value||g.default))}return new Qa(o,f,u,h)}evaluate(e){const i=Pf(this.key,this.scope,e.scope),o=e.getConfig(i);if(!o)return null;const{type:a,value:u,values:h,minValue:f,maxValue:_,stepValue:g}=o,v=o.default.evaluate(e);let b=v;if(u){const w=e.scope;e.scope=(w||"").split("").slice(1).join(""),b=u.evaluate(e),e.scope=w}return a&&(b=Ah(a,b)),b===void 0||f===void 0&&_===void 0&&g===void 0||(typeof b=="number"?b=Rf(b,f,_,g):Array.isArray(b)&&(b=b.map((w=>typeof w=="number"?Rf(w,f,_,g):w)))),u!==void 0&&b!==void 0&&h&&!h.includes(b)&&(b=v,a&&(b=Ah(a,b))),(a&&a!==this.type||b!==void 0&&!Lc(_n(b),this.type))&&(b=Ah(this.type.kind,b)),b}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class Zc{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const o=e[1];return i.scope.has(o)?new Zc(o,i.scope.get(o)):i.error('Unknown variable "'.concat(o,'". Make sure "').concat(o,'" has been bound in an enclosing "let" expression before using it.'),1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Wc{constructor(e,i=[],o,a=new ts,u=[],h,f,_){this.registry=e,this.path=i,this.key=i.map((g=>typeof g=="string"?"['".concat(g,"']"):"[".concat(g,"]"))).join(""),this.scope=a,this.errors=u,this.expectedType=o,this._scope=h,this.options=f,this.iconImageUseTheme=_}parse(e,i,o,a,u={}){return i||o?this.concat(i,null,o,a)._parse(e,u):this._parse(e,u)}parseObjectValue(e,i,o,a,u,h={}){return this.concat(i,o,a,u)._parse(e,h)}_parse(e,i){function o(a,u,h){return h==="assert"?new xt(u,[a]):h==="coerce"?new Ts(u,[a]):a}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const a=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(a){let u=a.parse(e,this);if(!u)return null;if(this.expectedType){const h=this.expectedType,f=u.type;if(h.kind!=="string"&&h.kind!=="number"&&h.kind!=="boolean"&&h.kind!=="object"&&h.kind!=="array"||f.kind!=="value")if(h.kind!=="color"&&h.kind!=="formatted"&&h.kind!=="resolvedImage"||f.kind!=="value"&&f.kind!=="string"){if(this.checkSubtype(h,f))return null}else u=o(u,h,i.typeAnnotation||"coerce");else u=o(u,h,i.typeAnnotation||"assert")}if(!(u instanceof Os)&&u.type.kind!=="resolvedImage"&&Mh(u)){const h=new Rn(this._scope,this.options,this.iconImageUseTheme);try{u=new Os(u.type,u.evaluate(h))}catch(f){return this.error(f.message),null}}return u}return Ts.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':"Expected an array, but found ".concat(typeof e," instead."))}concat(e,i,o,a){let u=typeof e=="number"?this.path.concat(e):this.path;u=typeof i=="string"?u.concat(i):u;const h=a?this.scope.concat(a):this.scope;return new Wc(this.registry,u,o||null,h,this.errors,this._scope,this.options,this.iconImageUseTheme)}error(e,...i){const o="".concat(this.key).concat(i.map((a=>"[".concat(a,"]"))).join(""));this.errors.push(new es(o,e))}checkSubtype(e,i){const o=Zl(e,i);return o&&this.error(o),o}}function Mh(r){if(r instanceof Zc)return Mh(r.boundExpression);if(r instanceof Yn&&r.name==="error"||r instanceof qa||r instanceof wa||r instanceof Ta||r instanceof Qa)return!1;const e=r instanceof Ts||r instanceof xt;let i=!0;return r.eachChild((o=>{i=e?i&&Mh(o):i&&o instanceof Os})),!!i&&Ka(r)&&Ja(r,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Xc(r,e){const i=r.length-1;let o,a,u=0,h=i,f=0;for(;u<=h;)if(f=Math.floor((u+h)/2),o=r[f],a=r[f+1],o<=e){if(f===i||e<a)return f;u=f+1}else{if(!(o>e))throw new qr("Input is not a number.");h=f-1}return 0}class rc{constructor(e,i,o){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[a,u]of o)this.labels.push(a),this.outputs.push(u)}static parse(e,i){if(e.length-1<4)return i.error("Expected at least 4 arguments, but found only ".concat(e.length-1,"."));if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const o=i.parse(e[1],1,St);if(!o)return null;const a=[];let u=null;i.expectedType&&i.expectedType.kind!=="value"&&(u=i.expectedType);for(let h=1;h<e.length;h+=2){const f=h===1?-1/0:e[h],_=e[h+1],g=h,v=h+1;if(typeof f!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',g);if(a.length&&a[a.length-1][0]>=f)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',g);const b=i.parse(_,v,u);if(!b)return null;u=u||b.type,a.push([f,b])}return new rc(u,o,a)}evaluate(e){const i=this.labels,o=this.outputs;if(i.length===1)return o[0].evaluate(e);const a=this.input.evaluate(e);if(a<=i[0])return o[0].evaluate(e);const u=i.length;return a>=i[u-1]?o[u-1].evaluate(e):o[Xc(i,a)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const Df=.95047,zf=1.08883,Lf=4/29,el=6/29,Yc=3*el*el,zm=el*el*el,Of=Math.PI/180,Lm=180/Math.PI;function Ch(r){return r>zm?Math.pow(r,1/3):r/Yc+Lf}function Ph(r){return r>el?r*r*r:Yc*(r-Lf)}function Kc(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function Jc(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function Sa(r){const e=Jc(r.r),i=Jc(r.g),o=Jc(r.b),a=Ch((.4124564*e+.3575761*i+.1804375*o)/Df),u=Ch((.2126729*e+.7151522*i+.072175*o)/1);return{l:116*u-16,a:500*(a-u),b:200*(u-Ch((.0193339*e+.119192*i+.9503041*o)/zf)),alpha:r.a}}function Rh(r){let e=(r.l+16)/116,i=isNaN(r.a)?e:e+r.a/500,o=isNaN(r.b)?e:e-r.b/200;return e=1*Ph(e),i=Df*Ph(i),o=zf*Ph(o),new Ui(Kc(3.2404542*i-1.5371385*e-.4985314*o),Kc(-.969266*i+1.8760108*e+.041556*o),Kc(.0556434*i-.2040259*e+1.0572252*o),r.alpha)}function Ff(r,e,i){const o=e-r;return r+i*(o>180||o<-180?o-360*Math.round(o/360):o)}const nc={forward:Sa,reverse:Rh,interpolate:function(r,e,i){return{l:Ft(r.l,e.l,i),a:Ft(r.a,e.a,i),b:Ft(r.b,e.b,i),alpha:Ft(r.alpha,e.alpha,i)}}},Ea={forward:function(r){const{l:e,a:i,b:o}=Sa(r),a=Math.atan2(o,i)*Lm;return{h:a<0?a+360:a,c:Math.sqrt(i*i+o*o),l:e,alpha:r.a}},reverse:function(r){const e=r.h*Of,i=r.c;return Rh({l:r.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:r.alpha})},interpolate:function(r,e,i){return{h:Ff(r.h,e.h,i),c:Ft(r.c,e.c,i),l:Ft(r.l,e.l,i),alpha:Ft(r.alpha,e.alpha,i)}}};var Qc=Object.freeze({__proto__:null,hcl:Ea,lab:nc});class Lo{constructor(e,i,o,a,u){this.type=e,this.operator=i,this.interpolation=o,this.input=a,this.labels=[],this.outputs=[];for(const[h,f]of u)this.labels.push(h),this.outputs.push(f)}static interpolationFactor(e,i,o,a){let u=0;if(e.name==="exponential")u=Dh(i,e.base,o,a);else if(e.name==="linear")u=Dh(i,1,o,a);else if(e.name==="cubic-bezier"){const h=e.controlPoints;u=new Cn(h[0],h[1],h[2],h[3]).solve(Dh(i,1,o,a))}return u}static parse(e,i){let[o,a,u,...h]=e;if(!Array.isArray(a)||a.length===0)return i.error("Expected an interpolation type expression.",1);if(a[0]==="linear")a={name:"linear"};else if(a[0]==="exponential"){const g=a[1];if(typeof g!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);a={name:"exponential",base:g}}else{if(a[0]!=="cubic-bezier")return i.error("Unknown interpolation type ".concat(String(a[0])),1,0);{const g=a.slice(1);if(g.length!==4||g.some((v=>typeof v!="number"||v<0||v>1)))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);a={name:"cubic-bezier",controlPoints:g}}}if(e.length-1<4)return i.error("Expected at least 4 arguments, but found only ".concat(e.length-1,"."));if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(u=i.parse(u,2,St),!u)return null;const f=[];let _=null;o==="interpolate-hcl"||o==="interpolate-lab"?_=So:i.expectedType&&i.expectedType.kind!=="value"&&(_=i.expectedType);for(let g=0;g<h.length;g+=2){const v=h[g],b=h[g+1],w=g+3,I=g+4;if(typeof v!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',w);if(f.length&&f[f.length-1][0]>=v)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',w);const A=i.parse(b,I,_);if(!A)return null;_=_||A.type,f.push([v,A])}return _.kind==="number"||_.kind==="color"||_.kind==="array"&&_.itemType.kind==="number"&&typeof _.N=="number"?new Lo(_,o,a,u,f):i.error("Type ".concat(an(_)," is not interpolatable."))}evaluate(e){const i=this.labels,o=this.outputs;if(i.length===1)return o[0].evaluate(e);const a=this.input.evaluate(e);if(a<=i[0])return o[0].evaluate(e);const u=i.length;if(a>=i[u-1])return o[u-1].evaluate(e);const h=Xc(i,a),f=Lo.interpolationFactor(this.interpolation,a,i[h],i[h+1]),_=o[h].evaluate(e),g=o[h+1].evaluate(e);return this.operator==="interpolate"?zs[this.type.kind.toLowerCase()](_,g,f):this.operator==="interpolate-hcl"?Ea.reverse(Ea.interpolate(Ea.forward(_),Ea.forward(g),f)):nc.reverse(nc.interpolate(nc.forward(_),nc.forward(g),f))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const i=[this.operator,e,this.input.serialize()];for(let o=0;o<this.labels.length;o++)i.push(this.labels[o],this.outputs[o].serialize());return i}}function Dh(r,e,i,o){const a=o-i,u=r-i;return a===0?0:e===1?u/a:(Math.pow(e,u)-1)/(Math.pow(e,a)-1)}class oc{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let o=null;const a=i.expectedType;a&&a.kind!=="value"&&(o=a);const u=[];for(const f of e.slice(1)){const _=i.parse(f,1+u.length,o,void 0,{typeAnnotation:"omit"});if(!_)return null;o=o||_.type,u.push(_)}const h=a&&u.some((f=>Zl(a,f.type)));return new oc(h?Hi:o,u)}evaluate(e){let i,o=null,a=0;for(const u of this.args){if(a++,o=u.evaluate(e),o&&o instanceof po&&!o.available&&(i||(i=o),o=null,a===this.args.length))return i;if(o!==null)break}return o}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=["coalesce"];return this.eachChild((i=>{e.push(i.serialize())})),e}}class sc{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error("Expected at least 3 arguments, but found ".concat(e.length-1," instead."));const o=[];for(let u=1;u<e.length-1;u+=2){const h=e[u];if(typeof h!="string")return i.error("Expected string, but found ".concat(typeof h," instead."),u);if(/[^a-zA-Z0-9_]/.test(h))return i.error("Variable names must contain only alphanumeric characters or '_'.",u);const f=i.parse(e[u+1],u+1);if(!f)return null;o.push([h,f])}const a=i.parse(e[e.length-1],e.length-1,i.expectedType,o);return a?new sc(o,a):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,o]of this.bindings)e.push(i,o.serialize());return e.push(this.result.serialize()),e}}class zh{constructor(e,i,o){this.type=e,this.index=i,this.input=o}static parse(e,i){if(e.length!==3)return i.error("Expected 2 arguments, but found ".concat(e.length-1," instead."));const o=i.parse(e[1],1,St),a=i.parse(e[2],2,Pn(i.expectedType||Hi));return o&&a?new zh(a.type.itemType,o,a):null}evaluate(e){const i=this.index.evaluate(e),o=this.input.evaluate(e);if(i<0)throw new qr("Array index out of bounds: negative index");if(i>=o.length)throw new qr("Array index out of bounds: index exceeds array size");if(i!==Math.floor(i))throw new qr("Array index must be an integer. Use at-interpolated for fractional indices");return o[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Lh{constructor(e,i,o){this.type=e,this.index=i,this.input=o}static parse(e,i){if(e.length!==3)return i.error("Expected 2 arguments, but found ".concat(e.length-1," instead."));const o=i.parse(e[1],1,St),a=i.parse(e[2],2,Pn(i.expectedType||Hi));return o&&a?new Lh(a.type.itemType,o,a):null}evaluate(e){const i=this.index.evaluate(e),o=this.input.evaluate(e);if(i<0)throw new qr("Array index out of bounds: ".concat(i," < 0."));if(i>o.length-1)throw new qr("Array index out of bounds: ".concat(i," > ").concat(o.length-1,"."));if(i===Math.floor(i))return o[i];const a=Math.floor(i),u=Math.ceil(i),h=o[a],f=o[u];if(typeof h!="number"||typeof f!="number")throw new qr("Cannot interpolate between non-number values at index ".concat(i,"."));const _=i-a;return h*(1-_)+f*_}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Oh{constructor(e,i){this.type=Bi,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error("Expected 2 arguments, but found ".concat(e.length-1," instead."));const o=i.parse(e[1],1,Hi),a=i.parse(e[2],2,Hi);return o&&a?mh(o.type,[Bi,Ei,St,Ua,Hi])?new Oh(o,a):i.error("Expected first argument to be of type boolean, string, number or null, but found ".concat(an(o.type)," instead")):null}evaluate(e){const i=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(o==null)return!1;if(!Wl(i,["boolean","string","number","null"]))throw new qr("Expected first argument to be of type boolean, string, number or null, but found ".concat(an(_n(i))," instead."));if(!Wl(o,["string","array"]))throw new qr("Expected second argument to be of type array or string, but found ".concat(an(_n(o))," instead."));return o.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class ac{constructor(e,i,o){this.type=St,this.needle=e,this.haystack=i,this.fromIndex=o}static parse(e,i){if(e.length<=2||e.length>=5)return i.error("Expected 3 or 4 arguments, but found ".concat(e.length-1," instead."));const o=i.parse(e[1],1,Hi),a=i.parse(e[2],2,Hi);if(!o||!a)return null;if(!mh(o.type,[Bi,Ei,St,Ua,Hi]))return i.error("Expected first argument to be of type boolean, string, number or null, but found ".concat(an(o.type)," instead"));if(e.length===4){const u=i.parse(e[3],3,St);return u?new ac(o,a,u):null}return new ac(o,a)}evaluate(e){const i=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(!Wl(i,["boolean","string","number","null"]))throw new qr("Expected first argument to be of type boolean, string, number or null, but found ".concat(an(_n(i))," instead."));if(!Wl(o,["string","array"]))throw new qr("Expected second argument to be of type array or string, but found ".concat(an(_n(o))," instead."));if(this.fromIndex){const a=this.fromIndex.evaluate(e);return o.indexOf(i,a)}return o.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class eu{constructor(e,i,o,a,u,h){this.inputType=e,this.type=i,this.input=o,this.cases=a,this.outputs=u,this.otherwise=h}static parse(e,i){if(e.length<5)return i.error("Expected at least 4 arguments, but found only ".concat(e.length-1,"."));if(e.length%2!=1)return i.error("Expected an even number of arguments.");let o,a;i.expectedType&&i.expectedType.kind!=="value"&&(a=i.expectedType);const u={},h=[];for(let g=2;g<e.length-1;g+=2){let v=e[g];const b=e[g+1];Array.isArray(v)||(v=[v]);const w=i.concat(g);if(v.length===0)return w.error("Expected at least one branch label.");for(const A of v){if(typeof A!="number"&&typeof A!="string")return w.error("Branch labels must be numbers or strings.");if(typeof A=="number"&&Math.abs(A)>Number.MAX_SAFE_INTEGER)return w.error("Branch labels must be integers no larger than ".concat(Number.MAX_SAFE_INTEGER,"."));if(typeof A=="number"&&Math.floor(A)!==A)return w.error("Numeric branch labels must be integer values.");if(o){if(w.checkSubtype(o,_n(A)))return null}else o=_n(A);if(u[String(A)]!==void 0)return w.error("Branch labels must be unique.");u[String(A)]=h.length}const I=i.parse(b,g,a);if(!I)return null;a=a||I.type,h.push(I)}const f=i.parse(e[1],1,Hi);if(!f)return null;const _=i.parse(e[e.length-1],e.length-1,a);return _?f.type.kind!=="value"&&i.concat(1).checkSubtype(o,f.type)?null:new eu(o,a,f,u,h,_):null}evaluate(e){const i=this.input.evaluate(e);return(Lc(_n(i),this.inputType)&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),o=[],a={};for(const h of i){const f=a[this.cases[h]];f===void 0?(a[this.cases[h]]=o.length,o.push([this.cases[h],[h]])):o[f][1].push(h)}const u=h=>this.inputType.kind==="number"?Number(h):h;for(const[h,f]of o)e.push(f.length===1?u(f[0]):f.map(u)),e.push(this.outputs[h].serialize());return e.push(this.otherwise.serialize()),e}}class tl{constructor(e,i,o){this.type=e,this.branches=i,this.otherwise=o}static parse(e,i){if(e.length<4)return i.error("Expected at least 3 arguments, but found only ".concat(e.length-1,"."));if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let o;i.expectedType&&i.expectedType.kind!=="value"&&(o=i.expectedType);const a=[];for(let h=1;h<e.length-1;h+=2){const f=i.parse(e[h],h,Bi);if(!f)return null;const _=i.parse(e[h+1],h+1,o);if(!_)return null;a.push([f,_]),o=o||_.type}const u=i.parse(e[e.length-1],e.length-1,o);return u?new tl(o,a,u):null}evaluate(e){for(const[i,o]of this.branches)if(i.evaluate(e))return o.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,o]of this.branches)e(i),e(o);e(this.otherwise)}outputDefined(){return this.branches.every((([e,i])=>i.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild((i=>{e.push(i.serialize())})),e}}class tu{constructor(e,i,o,a){this.type=e,this.input=i,this.beginIndex=o,this.endIndex=a}static parse(e,i){if(e.length<=2||e.length>=5)return i.error("Expected 3 or 4 arguments, but found ".concat(e.length-1," instead."));const o=i.parse(e[1],1,Hi),a=i.parse(e[2],2,St);if(!o||!a)return null;if(!mh(o.type,[Pn(Hi),Ei,Hi]))return i.error("Expected first argument to be of type array or string, but found ".concat(an(o.type)," instead"));if(e.length===4){const u=i.parse(e[3],3,St);return u?new tu(o.type,o,a,u):null}return new tu(o.type,o,a)}evaluate(e){const i=this.input.evaluate(e),o=this.beginIndex.evaluate(e);if(!Wl(i,["string","array"]))throw new qr("Expected first argument to be of type array or string, but found ".concat(an(_n(i))," instead."));if(this.endIndex){const a=this.endIndex.evaluate(e);return i.slice(o,a)}return i.slice(o)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class iu{constructor(e,i){this.type=Pn(Ei),this.str=e,this.delimiter=i}static parse(e,i){if(e.length!==3)return i.error("Expected 2 arguments, but found ".concat(e.length-1," instead."));const o=i.parse(e[1],1,Ei),a=i.parse(e[2],2,Ei);return o&&a?new iu(o,a):void 0}evaluate(e){const i=this.str.evaluate(e),o=this.delimiter.evaluate(e);return i.split(o)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function kf(r,e){return r==="=="||r==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Bf(r,e,i,o){return o.compare(e,i)===0}function il(r,e,i){const o=r!=="=="&&r!=="!=";return class ub{constructor(u,h,f){this.type=Bi,this.lhs=u,this.rhs=h,this.collator=f,this.hasUntypedArgument=u.type.kind==="value"||h.type.kind==="value"}static parse(u,h){if(u.length!==3&&u.length!==4)return h.error("Expected two or three arguments.");const f=u[0];let _=h.parse(u[1],1,Hi);if(!_)return null;if(!kf(f,_.type))return h.concat(1).error('"'.concat(f,"\" comparisons are not supported for type '").concat(an(_.type),"'."));let g=h.parse(u[2],2,Hi);if(!g)return null;if(!kf(f,g.type))return h.concat(2).error('"'.concat(f,"\" comparisons are not supported for type '").concat(an(g.type),"'."));if(_.type.kind!==g.type.kind&&_.type.kind!=="value"&&g.type.kind!=="value")return h.error("Cannot compare types '".concat(an(_.type),"' and '").concat(an(g.type),"'."));o&&(_.type.kind==="value"&&g.type.kind!=="value"?_=new xt(g.type,[_]):_.type.kind!=="value"&&g.type.kind==="value"&&(g=new xt(_.type,[g])));let v=null;if(u.length===4){if(_.type.kind!=="string"&&g.type.kind!=="string"&&_.type.kind!=="value"&&g.type.kind!=="value")return h.error("Cannot use collator to compare non-string types.");if(v=h.parse(u[3],3,ql),!v)return null}return new ub(_,g,v)}evaluate(u){const h=this.lhs.evaluate(u),f=this.rhs.evaluate(u);if(o&&this.hasUntypedArgument){const _=_n(h),g=_n(f);if(_.kind!==g.kind||_.kind!=="string"&&_.kind!=="number")throw new qr('Expected arguments for "'.concat(r,'" to be (string, string) or (number, number), but found (').concat(_.kind,", ").concat(g.kind,") instead."))}if(this.collator&&!o&&this.hasUntypedArgument){const _=_n(h),g=_n(f);if(_.kind!=="string"||g.kind!=="string")return e(u,h,f)}return this.collator?i(u,h,f,this.collator.evaluate(u)):e(u,h,f)}eachChild(u){u(this.lhs),u(this.rhs),this.collator&&u(this.collator)}outputDefined(){return!0}serialize(){const u=[r];return this.eachChild((h=>{u.push(h.serialize())})),u}}}const Nf=il("==",(function(r,e,i){return e===i}),Bf),Vf=il("!=",(function(r,e,i){return e!==i}),(function(r,e,i,o){return!Bf(0,e,i,o)})),Om=il("<",(function(r,e,i){return e<i}),(function(r,e,i,o){return o.compare(e,i)<0})),Fm=il(">",(function(r,e,i){return e>i}),(function(r,e,i,o){return o.compare(e,i)>0})),km=il("<=",(function(r,e,i){return e<=i}),(function(r,e,i,o){return o.compare(e,i)<=0})),ru=il(">=",(function(r,e,i){return e>=i}),(function(r,e,i,o){return o.compare(e,i)>=0}));class Fh{constructor(e,i,o,a,u,h){this.type=Ei,this.number=e,this.locale=i,this.currency=o,this.unit=a,this.minFractionDigits=u,this.maxFractionDigits=h}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");const o=i.parse(e[1],1,St);if(!o)return null;const a=e[2];if(typeof a!="object"||Array.isArray(a))return i.error("NumberFormat options argument must be an object.");let u=null;if(a.locale&&(u=i.parseObjectValue(a.locale,2,"locale",Ei),!u))return null;let h=null;if(a.currency&&(h=i.parseObjectValue(a.currency,2,"currency",Ei),!h))return null;let f=null;if(a.unit&&(f=i.parseObjectValue(a.unit,2,"unit",Ei),!f))return null;let _=null;if(a["min-fraction-digits"]&&(_=i.parseObjectValue(a["min-fraction-digits"],2,"min-fraction-digits",St),!_))return null;let g=null;return a["max-fraction-digits"]&&(g=i.parseObjectValue(a["max-fraction-digits"],2,"max-fraction-digits",St),!g)?null:new Fh(o,u,h,f,_,g)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class kh{constructor(e){this.type=St,this.input=e}static parse(e,i){if(e.length!==2)return i.error("Expected 1 argument, but found ".concat(e.length-1," instead."));const o=i.parse(e[1],1);return o?o.type.kind!=="array"&&o.type.kind!=="string"&&o.type.kind!=="value"?i.error("Expected argument of type string or array, but found ".concat(an(o.type)," instead.")):new kh(o):null}evaluate(e){const i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new qr("Expected value to be of type string or array, but found ".concat(an(_n(i))," instead."))}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild((i=>{e.push(i.serialize())})),e}}function Uf(r){return function(){r=1831565813+(r|=0)|0;let e=Math.imul(r^r>>>15,1|r);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const rl={"==":Nf,"!=":Vf,">":Fm,"<":Om,">=":ru,"<=":km,array:xt,at:zh,"at-interpolated":Lh,boolean:xt,case:tl,coalesce:oc,collator:qa,format:va,image:Gt,in:Oh,"index-of":ac,interpolate:Lo,"interpolate-hcl":Lo,"interpolate-lab":Lo,length:kh,let:sc,literal:Os,match:eu,number:xt,"number-format":Fh,object:xt,slice:tu,step:rc,string:xt,"to-boolean":Ts,"to-color":Ts,"to-number":Ts,"to-string":Ts,var:Zc,within:wa,distance:Ta,config:Qa,split:iu};function Bh(r,[e,i,o,a]){e=e.evaluate(r),i=i.evaluate(r),o=o.evaluate(r);const u=a?a.evaluate(r):1,h=Oc(e,i,o,u);if(h)throw new qr(h);return new Ui(e/255,i/255,o/255,u)}function jf(r,[e,i,o,a]){e=e.evaluate(r),i=i.evaluate(r),o=o.evaluate(r);const u=a?a.evaluate(r):1,h=(function(g,v,b,w){return typeof g=="number"&&g>=0&&g<=360?typeof v=="number"&&v>=0&&v<=100&&typeof b=="number"&&b>=0&&b<=100?w===void 0||typeof w=="number"&&w>=0&&w<=1?null:"Invalid hsla value [".concat([g,v,b,w].join(", "),"]: 'a' must be between 0 and 1."):"Invalid hsla value [".concat((typeof w=="number"?[g,v,b,w]:[g,v,b]).join(", "),"]: 's', and 'l' must be between 0 and 100."):"Invalid hsla value [".concat((typeof w=="number"?[g,v,b,w]:[g,v,b]).join(", "),"]: 'h' must be between 0 and 360.")})(e,i,o,u);if(h)throw new qr(h);const f="hsla(".concat(e,", ").concat(i,"%, ").concat(o,"%, ").concat(u,")"),_=Ui.parse(f);if(!_)throw new qr("Failed to parse HSLA color: ".concat(f));return _}function Gf(r,e){return r in e}function nu(r,e){const i=e[r];return i===void 0?null:i}function ks(r){return{type:r}}function lc(r){if(r instanceof Qa)return new Set([r.key]);let e=new Set;return r.eachChild((i=>{e=new Set([...e,...lc(i)])})),e}function ou(r){if(r instanceof Yn&&r.name==="is-active-floor")return!0;let e=!1;return r.eachChild((i=>{!e&&ou(i)&&(e=!0)})),e}function Ia(r){return{result:"success",value:r}}function ea(r){return{result:"error",value:r}}function Nh(r,e){return!!r&&!!r.parameters&&r.parameters.indexOf(e)>-1}function su(r){return r["property-type"]==="data-driven"}function Vh(r){return Nh(r.expression,"measure-light")}function Uh(r){return Nh(r.expression,"zoom")}function au(r){return!!r.expression&&r.expression.interpolated}function lu(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function jh(r){return r}function cu(r,e){const i=e.type==="color",o=r.stops&&typeof r.stops[0][0]=="object",a=o||!(o||r.property!==void 0),u=r.type||(au(e)?"exponential":"interval");if(i&&((r=Object.assign({},r)).stops&&(r.stops=r.stops.map((g=>[g[0],Ui.parse(g[1])]))),r.default=Ui.parse(r.default?r.default:e.default)),r.colorSpace&&r.colorSpace!=="rgb"&&!Qc[r.colorSpace])throw new Error("Unknown color space: ".concat(r.colorSpace));let h,f,_;if(u==="exponential")h=Hf;else if(u==="interval")h=ta;else if(u==="categorical"){h=Bm,f=Object.create(null);for(const g of r.stops)f[g[0]]=g[1];_=typeof r.stops[0][0]}else{if(u!=="identity")throw new Error('Unknown function type "'.concat(u,'"'));h=Nm}if(o){const g={},v=[];for(let I=0;I<r.stops.length;I++){const A=r.stops[I],P=A[0].zoom;g[P]===void 0&&(g[P]={zoom:P,type:r.type,property:r.property,default:r.default,stops:[]},v.push(P)),g[P].stops.push([A[0].value,A[1]])}const b=[];for(const I of v)b.push([g[I].zoom,cu(g[I],e)]);const w={name:"linear"};return{kind:"composite",interpolationType:w,interpolationFactor:Lo.interpolationFactor.bind(void 0,w),zoomStops:b.map((I=>I[0])),evaluate:({zoom:I},A)=>Hf({stops:b,base:r.base},e,I).evaluate(I,A)}}if(a){const g=u==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:g,interpolationFactor:Lo.interpolationFactor.bind(void 0,g),zoomStops:r.stops.map((v=>v[0])),evaluate:({zoom:v})=>h(r,e,v,f,_)}}return{kind:"source",evaluate(g,v){const b=v&&v.properties?v.properties[r.property]:void 0;return b===void 0?nl(r.default,e.default):h(r,e,b,f,_)}}}function nl(r,e,i){return r!==void 0?r:e!==void 0?e:i!==void 0?i:void 0}function Bm(r,e,i,o,a){return nl(typeof i===a?o[i]:void 0,r.default,e.default)}function ta(r,e,i){if(!Yl(i))return nl(r.default,e.default);const o=r.stops.length;if(o===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[o-1][0])return r.stops[o-1][1];const a=Xc(r.stops.map((u=>u[0])),i);return r.stops[a][1]}function Hf(r,e,i){const o=r.base!==void 0?r.base:1;if(!Yl(i))return nl(r.default,e.default);const a=r.stops.length;if(a===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[a-1][0])return r.stops[a-1][1];const u=Xc(r.stops.map((v=>v[0])),i),h=(function(v,b,w,I){const A=I-w,P=v-w;return A===0?0:b===1?P/A:(Math.pow(b,P)-1)/(Math.pow(b,A)-1)})(i,o,r.stops[u][0],r.stops[u+1][0]),f=r.stops[u][1],_=r.stops[u+1][1];let g=zs[e.type]||jh;if(r.colorSpace&&r.colorSpace!=="rgb"){const v=Qc[r.colorSpace];g=(b,w)=>v.reverse(v.interpolate(v.forward(b),v.forward(w),h))}return typeof f.evaluate=="function"?{evaluate(...v){const b=f.evaluate.apply(void 0,v),w=_.evaluate.apply(void 0,v);if(b!==void 0&&w!==void 0)return g(b,w,h)}}:g(f,_,h)}function Nm(r,e,i){return e.type==="color"?i=Ui.parse(i):e.type==="formatted"?i=bn.fromString(i.toString()):e.type==="resolvedImage"?i=po.build(i.toString()):Ha(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),nl(i,r.default,e.default)}Yn.register(rl,{error:[{kind:"error"},[Ei],(r,[e])=>{throw new qr(e.evaluate(r))}],typeof:[Ei,[Hi],(r,[e])=>an(_n(e.evaluate(r)))],"to-rgba":[Pn(St,4),[So],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[Pn(St,4),[So],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[So,[St,St,St],Bh],rgba:[So,[St,St,St,St],Bh],hsl:[So,[St,St,St],jf],hsla:[So,[St,St,St,St],jf],has:{type:Bi,overloads:[[[Ei],(r,[e])=>Gf(e.evaluate(r),r.properties())],[[Ei,ja],(r,[e,i])=>Gf(e.evaluate(r),i.evaluate(r))]]},get:{type:Hi,overloads:[[[Ei],(r,[e])=>nu(e.evaluate(r),r.properties())],[[Ei,ja],(r,[e,i])=>nu(e.evaluate(r),i.evaluate(r))]]},"feature-state":[Hi,[Ei],(r,[e])=>nu(e.evaluate(r),r.featureState||{})],properties:[ja,[],r=>r.properties()],"geometry-type":[Ei,[],r=>r.geometryType()],worldview:[Ei,[],r=>r.globals.worldview||""],"is-active-floor":[Bi,ks(Ei),(r,e)=>{if(!(r.globals.activeFloors&&r.globals.activeFloors.size>0))return!1;const i=r.globals.activeFloors;return e.some((o=>{const a=o.evaluate(r);return i.has(a)}))}],id:[Hi,[],r=>r.id()],zoom:[St,[],r=>r.globals.zoom],pitch:[St,[],r=>r.globals.pitch||0],"distance-from-center":[St,[],r=>r.distanceFromCenter()],"measure-light":[St,[Ei],(r,[e])=>r.measureLight(e.evaluate(r))],"heatmap-density":[St,[],r=>r.globals.heatmapDensity||0],"line-progress":[St,[],r=>r.globals.lineProgress||0],"raster-value":[St,[],r=>r.globals.rasterValue||0],"raster-particle-speed":[St,[],r=>r.globals.rasterParticleSpeed||0],"sky-radial-progress":[St,[],r=>r.globals.skyRadialProgress||0],accumulated:[Hi,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[St,ks(St),(r,e)=>{let i=0;for(const o of e)i+=o.evaluate(r);return i}],"*":[St,ks(St),(r,e)=>{let i=1;for(const o of e)i*=o.evaluate(r);return i}],"-":{type:St,overloads:[[[St,St],(r,[e,i])=>e.evaluate(r)-i.evaluate(r)],[[St],(r,[e])=>-e.evaluate(r)]]},"/":[St,[St,St],(r,[e,i])=>e.evaluate(r)/i.evaluate(r)],"%":[St,[St,St],(r,[e,i])=>e.evaluate(r)%i.evaluate(r)],ln2:[St,[],()=>Math.LN2],pi:[St,[],()=>Math.PI],e:[St,[],()=>Math.E],"^":[St,[St,St],(r,[e,i])=>Math.pow(e.evaluate(r),i.evaluate(r))],sqrt:[St,[St],(r,[e])=>Math.sqrt(e.evaluate(r))],log10:[St,[St],(r,[e])=>Math.log(e.evaluate(r))/Math.LN10],ln:[St,[St],(r,[e])=>Math.log(e.evaluate(r))],log2:[St,[St],(r,[e])=>Math.log2(e.evaluate(r))],sin:[St,[St],(r,[e])=>Math.sin(e.evaluate(r))],cos:[St,[St],(r,[e])=>Math.cos(e.evaluate(r))],tan:[St,[St],(r,[e])=>Math.tan(e.evaluate(r))],asin:[St,[St],(r,[e])=>Math.asin(e.evaluate(r))],acos:[St,[St],(r,[e])=>Math.acos(e.evaluate(r))],atan:[St,[St],(r,[e])=>Math.atan(e.evaluate(r))],min:[St,ks(St),(r,e)=>Math.min(...e.map((i=>i.evaluate(r))))],max:[St,ks(St),(r,e)=>Math.max(...e.map((i=>i.evaluate(r))))],abs:[St,[St],(r,[e])=>Math.abs(e.evaluate(r))],round:[St,[St],(r,[e])=>{const i=e.evaluate(r);return i<0?-Math.round(-i):Math.round(i)}],floor:[St,[St],(r,[e])=>Math.floor(e.evaluate(r))],ceil:[St,[St],(r,[e])=>Math.ceil(e.evaluate(r))],"filter-==":[Bi,[Ei,Hi],(r,[e,i])=>r.properties()[e.value]===i.value],"filter-id-==":[Bi,[Hi],(r,[e])=>r.id()===e.value],"filter-type-==":[Bi,[Ei],(r,[e])=>r.geometryType()===e.value],"filter-<":[Bi,[Ei,Hi],(r,[e,i])=>{const o=r.properties()[e.value],a=i.value;return typeof o==typeof a&&o<a}],"filter-id-<":[Bi,[Hi],(r,[e])=>{const i=r.id(),o=e.value;return typeof i==typeof o&&i<o}],"filter->":[Bi,[Ei,Hi],(r,[e,i])=>{const o=r.properties()[e.value],a=i.value;return typeof o==typeof a&&o>a}],"filter-id->":[Bi,[Hi],(r,[e])=>{const i=r.id(),o=e.value;return typeof i==typeof o&&i>o}],"filter-<=":[Bi,[Ei,Hi],(r,[e,i])=>{const o=r.properties()[e.value],a=i.value;return typeof o==typeof a&&o<=a}],"filter-id-<=":[Bi,[Hi],(r,[e])=>{const i=r.id(),o=e.value;return typeof i==typeof o&&i<=o}],"filter->=":[Bi,[Ei,Hi],(r,[e,i])=>{const o=r.properties()[e.value],a=i.value;return typeof o==typeof a&&o>=a}],"filter-id->=":[Bi,[Hi],(r,[e])=>{const i=r.id(),o=e.value;return typeof i==typeof o&&i>=o}],"filter-has":[Bi,[Hi],(r,[e])=>e.value in r.properties()],"filter-has-id":[Bi,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[Bi,[Pn(Ei)],(r,[e])=>e.value.indexOf(r.geometryType())>=0],"filter-id-in":[Bi,[Pn(Hi)],(r,[e])=>e.value.indexOf(r.id())>=0],"filter-in-small":[Bi,[Ei,Pn(Hi)],(r,[e,i])=>i.value.indexOf(r.properties()[e.value])>=0],"filter-in-large":[Bi,[Ei,Pn(Hi)],(r,[e,i])=>(function(o,a,u,h){for(;u<=h;){const f=u+h>>1;if(a[f]===o)return!0;a[f]>o?h=f-1:u=f+1}return!1})(r.properties()[e.value],i.value,0,i.value.length-1)],all:{type:Bi,overloads:[[[Bi,Bi],(r,[e,i])=>e.evaluate(r)&&i.evaluate(r)],[ks(Bi),(r,e)=>{for(const i of e)if(!i.evaluate(r))return!1;return!0}]]},any:{type:Bi,overloads:[[[Bi,Bi],(r,[e,i])=>e.evaluate(r)||i.evaluate(r)],[ks(Bi),(r,e)=>{for(const i of e)if(i.evaluate(r))return!0;return!1}]]},"!":[Bi,[Bi],(r,[e])=>!e.evaluate(r)],"is-supported-script":[Bi,[Ei],(r,[e])=>{const i=r.globals&&r.globals.isSupportedScript;return!i||i(e.evaluate(r))}],upcase:[Ei,[Ei],(r,[e])=>e.evaluate(r).toUpperCase()],downcase:[Ei,[Ei],(r,[e])=>e.evaluate(r).toLowerCase()],concat:[Ei,ks(Hi),(r,e)=>e.map((i=>ws(i.evaluate(r)))).join("")],"resolved-locale":[Ei,[ql],(r,[e])=>e.evaluate(r).resolvedLocale()],random:[St,[St,St,Hi],(r,e)=>{const[i,o,a]=e.map((h=>h.evaluate(r)));if(i>o||i===o)return i;let u;if(typeof a=="string")u=(function(h){let f=0;if(h.length===0)return f;for(let _=0;_<h.length;_++)f=(f<<5)-f+h.charCodeAt(_),f|=0;return f})(a);else{if(typeof a!="number")throw new qr("Invalid seed input: ".concat(a));u=a}return i+Uf(u)()*(o-i)}]});class uu{constructor(e,i,o,a,u){this.expression=e,this._warningHistory={},this._scope=o,this._options=a,this._iconImageUseTheme=u,this._evaluator=new Rn(o,a,u),this._defaultValue=i?(function(h){return h.type==="color"&&(lu(h.default)||Array.isArray(h.default))?new Ui(0,0,0,0):h.type==="color"?Ui.parse(h.default)||null:h.default===void 0?null:h.default})(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=lc(e),this.isIndoorDependent=ou(e)}evaluateWithoutErrorHandling(e,i,o,a,u,h,f,_){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=o,this._evaluator.canonical=a||null,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=h,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=_||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,o,a,u,h,f,_,g){this._evaluator||(this._evaluator=new Rn(this._scope,this._options,this._iconImageUseTheme)),this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=o||null,this._evaluator.canonical=a||null,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=h||null,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=_||null,this._evaluator.iconImageUseTheme=g||null;try{const v=this.expression.evaluate(this._evaluator);if(v==null||typeof v=="number"&&v!=v)return this._defaultValue;if(this._enumValues&&!(v in this._enumValues))throw new qr("Expected value to be one of ".concat(Object.keys(this._enumValues).map((b=>JSON.stringify(b))).join(", "),", but found ").concat(JSON.stringify(v)," instead."));return v}catch(v){return this._warningHistory[v.message]||(this._warningHistory[v.message]=!0,typeof console<"u"&&console.warn('Failed to evaluate expression "'.concat(JSON.stringify(this.expression.serialize()),'". ').concat(v.message))),this._defaultValue}}}function hu(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in rl}function Es(r,e,i,o,a){const u=new Wc(rl,[],e?(function(f){const _={color:So,string:Ei,number:St,enum:Ei,boolean:Bi,formatted:xa,resolvedImage:$l};return f.type==="array"?Pn(_[f.value]||Hi,f.length):_[f.type]})(e):void 0,void 0,void 0,i,o,a),h=u.parse(r,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return h?Ia(new uu(h,e,i,o,a)):ea(u.errors)}class cc{constructor(e,i,o,a){this.kind=e,this._styleExpression=i,this.isLightConstant=o,this.isLineProgressConstant=a,this.isStateDependent=e!=="constant"&&!ic(i.expression),this.configDependencies=lc(i.expression),this.isIndoorDependent=ou(i.expression)}evaluateWithoutErrorHandling(e,i,o,a,u,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,o,a,u,h)}evaluate(e,i,o,a,u,h,f){return this._styleExpression.evaluate(e,i,o,a,u,h,void 0,void 0,f)}}class ia{constructor(e,i,o,a,u,h){this.kind=e,this.zoomStops=o,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!ic(i.expression),this.isIndoorDependent=ou(i.expression),this.isLightConstant=u,this.isLineProgressConstant=h,this.configDependencies=lc(i.expression),this.interpolationType=a}evaluateWithoutErrorHandling(e,i,o,a,u,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,o,a,u,h)}evaluate(e,i,o,a,u,h){return this._styleExpression.evaluate(e,i,o,a,u,h)}interpolationFactor(e,i,o){return this.interpolationType?Lo.interpolationFactor(this.interpolationType,e,i,o):0}}function Gh(r,e,i,o,a){if((r=Es(r,e,i,o,a)).result==="error")return r;const u=r.value.expression,h=Ka(u);if(!h&&!su(e))return ea([new es("","data expressions not supported")]);const f=Ja(u,["zoom","pitch","distance-from-center"]);if(!f&&!Uh(e))return ea([new es("","zoom expressions not supported")]);const _=Ja(u,["measure-light"]);if(!_&&!Vh(e))return ea([new es("","measure-light expression not supported")]);const g=Ja(u,["line-progress"]);if(!g&&!(function(w){return Nh(w.expression,"line-progress")})(e))return ea([new es("","line-progress expression not supported")]);const v=e.expression&&e.expression.relaxZoomRestriction,b=fu(u);return b||f||v?b instanceof es?ea([b]):b instanceof Lo&&!au(e)?ea([new es("",'"interpolate" expressions cannot be used with this property')]):Ia(b?new ia(h&&g?"camera":"composite",r.value,b.labels,b instanceof Lo?b.interpolation:void 0,_,g):new cc(h&&g?"constant":"source",r.value,_,g)):ea([new es("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class du{constructor(e,i){this._parameters=e,this._specification=i,Object.assign(this,cu(this._parameters,this._specification))}static deserialize(e){return new du(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function fu(r){let e=null;if(r instanceof sc)e=fu(r.result);else if(r instanceof oc){for(const i of r.args)if(e=fu(i),e)break}else(r instanceof rc||r instanceof Lo)&&r.input instanceof Yn&&r.input.name==="zoom"&&(e=r);return e instanceof es||r.eachChild((i=>{const o=fu(i);o instanceof es?e=o:e&&o&&e!==o&&(e=new es("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),e}var uc,pu,qf=(function(){if(pu)return uc;pu=1,uc=e;var r=3;function e(i,o,a){var u=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var h=new Int32Array(this.arrayBuffer);i=h[0],this.d=(o=h[1])+2*(a=h[2]);for(var f=0;f<this.d*this.d;f++){var _=h[r+f],g=h[r+f+1];u.push(_===g?null:h.subarray(_,g))}var v=h[r+u.length+1];this.keys=h.subarray(h[r+u.length],v),this.bboxes=h.subarray(v),this.insert=this._insertReadonly}else{this.d=o+2*a;for(var b=0;b<this.d*this.d;b++)u.push([]);this.keys=[],this.bboxes=[]}this.n=o,this.extent=i,this.padding=a,this.scale=o/i,this.uid=0;var w=a/o*i;this.min=-w,this.max=i+w}return e.prototype.insert=function(i,o,a,u,h){this._forEachCell(o,a,u,h,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(o),this.bboxes.push(a),this.bboxes.push(u),this.bboxes.push(h)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,o,a,u,h,f){this.cells[h].push(f)},e.prototype.query=function(i,o,a,u,h){var f=this.min,_=this.max;if(i<=f&&o<=f&&_<=a&&_<=u&&!h)return Array.prototype.slice.call(this.keys);var g=[];return this._forEachCell(i,o,a,u,this._queryCell,g,{},h),g},e.prototype._queryCell=function(i,o,a,u,h,f,_,g){var v=this.cells[h];if(v!==null)for(var b=this.keys,w=this.bboxes,I=0;I<v.length;I++){var A=v[I];if(_[A]===void 0){var P=4*A;(g?g(w[P+0],w[P+1],w[P+2],w[P+3]):i<=w[P+2]&&o<=w[P+3]&&a>=w[P+0]&&u>=w[P+1])?(_[A]=!0,f.push(b[A])):_[A]=!1}}},e.prototype._forEachCell=function(i,o,a,u,h,f,_,g){for(var v=this._convertToCellCoord(i),b=this._convertToCellCoord(o),w=this._convertToCellCoord(a),I=this._convertToCellCoord(u),A=v;A<=w;A++)for(var P=b;P<=I;P++){var D=this.d*P+A;if((!g||g(this._convertFromCellCoord(A),this._convertFromCellCoord(P),this._convertFromCellCoord(A+1),this._convertFromCellCoord(P+1)))&&h.call(this,i,o,a,u,D,f,_,g))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,o=r+this.cells.length+1+1,a=0,u=0;u<this.cells.length;u++)a+=this.cells[u].length;var h=new Int32Array(o+a+this.keys.length+this.bboxes.length);h[0]=this.extent,h[1]=this.n,h[2]=this.padding;for(var f=o,_=0;_<i.length;_++){var g=i[_];h[r+_]=f,h.set(g,f),f+=g.length}return h[r+i.length]=f,h.set(this.keys,f),h[r+i.length+1]=f+=this.keys.length,h.set(this.bboxes,f),f+=this.bboxes.length,h.buffer},uc})(),Aa=vo(qf);const ol={};function pt(r,e,i={}){Object.defineProperty(r,"_classRegistryKey",{value:e,writable:!1}),ol[e]={klass:r,omit:i.omit||[]}}pt(Object,"Object"),Aa.serialize=function(r,e){const i=r.toArrayBuffer();return e&&e.add(i),{buffer:i}},Aa.deserialize=function(r){return new Aa(r.buffer)},Object.defineProperty(Aa,"name",{value:"Grid"}),pt(Aa,"Grid"),delete Be.prototype.constructor,typeof DOMMatrix<"u"&&pt(DOMMatrix,"DOMMatrix"),pt(Ui,"Color"),pt(Error,"Error"),pt(bn,"Formatted"),pt(Xl,"FormattedSection"),pt(ga,"AJAXError"),pt(po,"ResolvedImage"),pt(du,"StylePropertyFunction"),pt(uu,"StyleExpression",{omit:["_evaluator"]}),pt(hn,"ImageId"),pt(Ls,"ImageVariant"),pt(ia,"ZoomDependentExpression"),pt(cc,"ZoomConstantExpression"),pt(Yn,"CompoundExpression",{omit:["_evaluate"]});for(const r in rl)ol[rl[r]._classRegistryKey]||pt(rl[r],"Expression".concat(r));function Hh(r){return r&&typeof ArrayBuffer<"u"&&(r instanceof ArrayBuffer||r.constructor&&r.constructor.name==="ArrayBuffer")}function Bs(r){return self.ImageBitmap&&r instanceof ImageBitmap}function ra(r,e){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp)return r;if(Hh(r)||Bs(r))return e&&e.add(r),r;if(ArrayBuffer.isView(r))return e&&e.add(r.buffer),r;if(r instanceof ImageData)return e&&e.add(r.data.buffer),r;if(Array.isArray(r)){const i=[];for(const o of r)i.push(ra(o,e));return i}if(r instanceof Map){const i={$name:"Map",entries:[]};for(const[o,a]of r.entries())i.entries.push(ra(o),ra(a,e));return i}if(r instanceof Set){const i={$name:"Set"};let o=0;for(const a of r.values())i[++o]=ra(a);return i}if(r instanceof DOMMatrix){const i={$name:"DOMMatrix"},o=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const a of o)i[a]=r[a];return i}if(typeof r=="bigint")return{$name:"BigInt",value:r.toString()};if(typeof r=="object"){const i=r.constructor,o=i._classRegistryKey;if(!o)throw new Error("Can't serialize object of unregistered class \"".concat(i.name,'".'));const a=i.serialize?i.serialize(r,e):{};if(!i.serialize){for(const u in r)r.hasOwnProperty(u)&&(ol[o].omit.indexOf(u)>=0||(a[u]=ra(r[u],e)));r instanceof Error&&(a.message=r.message)}if(a.$name)throw new Error("$name property is reserved for worker serialization logic.");return o!=="Object"&&(a.$name=o),a}throw new Error("can't serialize object of type "+typeof r)}function na(r){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||Hh(r)||Bs(r)||ArrayBuffer.isView(r)||r instanceof ImageData)return r;if(Array.isArray(r))return r.map(na);if(typeof r=="object"){const e=r.$name||"Object";if(e==="Map"){const a=r.entries||[],u=new Map;for(let h=0;h<a.length;h+=2)u.set(na(a[h]),na(a[h+1]));return u}if(e==="Set"){const a=new Set;for(const u of Object.keys(r))u!=="$name"&&a.add(na(r[u]));return a}if(e==="DOMMatrix"){let a;return a=r.is2D?[r.a,r.b,r.c,r.d,r.e,r.f]:[r.m11,r.m12,r.m13,r.m14,r.m21,r.m22,r.m23,r.m24,r.m31,r.m32,r.m33,r.m34,r.m41,r.m42,r.m43,r.m44],new DOMMatrix(a)}if(e==="BigInt")return BigInt(r.value);const{klass:i}=ol[e];if(!i)throw new Error("Can't deserialize unregistered class \"".concat(e,'".'));if(i.deserialize)return i.deserialize(r);const o=Object.create(i.prototype);for(const a of Object.keys(r))a!=="$name"&&(o[a]=na(r[a]));return o}throw new Error("can't deserialize object of type "+typeof r)}const Ct={"Latin-1 Supplement":r=>r>=128&&r<=255,Arabic:r=>r>=1536&&r<=1791,"Arabic Supplement":r=>r>=1872&&r<=1919,"Arabic Extended-A":r=>r>=2208&&r<=2303,"Hangul Jamo":r=>r>=4352&&r<=4607,"Unified Canadian Aboriginal Syllabics":r=>r>=5120&&r<=5759,Khmer:r=>r>=6016&&r<=6143,"Unified Canadian Aboriginal Syllabics Extended":r=>r>=6320&&r<=6399,"General Punctuation":r=>r>=8192&&r<=8303,"Letterlike Symbols":r=>r>=8448&&r<=8527,"Number Forms":r=>r>=8528&&r<=8591,"Miscellaneous Technical":r=>r>=8960&&r<=9215,"Control Pictures":r=>r>=9216&&r<=9279,"Optical Character Recognition":r=>r>=9280&&r<=9311,"Enclosed Alphanumerics":r=>r>=9312&&r<=9471,"Geometric Shapes":r=>r>=9632&&r<=9727,"Miscellaneous Symbols":r=>r>=9728&&r<=9983,"Miscellaneous Symbols and Arrows":r=>r>=11008&&r<=11263,"CJK Radicals Supplement":r=>r>=11904&&r<=12031,"Kangxi Radicals":r=>r>=12032&&r<=12255,"Ideographic Description Characters":r=>r>=12272&&r<=12287,"CJK Symbols and Punctuation":r=>r>=12288&&r<=12351,Hiragana:r=>r>=12352&&r<=12447,Katakana:r=>r>=12448&&r<=12543,Bopomofo:r=>r>=12544&&r<=12591,"Hangul Compatibility Jamo":r=>r>=12592&&r<=12687,Kanbun:r=>r>=12688&&r<=12703,"Bopomofo Extended":r=>r>=12704&&r<=12735,"CJK Strokes":r=>r>=12736&&r<=12783,"Katakana Phonetic Extensions":r=>r>=12784&&r<=12799,"Enclosed CJK Letters and Months":r=>r>=12800&&r<=13055,"CJK Compatibility":r=>r>=13056&&r<=13311,"CJK Unified Ideographs Extension A":r=>r>=13312&&r<=19903,"Yijing Hexagram Symbols":r=>r>=19904&&r<=19967,"CJK Unified Ideographs":r=>r>=19968&&r<=40959,"Yi Syllables":r=>r>=40960&&r<=42127,"Yi Radicals":r=>r>=42128&&r<=42191,"Hangul Jamo Extended-A":r=>r>=43360&&r<=43391,"Hangul Syllables":r=>r>=44032&&r<=55215,"Hangul Jamo Extended-B":r=>r>=55216&&r<=55295,"Private Use Area":r=>r>=57344&&r<=63743,"CJK Compatibility Ideographs":r=>r>=63744&&r<=64255,"Arabic Presentation Forms-A":r=>r>=64336&&r<=65023,"Vertical Forms":r=>r>=65040&&r<=65055,"CJK Compatibility Forms":r=>r>=65072&&r<=65103,"Small Form Variants":r=>r>=65104&&r<=65135,"Arabic Presentation Forms-B":r=>r>=65136&&r<=65279,"Halfwidth and Fullwidth Forms":r=>r>=65280&&r<=65519,Osage:r=>r>=66736&&r<=66815,"CJK Unified Ideographs Extension B":r=>r>=131072&&r<=173791};function qh(r){for(const e of r)if(_u(e.charCodeAt(0)))return!0;return!1}function $f(r){for(const e of r)if(!mu(e.charCodeAt(0)))return!1;return!0}function mu(r){return!(Ct.Arabic(r)||Ct["Arabic Supplement"](r)||Ct["Arabic Extended-A"](r)||Ct["Arabic Presentation Forms-A"](r)||Ct["Arabic Presentation Forms-B"](r))}function _u(r){return!(r!==746&&r!==747&&(r<4352||!(Ct["Bopomofo Extended"](r)||Ct.Bopomofo(r)||Ct["CJK Compatibility Forms"](r)&&!(r>=65097&&r<=65103)||Ct["CJK Compatibility Ideographs"](r)||Ct["CJK Compatibility"](r)||Ct["CJK Radicals Supplement"](r)||Ct["CJK Strokes"](r)||!(!Ct["CJK Symbols and Punctuation"](r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||Ct["CJK Unified Ideographs Extension A"](r)||Ct["CJK Unified Ideographs"](r)||Ct["Enclosed CJK Letters and Months"](r)||Ct["Hangul Compatibility Jamo"](r)||Ct["Hangul Jamo Extended-A"](r)||Ct["Hangul Jamo Extended-B"](r)||Ct["Hangul Jamo"](r)||Ct["Hangul Syllables"](r)||Ct.Hiragana(r)||Ct["Ideographic Description Characters"](r)||Ct.Kanbun(r)||Ct["Kangxi Radicals"](r)||Ct["Katakana Phonetic Extensions"](r)||Ct.Katakana(r)&&r!==12540||!(!Ct["Halfwidth and Fullwidth Forms"](r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!Ct["Small Form Variants"](r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||Ct["Unified Canadian Aboriginal Syllabics"](r)||Ct["Unified Canadian Aboriginal Syllabics Extended"](r)||Ct["Vertical Forms"](r)||Ct["Yijing Hexagram Symbols"](r)||Ct["Yi Syllables"](r)||Ct["Yi Radicals"](r))))}function $h(r){return!(_u(r)||(function(e){return!!(Ct["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Ct["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Ct["Letterlike Symbols"](e)||Ct["Number Forms"](e)||Ct["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Ct["Control Pictures"](e)&&e!==9251||Ct["Optical Character Recognition"](e)||Ct["Enclosed Alphanumerics"](e)||Ct["Geometric Shapes"](e)||Ct["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Ct["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Ct["CJK Symbols and Punctuation"](e)||Ct.Katakana(e)||Ct["Private Use Area"](e)||Ct["CJK Compatibility Forms"](e)||Ct["Small Form Variants"](e)||Ct["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)})(r))}function Zh(r){return Ct.Arabic(r)||Ct["Arabic Supplement"](r)||Ct["Arabic Extended-A"](r)||Ct["Arabic Presentation Forms-A"](r)||Ct["Arabic Presentation Forms-B"](r)}function Zf(r){return r>=1424&&r<=2303||Ct["Arabic Presentation Forms-A"](r)||Ct["Arabic Presentation Forms-B"](r)}function Vm(r,e){return!(!e&&Zf(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||Ct.Khmer(r))}function Um(r){for(const e of r)if(Zf(e.charCodeAt(0)))return!0;return!1}const Eo={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let Wh=null,no=Eo.unavailable,oa=null;const Wf=function(r){r&&typeof r=="string"&&r.indexOf("NetworkError")>-1&&(no=Eo.error),Wh&&Wh(r)};function Xh(){Yh.fire(new Do("pluginStateChange",{pluginStatus:no,pluginURL:oa}))}const Yh=new Ds,Kh=function(){return no},Jh=function(){if(no!==Eo.deferred||!oa)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");no=Eo.loading,Xh(),oa&&Na({url:oa},(r=>{r?Wf(r):(no=Eo.loaded,Xh())}))},Io={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>no===Eo.loaded||Io.applyArabicShaping!=null,isLoading:()=>no===Eo.loading,setState(r){no=r.pluginStatus,oa=r.pluginURL},isParsing:()=>no===Eo.parsing,isParsed:()=>no===Eo.parsed,getPluginURL:()=>oa};class lr{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness,this.worldview=i.worldview,this.activeFloors=i.activeFloors):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return(function(i,o){for(const a of i)if(!Vm(a.charCodeAt(0),o))return!1;return!0})(e,Io.isLoaded())}}class hc{constructor(e,i,o,a,u){this.property=e,this.value=i,this.expression=(function(h,f,_,g,v){if(lu(h))return new du(h,f);if(hu(h)||Array.isArray(h)&&h.length>0){const b=Gh(h,f,_,g,v);if(b.result==="error")throw new Error(b.value.map((w=>"".concat(w.key,": ").concat(w.message))).join(", "));return b.value}{let b=h;return typeof h=="string"&&f.type==="color"&&(b=Ui.parse(h)),{kind:"constant",configDependencies:new Set,isIndoorDependent:!1,evaluate:()=>b}}})(i===void 0?e.specification.default:i,e.specification,o,a,u)}isIndoorDependent(){return this.expression.isIndoorDependent}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,o,a){return this.property.possiblyEvaluate(this,e,i,o,a)}}class sl{constructor(e,i,o,a){this.property=e,this.value=new hc(e,void 0,i,o,a)}transitioned(e,i){return new Yf(this.property,this.value,i,Object.assign({},e.transition,this.transition),e.now)}untransitioned(){return new Yf(this.property,this.value,null,{},0)}}class Xf{constructor(e,i,o,a){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=o,this._iconImageUseTheme=a,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return bt(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new sl(this._values[e].property,this._scope,this._options,this._iconImageUseTheme)),this._values[e].value=new hc(this._values[e].property,i===null?void 0:bt(i),this._scope,this._options,this._iconImageUseTheme),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].value.isIndoorDependent())}setTransitionOrValue(e,i){i&&(this._options=i);const o=this._properties.properties;if(e)for(const a in e){const u=e[a];if(a.endsWith("-transition")){const h=a.slice(0,-11);o[h]&&this.setTransition(h,u)}else o.hasOwnProperty(a)&&this.setValue(a,u)}}getTransition(e){return bt(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new sl(this._values[e].property)),this._values[e].transition=bt(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const o=this.getValue(i);o!==void 0&&(e[i]=o);const a=this.getTransition(i);a!==void 0&&(e["".concat(i,"-transition")]=a)}return e}transitioned(e,i){const o=new Ns(this._properties);for(const a of Object.keys(this._values))o._values[a]=this._values[a].transitioned(e,i._values[a]);return o}untransitioned(){const e=new Ns(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}isIndoorDependent(){return this._isIndoorDependent}}class Yf{constructor(e,i,o,a,u){const h=a.delay||0,f=a.duration||0;u=u||0,this.property=e,this.value=i,this.begin=u+h,this.end=this.begin+f,e.specification.transition&&(a.delay||a.duration)&&(this.prior=o)}possiblyEvaluate(e,i,o){const a=e.now||0,u=this.value.possiblyEvaluate(e,i,o),h=this.prior;if(h){if(a>this.end)return this.prior=null,u;if(this.value.isDataDriven())return this.prior=null,u;if(a<this.begin)return h.possiblyEvaluate(e,i,o);{const f=(a-this.begin)/(this.end-this.begin);return this.property.interpolate(h.possiblyEvaluate(e,i,o),u,ds(f))}}return u}}class Ns{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,o){const a=new Ma(this._properties);for(const u of Object.keys(this._values))a._values[u]=this._values[u].possiblyEvaluate(e,i,o);return a}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Qh{constructor(e,i,o,a){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=o,this._iconImageUseTheme=a,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return bt(this._values[e].value)}setValue(e,i){this._values[e]=new hc(this._values[e].property,i===null?void 0:bt(i),this._scope,this._options,this._iconImageUseTheme),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].isIndoorDependent())}serialize(){const e={};for(const i of Object.keys(this._values)){const o=this.getValue(i);o!==void 0&&(e[i]=o)}return e}possiblyEvaluate(e,i,o,a){const u=new Ma(this._properties);for(const h of Object.keys(this._values))u._values[h]=this._values[h].possiblyEvaluate(e,i,o,a);return u}isIndoorDependent(){return this._isIndoorDependent}}class os{constructor(e,i,o,a){this.property=e,this.value=i,this.parameters=o,this.iconImageUseTheme=a}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,o,a){return this.property.evaluate(this.value,this.parameters,e,i,o,a,this.iconImageUseTheme)}}class Ma{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class qe{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,o){const a=zs[this.specification.type];return a?a(e,i,o):e}}class lt{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,o,a,u){return e.expression.kind==="constant"||e.expression.kind==="camera"?new os(this,{kind:"constant",value:e.expression.evaluate(i,null,{},o,a,void 0,u)},i):new os(this,e.expression,i,u)}interpolate(e,i,o){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new os(this,{kind:"constant",value:void 0},e.parameters);const a=zs[this.specification.type];return a?new os(this,{kind:"constant",value:a(e.value.value,i.value.value,o)},e.parameters):e}evaluate(e,i,o,a,u,h,f){return e.kind==="constant"?e.value:e.evaluate(i,o,a,u,h,void 0,f)}}class al{constructor(e){this.specification=e}possiblyEvaluate(e,i,o,a){return!!e.expression.evaluate(i,null,{},o,a)}interpolate(){return!1}}class kr{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new lr(0,{});for(const o in e){const a=e[o];a.specification.overridable&&this.overridableProperties.push(o);const u=this.defaultPropertyValues[o]=new hc(a,void 0),h=this.defaultTransitionablePropertyValues[o]=new sl(a);this.defaultTransitioningPropertyValues[o]=h.untransitioned(),this.defaultPossiblyEvaluatedValues[o]=u.possiblyEvaluate(i)}}}pt(lt,"DataDrivenProperty"),pt(qe,"DataConstantProperty"),pt(al,"ColorRampProperty");var ge=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"modelNodeOverride":{"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360}},"modelNodeOverrides":{"*":{"type":"modelNodeOverride"}},"modelMaterialOverride":{"model-color":{"type":"color"},"model-color-mix-intensity":{"type":"number"},"model-opacity":{"type":"number"},"model-emissive-strength":{"type":"number"}},"modelMaterialOverrides":{"*":{"type":"modelMaterialOverride"}},"modelSourceModel":{"uri":{"type":"string"},"position":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[-180,-90],"maximum":[180,90]},"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360},"nodeOverrides":{"type":"modelNodeOverrides"},"materialOverrides":{"type":"modelMaterialOverrides"},"nodeOverrideNames":{"type":"array","value":"string"},"materialOverrideNames":{"type":"array","value":"string"},"featureProperties":{"type":"*"}},"modelSourceModels":{"*":{"type":"modelSourceModel"}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"},"models":{"type":"modelSourceModels"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"boolean","expression":{"parameters":["zoom","pitch","feature","feature-state","measure-light","distance-from-center"]},"property-type":"data-driven"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-unit-width":{"type":"number","minimum":1,"maximum":20,"default":3.1,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flip-roof-orientation":{"property-type":"data-driven","type":"boolean","default":false,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"use-theme":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor_source":{"sourceId":{"type":"string"},"sourceLayers":{"type":"array","value":"string"}},"indoor":{"*":{"type":"indoor_source"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"building-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]},"model-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{}}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function ed(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function ll(r){if(Array.isArray(r))return r.map(ll);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){const e={};for(const i in r)e[i]=ll(r[i]);return e}return ed(r)}function cl(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(const e of r.slice(1))if(!cl(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function gu(r,e="",i=null,o="fill"){if(r==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};cl(r)||(r=Oo(r));const a=r;let u=!0;try{u=(function(v){if(!hl(v))return v;let b=ll(v);return ul(b),b=yu(b),b})(a)}catch(v){console.warn("Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n".concat(JSON.stringify(a,null,2),"\n        "))}let h=null,f=null;if(o!=="background"&&o!=="sky"&&o!=="slot"){f=ge["filter_".concat(o)];const v=Es(u,f,e,i);if(v.result==="error")throw new Error(v.value.map((b=>"".concat(b.key,": ").concat(b.message))).join(", "));h=(b,w,I)=>v.value.evaluate(b,w,{},I)}let _=null,g=null;if(u!==a){const v=Es(a,f,e,i);if(v.result==="error")throw new Error(v.value.map((b=>"".concat(b.key,": ").concat(b.message))).join(", "));_=(b,w,I,A,P)=>v.value.evaluate(b,w,{},I,void 0,void 0,A,P),g=!Ka(v.value.expression)}return{filter:h,dynamicFilter:_||void 0,needGeometry:Jf(u),needFeature:!!g}}function yu(r){if(!Array.isArray(r))return r;const e=(function(i){if(jm.has(i[0])){for(let o=1;o<i.length;o++)if(hl(i[o]))return!0}return i})(r);return e===!0?e:e.map((i=>yu(i)))}function ul(r){let e=!1;const i=[];if(r[0]==="case"){for(let o=1;o<r.length-1;o+=2)e=e||hl(r[o]),i.push(r[o+1]);i.push(r[r.length-1])}else if(r[0]==="match"){e=e||hl(r[1]);for(let o=2;o<r.length-1;o+=2)i.push(r[o+1]);i.push(r[r.length-1])}else if(r[0]==="step"){e=e||hl(r[1]);for(let o=1;o<r.length-1;o+=2)i.push(r[o+1])}e&&(r.length=0,r.push("any",...i));for(let o=1;o<r.length;o++)ul(r[o])}function hl(r){if(!Array.isArray(r))return!1;if((e=r[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<r.length;i++)if(hl(r[i]))return!0;return!1}const jm=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Kf(r,e){return r<e?-1:r>e?1:0}function Jf(r){if(!Array.isArray(r))return!1;if(r[0]==="within"||r[0]==="distance")return!0;for(let e=1;e<r.length;e++)if(Jf(r[e]))return!0;return!1}function Oo(r){if(!r)return!0;const e=r[0];return r.length<=1?e!=="any":e==="=="?td(r[1],r[2],"=="):e==="!="?xu(td(r[1],r[2],"==")):e==="<"||e===">"||e==="<="||e===">="?td(r[1],r[2],e):e==="any"?(i=r.slice(1),["any"].concat(i.map(Oo))):e==="all"?["all"].concat(r.slice(1).map(Oo)):e==="none"?["all"].concat(r.slice(1).map(Oo).map(xu)):e==="in"?id(r[1],r.slice(2)):e==="!in"?xu(id(r[1],r.slice(2))):e==="has"?Qf(r[1]):e!=="!has"||xu(Qf(r[1]));var i}function td(r,e,i){switch(r){case"$type":return["filter-type-".concat(i),e];case"$id":return["filter-id-".concat(i),e];default:return["filter-".concat(i),r,e]}}function id(r,e){if(e.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some((i=>typeof i!=typeof e[0]))?["filter-in-large",r,["literal",e.sort(Kf)]]:["filter-in-small",r,["literal",e]]}}function Qf(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function xu(r){return["!",r]}const dc="";function Ca(r,e){return e?"".concat(r).concat(dc).concat(e):r}let ep;const tp=()=>ep||(ep=new kr({"icon-size":new lt(ge.layout_symbol["icon-size"]),"icon-image":new lt(ge.layout_symbol["icon-image"]),"icon-rotate":new lt(ge.layout_symbol["icon-rotate"]),"icon-offset":new lt(ge.layout_symbol["icon-offset"])}));class Gm{constructor(e,i,o,a,u,h){this.cachedIconPrimary=null;const f=Es(e,ge.appearance.condition);if(f.result==="success"&&(this.condition=f.value),this.name=i,o){this.properties=new Ma(tp()),this.unevaluatedLayout=new Qh(tp(),a,u,h);for(const _ in o)this.unevaluatedLayout.setValue(_,o[_])}}hasCachedIconPrimary(){return this.cachedIconPrimary!==null}setCachedIconPrimary(e){this.cachedIconPrimary=e}getCachedIconPrimary(){return this.cachedIconPrimary}isActive(e){return!(this.condition||!e.isHidden||this.name!=="hidden")||this.condition.evaluate(e.globals,e.feature,e.featureState,e.canonical)}getCondition(){return this.condition}getName(){return this.name}getProperty(e){return this.properties.get(e)}getUnevaluatedProperties(){return this.unevaluatedLayout}recalculate(e,i,o){this.unevaluatedLayout&&(this.properties=this.unevaluatedLayout.possiblyEvaluate(e,void 0,i,o))}serialize(){const e={};return e.condition=this.condition.expression.serialize(),this.name&&(e.name=this.name),this.unevaluatedLayout&&(e.properties=this.unevaluatedLayout.serialize()),e}}const ip="-transition",Hm=new Set(["fill","line","background","hillshade","raster"]);class Kn extends Ds{constructor(e,i,o,a,u,h){if(super(),this.id=e.id,this.fqid=Ca(this.id,o),this.type=e.type,this.scope=o,this.lut=a,this.options=u,this.iconImageUseTheme=h,this.appearances=new Array,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.expressionDependencies={isIndoorDependent:!1,configDependencies:new Set},e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const f=Es(this.filter,ge["filter_".concat(e.type)]);f.result!=="error"&&(this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...f.value.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||f.value.isIndoorDependent)}if(e.slot&&(this.slot=e.slot),e.appearances&&this.setAppearances(e.appearances),i.layout&&(this._unevaluatedLayout=new Qh(i.layout,this.scope,u,this.iconImageUseTheme),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._unevaluatedLayout.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._unevaluatedLayout.isIndoorDependent()),i.paint){this._transitionablePaint=new Xf(i.paint,this.scope,u);for(const f in e.paint)this.setPaintProperty(f,e.paint[f]);for(const f in e.layout)this.setLayoutProperty(f,e.layout[f]);this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._transitionablePaint.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._transitionablePaint.isIndoorDependent(),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Ma(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Hm.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);const o=this._unevaluatedLayout;o._properties.properties[e]&&(o.setValue(e,i),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...o.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||o.isIndoorDependent(),e==="visibility"&&this.possiblyEvaluateVisibility())}setAppearances(e){this.appearances=[],e.forEach((i=>{this.appearances.push(new Gm(i.condition,i.name,i.properties,this.scope,this.options,this.iconImageUseTheme))}))}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(ip)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}isPaintProperty(e){return!!this._transitionablePaint._properties.properties[e]}setPaintProperty(e,i){const o=this._transitionablePaint,a=o._properties.properties;if(e.endsWith(ip)){const b=e.slice(0,-11);return a[b]&&o.setTransition(b,i||void 0),!1}if(!a[e])return!1;const u=o._values[e],h=u.value.isDataDriven(),f=u.value;o.setValue(e,i),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...o.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||o.isIndoorDependent(),this._handleSpecialPaintPropertyUpdate(e);const _=o._values[e].value,g=_.isDataDriven(),v=e.endsWith("pattern")||e==="line-dasharray";return g||h||v||this._handleOverridablePaintPropertyUpdate(e,f,_)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,o){return null}_handleOverridablePaintPropertyUpdate(e,i,o){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i,this.iconImageUseTheme)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){const e={id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.appearances.length!==0&&(e.appearances=this.appearances.map((i=>i.serialize()))),je(e,((i,o)=>!(i===void 0||o==="layout"&&!Object.keys(i).length||o==="paint"&&!Object.keys(i).length)))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof os&&su(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}for(const e of this.appearances)if(!ic(e.condition.expression))return!0;return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=gu(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}getAppearances(){return this.appearances}queryRenderedFeatures(e,i,o){return{}}queryRadius(e){}queryIntersectsFeature(e,i,o,a,u,h,f,_,g){}}const qm={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class fc{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class pr{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&i.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function ai(r,e=1){let i=0,o=0;return{members:r.map((a=>{const u=qm[a.type].BYTES_PER_ELEMENT,h=i=rd(i,Math.max(e,u)),f=a.components||1;return o=Math.max(o,u),i+=u*f,{name:a.name,type:a.type,components:f,offset:h}})),size:rd(i,Math.max(o,e)),alignment:e}}function rd(r,e){return Math.ceil(r/e)*e}class mo extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const a=2*e;return this.int16[a+0]=i,this.int16[a+1]=o,e}}mo.prototype.bytesPerElement=4,pt(mo,"StructArrayLayout2i4");class Pa extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o)}emplace(e,i,o,a){const u=3*e;return this.int16[u+0]=i,this.int16[u+1]=o,this.int16[u+2]=a,e}}Pa.prototype.bytesPerElement=6,pt(Pa,"StructArrayLayout3i6");class dl extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,o,a)}emplace(e,i,o,a,u){const h=4*e;return this.int16[h+0]=i,this.int16[h+1]=o,this.int16[h+2]=a,this.int16[h+3]=u,e}}dl.prototype.bytesPerElement=8,pt(dl,"StructArrayLayout4i8");class Vs extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}Vs.prototype.bytesPerElement=4,pt(Vs,"StructArrayLayout1f4");class nd extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o)}emplace(e,i,o,a){const u=4*e,h=2*e;return this.int16[u+0]=i,this.int16[u+1]=o,this.float32[h+1]=a,e}}nd.prototype.bytesPerElement=8,pt(nd,"StructArrayLayout2i1f8");class od extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o)}emplace(e,i,o,a){const u=4*e;return this.int16[u+0]=i,this.int16[u+1]=o,this.int16[u+2]=a,e}}od.prototype.bytesPerElement=8,pt(od,"StructArrayLayout3i8");class vu extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,a,u)}emplace(e,i,o,a,u,h){const f=5*e;return this.int16[f+0]=i,this.int16[f+1]=o,this.int16[f+2]=a,this.int16[f+3]=u,this.int16[f+4]=h,e}}vu.prototype.bytesPerElement=10,pt(vu,"StructArrayLayout5i10");class bu extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,o,a,u,h,f)}emplace(e,i,o,a,u,h,f,_){const g=6*e,v=12*e,b=3*e;return this.int16[g+0]=i,this.int16[g+1]=o,this.uint8[v+4]=a,this.uint8[v+5]=u,this.uint8[v+6]=h,this.uint8[v+7]=f,this.float32[b+2]=_,e}}bu.prototype.bytesPerElement=12,pt(bu,"StructArrayLayout2i4ub1f12");class Fo extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o)}emplace(e,i,o,a){const u=3*e;return this.float32[u+0]=i,this.float32[u+1]=o,this.float32[u+2]=a,e}}Fo.prototype.bytesPerElement=12,pt(Fo,"StructArrayLayout3f12");class sa extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,a,u)}emplace(e,i,o,a,u,h){const f=6*e,_=3*e;return this.uint16[f+0]=i,this.uint16[f+1]=o,this.uint16[f+2]=a,this.uint16[f+3]=u,this.float32[_+2]=h,e}}sa.prototype.bytesPerElement=12,pt(sa,"StructArrayLayout4ui1f12");class Ra extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,o,a)}emplace(e,i,o,a,u){const h=4*e;return this.uint16[h+0]=i,this.uint16[h+1]=o,this.uint16[h+2]=a,this.uint16[h+3]=u,e}}Ra.prototype.bytesPerElement=8,pt(Ra,"StructArrayLayout4ui8");class wu extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,o,a,u,h)}emplace(e,i,o,a,u,h,f){const _=6*e;return this.int16[_+0]=i,this.int16[_+1]=o,this.int16[_+2]=a,this.int16[_+3]=u,this.int16[_+4]=h,this.int16[_+5]=f,e}}wu.prototype.bytesPerElement=12,pt(wu,"StructArrayLayout6i12");class Tu extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h,f,_,g,v,b,w){const I=this.length;return this.resize(I+1),this.emplace(I,e,i,o,a,u,h,f,_,g,v,b,w)}emplace(e,i,o,a,u,h,f,_,g,v,b,w,I){const A=12*e;return this.int16[A+0]=i,this.int16[A+1]=o,this.int16[A+2]=a,this.int16[A+3]=u,this.uint16[A+4]=h,this.uint16[A+5]=f,this.uint16[A+6]=_,this.uint16[A+7]=g,this.int16[A+8]=v,this.int16[A+9]=b,this.int16[A+10]=w,this.int16[A+11]=I,e}}Tu.prototype.bytesPerElement=24,pt(Tu,"StructArrayLayout4i4ui4i24");class fl extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,o,a,u,h)}emplace(e,i,o,a,u,h,f){const _=10*e,g=5*e;return this.int16[_+0]=i,this.int16[_+1]=o,this.int16[_+2]=a,this.float32[g+2]=u,this.float32[g+3]=h,this.float32[g+4]=f,e}}fl.prototype.bytesPerElement=20,pt(fl,"StructArrayLayout3i3f20");class aa extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,o,a)}emplace(e,i,o,a,u){const h=4*e;return this.float32[h+0]=i,this.float32[h+1]=o,this.float32[h+2]=a,this.float32[h+3]=u,e}}aa.prototype.bytesPerElement=16,pt(aa,"StructArrayLayout4f16");class sd extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}sd.prototype.bytesPerElement=4,pt(sd,"StructArrayLayout1ul4");class ss extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const a=2*e;return this.uint16[a+0]=i,this.uint16[a+1]=o,e}}ss.prototype.bytesPerElement=4,pt(ss,"StructArrayLayout2ui4");class ad extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h,f,_,g,v,b,w,I){const A=this.length;return this.resize(A+1),this.emplace(A,e,i,o,a,u,h,f,_,g,v,b,w,I)}emplace(e,i,o,a,u,h,f,_,g,v,b,w,I,A){const P=20*e,D=10*e;return this.int16[P+0]=i,this.int16[P+1]=o,this.int16[P+2]=a,this.int16[P+3]=u,this.int16[P+4]=h,this.float32[D+3]=f,this.float32[D+4]=_,this.float32[D+5]=g,this.float32[D+6]=v,this.int16[P+14]=b,this.uint32[D+8]=w,this.uint16[P+18]=I,this.uint16[P+19]=A,e}}ad.prototype.bytesPerElement=40,pt(ad,"StructArrayLayout5i4f1i1ul2ui40");class Su extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,o,a,u,h,f)}emplace(e,i,o,a,u,h,f,_){const g=8*e;return this.int16[g+0]=i,this.int16[g+1]=o,this.int16[g+2]=a,this.int16[g+4]=u,this.int16[g+5]=h,this.int16[g+6]=f,this.int16[g+7]=_,e}}Su.prototype.bytesPerElement=16,pt(Su,"StructArrayLayout3i2i2i16");class pl extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,a,u)}emplace(e,i,o,a,u,h){const f=4*e,_=8*e;return this.float32[f+0]=i,this.float32[f+1]=o,this.float32[f+2]=a,this.int16[_+6]=u,this.int16[_+7]=h,e}}pl.prototype.bytesPerElement=16,pt(pl,"StructArrayLayout2f1f2i16");class ml extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,o,a,u,h)}emplace(e,i,o,a,u,h,f){const _=20*e,g=5*e;return this.uint8[_+0]=i,this.uint8[_+1]=o,this.float32[g+1]=a,this.float32[g+2]=u,this.float32[g+3]=h,this.float32[g+4]=f,e}}ml.prototype.bytesPerElement=20,pt(ml,"StructArrayLayout2ub4f20");class vr extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o)}emplace(e,i,o,a){const u=3*e;return this.uint16[u+0]=i,this.uint16[u+1]=o,this.uint16[u+2]=a,e}}vr.prototype.bytesPerElement=6,pt(vr,"StructArrayLayout3ui6");class _l extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D,L,V,j,H,te){const K=this.length;return this.resize(K+1),this.emplace(K,e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D,L,V,j,H,te)}emplace(e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D,L,V,j,H,te,K){const oe=30*e,le=15*e,ue=60*e;return this.int16[oe+0]=i,this.int16[oe+1]=o,this.int16[oe+2]=a,this.float32[le+2]=u,this.float32[le+3]=h,this.uint16[oe+8]=f,this.uint16[oe+9]=_,this.uint32[le+5]=g,this.uint32[le+6]=v,this.uint32[le+7]=b,this.uint16[oe+16]=w,this.uint16[oe+17]=I,this.uint16[oe+18]=A,this.float32[le+10]=P,this.float32[le+11]=D,this.uint8[ue+48]=L,this.uint8[ue+49]=V,this.uint8[ue+50]=j,this.uint32[le+13]=H,this.int16[oe+28]=te,this.uint8[ue+58]=K,e}}_l.prototype.bytesPerElement=60,pt(_l,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class ld extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D,L,V,j,H,te,K,oe,le,ue,Me,ye,Ce,Oe,Ne,Ye,He,Fe){const Ge=this.length;return this.resize(Ge+1),this.emplace(Ge,e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D,L,V,j,H,te,K,oe,le,ue,Me,ye,Ce,Oe,Ne,Ye,He,Fe)}emplace(e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D,L,V,j,H,te,K,oe,le,ue,Me,ye,Ce,Oe,Ne,Ye,He,Fe,Ge){const Ie=20*e,Se=40*e,Ue=80*e;return this.float32[Ie+0]=i,this.float32[Ie+1]=o,this.int16[Se+4]=a,this.int16[Se+5]=u,this.int16[Se+6]=h,this.int16[Se+7]=f,this.int16[Se+8]=_,this.int16[Se+9]=g,this.int16[Se+10]=v,this.int16[Se+11]=b,this.int16[Se+12]=w,this.uint16[Se+13]=I,this.uint16[Se+14]=A,this.uint16[Se+15]=P,this.uint16[Se+16]=D,this.uint16[Se+17]=L,this.uint16[Se+18]=V,this.uint16[Se+19]=j,this.uint16[Se+20]=H,this.uint16[Se+21]=te,this.uint16[Se+22]=K,this.uint16[Se+23]=oe,this.uint16[Se+24]=le,this.uint16[Se+25]=ue,this.uint16[Se+26]=Me,this.uint16[Se+27]=ye,this.uint32[Ie+14]=Ce,this.float32[Ie+15]=Oe,this.float32[Ie+16]=Ne,this.float32[Ie+17]=Ye,this.float32[Ie+18]=He,this.uint8[Ue+76]=Fe,this.uint16[Se+39]=Ge,e}}ld.prototype.bytesPerElement=80,pt(ld,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class cd extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,o,a,u,h)}emplace(e,i,o,a,u,h,f){const _=6*e;return this.float32[_+0]=i,this.float32[_+1]=o,this.float32[_+2]=a,this.float32[_+3]=u,this.float32[_+4]=h,this.float32[_+5]=f,e}}cd.prototype.bytesPerElement=24,pt(cd,"StructArrayLayout6f24");class Da extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,a,u)}emplace(e,i,o,a,u,h){const f=5*e;return this.float32[f+0]=i,this.float32[f+1]=o,this.float32[f+2]=a,this.float32[f+3]=u,this.float32[f+4]=h,e}}Da.prototype.bytesPerElement=20,pt(Da,"StructArrayLayout5f20");class ud extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,o,a,u,h,f)}emplace(e,i,o,a,u,h,f,_){const g=7*e;return this.float32[g+0]=i,this.float32[g+1]=o,this.float32[g+2]=a,this.float32[g+3]=u,this.float32[g+4]=h,this.float32[g+5]=f,this.float32[g+6]=_,e}}ud.prototype.bytesPerElement=28,pt(ud,"StructArrayLayout7f28");class pc extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h,f,_,g,v,b){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,o,a,u,h,f,_,g,v,b)}emplace(e,i,o,a,u,h,f,_,g,v,b,w){const I=11*e;return this.float32[I+0]=i,this.float32[I+1]=o,this.float32[I+2]=a,this.float32[I+3]=u,this.float32[I+4]=h,this.float32[I+5]=f,this.float32[I+6]=_,this.float32[I+7]=g,this.float32[I+8]=v,this.float32[I+9]=b,this.float32[I+10]=w,e}}pc.prototype.bytesPerElement=44,pt(pc,"StructArrayLayout11f44");class hd extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h,f,_,g){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,o,a,u,h,f,_,g)}emplace(e,i,o,a,u,h,f,_,g,v){const b=9*e;return this.float32[b+0]=i,this.float32[b+1]=o,this.float32[b+2]=a,this.float32[b+3]=u,this.float32[b+4]=h,this.float32[b+5]=f,this.float32[b+6]=_,this.float32[b+7]=g,this.float32[b+8]=v,e}}hd.prototype.bytesPerElement=36,pt(hd,"StructArrayLayout9f36");class la extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const a=2*e;return this.float32[a+0]=i,this.float32[a+1]=o,e}}la.prototype.bytesPerElement=8,pt(la,"StructArrayLayout2f8");class dd extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,o,a)}emplace(e,i,o,a,u){const h=6*e;return this.uint32[3*e+0]=i,this.uint16[h+2]=o,this.uint16[h+3]=a,this.uint16[h+4]=u,e}}dd.prototype.bytesPerElement=12,pt(dd,"StructArrayLayout1ul3ui12");class Eu extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}Eu.prototype.bytesPerElement=2,pt(Eu,"StructArrayLayout1ui2");class Iu extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D){const L=this.length;return this.resize(L+1),this.emplace(L,e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D)}emplace(e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D,L){const V=16*e;return this.float32[V+0]=i,this.float32[V+1]=o,this.float32[V+2]=a,this.float32[V+3]=u,this.float32[V+4]=h,this.float32[V+5]=f,this.float32[V+6]=_,this.float32[V+7]=g,this.float32[V+8]=v,this.float32[V+9]=b,this.float32[V+10]=w,this.float32[V+11]=I,this.float32[V+12]=A,this.float32[V+13]=P,this.float32[V+14]=D,this.float32[V+15]=L,e}}Iu.prototype.bytesPerElement=64,pt(Iu,"StructArrayLayout16f64");class gl extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,u,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,o,a,u,h,f)}emplace(e,i,o,a,u,h,f,_){const g=10*e,v=5*e;return this.uint16[g+0]=i,this.uint16[g+1]=o,this.uint16[g+2]=a,this.uint16[g+3]=u,this.float32[v+2]=h,this.float32[v+3]=f,this.float32[v+4]=_,e}}gl.prototype.bytesPerElement=20,pt(gl,"StructArrayLayout4ui3f20");class fd extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}fd.prototype.bytesPerElement=2,pt(fd,"StructArrayLayout1i2");class Au extends pr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}Au.prototype.bytesPerElement=1,pt(Au,"StructArrayLayout1ub1");class pd extends fc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}pd.prototype.size=40;class rp extends ad{get(e){return new pd(this,e)}}pt(rp,"CollisionBoxArray");class Mu extends fc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Mu.prototype.size=60;class mc extends _l{get(e){return new Mu(this,e)}}pt(mc,"PlacedSymbolArray");class md extends fc{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}md.prototype.size=80;class np extends ld{get(e){return new md(this,e)}}pt(np,"SymbolInstanceArray");class _d extends Vs{getoffsetX(e){return this.float32[1*e+0]}}pt(_d,"GlyphOffsetArray");class op extends mo{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}pt(op,"SymbolLineVertexArray");class Cu extends fc{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Cu.prototype.size=12;class sp extends dd{get(e){return new Cu(this,e)}}pt(sp,"FeatureIndexArray");class ap extends ss{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}pt(ap,"FillExtrusionCentroidArray");class lp extends fc{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}lp.prototype.size=6;class cp extends Pa{get(e){return new lp(this,e)}}pt(cp,"FillExtrusionWallArray");const up=ai([{name:"a_pos",components:2,type:"Int16"}],4),$m=ai([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),Zm=ai([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Ar{constructor(e=[]){this.segments=e}_prepareSegment(e,i,o,a){let u=this.segments[this.segments.length-1];return e>Ar.MAX_VERTEX_ARRAY_LENGTH&&Mt("Max vertices per segment is ".concat(Ar.MAX_VERTEX_ARRAY_LENGTH,": bucket requested ").concat(e)),(!u||u.vertexLength+e>Ar.MAX_VERTEX_ARRAY_LENGTH||u.sortKey!==a)&&(u={vertexOffset:i,primitiveOffset:o,vertexLength:0,primitiveLength:0},a!==void 0&&(u.sortKey=a),this.segments.push(u)),u}prepareSegment(e,i,o,a){return this._prepareSegment(e,i.length,o.length,a)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,o,a){return new Ar([{vertexOffset:e,primitiveOffset:i,vertexLength:o,primitiveLength:a,vaos:{},sortKey:0}])}}function hp(r,e){return 256*(r=B(Math.floor(r),0,255))+B(Math.floor(e),0,255)}Ar.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,pt(Ar,"SegmentVector");const Wm=ai([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Xm=ai([{name:"a_pattern_b",components:4,type:"Uint16"}]),Ym=ai([{name:"a_dash",components:4,type:"Uint16"}]);class _c{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,o,a){this.ids.push(gc(e)),this.positions.push(i,o,a)}eachPosition(e,i){const o=gc(e);let a=0,u=this.ids.length-1;for(;a<u;){const h=a+u>>1;this.ids[h]>=o?u=h:a=h+1}for(;this.ids[a]===o;)i(this.positions[3*a],this.positions[3*a+1],this.positions[3*a+2]),a++}static serialize(e,i){const o=new Float64Array(e.ids),a=new Uint32Array(e.positions);return gd(o,a,0,o.length-1),i&&(i.add(o.buffer),i.add(a.buffer)),{ids:o,positions:a}}static deserialize(e){const i=new _c;let o;i.ids=e.ids,i.positions=e.positions;for(const a of i.ids)a!==o&&i.uniqueIds.push(a),o=a;return i.indexed=!0,i}}function gc(r){const e=+r;return Number.isSafeInteger(e)?e:Ul(String(r))}function gd(r,e,i,o){for(;i<o;){const a=r[i+o>>1];let u=i-1,h=o+1;for(;;){do u++;while(r[u]<a);do h--;while(r[h]>a);if(u>=h)break;Pu(r,u,h),Pu(e,3*u,3*h),Pu(e,3*u+1,3*h+1),Pu(e,3*u+2,3*h+2)}h-i<o-h?(gd(r,e,i,h),i=h+1):(gd(r,e,h+1,o),o=h)}}function Pu(r,e,i){const o=r[e];r[e]=r[i],r[i]=o}pt(_c,"FeaturePositionMap");class as{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,o){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Ru extends as{constructor(e){super(e),this.current=0}set(e,i,o){this.fetchUniformLocation(e,i)&&this.current!==o&&(this.current=o,this.gl.uniform1i(this.location,o))}}class Qr extends as{constructor(e){super(e),this.current=0}set(e,i,o){this.fetchUniformLocation(e,i)&&this.current!==o&&(this.current=o,this.gl.uniform1f(this.location,o))}}class Is extends as{constructor(e){super(e),this.current=[0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]||(this.current=o,this.gl.uniform2f(this.location,o[0],o[1])))}}class yl extends as{constructor(e){super(e),this.current=[0,0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]||(this.current=o,this.gl.uniform3f(this.location,o[0],o[1],o[2])))}}class yc extends as{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]&&o[3]===this.current[3]||(this.current=o,this.gl.uniform4f(this.location,o[0],o[1],o[2],o[3])))}}class yd extends as{constructor(e){super(e),this.current=Ui.transparent.toPremultipliedRenderColor(null)}set(e,i,o){this.fetchUniformLocation(e,i)&&(o.r===this.current.r&&o.g===this.current.g&&o.b===this.current.b&&o.a===this.current.a||(this.current=o,this.gl.uniform4f(this.location,o.r,o.g,o.b,o.a)))}}const dp=new Float32Array(16);class xc extends as{constructor(e){super(e),this.current=dp}set(e,i,o){if(this.fetchUniformLocation(e,i)){if(o[12]!==this.current[12]||o[0]!==this.current[0])return this.current=o,void this.gl.uniformMatrix4fv(this.location,!1,o);for(let a=1;a<16;a++)if(o[a]!==this.current[a]){this.current=o,this.gl.uniformMatrix4fv(this.location,!1,o);break}}}}const Km=new Float32Array(9),fp=new Float32Array(4);class xd extends as{constructor(e){super(e),this.current=fp}set(e,i,o){if(this.fetchUniformLocation(e,i)){for(let a=0;a<4;a++)if(o[a]!==this.current[a]){this.current=o,this.gl.uniformMatrix2fv(this.location,!1,o);break}}}}function vd(r){return[hp(255*r.r,255*r.g),hp(255*r.b,255*r.a)]}function Du(r,e,i,o,a,u,h,f){return!!r&&(r.kind==="composite"||r.kind==="source"?r.evaluate(new lr(0,{brightness:u,worldview:f}),e,i,a,o,h)==="none":r.value==="none")}class zu{constructor(e,i,o,a){this.value=e,this.uniformNames=i.map((u=>"u_".concat(u))),this.type=o,this.context=a}setUniform(e,i,o,a,u){const h=a.constantOr(this.value);i.set(e,u,h instanceof Ui?h.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.kind==="constant"&&this.lutExpression.value==="none"?null:this.context.lut):h)}getBinding(e,i){return this.type==="color"?new yd(e):new Qr(e)}}class vc{constructor(e,i){this.uniformNames=i.map((o=>"u_".concat(o))),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,i){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=i?i.tl.concat(i.br):this.pattern}setUniform(e,i,o,a,u){let h=null;u!=="u_pattern"&&u!=="u_dash"||(h=this.pattern),u==="u_pattern_b"&&(h=this.patternTransition),u==="u_pixel_ratio"&&(h=this.pixelRatio),h&&i.set(e,u,h)}getBinding(e,i){return i==="u_pattern"||i==="u_pattern_b"||i==="u_dash"?new yc(e):new Qr(e)}}class Us{constructor(e,i,o,a){this.expression=e,this.type=o,this.maxValue=0,this.paintVertexAttributes=i.map((u=>({name:"a_".concat(u),type:"Float32",components:o==="color"?2:1,offset:0}))),this.paintVertexArray=new a}populatePaintArray(e,i,o,a,u,h,f,_){const g=this.paintVertexArray.length,v=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new lr(0,{brightness:h,worldview:_}),i,{},u,a,f):this.expression.kind==="constant"&&this.expression.value,b=Du(this.lutExpression,i,{},a,u,h,f,_);this.paintVertexArray.resize(e),this._setPaintValue(g,e,v,b?null:this.context.lut)}updatePaintArray(e,i,o,a,u,h,f,_){const g=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:f,worldview:_},o,a,void 0,u):this.expression.kind==="constant"&&this.expression.value,v=Du(this.lutExpression,o,a,u,void 0,f,void 0,_);this._setPaintValue(e,i,g,v?null:this.context.lut)}_setPaintValue(e,i,o,a){if(this.type==="color"){const u=vd(o.toPremultipliedRenderColor(a));for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,u[0],u[1])}else{for(let u=e;u<i;u++)this.paintVertexArray.emplace(u,o);this.maxValue=Math.max(this.maxValue,Math.abs(o))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class ms{constructor(e,i,o,a,u,h){this.expression=e,this.uniformNames=i.map((f=>"u_".concat(f,"_t"))),this.type=o,this.useIntegerZoom=a,this.context=u,this.maxValue=0,this.paintVertexAttributes=i.map((f=>({name:"a_".concat(f),type:"Float32",components:o==="color"?4:2,offset:0}))),this.paintVertexArray=new h}populatePaintArray(e,i,o,a,u,h,f,_){const g=this.expression.evaluate(new lr(this.context.zoom,{brightness:h,worldview:_}),i,{},u,a,f),v=this.expression.evaluate(new lr(this.context.zoom+1,{brightness:h,worldview:_}),i,{},u,a,f),b=Du(this.lutExpression,i,{},a,u,h,f,_),w=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(w,e,g,v,b?null:this.context.lut)}updatePaintArray(e,i,o,a,u,h,f,_){const g=this.expression.evaluate({zoom:this.context.zoom,brightness:f,worldview:_},o,a,void 0,u),v=this.expression.evaluate({zoom:this.context.zoom+1,brightness:f,worldview:_},o,a,void 0,u),b=Du(this.lutExpression,o,a,u,void 0,f,void 0,_);this._setPaintValue(e,i,g,v,b?null:this.context.lut)}_setPaintValue(e,i,o,a,u){if(this.type==="color"){const h=vd(o.toPremultipliedRenderColor(u)),f=vd(o.toPremultipliedRenderColor(u));for(let _=e;_<i;_++)this.paintVertexArray.emplace(_,h[0],h[1],f[0],f[1])}else{for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,o,a);this.maxValue=Math.max(this.maxValue,Math.abs(o),Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,o,a,u){const h=this.useIntegerZoom?Math.floor(o.zoom):o.zoom,f=B(this.expression.interpolationFactor(h,this.context.zoom,this.context.zoom+1),0,1);i.set(e,u,f)}getBinding(e,i){return new Qr(e)}}class jn{constructor(e,i,o,a,u){this.expression=e,this.layerId=u,this.paintVertexAttributes=(o==="array"?Ym:Wm).members;for(let h=0;h<i.length;++h);this.paintVertexArray=new a,this.paintTransitionVertexArray=new Ra}populatePaintArray(e,i,o,a){const u=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(u,e,i.patterns&&i.patterns[this.layerId],o)}updatePaintArray(e,i,o,a,u,h,f){this._setPaintValues(e,i,o.patterns&&o.patterns[this.layerId],h)}_setPaintValues(e,i,o,a){if(!a||!o)return;const u=a[o[0]],h=a[o[1]];if(u){if(u){const{tl:f,br:_,pixelRatio:g}=u;for(let v=e;v<i;v++)this.paintVertexArray.emplace(v,f[0],f[1],_[0],_[1],g)}if(h){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:f,br:_}=h;for(let g=e;g<i;g++)this.paintTransitionVertexArray.emplace(g,f[0],f[1],_[0],_[1])}}}upload(e){const i=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,i)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,Xm.members,i))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class js{constructor(e,i,o=(()=>!0)){this.binders={},this._buffers=[],this.context=i;const a=[];for(const u in e.paint._values){const h=e.paint.get(u);if(u.endsWith("-use-theme")||!o(u)||!(h instanceof os&&su(h.property.specification)))continue;const f=Qm(u,e.type),_=h.value,g=h.property.specification.type,v=!!h.property.useIntegerZoom,b=u==="line-dasharray"||u.endsWith("pattern"),w=e.paint.get("".concat(u,"-use-theme")),I=u==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||w&&w.value.kind!=="constant";if(_.kind!=="constant"||I)if(_.kind==="source"||I||b){const A=bd(u,g,"source");this.binders[u]=b?new jn(_,f,g,A,e.id):new Us(_,f,g,A),a.push("/a_".concat(u))}else{const A=bd(u,g,"composite");this.binders[u]=new ms(_,f,g,v,i,A),a.push("/z_".concat(u))}else this.binders[u]=b?new vc(_.value,f):new zu(_.value,f,g,i),a.push("/u_".concat(u));w&&(this.binders[u].lutExpression=w.value)}this.cacheKey=a.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof Us||i instanceof ms?i.maxValue:0}populatePaintArrays(e,i,o,a,u,h,f,_){for(const g in this.binders){const v=this.binders[g];v.context=this.context,(v instanceof Us||v instanceof ms||v instanceof jn)&&v.populatePaintArray(e,i,o,a,u,h,f,_)}}setConstantPatternPositions(e,i){for(const o in this.binders){const a=this.binders[o];a instanceof vc&&a.setConstantPatternPositions(e,i)}}getPatternTransitionVertexBuffer(e){const i=this.binders[e];return i instanceof jn?i.paintTransitionVertexBuffer:null}updatePaintArrays(e,i,o,a,u,h,f,_,g,v){let b=!1;const w=Object.keys(e),I=w.length!==0&&!_,A=I?w:i.uniqueIds;this.context.lut=u.lut;for(const P in this.binders){const D=this.binders[P];if(D.context=this.context,(D instanceof Us||D instanceof ms||D instanceof jn)&&D.expression&&D.expression.kind&&D.expression.kind!=="constant"&&(D.expression.isStateDependent===!0||D.expression.isLightConstant===!1)){const L=u.paint.get(P);D.expression=L.value;for(const V of A){const j=e[V.toString()];i.eachPosition(V,((H,te,K)=>{const oe=a.feature(H);D.updatePaintArray(te,K,oe,j,h,f,g,v)}))}if(!I)for(const V of o.uniqueIds){const j=e[V.toString()];o.eachPosition(V,((H,te,K)=>{const oe=a.feature(H);D.updatePaintArray(te,K,oe,j,h,f,g,v)}))}b=!0}}return b}defines(){const e=[];for(const i in this.binders){const o=this.binders[i];(o instanceof zu||o instanceof vc)&&e.push(...o.uniformNames.map((a=>"#define HAS_UNIFORM_".concat(a))))}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const o in this.binders){const a=this.binders[o];if(a instanceof zu||a instanceof vc||a instanceof ms)for(const u of a.uniformNames)i.push({name:u,property:o,binding:a.getBinding(e,u)})}return i}setUniforms(e,i,o,a,u){for(const{name:h,property:f,binding:_}of o)this.binders[f].setUniform(e,_,u,a.get(f),h)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof Us||i instanceof ms||i instanceof jn)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer),i instanceof jn&&i.paintTransitionVertexBuffer&&this._buffers.push(i.paintTransitionVertexBuffer)}}upload(e){for(const i in this.binders){const o=this.binders[i];(o instanceof Us||o instanceof ms||o instanceof jn)&&o.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof Us||i instanceof ms||i instanceof jn)&&i.destroy()}}}class _s{constructor(e,i,o=(()=>!0)){this.programConfigurations={};for(const a of e)this.programConfigurations[a.id]=new js(a,i,o);this.needsUpload=!1,this._featureMap=new _c,this._featureMapWithoutIds=new _c,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,o,a,u,h,f,_,g){for(const v in this.programConfigurations)this.programConfigurations[v].populatePaintArrays(e,i,a,u,h,f,_,g);i.id!==void 0?this._featureMap.add(i.id,o,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,o,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,o,a,u,h,f,_){for(const g of o)this.needsUpload=this.programConfigurations[g.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,g,a,u,h,f||0,_)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const Jm={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function Qm(r,e){return Jm[r]||[r.replace("".concat(e,"-"),"").replace(/-/g,"_")]}const e_={"line-pattern":{source:sa,composite:sa},"fill-pattern":{source:sa,composite:sa},"fill-extrusion-pattern":{source:sa,composite:sa},"line-dasharray":{source:Ra,composite:Ra}},t_={color:{source:la,composite:aa},number:{source:Vs,composite:la}};function bd(r,e,i){const o=e_[r];return o&&o[i]||t_[e][i]}pt(zu,"ConstantBinder"),pt(vc,"PatternConstantBinder"),pt(Us,"SourceExpressionBinder"),pt(jn,"PatternCompositeBinder"),pt(ms,"CompositeExpressionBinder"),pt(js,"ProgramConfiguration",{omit:["_buffers"]}),pt(_s,"ProgramConfigurationSet");const _o=Je/Math.PI/2,l=5,t=6,n=16383,c=64,d=[c,32,16],p=-_o,m=_o;function y(r,e,i,o=_o){return i=ii(i),[r*Math.sin(i)*o,-e*o,r*Math.cos(i)*o]}function x(r,e,i){return y(Math.cos(ii(r)),Math.sin(ii(r)),e,i)}const T=63710088e-1,S=2*Math.PI*T;class M{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error("Invalid LngLat object: (".concat(e,", ").concat(i,")"));if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new M(ae(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return"LngLat(".concat(this.lng,", ").concat(this.lat,")")}distanceTo(e){const i=Math.PI/180,o=this.lat*i,a=e.lat*i,u=Math.sin(o)*Math.sin(a)+Math.cos(o)*Math.cos(a)*Math.cos((e.lng-this.lng)*i);return T*Math.acos(Math.min(u,1))}toBounds(e=0){const i=360*e/40075017,o=i/Math.cos(Math.PI/180*this.lat);return new E({lng:this.lng-o,lat:this.lat-i},{lng:this.lng+o,lat:this.lat+i})}toEcef(e){return x(this.lat,this.lng,_o+e*_o/T)}static convert(e){if(e instanceof M)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new M(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new M(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class E{constructor(e,i){e&&(i?this.setSouthWest(e).setNorthEast(i):Array.isArray(e)&&e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof M?new M(e.lng,e.lat):M.convert(e),this}setSouthWest(e){return this._sw=e instanceof M?new M(e.lng,e.lat):M.convert(e),this}extend(e){const i=this._sw,o=this._ne;let a,u;if(e instanceof M)a=e,u=e;else{if(!(e instanceof E))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(E.convert(e)):this.extend(M.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(M.convert(e)):this;if(a=e._sw,u=e._ne,!a||!u)return this}return i||o?(i.lng=Math.min(a.lng,i.lng),i.lat=Math.min(a.lat,i.lat),o.lng=Math.max(u.lng,o.lng),o.lat=Math.max(u.lat,o.lat)):(this._sw=new M(a.lng,a.lat),this._ne=new M(u.lng,u.lat)),this}getCenter(){return new M((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new M(this.getWest(),this.getNorth())}getSouthEast(){return new M(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return"LngLatBounds(".concat(this._sw.toString(),", ").concat(this._ne.toString(),")")}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:o}=M.convert(e);let a=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(a=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=o&&o<=this._ne.lat&&a}static convert(e){if(e)return e instanceof E?e:new E(e)}}const C=0,R=25.5;function z(r){return S*Math.cos(r*Math.PI/180)}function N(r){return(180+r)/360}function k(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function U(r,e){return r/z(e)}function $(r){return 360*r-180}function G(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function ee(r,e){return r*z(G(e))}const Z=85.051129;function ie(r){return Math.cos(ii(B(r,-Z,Z)))}function Q(r,e){const i=B(e,C,R),o=Math.pow(2,i);return ie(r)*S/(512*o)}function Y(r){return 1/Math.cos(r*Math.PI/180)}function re(r,e=0){const i=Math.exp(Math.PI*(1-(r.y+e/Je)/(1<<r.z)*2));return 80150034*i/(i*i+1)/Je/(1<<r.z)}class _e{constructor(e,i,o=0){this.x=+e,this.y=+i,this.z=+o}static fromLngLat(e,i=0){const o=M.convert(e);return new _e(N(o.lng),k(o.lat),U(i,o.lat))}toLngLat(){return new M($(this.x),G(this.y))}toAltitude(){return ee(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/S*Y(G(this.y))}}function he(r,e,i,o,a,u,h,f,_){const g=(e+o)/2,v=(i+a)/2,b=new Be(g,v);f(b),(function(w,I,A,P,D,L){const V=A-D,j=P-L;return Math.abs((P-I)*V-(A-w)*j)/Math.hypot(V,j)})(b.x,b.y,u.x,u.y,h.x,h.y)>=_?(he(r,e,i,g,v,u,b,f,_),he(r,g,v,o,a,b,h,f,_)):r.push(h)}function Ae(r,e,i){let o=r[0],a=o.x,u=o.y;e(o);const h=[o];for(let f=1;f<r.length;f++){const _=r[f],{x:g,y:v}=_;e(_),he(h,a,u,g,v,o,_,e,i),a=g,u=v,o=_}return h}function ve(r,e,i,o){if(o(e,i)){const a=e.add(i)._mult(.5);ve(r,e,a,o),ve(r,a,i,o)}else r.push(i)}function ze(r,e){let i=r[0];const o=[i];for(let a=1;a<r.length;a++){const u=r[a];ve(o,i,u,e),i=u}return o}const Xe=Math.pow(2,14)-1,xe=-Xe-1;function ce(r,e){const i=Math.round(r.x*e),o=Math.round(r.y*e);return r.x=B(i,xe,Xe),r.y=B(o,xe,Xe),(i<r.x||i>r.x+1||o<r.y||o>r.y+1)&&Mt("Geometry exceeds allowed extent, reduce your vector tile buffer size"),r}function Le(r,e,i){const o=r.loadGeometry(),a=r.extent,u=Je/a;if(e&&i&&i.projection.isReprojectedInTileSpace){const h=1<<e.z,{scale:f,x:_,y:g,projection:v}=i,b=w=>{const I=$((e.x+w.x/a)/h),A=G((e.y+w.y/a)/h),P=v.project(I,A);w.x=(P.x*f-_)*a,w.y=(P.y*f-g)*a};for(let w=0;w<o.length;w++)if(r.type!==1)o[w]=Ae(o[w],b,1);else{const I=[];for(const A of o[w])A.x<0||A.x>=a||A.y<0||A.y>=a||(b(A),I.push(A));o[w]=I}}for(const h of o)for(const f of h)ce(f,u);return o}function be(r,e){return{type:r.type,id:r.id,properties:r.properties,geometry:e?Le(r):[]}}class Ve{constructor(e,i,o,a,u){this.properties={},this.extent=o,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=a,this._values=u,e.readFields(Qe,this,i)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos,o=[];let a,u=1,h=0,f=0,_=0;for(;e.pos<i;){if(h<=0){const g=e.readVarint();u=7&g,h=g>>3}if(h--,u===1||u===2)f+=e.readSVarint(),_+=e.readSVarint(),u===1&&(a&&o.push(a),a=[]),a&&a.push(new Be(f,_));else{if(u!==7)throw new Error("unknown command ".concat(u));a&&a.push(a[0].clone())}}return a&&o.push(a),o}bbox(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos;let o=1,a=0,u=0,h=0,f=1/0,_=-1/0,g=1/0,v=-1/0;for(;e.pos<i;){if(a<=0){const b=e.readVarint();o=7&b,a=b>>3}if(a--,o===1||o===2)u+=e.readSVarint(),h+=e.readSVarint(),u<f&&(f=u),u>_&&(_=u),h<g&&(g=h),h>v&&(v=h);else if(o!==7)throw new Error("unknown command ".concat(o))}return[f,g,_,v]}toGeoJSON(e,i,o){const a=this.extent*Math.pow(2,o),u=this.extent*e,h=this.extent*i,f=this.loadGeometry();function _(w){return[360*(w.x+u)/a-180,360/Math.PI*Math.atan(Math.exp((1-2*(w.y+h)/a)*Math.PI))-90]}function g(w){return w.map(_)}let v;if(this.type===1){const w=[];for(const A of f)w.push(A[0]);const I=g(w);v=w.length===1?{type:"Point",coordinates:I[0]}:{type:"MultiPoint",coordinates:I}}else if(this.type===2){const w=f.map(g);v=w.length===1?{type:"LineString",coordinates:w[0]}:{type:"MultiLineString",coordinates:w}}else{if(this.type!==3)throw new Error("unknown feature type");{const w=(function(A){const P=A.length;if(P<=1)return[A];const D=[];let L,V;for(let j=0;j<P;j++){const H=mt(A[j]);H!==0&&(V===void 0&&(V=H<0),V===H<0?(L&&D.push(L),L=[A[j]]):L&&L.push(A[j]))}return L&&D.push(L),D})(f),I=[];for(const A of w)I.push(A.map(g));v=I.length===1?{type:"Polygon",coordinates:I[0]}:{type:"MultiPolygon",coordinates:I}}}const b={type:"Feature",geometry:v,properties:this.properties};return this.id!=null&&(b.id=this.id),b}}function Qe(r,e,i){r===1?e.id=i.readVarint():r===2?(function(o,a){const u=o.readVarint()+o.pos;for(;o.pos<u;){const h=a._keys[o.readVarint()],f=a._values[o.readVarint()];a.properties[h]=f}})(i,e):r===3?e.type=i.readVarint():r===4&&(e._geometry=i.pos)}function mt(r){let e=0;for(let i,o,a=0,u=r.length,h=u-1;a<u;h=a++)i=r[a],o=r[h],e+=(o.x-i.x)*(i.y+o.y);return e}Ve.types=["Unknown","Point","LineString","Polygon"];class $e{constructor(e,i){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(Ke,this,i),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const i=this._pbf.readVarint()+this._pbf.pos;return new Ve(this._pbf,i,this.extent,this._keys,this._values)}}function Ke(r,e,i){r===15?e.version=i.readVarint():r===1?e.name=i.readString():r===5?e.extent=i.readVarint():r===2?e._features.push(i.pos):r===3?e._keys.push(i.readString()):r===4&&e._values.push((function(o){let a=null;const u=o.readVarint()+o.pos;for(;o.pos<u;){const h=o.readVarint()>>3;a=h===1?o.readString():h===2?o.readFloat():h===3?o.readDouble():h===4?o.readVarint64():h===5?o.readVarint():h===6?o.readSVarint():h===7?o.readBoolean():null}if(a==null)throw new Error("unknown feature value");return a})(i))}class gt{constructor(e,i){this.layers=e.readFields(ht,{},i)}}function ht(r,e,i){if(r===3){const o=new $e(i,i.readVarint()+i.pos);o.length&&(e[o.name]=o)}}const ct="3d_elevation_id",dt="level";class Pt{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,i){return this._valid&&e(i(this._geometry)),this}require(e,i,o){return this.get(e,!0,i,o)}optional(e,i,o){return this.get(e,!1,i,o)}success(){return this._valid}get(e,i,o,a){const u=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&u!==void 0&&!Number.isNaN(u)?o(a?a(u):u):i&&(this._valid=!1),this}}class li{constructor(e,i){this.featureFunc=e,this.vertexFunc=i}parseFeature(e,i,o){return this.featureFunc(e,i,o)}parseVertex(e,i,o){return this.vertexFunc(e,i,o)}}const pi=new li(((r,e,i)=>r.reset(e).require(ct,(o=>{i.id=o})).optional("fixed_height_relative",(o=>{i.constantHeight=o}),Nt.decodeRelativeHeight).geometry((o=>{i.bounds=o}),Jl).success()),((r,e,i)=>r.reset(e).require(ct,(o=>{i.id=o})).require("elevation_idx",(o=>{i.idx=o})).require("extent",(o=>{i.extent=o})).require("height_relative",(o=>{i.height=o}),Nt.decodeRelativeHeight).geometry((o=>{i.position=o}),Nt.getPoint).success())),Yi=new li(((r,e,i)=>r.reset(e).require(ct,(o=>{i.id=o})).optional("fixed_height",(o=>{i.constantHeight=o}),Nt.decodeMetricHeight).geometry((o=>{i.bounds=o}),Jl).success()),((r,e,i)=>r.reset(e).require(ct,(o=>{i.id=o})).require("elevation_idx",(o=>{i.idx=o})).require("extent",(o=>{i.extent=o})).require("height",(o=>{i.height=o}),Nt.decodeMetricHeight).geometry((o=>{i.position=o}),Nt.getPoint).success()));class Nt{static getPoint(e){return yo(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static getVersionSchema(e){return e?e==="1.0.1"?Yi:void 0:pi}static parse(e){const i=[],o=[],a=e.length,u=new Pt;for(let h=0;h<a;h++){const f=e.feature(h),_=f.properties.version,g=Nt.getVersionSchema(_);if(g===void 0){Mt("Unknown elevation feature version number ".concat(_||"(unknown)"));continue}const v=f.properties.type;if(!v)continue;const b=Ve.types[f.type];if(b==="Point"&&v==="curve_point"){const w={};g.parseVertex(u,f,w)&&i.push(w)}else if(b==="Polygon"&&v==="curve_meta"){const w={};g.parseFeature(u,f,w)&&o.push(w)}}return{vertices:i,features:o}}}class fi{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,o){const a=ho(i,this.dir);if(Math.abs(a)<1e-6)return!1;const u=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1])/a;return o[0]=this.pos[0]+this.dir[0]*u,o[1]=this.pos[1]+this.dir[1]*u,!0}}class Kt{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,o){const a=Gi(i,this.dir);if(Math.abs(a)<1e-6)return!1;const u=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/a;return o[0]=this.pos[0]+this.dir[0]*u,o[1]=this.pos[1]+this.dir[1]*u,o[2]=this.pos[2]+this.dir[2]*u,!0}closestPointOnSphere(e,i,o){if((function(I,A){var P=I[0],D=I[1],L=I[2],V=A[0],j=A[1],H=A[2];return Math.abs(P-V)<=et*Math.max(1,Math.abs(P),Math.abs(V))&&Math.abs(D-j)<=et*Math.max(1,Math.abs(D),Math.abs(j))&&Math.abs(L-H)<=et*Math.max(1,Math.abs(L),Math.abs(H))})(this.pos,e)||i===0)return o[0]=o[1]=o[2]=0,!1;const[a,u,h]=this.dir,f=this.pos[0]-e[0],_=this.pos[1]-e[1],g=this.pos[2]-e[2],v=a*a+u*u+h*h,b=2*(f*a+_*u+g*h),w=b*b-4*v*(f*f+_*_+g*g-i*i);if(w<0){const I=Math.max(-b/2,0),A=f+a*I,P=_+u*I,D=g+h*I,L=Math.hypot(A,P,D);return o[0]=A*i/L,o[1]=P*i/L,o[2]=D*i/L,!1}{const I=(-b-Math.sqrt(w))/(2*v);if(I<0){const A=Math.hypot(f,_,g);return o[0]=f*i/A,o[1]=_*i/A,o[2]=g*i/A,!1}return o[0]=f+a*I,o[1]=_+u*I,o[2]=g+h*I,!0}}}class qi{constructor(e,i,o,a,u){this.TL=e,this.TR=i,this.BR=o,this.BL=a,this.horizon=u}static fromInvProjectionMatrix(e,i,o){const a=[-1,1,1],u=[1,1,1],h=[1,-1,1],f=[-1,-1,1],_=nr(a,a,e),g=nr(u,u,e),v=nr(h,h,e),b=nr(f,f,e);return new qi(_,g,v,b,i/o)}}function mi(r,e,i){let o=1/0,a=-1/0;const u=[];for(const h of r){Pr(u,h,e);const f=Gi(u,i);o=Math.min(o,f),a=Math.max(a,f)}return[o,a]}function ir(r,e){let i=!0;for(let o=0;o<r.planes.length;o++){const a=r.planes[o];let u=0;for(let h=0;h<e.length;h++)u+=+(Gi(a,e[h])+a[3]>=0);if(u===0)return 0;u!==e.length&&(i=!1)}return i?2:1}function Ii(r,e){for(const i of r.projections){const o=mi(e,r.points[0],i.axis);if(i.projection[1]<o[0]||i.projection[0]>o[1])return 0}return 1}function Qt(r,e){let i=0;const o=[0,0,0,0];for(let h=0;h<r.length;h++)o[0]=r[h][0],o[1]=r[h][1],o[2]=r[h][2],o[3]=1,(a=o)[0]*(u=e)[0]+a[1]*u[1]+a[2]*u[2]+a[3]*u[3]>=0&&i++;var a,u;return i}class ki{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=ri.fromPoints(this.points),this.projections=[],this.frustumEdges=[Pr([],this.points[2],this.points[3]),Pr([],this.points[0],this.points[3]),Pr([],this.points[4],this.points[0]),Pr([],this.points[5],this.points[1]),Pr([],this.points[6],this.points[2]),Pr([],this.points[7],this.points[3])];for(const o of this.frustumEdges){const a=[0,-o[2],o[1]],u=[o[2],0,-o[0]];this.projections.push({axis:a,projection:mi(this.points,this.points[0],a)}),this.projections.push({axis:u,projection:mi(this.points,this.points[0],u)})}}static fromInvProjectionMatrix(e,i,o,a){const u=Math.pow(2,o),h=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((g=>{const v=pn([],g,e),b=1/v[3]/i*u;return(w=v)[0]=(I=v)[0]*(A=[b,b,a?1/v[3]:b,b])[0],w[1]=I[1]*A[1],w[2]=I[2]*A[2],w[3]=I[3]*A[3],w;var w,I,A})),f=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((g=>{const v=Oi([],Cr([],Pr([],h[g[0]],h[g[1]]),Pr([],h[g[2]],h[g[1]]))),b=-Gi(v,h[g[1]]);return v.concat(b)})),_=[];for(let g=0;g<h.length;g++)_.push([h[g][0],h[g][1],h[g][2]]);return new ki(_,f)}intersectsPrecise(e,i,o){for(let a=0;a<i.length;a++)if(!Qt(e,i[a]))return 0;for(let a=0;a<this.planes.length;a++)if(!Qt(e,this.planes[a]))return 0;for(const a of o)for(const u of this.frustumEdges){const h=Cr([],a,u),f=yn(h);if(f===0)continue;Wi(h,h,1/f);const _=mi(this.points,this.points[0],h),g=mi(e,this.points[0],h);if(_[0]>g[1]||g[0]>_[1])return 0}return 1}containsPoint(e){for(const i of this.planes){const o=i[3];if(Gi([i[0],i[1],i[2]],e)+o<0)return!1}return!0}}class ri{static fromPoints(e){const i=[1/0,1/0,1/0],o=[-1/0,-1/0,-1/0];for(const a of e)lo(i,i,a),xn(o,o,a);return new ri(i,o)}static fromTileIdAndHeight(e,i,o){const a=1<<e.canonical.z,u=e.canonical.x,h=e.canonical.y;return new ri([u/a,h/a,i],[(u+1)/a,(h+1)/a,o])}static applyTransform(e,i){const o=e.getCorners();for(let a=0;a<o.length;++a)nr(o[a],o[a],i);return ri.fromPoints(o)}static applyTransformFast(e,i){const o=[i[12],i[13],i[14]],a=[...o];for(let u=0;u<3;u++)for(let h=0;h<3;h++){const f=i[4*h+u],_=f*e.min[h],g=f*e.max[h];o[u]+=Math.min(_,g),a[u]+=Math.max(_,g)}return new ri(o,a)}static projectAabbCorners(e,i){const o=e.getCorners();for(let a=0;a<o.length;++a)nr(o[a],o[a],i);return o}constructor(e,i){this.min=e,this.max=i,this.center=Wi([],Er([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],o=On(this.min),a=On(this.max);for(let u=0;u<i.length;u++)o[u]=i[u]?this.min[u]:this.center[u],a[u]=i[u]?this.center[u]:this.max[u];return a[2]=this.max[2],new ri(o,a)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?ir(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?ir(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?Ii(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?Ii(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}pt(ri,"Aabb");class ur{constructor(e,i){this.feature=e,this.metersToTile=i,this.index=0}get(){const e=this.feature.vertices[this.index],i=this.feature.vertexProps[this.index].dir,o=i[1],a=-i[0],u=(e.extent+1)*this.metersToTile;return[new Be(Math.trunc(e.position[0]+o*u),Math.trunc(e.position[1]+a*u)),new Be(Math.trunc(e.position[0]-o*u),Math.trunc(e.position[1]-a*u))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Ni{constructor(e,i,o,a,u,h){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this._tmpVec2=[Nr(),Nr(),Nr(),Nr(),Nr(),Nr(),Nr()],this.id=e,this.heightRange={min:o,max:o},this.safeArea=i,this.constantHeight=o,this.constantHeight==null&&(this.constantHeight!=null||a.length!==0)){this.vertices=a,this.edges=u,this.edges=this.edges.filter((f=>{return f.a<this.vertices.length&&f.b<this.vertices.length&&!((_=this.vertices[f.a].position)[0]===(g=this.vertices[f.b].position)[0]&&_[1]===g[1]);var _,g})),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const f of this.vertices)this.vertexProps.push({dir:yo(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,f.height),this.heightRange.max=Math.max(this.heightRange.max,f.height);for(const f of this.edges){const _=this.vertices[f.a].position,g=this.vertices[f.b].position,v=Wn(Nr(),g,_),b=cr(v),w=Mn(Nr(),v,1/b);this.edgeProps.push({vec:v,dir:w,len:b});const I=this.vertexProps[f.a].dir,A=this.vertexProps[f.b].dir;xo(I,I,w),xo(A,A,w)}for(const f of this.vertexProps)f.dir[0]===0&&f.dir[1]===0||Xr(f.dir,f.dir);this.tessellate(h)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;const i=this.getClosestEdge(e);if(i==null)return 0;const[o,a]=i;return Ft(this.vertices[this.edges[o].a].height,this.vertices[this.edges[o].b].height,a)}computeSlopeNormal(e,i){const o=this.getClosestEdge(e);if(!o)return rr(0,0,1);const a=o[0],u=this.edges[a],h=this.edgeProps[a].vec,f=rr(h[0],h[1],(this.vertices[u.b].height-this.vertices[u.a].height)*i),_=rr(f[1],-f[0],0);Cr(_,_,f);const g=yn(_);return g>0?Wi(_,_,1/g):Li(_,0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let i=0,o=Number.POSITIVE_INFINITY,a=0;const[u,h,f,_,g,v,b]=this._tmpVec2;Yo(b,e.x,e.y);const w=new fi(b,null);for(let I=0;I<this.edges.length;I++){const A=this.edges[I],P=this.edgeProps[I].dir;w.dir=P;const D=this.vertices[A.a].position,L=this.vertices[A.b].position,V=w.intersectsPlane(D,this.vertexProps[A.a].dir,u),j=w.intersectsPlane(L,this.vertexProps[A.b].dir,h);if(!V||!j)continue;Wn(f,h,u),Wn(_,b,u);const H=ho(f,f),te=H>0?ho(_,f)/H:0,K=B(te,0,1),oe=Math.abs((te-K)*this.edgeProps[I].len);Wn(g,b,D),Yo(v,P[1],-P[0]);const le=oe+Math.abs(ho(g,v));le<o&&(i=I,o=le,a=K)}return[i,a]}tessellate(e){const i=Jt(),o=Jt(),a=Jt(),u=Jt();for(let h=this.edges.length-1;h>=0;--h){const f=this.edges[h].a,_=this.edges[h].b,{position:g,height:v,extent:b}=this.vertices[f],{position:w,height:I,extent:A}=this.vertices[_],P=this.vertexProps[f].dir,D=this.vertexProps[_].dir;if(Li(i,g[0]/e,g[1]/e,v),Li(o,w[0]/e,w[1]/e,I),Li(a,P[1],-P[0],0),Wi(a,a,b),Li(u,D[1],-D[0],0),Wi(u,u,A),this.distSqLines(rr(i[0]+.5*a[0],i[1]+.5*a[1],i[2]+.5*a[2]),rr(o[0]-.5*u[0],o[1]-.5*u[1],o[2]-.5*u[2]),rr(i[0]-.5*a[0],i[1]-.5*a[1],i[2]-.5*a[2]),rr(o[0]+.5*u[0],o[1]+.5*u[1],o[2]+.5*u[2]))<=.0025000000000000005)continue;const L=this.vertices.length,V=xo(Nr(),g,w);this.vertices.push({position:Mn(V,V,.5),height:.5*(v+I),extent:.5*(b+A)});const j=xo(Nr(),P,D);this.vertexProps.push({dir:Xr(j,j)}),this.edges.splice(h,1),this.edgeProps.splice(h,1),this.edges.push({a:f,b:L}),this.edges.push({a:L,b:_});const H=Wn(Nr(),this.vertices[L].position,g),te=cr(H),K={vec:H,dir:Mn(Nr(),H,1/te),len:te};this.edgeProps.push(K),this.edgeProps.push(K)}}distSqLines(e,i,o,a){const u=en(Jt(),i,e),h=en(Jt(),a,o),f=en(Jt(),e,o),_=Gi(u,u),g=Gi(u,h),v=Gi(u,f),b=Gi(h,h),w=Gi(h,f),I=_*b-g*g;if(I===0)return En(fn(u,o,a,Gi(f,h)/Gi(h,h)),e);const A=(_*w-g*v)/I;return En(fn(u,e,i,(g*w-v*b)/I),fn(h,o,a,A))}}class Ut{static parseFrom(e,i){const o=Nt.parse(e);if(!o)return[];let{vertices:a,features:u}=o;const h=1/re(i);u.sort(((v,b)=>v.id-b.id)),a.sort(((v,b)=>v.id-b.id||v.idx-b.idx)),a=a.filter(((v,b,w)=>b===w.findIndex((I=>I.id===v.id&&I.idx===v.idx))));const f=new Array;let _=0;const g=a.length;for(const v of u){if(v.constantHeight){f.push(new Ni(v.id,v.bounds,v.constantHeight));continue}for(;_!==g&&a[_].id<v.id;)_++;if(_===g||a[_].id!==v.id)continue;const b=new Array,w=new Array,I=_;for(;_!==g&&a[_].id===v.id;){const A=a[_];if(b.push({position:A.position,height:A.height,extent:A.extent}),_!==I&&a[_-1].idx===A.idx-1){const P=_-I;w.push({a:P-1,b:P})}_++}f.push(new Ni(v.id,v.bounds,void 0,b,w,h))}return f}static getElevationFeature(e,i){if(!i)return;const o=+e.properties[ct];return Number.isNaN(o)?void 0:i.find((a=>a.id===o))}}class gi{constructor(e,i){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(i)||(this.zScale=Math.pow(2,i.z-e.z),this.xOffset=(e.x*this.zScale-i.x)*Je,this.yOffset=(e.y*this.zScale-i.y)*Je)}constantElevation(e,i){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,i)}pointElevation(e,i,o){const a=this.constantElevation(i,o);return a!=null?a:(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(i.pointElevation(e),o))}computeBiasedHeight(e,i){return i<=0?e:e+i*X(0,i,e>=0?e:Math.abs(.5*e))}}pt(Ni,"ElevationFeature");class wr{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new mo,this.indexArray=new vr,this.segments=new Ar,this.programConfigurations=new _s(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new Vs),this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,o,a){}populate(e,i,o,a){const u=this.layers[0],h=[];let f=null;u.type==="circle"&&(f=u.layout.get("circle-sort-key"));for(const{feature:g,id:v,index:b,sourceLayerIndex:w}of e){const I=this.layers[0]._featureFilter.needGeometry,A=be(g,I);if(!this.layers[0]._featureFilter.filter(new lr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),A,o))continue;const P=f?f.evaluate(A,{},o):void 0,D={id:v,properties:g.properties,type:g.type,sourceLayerIndex:w,index:b,geometry:I?A.geometry:Le(g,o,a),patterns:{},sortKey:P};h.push(D)}f&&h.sort(((g,v)=>g.sortKey-v.sortKey));let _=null;a.projection.name==="globe"&&(this.globeExtVertexArray=new wu,_=a.projection);for(const g of h){const{geometry:v,index:b,sourceLayerIndex:w}=g,I=e[b].feature;this.addFeature(g,v,b,i.availableImages,o,_,i.brightness,i.elevationFeatures),i.featureIndex.insert(I,v,b,w,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,i,o,a,u,h,f){this.programConfigurations.updatePaintArrays(e,i,u,o,a,h,f,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,up.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Zm.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,$m.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,i,o,a,u,h,f,_){let g;this.elevationMode!=="none"&&(g=Ut.getElevationFeature(e,_));for(const v of i)for(const b of v){const w=b.x,I=b.y;if(w<0||w>=Je||I<0||I>=Je)continue;if(h){const D=h.projectTilePoint(w,I,u),L=h.upVector(u,w,I);this.addGlobeExtVertex(D,L),this.addGlobeExtVertex(D,L),this.addGlobeExtVertex(D,L),this.addGlobeExtVertex(D,L)}const A=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),P=A.vertexLength;if(this.addCircleVertex(w,I,-1,-1),this.addCircleVertex(w,I,1,-1),this.addCircleVertex(w,I,1,1),this.addCircleVertex(w,I,-1,1),this.elevationMode!=="none"){const D=g?g.pointElevation(new Be(w,I)):0;this.hasElevation=this.hasElevation||D!==0;for(let L=0;L<4;L++)this.elevatedLayoutVertexArray.emplaceBack(D)}this.indexArray.emplaceBack(P,P+1,P+2),this.indexArray.emplaceBack(P,P+2,P+3),A.vertexLength+=4,A.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,{},a,u,f,void 0,this.worldview)}addCircleVertex(e,i,o,a){this.layoutVertexArray.emplaceBack(2*e+(o+1)/2,2*i+(a+1)/2)}addGlobeExtVertex(e,i){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}}function jr(r,e){for(let i=0;i<r.length;i++)if(wn(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(wn(r,e[i]))return!0;return!!oo(r,e)}function Mr(r,e,i){return!!wn(r,e)||!!Vn(e,r,i)}function Br(r,e){if(r.length===1)return ls(e,r[0]);for(let i=0;i<e.length;i++){const o=e[i];for(let a=0;a<o.length;a++)if(wn(r,o[a]))return!0}for(let i=0;i<r.length;i++)if(ls(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(oo(r,e[i]))return!0;return!1}function go(r,e,i){if(r.length>1){if(oo(r,e))return!0;for(let o=0;o<e.length;o++)if(Vn(e[o],r,i))return!0}for(let o=0;o<r.length;o++)if(Vn(r[o],e,i))return!0;return!1}function oo(r,e){if(r.length===0||e.length===0)return!1;for(let i=0;i<r.length-1;i++){const o=r[i],a=r[i+1];for(let u=0;u<e.length-1;u++)if(Nn(o,a,e[u],e[u+1]))return!0}return!1}function Nn(r,e,i,o){return ni(r,i,o)!==ni(e,i,o)&&ni(r,e,i)!==ni(r,e,o)}function Gn(r,e,i){return(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x)}function ko(r,e,i,o){const a=Gn(r,e,o),u=Gn(r,e,i);if(Math.sign(a)===Math.sign(u))return;const h=Gn(i,o,r),f=h+u-a;return Math.sign(h)!==Math.sign(f)?[h/(h-f),u/(u-a)]:void 0}function Vn(r,e,i){const o=i*i;if(e.length===1)return r.distSqr(e[0])<o;for(let a=1;a<e.length;a++)if(Bo(r,e[a-1],e[a])<o)return!0;return!1}function Bo(r,e,i){const o=e.distSqr(i);if(o===0)return r.distSqr(e);const a=((r.x-e.x)*(i.x-e.x)+(r.y-e.y)*(i.y-e.y))/o;return r.distSqr(a<0?e:a>1?i:i.sub(e)._mult(a)._add(e))}function ls(r,e){let i,o,a,u=!1;for(let h=0;h<r.length;h++){i=r[h];for(let f=0,_=i.length-1;f<i.length;_=f++)o=i[f],a=i[_],o.y>e.y!=a.y>e.y&&e.x<(a.x-o.x)*(e.y-o.y)/(a.y-o.y)+o.x&&(u=!u)}return u}function wn(r,e){let i=!1;for(let o=0,a=r.length-1;o<r.length;a=o++){const u=r[o],h=r[a];u.y>e.y!=h.y>e.y&&e.x<(h.x-u.x)*(e.y-u.y)/(h.y-u.y)+u.x&&(i=!i)}return i}function Dr(r,e,i,o,a){for(const h of r)if(e<=h.x&&i<=h.y&&o>=h.x&&a>=h.y)return!0;const u=[new Be(e,i),new Be(e,a),new Be(o,a),new Be(o,i)];if(r.length>2){for(const h of u)if(wn(r,h))return!0}for(let h=0;h<r.length-1;h++)if(Gr(r[h],r[h+1],u))return!0;return!1}function Gr(r,e,i){const o=i[0],a=i[2];if(r.x<o.x&&e.x<o.x||r.x>a.x&&e.x>a.x||r.y<o.y&&e.y<o.y||r.y>a.y&&e.y>a.y)return!1;const u=ni(r,e,i[0]);return u!==ni(r,e,i[1])||u!==ni(r,e,i[2])||u!==ni(r,e,i[3])}function er(r,e,i,o,a,u){let h=e.y-r.y,f=r.x-e.x;if(u=u||0){const _=h*h+f*f;if(_===0)return!0;const g=Math.sqrt(_);h/=g,f/=g}return!((i.x-r.x)*h+(i.y-r.y)*f-u<0||(o.x-r.x)*h+(o.y-r.y)*f-u<0||(a.x-r.x)*h+(a.y-r.y)*f-u<0)}function $r(r,e,i,o,a,u,h){return!(er(r,e,o,a,u,h)||er(e,i,o,a,u,h)||er(i,r,o,a,u,h)||er(o,a,r,e,i,h)||er(a,u,r,e,i,h)||er(u,o,r,e,i,h))}function Tn(r,e,i){const o=e.paint.get(r).value;return o.kind==="constant"?o.value:i.programConfigurations.get(e.id).getMaxValue(r)}function zr(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function No(r,e,i,o,a){if(!e[0]&&!e[1])return r;const u=Be.convert(e)._mult(a);i==="viewport"&&u._rotate(-o);const h=[];for(let f=0;f<r.length;f++)h.push(r[f].sub(u));return h}function xl(r,e,i,o){const a=Be.convert(r)._mult(o);return e==="viewport"&&a._rotate(-i),a}let Gs,vl;function bl(r,e,i){var o=2*Math.PI*6378137/256/Math.pow(2,i);return[r*o-2*Math.PI*6378137/2,e*o-2*Math.PI*6378137/2]}pt(wr,"CircleBucket",{omit:["layers"]});class Vo{constructor(e,i,o){this.z=e,this.x=i,this.y=o,this.key=Uo(0,e,e,i,o)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){const i=this.z-e.z;return e.z===0||e.z<this.z&&e.x===this.x>>i&&e.y===this.y>>i}url(e,i){const o=(function(u,h,f){var _=bl(256*u,256*(h=Math.pow(2,f)-h-1),f),g=bl(256*(u+1),256*(h+1),f);return _[0]+","+_[1]+","+g[0]+","+g[1]})(this.x,this.y,this.z),a=(function(u,h,f){let _,g="";for(let v=u;v>0;v--)_=1<<v-1,g+=(h&_?1:0)+(f&_?2:0);return g})(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",a).replace("{bbox-epsg-3857}",o)}toString(){return"".concat(this.z,"/").concat(this.x,"/").concat(this.y)}}class As{constructor(e,i){this.wrap=e,this.canonical=i,this.key=Uo(e,i.z,i.z,i.x,i.y)}}class gn{constructor(e,i,o,a,u){this.overscaledZ=e,this.wrap=i,this.canonical=new Vo(o,+a,+u),this.key=i===0&&e===o?this.canonical.key:Uo(i,e,o,a,u)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new gn(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new gn(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return Uo(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const o=this.canonical.z-e;return Uo(this.wrap*+i,e,e,this.canonical.x>>o,this.canonical.y>>o)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new gn(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,o=2*this.canonical.x,a=2*this.canonical.y;return[new gn(i,this.wrap,i,o,a),new gn(i,this.wrap,i,o+1,a),new gn(i,this.wrap,i,o,a+1),new gn(i,this.wrap,i,o+1,a+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new gn(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new gn(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new As(this.wrap,this.canonical)}toString(){return"".concat(this.overscaledZ,"/").concat(this.canonical.x,"/").concat(this.canonical.y)}}function Uo(r,e,i,o,a){const u=1<<Math.min(i,22);let h=u*(a%u)+o%u;return r&&i<22&&(h+=u*u*((r<0?-2*r-1:2*r)%(1<<2*(22-i)))),16*(32*h+i)+(e-i)}const za=[r=>{let e=r.canonical.x-1,i=r.wrap;return e<0&&(e=(1<<r.canonical.z)-1,i--),new gn(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>{let e=r.canonical.x+1,i=r.wrap;return e===1<<r.canonical.z&&(e=0,i++),new gn(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>new gn(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,(r.canonical.y===0?1<<r.canonical.z:r.canonical.y)-1),r=>new gn(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y===(1<<r.canonical.z)-1?0:r.canonical.y+1)];pt(Vo,"CanonicalTileID"),pt(gn,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const pp=ai([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Lu}=pp,Ab=ai([{name:"a_pos_3",components:3,type:"Int16"}]);var $g=ai([{name:"a_pos",type:"Int16",components:2}]);function mp(r){return r*_o/T}const Mb=[new ri([p,p,p],[m,m,m]),new ri([p,p,p],[0,0,m]),new ri([0,p,p],[m,0,m]),new ri([p,0,p],[0,m,m]),new ri([0,0,p],[m,m,m])];function Zg(r,e,i,o=!0){const a=Wi([],r._camera.position,r.worldSize),u=[e,i,1,1];pn(u,u,r.pixelMatrixInverse),uo(u,u,1/u[3]);const h=Oi([],Pr([],u,a)),f=r.globeMatrix,_=[f[12],f[13],f[14]],g=Pr([],_,a),v=yn(g),b=Oi([],g),w=r.worldSize/(2*Math.PI),I=Gi(b,h),A=Math.asin(w/v);if(A<Math.acos(I)){if(!o)return null;const Me=[],ye=[];Wi(Me,h,v/I),Oi(ye,Pr(ye,Me,g)),Oi(h,Er(h,g,Wi(h,ye,Math.tan(A)*v)))}const P=[];new Kt(a,h).closestPointOnSphere(_,w,P);const D=Oi([],Ur(f,0)),L=Oi([],Ur(f,1)),V=Oi([],Ur(f,2)),j=Gi(D,P),H=Gi(L,P),te=Gi(V,P),K=Jr(Math.asin(-H/w));let oe=Jr(Math.atan2(j,te));oe=r.center.lng+(function(Me,ye){const Ce=(ye-Me+180)%360-180;return Ce<-180?Ce+360:Ce})(r.center.lng,oe);const le=N(oe),ue=B(k(K),0,1);return new _e(le,ue)}class Cb{constructor(e,i,o){this.a=Pr([],e,o),this.b=Pr([],i,o),this.center=o;const a=Oi([],this.a),u=Oi([],this.b);this.angle=Math.acos(Gi(a,u))}}function i_(r,e){if(r.angle===0)return null;let i;return i=r.a[e]===0?1/r.angle*.5*Math.PI:1/r.angle*Math.atan(r.b[e]/r.a[e]/Math.sin(r.angle)-1/Math.tan(r.angle)),i<0||i>1?null:(function(o,a,u,h){const f=Math.sin(u);return o*(Math.sin((1-h)*u)/f)+a*(Math.sin(h*u)/f)})(r.a[e],r.b[e],r.angle,B(i,0,1))+r.center[e]}function ca(r){if(r.z<=1)return Mb[r.z+2*r.y+r.x];const e=r_(_p(r));return ri.fromPoints(e)}function La(r,e,i){return Wi(r,r,1-i),Fn(r,r,e,i)}function Wg(r,e,i){for(const o of r)nr(o,o,e),Wi(o,o,i)}function Xg(r,e,i,o){const a=e/r.worldSize,u=r.globeMatrix;if(i.z<=1){const ue=ca(i).getCorners();return Wg(ue,u,a),ri.fromPoints(ue)}const h=_p(i,o),f=r_(h,_o+mp(r._tileCoverLift));Wg(f,u,a);const _=Number.MAX_VALUE,g=[-_,-_,-_],v=[_,_,_];if(h.contains(r.center)){for(const ye of f)lo(v,v,ye),xn(g,g,ye);g[2]=0;const ue=r.point,Me=[ue.x*a,ue.y*a,0];return lo(v,v,Me),xn(g,g,Me),new ri(v,g)}if(r._tileCoverLift>0){for(const ue of f)lo(v,v,ue),xn(g,g,ue);return new ri(v,g)}const b=[u[12]*a,u[13]*a,u[14]*a],w=h.getCenter(),I=B(r.center.lat,-Z,Z),A=B(w.lat,-Z,Z),P=N(r.center.lng),D=k(I);let L=P-N(w.lng);const V=D-k(A);L>.5?L-=1:L<-.5&&(L+=1);let j=0;Math.abs(L)>Math.abs(V)?j=L>=0?1:3:(j=V>=0?0:2,Fn(b,b,[u[4]*a,u[5]*a,u[6]*a],-Math.sin(ii(V>=0?h.getSouth():h.getNorth()))*_o));const H=f[j],te=f[(j+1)%4],K=new Cb(H,te,b),oe=[i_(K,0)||H[0],i_(K,1)||H[1],i_(K,2)||H[2]],le=wl(r.zoom);if(le>0){const ue=(function({x:ye,y:Ce,z:Oe},Ne,Ye,He,Fe){const Ge=1/(1<<Oe);let Ie=ye*Ge,Se=Ie+Ge,Ue=Ce*Ge,Ze=Ue+Ge,ke=0;const ft=(Ie+Se)/2-He;return ft>.5?ke=-1:ft<-.5&&(ke=1),Ie=((Ie+ke)*Ne-(He*=Ne))*Ye+He,Se=((Se+ke)*Ne-He)*Ye+He,Ue=(Ue*Ne-(Fe*=Ne))*Ye+Fe,Ze=(Ze*Ne-Fe)*Ye+Fe,[[Ie,Ze,0],[Se,Ze,0],[Se,Ue,0],[Ie,Ue,0]]})(i,e,r._pixelsPerMercatorPixel,P,D);for(let ye=0;ye<f.length;ye++)La(f[ye],ue[ye],le);const Me=Er([],ue[j],ue[(j+1)%4]);Wi(Me,Me,.5),La(oe,Me,le)}for(const ue of f)lo(v,v,ue),xn(g,g,ue);return v[2]=Math.min(H[2],te[2]),lo(v,v,oe),xn(g,g,oe),new ri(v,g)}function _p({x:r,y:e,z:i},o=!1){const a=1/(1<<i),u=new M($(r*a),e===(1<<i)-1&&o?-90:G((e+1)*a)),h=new M($((r+1)*a),e===0&&o?90:G(e*a));return new E(u,h)}function r_(r,e=_o){const i=ii(r.getNorth()),o=ii(r.getSouth()),a=Math.cos(i),u=Math.cos(o),h=Math.sin(i),f=Math.sin(o),_=r.getWest(),g=r.getEast();return[y(u,f,_,e),y(u,f,g,e),y(a,h,g,e),y(a,h,_,e)]}function wd(r,e,i,o){const a=1<<i.z,u=(r/Je+i.x)/a;return x(G((e/Je+i.y)/a),$(u),o)}function gp({min:r,max:e}){return n/Math.max(e[0]-r[0],e[1]-r[1],e[2]-r[2])}const Yg=new Float64Array(16);function yp(r){const e=gp(r),i=Si(Yg,[e,e,e]);return wi(i,i,Qn([],r.min))}function n_(r){const e=(o=r.min,(i=Yg)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=o[0],i[13]=o[1],i[14]=o[2],i[15]=1,i);var i,o;const a=1/gp(r);return Ci(e,e,[a,a,a])}function o_(r){const e=Je/(2*Math.PI);return r/(2*Math.PI)/e}function Kg(r,e){return Je/(512*Math.pow(2,r))*gp(ca(e))}function Jg(r,e,i,o,a){const u=o_(i),h=[r,e,-i/(2*Math.PI)],f=Dt(new Float64Array(16));return wi(f,f,h),Ci(f,f,[u,u,u]),tr(f,f,ii(-a)),vi(f,f,ii(-o)),f}function wl(r){return X(l,t,r)}function Qg(r,e){const i=x(e.lat,e.lng),o=(function(A){const P=x(A._center.lat,A._center.lng);let D=Cr([],rr(0,1,0),P);const L=hr([],-A.angle,P);D=nr(D,D,L),hr(L,-A._pitch,D);const V=Oi([],P);return Wi(V,V,mp(A.cameraToCenterDistance/A.pixelsPerMeter)),nr(V,V,L),Er([],P,V)})(r);return h=(a=en([],o,i))[0],f=a[1],_=a[2],g=(u=i)[0],v=u[1],b=u[2],I=(w=Math.sqrt((h*h+f*f+_*_)*(g*g+v*v+b*b)))&&Gi(a,u)/w,Math.acos(Math.min(Math.max(I,-1),1));var a,u,h,f,_,g,v,b,w,I}function s_(r,e){return Qg(r,e)>Math.PI/2*1.01}const ey=ii(85),Pb=Math.cos(ey),Rb=Math.sin(ey),Db=Vi(),ty=r=>{const e=[];return r.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),r.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function iy(r,e,i,o,a,u,h,f,_){if(u&&r.queryGeometry.isAboveHorizon)return!1;u&&(_*=r.pixelToTileUnitsFactor);const g=r.tileID.canonical,v=i.projection.upVectorScale(g,i.center.lat,i.worldSize).metersToTile;for(const b of e)for(const w of b){const I=w.add(f),A=a&&i.elevation?i.elevation.exaggeration()*a.getElevationAt(I.x,I.y,!0):0,P=i.projection.projectTilePoint(I.x,I.y,g);if(A>0){const j=i.projection.upVector(g,I.x,I.y);P.x+=j[0]*v*A,P.y+=j[1]*v*A,P.z+=j[2]*v*A}const D=u?I:zb(P.x,P.y,P.z,o),L=u?r.tilespaceRays.map((j=>Ob(j,A))):r.queryGeometry.screenGeometry,V=pn([],[P.x,P.y,P.z,1],o);if(!h&&u?_*=V[3]/i.cameraToCenterDistance:h&&!u&&(_*=i.cameraToCenterDistance/V[3]),u){const j=G((w.y/Je+g.y)/(1<<g.z));_/=i.projection.pixelsPerMeter(j,1)/U(1,j)}if(Mr(L,D,_))return!0}return!1}function zb(r,e,i,o){const a=pn([],[r,e,i,1],o);return new Be(a[0]/a[3],a[1]/a[3])}const ry=rr(0,0,0),Lb=rr(0,0,1);function Ob(r,e){const i=Jt();return ry[2]=e,r.intersectsPlane(ry,Lb,i),new Be(i[0],i[1])}class ny extends wr{}let oy,sy,ay,ly;function cy(r,{width:e,height:i},o,a){if(a){if(a instanceof Uint8ClampedArray)a=new Uint8Array(a.buffer);else if(a.length!==e*i*o)throw new RangeError("mismatched image size")}else a=new Uint8Array(e*i*o);return r.width=e,r.height=i,r.data=a,r}function uy(r,e,i){const{width:o,height:a}=e;o===r.width&&a===r.height||(a_(r,e,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,o),height:Math.min(r.height,a)},i,null),r.width=o,r.height=a,r.data=e.data)}function a_(r,e,i,o,a,u,h,f){if(a.width===0||a.height===0)return e;if(a.width>r.width||a.height>r.height||i.x>r.width-a.width||i.y>r.height-a.height)throw new RangeError("out of range source coordinates for image copy");if(a.width>e.width||a.height>e.height||o.x>e.width-a.width||o.y>e.height-a.height)throw new RangeError("out of range destination coordinates for image copy");const _=r.data,g=e.data,v=u===4&&f;for(let b=0;b<a.height;b++){const w=((i.y+b)*r.width+i.x)*u,I=((o.y+b)*e.width+o.x)*u;if(v)for(let A=0;A<a.width;A++){const P=w+A*u+3,D=I+A*u;g[D+0]=255,g[D+1]=255,g[D+2]=255,g[D+3]=_[P]}else if(h)for(let A=0;A<a.width;A++){const P=w+A*u,D=I+A*u,L=new Ui(_[P+0]/255,_[P+1]/255,_[P+2]/255,_[P+3]).toNonPremultipliedRenderColor(h).toArray();g[D+0]=L[0],g[D+1]=L[1],g[D+2]=L[2],g[D+3]=L[3]}else for(let A=0;A<a.width*u;A++)g[I+A]=_[w+A]}return e}pt(ny,"HeatmapBucket",{omit:["layers"]});class Tl{constructor(e,i){cy(this,e,1,i)}resize(e){uy(this,new Tl(e),1)}clone(){return new Tl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,o,a,u){a_(e,i,o,a,u,1,null)}}class Hn{constructor(e,i){cy(this,e,4,i)}resize(e){uy(this,new Hn(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Hn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,o,a,u,h,f){a_(e,i,o,a,u,4,h,f)}}class hy{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function Td(r){const e={},i=r.resolution||256,o=r.clips?r.clips.length:1,a=r.image||new Hn({width:i,height:o}),u=(h,f,_)=>{e[r.evaluationKey]=_;const g=r.expression.evaluate(e),v=g?g.toNonPremultipliedRenderColor(null):null;v&&(a.data[h+f+0]=Math.floor(255*v.r),a.data[h+f+1]=Math.floor(255*v.g),a.data[h+f+2]=Math.floor(255*v.b),a.data[h+f+3]=Math.floor(255*v.a))};if(r.clips)for(let h=0,f=0;h<o;++h,f+=4*i)for(let _=0,g=0;_<i;_++,g+=4){const v=_/(i-1),{start:b,end:w}=r.clips[h];u(f,g,b*(1-v)+w*v)}else for(let h=0,f=0;h<i;h++,f+=4)u(0,f,h/(i-1));return a}pt(Tl,"AlphaImage"),pt(Hn,"RGBAImage");const Fb=ai([{name:"a_pos",components:2,type:"Int16"}],4),kb=ai([{name:"a_road_z_offset",components:1,type:"Float32"}],4),Bb=ai([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),Nb=ai([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Ou(r,e,i=2){const o=e&&e.length,a=o?e[0]*i:r.length;let u=dy(r,0,a,i,!0);const h=[];if(!u||u.next===u.prev)return h;let f,_,g;if(o&&(u=(function(v,b,w,I){const A=[];for(let P=0,D=b.length;P<D;P++){const L=dy(v,b[P]*I,P<D-1?b[P+1]*I:v.length,I,!1);L===L.next&&(L.steiner=!0),A.push(Zb(L))}A.sort(Hb);for(let P=0;P<A.length;P++)w=qb(A[P],w);return w})(r,e,u,i)),r.length>80*i){f=r[0],_=r[1];let v=f,b=_;for(let w=i;w<a;w+=i){const I=r[w],A=r[w+1];I<f&&(f=I),A<_&&(_=A),I>v&&(v=I),A>b&&(b=A)}g=Math.max(v-f,b-_),g=g!==0?32767/g:0}return Sd(u,h,i,f,_,g,0),h}function dy(r,e,i,o,a){let u;if(a===(function(h,f,_,g){let v=0;for(let b=f,w=_-g;b<_;b+=g)v+=(h[w]-h[b])*(h[b+1]+h[w+1]),w=b;return v})(r,e,i,o)>0)for(let h=e;h<i;h+=o)u=_y(h/o|0,r[h],r[h+1],u);else for(let h=i-o;h>=e;h-=o)u=_y(h/o|0,r[h],r[h+1],u);return u&&Fu(u,u.next)&&(Ad(u),u=u.next),u}function bc(r,e){if(!r)return r;e||(e=r);let i,o=r;do if(i=!1,o.steiner||!Fu(o,o.next)&&Sn(o.prev,o,o.next)!==0)o=o.next;else{if(Ad(o),o=e=o.prev,o===o.next)break;i=!0}while(i||o!==e);return e}function Sd(r,e,i,o,a,u,h){if(!r)return;!h&&u&&(function(_,g,v,b){let w=_;do w.z===0&&(w.z=l_(w.x,w.y,g,v,b)),w.prevZ=w.prev,w.nextZ=w.next,w=w.next;while(w!==_);w.prevZ.nextZ=null,w.prevZ=null,(function(I){let A,P=1;do{let D,L=I;I=null;let V=null;for(A=0;L;){A++;let j=L,H=0;for(let K=0;K<P&&(H++,j=j.nextZ,j);K++);let te=P;for(;H>0||te>0&&j;)H!==0&&(te===0||!j||L.z<=j.z)?(D=L,L=L.nextZ,H--):(D=j,j=j.nextZ,te--),V?V.nextZ=D:I=D,D.prevZ=V,V=D;L=j}V.nextZ=null,P*=2}while(A>1)})(w)})(r,o,a,u);let f=r;for(;r.prev!==r.next;){const _=r.prev,g=r.next;if(u?Ub(r,o,a,u):Vb(r))e.push(_.i,r.i,g.i),Ad(r),r=g.next,f=g.next;else if((r=g)===f){h?h===1?Sd(r=jb(bc(r),e),e,i,o,a,u,2):h===2&&Gb(r,e,i,o,a,u):Sd(bc(r),e,i,o,a,u,1);break}}}function Vb(r){const e=r.prev,i=r,o=r.next;if(Sn(e,i,o)>=0)return!1;const a=e.x,u=i.x,h=o.x,f=e.y,_=i.y,g=o.y,v=Math.min(a,u,h),b=Math.min(f,_,g),w=Math.max(a,u,h),I=Math.max(f,_,g);let A=o.next;for(;A!==e;){if(A.x>=v&&A.x<=w&&A.y>=b&&A.y<=I&&Ed(a,f,u,_,h,g,A.x,A.y)&&Sn(A.prev,A,A.next)>=0)return!1;A=A.next}return!0}function Ub(r,e,i,o){const a=r.prev,u=r,h=r.next;if(Sn(a,u,h)>=0)return!1;const f=a.x,_=u.x,g=h.x,v=a.y,b=u.y,w=h.y,I=Math.min(f,_,g),A=Math.min(v,b,w),P=Math.max(f,_,g),D=Math.max(v,b,w),L=l_(I,A,e,i,o),V=l_(P,D,e,i,o);let j=r.prevZ,H=r.nextZ;for(;j&&j.z>=L&&H&&H.z<=V;){if(j.x>=I&&j.x<=P&&j.y>=A&&j.y<=D&&j!==a&&j!==h&&Ed(f,v,_,b,g,w,j.x,j.y)&&Sn(j.prev,j,j.next)>=0||(j=j.prevZ,H.x>=I&&H.x<=P&&H.y>=A&&H.y<=D&&H!==a&&H!==h&&Ed(f,v,_,b,g,w,H.x,H.y)&&Sn(H.prev,H,H.next)>=0))return!1;H=H.nextZ}for(;j&&j.z>=L;){if(j.x>=I&&j.x<=P&&j.y>=A&&j.y<=D&&j!==a&&j!==h&&Ed(f,v,_,b,g,w,j.x,j.y)&&Sn(j.prev,j,j.next)>=0)return!1;j=j.prevZ}for(;H&&H.z<=V;){if(H.x>=I&&H.x<=P&&H.y>=A&&H.y<=D&&H!==a&&H!==h&&Ed(f,v,_,b,g,w,H.x,H.y)&&Sn(H.prev,H,H.next)>=0)return!1;H=H.nextZ}return!0}function jb(r,e){let i=r;do{const o=i.prev,a=i.next.next;!Fu(o,a)&&py(o,i,i.next,a)&&Id(o,a)&&Id(a,o)&&(e.push(o.i,i.i,a.i),Ad(i),Ad(i.next),i=r=a),i=i.next}while(i!==r);return bc(i)}function Gb(r,e,i,o,a,u){let h=r;do{let f=h.next.next;for(;f!==h.prev;){if(h.i!==f.i&&Wb(h,f)){let _=my(h,f);return h=bc(h,h.next),_=bc(_,_.next),Sd(h,e,i,o,a,u,0),void Sd(_,e,i,o,a,u,0)}f=f.next}h=h.next}while(h!==r)}function Hb(r,e){let i=r.x-e.x;return i===0&&(i=r.y-e.y,i===0)&&(i=(r.next.y-r.y)/(r.next.x-r.x)-(e.next.y-e.y)/(e.next.x-e.x)),i}function qb(r,e){const i=(function(a,u){let h=u;const f=a.x,_=a.y;let g,v=-1/0;if(Fu(a,h))return h;do{if(Fu(a,h.next))return h.next;if(_<=h.y&&_>=h.next.y&&h.next.y!==h.y){const P=h.x+(_-h.y)*(h.next.x-h.x)/(h.next.y-h.y);if(P<=f&&P>v&&(v=P,g=h.x<h.next.x?h:h.next,P===f))return g}h=h.next}while(h!==u);if(!g)return null;const b=g,w=g.x,I=g.y;let A=1/0;h=g;do{if(f>=h.x&&h.x>=w&&f!==h.x&&fy(_<I?f:v,_,w,I,_<I?v:f,_,h.x,h.y)){const P=Math.abs(_-h.y)/(f-h.x);Id(h,a)&&(P<A||P===A&&(h.x>g.x||h.x===g.x&&$b(g,h)))&&(g=h,A=P)}h=h.next}while(h!==b);return g})(r,e);if(!i)return e;const o=my(i,r);return bc(o,o.next),bc(i,i.next)}function $b(r,e){return Sn(r.prev,r,e.prev)<0&&Sn(e.next,r,r.next)<0}function l_(r,e,i,o,a){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-i)*a|0)|r<<8))|r<<4))|r<<2))|r<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-o)*a|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Zb(r){let e=r,i=r;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==r);return i}function fy(r,e,i,o,a,u,h,f){return(a-h)*(e-f)>=(r-h)*(u-f)&&(r-h)*(o-f)>=(i-h)*(e-f)&&(i-h)*(u-f)>=(a-h)*(o-f)}function Ed(r,e,i,o,a,u,h,f){return!(r===h&&e===f)&&fy(r,e,i,o,a,u,h,f)}function Wb(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!(function(i,o){let a=i;do{if(a.i!==i.i&&a.next.i!==i.i&&a.i!==o.i&&a.next.i!==o.i&&py(a,a.next,i,o))return!0;a=a.next}while(a!==i);return!1})(r,e)&&(Id(r,e)&&Id(e,r)&&(function(i,o){let a=i,u=!1;const h=(i.x+o.x)/2,f=(i.y+o.y)/2;do a.y>f!=a.next.y>f&&a.next.y!==a.y&&h<(a.next.x-a.x)*(f-a.y)/(a.next.y-a.y)+a.x&&(u=!u),a=a.next;while(a!==i);return u})(r,e)&&(Sn(r.prev,r,e.prev)||Sn(r,e.prev,e))||Fu(r,e)&&Sn(r.prev,r,r.next)>0&&Sn(e.prev,e,e.next)>0)}function Sn(r,e,i){return(e.y-r.y)*(i.x-e.x)-(e.x-r.x)*(i.y-e.y)}function Fu(r,e){return r.x===e.x&&r.y===e.y}function py(r,e,i,o){const a=vp(Sn(r,e,i)),u=vp(Sn(r,e,o)),h=vp(Sn(i,o,r)),f=vp(Sn(i,o,e));return a!==u&&h!==f||!(a!==0||!xp(r,i,e))||!(u!==0||!xp(r,o,e))||!(h!==0||!xp(i,r,o))||!(f!==0||!xp(i,e,o))}function xp(r,e,i){return e.x<=Math.max(r.x,i.x)&&e.x>=Math.min(r.x,i.x)&&e.y<=Math.max(r.y,i.y)&&e.y>=Math.min(r.y,i.y)}function vp(r){return r>0?1:r<0?-1:0}function Id(r,e){return Sn(r.prev,r,r.next)<0?Sn(r,e,r.next)>=0&&Sn(r,r.prev,e)>=0:Sn(r,e,r.prev)<0||Sn(r,r.next,e)<0}function my(r,e){const i=c_(r.i,r.x,r.y),o=c_(e.i,e.x,e.y),a=r.next,u=e.prev;return r.next=e,e.prev=r,i.next=a,a.prev=i,o.next=i,i.prev=o,u.next=o,o.prev=u,o}function _y(r,e,i,o){const a=c_(r,e,i);return o?(a.next=o.next,a.prev=o,o.next.prev=a,o.next=a):(a.prev=a,a.next=a),a}function Ad(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function c_(r,e,i){return{i:r,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Md(r,e){const i=r.length;if(i<=1)return[r];const o=[];let a,u;for(let h=0;h<i;h++){const f=si(r[h]);f!==0&&(r[h].area=Math.abs(f),u===void 0&&(u=f<0),u===f<0?(a&&o.push(a),a=[r[h]]):a.push(r[h]))}if(a&&o.push(a),e>1)for(let h=0;h<o.length;h++)o[h].length<=e||(Fs(o[h],e,1,o[h].length-1,Xb),o[h]=o[h].slice(0,e));return o}function Xb(r,e){return e.area-r.area}function gy(r,e,i=1){if(!r)return null;const o=typeof r=="string"?po.from(r).getPrimary():r.getPrimary(),a=typeof r=="string"?null:r.getSecondary();for(const u of[o,a]){if(!u)continue;const h=u.id.toString();e.has(h)||e.set(h,[]),u.scaleSelf(i),e.get(h).push(u)}return{primary:o.toString(),secondary:a?a.toString():null}}function u_(r,e,i,o){const a=o.patternDependencies;let u=!1;for(const h of e){const f=h.paint.get("".concat(r,"-pattern"));f.isConstant()||(u=!0),gy(f.constantOr(null),a,i)&&(u=!0)}return u}function h_(r,e,i,o,a,u){const h=u.patternDependencies;for(const f of e){const _=f.paint.get("".concat(r,"-pattern")).value;if(_.kind!=="constant"){let g=_.evaluate({zoom:o},i,{},u.availableImages);g=g&&g.name?g.name:g;const v=gy(g,h,a);if(!v)continue;const{primary:b,secondary:w}=v;b&&(i.patterns[f.id]=[b,w].filter(Boolean))}}return i}class yy{constructor(){this.polygons=new Map}add(e,...i){const o=this.polygons.get(e);o?o.push(...i):this.polygons.set(e,i)}merge(e){for(const[i,o]of e.polygons)this.add(i,...o)}}class Oa{constructor(){this.portals=[]}static isOnBorder(e,i){return e<=0&&i<=0||e>=Je&&i>=Je}static evaluate(e){if(e.length===0)return new Oa;let i=[];for(const _ of e)i.push(..._.portals);if(i.length===0)return new Oa;for(const _ of i){const g=_.va,v=_.vb;(Oa.isOnBorder(g.x,v.x)||Oa.isOnBorder(g.y,v.y))&&(_.type="border")}const o=i.filter((_=>_.type!=="unevaluated")),a=i.filter((_=>_.type==="unevaluated"));if(a.length===0)return new Oa;a.sort(((_,g)=>_.hash===g.hash?_.isTunnel===g.isTunnel?0:_.isTunnel?-1:1:_.hash<g.hash?1:-1)),i=o.concat(a);let u=o.length,h=u,f=u;do if(h++,h===i.length||i[u].hash!==i[h].hash){if(h-u==2){f<u&&(i[f]=i[u],i[u]=null);const _=i[f],g=i[h-1];_.type=_.isTunnel!==g.isTunnel?"tunnel":"polygon",_.connection={a:_.connection.a,b:g.connection.a},f++}u=h}while(u!==i.length);return i.splice(f),i.sort(((_,g)=>_.hash<g.hash?1:-1)),{portals:i}}}pt(Oa,"ElevationPortalGraph"),pt(yy,"ElevationPolygons");class Yb{constructor(e,i,o){this.outPositions=e,this.outNormals=i,this.outIndices=o,this.vertexLookup=new Map}addVertex(e,i,o){let a=e[2];o!=null&&(a*=o);const u="".concat(e[0],",").concat(e[1],",").concat(e[2],",").concat(i[0],",").concat(i[1],",").concat(i[2]),h=this.vertexLookup.get(u);if(h!=null)return h;const f=this.outPositions.length;this.vertexLookup.set(u,f);const _=Math.trunc(16384*i[0]),g=Math.trunc(16384*i[1]),v=Math.trunc(16384*i[2]);return this.outPositions.emplaceBack(e[0],e[1],a),this.outNormals.emplaceBack(_,g,v),f}addTriangle(e,i,o){this.outIndices.emplaceBack(e,i,o)}addTriangles(e,i,o){if(e.length===0)return;const a=o.length===1,u=Jt(),h=Jt();for(let f=0;f<e.length;f+=3){const _=i[e[f+0]],g=i[e[f+1]],v=i[e[f+2]],b=a?o[0]:o[e[f+1]],w=a?o[0]:o[e[f+2]];Li(u,_.x,_.y,a?o[0]:o[e[f+0]]);const I=this.addVertex(u,h);Li(u,g.x,g.y,b);const A=this.addVertex(u,h);Li(u,v.x,v.y,w);const P=this.addVertex(u,h);this.outIndices.emplaceBack(I,A,P)}}addQuad(e,i,o,a,u,h){const f=this.addVertex(e,u,h),_=this.addVertex(i,u,h),g=this.addVertex(o,u,h),v=this.addVertex(a,u,h);this.addTriangle(f,_,g),this.addTriangle(g,v,f)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}}class jo{constructor(e,i,o,a){this.unevaluatedPortals=new Oa,this.portalPolygons=new yy,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new nd,this.vertexNormals=new od,this.indexArray=new vr,this.tileToMeters=re(e),this.bridgeProgramConfigurations=new _s(i,{zoom:o,lut:a},(u=>u!=="fill-tunnel-structure-color")),this.tunnelProgramConfigurations=new _s(i,{zoom:o,lut:a},(u=>u!=="fill-bridge-guard-rail-color"))}addVertices(e,i){const o=this.unevalVertices.length;for(let a=0;a<e.length;a++)this.unevalVertices.push(e[a]),this.unevalHeights.push(i[a]);return o}addTriangles(e,i,o){const a=o?this.unevalTunnelTriangles:this.unevalTriangles;for(const u of e)a.push(u+i)}addRenderableRing(e,i,o,a,u,h){const f=[new Be(u.min.x,u.min.y),new Be(u.max.x,u.min.y),new Be(u.max.x,u.max.y),new Be(u.min.x,u.max.y)];for(let _=0;_<o-1;_++){const g=i+_,v=g+1,b=this.unevalVertices[g],w=this.unevalVertices[v];if(!(b.x>=u.min.x&&b.x<=u.max.x&&b.y>=u.min.y&&b.y<=u.max.y||w.x>=u.min.x&&w.x<=u.max.x&&w.y>=u.min.y&&w.y<=u.max.y||Gr(b,w,f))||this.isOnBorder(b.x,w.x)||this.isOnBorder(b.y,w.y))continue;const I=jo.computeEdgeHash(this.unevalVertices[g],this.unevalVertices[v]);let A,P=this.vertexHashLookup.get(jo.computePosHash(b));P!=null?A=P.next:(P=this.vertexHashLookup.get(jo.computePosHash(w)),A=P!=null?P.prev:I),this.unevalEdges.push({polygonIdx:e,a:g,b:v,hash:I,portalHash:A,isTunnel:a,type:"unevaluated",featureInfo:h})}}addPortalCandidates(e,i,o,a,u){if(i.length===0)return;this.portalPolygons.add(e,{geometry:i,zLevel:u});const h=i[0];this.vertexHashLookup.clear();let f=jo.computeEdgeHash(h[h.length-2],h[h.length-1]);for(let _=0;_<h.length-1;_++){const g=h[_+0],v=h[_+1],b=yo(v.x-g.x,v.y-g.y),w=cr(b);if(w===0)continue;let I="unevaluated";const A=a.pointElevation(g),P=a.pointElevation(v);Math.abs(A)<.01&&Math.abs(P)<.01?I="entrance":(this.isOnBorder(g.x,v.x)||this.isOnBorder(g.y,v.y))&&(I="border");const D=jo.computeEdgeHash(g,v);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:g,vb:v,vab:b,length:w,hash:D,isTunnel:o,type:I});const L=jo.computePosHash(g);this.vertexHashLookup.set(L,{prev:f,next:D}),f=D}}construct(e){if(this.unevalVertices.length===0)return;const i=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),o=w=>{w.primitiveLength=this.indexArray.length-w.primitiveOffset},a=new Yb(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const u=i(),h=i(),f=i(),_=(w,I)=>{w.sort(((P,D)=>P.type===I&&D.type!==I?-1:P.type!==I&&D.type===I?1:0));const A=w.findIndex((P=>P.type!==I));return A>=0?A:w.length};let g=0;this.unevalEdges.length>0&&(g=_(this.unevalEdges,"none"),this.constructBridgeStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:g},this.tileToMeters)),o(f);const v=i(),b=i();if(this.unevalEdges.length>0){const w=this.unevalEdges.splice(g),I=_(w,"tunnel")+g;this.unevalEdges.push(...w),this.constructTunnelStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:g},{min:g,max:I})}o(v),a.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),o(b),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),o(h),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),o(u),this.maskSegments=Ar.simpleSegment(0,b.primitiveOffset,0,b.primitiveLength),this.depthSegments=Ar.simpleSegment(0,h.primitiveOffset,0,h.primitiveLength),this.renderableBridgeSegments=Ar.simpleSegment(0,f.primitiveOffset,0,f.primitiveLength),this.renderableTunnelSegments=Ar.simpleSegment(0,v.primitiveOffset,0,v.primitiveLength),this.shadowCasterSegments=Ar.simpleSegment(0,u.primitiveOffset,0,u.primitiveLength)}update(e,i,o,a,u,h,f,_){this.bridgeProgramConfigurations.updatePaintArrays(e,i,u,o,a,h,f,_),this.tunnelProgramConfigurations.updatePaintArrays(e,i,u,o,a,h,f,_)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,Bb.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,Nb.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,i,o,a,u){const h=(f,_)=>{for(let g=0;g<_.length-1;g++){const v=_[g].featureIndex,b=_[g+1].vertexStart,w=e.feature(v);f.populatePaintArrays(b,w,v,{},o,i,a,void 0,u)}};h(this.bridgeProgramConfigurations,this.bridgeFeatureSections),h(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,i,o,a,u){const h=new Map;for(let f=a;f<u;f++){const _=o[f],g=_.a,v=_.b,b=jo.computePosHash(e[g]),w=jo.computePosHash(e[v]);let I=h.get(b);I||(I={},h.set(b,I));let A=h.get(w);A||(A={},h.set(w,A)),i[g]<=0&&i[v]<=0||(I.to=v,A.from=g)}return h}isTerminalVertex(e,i){const o=jo.computePosHash(this.unevalVertices[e]),a=i.get(o);return!a||!a.from||!a.to}constructBridgeStructures(e,i,o,a,u,h){e.clearVertexLookup();const f=this.computeVertexConnections(i,o,a,u.min,u.max),_=1/h,g=.5*_,v=(Ye,He)=>Li(Ye,i[He].x,i[He].y,o[He]*_),b=Jt(),w=Jt(),I=Jt(),A=Jt(),P=Jt(),D=(Ye,He)=>{const Fe=f.get(jo.computePosHash(i[He])),Ge=Fe.from,Ie=Fe.to;if(!Ge||!Ie)return;v(b,Ge),v(w,He),v(I,Ie),An(A),co(b,w)||(Pr(P,w,b),Oi(A,P)),co(I,w)||(Pr(P,I,w),Er(A,A,Oi(P,P)));const Se=Bn(A);return Se>0?Wi(Ye,A,1/Se):void 0};let L=Number.POSITIVE_INFINITY;this.sortSubarray(a,u.min,u.max,((Ye,He)=>Ye.featureInfo.featureIndex-He.featureInfo.featureIndex));const V=Jt(),j=Jt(),H=Jt(),te=Jt(),K=Jt(),oe=Jt(),le=Jt(),ue=Jt(),Me=Jt(),ye=[Jt(),Jt(),Jt(),Jt()],Ce=[Jt(),Jt(),Jt(),Jt()],Oe=[{coord:new Be(0,0),height:0},{coord:new Be(0,0),height:0}],Ne=(Ye,He)=>Ye>He;for(let Ye=u.min;Ye<u.max;Ye++){const He=a[Ye];if(!He.featureInfo.guardRailEnabled||!this.prepareEdgePoints(Oe,i,o,He,Ne))continue;const[Fe,Ge]=Oe;if(Li(V,Fe.coord.x,Fe.coord.y,_*Fe.height),Li(j,Ge.coord.x,Ge.coord.y,_*Ge.height),co(V,j))continue;Pr(H,j,V),Oi(H,H);const Ie=D(ue,He.a)||H,Se=D(Me,He.b)||H;Li(te,Ie[1],-Ie[0],0),Oi(te,te),Li(K,Se[1],-Se[0],0),Oi(K,K),Cr(ue,te,Ie),Oi(oe,ue),Cr(ue,K,Se),Oi(le,ue),Er(ye[0],V,Wi(ue,Pr(ue,te,oe),g)),Er(ye[1],V,Wi(ue,Er(ue,te,oe),g)),Er(ye[2],V,Wi(ue,oe,g)),ye[3]=V,Er(Ce[0],j,Wi(ue,Pr(ue,K,le),g)),Er(Ce[1],j,Wi(ue,Er(ue,K,le),g)),Er(Ce[2],j,Wi(ue,le,g)),Ce[3]=j,L=this.addFeatureSection(He.featureInfo.featureIndex,L,this.bridgeFeatureSections,e);const Ue=e.addVertex(ye[0],te,h),Ze=e.addVertex(ye[1],te,h),ke=e.addVertex(Ce[0],K,h),ft=e.addVertex(Ce[1],K,h);e.addTriangle(Ue,Ze,ke),e.addTriangle(Ze,ft,ke);const _t=e.addVertex(ye[1],oe,h),ut=e.addVertex(ye[2],oe,h),ot=e.addVertex(Ce[1],le,h),jt=e.addVertex(Ce[2],le,h);e.addTriangle(_t,ut,ot),e.addTriangle(ut,jt,ot),Qn(te,te),Qn(K,K);const at=e.addVertex(ye[2],te,h),Et=e.addVertex(ye[3],te,h),Ht=e.addVertex(Ce[2],K,h),oi=e.addVertex(Ce[3],K,h);e.addTriangle(at,Et,Ht),e.addTriangle(Et,oi,Ht);const yi=this.isTerminalVertex(He.a,f),$t=this.isTerminalVertex(He.b,f);Fe.height<.01&&yi&&e.addQuad(ye[3],ye[2],ye[1],ye[0],Qn(Ie,Ie),h),Ge.height<.01&&$t&&e.addQuad(Ce[0],Ce[1],Ce[2],Ce[3],Se,h)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,i,o,a,u,h){e.clearVertexLookup();let f=Number.POSITIVE_INFINITY;const _=(L,V)=>L.featureInfo.featureIndex-V.featureInfo.featureIndex;this.sortSubarray(a,u.min,u.max,_),this.sortSubarray(a,h.min,h.max,_);const g=L=>Oi(L,L),v=[{coord:new Be(0,0),height:0},{coord:new Be(0,0),height:0}],b=(L,V)=>L<V,w=Jt(),I=Jt(),A=Jt(),P=Jt(),D=Jt();for(let L=u.min;L<u.max;L++){if(!this.prepareEdgePoints(v,i,o,a[L],b))continue;const[V,j]=v,H=g(Li(D,-(j.coord.y-V.coord.y),j.coord.x-V.coord.x,0));f=this.addFeatureSection(a[L].featureInfo.featureIndex,f,this.tunnelFeatureSections,e),e.addQuad(Li(w,V.coord.x,V.coord.y,V.height),Li(I,j.coord.x,j.coord.y,j.height),Li(A,j.coord.x,j.coord.y,a[L].isTunnel?-.1:0),Li(P,V.coord.x,V.coord.y,a[L].isTunnel?-.1:0),H)}for(let L=h.min;L<h.max;L++){const V=a[L];V.isTunnel&&([V.a,V.b]=[V.b,V.a]);const j=i[V.a],H=i[V.b],te=g(Li(D,-(H.y-j.y),H.x-j.x,0));f=this.addFeatureSection(V.featureInfo.featureIndex,f,this.tunnelFeatureSections,e),e.addQuad(Li(w,H.x,H.y,0),Li(I,j.x,j.y,0),Li(A,j.x,j.y,o[V.a]+4),Li(P,H.x,H.y,o[V.b]+4),te),e.addQuad(Li(w,j.x,j.y,0),Li(I,H.x,H.y,0),Li(A,H.x,H.y,o[V.b]+4),Li(P,j.x,j.y,o[V.a]+4),te)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,i,o,a){e.coord.x=i,e.coord.y=o,e.height=a}prepareEdgePoints(e,i,o,a,u){let h=i[a.a].x,f=i[a.a].y,_=i[a.b].x,g=i[a.b].y,v=o[a.a],b=o[a.b];const w=u(v,0),I=u(b,0);if(w&&I)return this.setElevatedPoint(e[0],h,f,v),this.setElevatedPoint(e[1],_,g,b),!0;if(!w&&!I)return!1;if(w){if(!I){const A=b/(b-v);_=Ft(_,h,A),g=Ft(g,f,A),b=Ft(b,v,A)}}else{const A=v/(v-b);h=Ft(h,_,A),f=Ft(f,g,A),v=Ft(v,b,A)}return this.setElevatedPoint(e[0],h,f,v),this.setElevatedPoint(e[1],_,g,b),!0}prepareEdges(e,i){if(i.length===0)return;i.sort(((f,_)=>f.hash===_.hash?_.polygonIdx-f.polygonIdx:_.hash>f.hash?1:-1));let o=0,a=0,u=0,h=i[o].polygonIdx;do a++,(a===i.length||i[o].hash!==i[a].hash)&&((a-o==1||i[a-1].polygonIdx!==h)&&(u<o&&(i[u]=i[o],i[o]=null),i[u].type="none",u++),o=a,o!==i.length&&(h=i[o].polygonIdx));while(o!==i.length);if(i.splice(u),i.length!==0&&e.length!==0){i.sort(((g,v)=>g.portalHash<v.portalHash?1:-1));let f=0,_=0;for(;f!==i.length&&_!==e.length;){const g=i[f],v=e[_];g.portalHash>v.hash?f++:v.hash>g.portalHash?_++:(g.type=v.type,f++)}}}isOnBorder(e,i){return e<=0&&i<=0||e>=Je&&i>=Je}addFeatureSection(e,i,o,a){return e!==i&&(i=e,o.push({featureIndex:e,vertexStart:a.getVertexCount()}),a.clearVertexLookup()),i}sortSubarray(e,i,o,a){const u=e.slice(i,o);u.sort(a),e.splice(i,u.length,...u)}static computeEdgeHash(e,i){return(e.y===i.y&&e.x>i.x||e.y>i.y)&&([e,i]=[i,e]),BigInt(jo.computePosHash(e))<<BigInt(32)|BigInt(jo.computePosHash(i))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var xy,vy={exports:{}},by=(xy||(xy=1,(function(r,e){(function(i){function o(J,W){return J>W?1:J<W?-1:0}var a=function(J,W){J===void 0&&(J=o),W===void 0&&(W=!1),this._compare=J,this._root=null,this._size=0,this._noDuplicates=!!W},u={size:{configurable:!0}};function h(J,W,Re,it,De){var st=De-it;if(st>0){var wt=it+Math.floor(st/2),vt={key:W[wt],data:Re[wt],parent:J};return vt.left=h(vt,W,Re,it,wt),vt.right=h(vt,W,Re,wt+1,De),vt}return null}function f(J,W,Re,it,De){if(!(Re>=it)){for(var st=J[Re+it>>1],wt=Re-1,vt=it+1;;){do wt++;while(De(J[wt],st)<0);do vt--;while(De(J[vt],st)>0);if(wt>=vt)break;var Zt=J[wt];J[wt]=J[vt],J[vt]=Zt,Zt=W[wt],W[wt]=W[vt],W[vt]=Zt}f(J,W,Re,vt,De),f(J,W,vt+1,it,De)}}a.prototype.rotateLeft=function(J){var W=J.right;W&&(J.right=W.left,W.left&&(W.left.parent=J),W.parent=J.parent),J.parent?J===J.parent.left?J.parent.left=W:J.parent.right=W:this._root=W,W&&(W.left=J),J.parent=W},a.prototype.rotateRight=function(J){var W=J.left;W&&(J.left=W.right,W.right&&(W.right.parent=J),W.parent=J.parent),J.parent?J===J.parent.left?J.parent.left=W:J.parent.right=W:this._root=W,W&&(W.right=J),J.parent=W},a.prototype._splay=function(J){for(;J.parent;){var W=J.parent;W.parent?W.left===J&&W.parent.left===W?(this.rotateRight(W.parent),this.rotateRight(W)):W.right===J&&W.parent.right===W?(this.rotateLeft(W.parent),this.rotateLeft(W)):W.left===J&&W.parent.right===W?(this.rotateRight(W),this.rotateLeft(W)):(this.rotateLeft(W),this.rotateRight(W)):W.left===J?this.rotateRight(W):this.rotateLeft(W)}},a.prototype.splay=function(J){for(var W,Re,it,De,st;J.parent;)(Re=(W=J.parent).parent)&&Re.parent?((it=Re.parent).left===Re?it.left=J:it.right=J,J.parent=it):(J.parent=null,this._root=J),De=J.left,st=J.right,J===W.left?(Re&&(Re.left===W?(W.right?(Re.left=W.right,Re.left.parent=Re):Re.left=null,W.right=Re,Re.parent=W):(De?(Re.right=De,De.parent=Re):Re.right=null,J.left=Re,Re.parent=J)),st?(W.left=st,st.parent=W):W.left=null,J.right=W,W.parent=J):(Re&&(Re.right===W?(W.left?(Re.right=W.left,Re.right.parent=Re):Re.right=null,W.left=Re,Re.parent=W):(st?(Re.left=st,st.parent=Re):Re.left=null,J.right=Re,Re.parent=J)),De?(W.right=De,De.parent=W):W.right=null,J.left=W,W.parent=J)},a.prototype.replace=function(J,W){J.parent?J===J.parent.left?J.parent.left=W:J.parent.right=W:this._root=W,W&&(W.parent=J.parent)},a.prototype.minNode=function(J){if(J===void 0&&(J=this._root),J)for(;J.left;)J=J.left;return J},a.prototype.maxNode=function(J){if(J===void 0&&(J=this._root),J)for(;J.right;)J=J.right;return J},a.prototype.insert=function(J,W){var Re=this._root,it=null,De=this._compare;if(this._noDuplicates)for(;Re;){if(it=Re,De(Re.key,J)===0)return;Re=De(Re.key,J)<0?Re.right:Re.left}else for(;Re;)it=Re,Re=De(Re.key,J)<0?Re.right:Re.left;return Re={key:J,data:W,left:null,right:null,parent:it},it?De(it.key,Re.key)<0?it.right=Re:it.left=Re:this._root=Re,this.splay(Re),this._size++,Re},a.prototype.find=function(J){for(var W=this._root,Re=this._compare;W;){var it=Re(W.key,J);if(it<0)W=W.right;else{if(!(it>0))return W;W=W.left}}return null},a.prototype.contains=function(J){for(var W=this._root,Re=this._compare;W;){var it=Re(J,W.key);if(it===0)return!0;W=it<0?W.left:W.right}return!1},a.prototype.remove=function(J){var W=this.find(J);if(!W)return!1;if(this.splay(W),W.left)if(W.right){var Re=this.minNode(W.right);Re.parent!==W&&(this.replace(Re,Re.right),Re.right=W.right,Re.right.parent=Re),this.replace(W,Re),Re.left=W.left,Re.left.parent=Re}else this.replace(W,W.left);else this.replace(W,W.right);return this._size--,!0},a.prototype.removeNode=function(J){if(!J)return!1;if(this.splay(J),J.left)if(J.right){var W=this.minNode(J.right);W.parent!==J&&(this.replace(W,W.right),W.right=J.right,W.right.parent=W),this.replace(J,W),W.left=J.left,W.left.parent=W}else this.replace(J,J.left);else this.replace(J,J.right);return this._size--,!0},a.prototype.erase=function(J){var W=this.find(J);if(W){this.splay(W);var Re=W.left,it=W.right,De=null;Re&&(Re.parent=null,De=this.maxNode(Re),this.splay(De),this._root=De),it&&(Re?De.right=it:this._root=it,it.parent=De),this._size--}},a.prototype.pop=function(){var J=this._root,W=null;if(J){for(;J.left;)J=J.left;W={key:J.key,data:J.data},this.remove(J.key)}return W},a.prototype.next=function(J){var W=J;if(W)if(W.right)for(W=W.right;W&&W.left;)W=W.left;else for(W=J.parent;W&&W.right===J;)J=W,W=W.parent;return W},a.prototype.prev=function(J){var W=J;if(W)if(W.left)for(W=W.left;W&&W.right;)W=W.right;else for(W=J.parent;W&&W.left===J;)J=W,W=W.parent;return W},a.prototype.forEach=function(J){for(var W=this._root,Re=[],it=!1,De=0;!it;)W?(Re.push(W),W=W.left):Re.length>0?(J(W=Re.pop(),De++),W=W.right):it=!0;return this},a.prototype.range=function(J,W,Re,it){for(var De=[],st=this._compare,wt=this._root;De.length!==0||wt;)if(wt)De.push(wt),wt=wt.left;else{if(st((wt=De.pop()).key,W)>0)break;if(st(wt.key,J)>=0&&Re.call(it,wt))return this;wt=wt.right}return this},a.prototype.keys=function(){for(var J=this._root,W=[],Re=[],it=!1;!it;)J?(W.push(J),J=J.left):W.length>0?(J=W.pop(),Re.push(J.key),J=J.right):it=!0;return Re},a.prototype.values=function(){for(var J=this._root,W=[],Re=[],it=!1;!it;)J?(W.push(J),J=J.left):W.length>0?(J=W.pop(),Re.push(J.data),J=J.right):it=!0;return Re},a.prototype.at=function(J){for(var W=this._root,Re=[],it=!1,De=0;!it;)if(W)Re.push(W),W=W.left;else if(Re.length>0){if(W=Re.pop(),De===J)return W;De++,W=W.right}else it=!0;return null},a.prototype.load=function(J,W,Re){if(J===void 0&&(J=[]),W===void 0&&(W=[]),Re===void 0&&(Re=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var it=J.length;return Re&&f(J,W,0,it-1,this._compare),this._root=h(null,J,W,0,it),this._size=it,this},a.prototype.min=function(){var J=this.minNode(this._root);return J?J.key:null},a.prototype.max=function(){var J=this.maxNode(this._root);return J?J.key:null},a.prototype.isEmpty=function(){return this._root===null},u.size.get=function(){return this._size},a.createTree=function(J,W,Re,it,De){return new a(Re,De).load(J,W,it)},Object.defineProperties(a.prototype,u);var _=0,g=1,v=2,b=3,w=0,I=1,A=2,P=3;function D(J,W,Re){W===null?(J.inOut=!1,J.otherInOut=!0):(J.isSubject===W.isSubject?(J.inOut=!W.inOut,J.otherInOut=W.otherInOut):(J.inOut=!W.otherInOut,J.otherInOut=W.isVertical()?!W.inOut:W.inOut),W&&(J.prevInResult=!L(W,Re)||W.isVertical()?W.prevInResult:W));var it=L(J,Re);J.resultTransition=it?(function(De,st){var wt,vt=!De.inOut,Zt=!De.otherInOut;switch(st){case w:wt=vt&&Zt;break;case I:wt=vt||Zt;break;case P:wt=vt^Zt;break;case A:wt=De.isSubject?vt&&!Zt:Zt&&!vt}return wt?1:-1})(J,Re):0}function L(J,W){switch(J.type){case _:switch(W){case w:return!J.otherInOut;case I:return J.otherInOut;case A:return J.isSubject&&J.otherInOut||!J.isSubject&&!J.otherInOut;case P:return!0}break;case v:return W===w||W===I;case b:return W===A;case g:return!1}return!1}var V=function(J,W,Re,it,De){this.left=W,this.point=J,this.otherEvent=Re,this.isSubject=it,this.type=De||_,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},j={inResult:{configurable:!0}};function H(J,W){return J[0]===W[0]&&J[1]===W[1]}V.prototype.isBelow=function(J){var W=this.point,Re=this.otherEvent.point;return this.left?(W[0]-J[0])*(Re[1]-J[1])-(Re[0]-J[0])*(W[1]-J[1])>0:(Re[0]-J[0])*(W[1]-J[1])-(W[0]-J[0])*(Re[1]-J[1])>0},V.prototype.isAbove=function(J){return!this.isBelow(J)},V.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},j.inResult.get=function(){return this.resultTransition!==0},V.prototype.clone=function(){var J=new V(this.point,this.left,this.otherEvent,this.isSubject,this.type);return J.contourId=this.contourId,J.resultTransition=this.resultTransition,J.prevInResult=this.prevInResult,J.isExteriorRing=this.isExteriorRing,J.inOut=this.inOut,J.otherInOut=this.otherInOut,J},Object.defineProperties(V.prototype,j);var te=11102230246251565e-32,K=134217729,oe=(3+8*te)*te;function le(J,W,Re,it,De){var st,wt,vt,Zt,zt=W[0],yt=it[0],Ai=0,Ji=0;yt>zt==yt>-zt?(st=zt,zt=W[++Ai]):(st=yt,yt=it[++Ji]);var Ot=0;if(Ai<J&&Ji<Re)for(yt>zt==yt>-zt?(vt=st-((wt=zt+st)-zt),zt=W[++Ai]):(vt=st-((wt=yt+st)-yt),yt=it[++Ji]),st=wt,vt!==0&&(De[Ot++]=vt);Ai<J&&Ji<Re;)yt>zt==yt>-zt?(vt=st-((wt=st+zt)-(Zt=wt-st))+(zt-Zt),zt=W[++Ai]):(vt=st-((wt=st+yt)-(Zt=wt-st))+(yt-Zt),yt=it[++Ji]),st=wt,vt!==0&&(De[Ot++]=vt);for(;Ai<J;)vt=st-((wt=st+zt)-(Zt=wt-st))+(zt-Zt),zt=W[++Ai],st=wt,vt!==0&&(De[Ot++]=vt);for(;Ji<Re;)vt=st-((wt=st+yt)-(Zt=wt-st))+(yt-Zt),yt=it[++Ji],st=wt,vt!==0&&(De[Ot++]=vt);return st===0&&Ot!==0||(De[Ot++]=st),Ot}function ue(J){return new Float64Array(J)}var Me=33306690738754716e-32,ye=22204460492503146e-32,Ce=11093356479670487e-47,Oe=ue(4),Ne=ue(8),Ye=ue(12),He=ue(16),Fe=ue(4);function Ge(J,W,Re){var it=(function(De,st,wt,vt,Zt,zt){var yt=(st-zt)*(wt-Zt),Ai=(De-Zt)*(vt-zt),Ji=yt-Ai;if(yt===0||Ai===0||yt>0!=Ai>0)return Ji;var Ot=Math.abs(yt+Ai);return Math.abs(Ji)>=Me*Ot?Ji:-(function(_i,Qi,ji,Lr,mr,or,Zi){var Di,Wt,zi,sr,Lt,xi,_r,Vr,Zr,ln,gr,rn,Ao,nn,Ho,qn,ys,Mo,qo=_i-mr,$n=ji-mr,$o=Qi-or,xs=Lr-or;Oe[0]=(Ho=(Vr=qo-(_r=(xi=K*qo)-(xi-qo)))*(ln=xs-(Zr=(xi=K*xs)-(xi-xs)))-((nn=qo*xs)-_r*Zr-Vr*Zr-_r*ln))-((gr=Ho-(ys=(Vr=$o-(_r=(xi=K*$o)-(xi-$o)))*(ln=$n-(Zr=(xi=K*$n)-(xi-$n)))-((qn=$o*$n)-_r*Zr-Vr*Zr-_r*ln)))+(Lt=Ho-gr))+(Lt-ys),Oe[1]=(Ao=nn-((rn=nn+gr)-(Lt=rn-nn))+(gr-Lt))-((gr=Ao-qn)+(Lt=Ao-gr))+(Lt-qn),Oe[2]=rn-((Mo=rn+gr)-(Lt=Mo-rn))+(gr-Lt),Oe[3]=Mo;var Ln=(function(Cl,fa){for(var cm=fa[0],th=1;th<4;th++)cm+=fa[th];return cm})(0,Oe),so=ye*Zi;if(Ln>=so||-Ln>=so||(Di=_i-(qo+(Lt=_i-qo))+(Lt-mr),zi=ji-($n+(Lt=ji-$n))+(Lt-mr),Wt=Qi-($o+(Lt=Qi-$o))+(Lt-or),sr=Lr-(xs+(Lt=Lr-xs))+(Lt-or),Di===0&&Wt===0&&zi===0&&sr===0)||(so=Ce*Zi+oe*Math.abs(Ln),(Ln+=qo*sr+xs*Di-($o*zi+$n*Wt))>=so||-Ln>=so))return Ln;Fe[0]=(Ho=(Vr=Di-(_r=(xi=K*Di)-(xi-Di)))*(ln=xs-(Zr=(xi=K*xs)-(xi-xs)))-((nn=Di*xs)-_r*Zr-Vr*Zr-_r*ln))-((gr=Ho-(ys=(Vr=Wt-(_r=(xi=K*Wt)-(xi-Wt)))*(ln=$n-(Zr=(xi=K*$n)-(xi-$n)))-((qn=Wt*$n)-_r*Zr-Vr*Zr-_r*ln)))+(Lt=Ho-gr))+(Lt-ys),Fe[1]=(Ao=nn-((rn=nn+gr)-(Lt=rn-nn))+(gr-Lt))-((gr=Ao-qn)+(Lt=Ao-gr))+(Lt-qn),Fe[2]=rn-((Mo=rn+gr)-(Lt=Mo-rn))+(gr-Lt),Fe[3]=Mo;var da=le(4,Oe,4,Fe,Ne);Fe[0]=(Ho=(Vr=qo-(_r=(xi=K*qo)-(xi-qo)))*(ln=sr-(Zr=(xi=K*sr)-(xi-sr)))-((nn=qo*sr)-_r*Zr-Vr*Zr-_r*ln))-((gr=Ho-(ys=(Vr=$o-(_r=(xi=K*$o)-(xi-$o)))*(ln=zi-(Zr=(xi=K*zi)-(xi-zi)))-((qn=$o*zi)-_r*Zr-Vr*Zr-_r*ln)))+(Lt=Ho-gr))+(Lt-ys),Fe[1]=(Ao=nn-((rn=nn+gr)-(Lt=rn-nn))+(gr-Lt))-((gr=Ao-qn)+(Lt=Ao-gr))+(Lt-qn),Fe[2]=rn-((Mo=rn+gr)-(Lt=Mo-rn))+(gr-Lt),Fe[3]=Mo;var Ml=le(da,Ne,4,Fe,Ye);Fe[0]=(Ho=(Vr=Di-(_r=(xi=K*Di)-(xi-Di)))*(ln=sr-(Zr=(xi=K*sr)-(xi-sr)))-((nn=Di*sr)-_r*Zr-Vr*Zr-_r*ln))-((gr=Ho-(ys=(Vr=Wt-(_r=(xi=K*Wt)-(xi-Wt)))*(ln=zi-(Zr=(xi=K*zi)-(xi-zi)))-((qn=Wt*zi)-_r*Zr-Vr*Zr-_r*ln)))+(Lt=Ho-gr))+(Lt-ys),Fe[1]=(Ao=nn-((rn=nn+gr)-(Lt=rn-nn))+(gr-Lt))-((gr=Ao-qn)+(Lt=Ao-gr))+(Lt-qn),Fe[2]=rn-((Mo=rn+gr)-(Lt=Mo-rn))+(gr-Lt),Fe[3]=Mo;var eh=le(Ml,Ye,4,Fe,He);return He[eh-1]})(De,st,wt,vt,Zt,zt,Ot)})(J[0],J[1],W[0],W[1],Re[0],Re[1]);return it>0?-1:it<0?1:0}function Ie(J,W){var Re=J.point,it=W.point;return Re[0]>it[0]?1:Re[0]<it[0]?-1:Re[1]!==it[1]?Re[1]>it[1]?1:-1:(function(De,st,wt,vt){return De.left!==st.left?De.left?1:-1:Ge(wt,De.otherEvent.point,st.otherEvent.point)!==0?De.isBelow(st.otherEvent.point)?-1:1:!De.isSubject&&st.isSubject?1:-1})(J,W,Re)}function Se(J,W,Re){var it=new V(W,!1,J,J.isSubject),De=new V(W,!0,J.otherEvent,J.isSubject);return H(J.point,J.otherEvent.point)&&console.warn("what is that, a collapsed segment?",J),it.contourId=De.contourId=J.contourId,Ie(De,J.otherEvent)>0&&(J.otherEvent.left=!0,De.left=!1),J.otherEvent.otherEvent=De,J.otherEvent=it,Re.push(De),Re.push(it),Re}function Ue(J,W){return J[0]*W[1]-J[1]*W[0]}function Ze(J,W){return J[0]*W[0]+J[1]*W[1]}function ke(J,W,Re){var it=(function(Zt,zt,yt,Ai,Ji){var Ot=[zt[0]-Zt[0],zt[1]-Zt[1]],_i=[Ai[0]-yt[0],Ai[1]-yt[1]];function Qi(xi,_r,Vr){return[xi[0]+_r*Vr[0],xi[1]+_r*Vr[1]]}var ji=[yt[0]-Zt[0],yt[1]-Zt[1]],Lr=Ue(Ot,_i),mr=Lr*Lr,or=Ze(Ot,Ot);if(mr>0){var Zi=Ue(ji,_i)/Lr;if(Zi<0||Zi>1)return null;var Di=Ue(ji,Ot)/Lr;return Di<0||Di>1?null:Zi===0||Zi===1?[Qi(Zt,Zi,Ot)]:Di===0||Di===1?[Qi(yt,Di,_i)]:[Qi(Zt,Zi,Ot)]}if((mr=(Lr=Ue(ji,Ot))*Lr)>0)return null;var Wt=Ze(Ot,ji)/or,zi=Wt+Ze(Ot,_i)/or,sr=Math.min(Wt,zi),Lt=Math.max(Wt,zi);return sr<=1&&Lt>=0?sr===1?[Qi(Zt,sr>0?sr:0,Ot)]:Lt===0?[Qi(Zt,Lt<1?Lt:1,Ot)]:[Qi(Zt,sr>0?sr:0,Ot),Qi(Zt,Lt<1?Lt:1,Ot)]:null})(J.point,J.otherEvent.point,W.point,W.otherEvent.point),De=it?it.length:0;if(De===0||De===1&&(H(J.point,W.point)||H(J.otherEvent.point,W.otherEvent.point))||De===2&&J.isSubject===W.isSubject)return 0;if(De===1)return H(J.point,it[0])||H(J.otherEvent.point,it[0])||Se(J,it[0],Re),H(W.point,it[0])||H(W.otherEvent.point,it[0])||Se(W,it[0],Re),1;var st=[],wt=!1,vt=!1;return H(J.point,W.point)?wt=!0:Ie(J,W)===1?st.push(W,J):st.push(J,W),H(J.otherEvent.point,W.otherEvent.point)?vt=!0:Ie(J.otherEvent,W.otherEvent)===1?st.push(W.otherEvent,J.otherEvent):st.push(J.otherEvent,W.otherEvent),wt&&vt||wt?(W.type=g,J.type=W.inOut===J.inOut?v:b,wt&&!vt&&Se(st[1].otherEvent,st[0].point,Re),2):vt?(Se(st[0],st[1].point,Re),3):st[0]!==st[3].otherEvent?(Se(st[0],st[1].point,Re),Se(st[1],st[2].point,Re),3):(Se(st[0],st[1].point,Re),Se(st[3].otherEvent,st[2].point,Re),3)}function ft(J,W){if(J===W)return 0;if(Ge(J.point,J.otherEvent.point,W.point)!==0||Ge(J.point,J.otherEvent.point,W.otherEvent.point)!==0)return H(J.point,W.point)?J.isBelow(W.otherEvent.point)?-1:1:J.point[0]===W.point[0]?J.point[1]<W.point[1]?-1:1:Ie(J,W)===1?W.isAbove(J.point)?-1:1:J.isBelow(W.point)?-1:1;if(J.isSubject!==W.isSubject)return J.isSubject?-1:1;var Re=J.point,it=W.point;return Re[0]===it[0]&&Re[1]===it[1]?(Re=J.otherEvent.point)[0]===(it=W.otherEvent.point)[0]&&Re[1]===it[1]?0:J.contourId>W.contourId?1:-1:Ie(J,W)===1?1:-1}var _t=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function ut(J,W,Re,it){var De,st=J+1,wt=W[J].point,vt=W.length;for(st<vt&&(De=W[st].point);st<vt&&De[0]===wt[0]&&De[1]===wt[1];){if(!Re[st])return st;++st<vt&&(De=W[st].point)}for(st=J-1;Re[st]&&st>it;)st--;return st}_t.prototype.isExterior=function(){return this.holeOf==null};var ot=at,jt=at;function at(J,W){if(!(this instanceof at))return new at(J,W);if(this.data=J||[],this.length=this.data.length,this.compare=W||Et,this.length>0)for(var Re=(this.length>>1)-1;Re>=0;Re--)this._down(Re)}function Et(J,W){return J<W?-1:J>W?1:0}at.prototype={push:function(J){this.data.push(J),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var J=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),J}},peek:function(){return this.data[0]},_up:function(J){for(var W=this.data,Re=this.compare,it=W[J];J>0;){var De=J-1>>1,st=W[De];if(Re(it,st)>=0)break;W[J]=st,J=De}W[J]=it},_down:function(J){for(var W=this.data,Re=this.compare,it=this.length>>1,De=W[J];J<it;){var st=1+(J<<1),wt=st+1,vt=W[st];if(wt<this.length&&Re(W[wt],vt)<0&&(st=wt,vt=W[wt]),Re(vt,De)>=0)break;W[J]=vt,J=st}W[J]=De}},ot.default=jt;var Ht=Math.max,oi=Math.min,yi=0;function $t(J,W,Re,it,De,st){var wt,vt,Zt,zt,yt,Ai;for(wt=0,vt=J.length-1;wt<vt;wt++)if(zt=J[wt+1],yt=new V(Zt=J[wt],!1,void 0,W),Ai=new V(zt,!1,yt,W),yt.otherEvent=Ai,Zt[0]!==zt[0]||Zt[1]!==zt[1]){yt.contourId=Ai.contourId=Re,st||(yt.isExteriorRing=!1,Ai.isExteriorRing=!1),Ie(yt,Ai)>0?Ai.left=!0:yt.left=!0;var Ji=Zt[0],Ot=Zt[1];De[0]=oi(De[0],Ji),De[1]=oi(De[1],Ot),De[2]=Ht(De[2],Ji),De[3]=Ht(De[3],Ot),it.push(yt),it.push(Ai)}}var Pi=[];function Ri(J,W,Re){typeof J[0][0][0]=="number"&&(J=[J]),typeof W[0][0][0]=="number"&&(W=[W]);var it=(function(Ot,_i,Qi){var ji=null;return Ot.length*_i.length==0&&(Qi===w?ji=Pi:Qi===A?ji=Ot:Qi!==I&&Qi!==P||(ji=Ot.length===0?_i:Ot)),ji})(J,W,Re);if(it)return it===Pi?null:it;var De=[1/0,1/0,-1/0,-1/0],st=[1/0,1/0,-1/0,-1/0],wt=(function(Ot,_i,Qi,ji,Lr){var mr,or,Zi,Di,Wt,zi,sr=new ot(null,Ie);for(Zi=0,Di=Ot.length;Zi<Di;Zi++)for(Wt=0,zi=(mr=Ot[Zi]).length;Wt<zi;Wt++)(or=Wt===0)&&yi++,$t(mr[Wt],!0,yi,sr,Qi,or);for(Zi=0,Di=_i.length;Zi<Di;Zi++)for(Wt=0,zi=(mr=_i[Zi]).length;Wt<zi;Wt++)or=Wt===0,Lr===A&&(or=!1),or&&yi++,$t(mr[Wt],!1,yi,sr,ji,or);return sr})(J,W,De,st,Re);if(it=(function(Ot,_i,Qi,ji,Lr){var mr=null;return(Qi[0]>ji[2]||ji[0]>Qi[2]||Qi[1]>ji[3]||ji[1]>Qi[3])&&(Lr===w?mr=Pi:Lr===A?mr=Ot:Lr!==I&&Lr!==P||(mr=Ot.concat(_i))),mr})(J,W,De,st,Re))return it===Pi?null:it;for(var vt=(function(Ot){var _i,Qi,ji=(function(Zi){var Di,Wt,zi,sr,Lt=[];for(Wt=0,zi=Zi.length;Wt<zi;Wt++)((Di=Zi[Wt]).left&&Di.inResult||!Di.left&&Di.otherEvent.inResult)&&Lt.push(Di);for(var xi=!1;!xi;)for(xi=!0,Wt=0,zi=Lt.length;Wt<zi;Wt++)Wt+1<zi&&Ie(Lt[Wt],Lt[Wt+1])===1&&(sr=Lt[Wt],Lt[Wt]=Lt[Wt+1],Lt[Wt+1]=sr,xi=!1);for(Wt=0,zi=Lt.length;Wt<zi;Wt++)(Di=Lt[Wt]).otherPos=Wt;for(Wt=0,zi=Lt.length;Wt<zi;Wt++)(Di=Lt[Wt]).left||(sr=Di.otherPos,Di.otherPos=Di.otherEvent.otherPos,Di.otherEvent.otherPos=sr);return Lt})(Ot),Lr={},mr=[],or=function(){if(!Lr[_i]){var Zi=mr.length,Di=(function(Lt,xi,_r){var Vr=new _t;if(Lt.prevInResult!=null){var Zr=Lt.prevInResult,ln=Zr.outputContourId;if(Zr.resultTransition>0){var gr=xi[ln];if(gr.holeOf!=null){var rn=gr.holeOf;xi[rn].holeIds.push(_r),Vr.holeOf=rn,Vr.depth=xi[ln].depth}else xi[ln].holeIds.push(_r),Vr.holeOf=ln,Vr.depth=xi[ln].depth+1}else Vr.holeOf=null,Vr.depth=xi[ln].depth}else Vr.holeOf=null,Vr.depth=0;return Vr})(ji[_i],mr,Zi),Wt=function(Lt){Lr[Lt]=!0,Lt<ji.length&&ji[Lt]&&(ji[Lt].outputContourId=Zi)},zi=_i,sr=_i;for(Di.points.push(ji[_i].point);Wt(zi),Wt(zi=ji[zi].otherPos),Di.points.push(ji[zi].point),!((zi=ut(zi,ji,Lr,sr))==sr||zi>=ji.length)&&ji[zi];);mr.push(Di)}};for(_i=0,Qi=ji.length;_i<Qi;_i++)or();return mr})((function(Ot,_i,Qi,ji,Lr,mr){for(var or,Zi,Di,Wt=new a(ft),zi=[],sr=Math.min(ji[2],Lr[2]);Ot.length!==0;){var Lt=Ot.pop();if(zi.push(Lt),mr===w&&Lt.point[0]>sr||mr===A&&Lt.point[0]>ji[2])break;if(Lt.left){Zi=or=Wt.insert(Lt),or=or!==(Di=Wt.minNode())?Wt.prev(or):null,Zi=Wt.next(Zi);var xi=or?or.key:null;if(D(Lt,xi,mr),Zi&&ke(Lt,Zi.key,Ot)===2&&(D(Lt,xi,mr),D(Zi.key,Lt,mr)),or&&ke(or.key,Lt,Ot)===2){var _r=or;D(xi,(_r=_r!==Di?Wt.prev(_r):null)?_r.key:null,mr),D(Lt,xi,mr)}}else Zi=or=Wt.find(Lt=Lt.otherEvent),or&&Zi&&(or=or!==Di?Wt.prev(or):null,Zi=Wt.next(Zi),Wt.remove(Lt),Zi&&or&&ke(or.key,Zi.key,Ot))}return zi})(wt,0,0,De,st,Re)),Zt=[],zt=0;zt<vt.length;zt++){var yt=vt[zt];if(yt.isExterior()){for(var Ai=[yt.points],Ji=0;Ji<yt.holeIds.length;Ji++)Ai.push(vt[yt.holeIds[Ji]].points);Zt.push(Ai)}}return Zt}var Tr={UNION:I,DIFFERENCE:A,INTERSECTION:w,XOR:P};i.diff=function(J,W){return Ri(J,W,A)},i.intersection=function(J,W){return Ri(J,W,w)},i.operations=Tr,i.union=function(J,W){return Ri(J,W,I)},i.xor=function(J,W){return Ri(J,W,P)},Object.defineProperty(i,"__esModule",{value:!0})})(e)})(0,vy.exports)),vy.exports);/**
 * martinez v0.7.4
 * Martinez polygon clipping algorithm, does boolean operation on polygons (multipolygons, polygons with holes etc): intersection, union, difference, xor
 *
 * @author Alex Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 */function bp(r,e,i,o){const a=[],u=o===0?(h,f,_,g,v,b)=>{h.push(new Be(b,_+(b-f)/(g-f)*(v-_)))}:(h,f,_,g,v,b)=>{h.push(new Be(f+(b-_)/(v-_)*(g-f),b))};for(const h of r){const f=[];for(const _ of h){if(_.length<=2)continue;const g=[];for(let w=0;w<_.length-1;w++){const I=_[w].x,A=_[w].y,P=_[w+1].x,D=_[w+1].y,L=o===0?I:A,V=o===0?P:D;L<e?V>e&&u(g,I,A,P,D,e):L>i?V<i&&u(g,I,A,P,D,i):g.push(_[w]),V<e&&L>=e&&u(g,I,A,P,D,e),V>i&&L<=i&&u(g,I,A,P,D,i)}let v=_[_.length-1];const b=o===0?v.x:v.y;b>=e&&b<=i&&g.push(v),g.length&&(v=g[g.length-1],g[0].x===v.x&&g[0].y===v.y||g.push(g[0]),f.push(g))}f.length&&a.push(f)}return a}function Kb(r,e){const i=d_(r),o=d_([e]),a=by.intersection(i,o);return a==null?[]:wy(a)}function Jb(r,e){let o=d_(r,65536);const a=[];for(;e.valid();e.next()){const[u,h]=e.get(),f=u.x*65536,_=u.y*65536,g=h.x*65536,v=h.y*65536,b=g-f,w=v-_,I=Math.hypot(b,w);if(I===0)continue;const A=Math.trunc(w/I*3),P=-Math.trunc(b/I*3);a.push([[[f,_],[g,v],[g+A,v+P],[f+A,_+P],[f,_]]])}return a.length>0&&(o=by.diff(o,a)),wy(o,1/65536)}function d_(r,e=1){return[r.map((i=>i.map((o=>[o.x*e,o.y*e]))))]}function wy(r,e=1){return r.map((i=>i.map(((o,a)=>{const u=o.map((h=>new Be(h[0]*e,h[1]*e).round()));return a>0&&u.reverse(),u}))))}class f_{constructor(e,i){this.layoutVertexArray=new mo,this.indexArray=new vr,this.lineIndexArray=new ss,this.triangleSegments=new Ar,this.lineSegments=new Ar,this.programConfigurations=new _s(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,i&&(this.elevatedLayoutVertexArray=new Vs)}update(e,i,o,a,u,h,f,_){this.programConfigurations.updatePaintArrays(e,i,u,o,a,h,f,_)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Fb.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,kb.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,i,o,a,u,h,f){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,o,a,u,h,void 0,f)}}class p_{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new f_(e,!1),this.elevationBufferData=new f_(e,!0),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,o,a){}populate(e,i,o,a){this.hasPattern=u_("fill",this.layers,this.pixelRatio,i);const u=this.layers[0].layout.get("fill-sort-key"),h=[];for(const{feature:f,id:_,index:g,sourceLayerIndex:v}of e){const b=this.layers[0]._featureFilter.needGeometry,w=be(f,b);if(!this.layers[0]._featureFilter.filter(new lr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),w,o))continue;const I=u?u.evaluate(w,{},o,i.availableImages):void 0,A={id:_,properties:f.properties,type:f.type,sourceLayerIndex:v,index:g,geometry:b?w.geometry:Le(f,o,a),patterns:{},sortKey:I};h.push(A)}u&&h.sort(((f,_)=>f.sortKey-_.sortKey));for(const f of h){const{geometry:_,index:g,sourceLayerIndex:v}=f;if(this.hasPattern){const b=h_("fill",this.layers,f,this.zoom,this.pixelRatio,i);this.patternFeatures.push(b)}else this.addFeature(f,_,g,o,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[g].feature,_,g,v,this.index)}}update(e,i,o,a,u,h,f){this.bufferData.update(e,i,o,a,u,h,f,this.worldview),this.elevationBufferData.update(e,i,o,a,u,h,f,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,i,o,a,u,h,f,this.worldview)}addFeatures(e,i,o,a,u,h){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,i,o,a,h,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,i,o,a,u,h=[],f,_){const g=Md(i,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,g,a,o,_):this.addGeometry(g,this.bufferData),this.bufferData.populatePaintArrays(e,o,u,h,a,f,this.worldview),this.elevationBufferData.populatePaintArrays(e,o,u,h,a,f,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,i,o,a,u){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(i,o,a,u,this.worldview))}addElevatedRoadFeature(e,i,o,a,u){const h=new Array,f=Ut.getElevationFeature(e,u);if(!f)return void this.addGeometry(i,this.bufferData);{const g=this.clipPolygonsToTile(i,1);g.length>0&&h.push({polygons:g,elevationFeature:f,elevationTileID:o})}const _={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},o),featureIndex:a};for(const g of h)if(g.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new jo(g.elevationTileID,this.layers,this.zoom,this.lut));const b=g.elevationFeature.isTunnel();let w=0;e.properties.hasOwnProperty(dt)&&(w=+e.properties[dt]);for(const I of g.polygons)this.elevatedStructures.addPortalCandidates(g.elevationFeature.id,I,b,g.elevationFeature,w)}g.elevationFeature.constantHeight==null&&(g.polygons=this.prepareElevatedPolygons(g.polygons,g.elevationFeature,g.elevationTileID));const v=new gi(o,g.elevationTileID);this.addElevatedGeometry(g.polygons,v,g.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,a,_)}}addElevatedGeometry(e,i,o,a,u,h){const f={elevation:o,elevationSampler:i,bias:a,index:u,featureInfo:h},[_,g]=this.addGeometry(e,this.elevationBufferData,f);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:_,max:g}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,_),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,g))}addGeometry(e,i,o){let a=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,h=null;o&&(h=o.elevationSampler.constantElevation(o.elevation,o.bias),h!=null&&(a=h,u=h));const f=(_,g,v)=>{if(o!=null)if(g.push(_),h!=null)i.elevatedLayoutVertexArray.emplaceBack(h),v.push(h);else{const b=o.elevationSampler.pointElevation(_,o.elevation,o.bias);i.elevatedLayoutVertexArray.emplaceBack(b),v.push(b),a=Math.min(a,b),u=Math.max(u,b)}};for(const _ of e){let g=0;for(const j of _)g+=j.length;const v=i.triangleSegments.prepareSegment(g,i.layoutVertexArray,i.indexArray),b=v.vertexLength,w=[],I=[],A=[],P=[],D=[],L=i.layoutVertexArray.length;for(const j of _){if(j.length===0)continue;j!==_[0]&&I.push(w.length/2);const H=i.lineSegments.prepareSegment(j.length,i.layoutVertexArray,i.lineIndexArray),te=H.vertexLength;o&&D.push(i.layoutVertexArray.length-L),f(j[0],A,P),i.layoutVertexArray.emplaceBack(j[0].x,j[0].y),i.lineIndexArray.emplaceBack(te+j.length-1,te),w.push(j[0].x),w.push(j[0].y);for(let K=1;K<j.length;K++)f(j[K],A,P),i.layoutVertexArray.emplaceBack(j[K].x,j[K].y),i.lineIndexArray.emplaceBack(te+K-1,te+K),w.push(j[K].x),w.push(j[K].y);H.vertexLength+=j.length,H.primitiveLength+=j.length}const V=Ou(w,I);for(let j=0;j<V.length;j+=3)i.indexArray.emplaceBack(b+V[j],b+V[j+1],b+V[j+2]);if(V.length>0&&o&&this.elevationMode==="hd-road-base"){const j=o.elevation.isTunnel(),H=o.elevation.safeArea,te=this.elevatedStructures.addVertices(A,P);this.elevatedStructures.addTriangles(V,te,j);const K=D.length;if(K>0){for(let oe=0;oe<K-1;oe++)this.elevatedStructures.addRenderableRing(o.index,D[oe]+te,D[oe+1]-D[oe],j,H,o.featureInfo);this.elevatedStructures.addRenderableRing(o.index,D[K-1]+te,A.length-D[K-1],j,H,o.featureInfo)}}v.vertexLength+=g,v.primitiveLength+=V.length/3}return[a,u]}prepareElevatedPolygons(e,i,o){const a=1/re(o),u=[];for(const h of e){const f=Jb(h,new ur(i,a));u.push(...f)}return u}clipPolygonsToTile(e,i){const o=-i,a=-i,u=Je+i,h=Je+i;let f=0;const _=[],g=[];for(;f<e.length;f++){const w=e[f],I=Jl(w);(I.min.x>=o&&I.max.x<=u&&I.min.y>=a&&I.max.y<=h?_:g).push(w)}if(_.length===e.length)return e;const v=[new Be(o,a),new Be(u,a),new Be(u,h),new Be(o,h),new Be(o,a)],b=_;for(const w of g)b.push(...Kb(w,v));return b}}let Ty,Sy,Ey,Iy;pt(p_,"FillBucket",{omit:["layers","patternFeatures"]}),pt(f_,"FillBufferData"),pt(jo,"ElevatedStructures");class wp{constructor(e,i,o,a){if(this.triangleCount=i.length/3,this.min=new Be(0,0),this.max=new Be(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[u,h]=[e[0].clone(),e[0].clone()];for(let b=1;b<e.length;++b){const w=e[b];u.x=Math.min(u.x,w.x),u.y=Math.min(u.y,w.y),h.x=Math.max(h.x,w.x),h.y=Math.max(h.y,w.y)}if(a){const b=Math.ceil(Math.max(h.x-u.x,h.y-u.y)/a);o=Math.max(o,b)}if(o===0)return;this.min=u,this.max=h;const f=this.max.sub(this.min);f.x=Math.max(f.x,1),f.y=Math.max(f.y,1);const _=Math.max(f.x,f.y)/o;this.cellsX=Math.max(1,Math.ceil(f.x/_)),this.cellsY=Math.max(1,Math.ceil(f.y/_)),this.xScale=1/_,this.yScale=1/_;const g=[];for(let b=0;b<this.triangleCount;b++){const w=e[i[3*b+0]].sub(this.min),I=e[i[3*b+1]].sub(this.min),A=e[i[3*b+2]].sub(this.min),P=ua(Math.floor(Math.min(w.x,I.x,A.x)),this.xScale,this.cellsX),D=ua(Math.floor(Math.max(w.x,I.x,A.x)),this.xScale,this.cellsX),L=ua(Math.floor(Math.min(w.y,I.y,A.y)),this.yScale,this.cellsY),V=ua(Math.floor(Math.max(w.y,I.y,A.y)),this.yScale,this.cellsY),j=new Be(0,0),H=new Be(0,0),te=new Be(0,0),K=new Be(0,0);for(let oe=L;oe<=V;++oe){j.y=H.y=oe*_,te.y=K.y=(oe+1)*_;for(let le=P;le<=D;++le)j.x=te.x=le*_,H.x=K.x=(le+1)*_,($r(w,I,A,j,H,K)||$r(w,I,A,j,K,te))&&g.push({cellIdx:oe*this.cellsX+le,triIdx:b})}}if(g.length===0)return;g.sort(((b,w)=>b.cellIdx-w.cellIdx||b.triIdx-w.triIdx));let v=0;for(;v<g.length;){const b=g[v].cellIdx,w={start:this.payload.length,len:0};for(;v<g.length&&g[v].cellIdx===b;)++w.len,this.payload.push(g[v++].triIdx);this.cells[b]=w}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const o=ua(e.x-this.min.x,this.xScale,this.cellsX),a=ua(e.y-this.min.y,this.yScale,this.cellsY),u=this.cells[a*this.cellsX+o];if(u){this._lazyInitLookup();for(let h=0;h<u.len;h++){const f=this.payload[u.start+h],_=Math.floor(f/8),g=1<<f%8;if(!(this.lookup[_]&g)&&(this.lookup[_]|=g,i.push(f),i.length===this.triangleCount))return}}}query(e,i,o){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();const a=ua(e.x-this.min.x,this.xScale,this.cellsX),u=ua(i.x-this.min.x,this.xScale,this.cellsX),h=ua(e.y-this.min.y,this.yScale,this.cellsY),f=ua(i.y-this.min.y,this.yScale,this.cellsY);for(let _=h;_<=f;_++)for(let g=a;g<=u;g++){const v=this.cells[_*this.cellsX+g];if(v)for(let b=0;b<v.len;b++){const w=this.payload[v.start+b],I=Math.floor(w/8),A=1<<w%8;if(!(this.lookup[I]&A)&&(this.lookup[I]|=A,o.push(w),o.length===this.triangleCount))return}}}}function ua(r,e,i){return Math.max(0,Math.min(i-1,Math.floor(r*e)))}pt(wp,"TriangleGridIndex");class Ay{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.footprints=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){for(const o of this.footprints)i.push({footprint:o,id:e})}updateAppearances(e,i,o,a){}populate(e,i,o,a){const u=[];for(const{feature:h,id:f,index:_,sourceLayerIndex:g}of e){const v=this.layers[0]._featureFilter.needGeometry,b=be(h,v);if(!this.layers[0]._featureFilter.filter(new lr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),b,o))continue;const w={id:f,properties:h.properties,type:h.type,sourceLayerIndex:g,index:_,geometry:v?b.geometry:Le(h,o,a),patterns:{}};u.push(w)}for(const h of u){const{geometry:f,index:_,sourceLayerIndex:g}=h;this.addFeature(h,f,_,o,{},i.availableImages,i.brightness),i.featureIndex.insert(e[_].feature,f,_,g,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,o,a,u,h,f){}destroy(){}addFeature(e,i,o,a,u,h=[],f){for(const _ of Md(i,2)){const g=[],v=[],b=[],w=new Be(1/0,1/0),I=new Be(-1/0,-1/0);for(const D of _)if(D.length!==0){D!==_[0]&&b.push(v.length/2);for(let L=0;L<D.length;L++)v.push(D[L].x),v.push(D[L].y),g.push(D[L]),w.x=Math.min(w.x,D[L].x),w.y=Math.min(w.y,D[L].y),I.x=Math.max(I.x,D[L].x),I.y=Math.max(I.y,D[L].y)}const A=Ou(v,b),P=new wp(g,A,8,256);this.footprints.push({vertices:g,indices:A,grid:P,min:w,max:I})}}}pt(Ay,"ClipBucket",{omit:["layers"]});const Qb=ai([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),e1=ai([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),t1=ai([{name:"a_flood_light_ground_radius",components:1,type:"Float32"}]),i1=ai([{name:"a_centroid_pos",components:2,type:"Uint16"}]),r1=ai([{name:"a_join_normal_inside",components:3,type:"Int16"}]),n1=ai([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),o1=ai([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:s1}=Qb,Cd=Number.MAX_SAFE_INTEGER,My=Cd-1;function Cy(r,e,i,o){return r.order<e||r.order===Cd||!(r.clipMask&i)||(function(a,u){return u.length!==0&&u.find((h=>h===a))===void 0})(o,r.clipScope)}function Tp(r,e){return r.x-e.x||r.y-e.y}function Py(r,e){return Tp(r.min,e.min)===0&&Tp(r.max,e.max)===0}function m_(r,e){return!(r.min.x>e.max.x||r.max.x<e.min.x||r.min.y>e.max.y||r.max.y<e.min.y)}function Sp(r,e){if(r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(r[i].sourceId!==e[i].sourceId||!Py(r[i],e[i])||r[i].order!==e[i].order||r[i].clipMask!==e[i].clipMask||!to(r[i].clipScope,e[i].clipScope))return!1;return!0}function Ry(r,e,i){const o=1/Je,a=1/(1<<i.canonical.z),u=(e.x*o+i.canonical.x)*a+i.wrap,h=(e.y*o+i.canonical.y)*a;return{min:new Be((r.x*o+i.canonical.x)*a+i.wrap,(r.y*o+i.canonical.y)*a),max:new Be(u,h)}}function a1(r,e,i){const o=1<<i.canonical.z,a=((e.x-i.wrap)*o-i.canonical.x)*Je,u=(e.y*o-i.canonical.y)*Je;return{min:new Be(((r.x-i.wrap)*o-i.canonical.x)*Je,(r.y*o-i.canonical.y)*Je),max:new Be(a,u)}}function __(r,e,i,o,a,u,h){const f=r.indices,_=r.vertices,g=[];for(let v=o;v<o+a;v+=3){const b=e[i[v+0]+u],w=e[i[v+1]+u],I=e[i[v+2]+u],A=Math.min(b.x,w.x,I.x),P=Math.max(b.x,w.x,I.x),D=Math.min(b.y,w.y,I.y),L=Math.max(b.y,w.y,I.y);g.length=0,r.grid.query(new Be(A,D),new Be(P,L),g);for(let V=0;V<g.length;V++){const j=g[V];if($r(_[f[3*j+0]],_[f[3*j+1]],_[f[3*j+2]],b,w,I,h))return!0}}return!1}function Dy(r,e,i,o){if(!r||!i)return!1;let a=r.vertices;if(!e.canonical.equals(o.canonical)||e.wrap!==o.wrap){if(i.vertices.length<r.vertices.length)return Dy(i,o,r,e);const u=e.canonical,h=o.canonical,f=Math.pow(2,h.z-u.z);a=r.vertices.map((_=>new Be((_.x+u.x*Je)*f-h.x*Je,(_.y+u.y*Je)*f-h.y*Je)))}return __(i,a,r.indices,0,r.indices.length,0,0)}function zy(r,e,i,o){const a=Math.pow(2,o.z-i.z);return new Be((r+i.x*Je)*a-o.x*Je,(e+i.y*Je)*a-o.y*Je)}function g_(r,e){const i=[];e.grid.queryPoint(r,i);const o=e.indices,a=e.vertices;for(let u=0;u<i.length;u++){const h=i[u];if(wn([a[o[3*h+0]],a[o[3*h+1]],a[o[3*h+2]]],r))return!0}return!1}const y_=[new Be(0,0),new Be(Je,0),new Be(Je,Je),new Be(0,Je)];function Ly(r,e){const i=[];let o=[];if(!e||r.length<2)return[r];if(r.length===2)return Gr(r[0],r[1],y_)?[r]:[];for(let a=0;a<r.length+2;a++){const u=r[a%r.length],h=r[(a+1)%r.length],f=Gr(a===0?r[r.length-1]:r[(a-1)%r.length],u,y_),_=Gr(u,h,y_),g=f||_;g&&o.push(u),g&&_||o.length>0&&(o.length>1&&i.push(o),o=[])}return o.length>1&&i.push(o),i}const x_=Ve.types,l1=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],c1=["fill-extrusion-flood-light-ground-radius"],u1=Math.pow(2,13),h1=Math.pow(2,15)-1,Oy=new Be(0,1),Sl=2147483648,Fy=7,ky=450;function Pd(r,e,i,o,a,u,h,f){r.emplaceBack((e<<1)+h,(i<<1)+u,(Math.floor(o*u1)<<1)+a,Math.round(f))}function Rd(r,e,i){r.emplaceBack(e.x*Je,e.y*Je,i?1:0)}function Ep(r,e,i,o,a,u){r.emplaceBack(e.x,e.y,(i.x<<1)+o,(i.y<<1)+a,u)}function Dd(r,e,i){r.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class By{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class Ny{constructor(){this.centroidXY=new Be(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Be(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Be(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Be(this.max.x-this.min.x,this.max.y-this.min.y)}}class Vy{constructor(){this.acc=new Be(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,o){this.accCount++,this.acc._add(i);let a=!!this.borders;i.x<e.min.x?(e.min.x=i.x,a=!0):i.x>e.max.x&&(e.max.x=i.x,a=!0),i.y<e.min.y?(e.min.y=i.y,a=!0):i.y>e.max.y&&(e.max.y=i.y,a=!0),((i.x===0||i.x===Je)&&i.x===o.x)!=((i.y===0||i.y===Je)&&i.y===o.y)&&this.processBorderOverlap(i,o),a&&this.checkBorderIntersection(i,o)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,Ft(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>Je!=e.x>Je&&this.addBorderIntersection(1,Ft(i.y,e.y,(Je-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,Ft(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>Je!=e.y>Je&&this.addBorderIntersection(3,Ft(i.x,e.x,(Je-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const o=this.borders[e];i<o[0]&&(o[0]=i),i>o[1]&&(o[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const o=e.x===0?0:1;this.addBorderIntersection(o,i.y),this.addBorderIntersection(o,e.y)}else{const o=e.y===0?2:3;this.addBorderIntersection(o,i.x),this.addBorderIntersection(o,e.x)}}centroid(){return this.accCount===0?new Be(0,0):new Be(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((e,i)=>e+ +(i[0]!==Number.MAX_VALUE)),0):0}}function Uy(r,e){const i=r.add(e)._unit(),o=B(r.x*i.x+r.y*i.y,-1,1);var a,u,h;return a=Math.acos(o),Math.min(4,Math.max(-4,Math.tan(a)))/4*h1*((u=r).x*(h=e).y-u.y*h.x<0?-1:1)}const d1=[r=>r.x<0,r=>r.x>Je,r=>r.y<0,r=>r.y>Je];function f1(r,e,i,o){const a=[4];if(o===0)return a;i._mult(o);const u=r.sub(i),h=e.sub(i),f=[r,e,u,h];for(let _=0;_<4;_++)for(const g of f)if(d1[_](g)){a.push(_);break}return a}class v_{constructor(e){this.groundRadiusArray=null,this.groundRadiusBuffer=null,this.vertexArray=new vu,this.indexArray=new vr,this.programConfigurations=new _s(e.layers,{zoom:e.zoom,lut:e.lut},(i=>c1.includes(i))),this._segments=new Ar,this.hiddenByLandmarkVertexArray=new Au,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Ar}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,o,a=!1){const u=e.length;if(u>2){let h=Math.max(0,this._segments.get().length-1);const f=this._segments._prepareSegment(4*u,this.vertexArray.length,2*this._segmentToGroundQuads[h].length);let _;h!==this._segments.get().length-1&&(h++,this._segmentToGroundQuads[h]=[],this._segmentToRegionTriCounts[h]=[0,0,0,0,0]);{const g=e[0],v=e[1];_=Uy(g.sub(e[u-1])._perp()._unit(),v.sub(g)._perp()._unit())}for(let g=0;g<u;g++){const v=g===u-1?0:g+1,b=e[g],w=e[v],I=e[v===u-1?0:v+1],A=w.sub(b)._perp()._unit(),P=Uy(A,I.sub(w)._perp()._unit()),D=_,L=P;if(b_(b,w,i)||a&&Hy(b,i)&&Hy(w,i)){_=P;continue}const V=f.vertexLength;Ep(this.vertexArray,b,w,1,1,D),Ep(this.vertexArray,b,w,1,0,D),Ep(this.vertexArray,b,w,0,1,L),Ep(this.vertexArray,b,w,0,0,L),f.vertexLength+=4;const j=f1(b,w,A,o);for(const H of j)this._segmentToGroundQuads[h].push({id:V,region:H}),this._segmentToRegionTriCounts[h][H]+=2,f.primitiveLength+=2;_=P}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let o=0;o<i;o++)this._segmentToGroundQuads[o].sort(((a,u)=>a.region-u.region));for(let o=0;o<i;o++){const a=this._segmentToGroundQuads[o],u=e[o],h=this._segmentToRegionTriCounts[o];h.reduce(((_,g)=>_+g),0);let f=0;for(let _=0;_<=4;_++){const g=h[_];if(g!==0){let v=this.regionSegments[_];v||(v=this.regionSegments[_]=new Ar);const b={vertexOffset:u.vertexOffset,primitiveOffset:u.primitiveOffset+f,vertexLength:u.vertexLength,primitiveLength:g};v.get().push(b)}f+=g}for(let _=0;_<a.length;_++){const g=a[_].id;this.indexArray.emplaceBack(g,g+1,g+3),this.indexArray.emplaceBack(g,g+3,g+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,o,a,u,h,f){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,o,a,u,h,void 0,f)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,e1.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.groundRadiusArray!=null&&(this.groundRadiusBuffer=e.createVertexBuffer(this.groundRadiusArray,t1.members)))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,o,a,u,h,f,_){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,o,a,u,h,f,_)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&Sl))}updateHiddenByLandmarkRange(e,i,o){if(!this.hasData())return;const a=i+e;if(i!==0){for(let u=e;u<a;++u)this.hiddenByLandmarkVertexArray.emplace(u,o?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,n1.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this.groundRadiusBuffer&&this.groundRadiusBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class Ip{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new vr,this.footprintVertices=new mo,this.footprintSegments=[],this.layoutVertexArray=new dl,this.centroidVertexArray=new ap,this.wallVertexArray=new cp,this.indexArray=new vr,this.programConfigurations=new _s(e.layers,{zoom:e.zoom,lut:e.lut},(i=>l1.includes(i))),this.segments=new Ar,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.groundEffect=new v_(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,o,a){}populate(e,i,o,a){this.features=[],this.hasPattern=u_("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=re(o),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:u,id:h,index:f,sourceLayerIndex:_}of e){const g=this.layers[0]._featureFilter.needGeometry,v=be(u,g);if(!this.layers[0]._featureFilter.filter(new lr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),v,o))continue;const b={id:h,sourceLayerIndex:_,index:f,geometry:g?v.geometry:Le(u,o,a),properties:u.properties,type:u.type,patterns:{}},w=this.layoutVertexArray.length,I=x_[b.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:u.id,feature:h_("fill-extrusion",this.layers,b,this.zoom,this.pixelRatio,i)});else if(this.wallMode)for(const A of b.geometry)for(const P of Ly(A,I))this.addFeature(u.id,b,[P],f,o,{},i.availableImages,a,i.brightness);else this.addFeature(u.id,b,b.geometry,f,o,{},i.availableImages,a,i.brightness);i.featureIndex.insert(u,b.geometry,f,_,this.index,w)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,o,a,u,h){for(const{featureId:f,feature:_}of this.features){const g=x_[_.type]==="Polygon",{geometry:v}=_;if(this.wallMode)for(const b of v)for(const w of Ly(b,g))this.addFeature(f,_,[w],_.index,i,o,a,u,h);else this.addFeature(f,_,v,_.index,i,o,a,u,h)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,o,a,u,h,f){this.programConfigurations.updatePaintArrays(e,i,u,o,a,h,f,this.worldview),this.groundEffect.update(e,i,u,o,a,h,f,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,s1),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,r1.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,o1.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,i1.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,o,a,u,h,f,_,g){const v=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(i,{})/this.tileToMeter,b=[new Be(0,0),new Be(Je,Je)],w=_.projection,I=w.name==="globe",A=this.wallMode||x_[i.type]==="Polygon",P=new Vy;P.centroidDataIndex=this.centroidData.length;const D=new Ny;D.buildingId=e,i.properties&&i.properties.hasOwnProperty("building_id")&&(D.buildingId=i.properties.building_id);const L=this.layers[0].paint.get("fill-extrusion-base").evaluate(i,{},u)<=0,V=this.layers[0].paint.get("fill-extrusion-height").evaluate(i,{},u);let j;if(D.height=V,D.vertexArrayOffset=this.layoutVertexArray.length,D.groundVertexArrayOffset=this.groundEffect.vertexArray.length,I&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new wu),this.wallMode){if(I)return void Mt("Non zero fill-extrusion-line-width is not yet supported on globe.");if(o.length!==1)return;j=(function(ye){const Ce=ye[0].x===ye[ye.length-1].x&&ye[0].y===ye[ye.length-1].y;(function(ut){let ot=0;const jt=ut.length;for(let at=0;at<jt;at++)ot+=(ut[(at+1)%jt].x-ut[at].x)*(ut[(at+1)%jt].y+ut[at].y);return ot>=0})(ye)||(ye=ye.reverse());const Ne={geometry:[],joinNormals:[],indices:[]},Ye=[],He=[],Fe=[];let Ge=ye.length;for(;Ge>=2&&ye[Ge-1].equals(ye[Ge-2]);)Ge--;if(Ge<(Ce?3:2))return Ne;let Ie,Se,Ue,Ze,ke,ft=0;for(;ft<Ge-1&&ye[ft].equals(ye[ft+1]);)ft++;Ce&&(Ie=ye[Ge-2],ke=ye[ft].sub(Ie)._unit()._perp());for(let ut=ft;ut<Ge;ut++){if(Ue=ut===Ge-1?Ce?ye[ft+1]:void 0:ye[ut+1],Ue&&ye[ut].equals(Ue))continue;ke&&(Ze=ke),Ie&&(Se=Ie),Ie=ye[ut],ke=Ue?Ue.sub(Ie)._unit()._perp():Ze,Ze=Ze||ke;let ot=Ze.add(ke);ot.x===0&&ot.y===0||ot._unit();const jt=ot.x*ke.x+ot.y*ke.y,at=jt!==0?1/jt:1/0,Et=Ze.x*ke.y-Ze.y*ke.x>0;let Ht="miter";const oi=2;Ht==="miter"&&at>oi&&(Ht="bevel"),Ht==="bevel"&&(at>100&&(Ht="flipbevel"),at<oi&&(Ht="miter"));const yi=($t,Pi,Ri,Tr)=>{const J=new Be($t.x,$t.y),W=new Be($t.x,$t.y);J.x+=Pi.x*Tr,J.y+=Pi.y*Tr,W.x-=Pi.x*Math.max(Ri,1),W.y-=Pi.y*Math.max(Ri,1),Fe.push(Pi),Ye.push(J),He.push(W)};if(Ht==="miter")ot._mult(at),yi(Ie,ot,0,0);else if(Ht==="flipbevel")ot=ke.mult(-1),yi(Ie,ot,0,0),yi(Ie,ot.mult(-1),0,0);else{const $t=-Math.sqrt(at*at-1),Pi=Et?$t:0,Ri=Et?0:$t;Se&&yi(Ie,Ze,Pi,Ri),Ue&&yi(Ie,ke,Pi,Ri)}}Ne.geometry=[...Ye,...He.reverse(),Ye[0]],Ne.joinNormals=[...Fe,...Fe.reverse(),Fe[Fe.length-1]];const _t=Ne.geometry.length-1;for(let ut=0;ut<_t/2;ut++)if(ut+1<_t/2){let ot=ut,jt=ut+1,at=_t-1-ut,Et=_t-2-ut;ot=ot===0?_t-1:ot-1,jt=jt===0?_t-1:jt-1,at=at===0?_t-1:at-1,Et=Et===0?_t-1:Et-1,Ne.indices.push(at),Ne.indices.push(jt),Ne.indices.push(ot),Ne.indices.push(at),Ne.indices.push(Et),Ne.indices.push(jt)}return Ne})(o[0]),o=[j.geometry]}const H=(ye,Ce)=>ye<(Ce.length-1)/2||ye===Ce.length-1,te=this.wallMode?[o]:Md(o,500);for(let ye=te.length-1;ye>=0;ye--){const Ce=te[ye];(Ce.length===0||(K=Ce[0]).every((Oe=>Oe.x<=0))||K.every((Oe=>Oe.x>=Je))||K.every((Oe=>Oe.y<=0))||K.every((Oe=>Oe.y>=Je)))&&te.splice(ye,1)}var K;let oe;if(I)oe=Wy(te,b,u);else{oe=[];for(const ye of te)oe.push({polygon:ye,bounds:b})}const le=A?this.edgeRadius:0,ue=le>0&&this.zoom<17,Me=(ye,Ce)=>{if(ye.length===0)return!1;const Oe=ye[ye.length-1];return Ce.x===Oe.x&&Ce.y===Oe.y};for(const{polygon:ye,bounds:Ce}of oe){let Oe=0,Ne=0;for(const Ge of ye)A&&!Ge[0].equals(Ge[Ge.length-1])&&Ge.push(Ge[0]),Ne+=A?Ge.length-1:Ge.length;const Ye=this.segments.prepareSegment((A?5:4)*Ne,this.layoutVertexArray,this.indexArray);D.footprintSegIdx<0&&(D.footprintSegIdx=this.footprintSegments.length),D.polygonSegIdx<0&&(D.polygonSegIdx=this.polygonSegments.length);const He={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Fe=new By;if(Fe.vertexOffset=this.footprintVertices.length,Fe.indexOffset=3*this.footprintIndices.length,Fe.ringIndices=[],A){const Ge=[],Ie=[];Oe=Ye.vertexLength;for(let Ue=0;Ue<ye.length;Ue++){const Ze=ye[Ue];Ze.length&&Ue!==0&&Ie.push(Ge.length/2);const ke=[];let ft,_t;ft=Ze[1].sub(Ze[0])._perp()._unit(),Fe.ringIndices.push(Ze.length-1);for(let ut=1;ut<Ze.length;ut++){const ot=Ze[ut],jt=Ze[ut===Ze.length-1?1:ut+1],at=ot.clone();if(le){_t=jt.sub(ot)._perp()._unit();const Et=ft.add(_t)._unit(),Ht=le*Math.min(4,1/(ft.x*Et.x+ft.y*Et.y));at.x+=Ht*Et.x,at.y+=Ht*Et.y,at.x=Math.round(at.x),at.y=Math.round(at.y),ft=_t}if(!L||le!==0&&!ue||Me(ke,at)||ke.push(at),Pd(this.layoutVertexArray,at.x,at.y,0,0,1,1,0),this.wallMode){const Et=H(ut,Ze);Rd(this.wallVertexArray,j.joinNormals[ut],!Et)}Ye.vertexLength++,this.footprintVertices.emplaceBack(ot.x,ot.y),Ge.push(ot.x,ot.y),I&&Dd(this.layoutVertexExtArray,w.projectTilePoint(at.x,at.y,u),w.upVector(u,at.x,at.y))}L&&(le===0||ue)&&(ke.length!==0&&Me(ke,ke[0])&&ke.pop(),this.groundEffect.addData(ke,Ce,v))}const Se=this.wallMode?j.indices:Ou(Ge,Ie);for(let Ue=0;Ue<Se.length;Ue+=3)this.footprintIndices.emplaceBack(Fe.vertexOffset+Se[Ue+0],Fe.vertexOffset+Se[Ue+1],Fe.vertexOffset+Se[Ue+2]),this.indexArray.emplaceBack(Oe+Se[Ue],Oe+Se[Ue+2],Oe+Se[Ue+1]),Ye.primitiveLength++;Fe.indexCount+=Se.length,Fe.vertexCount+=this.footprintVertices.length-Fe.vertexOffset}for(let Ge=0;Ge<ye.length;Ge++){const Ie=ye[Ge];P.startRing(D,Ie[0]);let Se=Ie.length>4&&qy(Ie[Ie.length-2],Ie[0],Ie[1]),Ue=le?p1(Ie[Ie.length-2],Ie[0],Ie[1],le):0;const Ze=[];let ke,ft,_t;ft=Ie[1].sub(Ie[0])._perp()._unit();let ut=!0;for(let ot=1,jt=0;ot<Ie.length;ot++){let at=Ie[ot-1],Et=Ie[ot];const Ht=Ie[ot===Ie.length-1?1:ot+1];if(P.appendEdge(D,Et,at),b_(Et,at,Ce)){le&&(ft=Ht.sub(Et)._perp()._unit(),ut=!ut);continue}const oi=Et.sub(at)._perp(),yi=oi.x/(Math.abs(oi.x)+Math.abs(oi.y)),$t=oi.y>0?1:0,Pi=at.dist(Et);if(jt+Pi>32768&&(jt=0),le){_t=Ht.sub(Et)._perp()._unit();let W=Gy(at,Et,Ht,jy(ft,_t),le);isNaN(W)&&(W=0);const Re=Et.sub(at)._unit();at=at.add(Re.mult(Ue))._round(),Et=Et.add(Re.mult(-W))._round(),Ue=W,ft=_t,L&&this.zoom>=17&&(Me(Ze,at)||Ze.push(at),Me(Ze,Et)||Ze.push(Et))}const Ri=Ye.vertexLength,Tr=Ie.length>4&&qy(at,Et,Ht);let J=$y(jt,Se,ut);if(Pd(this.layoutVertexArray,at.x,at.y,yi,$t,0,0,J),Pd(this.layoutVertexArray,at.x,at.y,yi,$t,0,1,J),this.wallMode){const W=H(ot-1,Ie),Re=j.joinNormals[ot-1];Rd(this.wallVertexArray,Re,W),Rd(this.wallVertexArray,Re,W)}if(jt+=Pi,J=$y(jt,Tr,!ut),Se=Tr,Pd(this.layoutVertexArray,Et.x,Et.y,yi,$t,0,0,J),Pd(this.layoutVertexArray,Et.x,Et.y,yi,$t,0,1,J),this.wallMode){const W=H(ot,Ie),Re=j.joinNormals[ot];Rd(this.wallVertexArray,Re,W),Rd(this.wallVertexArray,Re,W)}if(Ye.vertexLength+=4,this.indexArray.emplaceBack(Ri+0,Ri+1,Ri+2),this.indexArray.emplaceBack(Ri+1,Ri+3,Ri+2),Ye.primitiveLength+=2,le){const W=Oe+(ot===1?Ie.length-2:ot-2),Re=ot===1?Oe:W+1;if(this.indexArray.emplaceBack(Ri+1,W,Ri+3),this.indexArray.emplaceBack(W,Re,Ri+3),Ye.primitiveLength+=2,ke===void 0&&(ke=Ri),!b_(Ht,Ie[ot],Ce)){const it=ot===Ie.length-1?ke:Ye.vertexLength;this.indexArray.emplaceBack(Ri+2,Ri+3,it),this.indexArray.emplaceBack(Ri+3,it+1,it),this.indexArray.emplaceBack(Ri+3,Re,it+1),Ye.primitiveLength+=3}ut=!ut}if(I){const W=this.layoutVertexExtArray,Re=w.projectTilePoint(at.x,at.y,u),it=w.projectTilePoint(Et.x,Et.y,u),De=w.upVector(u,at.x,at.y),st=w.upVector(u,Et.x,Et.y);Dd(W,Re,De),Dd(W,Re,De),Dd(W,it,st),Dd(W,it,st)}}A&&(Oe+=Ie.length-1),L&&le&&this.zoom>=17&&(Ze.length!==0&&Me(Ze,Ze[0])&&Ze.pop(),this.groundEffect.addData(Ze,Ce,v,le>0))}this.footprintSegments.push(Fe),He.triangleCount=this.indexArray.length-He.triangleArrayOffset,this.polygonSegments.push(He),++D.footprintSegLen,++D.polygonSegLen}if(D.vertexCount=this.layoutVertexArray.length-D.vertexArrayOffset,D.groundVertexCount=this.groundEffect.vertexArray.length-D.groundVertexArrayOffset,D.vertexCount!==0){if(D.centroidXY=P.borders?Oy:this.encodeCentroid(P,D),this.centroidData.push(D),P.borders){this.featuresOnBorder.push(P);const ye=this.featuresOnBorder.length-1;for(let Ce=0;Ce<P.borders.length;Ce++)P.borders[Ce][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Ce].push(ye)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,a,h,f,u,g,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(i,a,h,f,u,g,this.worldview),this.maxHeight=Math.max(this.maxHeight,V)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort(((i,o)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[o].borders[e][0]))}splitToSubtiles(){const e=[];for(let f=0;f<this.centroidData.length;f++){const _=this.centroidData[f],g=+(_.min.y+_.max.y>Je),v=2*g+(+(_.min.x+_.max.x>Je)^g);for(let b=0;b<_.polygonSegLen;b++){const w=_.polygonSegIdx+b;e.push({centroidIdx:f,subtile:v,polygonSegmentIdx:w,triangleSegmentIdx:this.polygonSegments[w].triangleSegIdx})}}const i=new vr;e.sort(((f,_)=>f.triangleSegmentIdx===_.triangleSegmentIdx?f.subtile-_.subtile:f.triangleSegmentIdx-_.triangleSegmentIdx));let o=0,a=0,u=0;for(const f of e){if(f.triangleSegmentIdx!==o)break;u++}const h=e.length;for(;a!==e.length;){o=e[a].triangleSegmentIdx;let f=0,_=a,g=a;for(let v=_;v<u&&e[v].subtile===f;v++)g++;for(;_!==u;){const v=e[_];f=v.subtile;const b=this.centroidData[v.centroidIdx].min.clone(),w=this.centroidData[v.centroidIdx].max.clone(),I={vertexOffset:this.segments.segments[o].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[o].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let A=_;A<g;A++){const P=e[A],D=this.polygonSegments[P.polygonSegmentIdx],L=this.centroidData[P.centroidIdx].min,V=this.centroidData[P.centroidIdx].max,j=this.indexArray.uint16;for(let H=D.triangleArrayOffset;H<D.triangleArrayOffset+D.triangleCount;H++)i.emplaceBack(j[3*H],j[3*H+1],j[3*H+2]);I.primitiveLength+=D.triangleCount,b.x=Math.min(b.x,L.x),b.y=Math.min(b.y,L.y),w.x=Math.max(w.x,V.x),w.y=Math.max(w.y,V.y)}I.primitiveLength>0&&this.triangleSubSegments.push({segment:I,min:b,max:w}),_=g;for(let A=_;A<u&&e[A].subtile===e[_].subtile;A++)g++}a=u;for(let v=a;v<h&&e[v].triangleSegmentIdx===e[a].triangleSegmentIdx;v++)u++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,o){const a=new Ar;if(this.wallMode){for(const P of this.triangleSubSegments)a.segments.push(P.segment);return a}let u=0,h=0;const f=1<<e.canonical.z;if(i){const P=i.getMinMaxForTile(e);P&&(u=P.min,h=P.max)}h+=this.maxHeight;const _=e.toUnwrapped();let g;const v=[_.canonical.x/f+_.wrap,_.canonical.y/f],b=[(_.canonical.x+1)/f+_.wrap,(_.canonical.y+1)/f],w=(P,D,L)=>[P[0]*(1-L[0])+D[0]*L[0],P[1]*(1-L[1])+D[1]*L[1]],I=[],A=[];for(const P of this.triangleSubSegments){I[0]=P.min.x/Je,I[1]=P.min.y/Je,A[0]=P.max.x/Je,A[1]=P.max.y/Je;const D=w(v,b,I),L=w(v,b,A);if(new ri([D[0],D[1],u],[L[0],L[1],h]).intersectsPrecise(o)===0){g&&(a.segments.push(g),g=void 0);continue}const V=P.segment;g&&g.vertexOffset!==V.vertexOffset&&(a.segments.push(g),g=void 0),g?(g.vertexLength+=V.vertexLength,g.primitiveLength+=V.primitiveLength):g={vertexOffset:V.vertexOffset,primitiveLength:V.primitiveLength,vertexLength:V.vertexLength,primitiveOffset:V.primitiveOffset,sortKey:void 0,vaos:{}}}return g&&a.segments.push(g),a}encodeCentroid(e,i){const o=e.centroid(),a=i.span(),u=Math.min(7,Math.round(a.x*this.tileToMeter/10)),h=Math.min(7,Math.round(a.y*this.tileToMeter/10));return new Be(B(o.x,1,Je-1)<<3|u,B(o.y,1,Je-1)<<3|h)}encodeBorderCentroid(e){if(!e.borders)return new Be(0,0);const i=e.borders,o=Number.MAX_VALUE;if(i[0][0]!==o||i[1][0]!==o){const a=i[0][0]!==o?0:1;return new Be(6|(i[0][0]!==o?0:65528),(i[a][0]+i[a][1])/2<<3|6)}{const a=i[2][0]!==o?2:3;return new Be((i[a][0]+i[a][1])/2<<3|6,6|(i[2][0]!==o?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=2147483647,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,o=e.vertexCount+e.vertexArrayOffset,a=e.flags&Sl?Oy:e.centroidXY,u=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==a.y||u!==a.x){for(let h=i;h<o;++h)this.centroidVertexArray.emplace(h,a.x,a.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,o){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped());if(Sp(this.activeReplacements,a))return;if(this.activeReplacements=a,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const h of this.centroidData)h.flags&=2147483647;const u=[];for(const h of this.activeReplacements){if(h.order<o)continue;const f=Math.max(1,Math.pow(2,h.footprintTileId.canonical.z-e.canonical.z));if(h.footprint.buildingId){const _=h.footprint.buildingId;for(const g of this.centroidData)g.buildingId===_&&(g.flags|=Sl)}else for(const _ of this.centroidData)if(!(_.flags&Sl||h.min.x>_.max.x||_.min.x>h.max.x||h.min.y>_.max.y||_.min.y>h.max.y))for(let g=0;g<_.footprintSegLen;g++){const v=this.footprintSegments[_.footprintSegIdx+g];if(u.length=0,m1(this.footprintVertices,v.vertexOffset,v.vertexCount,h.footprintTileId.canonical,e.canonical,u),__(h.footprint,u,this.footprintIndices.uint16,v.indexOffset,v.indexCount,-v.vertexOffset,-f)){_.flags|=Sl;break}}}for(const h of this.centroidData)this.writeCentroidToBuffer(h);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,o){let a=!1;for(let u=0;u<o.footprintSegLen;u++){const h=this.footprintSegments[o.footprintSegIdx+u];let f=0;for(const _ of h.ringIndices){for(let g=f,v=_+f-1;g<_+f;v=g++){const b=this.footprintVertices.int16[2*(g+h.vertexOffset)+0],w=this.footprintVertices.int16[2*(g+h.vertexOffset)+1],I=this.footprintVertices.int16[2*(v+h.vertexOffset)+1];w>i!=I>i&&e<(this.footprintVertices.int16[2*(v+h.vertexOffset)+0]-b)*(i-w)/(I-w)+b&&(a=!a)}f=_}}return a}getHeightAtTileCoord(e,i){let o=Number.NEGATIVE_INFINITY,a=!0;const u=4*(e+Je)*Je+(i+Je);if(this.partLookup.hasOwnProperty(u)){const h=this.partLookup[u];return h?{height:h.height,hidden:!!(h.flags&Sl)}:void 0}for(const h of this.centroidData)e>h.max.x||h.min.x>e||i>h.max.y||h.min.y>i||h.height<=o||this.footprintContainsPoint(e,i,h)&&(o=h.height,this.partLookup[u]=h,a=!!(h.flags&Sl));if(o!==Number.NEGATIVE_INFINITY)return{height:o,hidden:a};this.partLookup[u]=void 0}}function jy(r,e){const i=r.add(e)._unit();return r.x*i.x+r.y*i.y}function p1(r,e,i,o){const a=e.sub(r)._perp()._unit(),u=i.sub(e)._perp()._unit();return Gy(r,e,i,jy(a,u),o)}function Gy(r,e,i,o,a){const u=Math.sqrt(1-o*o);return Math.min(r.dist(e)/3,e.dist(i)/3,a*u/o)}function b_(r,e,i){return r.x<i[0].x&&e.x<i[0].x||r.x>i[1].x&&e.x>i[1].x||r.y<i[0].y&&e.y<i[0].y||r.y>i[1].y&&e.y>i[1].y}function Hy(r,e){return r.x<e[0].x||r.x>e[1].x||r.y<e[0].y||r.y>e[1].y}function qy(r,e,i){if(r.x<0||r.x>=Je||e.x<0||e.x>=Je||i.x<0||i.x>=Je)return!1;const o=i.sub(e),a=o.perp(),u=r.sub(e);return(o.x*u.x+o.y*u.y)/Math.sqrt((o.x*o.x+o.y*o.y)*(u.x*u.x+u.y*u.y))>-.866&&a.x*u.x+a.y*u.y<0}function $y(r,e,i){const o=e?2|r:-3&r;return i?1|o:-2&o}function Zy(){const r=Math.PI/32,e=Math.tan(r),i=T;return i*Math.sqrt(1+2*e*e)-i}function Wy(r,e,i){const o=1<<i.z,a=$(i.x/o),u=$((i.x+1)/o),h=G(i.y/o),f=G((i.y+1)/o);return(function(_,g,v,b,w=0,I){const A=[];if(!_.length||!v||!b)return A;const P=(K,oe)=>{for(const le of K)A.push({polygon:le,bounds:oe})},D=Math.ceil(Math.log2(v)),L=Math.ceil(Math.log2(b)),V=D-L,j=[];for(let K=0;K<Math.abs(V);K++)j.push(V>0?0:1);for(let K=0;K<Math.min(D,L);K++)j.push(0),j.push(1);let H=_;if(H=bp(H,g[0].y-w,g[1].y+w,1),H=bp(H,g[0].x-w,g[1].x+w,0),!H.length)return A;const te=[];for(j.length?te.push({polygons:H,bounds:g,depth:0}):P(H,g);te.length;){const K=te.pop(),oe=K.depth,le=j[oe],ue=K.bounds[0],Me=K.bounds[1],ye=le===0?ue.x:ue.y,Ce=le===0?Me.x:Me.y,Oe=I?I(le,ye,Ce):.5*(ye+Ce),Ne=bp(K.polygons,ye-w,Oe+w,le),Ye=bp(K.polygons,Oe-w,Ce+w,le);if(Ne.length){const He=[ue,new Be(le===0?Oe:Me.x,le===1?Oe:Me.y)];j.length>oe+1?te.push({polygons:Ne,bounds:He,depth:oe+1}):P(Ne,He)}if(Ye.length){const He=[new Be(le===0?Oe:ue.x,le===1?Oe:ue.y),Me];j.length>oe+1?te.push({polygons:Ye,bounds:He,depth:oe+1}):P(Ye,He)}}return A})(r,e,Math.ceil((u-a)/11.25),Math.ceil((h-f)/11.25),1,((_,g,v)=>{if(_===0)return .5*(g+v);{const b=G((i.y+g/Je)/o);return(k(.5*(G((i.y+v/Je)/o)+b))*o-i.y)*Je}}))}function m1(r,e,i,o,a,u){const h=Math.pow(2,o.z-a.z);for(let f=0;f<i;f++){let _=r.int16[2*(f+e)+0],g=r.int16[2*(f+e)+1];_=(_+a.x*Je)*h-o.x*Je,g=(g+a.y*Je)*h-o.y*Je,u.push(new Be(_,g))}}let Xy,Yy;pt(Ip,"FillExtrusionBucket",{omit:["layers","features"]}),pt(Ny,"PartData"),pt(By,"FootprintSegment"),pt(Vy,"BorderCentroidData"),pt(v_,"GroundEffect");class wc extends Be{constructor(e,i,o){super(e,i),this.z=o}}class Ky extends wc{constructor(e,i,o,a){super(e,i,o),this.w=a}}function Jy(r,e,i,o){const a=i==="x"?"y":"x",u=(o-r[i])/(e[i]-r[i]);r[a]=Math.round(r[a]+(e[a]-r[a])*u),r[i]=o,r.hasOwnProperty("z")&&(r.z=Ft(r.z,e.z,u)),r.hasOwnProperty("w")&&(r.w=Ft(r.w,e.w,u))}function Qy(r,e,i,o){const a=i,u=o;for(const h of["x","y"]){let f=r,_=e;f[h]>=_[h]&&(f=e,_=r),f[h]<a&&_[h]>a&&Jy(f,_,h,a),f[h]<u&&_[h]>u&&Jy(_,f,h,u)}}function Ap(r,e,i,o,a,u){const h=[];for(let f=0;f<r.length;f++){const _=r[f];let g;const v=h.length;let b=0;for(let w=0;w<_.length-1;w++){let I=_[w],A=_[w+1],P=0;const D=b;let L,V;u&&(P=Math.hypot(A.x-I.x,A.y-I.y),b+=P,L=I,V=A),I.x<e&&A.x<e||(I.x<e?I=new Be(e,I.y+(e-I.x)/(A.x-I.x)*(A.y-I.y))._round():A.x<e&&(A=new Be(e,I.y+(e-I.x)/(A.x-I.x)*(A.y-I.y))._round()),I.y<i&&A.y<i||(I.y<i?I=new Be(I.x+(i-I.y)/(A.y-I.y)*(A.x-I.x),i)._round():A.y<i&&(A=new Be(I.x+(i-I.y)/(A.y-I.y)*(A.x-I.x),i)._round()),I.x>=o&&A.x>=o||(I.x>=o?I=new Be(o,I.y+(o-I.x)/(A.x-I.x)*(A.y-I.y))._round():A.x>=o&&(A=new Be(o,I.y+(o-I.x)/(A.x-I.x)*(A.y-I.y))._round()),I.y>=a&&A.y>=a||(I.y>=a?I=new Be(I.x+(a-I.y)/(A.y-I.y)*(A.x-I.x),a)._round():A.y>=a&&(A=new Be(I.x+(a-I.y)/(A.y-I.y)*(A.x-I.x),a)._round()),g&&I.equals(g[g.length-1])||(g=[I],h.push(g),u&&u.push({progress:{min:D+ex(L,V,I)*P,max:1},parentIndex:f,prevPoint:L,nextPoint:V})),g.push(A),u&&(u[u.length-1].progress.max=D+ex(L,V,A)*P,u[u.length-1].nextPoint=V)))))}if(u&&b>0)for(let w=v;w<h.length;w++)u[w].progress.min/=b,u[w].progress.max/=b}return h}function _1(r,e,i,o,a){if(r.length<2)return void o.push(r);const u=[];for(;e.valid();){const[g,v]=e.get();for(let b=0;b<r.length-1;b++){const w=r[b],I=r[b+1],A=ko(w,I,g,v);if(A){const[P]=A,D=new Be(Ft(w.x,I.x,P),Ft(w.y,I.y,P));u.push({t:b+P,distance:0,point:D})}}e.next()}if(u.length===0)return void o.push(r);u.sort(((g,v)=>g.t-v.t));let h=0,f=0,_=[];for(o.push(_);h!==r.length;){if(f===u.length){for(;h!==r.length;)_.length!==0&&_[_.length-1].equals(r[h])||_.push(r[h]),h++;break}u[f].t<=h?(_.length!==0&&_[_.length-1].equals(u[f].point)||_.push(u[f].point),Math.trunc(u[f].t),f++):(_.length!==0&&_[_.length-1].equals(r[h])||_.push(r[h]),h++)}}function ex(r,e,i){return r.x!==e.x?(i.x-r.x)/(e.x-r.x):r.y!==e.y?(i.y-r.y)/(e.y-r.y):0}function zd(r,e){return r.x*e.x+r.y*e.y}function tx(r,e){if(r.length===1){let i=0;const o=e[i++];let a;for(;!a||o.equals(a);)if(a=e[i++],!a)return 1/0;for(;i<e.length;i++){const u=e[i],h=r[0],f=a.sub(o),_=u.sub(o),g=h.sub(o),v=zd(f,f),b=zd(f,_),w=zd(_,_),I=zd(g,f),A=zd(g,_),P=v*w-b*b,D=(w*I-b*A)/P,L=(v*A-b*I)/P,V=o.z*(1-D-L)+a.z*D+u.z*L;if(isFinite(V))return V}return 1/0}{let i=1/0;for(const o of e)i=Math.min(i,o.z);return i}}function ix(r,e,i){let o=1/0;Br(i,e)&&(o=tx(i,e[0]));for(let a=0;a<e.length;a++){const u=e[a],h=r[a];for(let f=0;f<u.length-1;f++){const _=u[f],g=[_,u[f+1],h[f+1],h[f],_];jr(i,g)&&(o=Math.min(o,tx(i,g)))}}return o!==1/0&&o}function rx(r,e,i,o,a,u,h,f,_,g,v){return r.projection.name==="globe"?(function(b,w,I,A,P,D,L,V,j,H,te){const K=[],oe=[],le=b.projection.upVectorScale(te,b.center.lat,b.worldSize).metersToTile,ue=[0,0,0,1],Me=[0,0,0,1],ye=(Oe,Ne,Ye,He)=>{Oe[0]=Ne,Oe[1]=Ye,Oe[2]=He,Oe[3]=1},Ce=Zy();I>0&&(I+=Ce),A+=Ce;for(const Oe of w){const Ne=[],Ye=[];for(const He of Oe){const Fe=He.x+P.x,Ge=He.y+P.y,Ie=b.projection.projectTilePoint(Fe,Ge,te),Se=b.projection.upVector(te,He.x,He.y);let Ue=I,Ze=A;if(L){const ke=nx(Fe,Ge,I,A,L,V,j,H);Ue+=ke.base,Ze+=ke.top}I!==0?ye(ue,Ie.x+Se[0]*le*Ue,Ie.y+Se[1]*le*Ue,Ie.z+Se[2]*le*Ue):ye(ue,Ie.x,Ie.y,Ie.z),ye(Me,Ie.x+Se[0]*le*Ze,Ie.y+Se[1]*le*Ze,Ie.z+Se[2]*le*Ze),nr(ue,ue,D),nr(Me,Me,D),Ne.push(new wc(ue[0],ue[1],ue[2])),Ye.push(new wc(Me[0],Me[1],Me[2]))}K.push(Ne),oe.push(Ye)}return[K,oe]})(r,e,i,o,a,u,h,f,_,g,v):h?(function(b,w,I,A,P,D,L,V,j){const H=[],te=[],K=[0,0,0,1];for(const oe of b){const le=[],ue=[];for(const Me of oe){const ye=Me.x+A.x,Ce=Me.y+A.y,Oe=nx(ye,Ce,w,I,D,L,V,j);K[0]=ye,K[1]=Ce,K[2]=Oe.base,K[3]=1,pn(K,K,P),K[3]=Math.max(K[3],1e-5);const Ne=new wc(K[0]/K[3],K[1]/K[3],K[2]/K[3]);K[0]=ye,K[1]=Ce,K[2]=Oe.top,K[3]=1,pn(K,K,P),K[3]=Math.max(K[3],1e-5);const Ye=new wc(K[0]/K[3],K[1]/K[3],K[2]/K[3]);le.push(Ne),ue.push(Ye)}H.push(le),te.push(ue)}return[H,te]})(e,i,o,a,u,h,f,_,g):(function(b,w,I,A,P){const D=[],L=[],V=P[8]*w,j=P[9]*w,H=P[10]*w,te=P[11]*w,K=P[8]*I,oe=P[9]*I,le=P[10]*I,ue=P[11]*I;for(const Me of b){const ye=[],Ce=[];for(const Oe of Me){const Ne=Oe.x+A.x,Ye=Oe.y+A.y,He=P[0]*Ne+P[4]*Ye+P[12],Fe=P[1]*Ne+P[5]*Ye+P[13],Ge=P[2]*Ne+P[6]*Ye+P[14],Ie=P[3]*Ne+P[7]*Ye+P[15],Se=He+V,Ue=Fe+j,Ze=Ge+H,ke=Math.max(Ie+te,1e-5),ft=He+K,_t=Fe+oe,ut=Ge+le,ot=Math.max(Ie+ue,1e-5);ye.push(new wc(Se/ke,Ue/ke,Ze/ke)),Ce.push(new wc(ft/ot,_t/ot,ut/ot))}D.push(ye),L.push(Ce)}return[D,L]})(e,i,o,a,u)}function nx(r,e,i,o,a,u,h,f){const _=h*a.getElevationAt(r,e,!0,!0),g=u[0]!==0,v=g?u[1]===0?h*(u[0]/Fy-ky):h*(function(b,w,I){const A=Math.floor(w[0]/8),P=Math.floor(w[1]/8),D=10*(w[0]-8*A),L=10*(w[1]-8*P),V=b.getElevationAt(A,P,!0,!0),j=b.getMeterToDEM(I),H=Math.floor(.5*(D*j-1)),te=Math.floor(.5*(L*j-1)),K=b.tileCoordToPixel(A,P),oe=2*H+1,le=2*te+1,ue=(function(Ye,He,Fe,Ge,Ie){return[Ye.getElevationAtPixel(He,Fe,!0),Ye.getElevationAtPixel(He+Ie,Fe,!0),Ye.getElevationAtPixel(He,Fe+Ie,!0),Ye.getElevationAtPixel(He+Ge,Fe+Ie,!0)]})(b,K.x-H,K.y-te,oe,le),Me=Math.abs(ue[0]-ue[1]),ye=Math.abs(ue[2]-ue[3]),Ce=Math.abs(ue[0]-ue[2])+Math.abs(ue[1]-ue[3]),Oe=Math.min(.25,.5*j*(Me+ye)/oe),Ne=Math.min(.25,.5*j*Ce/le);return V+Math.max(Oe*D,Ne*L)})(a,u,f):_;return{base:_+(i===0?-1:i),top:g?Math.max(v+o,_+i+2):_+o}}class g1{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class y1{constructor(){this.tasks={},this.taskQueue=[],Te(["process"],this),this.invoker=new g1(this.process),this.nextId=0}add(e,i){const o=this.nextId++,a=(function({type:u,isSymbolTile:h,zoom:f}){return f=f||0,u==="message"?0:u!=="maybePrepare"||h?u!=="parseTile"||h?u==="parseTile"&&h?300-f:u==="maybePrepare"&&h?400-f:500:200-f:100-f})(i);if(a===0){try{e()}finally{}return null}return this.tasks[o]={fn:e,metadata:i,priority:a,id:o},this.taskQueue.push(o),this.invoker.trigger(),{cancel:()=>{delete this.tasks[o]}}}process(){try{if(this.taskQueue=this.taskQueue.filter((o=>!!this.tasks[o])),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let a=0;a<this.taskQueue.length;a++){const u=this.tasks[this.taskQueue[a]];u.priority<i&&(i=u.priority,e=a)}if(e===null)return null;const o=this.taskQueue[e];return this.taskQueue.splice(e,1),o}remove(){this.invoker.remove()}}class ox{constructor(e,i,o){this.target=e,this.parent=i,this.mapId=o,this.callbacks={},this.cancelCallbacks={},Te(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new y1}send(e,i,o,a,u=!1,h){const f=Math.round(1e18*Math.random()).toString(36).substring(0,10);o&&(o.metadata=h,this.callbacks[f]=o);const _=new Set;return this.target.postMessage({id:f,type:e,hasCallback:!!o,targetMapId:a,mustQueue:u,sourceMapId:this.mapId,data:ra(i,_)},_),{cancel:()=>{o&&delete this.callbacks[f],this.target.postMessage({id:f,type:"<cancel>",targetMapId:a,sourceMapId:this.mapId})}}}receive(e){const i=e.data;if(!i)return;const o=i.id;if(o&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const a=this.cancelCallbacks[o];delete this.cancelCallbacks[o],a&&a.cancel()}else if(i.mustQueue||Fr(self)){const a=this.callbacks[o],u=this.scheduler.add((()=>this.processTask(o,i)),a&&a.metadata||{type:"message"});u&&(this.cancelCallbacks[o]=u)}else this.processTask(o,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){const o=this.callbacks[e];delete this.callbacks[e],o&&(i.error?o(na(i.error)):o(null,na(i.data)))}else{const o=new Set,a=i.hasCallback?(h,f)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:h?ra(h):null,data:ra(f,o)},o)}:()=>{},u=na(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,u,a);else if(this.parent.getWorkerSource){const h=i.type.split("."),{source:f,scope:_}=u;this.parent.getWorkerSource(i.sourceMapId,h[0],f,_)[h[1]](u,a)}else a(new Error("Could not find function ".concat(i.type)))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var Ld={workerUrl:"",workerClass:null,workerParams:void 0};const w_="mapboxgl_preloaded_worker_pool";class Tc{constructor(){this.active={}}acquire(e,i=Tc.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;)this.workers.push(Ld.workerClass!=null?new Ld.workerClass:new self.Worker(Ld.workerUrl,Ld.workerParams));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach((i=>{i.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[w_]}numActive(){return Object.keys(this.active).length}}Tc.workerCount=2;class ku{constructor(e,i,o="Worker",a=Tc.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Ee();const u=this.workerPool.acquire(this.id,a);for(let h=0;h<u.length;h++){const f=new ku.Actor(u[h],i,this.id);f.name="".concat(o," ").concat(h),this.actors.push(f)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(e,i,o){se(this.actors,((a,u)=>{a.send(e,i,u)}),o=o||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((e=>{e.remove()})),this.actors=[],this.workerPool.release(this.id)}}let Od,T_;function Mp(){return Od||(Od=new Tc),Od}ku.Actor=ox;class x1{constructor(e){this.module=e}createIntArray(e){const i=new Int32Array(e),o=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heap32.set(i,o/i.BYTES_PER_ELEMENT),o}createFloatArray(e){const i=new Float32Array(e),o=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heapF32.set(i,o/i.BYTES_PER_ELEMENT),o}createStringBuffer(e){const i=this.module.malloc(e.length+1);for(let o=0;o<e.length;++o)this.module.heapU8[i+o]=e.charCodeAt(o);return this.module.heapU8[i+e.length]=0,i}readStringBuffer(e){let i="";for(;this.module.heapU8[e]!==0;)i+=String.fromCharCode(this.module.heapU8[e]),++e;return i}setStyle(e){const i=e.entranceColorRgb,o=e.facadeGlazingColorRgb,a=e.roofColorRgb,u=e.wallColorRgb,h=e.normalScale;this.module.setStyle(i[0],i[1],i[2],o[0],o[1],o[2],a[0],a[1],a[2],u[0],u[1],u[2],h[0],h[1],h[2],e.tileToMeters)}setAOOptions(e,i){this.module.setAOOptions(e?1:0,i)}setMetricOptions(e,i){this.module.setMetricOptions(e?1:0,i)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,i){this.module.setFacadeOptions(e,i?1:0)}setFauxFacadeOptions(e,i,o){this.module.setFauxFacadeOptions(e?1:0,i?1:0,o)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,i){for(const f of e){const _=this.createStringBuffer(f.roofType),g=[0],v=[];for(const I of f.coordinates)if(Array.isArray(I)){for(const A of I)v.push(A.x),v.push(A.y);g.push(v.length)}const b=this.createIntArray(g),w=this.createFloatArray(v);this.module.addFeature(f.id,f.sourceId,f.minHeight,f.height,_,f.roofType.length,w,b,g.length-1),this.module.free(_),this.module.free(b),this.module.free(w)}for(const f of i){let _;_=f.entrances?JSON.parse(f.entrances):[];const g=this.createFloatArray(_),v=[];for(const w of f.coordinates)v.push(w.x),v.push(w.y);const b=this.createFloatArray(v);this.module.addFacade(f.sourceId,f.crossPerc,f.distanceToRoad,g,_.length,b,v.length),this.module.free(g),this.module.free(b)}if(!this.module.generateMesh()){const f=this.module.getLastError();return this.readStringBuffer(f)}const o=this.module.getMeshCount(),a=new Array(o);for(let f=0;f<o;f++){const _=this.module.getPositionsPtr(f),g=this.module.getPositionsLength(f),v=new Float32Array(this.module.heapF32.buffer,_,g),b=this.module.getNormalsPtr(f),w=this.module.getNormalsLength(f),I=new Float32Array(this.module.heapF32.buffer,b,w),A=this.module.getColorsPtr(f),P=this.module.getColorsLength(f),D=new Uint8Array(this.module.heapU8.buffer,A,P),L=this.module.getAOPtr(f),V=this.module.getAOLength(f),j=new Float32Array(this.module.heapF32.buffer,L,V),H=this.module.getUVPtr(f),te=this.module.getUVLength(f),K=new Float32Array(this.module.heapF32.buffer,H,te),oe=this.module.getFauxFacadePtr(f),le=this.module.getFauxFacadeLength(f),ue=new Uint8Array(this.module.heapU8.buffer,oe,le),Me=this.module.getIndicesPtr(f),ye=this.module.getIndicesLength(f),Ce=new Int32Array(this.module.heap32.buffer,Me,ye),Oe=this.module.getBuildingPart(f),Ne=this.readStringBuffer(Oe);a[f]={positions:v,normals:I,colors:D,ao:j,uv:K,isFauxFacade:ue,indices:Ce,buildingPart:Ne}}const u=this.module.getRingCount(),h=[];for(let f=0;f<u;f++){const _=this.module.getRingPtr(f),g=this.module.getRingLength(f),v=new Float32Array(this.module.heapF32.buffer,_,g);h.push(v)}return{meshes:a,outerRingLength:this.module.getOuterRingLength(),modifiedPolygonRings:h}}}let Fd,S_,Hs,Bu,E_,Nu=null,Vu=null,sx=null,Cp=null;function ax(){return Fr(self)&&self.worker.dracoUrl?self.worker.dracoUrl:S_||fr.DRACO_URL}function lx(){if(Fr(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Bu)return Bu;const r=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Bu=WebAssembly.validate(r)?fr.MESHOPT_SIMD_URL:fr.MESHOPT_URL,Bu}function v1(){return Cp}const Pp={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},b1={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},kd={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function cx(r,e,i){const o=i.json.bufferViews.length,a=i.buffers.length;e.bufferView=o,i.json.bufferViews[o]={buffer:a,byteLength:r.byteLength},i.buffers[a]=r}const I_="KHR_draco_mesh_compression";function w1(r,e){const i=r.extensions&&r.extensions[I_];if(!i)return;const o=new Hs.Decoder,a=fx(e,i.bufferView),u=new Hs.Mesh;if(!o.DecodeArrayToMesh(a,a.byteLength,u))throw new Error("Failed to decode Draco mesh");const h=e.json.accessors[r.indices],f=Pp[h.componentType],_=h.count*f.BYTES_PER_ELEMENT,g=Hs._malloc(_);f===Uint16Array?o.GetTrianglesUInt16Array(u,_,g):o.GetTrianglesUInt32Array(u,_,g),cx(Hs.memory.buffer.slice(g,g+_),h,e),Hs._free(g);for(const v of Object.keys(i.attributes)){const b=o.GetAttributeByUniqueId(u,i.attributes[v]),w=e.json.accessors[r.attributes[v]],I=b1[w.componentType],A=w.count*kd[w.type]*Pp[w.componentType].BYTES_PER_ELEMENT,P=Hs._malloc(A);o.GetAttributeDataArrayForAllPoints(u,b,Hs[I],A,P),cx(Hs.memory.buffer.slice(P,P+A),w,e),Hs._free(P)}o.destroy(),u.destroy(),delete r.extensions[I_]}const Rp="EXT_meshopt_compression";function T1(r,e){if(!r.extensions||!r.extensions[Rp])return;const i=r.extensions[Rp],o=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),a=new Uint8Array(i.count*i.byteStride);E_.decodeGltfBuffer(a,i.count,i.byteStride,o,i.mode,i.filter),r.buffer=e.buffers.length,r.byteOffset=0,e.buffers[r.buffer]=a.buffer,delete r.extensions[Rp]}const ux=1179937895,hx=new TextDecoder("utf8");function dx(r,e){return new URL(r,e).href}function S1(r,e,i,o){return fetch(dx(r.uri,o)).then((a=>a.arrayBuffer())).then((a=>{e.buffers[i]=a}))}function fx(r,e){const i=r.json.bufferViews[e];return new Uint8Array(r.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function E1(r,e,i,o){if(r.uri){const a=dx(r.uri,o);return fetch(a).then((u=>u.blob())).then((u=>createImageBitmap(u))).then((u=>{e.images[i]=u}))}if(r.bufferView!==void 0){const a=fx(e,r.bufferView),u=new Blob([a],{type:r.mimeType});return createImageBitmap(u).then((h=>{e.images[i]=h}))}}function px(r,e=0,i){const o={json:null,images:[],buffers:[]};if(new Uint32Array(r,e,1)[0]===ux){const v=new Uint32Array(r,e);let b=2;const w=(v[b++]>>2)-3,I=v[b++]>>2;if(b++,o.json=JSON.parse(hx.decode(v.subarray(b,b+I))),b+=I,b<w){const A=v[b++];b++;const P=e+(b<<2);o.buffers[0]=r.slice(P,P+A)}}else o.json=JSON.parse(hx.decode(new Uint8Array(r,e)));const{buffers:a,images:u,meshes:h,extensionsUsed:f,bufferViews:_}=o.json;let g=Promise.resolve();if(a){const v=[];for(let b=0;b<a.length;b++){const w=a[b];w.uri?v.push(S1(w,o,b,i)):o.buffers[b]||(o.buffers[b]=null)}g=Promise.all(v)}return g.then((()=>{const v=[],b=f&&f.includes(I_),w=f&&f.includes(Rp);if(b&&v.push((function(){if(!Hs)return Fd!=null?Fd:(Fd=(function(I){let A,P=null;function D(){A=new Uint8Array(P.buffer)}function L(){throw new Error("Unexpected Draco error.")}const V={a:{a:L,d:function(j,H,te){return A.copyWithin(j,H,H+te)},c:function(j){const H=A.length,te=Math.max(j>>>0,Math.ceil(1.2*H)),K=Math.ceil((te-H)/65536);try{return P.grow(K),D(),!0}catch(oe){return!1}},b:L}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(I,V):I.then((j=>j.arrayBuffer())).then((j=>WebAssembly.instantiate(j,V)))).then((j=>{const{Rb:H,Qb:te,P:K,T:oe,X:le,Ja:ue,La:Me,Qa:ye,Va:Ce,Wa:Oe,eb:Ne,jb:Ye,f:He,e:Fe,yb:Ge,zb:Ie,Ab:Se,Bb:Ue,Db:Ze,Gb:ke}=j.instance.exports;P=Fe;const ft=(()=>{let _t=0,ut=0,ot=0,jt=0;return at=>{ot&&(H(jt),H(_t),ut+=ot,ot=_t=0),_t||(ut+=128,_t=te(ut));const Et=at.length+7&-8;let Ht=_t;Et>=ut&&(ot=Et,Ht=jt=te(Et));for(let oi=0;oi<at.length;oi++)A[Ht+oi]=at[oi];return Ht}})();return D(),He(),{memory:Fe,_free:H,_malloc:te,Mesh:class{constructor(){this.ptr=K()}destroy(){oe(this.ptr)}},Decoder:class{constructor(){this.ptr=ue()}destroy(){Ye(this.ptr)}DecodeArrayToMesh(_t,ut,ot){const jt=ft(_t),at=Me(this.ptr,jt,ut,ot.ptr);return!!le(at)}GetAttributeByUniqueId(_t,ut){return{ptr:ye(this.ptr,_t.ptr,ut)}}GetTrianglesUInt16Array(_t,ut,ot){Ce(this.ptr,_t.ptr,ut,ot)}GetTrianglesUInt32Array(_t,ut,ot){Oe(this.ptr,_t.ptr,ut,ot)}GetAttributeDataArrayForAllPoints(_t,ut,ot,jt,at){Ne(this.ptr,_t.ptr,ut.ptr,ot,jt,at)}},DT_INT8:Ge(),DT_UINT8:Ie(),DT_INT16:Se(),DT_UINT16:Ue(),DT_UINT32:Ze(),DT_FLOAT32:ke()}}))})(fetch(ax())),Fd.then((I=>{Hs=I,Fd=void 0})))})()),w&&v.push((function(){if(E_)return;const I=(function(A){let P;const D=WebAssembly.instantiateStreaming(A,{}).then((j=>{P=j.instance,P.exports.__wasm_call_ctors()})),L={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},V={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:D,supported:!0,decodeGltfBuffer(j,H,te,K,oe,le){(function(ue,Me,ye,Ce,Oe,Ne,Ye){const He=ue.exports.sbrk,Fe=Ce+3&-4,Ge=He(Fe*Oe),Ie=He(Ne.length),Se=new Uint8Array(ue.exports.memory.buffer);Se.set(Ne,Ie);const Ue=Me(Ge,Ce,Oe,Ie,Ne.length);if(Ue===0&&Ye&&Ye(Ge,Fe,Oe),ye.set(Se.subarray(Ge,Ge+Ce*Oe)),He(Ge-He(0)),Ue!==0)throw new Error("Malformed buffer data: ".concat(Ue))})(P,P.exports[V[oe]],j,H,te,K,P.exports[L[le]])}}})(fetch(lx()));return I.ready.then((()=>{E_=I}))})()),u)for(let I=0;I<u.length;I++)v.push(E1(u[I],o,I,i));return(v.length?Promise.all(v):Promise.resolve()).then((()=>{if(b&&h)for(const{primitives:I}of h)for(const A of I)w1(A,o);if(w&&h&&_)for(const I of _)T1(I,o);return o}))}))}function mx(r){return fetch(r).then((e=>e.arrayBuffer())).then((e=>px(e,0,r)))}function A_(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function M_(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class C_{constructor(e,i,o,a){this.context=e,this.format=o,this.useMipmap=a&&a.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:a&&a.premultiply})}update(e,i){const o=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,a=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:u}=this,{gl:h}=u,{x:f,y:_}=i&&i.position?i.position:{x:0,y:0},g=f+o,v=_+a;!this.size||this.size[0]===g&&this.size[1]===v||(h.bindTexture(h.TEXTURE_2D,null),h.deleteTexture(this.texture),this.texture=h.createTexture(),this.size=null),h.bindTexture(h.TEXTURE_2D,this.texture),u.pixelStoreUnpackFlipY.set(!1),u.pixelStoreUnpack.set(1),u.pixelStoreUnpackPremultiplyAlpha.set(this.format===h.RGBA8&&(!i||i.premultiply!==!1));const b=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&g>0&&v>0){const w=this.useMipmap?Math.floor(Math.log2(Math.max(g,v)))+1:1;h.texStorage2D(h.TEXTURE_2D,w,this.format,g,v),this.size=[g,v]}this.size&&(b?h.texSubImage2D(h.TEXTURE_2D,0,f,_,A_(this.format),M_(this.format),e):"data"in e&&e.data&&h.texSubImage2D(h.TEXTURE_2D,0,f,_,o,a,A_(this.format),M_(this.format),e.data)),this.useMipmap&&h.generateMipmap(h.TEXTURE_2D)}bind(e,i,o=!1){const{context:a}=this,{gl:u}=a;u.bindTexture(u.TEXTURE_2D,this.texture),e!==this.minFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,e),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,this.useMipmap&&!o?e===u.NEAREST?u.NEAREST_MIPMAP_NEAREST:u.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,i),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,o,a,u){const{context:h}=this,{gl:f}=h;f.bindTexture(f.TEXTURE_2D,this.texture),i!==this.magFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,this.useMipmap?e===f.NEAREST?f.NEAREST_MIPMAP_NEAREST:f.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),o!==this.wrapS&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,o),this.wrapS=o),a!==this.wrapT&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,a),this.wrapT=a),u!==this.compareMode&&(u?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_MODE,f.COMPARE_REF_TO_TEXTURE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_FUNC,u)):f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_MODE,f.NONE),this.compareMode=u)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Bd{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:o}=this,{gl:a}=o;a.bindTexture(a.TEXTURE_2D,this.texture),e!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,i),this.wrapS=i)}}const I1=ai([{name:"a_pos_3f",components:3,type:"Float32"}]),A1=ai([{name:"a_color_3f",components:3,type:"Float32"}]),M1=ai([{name:"a_color_4f",components:4,type:"Float32"}]),C1=ai([{name:"a_uv_2f",components:2,type:"Float32"}]),P1=ai([{name:"a_normal_3f",components:3,type:"Float32"}]),R1=ai([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),D1=ai([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function _x(r,e){const i=Dp(r.projection,r.zoom,r.width,r.height),o=(function(u,h,f,_,g){const v=new M(f.lng-180*El,f.lat),b=new M(f.lng+180*El,f.lat),w=u.project(v.lng,v.lat),I=u.project(b.lng,b.lat),A=-Math.atan2(I.y-w.y,I.x-w.x),P=_e.fromLngLat(f);P.y=B(P.y,-1+El,1-El);const D=P.toLngLat(),L=u.project(D.lng,D.lat),V=_e.fromLngLat(D);V.x+=El;const j=V.toLngLat(),H=u.project(j.lng,j.lat),te=yx(H.x-L.x,H.y-L.y,A),K=_e.fromLngLat(D);K.y+=El;const oe=K.toLngLat(),le=u.project(oe.lng,oe.lat),ue=yx(le.x-L.x,le.y-L.y,A),Me=Math.abs(te.x)/Math.abs(ue.y),ye=Dt([]);Ti(ye,ye,-A*(1-(g?0:_)));const Ce=Dt([]);return Ci(Ce,Ce,[1,1-(1-Me)*_,1]),Ce[4]=-ue.x/ue.y*_,Ti(Ce,Ce,A),Yt(Ce,ye,Ce),Ce})(r.projection,0,r.center,i,e),a=gx(r);return Ci(o,o,[a,a,1]),o}function gx(r){const e=r.projection,i=Dp(r.projection,r.zoom,r.width,r.height),o=P_(e,r.center),a=P_(e,M.convert(e.center));return Math.pow(2,o*i+(1-i)*a)}function Dp(r,e,i,o,a=1/0){const u=r.range;if(!u)return 0;const h=Math.min(a,Math.max(i,o)),f=Math.log2(h/1024);return X(u[0]+f,u[1]+f,e)}const El=1/4e4;function P_(r,e){const i=B(e.lat,-Z,Z),o=new M(e.lng-180*El,i),a=new M(e.lng+180*El,i),u=r.project(o.lng,i),h=r.project(a.lng,i),f=_e.fromLngLat(o),_=_e.fromLngLat(a),g=h.x-u.x,v=h.y-u.y,b=_.x-f.x,w=_.y-f.y,I=Math.sqrt((b*b+w*w)/(g*g+v*v));return Math.log2(I)}function yx(r,e,i){const o=Math.cos(i),a=Math.sin(i);return{x:r*o-e*a,y:r*a+e*o}}function xx(r,e,i){Dt(r),Ti(r,r,ii(e[2])),tr(r,r,ii(e[0])),vi(r,r,ii(e[1])),Ci(r,r,i),Yt(r,r,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function zp(r,e,i,o,a,u,h,f){const _=[i[0]-e[0],i[1]-e[1],0],g=[o[0]-e[0],o[1]-e[1],0];if(yn(_)<1e-12||yn(g)<1e-12)return Rt(r);const v=Cr([],_,g);Oi(v,v),en(g,o,e),_[2]=(u-a)*f,g[2]=(h-a)*f;const b=_;return Cr(b,_,g),Oi(b,b),Xo(r,v,b)}function Lp(r,e,i=!1){const o=wl(e.zoom),a=(function(u,h,f){const _=h.worldSize,g=[u[12],u[13],u[14]],v=G(g[1]/_),b=$(g[0]/_),w=Dt([]),I=U(1,v)*_,A=U(1,0)*_*Q(v,h.zoom),P=1/o_(_);let D=A*P;if(f){const H=Dp(h.projection,h.zoom,h.width,h.height,1024);D=P*h.projection.pixelSpaceConversion(h.center.lat,_,H)}const L=x(v,b);Er(L,L,Wi([],Oi([],L),I*D*g[2]));const V=(function(H){const te=[H[0],H[1],H[2]];let K=[0,1,0];const oe=Cr([],K,te);return Cr(K,te,oe),us(K)===0&&(K=[0,1,0],Cr(oe,te,K)),Oi(oe,oe),Oi(K,K),Oi(te,te),[oe[0],oe[1],oe[2],0,K[0],K[1],K[2],0,te[0],te[1],te[2],0,H[0],H[1],H[2],1]})(L);Ci(w,w,[D,D,D*I]),wi(w,w,[-g[0],-g[1],-g[2]]);const j=Yt([],h.globeMatrix,V);return Yt(j,j,w),Yt(j,j,u),j})(r,e,i);if(o>0){const u=(function(h,f){const _=f.worldSize,g=U(1,0)*_*Q(f.center.lat,f.zoom)/o_(_),v=U(1,f.center.lat)*_,b=Dt([]);vi(b,b,ii(f.center.lng)),tr(b,b,ii(f.center.lat)),wi(b,b,[0,0,_o]),Ci(b,b,[g,g,g*v]);const w=f.point;return wi(b,b,[-w.x,-w.y,0]),Yt(b,b,h),Yt(b,f.globeMatrix,b)})(r,e);return(function(h,f,_){const g=(A,P,D)=>{const L=yn(A),V=yn(P),j=La(A,P,D);return Wi(j,j,1/yn(j)*Ft(L,V,D))},v=g([h[0],h[1],h[2]],[f[0],f[1],f[2]],_),b=g([h[4],h[5],h[6]],[f[4],f[5],f[6]],_),w=g([h[8],h[9],h[10]],[f[8],f[9],f[10]],_),I=La([h[12],h[13],h[14]],[f[12],f[13],f[14]],_);return[v[0],v[1],v[2],0,b[0],b[1],b[2],0,w[0],w[1],w[2],0,I[0],I[1],I[2],1]})(a,u,o)}return a}function R_(r,e,i,o){const a=ri.projectAabbCorners(o,i);let u=Number.MAX_VALUE;for(let f=0;f<a.length;++f){const _=a[f];_[0]=(.5*_[0]+.5)*e.width,_[1]=(.5-.5*_[1])*e.height,_[2]<u&&(u=_[2])}const h=(function(f){const _=[];let g=0;for(let I=1;I<f.length;I++)(f[I][0]<f[g][0]||f[I][0]===f[g][0]&&f[I][1]<f[g][1])&&(g=I);let v,b=g;const w=new Uint8Array(f.length);do{if(w[b])break;_.push(new Be(f[b][0],f[b][1])),w[b]=1,v=(b+1)%f.length;for(let I=0;I<f.length;I++){if(f[I][0]===f[v][0]&&f[I][1]===f[v][1]||f[I][0]===f[b][0]&&f[I][1]===f[b][1])continue;const A=[f[I][0]-f[b][0],f[I][1]-f[b][1]],P=[f[v][0]-f[b][0],f[v][1]-f[b][1]],D=A[0]*P[1]-A[1]*P[0];(D>0||D===0&&A[0]*P[0]+A[1]*P[1]>=0&&A[0]*A[0]+A[1]*A[1]>P[0]*P[0]+P[1]*P[1])&&(v=I)}b=v}while(b!==g);return _.length>0&&_.push(_[0]),_})(a);if(jr(r,h))return u}const Sc=64,Uu={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Op(r,e,i,o,a,u,h,f,_,g=!1){const v=i.zoom,b=i.project(o),w=Q(o.lat,v),I=1/w;Dt(r),wi(r,r,[b.x+h[0]*I,b.y+h[1]*I,h[2]]);let A=1,P=1;const D=i.worldSize;if(g){if(i.projection.name==="mercator"){let H=0;i.elevation&&(H=i.elevation.getAtPointOrZero(new _e(b.x/D,b.y/D),0));const te=pn([],[b.x,b.y,H,1],i.projMatrix)[3]/i.cameraToCenterDistance;A=te,P=te*Q(i.center.lat,v)}else if(i.projection.name==="globe"){const H=Lp(r,i),te=[0,0,0,1];pn(te,te,Yt([],i.projMatrix,H));const K=te[3]/i.cameraToCenterDistance,oe=wl(v),le=i.projection.pixelsPerMeter(o.lat,D)*Q(o.lat,v),ue=i.projection.pixelsPerMeter(i.center.lat,D)*Q(i.center.lat,v);A=K/Ft(le,ie(i.center.lat),oe),P=K*w/le,A*=ue,P*=ue}}else A=I;Ci(r,r,[A,A,P]);const L=[...r],V=e.orientation,j=[];if(xx(j,[V[0]+(a?a[0]:0),V[1]+(a?a[1]:0),V[2]+(a?a[2]:0)],u),Yt(r,L,j),f&&i.elevation){let H=0;const te=[];if(_&&i.elevation){H=(function(oe,le,ue,Me,ye){const Ce=le.elevation;if(!Ce)return 0;const Oe=ri.projectAabbCorners(ue,Me),Ne=U(1,ye.lat)*le.worldSize,Ye=(function(ut,ot){const jt=[0,0,1],at=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Et of at){const Ht=ut[Et.corners[0]],oi=ut[Et.corners[1]],yi=ut[Et.corners[2]],$t=[oi[0]-Ht[0],oi[1]-Ht[1],ot*(oi[2]-Ht[2])],Pi=Cr($t,$t,[yi[0]-Ht[0],yi[1]-Ht[1],ot*(yi[2]-Ht[2])]);Oi(Pi,Pi),Et.dotProductWithUp=Gi(Pi,jt)}return at.sort(((Et,Ht)=>Et.dotProductWithUp-Ht.dotProductWithUp)),at[0].corners})(Oe,Ne),He=Oe[Ye[0]],Fe=Oe[Ye[1]],Ge=Oe[Ye[2]],Ie=Oe[Ye[3]],Se=Ce.getAtPointOrZero(new _e(He[0]/le.worldSize,He[1]/le.worldSize),0),Ue=Ce.getAtPointOrZero(new _e(Fe[0]/le.worldSize,Fe[1]/le.worldSize),0),Ze=Ce.getAtPointOrZero(new _e(Ge[0]/le.worldSize,Ge[1]/le.worldSize),0),ke=Ce.getAtPointOrZero(new _e(Ie[0]/le.worldSize,Ie[1]/le.worldSize),0),ft=(Se+ke)/2,_t=(Ue+Ze)/2;return ft>_t?Ue<Ze?zp(oe,Fe,Ie,He,Ue,ke,Se,Ne):zp(oe,Ge,He,Ie,Ze,Se,ke,Ne):Se<ke?zp(oe,He,Fe,Ge,Se,Ue,Ze,Ne):zp(oe,Ie,Ge,Fe,ke,Ze,Ue,Ne),Math.max(ft,_t)})(te,i,e.aabb,r,o);const K=Yt([],br([],te),j);Yt(r,L,K)}else H=i.elevation.getAtPointOrZero(new _e(b.x/D,b.y/D),0);H!==0&&(r[14]+=H)}}class vx{constructor(e,i,o,a,u){this.materialOverrides=new Map,this.nodeOverrides=new Map,this.materialOverrideNames=[],this.nodeOverrideNames=[],this.featureProperties={},this.id=e,this.uri=i,this.position=o!=null?new M(o[0],o[1]):new M(0,0),this.orientation=a!=null?a:[0,0,0],this.nodes=u,this.uploaded=!1,this.aabb=new ri([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(e,i){Yt(e.globalMatrix,i,e.localMatrix);const o=this.nodeOverrides.get(e.name);if(o!==void 0){const h=[];u=o.orientation,Dt(a=h),vi(a,a,ii(u[1])),Ti(a,a,ii(u[2])),tr(a,a,ii(u[0])),Yt(e.globalMatrix,e.globalMatrix,h)}var a,u;if(e.meshes)for(const h of e.meshes){const f=ri.applyTransformFast(h.aabb,e.globalMatrix);this.aabb.encapsulate(f)}if(e.children)for(const h of e.children)this._applyTransformations(h,e.globalMatrix)}computeBoundsAndApplyParent(){const e=Dt([]);this.aabb=new ri([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const i of this.nodes)this._applyTransformations(i,e)}computeModelMatrix(e,i,o,a,u,h,f=!1){Op(this.matrix,this,e.transform,this.position,i,o,a,u,h,f)}upload(e){if(!this.uploaded){for(const i of this.nodes)D_(i,e);for(const i of this.nodes)Fp(i);this.uploaded=!0}}destroy(){for(const e of this.nodes)z_(e)}}function Nd(r,e,i=!1){r.uploaded||(r.gfxTexture=new C_(e,r.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:r.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),r.uploaded=!0,r.image=null)}function z1(r,e,i){r.indexBuffer=e.createIndexBuffer(r.indexArray,!1,!0),r.vertexBuffer=e.createVertexBuffer(r.vertexArray,I1.members,!1,!0),r.normalArray&&(r.normalBuffer=e.createVertexBuffer(r.normalArray,P1.members,!1,!0)),r.texcoordArray&&(r.texcoordBuffer=e.createVertexBuffer(r.texcoordArray,C1.members,!1,!0)),r.colorArray&&(r.colorBuffer=e.createVertexBuffer(r.colorArray,(r.colorArray.bytesPerElement===12?A1:M1).members,!1,!0)),r.featureArray&&(r.pbrBuffer=e.createVertexBuffer(r.featureArray,D1.members,!0)),r.segments=Ar.simpleSegment(0,0,r.vertexArray.length,r.indexArray.length);const o=r.material;o.pbrMetallicRoughness.baseColorTexture&&Nd(o.pbrMetallicRoughness.baseColorTexture,e),o.pbrMetallicRoughness.metallicRoughnessTexture&&Nd(o.pbrMetallicRoughness.metallicRoughnessTexture,e),o.normalTexture&&Nd(o.normalTexture,e),o.occlusionTexture&&Nd(o.occlusionTexture,e,i),o.emissionTexture&&Nd(o.emissionTexture,e)}function D_(r,e,i){if(r.meshes)for(const o of r.meshes)z1(o,e,i);if(r.children)for(const o of r.children)D_(o,e,i)}function Fp(r){if(r.meshes)for(const e of r.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(r.children)for(const e of r.children)Fp(e)}function z_(r){if(r.meshes)for(const i of r.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(r.children)for(const i of r.children)z_(i)}function Ec(r,e){const i=r.json.bufferViews[e.bufferView],o=Pp[e.componentType];return new o(r.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==kd[e.type]*o.BYTES_PER_ELEMENT?i.byteStride/o.BYTES_PER_ELEMENT:kd[e.type]))}function L_(r,e,i,o){const a=Pp[e.componentType],u=(function(v){switch(v){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}})(a),h=r.json.bufferViews[e.bufferView],f=h.byteStride?h.byteStride/a.BYTES_PER_ELEMENT:kd[e.type],_=i.float32,g=_.length/i.capacity;for(let v=0,b=0;v<e.count*f;v+=f,b+=g)for(let w=0;w<g;w++)_[b+w]=o[v+w]*u;i._trim()}function L1(r,e,i){const o=r.indices,a=r.attributes,u={};u.indexArray=new vr;const h=e.json.accessors[o],f=h.count/3;u.indexArray.reserve(f);const _=Ec(e,h);for(let w=0;w<f;w++)u.indexArray.emplaceBack(_[3*w],_[3*w+1],_[3*w+2]);u.indexArray._trim(),u.vertexArray=new Fo;const g=e.json.accessors[a.POSITION];u.vertexArray.reserve(g.count);const v=Ec(e,g);for(let w=0;w<g.count;w++)u.vertexArray.emplaceBack(v[3*w],v[3*w+1],v[3*w+2]);if(u.vertexArray._trim(),u.aabb=new ri(g.min,g.max),u.centroid=(function(w,I){const A=[0,0,0],P=w.length;if(P>0){for(let D=0;D<P;D++){const L=3*w[D];A[0]+=I[L],A[1]+=I[L+1],A[2]+=I[L+2]}A[0]/=P,A[1]/=P,A[2]/=P}return A})(_,v),a.COLOR_0!==void 0){const w=e.json.accessors[a.COLOR_0],I=kd[w.type],A=Ec(e,w);u.colorArray=I===3?new Fo:new aa,u.colorArray.resize(w.count),L_(e,w,u.colorArray,A)}if(a.NORMAL!==void 0){u.normalArray=new Fo;const w=e.json.accessors[a.NORMAL];u.normalArray.resize(w.count);const I=Ec(e,w);L_(e,w,u.normalArray,I)}if(a.TEXCOORD_0!==void 0&&i.length>0){u.texcoordArray=new la;const w=e.json.accessors[a.TEXCOORD_0];u.texcoordArray.resize(w.count);const I=Ec(e,w);L_(e,w,u.texcoordArray,I)}if(a._FEATURE_ID_RGBA4444!==void 0){const w=e.json.accessors[a._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(u.featureData=Ec(e,w))}a._FEATURE_RGBA4444!==void 0&&(u.featureData=new Uint32Array(Ec(e,e.json.accessors[a._FEATURE_RGBA4444]).buffer));const b=r.material;return u.material=(function(w,I){const{emissiveFactor:A=[0,0,0],alphaMode:P="OPAQUE",alphaCutoff:D=.5,normalTexture:L,occlusionTexture:V,emissiveTexture:j,doubleSided:H,name:te}=w,{baseColorFactor:K=[1,1,1,1],metallicFactor:oe=1,roughnessFactor:le=1,baseColorTexture:ue,metallicRoughnessTexture:Me}=w.pbrMetallicRoughness||{},ye=V?I[V.index]:void 0;if(V&&V.extensions&&V.extensions.KHR_texture_transform&&ye){const Ce=V.extensions.KHR_texture_transform;ye.offsetScale=[Ce.offset[0],Ce.offset[1],Ce.scale[0],Ce.scale[1]]}return{name:te,pbrMetallicRoughness:{baseColorFactor:new Ui(...K),metallicFactor:oe,roughnessFactor:le,baseColorTexture:ue?I[ue.index]:void 0,metallicRoughnessTexture:Me?I[Me.index]:void 0},doubleSided:H,emissiveFactor:new Ui(...A),alphaMode:P,alphaCutoff:D,normalTexture:L?I[L.index]:void 0,occlusionTexture:ye,emissionTexture:j?I[j.index]:void 0,defined:w.defined===void 0}})(b!==void 0?e.json.materials[b]:{defined:!1},i),u}function bx(r,e,i){const{matrix:o,rotation:a,translation:u,scale:h,mesh:f,extras:_,children:g,name:v}=r,b={};if(b.name=v,b.localMatrix=o||(function(w,I,A,P){var D=I[0],L=I[1],V=I[2],j=I[3],H=D+D,te=L+L,K=V+V,oe=D*H,le=D*te,ue=D*K,Me=L*te,ye=L*K,Ce=V*K,Oe=j*H,Ne=j*te,Ye=j*K,He=P[0],Fe=P[1],Ge=P[2];return w[0]=(1-(Me+Ce))*He,w[1]=(le+Ye)*He,w[2]=(ue-Ne)*He,w[3]=0,w[4]=(le-Ye)*Fe,w[5]=(1-(oe+Ce))*Fe,w[6]=(ye+Oe)*Fe,w[7]=0,w[8]=(ue+Ne)*Ge,w[9]=(ye-Oe)*Ge,w[10]=(1-(oe+Me))*Ge,w[11]=0,w[12]=A[0],w[13]=A[1],w[14]=A[2],w[15]=1,w})([],a||[0,0,0,1],u||[0,0,0],h||[1,1,1]),b.globalMatrix=Tt(b.localMatrix),f!==void 0){b.meshes=i[f];const w=b.anchor=[0,0];for(const I of b.meshes){const{min:A,max:P}=I.aabb;w[0]+=A[0]+P[0],w[1]+=A[1]+P[1]}w[0]=Math.floor(w[0]/b.meshes.length/2),w[1]=Math.floor(w[1]/b.meshes.length/2)}if(_&&(_.id&&(b.id=_.id),_.lights&&(b.lights=(function(w){if(!w.length)return[];const I=(function(V){const j=atob(V),H=new Uint8Array(j.length);for(let te=0;te<j.length;te++)H[te]=j.codePointAt(te);return H})(w),A=[],P=I.length/24,D=new Uint16Array(I.buffer),L=new Float32Array(I.buffer);for(let V=0;V<P;V++){const j=D[2*V*6]/30,H=D[2*V*6+1]/30,te=D[2*V*6+10]/100,K=L[6*V+1],oe=L[6*V+2],le=L[6*V+3],ue=L[6*V+4],Me=le-K,ye=ue-oe,Ce=Math.hypot(Me,ye);A.push({pos:[K+.5*Me,oe+.5*ye,H],normal:[ye/Ce,-Me/Ce,0],width:Ce,height:j,depth:te,points:[K,oe,le,ue]})}return A})(_.lights)),_.MAPBOX_geometry_bloom&&(b.isGeometryBloom=_.MAPBOX_geometry_bloom)),g){const w=[];for(const I of g)w.push(bx(e.json.nodes[I],e,i));b.children=w}return b}function O1(r){if(r.vertices.length===0||r.indices.length===0)return null;const e=new wp(r.vertices,r.indices,8,256),[i,o]=[e.min.clone(),e.max.clone()];return{vertices:r.vertices,indices:r.indices,grid:e,min:i,max:o}}function F1(r){if(!r.extras||!r.extras.ground)return null;const e=r.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;const o=[];for(const h of i){if(!Array.isArray(h)||h.length!==2)continue;const f=h[0],_=h[1];typeof f=="number"&&typeof _=="number"&&o.push(new Be(f,_))}if(o.length<3)return null;o.length>1&&o[o.length-1].equals(o[0])&&o.pop();let a=0;for(let h=0;h<o.length;h++){const f=o[h],_=o[(h+1)%o.length],g=o[(h+2)%o.length];a+=(f.x-_.x)*(g.y-_.y)-(g.x-_.x)*(f.y-_.y)}a>0&&o.reverse();const u=Ou(o.flatMap((h=>[h.x,h.y])),[]);return u.length===0?null:{vertices:o,indices:u}}function k1(r,e){const i=[],o=[];let a=0;const u=[];for(const h of r){a=i.length;const f=h.vertexArray.float32,_=h.indexArray.uint16;for(let g=0;g<h.vertexArray.length;g++)u[0]=f[3*g+0],u[1]=f[3*g+1],u[2]=f[3*g+2],nr(u,u,e),i.push(new Be(u[0],u[1]));for(let g=0;g<3*h.indexArray.length;g++)o.push(_[g]+a)}if(o.length%3!=0)return null;for(let h=0;h<o.length;h+=3){const f=i[o[h+0]],_=i[o[h+1]],g=i[o[h+2]];(f.x-_.x)*(g.y-_.y)-(g.x-_.x)*(f.y-_.y)>0&&([o[h+1],o[h+2]]=[o[h+2],o[h+1]])}return{vertices:i,indices:o}}function O_(r){const e=(function(_,g){const v=[],b=WebGL2RenderingContext;if(_.json.textures)for(const w of _.json.textures){const I={magFilter:b.LINEAR,minFilter:b.NEAREST,wrapS:b.REPEAT,wrapT:b.REPEAT};w.sampler!==void 0&&Object.assign(I,_.json.samplers[w.sampler]),v.push({image:g[w.source],sampler:I,uploaded:!1})}return v})(r,r.images),i=(function(_,g){const v=[];for(const b of _.json.meshes){const w=[];for(const I of b.primitives)w.push(L1(I,_,g));v.push(w)}return v})(r,e),{scenes:o,scene:a,nodes:u}=r.json,h=o?o[a||0].nodes:[...u.keys()],f=[];for(const _ of h)f.push(bx(u[_],r,i));return(function(_,g,v){const b={},w=new Set;for(let I=0;I<_.length;I++){const A=v[g[I]];if(!A.extras)continue;const P=A.extras["mapbox:footprint:version"],D=A.extras["mapbox:footprint:id"];(P||D)&&w.add(I),P==="1.0.0"&&D&&(b[D]=I)}for(let I=0;I<_.length;I++){if(w.has(I))continue;const A=_[I],P=v[g[I]];if(!P.extras)continue;let D=null;A.id in b&&(D=k1(_[b[A.id]].meshes,A.localMatrix)),D||(D=F1(P)),D&&(A.footprint=O1(D))}if(w.size>0){const I=Array.from(w.values()).sort(((A,P)=>A-P));for(let A=I.length-1;A>=0;A--)_.splice(I[A],1)}})(f,h,r.json.nodes),f}function B1(r){r.heightmap=new Float32Array(4096),r.heightmap.fill(-1);const e=r.vertexArray.float32,i=r.aabb.min[0]-1,o=r.aabb.min[1]-1,a=Sc/(r.aabb.max[0]-i+2),u=Sc/(r.aabb.max[1]-o+2);for(let h=0;h<e.length;h+=3){const f=e[h+2],_=(e[h+0]-i)*a|0,g=(e[h+1]-o)*u|0;f>r.heightmap[g*Sc+_]&&(r.heightmap[g*Sc+_]=f)}}function wx(r,e,i,o,a){i.reserve(i.length+4*r.length),o.reserve(o.length+10*r.length),a.reserve(a.length+10*r.length);let u=o.length;for(const h of r){const f=Math.min(10,Math.max(4,1.3*h.height))*e,_=[-h.normal[1],h.normal[0],0],g=Math.min(.29,.1*h.width/h.depth),v=h.width-2*h.depth*e*(g+.01),b=Fn([],h.pos,_,v/2),w=Fn([],h.pos,_,-v/2),I=[b[0],b[1],b[2]+h.height],A=[w[0],w[1],w[2]+h.height],P=Fn([],h.normal,_,g);Wi(P,P,f);const D=Fn([],h.normal,_,-g);Wi(D,D,f),Er(P,b,P),Er(D,w,D),b[2]+=.1,w[2]+=.1,o.emplaceBack(P[0],P[1],P[2]),o.emplaceBack(D[0],D[1],D[2]),o.emplaceBack(b[0],b[1],b[2]),o.emplaceBack(w[0],w[1],w[2]),o.emplaceBack(I[0],I[1],I[2]),o.emplaceBack(A[0],A[1],A[2]),o.emplaceBack(b[0],b[1],b[2]),o.emplaceBack(w[0],w[1],w[2]),o.emplaceBack(P[0],P[1],P[2]),o.emplaceBack(D[0],D[1],D[2]);const L=v/f/2;a.emplaceBack(-L-g,-1,L,.8),a.emplaceBack(L+g,-1,L,.8),a.emplaceBack(-L,0,L,1.3),a.emplaceBack(L,0,L,1.3),a.emplaceBack(L+g,-.8,L,.7),a.emplaceBack(L+g,-.8,L,.7),a.emplaceBack(0,0,L,1.3),a.emplaceBack(0,0,L,1.3),a.emplaceBack(L+g,-1.2,L,.8),a.emplaceBack(L+g,-1.2,L,.8),i.emplaceBack(6+u,4+u,8+u),i.emplaceBack(7+u,9+u,5+u),i.emplaceBack(0+u,1+u,2+u),i.emplaceBack(1+u,3+u,2+u),u+=10}}function N1(r,e){const i={};i.indexArray=new vr,i.vertexArray=new Fo,i.colorArray=new aa,wx(r,e,i.indexArray,i.vertexArray,i.colorArray);const o={defined:!0};o.emissiveFactor=Ui.black;const a={};return a.baseColorFactor=Ui.white,o.pbrMetallicRoughness=a,i.material=o,i.aabb=new ri([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}const Tx=ai([{name:"a_pos_3f",components:3,type:"Float32"}]),V1=ai([{name:"a_normal_3",components:3,type:"Int16"}]),U1=ai([{name:"a_centroid_3",components:3,type:"Int16"}]),Sx=ai([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),j1=ai([{name:"a_faux_facade_color_emissive",components:2,type:"Uint16"}]),G1=ai([{name:"a_faux_facade_data",components:4,type:"Uint16"}]),H1=ai([{name:"a_faux_facade_vertical_range",components:2,type:"Uint16"}]),q1=ai([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),$1=ai([{name:"a_flood_light_wall_radius_1i16",components:1,type:"Uint16"}]),Ex=Ve.types,kp=32767;function Z1(r,e){const i=Je+e;for(const o of r)for(const a of o)if(a.x<-e||a.x>i||a.y<-e||a.y>i)return!1;return!0}class Ix{constructor(){this.layoutVertexArray=new Fo,this.layoutAttenuationArray=new aa,this.layoutColorArray=new ss,this.indexArray=new vr,this.indexArrayForConflation=new vr,this.segmentsBucket=new Ar}}class F_{constructor(){this.layoutVertexArray=new Fo,this.layoutNormalArray=new Pa,this.layoutCentroidArray=new Pa,this.layoutColorArray=new ss,this.layoutFacadePaintArray=null,this.layoutFacadeDataArray=null,this.layoutFacadeVerticalRangeArray=null,this.layoutFloodLightDataArray=new Eu,this.layoutAOArray=new Vs,this.indexArray=new vr,this.indexArrayForConflation=new vr,this.segmentsBucket=new Ar,this.entranceBloom=new Ix}}class Ax{constructor(e){this.colorBufferUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.buildingWithoutFacade=new F_,this.buildingWithFacade=new F_,this.indexArrayForConflationUploaded=!1,this.featureFootprintLookup=new Map,this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.lut=e.lut,this.buildingWithFacade.layoutFacadePaintArray=new ss,this.buildingWithFacade.layoutFacadeDataArray=new Ra,this.buildingWithFacade.layoutFacadeVerticalRangeArray=new ss,this.programConfigurations=new _s(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.projection=e.projection,this.groundEffect=new v_(e),this.groundEffect.groundRadiusArray=new Vs,this.hasAppearances=null}updateFootprints(e,i){for(const o of this.footprints)i.push({footprint:o,id:e})}updateAppearances(e,i,o,a){}prepare(){return(function(){if(Cp!=null||sx!=null)return null;if(Vu!=null)return Vu;const e=fetch(fr.BUILDING_GEN_URL);return Vu=(function(i){let o,a,u,h;function f(){o=new Uint8Array(h.buffer),a=new Int32Array(h.buffer),u=new Float32Array(h.buffer)}function _(){throw new Error("Unexpected BuildingGen error.")}const g=()=>{},v={a:{a:_,f:function(b){const w=o.length,I=Math.max(b>>>0,Math.ceil(1.2*w)),A=Math.ceil((I-w)/65536);try{return h.grow(A),f(),!0}catch(P){return!1}},g:_,b:g,c:g,d:g,e:g}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(i,v):i.then((b=>b.arrayBuffer())).then((b=>WebAssembly.instantiate(b,v)))).then((b=>{const w=b.instance.exports;return(0,w.g)(),h=w.f,f(),new x1({setStyle:w.h,setAOOptions:w.i,setMetricOptions:w.j,setStructuralOptions:w.k,setFacadeOptions:w.l,setFauxFacadeOptions:w.m,setFacadeClassifierOptions:w.n,addFeature:w.o,addFacade:w.p,generateMesh:w.q,getLastError:w.r,getOuterRingLength:w.s,getMeshCount:w.t,getPositionsPtr:w.u,getPositionsLength:w.v,getNormalsPtr:w.w,getNormalsLength:w.x,getColorsPtr:w.y,getColorsLength:w.z,getAOPtr:w.A,getAOLength:w.B,getUVPtr:w.C,getUVLength:w.D,getFauxFacadePtr:w.E,getFauxFacadeLength:w.F,getIndicesPtr:w.G,getIndicesLength:w.H,getBuildingPart:w.I,getRingCount:w.J,getRingPtr:w.K,getRingLength:w.L,free:w.M,malloc:w.N,heapU8:o,heap32:a,heapF32:u})}))})(e).then((i=>(Vu=null,Cp=i,Cp))).catch((i=>{Mt("Could not load building-gen"),Vu=null,sx=i})),Vu})()}populate(e,i,o,a){const u=v1();if(!u)return;const h=re(o);this.tileToMeter=h,this.brightness=i.brightness,u.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,h],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:h,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),u.setAOOptions(!1,.3),u.setMetricOptions(!1,16),u.setStructuralOptions(!0),u.setFacadeClassifierOptions(3);const f=new Map,_=new Map;for(const{feature:g}of e){if(Ex[g.type]!=="LineString"){f.set(g.id,g.properties.source_id);continue}const v=this.layers[0]._featureFilter.needGeometry,b=be(g,v);if(!this.layers[0]._featureFilter.filter(new lr(this.zoom),b,o))continue;const w=v?b.geometry:Le(g,o,a),I=[];for(const L of w)for(const V of L)I.push({x:V.x,y:V.y});const A={coordinates:I,crossPerc:g.properties.cross_perc,distanceToRoad:g.properties.distance_to_road,entrances:g.properties.entrances,sourceId:0},P=g.properties.source_id;let D=_.get(P);D||(D=[],_.set(P,D)),D.push(A)}this.maxHeight=0;for(const{feature:g,id:v,index:b,sourceLayerIndex:w}of e){if(Ex[g.type]==="LineString")continue;const I=this.layers[0]._featureFilter.needGeometry,A=be(g,I);if(!this.layers[0]._featureFilter.filter(new lr(this.zoom),A,o))continue;const P=I?A.geometry:Le(g,o,a),D=Md(P,500);if(!Z1(P,163))continue;const L=this.layers[0],V=L.layout.get("building-roof-shape").evaluate(g,{},o);if(V==="flat")continue;const j=L.layout.get("building-base").evaluate(g,{},o),H=L.layout.get("building-height").evaluate(g,{},o),te=L.layout.get("building-flood-light-ground-radius").evaluate(g,{},o),K=L.paint.get("building-ambient-occlusion-intensity"),oe=te/this.tileToMeter;let le=L.layout.get("building-flood-light-wall-radius").evaluate(g,{},o);le=B(le,0,2048);const ue=le/2048*kp,Me=f.get(v);let ye;ye=_.has(Me)?_.get(Me):[];const Ce=ye.length!==0&&L.layout.get("building-facade").evaluate(g,{},o);u.setFacadeOptions(4,!0),u.setFauxFacadeOptions(Ce,!1,1);let Oe=0,Ne=0,Ye=0,He=0,Fe=0,Ge=0;if(Ce){let De=Math.round(L.layout.get("building-facade-floors").evaluate(g,{},o));if(j===0){De=Math.max(1,De-(ye.length>0?1:0));let wt=4;if(H>100){const vt=[10,13,15];wt=vt[g.id?g.id%vt.length:0],u.setFacadeOptions(wt,!0)}Fe=1.6803*wt/h}else Fe=j/h;Ge=H/h,Fe=Math.min(Fe,Ge),Ye=L.layout.get("building-facade-unit-width").evaluate(g,{},o)/h,He=(Ge-Fe)/De,u.setFauxFacadeOptions(!0,!0,Ye);const st=L.layout.get("building-facade-window").evaluate(g,{},o);Oe=st[0],Ne=st[1]}const Ie=[],Se=new Be(1/0,1/0),Ue=new Be(-1/0,-1/0),Ze=new Be(0,0);let ke=0;for(const De of D)if(De.length>0){const st=[];for(const wt of De){const vt=[];for(let Zt=wt.length-1;Zt>=0;Zt--){const zt=wt[Zt];vt.push({x:zt.x,y:zt.y}),Se.x=Math.min(Se.x,zt.x),Se.y=Math.min(Se.y,zt.y),Ue.x=Math.max(Ue.x,zt.x),Ue.y=Math.max(Ue.y,zt.y),Ze.x+=zt.x,Ze.y+=zt.y,ke++}st.push(vt)}Ie.push({id:g.id?g.id:0,height:H,minHeight:j,sourceId:0,roofType:V,coordinates:st})}Ze.x/=ke||1,Ze.y/=ke||1;const ft=u.generateMesh(Ie,ye);if(typeof ft=="string"){Mt("Unable to generate building ".concat(g.id,": ").concat(ft));continue}if(ft.meshes.length===0||ft.modifiedPolygonRings.length===0)continue;let _t=0;for(const De of ft.meshes)_t+=De.positions.length/3;const ut=Ce?this.buildingWithFacade:this.buildingWithoutFacade,ot=ut.segmentsBucket.prepareSegment(_t,ut.layoutVertexArray,ut.indexArray),jt=[];let at=null,Et=0,Ht=-1;const oi=ut.layoutVertexArray.length,yi=ut.indexArray.length;let $t=0;for(const De of ft.meshes){const st=ut.layoutVertexArray.length;if(De.buildingPart==="entrance"){const yt=new Array;for(let _i=0;_i<De.positions.length;_i+=12){const Qi=De.positions[_i+0],ji=De.positions[_i+1],Lr=De.positions[_i+3],mr=De.positions[_i+4],or=De.positions[_i+2],Zi=De.positions[_i+8]-or,Di=1,Wt=Lr-Qi,zi=mr-ji,sr=Math.hypot(Wt,zi);yt.push({pos:[Qi+.5*Wt,ji+.5*zi,or],normal:[zi/sr,-Wt/sr,0],width:sr,height:Zi,depth:Di,points:[Qi,ji,Lr,mr]})}const Ai=ut.entranceBloom.segmentsBucket.prepareSegment(10*yt.length,ut.entranceBloom.layoutVertexArray,ut.entranceBloom.indexArray),Ji=ut.entranceBloom.layoutVertexArray.length;Et=ut.entranceBloom.indexArray.length,wx(yt,.5/this.tileToMeter,ut.entranceBloom.indexArray,ut.entranceBloom.layoutVertexArray,ut.entranceBloom.layoutAttenuationArray);const Ot=ut.entranceBloom.layoutVertexArray.length-Ji;Ht=ut.entranceBloom.indexArray.length-Et;for(let _i=0;_i<Ot;_i++)ut.entranceBloom.layoutColorArray.emplaceBack(65535,65535);Ai.vertexLength+=Ot,Ai.primitiveLength+=Ht,at={part:De.buildingPart,vertexOffset:Ji,vertexLength:Ot}}for(let yt=0;yt<De.positions.length;yt+=3)$t=Math.max($t,De.positions[yt+2]),ut.layoutVertexArray.emplaceBack(De.positions[yt],De.positions[yt+1],De.positions[yt+2]);const wt=Math.floor(Ze.x),vt=Math.floor(Ze.y),Zt=Math.floor($t);for(let yt=0;yt<De.positions.length;yt+=3)ut.layoutCentroidArray.emplaceBack(wt,vt,Zt),ut.layoutFloodLightDataArray.emplaceBack(De.buildingPart==="wall"?ue:0);for(let yt=0;yt<De.normals.length;yt+=3)ut.layoutNormalArray.emplaceBack(De.normals[yt+0]*kp,De.normals[yt+1]*kp,De.normals[yt+2]*kp);for(let yt=0;yt<De.ao.length;yt++)ut.layoutAOArray.emplaceBack(De.ao[yt]);for(let yt=0;yt<De.colors.length;yt+=3){const Ai=1+(De.ao[yt/3]-1)*K;ut.layoutColorArray.emplaceBack(De.colors[yt]*Ai<<8|De.colors[yt+1]*Ai,De.colors[yt+2]*Ai<<8)}if(Ce){for(let yt=0;yt<De.positions.length;yt+=3)ut.layoutFacadePaintArray.emplaceBack(65535,255);for(let yt=0;yt<De.isFauxFacade.length;yt++)if(De.isFauxFacade[yt]){const Ai=1|Math.min(65535,Math.floor(De.uv[2*yt]*ft.outerRingLength)),Ji=Math.floor(255*Oe)<<8|Math.floor(255*Ne),Ot=Math.floor(65535*Math.min(1,Ye/Je)),_i=Math.floor(65535*Math.min(1,He/Je));ut.layoutFacadeDataArray.emplaceBack(Ai,Ji,Ot,_i);const Qi=Math.floor(65535*Math.min(1,Fe/Je)),ji=Math.floor(65535*Math.min(1,Ge/Je));ut.layoutFacadeVerticalRangeArray.emplaceBack(Qi,ji)}else ut.layoutFacadeDataArray.emplaceBack(0,0,0,0),ut.layoutFacadeVerticalRangeArray.emplaceBack(0,0)}const zt=ot.vertexLength;for(let yt=0;yt<De.indices.length;yt+=3)ut.indexArray.emplaceBack(zt+De.indices[yt],zt+De.indices[yt+1],zt+De.indices[yt+2]);ot.vertexLength+=De.positions.length/3,ot.primitiveLength+=De.indices.length/3,(De.buildingPart==="roof"||De.buildingPart==="wall"||De.buildingPart==="facade_glazing"||De.buildingPart==="entrance")&&jt.push({part:De.buildingPart,vertexOffset:st,vertexLength:De.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,$t),this.buildingFeatures.push({promoteId:v,feature:A,hasFauxFacade:Ce,segment:ot,parts:jt,buildingBloom:at});const Pi=ut.indexArray.length-yi,Ri=[],Tr=[],J=new Be(1/0,1/0),W=new Be(-1/0,-1/0),Re=this.groundEffect.vertexArray.length;for(const De of ft.modifiedPolygonRings){const st=[],wt=new Be(1/0,1/0),vt=new Be(-1/0,-1/0);for(let Zt=0;Zt<De.length;Zt+=2){const zt=De.length-Zt-2;wt.x=Math.min(wt.x,De[zt]),wt.y=Math.min(wt.y,De[zt+1]),vt.x=Math.max(vt.x,De[zt]),vt.y=Math.max(vt.y,De[zt+1]);const yt=new Be(De[zt],De[zt+1]);st.push(yt),Ri.push(yt.x,yt.y),Tr.push(yt.clone())}J.x=Math.min(J.x,wt.x),J.y=Math.min(J.y,wt.y),W.x=Math.max(W.x,vt.x),W.y=Math.max(W.y,vt.y),this.groundEffect.addData(st,[wt,vt],oe)}const it=this.groundEffect.vertexArray.length-Re;for(let De=0;De<it;De++)this.groundEffect.groundRadiusArray.emplaceBack(te);(Se.x<0||Ue.x>Je||Se.y<0||Ue.y>Je)&&this.featuresOnBorder.push({featureId:g.id,footprintIndex:this.footprints.length});{const De=Ou(Ri,null,2),st=new wp(Tr,De,8,256);let wt=g.id;g.properties&&g.properties.hasOwnProperty("building_id")&&(wt=g.properties.building_id);const vt={vertices:Tr,indices:De,grid:st,min:J,max:W,buildingId:wt,hiddenFlags:0,indicesOffset:yi,indicesLength:Pi,bloomIndicesOffset:Et,bloomIndicesLength:Ht,groundEffectVertexOffset:Re,groundEffectVertexLength:it,hasFauxFacade:Ce,segment:ot,height:$t};g.id!==void 0&&this.featureFootprintLookup.set(g.id,this.footprints.length),this.footprints.push(vt)}this.programConfigurations.populatePaintArrays(ut.layoutVertexArray.length,g,b,{},i.availableImages,o,i.brightness),this.groundEffect.addPaintPropertiesData(g,b,{},i.availableImages,o,i.brightness),i.featureIndex.insert(g,P,b,w,this.index,oi)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0],{})}update(e,i,o,a,u,h,f){this.programConfigurations.updatePaintArrays(e,i,u,o,a,h,f),this.groundEffect.update(e,i,u,o,a,h,f),this.evaluate(this.layers[0],e),this.colorBufferUploaded=!1}isEmpty(){return this.buildingWithoutFacade.layoutVertexArray.length===0&&this.buildingWithFacade.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){const i=o=>{o.layoutVertexBuffer=e.createVertexBuffer(o.layoutVertexArray,Tx.members),o.layoutNormalBuffer=e.createVertexBuffer(o.layoutNormalArray,V1.members),o.layoutCentroidBuffer=e.createVertexBuffer(o.layoutCentroidArray,U1.members),o.layoutFloodLightDataBuffer=e.createVertexBuffer(o.layoutFloodLightDataArray,$1.members),o.layoutFacadeDataArray&&o.layoutFacadeDataArray.length&&(o.layoutFacadeDataBuffer=e.createVertexBuffer(o.layoutFacadeDataArray,G1.members)),o.layoutFacadeVerticalRangeArray&&o.layoutFacadeVerticalRangeArray.length&&(o.layoutFacadeVerticalRangeBuffer=e.createVertexBuffer(o.layoutFacadeVerticalRangeArray,H1.members)),o.entranceBloom.layoutVertexArray.length&&(o.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(o.entranceBloom.layoutVertexArray,Tx.members),o.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(o.entranceBloom.layoutAttenuationArray,q1.members)),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e)};this.uploaded||(i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){const e=i=>{i.layoutVertexBuffer&&(i.layoutVertexBuffer.destroy(),i.layoutNormalBuffer.destroy(),i.layoutColorBuffer.destroy(),i.segmentsBucket.destroy(),i.indexBuffer&&i.indexBuffer.destroy(),i.entranceBloom.layoutVertexBuffer&&(i.entranceBloom.layoutVertexBuffer.destroy(),i.entranceBloom.layoutColorBuffer.destroy(),i.entranceBloom.layoutAttenuationBuffer.destroy(),i.entranceBloom.indexBuffer.destroy(),i.entranceBloom.segmentsBucket.destroy()))};e(this.buildingWithoutFacade),e(this.buildingWithFacade),this.groundEffect.destroy(),this.programConfigurations.destroy()}updateFootprintHiddenFlags(e,i,o=!0){let a=!1;const u=o?i:0,h=0|(o?-1:~i);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const f of e){const _=this.footprints[f],g=_.hiddenFlags&h|u;_.hiddenFlags!==g&&(_.hiddenFlags=g,a=!0,this.groundEffect.updateHiddenByLandmarkRange(_.groundEffectVertexOffset,_.groundEffectVertexLength,_.hiddenFlags!==0))}return a&&(this.indexArrayForConflationUploaded=!1),a}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),this.indexArrayForConflationUploaded)return;const i=a=>{a.indexArray.length!==0&&(a.indexArrayForConflation.resize(a.indexArray.length),a.indexArrayForConflation.uint16.set(a.indexArray.uint16),a.entranceBloom.indexArrayForConflation.resize(a.entranceBloom.indexArray.length),a.entranceBloom.indexArrayForConflation.uint16.set(a.entranceBloom.indexArray.uint16))};i(this.buildingWithoutFacade),i(this.buildingWithFacade);for(const a of this.footprints){const u=a.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade,h=a.indicesOffset+a.indicesLength;if(a.hiddenFlags!==0){for(let _=a.indicesOffset;_<h;_++)u.indexArrayForConflation.uint16[3*_+0]=0,u.indexArrayForConflation.uint16[3*_+1]=0,u.indexArrayForConflation.uint16[3*_+2]=0;const f=a.bloomIndicesOffset+a.bloomIndicesLength;for(let _=a.bloomIndicesOffset;_<f;_++)u.entranceBloom.indexArrayForConflation.uint16[3*_+0]=0,u.entranceBloom.indexArrayForConflation.uint16[3*_+1]=0,u.entranceBloom.indexArrayForConflation.uint16[3*_+2]=0}}const o=a=>{a.indexArray.length!==0&&(a.indexBuffer?a.indexBuffer.updateData(a.indexArrayForConflation):a.indexBuffer=e.createIndexBuffer(a.indexArrayForConflation,!0),a.entranceBloom.indexBuffer?a.entranceBloom.indexBuffer.updateData(a.entranceBloom.indexArrayForConflation):a.entranceBloom.indexBuffer=e.createIndexBuffer(a.entranceBloom.indexArrayForConflation,!0))};o(this.buildingWithoutFacade),o(this.buildingWithFacade),this.indexArrayForConflationUploaded=!0}uploadUpdatedColorBuffer(e){const i=o=>{o.layoutColorBuffer?o.layoutColorBuffer.updateData(o.layoutColorArray):o.layoutColorBuffer=e.createVertexBuffer(o.layoutColorArray,Sx.members,!0),o.layoutFacadePaintArray&&(o.layoutFacadePaintBuffer?o.layoutFacadePaintBuffer.updateData(o.layoutFacadePaintArray):o.layoutFacadePaintBuffer=e.createVertexBuffer(o.layoutFacadePaintArray,j1.members,!0)),o.entranceBloom.layoutColorBuffer?o.entranceBloom.layoutColorBuffer.updateData(o.entranceBloom.layoutColorArray):o.entranceBloom.layoutColorBuffer=e.createVertexBuffer(o.entranceBloom.layoutColorArray,Sx.members,!0)};i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.colorBufferUploaded=!0}evaluate(e,i){const o=e.paint.get("building-ambient-occlusion-intensity");for(const a of this.buildingFeatures){const u=i[a.promoteId],h=a.feature;h.properties["building-part"]="roof";const f=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),_=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical);h.properties["building-part"]="wall";const g=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),v=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical);h.properties["building-part"]="window";const b=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),w=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical);h.properties["building-part"]="door";const I=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),A=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical),P=a.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade;for(const L of a.parts){let V,j=f;L.part==="roof"?(j=f,V=_):L.part==="wall"?(j=g,V=v):L.part==="facade_glazing"?(j=b,V=w):L.part==="entrance"&&(j=I,V=A),V=B(V,0,1);for(let H=0;H<L.vertexLength;H++){const te=L.vertexOffset+H,K=1+(P.layoutAOArray.float32[te]-1)*o;P.layoutColorArray.emplace(te,j.r*K*255<<8|j.g*K*255,j.b*K*255<<8|255*V),a.hasFauxFacade&&P.layoutFacadePaintArray.emplace(te,255*b.r<<8|255*b.g,255*b.b<<8|255*w)}}const D=a.buildingBloom;if(D)for(let L=0;L<D.vertexLength;L++)P.entranceBloom.layoutColorArray.emplace(D.vertexOffset+L,255*I.r<<8|255*I.g,255*I.b<<8|51*A)}}needsEvaluation(){return!this.colorBufferUploaded}updateReplacement(e,i,o){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped());if(Sp(this.activeReplacements,a))return;this.activeReplacements=a;for(const h of this.footprints)h.hiddenFlags&=-2;const u=[];for(const h of this.activeReplacements){if(h.order<=My)continue;const f=Math.max(1,Math.pow(2,h.footprintTileId.canonical.z-e.canonical.z));for(const _ of this.footprints)_.min.x>h.max.x||_.max.x<h.min.x||_.min.y>h.max.y||_.max.y<h.min.y||(u.length=0,W1(_.vertices,0,_.vertices.length,h.footprintTileId.canonical,e.canonical,u),__(h.footprint,u,_.indices,0,_.indices.length,0,-f)&&(_.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const h of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(h.groundEffectVertexOffset,h.groundEffectVertexLength,h.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getFootprint(e){if(e.id!==void 0){const i=this.featureFootprintLookup.get(e.id);return this.footprints[i]}return null}getHeightAtTileCoord(e,i){let o=Number.NEGATIVE_INFINITY,a=!0;const u=4*(e+Je)*Je+(i+Je);if(this.footprintLookup.hasOwnProperty(u)){const f=this.footprintLookup[u];return f?{height:f.height,hidden:f.hiddenFlags!==0}:void 0}const h=new Be(e,i);for(const f of this.footprints)e>f.max.x||f.min.x>e||i>f.max.y||f.min.y>i||f.height<=o||g_(h,f)&&(o=f.height,this.footprintLookup[u]=f,a=f.hiddenFlags!==0);if(o!==Number.NEGATIVE_INFINITY)return{height:o,hidden:a};this.footprintLookup[u]=void 0}}function W1(r,e,i,o,a,u){const h=Math.pow(2,o.z-a.z);for(let f=0;f<i;f++){let _=r[f+e].x,g=r[f+e].y;_=(_+a.x*Je)*h-o.x*Je,g=(g+a.y*Je)*h-o.y*Je,u.push(new Be(_,g))}}let Mx,Cx;pt(Ax,"BuildingBucket",{omit:["layers"]}),pt(F_,"BuildingGeometry"),pt(Ix,"BuildingBloomGeometry");const X1=ai([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),Y1=ai([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:K1}=X1,J1=ai([{name:"a_packed",components:3,type:"Float32"}]),{members:Q1}=J1,ew=ai([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:tw}=ew;class Px{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new Tl({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const o=this.getKey(e,i);return this.positions[o]}trim(){const e=this.width,i=this.height=pe(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,o){const a=[];let u=e.length%2==1?-e[e.length-1]*o:0,h=e[0]*o,f=!0;a.push({left:u,right:h,isDash:f,zeroLength:e[0]===0});let _=e[0];for(let g=1;g<e.length;g++){f=!f;const v=e[g];u=_*o,_+=v,h=_*o,a.push({left:u,right:h,isDash:f,zeroLength:v===0})}return a}addRoundDash(e,i,o){const a=i/2;for(let u=-o;u<=o;u++){const h=this.width*(this.nextRow+o+u);let f=0,_=e[f];for(let g=0;g<this.width;g++){g/_.right>1&&(_=e[++f]);const v=Math.abs(g-_.left),b=Math.abs(g-_.right),w=Math.min(v,b);let I;const A=u/o*(a+1);if(_.isDash){const P=a-Math.abs(A);I=Math.sqrt(w*w+P*P)}else I=a-Math.sqrt(w*w+A*A);this.image.data[h+g]=Math.max(0,Math.min(255,I+128))}}}addRegularDash(e,i){for(let _=e.length-1;_>=0;--_){const g=e[_],v=e[_+1];g.zeroLength?e.splice(_,1):v&&v.isDash===g.isDash&&(v.left=g.left,e.splice(_,1))}const o=e[0],a=e[e.length-1];o.isDash===a.isDash&&(o.left=a.left-this.width,a.right=o.right+this.width);const u=this.width*this.nextRow;let h=0,f=e[h];for(let _=0;_<this.width;_++){_/f.right>1&&(f=e[++h]);const g=Math.abs(_-f.left),v=Math.abs(_-f.right),b=Math.min(g,v);this.image.data[u+_]=Math.max(0,Math.min(255,(f.isDash?b:-b)+i+128))}}addDash(e,i){const o=this.getKey(e,i);if(this.positions[o])return this.positions[o];const a=i==="round",u=a?7:0,h=2*u+1;if(this.nextRow+h>this.height)return Mt("LineAtlas out of space"),null;e.length===0&&e.push(1);let f=0;for(let v=0;v<e.length;v++)e[v]<0&&(Mt("Negative value is found in line dasharray, replacing values with 0"),e[v]=0),f+=e[v];if(f!==0){const v=this.width/f,b=this.getDashRanges(e,this.width,v);a?this.addRoundDash(b,v,u):this.addRegularDash(b,i==="square"?.5*v:0)}const _=this.nextRow+u;this.nextRow+=h;const g={tl:[_,u],br:[f,0]};return this.positions[o]=g,g}}pt(Px,"LineAtlas");const iw=Ve.types,rw=Math.cos(Math.PI/180*37.5),nw=Math.cos(Math.PI/180*5);class k_{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((i=>{this.gradients[i.id]={}})),this.layoutVertexArray=new bu,this.layoutVertexArray2=new Fo,this.patternVertexArray=new Fo,this.indexArray=new vr,this.programConfigurations=new _s(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Ar,this.maxLineLength=0,this.zOffsetVertexArray=new Fo,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.tessellationStep=e.tessellationStep?e.tessellationStep:Je/64,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,o,a){}populate(e,i,o,a){this.hasPattern=u_("line",this.layers,this.pixelRatio,i);const u=this.layers[0].layout.get("line-sort-key");this.tileToMeter=re(o);const h=this.layers[0].layout.get("line-elevation-reference");if(h==="hd-road-markup")this.elevationType="road";else{const w=this.layers[0].layout.get("line-z-offset"),I=w.isConstant()&&!w.constantOr(0);this.elevationType=h!=="sea"&&h!=="ground"&&I?"none":"offset",this.elevationType==="offset"&&h==="none"&&Mt("line-elevation-reference: ground is used for the layer ".concat(this.layerIds[0]," because non-zero line-z-offset value was found."))}const f=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&f!==void 0;const _=[];for(const{feature:w,id:I,index:A,sourceLayerIndex:P}of e){const D=this.layers[0]._featureFilter.needGeometry,L=be(w,D);if(!this.layers[0]._featureFilter.filter(new lr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),L,o))continue;const V=u?u.evaluate(L,{},o):void 0,j={id:I,properties:w.properties,type:w.type,sourceLayerIndex:P,index:A,geometry:D?L.geometry:Le(w,o,a),patterns:{},sortKey:V};_.push(j)}u&&_.sort(((w,I)=>w.sortKey-I.sortKey));const{lineAtlas:g,featureIndex:v}=i,b=this.addConstantDashes(g);for(const w of _){const{geometry:I,index:A,sourceLayerIndex:P}=w;if(b&&this.addFeatureDashes(w,g),this.hasPattern){const D=h_("line",this.layers,w,this.zoom,this.pixelRatio,i);this.patternFeatures.push(D)}else this.addFeature(w,I,A,o,g.positions,i.availableImages,i.brightness,i.elevationFeatures);v.insert(e[A].feature,I,A,P,this.index)}}addConstantDashes(e){let i=!1;for(const o of this.layers){const a=o.paint.get("line-dasharray").value,u=o.layout.get("line-cap").value;if(a.kind!=="constant"||u.kind!=="constant")i=!0;else{const h=u.value,f=a.value;if(!f)continue;e.addDash(f,h)}}return i}addFeatureDashes(e,i){const o=this.zoom;for(const a of this.layers){const u=a.paint.get("line-dasharray").value,h=a.layout.get("line-cap").value;if(u.kind==="constant"&&h.kind==="constant")continue;let f,_;if(u.kind==="constant"){if(f=u.value,!f)continue}else f=u.evaluate({zoom:o},e);_=h.kind==="constant"?h.value:h.evaluate({zoom:o},e),i.addDash(f,_),e.patterns[a.id]=[i.getKey(f,_)]}}update(e,i,o,a,u,h,f,_){this.programConfigurations.updatePaintArrays(e,i,u,o,a,h,f,_)}addFeatures(e,i,o,a,u,h){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,i,o,a,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,Q1)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,tw)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,Y1.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,K1),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e,i){let o,a;if(i&&i>0?(o="mapbox_clip_start_".concat(i),a="mapbox_clip_end_".concat(i)):(o="mapbox_clip_start",a="mapbox_clip_end"),e.properties&&e.properties.hasOwnProperty(o)&&e.properties.hasOwnProperty(a))return{start:+e.properties[o],end:+e.properties[a]}}addFeature(e,i,o,a,u,h,f,_){const g=this.layers[0].layout,v=g.get("line-join").evaluate(e,{}),b=g.get("line-cap").evaluate(e,{}),w=g.get("line-miter-limit"),I=g.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e;const A=!(!e.properties||!e.properties.hasOwnProperty("mapbox_line_metrics"))&&e.properties.mapbox_line_metrics;this.zOffsetValue=g.get("line-z-offset").value;const P=this.layers[0].paint.get("line-width").value;if(P.kind!=="constant"&&P.isLineProgressConstant===!1&&(this.variableWidthValue=P),this.elevationType==="road"){const D=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,i,a,_,v,b,w,I)){const[L,V]=this.clipRuntimeLinesToTile(i,1);for(let j=0;j<L.length;j++){const H=L[j],te=V[j],K={progress:{min:te.progress.min,max:te.progress.max},nextDir:this.computeSegNextDir(te,H),prevDir:this.computeSegPrevDir(te,H)};this.addLine(H,e,a,v,b,w,I,K,A&&te.parentIndex>0?te.parentIndex:null)}this.fillNonElevatedRoadSegment(D)}}else for(let D=0;D<i.length;D++)this.addLine(i[D],e,a,v,b,w,I,void 0,A&&D>0?D:null);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,u,h,a,f,void 0,this.worldview)}computeSegNextDir(e,i){return e.nextPoint.sub(i.at(-2)).unit()}computeSegPrevDir(e,i){return i[1].sub(e.prevPoint).unit()}clipLinesToTile(e,i){return Ap(e,-i,-i,Je+i,Je+i)}clipRuntimeLinesToTile(e,i){const o=[];return[Ap(e,-i,-i,Je+i,Je+i,o),o]}addElevatedRoadFeature(e,i,o,a,u,h,f,_){const g=[],v=Ut.getElevationFeature(e,a);if(v){const b=this.clipLinesToTile(i,1),w=this.prepareElevatedLines(b,v,o);for(const I of w)g.push({geometry:I,elevation:v,elevationTileID:o,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(g.length===0)return!1;for(const b of g){const w=this.layoutVertexArray.length;this.addLine(b.geometry,e,o,u,h,f,_);const I=new gi(o,b.elevationTileID);if(b.elevation)for(let A=w;A<this.layoutVertexArray.length;A++){const P=new Be(this.layoutVertexArray.int16[6*A]>>1,this.layoutVertexArray.int16[6*A+1]>>1),D=I.pointElevation(P,b.elevation,.05);this.updateHeightRange(D),this.zOffsetVertexArray.emplaceBack(D,0,0)}else this.fillNonElevatedRoadSegment(w)}return!0}prepareElevatedLines(e,i,o){if(i.constantHeight!=null)return e;const a=[],u=1/re(o);for(const h of e)_1(h,new ur(i,u),0,a);return a}fillNonElevatedRoadSegment(e){for(let i=e;i<this.layoutVertexArray.length;i++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,i,o,a,u,h,f,_,g){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0,this.lineClips=g?this.lineFeatureClips(i,g):this.lineClips;const v=a==="none";this.patternJoinNone=this.hasPattern&&v,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const b=_&&_.progress.min>0,w=_&&_.progress.max<1;if(this.lineClips){let ue={min:this.lineClips.start,max:this.lineClips.end},Me=1;if(_){const Oe=this.lineClips.end-this.lineClips.start;ue=(function(Ne,Ye,He){return{min:Ki(Ne.min,Ye,He),max:Ki(Ne.max,Ye,He)}})(_.progress,{min:0,max:1},ue),Oe>0&&(Me=(ue.max-ue.min)/Oe)}const ye=+i.properties.mapbox_clip_feature_len,Ce=+i.properties.mapbox_clip_seg_len;if(Number.isNaN(ye)||Number.isNaN(Ce)){for(let Ne=0;Ne<e.length-1;Ne++)this.totalDistance+=e[Ne].dist(e[Ne+1]);const Oe=this.totalDistance/(ue.max-ue.min);this.totalFeatureLength=Number.isFinite(Oe)?Oe:0,this.lineClips.start=ue.min,this.lineClips.end=ue.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=ye,this.distance=Ce*Me,this.lineClips.start=ue.min,this.lineClips.end=ue.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const I=iw[i.type]==="Polygon";let A=e.length;for(;A>=2&&e[A-1].equals(e[A-2]);)A--;let P=0;for(;P<A-1&&e[P].equals(e[P+1]);)P++;if(A<(I?3:2))return;a==="bevel"&&(h=1.05);const D=this.segments.prepareSegment(10*A,this.layoutVertexArray,this.indexArray);let L,V,j,H,te,K,oe,le;_&&_.prevDir&&(K=_.prevDir.perp()),_&&_.nextDir&&(oe=_.nextDir.perp()),this.e1=this.e2=-1,I&&(L=e[A-2],te=e[P].sub(L)._unit()._perp());for(let ue=P;ue<A;ue++){if(j=ue===A-1?I?e[P+1]:void 0:e[ue+1],j&&e[ue].equals(j))continue;te&&(H=te),L&&(V=L),L=e[ue],le=this.evaluateLineProgressFeatures(V?V.dist(L):0),te=j?j.sub(L)._unit()._perp():H,H=H||te;const Me=V&&j;let ye=Me?a:I||v?"butt":u;const Ce=H.x*te.x+H.y*te.y;if(v){const Se=function(Ue){if(Ue.patternJoinNone){const Ze=Ue.segmentPoints.length/2,ke=Ue.lineSoFar-Ue.segmentStart;for(let ft=0;ft<Ze;++ft){const _t=Ue.segmentPoints[2*ft+1],ut=Math.round(Ue.segmentPoints[2*ft])+.5+.25*_t;Ue.patternVertexArray.emplaceBack(ut,ke,Ue.segmentStart),Ue.patternVertexArray.emplaceBack(ut,ke,Ue.segmentStart)}Ue.segmentPoints.length=0}Ue.e1=Ue.e2=-1};if(Me&&Ce<nw){this.updateDistance(V,L),this.addCurrentVertex(L,H,1,1,D,le),Se(this),this.addCurrentVertex(L,te,-1,-1,D,le);continue}if(V){if(!j){this.updateDistance(V,L),this.addCurrentVertex(L,H,1,1,D,le),Se(this);continue}ye="miter"}}let Oe=H.add(te);Oe.x===0&&Oe.y===0||Oe._unit();const Ne=Oe.x*te.x+Oe.y*te.y,Ye=Ne!==0?1/Ne:1/0,He=2*Math.sqrt(2-2*Ne),Fe=Ne<rw&&V&&j,Ge=H.x*te.y-H.y*te.x>0,Ie=this.overscaling<=16?15*Je/(512*this.overscaling):0;if(Me&&ye==="round"){if(Ye<f)ye="miter";else if(Ye<=2){const Se=B_(L,-10,Je+10);ye=this.elevationType==="offset"&&(Se||this.hasCrossSlope)?"miter":"fakeround"}}if(ye==="miter"&&Ye>h&&(ye="bevel"),ye==="bevel"&&(Ye>2&&(ye="flipbevel"),Ye<h&&(ye="miter")),V&&!(ye==="miter"&&Fe)&&this.updateDistance(V,L),ye==="miter")if(Fe){const Se=L.dist(V);if(Se>2*Ie){const Ze=L.sub(L.sub(V)._mult(Ie/Se)._round());this.updateDistance(V,Ze),this.addCurrentVertex(Ze,H,0,0,D,le),V=Ze}this.updateDistance(V,L),Oe._mult(Ye),this.addCurrentVertex(L,Oe,0,0,D,le);const Ue=L.dist(j);if(Ue>2*Ie){const Ze=L.add(j.sub(L)._mult(Ie/Ue)._round());this.updateDistance(L,Ze),this.addCurrentVertex(Ze,te,0,0,D,le),L=Ze}}else Oe._mult(Ye),this.addCurrentVertex(L,Oe,0,0,D,le);else if(ye==="flipbevel"){if(Ye>100)Oe=te.mult(-1);else{const Se=Ye*H.add(te).mag()/H.sub(te).mag();Oe._perp()._mult(Se*(Ge?-1:1))}this.addCurrentVertex(L,Oe,0,0,D,le),this.addCurrentVertex(L,Oe.mult(-1),0,0,D,le)}else if(ye==="bevel"||ye==="fakeround"){le!=null&&V&&this.addCurrentVertex(L,oe||H,-1,-1,D,le);const Se=L.dist(V)<=2*Ie&&ye!=="bevel",Ue=Oe.mult(Ge?1:-1);Ue._mult(Ye);const Ze=te.mult(Ge?-1:1),ke=H.mult(Ge?-1:1),ft=this.evaluateLineProgressFeatures(this.distance);if(le==null&&(this.addHalfVertex(L,Ue.x,Ue.y,!1,!Ge,0,D,ft),Se||this.addHalfVertex(L,Ue.x+2*ke.x,Ue.y+2*ke.y,!1,Ge,0,D,ft)),ye==="fakeround"){const _t=Math.round(180*He/Math.PI/20);this.addHalfVertex(L,ke.x,ke.y,!1,Ge,0,D,ft);for(let ut=0;ut<_t;ut++){let ot=ut/_t;if(ot!==.5){const at=ot-.5;ot+=ot*at*(ot-1)*((1.0904+Ce*(Ce*(3.55645-1.43519*Ce)-3.2452))*at*at+(.848013+Ce*(.215638*Ce-1.06021)))}const jt=Ze.sub(ke)._mult(ot)._add(ke)._unit();this.addHalfVertex(L,jt.x,jt.y,!1,Ge,0,D,ft)}this.addHalfVertex(L,Ze.x,Ze.y,!1,Ge,0,D,ft)}Se||le!=null||this.addHalfVertex(L,Ue.x+2*Ze.x,Ue.y+2*Ze.y,!1,Ge,0,D,ft),le!=null&&j&&this.addCurrentVertex(L,K||te,1,1,D,le)}else if(ye==="butt")this.addCurrentVertex(L,Oe,0,0,D,le);else if(ye==="square"){if(!V){const Se=b?0:-1;this.addCurrentVertex(L,Oe,Se,Se,D,le)}if(this.addCurrentVertex(L,Oe,0,0,D,le),V){const Se=w?0:1;this.addCurrentVertex(L,Oe,Se,Se,D,le)}}else if(ye==="round"){if(V){const Se=!Me&&oe?oe:H;this.addCurrentVertex(L,Se,0,0,D,le),!Me&&w||this.addCurrentVertex(L,Se,1,1,D,le,!0)}if(j){const Se=!Me&&K?K:te;!Me&&b||this.addCurrentVertex(L,Se,-1,-1,D,le,!0),this.addCurrentVertex(L,Se,0,0,D,le)}}}}addVerticesTo(e,i,o,a,u,h,f,_,g,v){const b=(i.w-e.w)/this.tessellationStep|0;let w=0;const I=this.scaledDistance;if(b>1){this.lineSoFar=e.w;const P=(i.x-e.x)/b,D=(i.y-e.y)/b,L=(i.z-e.z)/b,V=(i.w-e.w)/b;for(let j=1;j<b;++j){e.x+=P,e.y+=D,e.z+=L,this.lineSoFar+=V,w+=V;const H=this.evaluateLineProgressFeatures(this.prevDistance+w);this.scaledDistance=(this.prevDistance+w)/this.totalDistance,this.addHalfVertex(e,o,a,v,!1,f,g,H),this.addHalfVertex(e,u,h,v,!0,-_,g,H)}}this.lineSoFar=i.w,this.scaledDistance=I;const A=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,o,a,v,!1,f,g,A),this.addHalfVertex(i,u,h,v,!0,-_,g,A)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):Mt("line-progress evaluation for ".concat(this.layerIds[0]," requires enabling 'lineMetrics' for the source."));let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:i}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}}addCurrentVertex(e,i,o,a,u,h,f=!1){const _=i.x+i.y*o,g=i.y-i.x*o,v=i.y*a-i.x,b=-i.y-i.x*a;if(h!=null){const w=this.elevationType==="offset",I=-10,A=Je+10,P=h.zOffset,D=new Ky(e.x,e.y,P,this.lineSoFar),L=!!w&&B_(e,I,A),V=this.lineSoFar,j=this.distance;if(this.currentVertex)if(L){const H=this.currentVertexIsOutside,te=this.currentVertex,K=new Ky(e.x,e.y,P,this.lineSoFar);if(Qy(te,K,I,A),!B_(K,I,A)){if(H){this.e1=this.e2=-1,this.distance-=te.dist(D),this.lineSoFar=te.w;const oe=this.evaluateLineProgressFeatures(te.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(te,_,g,f,!1,o,u,oe),this.addHalfVertex(te,v,b,f,!0,-a,u,oe),this.prevDistance=this.distance}this.distance=this.prevDistance+te.dist(K),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(te,K,_,g,v,b,o,a,u,f),this.distance=j,this.scaledDistance=this.distance/this.totalDistance}}else{const H=this.currentVertex;if(this.currentVertexIsOutside){Qy(H,D,I,A),this.e1=this.e2=-1,this.distance-=H.dist(D),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=H.w;const te=this.evaluateLineProgressFeatures(H.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(H,_,g,f,!1,o,u,te),this.addHalfVertex(H,v,b,f,!0,-a,u,te),this.prevDistance=this.distance,this.distance=j,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(H,D,_,g,v,b,o,a,u,f)}else L||(this.addHalfVertex(e,_,g,f,!1,o,u,h),this.addHalfVertex(e,v,b,f,!0,-a,u,h));this.currentVertex=D,this.currentVertexIsOutside=L,this.lineSoFar=V}else this.addHalfVertex(e,_,g,f,!1,o,u,h),this.addHalfVertex(e,v,b,f,!0,-a,u,h)}addHalfVertex({x:e,y:i},o,a,u,h,f,_,g){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),h||this.segmentPoints.push(this.lineSoFar-this.segmentStart,f)),this.layoutVertexArray.emplaceBack((e<<1)+(u?1:0),(i<<1)+(h?1:0),Math.round(63*o)+128,Math.round(63*a)+128,1+(f===0?0:f<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const b=Ft(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,b)}const v=_.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,v),_.primitiveLength++),h?this.e2=v:this.e1=v,g!=null&&this.zOffsetVertexArray.emplaceBack(g.zOffset,g.variableWidth,g.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function B_(r,e,i){return r.x<e||r.x>i||r.y<e||r.y>i}let Rx,Dx;function zx(r,e,i){return e*(Je/(r.tileSize*Math.pow(2,i-r.tileID.overscaledZ)))}pt(k_,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const Lx=(r,e,i)=>(1-i)*r+i*e;function Ox(r,e){return 1/zx(r,1,e.tileZoom)}function Fx(r,e,i,o){return r.translatePosMatrix(o||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const kx=r=>{const e=[];Bx(r)&&e.push("RENDER_LINE_DASH"),r.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=r.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),r.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const o=r.layout.get("line-join").constantOr("miter")==="none",a=!!r.paint.get("line-pattern").constantOr(1);return o&&a&&e.push("LINE_JOIN_NONE"),e};function Bx(r){const e=r.paint.get("line-dasharray").value;return e.kind!=="constant"||e.value}let N_;const Nx=()=>N_||(N_={layout:Rx||(Rx=new kr({"line-cap":new lt(ge.layout_line["line-cap"]),"line-join":new lt(ge.layout_line["line-join"]),"line-miter-limit":new qe(ge.layout_line["line-miter-limit"]),"line-round-limit":new qe(ge.layout_line["line-round-limit"]),"line-sort-key":new lt(ge.layout_line["line-sort-key"]),"line-z-offset":new lt(ge.layout_line["line-z-offset"]),"line-elevation-reference":new qe(ge.layout_line["line-elevation-reference"]),"line-cross-slope":new qe(ge.layout_line["line-cross-slope"]),visibility:new qe(ge.layout_line.visibility),"line-width-unit":new qe(ge.layout_line["line-width-unit"])})),paint:Dx||(Dx=new kr({"line-opacity":new lt(ge.paint_line["line-opacity"]),"line-color":new lt(ge.paint_line["line-color"]),"line-translate":new qe(ge.paint_line["line-translate"]),"line-translate-anchor":new qe(ge.paint_line["line-translate-anchor"]),"line-width":new lt(ge.paint_line["line-width"]),"line-gap-width":new lt(ge.paint_line["line-gap-width"]),"line-offset":new lt(ge.paint_line["line-offset"]),"line-blur":new lt(ge.paint_line["line-blur"]),"line-dasharray":new lt(ge.paint_line["line-dasharray"]),"line-pattern":new lt(ge.paint_line["line-pattern"]),"line-pattern-cross-fade":new qe(ge.paint_line["line-pattern-cross-fade"]),"line-gradient":new al(ge.paint_line["line-gradient"]),"line-trim-offset":new qe(ge.paint_line["line-trim-offset"]),"line-trim-fade-range":new qe(ge.paint_line["line-trim-fade-range"]),"line-trim-color":new qe(ge.paint_line["line-trim-color"]),"line-emissive-strength":new qe(ge.paint_line["line-emissive-strength"]),"line-border-width":new lt(ge.paint_line["line-border-width"]),"line-border-color":new lt(ge.paint_line["line-border-color"]),"line-occlusion-opacity":new qe(ge.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},N_);class ow extends lt{possiblyEvaluate(e,i){return i=new lr(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition,worldview:i.worldview}),super.possiblyEvaluate(e,i)}evaluate(e,i,o,a){return i=Object.assign({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,o,a)}}let Vd;function Vx(r,e){return e>0?e+2*r:r}const sw=ai([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),aw=ai([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),lw=ai([{name:"a_projected_pos",components:4,type:"Float32"}],4);ai([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const cw=ai([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),uw=ai([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),hw=ai([{name:"a_texb",components:2,type:"Uint16"}]),dw=ai([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),fw=ai([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);ai([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Ux=ai([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),pw=ai([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);ai([{name:"triangle",components:3,type:"Uint16"}]),ai([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),ai([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),ai([{type:"Float32",name:"offsetX"}]),ai([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var zn=24;function mw(r,e,i){return r.sections.forEach((o=>{o.text=(function(a,u,h){const f=u.layout.get("text-transform").evaluate(h,{});return f==="uppercase"?a=a.toLocaleUpperCase():f==="lowercase"&&(a=a.toLocaleLowerCase()),Io.applyArabicShaping&&(a=Io.applyArabicShaping(a)),a})(o.text,e,i)})),r}const Ud={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function _w(r){return r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""}function gw(r){return r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""}const V_=4294967296,jx=1/V_,Gx=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");let Bp=class{constructor(r=new Uint8Array(16)){this.buf=ArrayBuffer.isView(r)?r:new Uint8Array(r),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(r,e,i=this.length){for(;this.pos<i;){const o=this.readVarint(),a=o>>3,u=this.pos;this.type=7&o,r(a,e,this),this.pos===u&&this.skip(o)}return e}readMessage(r,e){return this.readFields(r,e,this.readVarint()+this.pos)}readFixed32(){const r=this.dataView.getUint32(this.pos,!0);return this.pos+=4,r}readSFixed32(){const r=this.dataView.getInt32(this.pos,!0);return this.pos+=4,r}readFixed64(){const r=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*V_;return this.pos+=8,r}readSFixed64(){const r=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*V_;return this.pos+=8,r}readFloat(){const r=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,r}readDouble(){const r=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,r}readVarint(r){const e=this.buf;let i,o;return o=e[this.pos++],i=127&o,o<128?i:(o=e[this.pos++],i|=(127&o)<<7,o<128?i:(o=e[this.pos++],i|=(127&o)<<14,o<128?i:(o=e[this.pos++],i|=(127&o)<<21,o<128?i:(o=e[this.pos],i|=(15&o)<<28,(function(a,u,h){const f=h.buf;let _,g;if(g=f[h.pos++],_=(112&g)>>4,g<128||(g=f[h.pos++],_|=(127&g)<<3,g<128)||(g=f[h.pos++],_|=(127&g)<<10,g<128)||(g=f[h.pos++],_|=(127&g)<<17,g<128)||(g=f[h.pos++],_|=(127&g)<<24,g<128)||(g=f[h.pos++],_|=(1&g)<<31,g<128))return ju(a,_,u);throw new Error("Expected varint not more than 10 bytes")})(i,r,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const r=this.readVarint();return r%2==1?(r+1)/-2:r/2}readBoolean(){return!!this.readVarint()}readString(){const r=this.readVarint()+this.pos,e=this.pos;return this.pos=r,r-e>=12&&Gx?Gx.decode(this.buf.subarray(e,r)):(function(i,o,a){let u="",h=o;for(;h<a;){const f=i[h];let _,g,v,b=null,w=f>239?4:f>223?3:f>191?2:1;if(h+w>a)break;w===1?f<128&&(b=f):w===2?(_=i[h+1],(192&_)==128&&(b=(31&f)<<6|63&_,b<=127&&(b=null))):w===3?(_=i[h+1],g=i[h+2],(192&_)==128&&(192&g)==128&&(b=(15&f)<<12|(63&_)<<6|63&g,(b<=2047||b>=55296&&b<=57343)&&(b=null))):w===4&&(_=i[h+1],g=i[h+2],v=i[h+3],(192&_)==128&&(192&g)==128&&(192&v)==128&&(b=(15&f)<<18|(63&_)<<12|(63&g)<<6|63&v,(b<=65535||b>=1114112)&&(b=null))),b===null?(b=65533,w=1):b>65535&&(b-=65536,u+=String.fromCharCode(b>>>10&1023|55296),b=56320|1023&b),u+=String.fromCharCode(b),h+=w}return u})(this.buf,e,r)}readBytes(){const r=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,r);return this.pos=r,e}readPackedVarint(r=[],e){const i=this.readPackedEnd();for(;this.pos<i;)r.push(this.readVarint(e));return r}readPackedSVarint(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSVarint());return r}readPackedBoolean(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readBoolean());return r}readPackedFloat(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFloat());return r}readPackedDouble(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readDouble());return r}readPackedFixed32(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed32());return r}readPackedSFixed32(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed32());return r}readPackedFixed64(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed64());return r}readPackedSFixed64(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed64());return r}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(r){const e=7&r;if(e===0)for(;this.buf[this.pos++]>127;);else if(e===2)this.pos=this.readVarint()+this.pos;else if(e===5)this.pos+=4;else{if(e!==1)throw new Error("Unimplemented type: ".concat(e));this.pos+=8}}writeTag(r,e){this.writeVarint(r<<3|e)}realloc(r){let e=this.length||16;for(;e<this.pos+r;)e*=2;if(e!==this.length){const i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.dataView=new DataView(i.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeSFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*jx),!0),this.pos+=8}writeSFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*jx),!0),this.pos+=8}writeVarint(r){(r=+r||0)>268435455||r<0?(function(e,i){let o,a;if(e>=0?(o=e%4294967296|0,a=e/4294967296|0):(o=~(-e%4294967296),a=~(-e/4294967296),4294967295^o?o=o+1|0:(o=0,a=a+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");i.realloc(10),(function(u,h,f){f.buf[f.pos++]=127&u|128,u>>>=7,f.buf[f.pos++]=127&u|128,u>>>=7,f.buf[f.pos++]=127&u|128,u>>>=7,f.buf[f.pos++]=127&u|128,f.buf[f.pos]=127&(u>>>=7)})(o,0,i),(function(u,h){const f=(7&u)<<4;h.buf[h.pos++]|=f|((u>>>=3)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u)))))})(a,i)})(r,this):(this.realloc(4),this.buf[this.pos++]=127&r|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=r>>>7&127))))}writeSVarint(r){this.writeVarint(r<0?2*-r-1:2*r)}writeBoolean(r){this.writeVarint(+r)}writeString(r){r=String(r),this.realloc(4*r.length),this.pos++;const e=this.pos;this.pos=(function(o,a,u){for(let h,f,_=0;_<a.length;_++){if(h=a.charCodeAt(_),h>55295&&h<57344){if(!f){h>56319||_+1===a.length?(o[u++]=239,o[u++]=191,o[u++]=189):f=h;continue}if(h<56320){o[u++]=239,o[u++]=191,o[u++]=189,f=h;continue}h=f-55296<<10|h-56320|65536,f=null}else f&&(o[u++]=239,o[u++]=191,o[u++]=189,f=null);h<128?o[u++]=h:(h<2048?o[u++]=h>>6|192:(h<65536?o[u++]=h>>12|224:(o[u++]=h>>18|240,o[u++]=h>>12&63|128),o[u++]=h>>6&63|128),o[u++]=63&h|128)}return u})(this.buf,r,this.pos);const i=this.pos-e;i>=128&&Hx(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i}writeFloat(r){this.realloc(4),this.dataView.setFloat32(this.pos,r,!0),this.pos+=4}writeDouble(r){this.realloc(8),this.dataView.setFloat64(this.pos,r,!0),this.pos+=8}writeBytes(r){const e=r.length;this.writeVarint(e),this.realloc(e);for(let i=0;i<e;i++)this.buf[this.pos++]=r[i]}writeRawMessage(r,e){this.pos++;const i=this.pos;r(e,this);const o=this.pos-i;o>=128&&Hx(i,o,this),this.pos=i-1,this.writeVarint(o),this.pos+=o}writeMessage(r,e,i){this.writeTag(r,2),this.writeRawMessage(e,i)}writePackedVarint(r,e){e.length&&this.writeMessage(r,yw,e)}writePackedSVarint(r,e){e.length&&this.writeMessage(r,xw,e)}writePackedBoolean(r,e){e.length&&this.writeMessage(r,ww,e)}writePackedFloat(r,e){e.length&&this.writeMessage(r,vw,e)}writePackedDouble(r,e){e.length&&this.writeMessage(r,bw,e)}writePackedFixed32(r,e){e.length&&this.writeMessage(r,Tw,e)}writePackedSFixed32(r,e){e.length&&this.writeMessage(r,Sw,e)}writePackedFixed64(r,e){e.length&&this.writeMessage(r,Ew,e)}writePackedSFixed64(r,e){e.length&&this.writeMessage(r,Iw,e)}writeBytesField(r,e){this.writeTag(r,2),this.writeBytes(e)}writeFixed32Field(r,e){this.writeTag(r,5),this.writeFixed32(e)}writeSFixed32Field(r,e){this.writeTag(r,5),this.writeSFixed32(e)}writeFixed64Field(r,e){this.writeTag(r,1),this.writeFixed64(e)}writeSFixed64Field(r,e){this.writeTag(r,1),this.writeSFixed64(e)}writeVarintField(r,e){this.writeTag(r,0),this.writeVarint(e)}writeSVarintField(r,e){this.writeTag(r,0),this.writeSVarint(e)}writeStringField(r,e){this.writeTag(r,2),this.writeString(e)}writeFloatField(r,e){this.writeTag(r,5),this.writeFloat(e)}writeDoubleField(r,e){this.writeTag(r,1),this.writeDouble(e)}writeBooleanField(r,e){this.writeVarintField(r,+e)}};function ju(r,e,i){return i?4294967296*e+(r>>>0):4294967296*(e>>>0)+(r>>>0)}function Hx(r,e,i){const o=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(o);for(let a=i.pos-1;a>=r;a--)i.buf[a+o]=i.buf[a]}function yw(r,e){for(let i=0;i<r.length;i++)e.writeVarint(r[i])}function xw(r,e){for(let i=0;i<r.length;i++)e.writeSVarint(r[i])}function vw(r,e){for(let i=0;i<r.length;i++)e.writeFloat(r[i])}function bw(r,e){for(let i=0;i<r.length;i++)e.writeDouble(r[i])}function ww(r,e){for(let i=0;i<r.length;i++)e.writeBoolean(r[i])}function Tw(r,e){for(let i=0;i<r.length;i++)e.writeFixed32(r[i])}function Sw(r,e){for(let i=0;i<r.length;i++)e.writeSFixed32(r[i])}function Ew(r,e){for(let i=0;i<r.length;i++)e.writeFixed64(r[i])}function Iw(r,e){for(let i=0;i<r.length;i++)e.writeSFixed64(r[i])}const U_=3;function Aw(r,e,i){e.glyphs=[],r===1&&i.readMessage(Mw,e)}function Mw(r,e,i){if(r===3){const{id:o,bitmap:a,width:u,height:h,left:f,top:_,advance:g}=i.readMessage(Cw,{});e.glyphs.push({id:o,bitmap:new Tl({width:u+2*U_,height:h+2*U_},a),metrics:{width:u,height:h,left:f,top:_,advance:g}})}else r===4?e.ascender=i.readSVarint():r===5&&(e.descender=i.readSVarint())}function Cw(r,e,i){r===1?e.id=i.readVarint():r===2?e.bitmap=i.readBytes():r===3?e.width=i.readVarint():r===4?e.height=i.readVarint():r===5?e.left=i.readSVarint():r===6?e.top=i.readSVarint():r===7&&(e.advance=i.readVarint())}const qx=U_,Go={horizontal:1,vertical:2,horizontalOnly:3};class jd{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){const o=new jd;return o.scale=e||1,o.fontStack=i,o}static forImage(e){const i=new jd;return i.image=e,i}}class Gu{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i,o){const a=new Gu;for(let u=0;u<e.sections.length;u++){const h=e.sections[u];h.image?a.addImageSection(h,o):a.addTextSection(h,i)}return a}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=(function(i,o){let a="";for(let u=0;u<i.length;u++){const h=i.charCodeAt(u+1)||null,f=i.charCodeAt(u-1)||null;a+=!o&&(h&&$h(h)&&!Ud[i[u+1]]||f&&$h(f)&&!Ud[i[u-1]])||!Ud[i[u]]?i[u]:Ud[i[u]]}return a})(this.text,e)}trim(){let e=0;for(let o=0;o<this.text.length&&Np[this.text.charCodeAt(o)];o++)e++;let i=this.text.length;for(let o=this.text.length-1;o>=0&&o>=e&&Np[this.text.charCodeAt(o)];o--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const o=new Gu;return o.text=this.text.substring(e,i),o.sectionIndex=this.sectionIndex.slice(e,i),o.sections=this.sections,o}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((e,i)=>Math.max(e,this.sections[i].scale)),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(jd.forText(e.scale,e.fontStack||i));const o=this.sections.length-1;for(let a=0;a<e.text.length;++a)this.sectionIndex.push(o)}addImageSection(e,i){const o=e.image?e.image.getPrimary():null;if(!o)return void Mt("Can't add FormattedSection with an empty image.");o.scaleSelf(i);const a=this.getNextImageSectionCharCode();a?(this.text+=String.fromCodePoint(a),this.sections.push(jd.forImage(o)),this.sectionIndex.push(this.sections.length-1)):Mt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function j_(r,e,i,o,a,u,h,f,_,g,v,b,w,I,A,P=1){const D=Gu.fromFeature(r,a,P);b===Go.vertical&&D.verticalizePunctuation(w);let L=[];const V=(function(oe,le,ue,Me,ye,Ce){if(!oe)return[];const Oe=[],Ne=(function(Ge,Ie,Se,Ue,Ze,ke){let ft=0;for(let _t=0;_t<Ge.length();_t++){const ut=Ge.getSection(_t);ft+=$x(Ge.getCodePoint(_t),ut,Ue,Ze,Ie,ke)}return ft/Math.max(1,Math.ceil(ft/Se))})(oe,le,ue,Me,ye,Ce),Ye=oe.text.indexOf("")>=0;let He=0;for(let Ge=0;Ge<oe.length();Ge++){const Ie=oe.getSection(Ge),Se=oe.getCodePoint(Ge);if(Np[Se]||(He+=$x(Se,Ie,Me,ye,le,Ce)),Ge<oe.length()-1){const Ue=!((Fe=Se)<11904||!(Ct["Bopomofo Extended"](Fe)||Ct.Bopomofo(Fe)||Ct["CJK Compatibility Forms"](Fe)||Ct["CJK Compatibility Ideographs"](Fe)||Ct["CJK Compatibility"](Fe)||Ct["CJK Radicals Supplement"](Fe)||Ct["CJK Strokes"](Fe)||Ct["CJK Symbols and Punctuation"](Fe)||Ct["CJK Unified Ideographs Extension A"](Fe)||Ct["CJK Unified Ideographs"](Fe)||Ct["Enclosed CJK Letters and Months"](Fe)||Ct["Halfwidth and Fullwidth Forms"](Fe)||Ct.Hiragana(Fe)||Ct["Ideographic Description Characters"](Fe)||Ct["Kangxi Radicals"](Fe)||Ct["Katakana Phonetic Extensions"](Fe)||Ct.Katakana(Fe)||Ct["Vertical Forms"](Fe)||Ct["Yi Radicals"](Fe)||Ct["Yi Syllables"](Fe)));(Pw[Se]||Ue||Ie.image)&&Oe.push(Wx(Ge+1,He,Ne,Oe,Rw(Se,oe.getCodePoint(Ge+1),Ue&&Ye),!1))}}var Fe;return Xx(Wx(oe.length(),He,Ne,Oe,0,!0))})(D,g,u,e,o,I),{processBidirectionalText:j,processStyledBidirectionalText:H}=Io;if(j&&D.sections.length===1){const oe=j(D.toString(),V);for(const le of oe){const ue=new Gu;ue.text=le,ue.sections=D.sections;for(let Me=0;Me<le.length;Me++)ue.sectionIndex.push(0);L.push(ue)}}else if(H){const oe=H(D.text,D.sectionIndex,V);for(const le of oe){const ue=new Gu;ue.text=le[0],ue.sectionIndex=le[1],ue.sections=D.sections,L.push(ue)}}else L=(function(oe,le){const ue=[],Me=oe.text;let ye=0;for(const Ce of le)ue.push(oe.substring(ye,Ce)),ye=Ce;return ye<Me.length&&ue.push(oe.substring(ye,Me.length)),ue})(D,V);const te=[],K={positionedLines:te,text:D.toString(),top:v[1],bottom:v[1],left:v[0],right:v[0],writingMode:b,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if((function(oe,le,ue,Me,ye,Ce,Oe,Ne,Ye,He,Fe,Ge){let Ie=0,Se=0,Ue=0;const Ze=Ne==="right"?1:Ne==="left"?0:.5;let ke=!1;for(const at of ye){const Et=at.getSections();for(const Ht of Et){if(Ht.image)continue;const oi=le[Ht.fontStack];if(oi&&(ke=oi.ascender!==void 0&&oi.descender!==void 0,!ke))break}if(!ke)break}let ft=0;for(const at of ye){at.trim();const Et=at.getMaxScale(),Ht=(Et-1)*zn,oi={positionedGlyphs:[],lineOffset:0};oe.positionedLines[ft]=oi;const yi=oi.positionedGlyphs;let $t=0;if(!at.length()){Se+=Ce,++ft;continue}let Pi=0,Ri=0;for(let J=0;J<at.length();J++){const W=at.getSection(J),Re=at.getSectionIndex(J),it=at.getCodePoint(J);let De=W.scale,st=null,wt=null,vt=null,Zt=zn,zt=0,yt=Ye;yt===Go.vertical&&((_t=it)===12312||_t===12313||_t===12316||_t===12540||_t===12448)&&(yt=Go.horizontal);const Ai=!(yt===Go.horizontal||!Fe&&!_u(it)||Fe&&(Np[it]||Zh(it)));if(W.image){const Ji=Me.get(W.image.toString());if(!Ji)continue;vt=W.image,oe.iconsInText=oe.iconsInText||!0,wt=Ji.paddedRect;const Ot=Ji.displaySize;De=De*zn/Ge,st={width:Ot[0],height:Ot[1],left:0,top:-qx,advance:Ai?Ot[1]:Ot[0],localGlyph:!1},zt=ke?-st.height*De:Et*zn-17-Ot[1]*De,Zt=st.advance;const _i=(Ai?Ot[0]:Ot[1])*De-zn*Et;_i>0&&_i>$t&&($t=_i)}else{const Ji=ue[W.fontStack];if(!Ji)continue;Ji[it]&&(wt=Ji[it]);const Ot=le[W.fontStack];if(!Ot)continue;const _i=Ot.glyphs[it];if(!_i)continue;if(st=_i.metrics,Zt=it!==8203?zn:0,ke){const Qi=Ot.ascender!==void 0?Math.abs(Ot.ascender):0,ji=Ot.descender!==void 0?Math.abs(Ot.descender):0,Lr=(Qi+ji)*De;Pi<Lr&&(Pi=Lr,Ri=(Qi-ji)/2*De),zt=-Qi*De}else zt=(Et-De)*zn-17}Ai?(oe.verticalizable=!0,yi.push({glyph:it,image:vt,x:Ie,y:Se+zt,vertical:Ai,scale:De,localGlyph:st.localGlyph,fontStack:W.fontStack,sectionIndex:Re,metrics:st,rect:wt}),Ie+=Zt*De+He):(yi.push({glyph:it,image:vt,x:Ie,y:Se+zt,vertical:Ai,scale:De,localGlyph:st.localGlyph,fontStack:W.fontStack,sectionIndex:Re,metrics:st,rect:wt}),Ie+=st.advance*De+He)}yi.length!==0&&(Ue=Math.max(Ie-He,Ue),ke?Yx(yi,Ze,$t,Ri,Ce*Et/2):Yx(yi,Ze,$t,0,Ce/2)),Ie=0;const Tr=Ce*Et+$t;oi.lineOffset=Math.max($t,Ht),Se+=Tr,++ft}var _t;const ut=Se,{horizontalAlign:ot,verticalAlign:jt}=G_(Oe);(function(at,Et,Ht,oi,yi,$t){const Pi=(Et-Ht)*yi,Ri=-$t*oi;for(const Tr of at)for(const J of Tr.positionedGlyphs)J.x+=Pi,J.y+=Ri})(oe.positionedLines,Ze,ot,jt,Ue,ut),oe.top+=-jt*ut,oe.bottom=oe.top+ut,oe.left+=-ot*Ue,oe.right=oe.left+Ue,oe.hasBaseline=ke})(K,e,i,o,L,h,f,_,b,g,w,A),!(function(oe){for(const le of oe)if(le.positionedGlyphs.length!==0)return!1;return!0})(te))return K}const Np={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Pw={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function $x(r,e,i,o,a,u){if(e.image){const h=o.get(e.image.toString());return h?h.displaySize[0]*e.scale*zn/u+a:0}{const h=i[e.fontStack],f=h&&h.glyphs[r];return f?f.metrics.advance*e.scale+a:0}}function Zx(r,e,i,o){const a=Math.pow(r-e,2);return o?r<e?a/2:2*a:a+Math.abs(i)*i}function Rw(r,e,i){let o=0;return r===10&&(o-=1e4),i&&(o+=150),r!==40&&r!==65288||(o+=50),e!==41&&e!==65289||(o+=50),o}function Wx(r,e,i,o,a,u){let h=null,f=Zx(e,i,a,u);for(const _ of o){const g=Zx(e-_.x,i,a,u)+_.badness;g<=f&&(h=_,f=g)}return{index:r,x:e,priorBreak:h,badness:f}}function Xx(r){return r?Xx(r.priorBreak).concat(r.index):[]}function G_(r){let e=.5,i=.5;switch(r){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function Yx(r,e,i,o,a){if(!(e||i||o||a))return;const u=r.length-1,h=r[u],f=(h.x+h.metrics.advance*h.scale)*e;for(let _=0;_<=u;_++)r[_].x-=f,r[_].y+=i+o+a}function Kx(r){return r.imagePrimary!==void 0&&r.top!==void 0&&r.bottom!==void 0&&r.left!==void 0&&r.right!==void 0}function Vp(r,e,i,o){const{horizontalAlign:a,verticalAlign:u}=G_(o),h=i[0]-r.displaySize[0]*a,f=i[1]-r.displaySize[1]*u;return{imagePrimary:r,imageSecondary:e,top:f,bottom:f+r.displaySize[1],left:h,right:h+r.displaySize[0]}}function H_(r,e,i,o,a,u){const h=r.imagePrimary;let f;if(h.content){const D=h.content,L=h.pixelRatio||1;f=[D[0]/L,D[1]/L,h.displaySize[0]-D[2]/L,h.displaySize[1]-D[3]/L]}const _=e.left*u,g=e.right*u;let v,b,w,I;i==="width"||i==="both"?(I=a[0]+_-o[3],b=a[0]+g+o[1]):(I=a[0]+(_+g-h.displaySize[0])/2,b=I+h.displaySize[0]);const A=e.top*u,P=e.bottom*u;return i==="height"||i==="both"?(v=a[1]+A-o[0],w=a[1]+P+o[2]):(v=a[1]+(A+P-h.displaySize[1])/2,w=v+h.displaySize[1]),{imagePrimary:h,imageSecondary:void 0,top:v,right:b,bottom:w,left:I,collisionPadding:f}}function Jx(r){return!r.imagePrimary.stretchX}function Qx(r){return!r.imagePrimary.stretchY}function ev(r){return{width:r.right-r.left,height:r.bottom-r.top}}const qs=128;function Hu(r,e,i){const{expression:o}=e;if(o.kind==="constant")return{kind:"constant",layoutSize:o.evaluate(new lr(r+1,{worldview:i}))};if(o.kind==="source")return{kind:"source"};{const{zoomStops:a,interpolationType:u}=o;let h=0;for(;h<a.length&&a[h]<=r;)h++;h=Math.max(0,h-1);let f=h;for(;f<a.length&&a[f]<r+1;)f++;f=Math.min(a.length-1,f);const _=a[h],g=a[f];return o.kind==="composite"?{kind:"composite",minZoom:_,maxZoom:g,interpolationType:u}:{kind:"camera",minZoom:_,maxZoom:g,minSize:o.evaluate(new lr(_,{worldview:i})),maxSize:o.evaluate(new lr(g,{worldview:i})),interpolationType:u}}}function q_(r,{uSize:e,uSizeT:i},{lowerSize:o,upperSize:a}){return r.kind==="source"?o/qs:r.kind==="composite"?Ft(o/qs,a/qs,i):e}function qu(r,e,i=1){let o=0,a=0;if(r.kind==="constant")a=r.layoutSize*i;else if(r.kind!=="source"){const{interpolationType:u,minZoom:h,maxZoom:f}=r,_=u?B(Lo.interpolationFactor(u,e,h,f),0,1):0;r.kind==="camera"?a=Ft(r.minSize,r.maxSize,_)*i:o=_*i}return{uSizeT:o,uSize:a}}class Fa extends Be{constructor(e,i,o,a,u){super(e,i),this.angle=a,this.z=o,u!==void 0&&(this.segment=u)}clone(){return new Fa(this.x,this.y,this.z,this.angle,this.segment)}}function tv(r,e,i,o,a){if(e.segment===void 0)return!0;let u=e,h=e.segment+1,f=0;for(;f>-i/2;){if(h--,h<0)return!1;f-=r[h].dist(u),u=r[h]}f+=r[h].dist(r[h+1]),h++;const _=[];let g=0;for(;f<i/2;){const v=r[h],b=r[h+1];if(!b)return!1;let w=r[h-1].angleTo(v)-v.angleTo(b);for(w=Math.abs((w+3*Math.PI)%(2*Math.PI)-Math.PI),_.push({distance:f,angleDelta:w}),g+=w;f-_[0].distance>o;)g-=_.shift().angleDelta;if(g>a)return!1;h++,f+=v.dist(b)}return!0}function iv(r){let e=0;for(let i=0;i<r.length-1;i++)e+=r[i].dist(r[i+1]);return e}function rv(r,e,i){return r?.6*e*i:0}function nv(r,e){return Math.max(r?r.right-r.left:0,e?e.right-e.left:0)}function Dw(r,e,i,o,a,u){const h=rv(i,a,u),f=nv(i,o)*u;let _=0;const g=iv(r)/2;for(let v=0;v<r.length-1;v++){const b=r[v],w=r[v+1],I=b.dist(w);if(_+I>g){const A=(g-_)/I,P=Ft(b.x,w.x,A),D=Ft(b.y,w.y,A),L=new Fa(P,D,0,w.angleTo(b),v);return!h||tv(r,L,f,h,e)?L:void 0}_+=I}}function zw(r,e,i,o,a,u,h,f,_){const g=rv(o,u,h),v=nv(o,a),b=v*h,w=r[0].x===0||r[0].x===_||r[0].y===0||r[0].y===_;return e-b<e/4&&(e=b+e/4),ov(r,w?e/2*f%e:(v/2+2*u)*h*f%e,e,g,i,b,w,!1,_)}function ov(r,e,i,o,a,u,h,f,_){const g=u/2,v=iv(r);let b=0,w=e-i,I=[];for(let A=0;A<r.length-1;A++){const P=r[A],D=r[A+1],L=P.dist(D),V=D.angleTo(P);for(;w+i<b+L;){w+=i;const j=(w-b)/L,H=Ft(P.x,D.x,j),te=Ft(P.y,D.y,j);if(H>=0&&H<_&&te>=0&&te<_&&w-g>=0&&w+g<=v){const K=new Fa(H,te,0,V,A);o&&!tv(r,K,u,o,a)||I.push(K)}}b+=L}return f||I.length||h||(I=ov(r,b/2,i,o,a,u,h,!0,_)),I}function sv(r){let e=0,i=0;for(const h of r)e+=h.w*h.h,i=Math.max(i,h.w);r.sort(((h,f)=>f.h-h.h));const o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let a=0,u=0;for(const h of r)for(let f=o.length-1;f>=0;f--){const _=o[f];if(!(h.w>_.w||h.h>_.h)){if(h.x=_.x,h.y=_.y,u=Math.max(u,h.y+h.h),a=Math.max(a,h.x+h.w),h.w===_.w&&h.h===_.h){const g=o.pop();g&&f<o.length&&(o[f]=g)}else h.h===_.h?(_.x+=h.w,_.w-=h.w):h.w===_.w?(_.y+=h.h,_.h-=h.h):(o.push({x:_.x+h.w,y:_.y,w:_.w-h.w,h:h.h}),_.y+=h.h,_.h-=h.h);break}}return{w:a,h:u,fill:e/(a*u)||0}}pt(Fa,"Anchor");const Ic=1;class Gd{static getImagePositionScale(e,i,o){if(i&&e&&e.options&&e.options.transform){const a=e.options.transform;return{x:a.a,y:a.d}}return{x:o,y:o}}constructor(e,i,o,a){this.paddedRect=e;const{pixelRatio:u,version:h,stretchX:f,stretchY:_,content:g,sdf:v,usvg:b}=i;this.pixelRatio=u,this.stretchX=f,this.stretchY=_,this.content=g,this.version=h,this.padding=o,this.sdf=v,this.usvg=b,this.scale=Gd.getImagePositionScale(a,b,u)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function $_(r,e,i){const o=Ls.parse(r),a=(function(u,h,f=[1,1]){return{x:0,y:0,w:(u.data?u.data.width:u.width*f[0])+2*h,h:(u.data?u.data.height:u.height*f[1])+2*h}})(e,i,[o.options.transform.a,o.options.transform.d]);return{bin:a,imagePosition:new Gd(a,e,i,o),imageVariant:o}}class av{constructor(e,i,o){const a=new Map,u=new Map;this.haveRenderCallbacks=[];const h=[];this.addImages(e,a,Ic,h),this.addImages(i,u,2,h);const{w:f,h:_}=sv(h),g=new Hn({width:f||1,height:_||1});for(const[v,b]of e.entries()){const w=a.get(v).paddedRect;Hn.copy(b.data,g,{x:0,y:0},{x:w.x+Ic,y:w.y+Ic},b.data,null,b.sdf)}for(const[v,b]of i.entries()){const w=u.get(v),I=w.paddedRect;let A=w.padding;const P=I.x+A,D=I.y+A,L=b.data.width,V=b.data.height;A=A>1?A-1:A,Hn.copy(b.data,g,{x:0,y:0},{x:P,y:D},b.data,o),Hn.copy(b.data,g,{x:0,y:V-A},{x:P,y:D-A},{width:L,height:A},o),Hn.copy(b.data,g,{x:0,y:0},{x:P,y:D+V},{width:L,height:A},o),Hn.copy(b.data,g,{x:L-A,y:0},{x:P-A,y:D},{width:A,height:V},o),Hn.copy(b.data,g,{x:0,y:0},{x:P+L,y:D},{width:A,height:V},o),Hn.copy(b.data,g,{x:L-A,y:V-A},{x:P-A,y:D-A},{width:A,height:A},o),Hn.copy(b.data,g,{x:0,y:V-A},{x:P+L,y:D-A},{width:A,height:A},o),Hn.copy(b.data,g,{x:0,y:0},{x:P+L,y:D+V},{width:A,height:A},o),Hn.copy(b.data,g,{x:L-A,y:0},{x:P-A,y:D+V},{width:A,height:A},o)}this.lut=o,this.image=g,this.iconPositions=a,this.patternPositions=u}addImages(e,i,o,a){for(const[u,h]of e.entries()){const{bin:f,imagePosition:_,imageVariant:g}=$_(u,h,o);i.set(u,_),a.push(f),h.hasRenderCallback&&this.haveRenderCallbacks.push(g.id)}}patchUpdatedImages(e,i,o){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((a=>e.hasImage(a,o))),e.dispatchRenderCallbacks(this.haveRenderCallbacks,o);for(const a of e.getUpdatedImages(o)){for(const u of this.iconPositions.keys()){const h=Ls.parse(u);if(hn.isEqual(h.id,a)){const f=e.getImage(a,o);this.patchUpdatedImage(this.iconPositions.get(u),f,i,null)}}for(const u of this.patternPositions.keys()){const h=Ls.parse(u);if(hn.isEqual(h.id,a)){const f=e.getImage(a,o);this.patchUpdatedImage(this.patternPositions.get(u),f,i,this.lut)}}}}patchUpdatedImage(e,i,o,a=null){if(!e||!i||e.version===i.version)return;e.version=i.version;const[u,h]=e.tl,f=e.sdf;if(this.lut||f){const _={width:i.data.width,height:i.data.height},g=new Hn(_);Hn.copy(i.data,g,{x:0,y:0},{x:0,y:0},_,a,f),o.update(g,{position:{x:u,y:h}})}else o.update(i.data,{position:{x:u,y:h}})}}pt(Gd,"ImagePosition"),pt(av,"ImageAtlas");const Hd=1e20;function lv(r,e,i,o,a,u,h,f,_){for(let g=e;g<e+o;g++)cv(r,i*u+g,u,a,h,f,_);for(let g=i;g<i+a;g++)cv(r,g*u+e,1,o,h,f,_)}function cv(r,e,i,o,a,u,h){u[0]=0,h[0]=-Hd,h[1]=Hd,a[0]=r[e];for(let f=1,_=0,g=0;f<o;f++){a[f]=r[e+f*i];const v=f*f;do{const b=u[_];g=(a[f]-a[b]+v-b*b)/(f-b)/2}while(g<=h[_]&&--_>-1);_++,u[_]=f,h[_]=g,h[_+1]=Hd}for(let f=0,_=0;f<o;f++){for(;h[_+1]<f;)_++;const g=u[_],v=f-g;r[e+f*i]=a[g]+v*v}}const $s=2,Z_={none:0,ideographs:1,all:2};class $u{constructor(e,i,o){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=o,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,i){const o=[],a=this.url||fr.GLYPHS_URL;for(const u in e)for(const h of e[u])o.push({stack:u,id:h});se(o,(({stack:u,id:h},f)=>{let _=this.entries[u];_||(_=this.entries[u]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let g=_.glyphs[h];if(g!==void 0)return void f(null,{stack:u,id:h,glyph:g});if(g=this._tinySDF(_,u,h),g)return _.glyphs[h]=g,void f(null,{stack:u,id:h,glyph:g});const v=Math.floor(h/256);if(256*v>65535)return Mt("glyphs > 65535 not supported"),void f(null,{stack:u,id:h,glyph:g});if(_.ranges[v])return void f(null,{stack:u,id:h,glyph:g});let b=_.requests[v];b||(b=_.requests[v]=[],$u.loadGlyphRange(u,v,a,this.requestManager,((w,I)=>{if(I){_.ascender=I.ascender,_.descender=I.descender;for(const A in I.glyphs)this._doesCharSupportLocalGlyph(+A)||(_.glyphs[+A]=I.glyphs[+A]);_.ranges[v]=!0}for(const A of b)A(w,I);delete _.requests[v]}))),b.push(((w,I)=>{w?f(w):I&&f(null,{stack:u,id:h,glyph:I.glyphs[h]||null})}))}),((u,h)=>{if(u)i(u);else if(h){const f={};for(const{stack:_,id:g,glyph:v}of h)f[_]===void 0&&(f[_]={}),f[_].glyphs===void 0&&(f[_].glyphs={}),f[_].glyphs[g]=v&&{id:v.id,bitmap:v.bitmap.clone(),metrics:v.metrics},f[_].ascender=this.entries[_].ascender,f[_].descender=this.entries[_].descender;i(null,f)}}))}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Z_.none&&(this.localGlyphMode===Z_.all?!!this.localFontFamily:!!this.localFontFamily&&(Ct["CJK Unified Ideographs"](e)||Ct["Hangul Syllables"](e)||Ct.Hiragana(e)||Ct.Katakana(e)||Ct["CJK Symbols and Punctuation"](e)||Ct["CJK Unified Ideographs Extension A"](e)||Ct["CJK Unified Ideographs Extension B"](e)||Ct.Osage(e)))}_tinySDF(e,i,o){const a=this.localFontFamily;if(!a||!this._doesCharSupportLocalGlyph(o))return;let u=e.tinySDF;if(!u){let P="400";/bold/i.test(i)?P="900":/medium/i.test(i)?P="500":/light/i.test(i)&&(P="200"),u=e.tinySDF=new $u.TinySDF({fontFamily:a,fontWeight:P,fontSize:24*$s,buffer:3*$s,radius:8*$s}),u.fontWeight=P}if(this.localGlyphs[u.fontWeight][o])return this.localGlyphs[u.fontWeight][o];const h=String.fromCodePoint(o),{data:f,width:_,height:g,glyphWidth:v,glyphHeight:b,glyphLeft:w,glyphTop:I,glyphAdvance:A}=u.draw(h);return this.localGlyphs[u.fontWeight][o]={id:o,bitmap:new Tl({width:_,height:g},f),metrics:{width:v/$s,height:b/$s,left:w/$s,top:I/$s-27,advance:A/$s,localGlyph:!0}}}}$u.loadGlyphRange=function(r,e,i,o,a){const u=256*e,h=u+255,f=o.transformRequest(o.normalizeGlyphsURL(i).replace("{fontstack}",r).replace("{range}","".concat(u,"-").concat(h)),_a.Glyphs);Na(f,((_,g)=>{if(_)a(_);else if(g){const v={},b=(function(w){return new Bp(w).readFields(Aw,{})})(g);for(const w of b.glyphs)v[w.id]=w;a(null,{glyphs:v,ascender:b.ascender,descender:b.descender})}}))},$u.TinySDF=class{constructor({fontSize:r=24,buffer:e=3,radius:i=8,cutoff:o=.25,fontFamily:a="sans-serif",fontWeight:u="normal",fontStyle:h="normal",lang:f=null}={}){this.buffer=e,this.cutoff=o,this.radius=i,this.lang=f;const _=this.size=r+4*e,g=this._createCanvas(_),v=this.ctx=g.getContext("2d",{willReadFrequently:!0});v.font="".concat(h," ").concat(u," ").concat(r,"px ").concat(a),v.textBaseline="alphabetic",v.textAlign="left",v.fillStyle="black",this.gridOuter=new Float64Array(_*_),this.gridInner=new Float64Array(_*_),this.f=new Float64Array(_),this.z=new Float64Array(_+1),this.v=new Uint16Array(_)}_createCanvas(r){const e=document.createElement("canvas");return e.width=e.height=r,e}draw(r){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:o,actualBoundingBoxLeft:a,actualBoundingBoxRight:u}=this.ctx.measureText(r),h=Math.ceil(i),f=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(u-a))),_=Math.min(this.size-this.buffer,h+Math.ceil(o)),g=f+2*this.buffer,v=_+2*this.buffer,b=Math.max(g*v,0),w=new Uint8ClampedArray(b),I={data:w,width:g,height:v,glyphWidth:f,glyphHeight:_,glyphTop:h,glyphLeft:0,glyphAdvance:e};if(f===0||_===0)return I;const{ctx:A,buffer:P,gridInner:D,gridOuter:L}=this;this.lang&&(A.lang=this.lang),A.clearRect(P,P,f,_),A.fillText(r,P,P+h);const V=A.getImageData(P,P,f,_);L.fill(Hd,0,b),D.fill(0,0,b);for(let j=0;j<_;j++)for(let H=0;H<f;H++){const te=V.data[4*(j*f+H)+3]/255;if(te===0)continue;const K=(j+P)*g+H+P;if(te===1)L[K]=0,D[K]=Hd;else{const oe=.5-te;L[K]=oe>0?oe*oe:0,D[K]=oe<0?oe*oe:0}}lv(L,0,0,g,v,g,this.f,this.v,this.z),lv(D,P,P,f,_,g,this.f,this.v,this.z);for(let j=0;j<b;j++){const H=Math.sqrt(L[j])-Math.sqrt(D[j]);w[j]=Math.round(255-255*(H/this.radius+this.cutoff))}return I}};const ha=Ic;function uv(r,e){return r+e[1]-e[0]}function W_(r,e,i,o,a=1){const u=[],h=r.imagePrimary,f=h.pixelRatio,_=h.paddedRect.w-2*ha,g=h.paddedRect.h-2*ha,v=(r.right-r.left)*a,b=(r.bottom-r.top)*a,w=h.stretchX||[[0,_]],I=h.stretchY||[[0,g]],A=w.reduce(uv,0),P=I.reduce(uv,0),D=_-A,L=g-P;let V=0,j=A,H=0,te=P,K=0,oe=D,le=0,ue=L;if(h.content&&o){const ye=h.content;V=Up(w,0,ye[0]),H=Up(I,0,ye[1]),j=Up(w,ye[0],ye[2]),te=Up(I,ye[1],ye[3]),K=ye[0]-V,le=ye[1]-H,oe=ye[2]-ye[0]-j,ue=ye[3]-ye[1]-te}const Me=(ye,Ce,Oe,Ne)=>{const Ye=jp(ye.stretch-V,j,v,r.left*a),He=Gp(ye.fixed-K,oe,ye.stretch,A),Fe=jp(Ce.stretch-H,te,b,r.top*a),Ge=Gp(Ce.fixed-le,ue,Ce.stretch,P),Ie=jp(Oe.stretch-V,j,v,r.left*a),Se=Gp(Oe.fixed-K,oe,Oe.stretch,A),Ue=jp(Ne.stretch-H,te,b,r.top*a),Ze=Gp(Ne.fixed-le,ue,Ne.stretch,P),ke=new Be(Ye,Fe),ft=new Be(Ie,Fe),_t=new Be(Ie,Ue),ut=new Be(Ye,Ue),ot=new Be(He/f,Ge/f),jt=new Be(Se/f,Ze/f),at=e*Math.PI/180;if(at){const Pi=Math.sin(at),Ri=Math.cos(at),Tr=[Ri,-Pi,Pi,Ri];ke._matMult(Tr),ft._matMult(Tr),ut._matMult(Tr),_t._matMult(Tr)}const Et=ye.stretch+ye.fixed,Ht=Oe.stretch+Oe.fixed,oi=Ce.stretch+Ce.fixed,yi=Ne.stretch+Ne.fixed,$t=r.imageSecondary;return{tl:ke,tr:ft,bl:ut,br:_t,texPrimary:{x:h.paddedRect.x+ha+Et,y:h.paddedRect.y+ha+oi,w:Ht-Et,h:yi-oi},texSecondary:$t?{x:$t.paddedRect.x+ha+Et,y:$t.paddedRect.y+ha+oi,w:Ht-Et,h:yi-oi}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:ot,pixelOffsetBR:jt,minFontScaleX:oe/f/v,minFontScaleY:ue/f/b,isSDF:i}};if(o&&(h.stretchX||h.stretchY)){const ye=hv(w,D,A),Ce=hv(I,L,P);for(let Oe=0;Oe<ye.length-1;Oe++){const Ne=ye[Oe],Ye=ye[Oe+1];for(let He=0;He<Ce.length-1;He++)u.push(Me(Ne,Ce[He],Ye,Ce[He+1]))}}else u.push(Me({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:_+1},{fixed:0,stretch:g+1}));return u}function Lw(r,e){const i=r.stretchY||[[0,r.paddedRect.h-2*ha]];return e&&(r.stretchX||r.stretchY)?dv(r.stretchX||[[0,r.paddedRect.w-2*ha]])*dv(i):1}function Up(r,e,i){let o=0;for(const a of r)o+=Math.max(e,Math.min(i,a[1]))-Math.max(e,Math.min(i,a[0]));return o}function hv(r,e,i){const o=[{fixed:-ha,stretch:0}];for(const[a,u]of r){const h=o[o.length-1];o.push({fixed:a-h.stretch,stretch:h.stretch}),o.push({fixed:a-h.stretch,stretch:h.stretch+(u-a)})}return o.push({fixed:e+ha,stretch:i}),o}function dv(r){return 2*r.length+1}function jp(r,e,i,o){return r/e*i+o}function Gp(r,e,i,o){return r-e*i/o}function Ow(r,e,i,o){const a=e+r.positionedLines[o].lineOffset;return o===0?i+a/2:i+(a+(e+r.positionedLines[o-1].lineOffset))/2}function Fw(r,e=1,i=!1){let o=1/0,a=1/0,u=-1/0,h=-1/0;const f=r[0];for(let I=0;I<f.length;I++){const A=f[I];(!I||A.x<o)&&(o=A.x),(!I||A.y<a)&&(a=A.y),(!I||A.x>u)&&(u=A.x),(!I||A.y>h)&&(h=A.y)}const _=Math.min(u-o,h-a);let g=_/2;const v=new jc([],kw);if(_===0)return new Be(o,a);for(let I=o;I<u;I+=_)for(let A=a;A<h;A+=_)v.push(new Zu(I+g,A+g,g,r));let b=(function(I){let A=0,P=0,D=0;const L=I[0];for(let V=0,j=L.length,H=j-1;V<j;H=V++){const te=L[V],K=L[H],oe=te.x*K.y-K.x*te.y;P+=(te.x+K.x)*oe,D+=(te.y+K.y)*oe,A+=3*oe}return new Zu(P/A,D/A,0,I)})(r),w=v.length;for(;v.length;){const I=v.pop();(I.d>b.d||!b.d)&&(b=I,i&&console.log("found best %d after %d probes",Math.round(1e4*I.d)/1e4,w)),I.max-b.d<=e||(g=I.h/2,v.push(new Zu(I.p.x-g,I.p.y-g,g,r)),v.push(new Zu(I.p.x+g,I.p.y-g,g,r)),v.push(new Zu(I.p.x-g,I.p.y+g,g,r)),v.push(new Zu(I.p.x+g,I.p.y+g,g,r)),w+=4)}return i&&(console.log("num probes: ".concat(w)),console.log("best distance: ".concat(b.d))),b.p}function kw(r,e){return e.max-r.max}class Zu{constructor(e,i,o,a){this.p=new Be(e,i),this.h=o,this.d=(function(u,h){let f=!1,_=1/0;for(let g=0;g<h.length;g++){const v=h[g];for(let b=0,w=v.length,I=w-1;b<w;I=b++){const A=v[b],P=v[I];A.y>u.y!=P.y>u.y&&u.x<(P.x-A.x)*(u.y-A.y)/(P.y-A.y)+A.x&&(f=!f),_=Math.min(_,Bo(u,A,P))}}return(f?1:-1)*Math.sqrt(_)})(this.p,a),this.max=this.d+this.h*Math.SQRT2}}const Bw=Object.keys,X_=Number.POSITIVE_INFINITY,Nw=Math.sqrt(2);function Hp(r,e,i,o){const a=r.collisionPadding||[0,0,0,0],u={top:r.top-a[1],bottom:r.bottom+a[3],left:r.left-a[0],right:r.right+a[2],scaled:!1};return o!==void 0&&(function(h,f){h.top*=f,h.bottom*=f,h.left*=f,h.right*=f,h.scaled=!0})(u,o),i&&(function(h,f){if(!f)return;const _=ii(f),g=new Be(h.left,h.top),v=new Be(h.right,h.top),b=new Be(h.left,h.bottom),w=new Be(h.right,h.bottom);g._rotateAround(_,new Be(0,0)),v._rotateAround(_,new Be(0,0)),b._rotateAround(_,new Be(0,0)),w._rotateAround(_,new Be(0,0)),h.left=Math.min(g.x,v.x,b.x,w.x),h.right=Math.max(g.x,v.x,b.x,w.x),h.top=Math.min(g.y,v.y,b.y,w.y),h.bottom=Math.max(g.y,v.y,b.y,w.y)})(u,i),e?{top:Math.min(e.top,u.top),bottom:Math.max(e.bottom,u.bottom),left:Math.min(e.left,u.left),right:Math.max(e.right,u.right),scaled:e.scaled||u.scaled}:u}function fv(r,[e,i]){let o=0,a=0;if(i===X_){e<0&&(e=0);const u=e/Nw;switch(r){case"top-right":case"top-left":a=u-7;break;case"bottom-right":case"bottom-left":a=7-u;break;case"bottom":a=7-e;break;case"top":a=e-7}switch(r){case"top-right":case"bottom-right":o=-u;break;case"top-left":case"bottom-left":o=u;break;case"left":o=e;break;case"right":o=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),r){case"top-right":case"top-left":case"top":a=i-7;break;case"bottom-right":case"bottom-left":case"bottom":a=7-i}switch(r){case"top-right":case"bottom-right":case"right":o=-e;break;case"top-left":case"bottom-left":case"left":o=e}}return[o,a]}function Vw(r,e,i,o,a,u,h,f,_,g,v){const b=r.layers[0],w=b.appearances;if(w.length===0)return{iconBBox:null,iconVerticalBBox:null};let I=null,A=null;const P=o.get("icon-rotate").evaluate(a,{},u);e&&(I=Hp(e,I,P,h),i)&&(A=Hp(i,A,P+90,h));const[D,L]=o.get("icon-size-scale-range"),V=B(1,D,L);for(const j of w){const H=j.getUnevaluatedProperties(),te=H._values["icon-image"].value!==void 0,K=H._values["icon-size"].value!==void 0,oe=H._values["icon-offset"].value!==void 0,le=H._values["icon-rotate"].value!==void 0;if(te||K||oe||le){const ue=oe?b.getAppearanceValueAndResolveTokens(j,"icon-offset",a,u,[]):null,Me=ue&&Array.isArray(ue)?ue:f,ye=le?b.getAppearanceValueAndResolveTokens(j,"icon-rotate",a,u,[]):null,Ce=typeof ye=="number"?ye:P,Oe=K?b.getAppearanceValueAndResolveTokens(j,"icon-size",a,u,[]):null,Ne=typeof Oe=="number"?Oe*_.iconScaleFactor:h;let Ye=null,He=null,Fe=null;if(te){const Ge=b.getAppearanceValueAndResolveTokens(j,"icon-image",a,u,[]);if(Ge){const Ie=r.getResolvedImageFromTokens(Ge),Se=H._values["icon-size"],Ue=qd(Ie,Hu(r.zoom,Se,r.worldview),Se,u,r.zoom,a,r.pixelRatio,V,r.worldview);Fe=g.get(Ue.iconPrimary.toString())}}else e&&(Fe=e.imagePrimary);Fe&&(Ye=Vp(Fe,null,Me,v),r.allowVerticalPlacement&&(He=Vp(Fe,null,Me,v))),Ye&&(I=Hp(Ye,I,Ce,Ne)),He&&(A=Hp(He,A,Ce+90,Ne))}}return{iconBBox:I,iconVerticalBBox:A}}function qp(r,e,i,o,a,u,h,f,_){if(!e||!e.usvg)return;const g=ev(o),v=ev(a),b=u!=="both"&&u!=="width"||!Jx(o)?1:v.width/g.width,w=u!=="both"&&u!=="height"||!Qx(o)?1:v.height/g.height;i.scaleSelf(b,w);const I=i.toString();h.set(I,i),f.set(I,e);const{imagePosition:A}=$_(I,e,Ic);_.set(I,A)}function pv(r,e,i,o,a,u,h,f,_){if(!r)return;const g=(function(v,b,w,I,A,P){if(v.kind==="camera")return v.maxSize;if(v.kind==="composite"){const D=b.possiblyEvaluate(new lr(v.maxZoom,{worldview:P}),w).evaluate(A,{},w),L=b.possiblyEvaluate(new lr(v.minZoom,{worldview:P}),w).evaluate(A,{},w);return Math.max(D,L)}return b.possiblyEvaluate(new lr(I,{worldview:P})).evaluate(A,{},w)})(e,i,o,a,u,_);return r.scaleSelf(g*f*h)}function qd(r,e,i,o,a,u,h,f,_){return{iconPrimary:pv(r.getPrimary(),e,i,o,a,u,h,f,_),iconSecondary:pv(r.getSecondary(),e,i,o,a,u,h,f,_)}}function Uw(r,e,i){if(!e)return;const o=i.get(r.toString()),a=i.get(e.toString());o&&a&&(o.paddedRect.w===a.paddedRect.w&&o.paddedRect.h===a.paddedRect.h||Mt("Mismatch in icon variant sizes: ".concat(r.toString()," and ").concat(e.toString())),o.usvg!==a.usvg&&Mt("Mismatch in icon variant image types: ".concat(r.id," and ").concat(e.id)))}function mv(r,e,i,o){if(!r)return;const a=e.get(i.toString());if(r.imagePrimary=a,o){const u=e.get(o.toString());r.imageSecondary=u}}function jw(r,e){for(const i in r.horizontal)_v(r.horizontal[i],e);_v(r.vertical,e)}function _v(r,e){if(r){for(const i of r.positionedLines)for(const o of i.positionedGlyphs)if(o.image!==null){const a=o.image.toString();o.rect=e.get(a).paddedRect}}}function Y_(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Gw(r,e,i,o,a,u,h,f,_){const g=K_(u.horizontal)||u.vertical,v=i.get("icon-text-fit-padding").evaluate(o,{},a);let b,w=e;return e&&_!=="none"&&(r.allowVerticalPlacement&&u.vertical&&(b=H_(e,u.vertical,_,v,f,h)),g&&(w=H_(e,g,_,v,f,h))),{defaultShapedIcon:w,verticallyShapedIcon:b}}function Hw(r,e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D,L,V,j,H,te){let K=h.textMaxSize.evaluate(e,{},w);K===void 0?K=f*h.textScaleFactor:K*=h.textScaleFactor;const oe=r.layers[0].layout,le=zn,ue=f*h.textScaleFactor/le,Me=K_(i.horizontal)||i.vertical;if(D!=="none"&&r.appearanceFeatureData&&e.index<r.appearanceFeatureData.length){const ke=r.appearanceFeatureData[e.index];ke&&(ke.textShaping=Me,ke.iconTextFitPadding=oe.get("icon-text-fit-padding").evaluate(e,{},w),ke.fontScale=ue)}const ye=I.name==="globe",Ce=r.tilePixelRatio*K/le,Oe=(Ie=r.overscaling,r.zoom>18&&Ie>2&&(Ie>>=1),Math.max(Je/(512*Ie),1)*oe.get("symbol-spacing")),Ne=oe.get("text-padding")*r.tilePixelRatio,Ye=oe.get("icon-padding")*r.tilePixelRatio,He=ii(oe.get("text-max-angle")),Fe=oe.get("icon-rotation-alignment")==="map"&&j!=="point",Ge=Oe/2;var Ie;r.hasAnyIconTextFit===!1&&D!=="none"&&(r.hasAnyIconTextFit=!0);const Se=e.properties?+e.properties[ct]:null,Ue=Se&&r.elevationFeatureIdToIndex?r.elevationFeatureIdToIndex.get(Se):65535,Ze=(ke,ft,_t)=>{if(ft.x<0||ft.x>=Je||ft.y<0||ft.y>=Je)return;let ut=null;if(ye){const{x:ot,y:jt,z:at}=I.projectTilePoint(ft.x,ft.y,_t);ut={anchor:new Fa(ot,jt,at,0,void 0),up:I.upVector(_t,ft.x,ft.y)}}(function(ot,jt,at,Et,Ht,oi,yi,$t,Pi,Ri,Tr,J,W,Re,it,De,st,wt,vt,Zt,zt,yt,Ai,Ji,Ot,_i,Qi,ji,Lr,mr,or){const Zi=ot.addToLineVertexArray(jt,Et);let Di,Wt,zi,sr,Lt,xi,_r,Vr=0,Zr=0,ln=0,gr=0,rn=-1,Ao=-1;const nn={};let Ho=Ul("");const qn=at?at.anchor:jt,ys=ji!=="none";let Mo=0,qo=0;if(Pi._unevaluatedLayout.getValue("text-radial-offset")===void 0){const Ln=Pi.layout.get("text-offset").evaluate(zt,{},Ot);Mo=Ln[0]*zn,qo=Ln[1]*zn}else Mo=Pi.layout.get("text-radial-offset").evaluate(zt,{},Ot)*zn,qo=X_;if(ot.allowVerticalPlacement&&Ht.vertical){const Ln=Ht.vertical;if(it)xi=J_(Ln),$t&&(_r=J_($t));else{const so=Pi.layout.get("text-rotate").evaluate(zt,{},Ot)+90;zi=$p(Ri,qn,jt,Tr,J,W,Ln,Re,so,De),$t&&(sr=$p(Ri,qn,jt,Tr,J,W,$t,wt,so,null,or))}}if(oi){const Ln=ot.iconSizeData,so=Pi.layout.get("icon-rotate").evaluate(zt,{},Ot),da=W_(oi,so,Ai,ys,yt.iconScaleFactor),Ml=$t?W_($t,so,Ai,ys,yt.iconScaleFactor):void 0;Wt=$p(Ri,qn,jt,Tr,J,W,oi,wt,so,null,mr);const eh=(function(fa,cm,th,r2,O0,F0,n2,o2){const k0=fa.layers[0],B0=k0.appearances;let ih=cm.length;if(th&&(ih=Math.max(ih,th.length)),B0.length===0)return ih;const[s2,a2]=r2.get("icon-size-scale-range"),l2=B(1,s2,a2);for(const N0 of B0){const V0=N0.getUnevaluatedProperties();if(V0._values["icon-image"].value!==void 0){const U0=k0.getAppearanceValueAndResolveTokens(N0,"icon-image",O0,F0,[]);if(U0){const j0=fa.getResolvedImageFromTokens(U0);if(j0){const G0=V0._values["icon-size"],c2=qd(j0,Hu(fa.zoom,G0,fa.worldview),G0,F0,fa.zoom,O0,fa.pixelRatio,l2,fa.worldview),u2=n2.get(c2.iconPrimary.toString());ih=Math.max(ih,Lw(u2,o2))}}}}return ih})(ot,da,Ml,Pi.layout,zt,Ot,ot.iconAtlasPositions,ys);Vr=4*eh;let Cl=null;Ln.kind==="source"?(Cl=[qs*Pi.layout.get("icon-size").evaluate(zt,{},Ot)*yt.iconScaleFactor],Cl[0]>ka&&Mt("".concat(ot.layerIds[0],': Value for "icon-size" is >= ').concat($d,'. Reduce your "icon-size".'))):Ln.kind==="composite"&&(Cl=[qs*yt.compositeIconSizes[0].evaluate(zt,{},Ot)*yt.iconScaleFactor,qs*yt.compositeIconSizes[1].evaluate(zt,{},Ot)*yt.iconScaleFactor],(Cl[0]>ka||Cl[1]>ka)&&Mt("".concat(ot.layerIds[0],': Value for "icon-size" is >= ').concat($d,'. Reduce your "icon-size".'))),ot.addSymbols(ot.icon,da,Cl,Zt,vt,zt,void 0,at,jt,Zi.lineStartIndex,Zi.lineLength,-1,Ji,Ot,_i,Qi,ot.symbolInstances.length,eh),rn=ot.icon.placedSymbolArray.length-1,Ml&&(Zr=4*eh,ot.addSymbols(ot.icon,Ml,Cl,Zt,vt,zt,Go.vertical,at,jt,Zi.lineStartIndex,Zi.lineLength,-1,Ji,Ot,_i,Qi,ot.symbolInstances.length,eh),Ao=ot.icon.placedSymbolArray.length-1)}for(const Ln in Ht.horizontal){const so=Ln,da=Ht.horizontal[so];Di||(Ho=Ul(da.text),it?Lt=J_(da):Di=$p(Ri,qn,jt,Tr,J,W,da,Re,Pi.layout.get("text-rotate").evaluate(zt,{},Ot),De));const Ml=da.positionedLines.length===1;if(ln+=gv(ot,at,jt,da,yi,Pi,it,zt,De,Zi,Ht.vertical?Go.horizontal:Go.horizontalOnly,Ml?Bw(Ht.horizontal):[so],nn,rn,yt,Ji,Ot,ot.symbolInstances.length,_i),Ml)break}Ht.vertical&&(gr+=gv(ot,at,jt,Ht.vertical,yi,Pi,it,zt,De,Zi,Go.vertical,["vertical"],nn,Ao,yt,Ji,Ot,ot.symbolInstances.length,_i));let $n=-1;const $o=(Ln,so)=>Ln?Math.max(Ln,so):so;$n=$o(Lt,$n),$n=$o(xi,$n),$n=$o(_r,$n);const xs=$n>-1?1:0;ot.glyphOffsetArray.length>=65535&&Mt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),zt.sortKey!==void 0&&ot.addToSortKeyRanges(ot.symbolInstances.length,zt.sortKey),ot.symbolInstances.emplaceBack(jt.x,jt.y,qn.x,qn.y,qn.z,nn.right>=0?nn.right:-1,nn.center>=0?nn.center:-1,nn.left>=0?nn.left:-1,nn.vertical>=0?nn.vertical:-1,rn,Ao,Ho,Di!==void 0?Di:ot.collisionBoxArray.length,Di!==void 0?Di+1:ot.collisionBoxArray.length,zi!==void 0?zi:ot.collisionBoxArray.length,zi!==void 0?zi+1:ot.collisionBoxArray.length,Wt!==void 0?Wt:ot.collisionBoxArray.length,Wt!==void 0?Wt+1:ot.collisionBoxArray.length,sr||ot.collisionBoxArray.length,sr?sr+1:ot.collisionBoxArray.length,Tr,ln,gr,Vr,Zr,xs,0,Mo,qo,$n,0,ys?1:0,Lr)})(r,ft,ut,ke,i,o,u,a,r.layers[0],r.collisionBoxArray,e.index,e.sourceLayerIndex,r.index,Ne,V,g,0,Ye,Fe,L,e,h,v,b,w,A,P,D,Ue,H,te)};if(j==="line")for(const ke of Ap(e.geometry,0,0,Je,Je)){const ft=zw(ke,Oe,He,i.vertical||Me,o,le,Ce,r.overscaling,Je);for(const _t of ft)Me&&qw(r,Me.text,Ge,_t)||Ze(ke,_t,w)}else if(j==="line-center"){for(const ke of e.geometry)if(ke.length>1){const ft=Dw(ke,He,i.vertical||Me,o,le,Ce);ft&&Ze(ke,ft,w)}}else if(e.type==="Polygon")for(const ke of Md(e.geometry,0)){const ft=Fw(ke,16);Ze(ke[0],new Fa(ft.x,ft.y,0,0,void 0),w)}else if(e.type==="LineString")for(const ke of e.geometry)Ze(ke,new Fa(ke[0].x,ke[0].y,0,0,void 0),w);else if(e.type==="Point")for(const ke of e.geometry)for(const ft of ke)Ze([ft],new Fa(ft.x,ft.y,0,0,void 0),w)}const $d=255,ka=$d*qs;function gv(r,e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D,L,V){const j=(function(K,oe,le,ue,Me,ye,Ce,Oe){const Ne=[];if(oe.positionedLines.length===0)return Ne;const Ye=ue.layout.get("text-rotate").evaluate(ye,{})*Math.PI/180,He=(function(Ue){const Ze=Ue[0],ke=Ue[1],ft=Ze*ke;return ft>0?[Ze,-ke]:ft<0?[-Ze,ke]:Ze===0?[ke,Ze]:[ke,-Ze]})(le);let Fe=Math.abs(oe.top-oe.bottom);for(const Ue of oe.positionedLines)Fe-=Ue.lineOffset;const Ge=oe.positionedLines.length,Ie=Fe/Ge;let Se=oe.top-le[1];for(let Ue=0;Ue<Ge;++Ue){const Ze=oe.positionedLines[Ue];Se=Ow(oe,Ie,Se,Ue);for(const ke of Ze.positionedGlyphs){if(!ke.rect)continue;const ft=ke.rect||{};let _t=qx+1,ut=!0,ot=1,jt=0;if(ke.image){const vt=Ce.get(ke.image.toString());if(!vt)continue;if(vt.sdf){Mt("SDF images are not supported in formatted text and will be ignored.");continue}ut=!1,ot=vt.pixelRatio,_t=Ic/ot}const at=(Me||Oe)&&ke.vertical,Et=ke.metrics.advance*ke.scale/2,Ht=ke.metrics,oi=ke.rect;if(oi===null)continue;Oe&&oe.verticalizable&&(jt=ke.image?Et-ke.metrics.width*ke.scale/2:0);const yi=Me?[ke.x+Et,ke.y]:[0,0];let $t=[0,0],Pi=[0,0],Ri=!1;Me||(at?(Pi=[ke.x+Et+He[0],ke.y+He[1]-jt],Ri=!0):$t=[ke.x+Et+le[0],ke.y+le[1]-jt]);const Tr=oi.w*ke.scale/(ot*(ke.localGlyph?$s:1)),J=oi.h*ke.scale/(ot*(ke.localGlyph?$s:1));let W,Re,it,De;if(at){const vt=ke.y-Se,Zt=new Be(-Et,Et-vt),zt=-Math.PI/2,yt=new Be(...Pi);W=new Be(-Et+$t[0],$t[1]),W._rotateAround(zt,Zt)._add(yt),W.x+=-vt+Et,W.y-=(Ht.left-_t)*ke.scale;const Ai=ke.image?Ht.advance*ke.scale:zn*ke.scale,Ji=String.fromCodePoint(ke.glyph);_w(Ji)?W.x+=(1-_t)*ke.scale:gw(Ji)?W.x+=Ai-Ht.height*ke.scale+(-_t-1)*ke.scale:W.x+=ke.image||Ht.width+2*_t===oi.w&&Ht.height+2*_t===oi.h?(Ai-J)/2:(Ai-(Ht.height+2*_t)*ke.scale)/2,Re=new Be(W.x,W.y-Tr),it=new Be(W.x+J,W.y),De=new Be(W.x+J,W.y-Tr)}else{const vt=(Ht.left-_t)*ke.scale-Et+$t[0],Zt=(-Ht.top-_t)*ke.scale+$t[1],zt=vt+Tr,yt=Zt+J;W=new Be(vt,Zt),Re=new Be(zt,Zt),it=new Be(vt,yt),De=new Be(zt,yt)}if(Ye){let vt;vt=Me?new Be(0,0):Ri?new Be(He[0],He[1]):new Be(le[0],le[1]),W._rotateAround(Ye,vt),Re._rotateAround(Ye,vt),it._rotateAround(Ye,vt),De._rotateAround(Ye,vt)}const st=new Be(0,0),wt=new Be(0,0);Ne.push({tl:W,tr:Re,bl:it,br:De,texPrimary:ft,texSecondary:void 0,writingMode:oe.writingMode,glyphOffset:yi,sectionIndex:ke.sectionIndex,isSDF:ut,pixelOffsetTL:st,pixelOffsetBR:wt,minFontScaleX:0,minFontScaleY:0})}}return Ne})(0,o,_,u,h,f,a,r.allowVerticalPlacement),H=r.textSizeData;let te=null;H.kind==="source"?(te=[qs*u.layout.get("text-size").evaluate(f,{},D)*A.textScaleFactor],te[0]>ka&&Mt("".concat(r.layerIds[0],': Value for "text-size" is >= ').concat($d,'. Reduce your "text-size".'))):H.kind==="composite"&&(te=[qs*A.compositeTextSizes[0].evaluate(f,{},D)*A.textScaleFactor,qs*A.compositeTextSizes[1].evaluate(f,{},D)*A.textScaleFactor],(te[0]>ka||te[1]>ka)&&Mt("".concat(r.layerIds[0],': Value for "text-size" is >= ').concat($d,'. Reduce your "text-size".'))),r.addSymbols(r.text,j,te,_,h,f,v,e,i,g.lineStartIndex,g.lineLength,I,P,D,V,!1,L,j.length);for(const K of b)w[K]=r.text.placedSymbolArray.length-1;return 4*j.length}function K_(r){for(const e in r)return r[e];return null}function $p(r,e,i,o,a,u,h,f,_,g,v){let b,w,I,A;if(b=v?v.top:h.top,w=v?v.bottom:h.bottom,I=v?v.left:h.left,A=v?v.right:h.right,Kx(h)&&h.collisionPadding){const P=h.collisionPadding;I-=P[0],b-=P[1],A+=P[2],w+=P[3]}if(_){const P=new Be(I,b),D=new Be(A,b),L=new Be(I,w),V=new Be(A,w),j=ii(_);let H=new Be(0,0);g&&(H=new Be(g[0],g[1])),P._rotateAround(j,H),D._rotateAround(j,H),L._rotateAround(j,H),V._rotateAround(j,H),I=Math.min(P.x,D.x,L.x,V.x),A=Math.max(P.x,D.x,L.x,V.x),b=Math.min(P.y,D.y,L.y,V.y),w=Math.max(P.y,D.y,L.y,V.y)}return r.emplaceBack(e.x,e.y,e.z,i.x,i.y,I,b,A,w,f,o,a,u),r.length-1}function J_(r){Kx(r)&&r.collisionPadding&&(r.top-=r.collisionPadding[1],r.bottom+=r.collisionPadding[3]);const e=r.bottom-r.top;return e>0?Math.max(10,e):null}function qw(r,e,i,o){const a=r.compareText;if(e in a){const u=a[e];for(let h=u.length-1;h>=0;h--)if(o.dist(u[h])<i)return!0}else a[e]=[];return a[e].push(o),!1}function yv(r,e){const i=r.fovAboveCenter,o=r.elevation?r.elevation.getMinElevationBelowMSL()*e:0,a=(r._camera.position[2]*r.worldSize-o)/Math.cos(r._pitch),u=Math.sin(i)*a/Math.sin(Math.max(Math.PI/2-r._pitch-i,.01));let h=Math.sin(r._pitch)*u+a;const f=a*(1/r._horizonShift);if(!r.elevation||r.elevation.exaggeration()===0){let _=Math.max(r.zoom-17,0);r.isOrthographic&&(_/=10),h*=1+_}return Math.min(1.01*h,f)}function Zd(r,e){if(!e.isReprojectedInTileSpace)return{scale:1<<r.z,x:r.x,y:r.y,x2:r.x+1,y2:r.y+1,projection:e};const i=Math.pow(2,-r.z),o=r.x*i,a=(r.x+1)*i,u=r.y*i,h=(r.y+1)*i,f=$(o),_=$(a),g=G(u),v=G(h),b=e.project(f,g),w=e.project(_,g),I=e.project(_,v),A=e.project(f,v);let P=Math.min(b.x,w.x,I.x,A.x),D=Math.min(b.y,w.y,I.y,A.y),L=Math.max(b.x,w.x,I.x,A.x),V=Math.max(b.y,w.y,I.y,A.y);const j=i/16;function H(K,oe,le,ue,Me,ye){const Ce=(le+Me)/2,Oe=(ue+ye)/2,Ne=e.project($(Ce),G(Oe)),Ye=Math.max(0,P-Ne.x,D-Ne.y,Ne.x-L,Ne.y-V);P=Math.min(P,Ne.x),L=Math.max(L,Ne.x),D=Math.min(D,Ne.y),V=Math.max(V,Ne.y),Ye>j&&(H(K,Ne,le,ue,Ce,Oe),H(Ne,oe,Ce,Oe,Me,ye))}H(b,w,o,u,a,u),H(w,I,a,u,a,h),H(I,A,a,h,o,h),H(A,b,o,h,o,u),P-=j,D-=j,L+=j,V+=j;const te=1/Math.max(L-P,V-D);return{scale:te,x:P*te,y:D*te,x2:L*te,y2:V*te,projection:e}}function xv(r,{x:e,y:i},o=0){return new Be(((e-o)*r.scale-r.x)*Je,(i*r.scale-r.y)*Je)}const $w=Dt(new Float32Array(16));class Il{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new M(0,0)}projectTilePoint(e,i,o){return{x:e,y:i,z:0}}locationPoint(e,i,o,a=!0){return e._coordinatePoint(e.locationCoordinate(i,o),a)}pixelsPerMeter(e,i){return U(1,e)*i}pixelSpaceConversion(e,i,o){return 1}farthestPixelDistance(e){return yv(e,e.pixelsPerMeter)}pointCoordinate(e,i,o,a){const u=e.horizonLineFromTop(!1),h=new Be(i,Math.max(u,o));return e.rayIntersectionCoordinate(e.pointRayIntersection(h,a))}pointCoordinate3D(e,i,o){const a=new Be(i,o);if(e.elevation)return e.elevation.pointCoordinate(a);{const u=this.pointCoordinate(e,a.x,a.y,0);return[u.x,u.y,u.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);const o=e.horizonLineFromTop();return i.y<o}createInversionMatrix(e,i){return $w}createTileMatrix(e,i,o){let a,u,h;const f=o.canonical,_=Dt(new Float64Array(16));if(this.isReprojectedInTileSpace){const g=Zd(f,this);a=1,u=g.x+o.wrap*g.scale,h=g.y,Ci(_,_,[a/g.scale,a/g.scale,e.pixelsPerMeter/i])}else a=i/e.zoomScale(f.z),u=(f.x+Math.pow(2,f.z)*o.wrap)*a,h=f.y*a;return wi(_,_,[u,h,0]),Ci(_,_,[a/Je,a/Je,1]),_}upVector(e,i,o){return[0,0,1]}upVectorScale(e,i,o){return{metersToTile:1}}}class Zw extends Il{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,o]=this.parallels=e.parallels||[29.5,45.5],a=Math.sin(ii(i));this.n=(a+Math.sin(ii(o)))/2,this.c=1+a*(2*this.n-a),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:o,c:a,r0:u}=this,h=ii(e-this.center[0]),f=ii(i),_=Math.sqrt(a-2*o*Math.sin(f))/o;return{x:_*Math.sin(h*o),y:_*Math.cos(h*o)-u,z:0}}unproject(e,i){const{n:o,c:a,r0:u}=this,h=u+i;let f=Math.atan2(e,Math.abs(h))*Math.sign(h);h*o<0&&(f-=Math.PI*Math.sign(e)*Math.sign(h));const _=ii(this.center[0])*o;f=ae(f,-Math.PI-_,Math.PI-_);const g=B(Jr(f/o)+this.center[0],-180,180),v=Math.asin(B((a-(e*e+h*h)*o*o)/(2*o),-1,1)),b=B(Jr(v),-Z,Z);return new M(g,b)}}const Wd=1.340264,Xd=-.081106,Yd=893e-6,Kd=.003796,Zp=Math.sqrt(3)/2;class Ww extends Il{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const o=Math.asin(Zp*Math.sin(i)),a=o*o,u=a*a*a;return{x:.5*(e*Math.cos(o)/(Zp*(Wd+3*Xd*a+u*(7*Yd+9*Kd*a)))/Math.PI+.5),y:1-.5*(o*(Wd+Xd*a+u*(Yd+Kd*a))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,a=o*o,u=a*a*a;for(let v,b,w,I=0;I<12&&(b=o*(Wd+Xd*a+u*(Yd+Kd*a))-i,w=Wd+3*Xd*a+u*(7*Yd+9*Kd*a),v=b/w,o=B(o-v,-Math.PI/3,Math.PI/3),a=o*o,u=a*a*a,!(Math.abs(v)<1e-12));++I);const h=Zp*e*(Wd+3*Xd*a+u*(7*Yd+9*Kd*a))/Math.cos(o),f=Math.asin(Math.sin(o)/Zp),_=B(180*h/Math.PI,-180,180),g=B(180*f/Math.PI,-Z,Z);return new M(_,g)}}class Xw extends Il{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const o=360*(e-.5),a=B(360*(.5-i),-Z,Z);return new M(o,a)}}const Wu=Math.PI/2;function Wp(r){return Math.tan((Wu+r)/2)}class Yw extends Il{constructor(e){super(e),this.center=e.center||[0,30];const[i,o]=this.parallels=e.parallels||[30,30];let a=ii(i),u=ii(o);this.southernCenter=a+u<0,this.southernCenter&&(a=-a,u=-u);const h=Math.cos(a),f=Wp(a);this.n=a===u?Math.sin(a):Math.log(h/Math.cos(u))/Math.log(Wp(u)/f),this.f=h*Math.pow(Wp(a),this.n)/this.n}project(e,i){i=ii(i),this.southernCenter&&(i=-i),e=ii(e-this.center[0]);const o=1e-6,{n:a,f:u}=this;u>0?i<-Wu+o&&(i=-Wu+o):i>Wu-o&&(i=Wu-o);const h=u/Math.pow(Wp(i),a);let f=h*Math.sin(a*e),_=u-h*Math.cos(a*e);return f=.5*(f/Math.PI+.5),_=.5*(_/Math.PI+.5),{x:f,y:this.southernCenter?_:1-_,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:o,f:a}=this,u=a-i,h=Math.sign(u),f=Math.sign(o)*Math.sqrt(e*e+u*u);let _=Math.atan2(e,Math.abs(u))*h;u*o<0&&(_-=Math.PI*Math.sign(e)*h);const g=B(Jr(_/o)+this.center[0],-180,180),v=B(Jr(2*Math.atan(Math.pow(a/f,1/o))-Wu),-Z,Z);return new M(g,this.southernCenter?-v:v)}}class vv extends Il{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:N(e),y:k(i),z:0}}unproject(e,i){const o=$(e),a=G(i);return new M(o,a)}}const bv=ii(Z);class Kw extends Il{project(e,i){const o=(i=ii(i))*i,a=o*o;return{x:.5*((e=ii(e))*(.8707-.131979*o+a*(a*(.003971*o-.001529*a)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+o*(.015085+a*(.028874*o-.044475-.005916*a)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,a=25,u=0,h=o*o;do{h=o*o;const g=h*h;u=(o*(1.007226+h*(.015085+g*(.028874*h-.044475-.005916*g)))-i)/(1.007226+h*(.045255+g*(.259866*h-.311325-.005916*11*g))),o=B(o-u,-bv,bv)}while(Math.abs(u)>1e-6&&--a>0);h=o*o;const f=B(Jr(e/(.8707+h*(h*(h*h*h*(.003971-.001529*h)-.013791)-.131979))),-180,180),_=Jr(o);return new M(f,_)}}const wv=ii(Z);class Jw extends Il{project(e,i){i=ii(i),e=ii(e);const o=Math.cos(i),a=2/Math.PI,u=Math.acos(o*Math.cos(e/2)),h=Math.sin(u)/u,f=.5*(e*a+2*o*Math.sin(e/2)/h)||0,_=.5*(i+Math.sin(i)/h)||0;return{x:.5*(f/Math.PI+.5),y:1-.5*(_/Math.PI+1),z:0}}unproject(e,i){let o=e=(2*e-.5)*Math.PI,a=i=(2*(1-i)-1)*Math.PI,u=25;const h=1e-6;let f=0,_=0;do{const g=Math.cos(a),v=Math.sin(a),b=2*v*g,w=v*v,I=g*g,A=Math.cos(o/2),P=Math.sin(o/2),D=2*A*P,L=P*P,V=1-I*A*A,j=V?1/V:0,H=V?Math.acos(g*A)*Math.sqrt(1/V):0,te=.5*(2*H*g*P+2*o/Math.PI)-e,K=.5*(H*v+a)-i,oe=.5*j*(I*L+H*g*A*w)+1/Math.PI,le=j*(D*b/4-H*v*P),ue=.125*j*(b*P-H*v*I*D),Me=.5*j*(w*A+H*L*g)+.5,ye=le*ue-Me*oe;f=(K*le-te*Me)/ye,_=(te*ue-K*oe)/ye,o=B(o-f,-Math.PI,Math.PI),a=B(a-_,-wv,wv)}while((Math.abs(f)>h||Math.abs(_)>h)&&--u>0);return new M(Jr(o),Jr(a))}}class Tv extends Il{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(ii(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:o,cosPhi:a}=this;return{x:ii(e)*a*o+.5,y:-Math.sin(ii(i))/a*o+.5,z:0}}unproject(e,i){const{scale:o,cosPhi:a}=this,u=-(i-.5)/o,h=B(Jr((e-.5)/o)/a,-180,180),f=Math.asin(B(u*a,-1,1)),_=B(Jr(f),-Z,Z);return new M(h,_)}}class Qw extends vv{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,o){const a=wd(e,i,o);return nr(a,a,yp(ca(o))),{x:a[0],y:a[1],z:a[2]}}locationPoint(e,i,o){const a=x(i.lat,i.lng),u=Oi([],a),h=o?e._centerAltitude+o:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude;Fn(a,a,u,U(1,0)*Je*h);const f=Dt(new Float64Array(16));return Yt(f,e.pixelMatrix,e.globeMatrix),nr(a,a,f),new Be(a[0],a[1])}pixelsPerMeter(e,i){return U(1,0)*i}pixelSpaceConversion(e,i,o){const a=U(1,e)*i,u=Ft(U(1,45)*i,a,o);return this.pixelsPerMeter(e,i)/u}createTileMatrix(e,i,o){const a=n_(ca(o.canonical));return Yt(new Float64Array(16),e.globeMatrix,a)}createInversionMatrix(e,i){const{center:o}=e,a=yp(ca(i));return vi(a,a,ii(o.lng)),tr(a,a,ii(o.lat)),Ci(a,a,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(a)}pointCoordinate(e,i,o,a){return Zg(e,i,o,!0)||new _e(0,0)}pointCoordinate3D(e,i,o){const a=this.pointCoordinate(e,i,o,0);return[a.x,a.y,a.z]}isPointAboveHorizon(e,i){return!Zg(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=(function(a,u){const h=a.cameraToCenterDistance,f=a._centerAltitude*u,_=a._camera,g=a._camera.forward(),v=Er([],Wi([],g,-h),[0,0,f]),b=a.worldSize/(2*Math.PI),w=[0,0,-b],I=a.width/a.height,A=Math.tan(a.fovAboveCenter),P=Wi([],_.up(),A),D=Wi([],_.right(),A*I),L=Oi([],Er([],Er([],g,P),D)),V=[];let j;if(new Kt(v,L).closestPointOnSphere(w,b,V)){const H=Er([],V,w),te=Pr([],H,v);j=Math.cos(a.fovAboveCenter)*yn(te)}else{const H=Pr([],v,w),te=Pr([],w,v);Oi(te,te);const K=yn(H)-b;j=Math.sqrt(K*(K+2*b));const oe=Math.acos(j/(b+K))-Math.acos(Gi(g,te));j*=Math.cos(oe)}return 1.01*j})(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),o=wl(e.zoom);if(o>0){const a=yv(e,U(1,e.center.lat)*e.worldSize),u=e.worldSize/(2*Math.PI),h=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Ft(i,a+u*(1-Math.cos(h)),Math.pow(o,10))}return i}upVector(e,i,o){return wd(i,o,e,1)}upVectorScale(e){return{metersToTile:mp(gp(ca(e)))}}}function Sv(r){const e=r.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(r.name){case"mercator":return new vv(r);case"equirectangular":return new Xw(r);case"naturalEarth":return new Kw(r);case"equalEarth":return new Ww(r);case"winkelTripel":return new Jw(r);case"albers":return i?new Tv(r):new Zw(r);case"lambertConformalConic":return i?new Tv(r):new Yw(r);case"globe":return new Qw(r)}throw new Error("Invalid projection name: ".concat(r.name))}const eT=Ve.types,tT=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Jd(r,e,i,o,a,u,h,f,_,g,v,b,w){const I=f?Math.min(ka,Math.round(f[0])):0,A=f?Math.min(ka,Math.round(f[1])):0;r.emplaceBack(e,i,Math.round(32*o),Math.round(32*a),u,h,(I<<1)+(_?1:0),0+(A<<1),16*g,16*v,256*b,256*w)}function Qd(r,e,i){r.emplaceBack(e,i)}function ef(r,e,i,o,a,u,h){r.emplaceBack(e,i,o,a,u,h)}const Xp=(r,e,i,o)=>{for(let a=0;a<e;a++)r.emplaceBack(i[0],i[1],i[2],o[0],o[1],o[2])};function Xu(r,e,i,o,a){r.emplaceBack(e,i,o,a),r.emplaceBack(e,i,o,a),r.emplaceBack(e,i,o,a),r.emplaceBack(e,i,o,a)}function iT(r){for(const e of r.sections)if(Um(e.text))return!0;return!1}class Q_{constructor(e){this.layoutVertexArray=new Tu,this.indexArray=new vr,this.programConfigurations=e,this.segments=new Ar,this.dynamicLayoutVertexArray=new aa,this.opacityVertexArray=new sd,this.placedSymbolArray=new mc,this.iconTransitioningVertexArray=new ss,this.globeExtVertexArray=new fl,this.zOffsetVertexArray=new Vs,this.orientationVertexArray=new cd,this.symbolInstanceIndices=[]}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}getIconVertexData(e,i){const o=[],a=this.layoutVertexArray.uint16;for(let u=0;u<i;++u){const h=12*(e+u);o.push(...a.slice(h,h+12))}return o}updateIconVertexData(e,i,o,a,u,h,f,_,g,v,b,w,I){const A=this.layoutVertexArray.uint16,P=12*e;A[P]=i,A[P+1]=o,A[P+2]=a,A[P+3]=u,A[P+4]=h,A[P+5]=f,A[P+6]=_,A[P+7]=g,A[P+8]=v,A[P+9]=b,A[P+10]=w,A[P+11]=I}upload(e,i,o,a,u,h){this.isEmpty()||(o&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,sw.members,!!h),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,lw.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,tT,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,hw.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,aw.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||u)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,cw.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,uw.members,!0)),this.opacityVertexBuffer.itemSize=1),(o||a)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}pt(Q_,"SymbolBuffers");class eg{constructor(e,i,o){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new o,this.segments=new Ar,this.collisionVertexArray=new ml,this.collisionVertexArrayExt=new aa}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,dw.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,fw.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}pt(eg,"CollisionBuffers");class Yp{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((h=>h.fqid)),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Dt([]),this.placementViewportMatrix=Dt([]);const i=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=Hu(this.zoom,i["text-size"],this.worldview),this.iconSizeData=Hu(this.zoom,i["icon-size"],this.worldview);const o=this.layers[0].layout,a=o.get("symbol-sort-key"),u=o.get("symbol-z-order");this.lut=e.lut,this.canOverlap=o.get("text-allow-overlap")||o.get("icon-allow-overlap")||o.get("text-ignore-placement")||o.get("icon-ignore-placement"),this.sortFeaturesByKey=u!=="viewport-y"&&a.constantOr(1)!==void 0,this.sortFeaturesByY=(u==="viewport-y"||u==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=o.get("text-writing-mode").map((h=>Go[h])),this.stateDependentLayerIds=this.layers.filter((h=>h.isStateDependent())).map((h=>h.id)),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1,this.hasAppearances=null,this.lastActiveApperance=null}hasAnyAppearanceProperty(e){const i=this.layers[0].getAppearances();return!(!i||i.length===0)&&i.some((o=>o.getProperty(e)!=null))}createArrays(){this.text=new Q_(new _s(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("text")||e.startsWith("symbol")))),this.icon=new Q_(new _s(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("icon")||e.startsWith("symbol")))),this.glyphOffsetArray=new _d,this.lineVertexArray=new op,this.symbolInstances=new np}calculateGlyphDependencies(e,i,o,a,u){for(const h of e){const f=h.codePointAt(0);if(f===void 0)break;if(i[f]=!0,a&&u&&f<=65535){const _=Ud[h];_&&(i[_.charCodeAt(0)]=!0)}}}calculateEffectiveAppearanceIconSize(e,i,o,a,u,h){let f=1;const _=e.getUnevaluatedProperties()._values["icon-size"],g=Hu(this.zoom,_,this.worldview),v=qu(g,i);if(g.kind!=="constant"&&g.kind!=="camera"||(f=v.uSize),g.kind==="composite"){const{minZoom:b,maxZoom:w}=g,I=_.possiblyEvaluate(new lr(b,{worldview:this.worldview}),a),A=_.possiblyEvaluate(new lr(w,{worldview:this.worldview}),a),P=I.evaluate(o,{},a,u);f=P+(A.evaluate(o,{},a,u)-P)*v.uSizeT}return g.kind==="source"&&(f=_.possiblyEvaluate(new lr(this.zoom,{worldview:this.worldview}),a).evaluate(o,{},a,u)),f*h}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const o=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!Sp(this.activeReplacements,o)&&(this.activeReplacements=o,!0)}getResolvedImageFromTokens(e){return typeof e=="string"?po.build(e):e}populate(e,i,o,a){const u=this.layers[0],h=u.layout,f=this.projection.name==="globe",_=h.get("text-font"),g=h.get("text-field"),v=h.get("icon-image"),[b,w]=h.get("icon-size-scale-range"),I=B(i.scaleFactor||1,b,w),A=(g.value.kind!=="constant"||g.value.value instanceof bn&&!g.value.value.isEmpty()||g.value.value.toString().length>0)&&(_.value.kind!=="constant"||_.value.value.length>0),P=v.value.kind!=="constant"||!!v.value.value||Object.keys(v.parameters).length>0,D=this.hasAnyAppearanceProperty("icon-image"),L=h.get("symbol-sort-key");if(this.features=[],this.appearanceFeatureData=[],!A&&!P&&!D)return;const V=i.iconDependencies,j=i.glyphDependencies,H=i.availableImages,te=new lr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),K=oe=>{const le=oe.id.toString();V.has(le)?V.get(le).push(oe):V.set(le,[oe])};for(const oe of e){const{feature:le,id:ue,index:Me,sourceLayerIndex:ye}=oe,Ce=u._featureFilter.needGeometry,Oe=be(le,Ce);if(!u._featureFilter.filter(te,Oe,o))continue;if(Ce||(Oe.geometry=Le(le,o,a)),f&&le.type!==1&&o.z<=5){const Ue=Oe.geometry,Ze=.98078528056,ke=(ft,_t)=>Gi(wd(ft.x,ft.y,o,1),wd(_t.x,_t.y,o,1))<Ze;for(let ft=0;ft<Ue.length;ft++)Ue[ft]=ze(Ue[ft],ke)}let Ne,Ye;if(A){const Ue=u.getValueAndResolveTokens("text-field",Oe,o,H),Ze=bn.factory(Ue);iT(Ze)&&(this.hasRTLText=!0),(!this.hasRTLText||Kh()==="unavailable"||this.hasRTLText&&Io.isParsed())&&(Ne=mw(Ze,u,Oe))}if(P){const Ue=u.getValueAndResolveTokens("icon-image",Oe,o,H);Ye=this.getResolvedImageFromTokens(Ue)}const He=this.layers[0];let Fe=!1;if(!Ye&&D){const Ue=He.getAppearances();for(const Ze of Ue)if(Ze.getProperty("icon-image")){const ke=He.getAppearanceValueAndResolveTokens(Ze,"icon-image",Oe,o,H);if(ke){Ye=this.getResolvedImageFromTokens(ke),Fe=!0;break}}}if(!Ne&&!Ye)continue;const Ge=this.sortFeaturesByKey?L.evaluate(Oe,{},o):void 0,Ie={id:ue,text:Ne,icon:Ye,index:Me,sourceLayerIndex:ye,geometry:Oe.geometry,properties:le.properties,type:eT[le.type],sortKey:Ge};if(this.features.push(Ie),this.appearanceFeatureData.push({id:ue,properties:le.properties,usesAppearanceIconAsPlaceholder:Fe,isUsingAppearanceVertexData:!1,layoutBasedVertexData:[],activeAppearance:null}),Ye){const Ue=He._unevaluatedLayout._values,{iconPrimary:Ze,iconSecondary:ke}=qd(Ye,this.iconSizeData,Ue["icon-size"],o,this.zoom,Ie,this.pixelRatio,I,this.worldview);K(Ze),ke&&(this.hasAnySecondaryIcon=!0,K(ke))}const Se=He.getAppearances();if(Se.length!==0&&Se.forEach((Ue=>{if(!Ue.getProperty("icon-image"))return;const Ze=this.getCombinedIconPrimary(Ue,He,Oe,o,H,Ie,I);Ze&&K(Ze)})),Ne){const Ue=_.evaluate(Oe,{},o).join(","),Ze=h.get("text-rotation-alignment")==="map"&&h.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Go.vertical)>=0;for(const ke of Ne.sections)if(ke.image){const ft=ke.image.getPrimary().scaleSelf(this.pixelRatio),_t=ft.id.toString(),ut=V.get(_t)||[];ut.push(ft),V.set(_t,ut)}else{const ft=qh(Ne.toString()),_t=ke.fontStack||Ue,ut=j[_t]=j[_t]||{};this.calculateGlyphDependencies(ke.text,ut,Ze,this.allowVerticalPlacement,ft)}}}if(h.get("symbol-placement")==="line"&&(this.features=(function(oe){const le={},ue={},Me=[];let ye=0;function Ce(He){Me.push(oe[He]),ye++}function Oe(He,Fe,Ge){const Ie=ue[He];return delete ue[He],ue[Fe]=Ie,Me[Ie].geometry[0].pop(),Me[Ie].geometry[0]=Me[Ie].geometry[0].concat(Ge[0]),Ie}function Ne(He,Fe,Ge){const Ie=le[Fe];return delete le[Fe],le[He]=Ie,Me[Ie].geometry[0].shift(),Me[Ie].geometry[0]=Ge[0].concat(Me[Ie].geometry[0]),Ie}function Ye(He,Fe,Ge){const Ie=Ge?Fe[0][Fe[0].length-1]:Fe[0][0];return"".concat(He,":").concat(Ie.x,":").concat(Ie.y)}for(let He=0;He<oe.length;He++){const Fe=oe[He],Ge=Fe.geometry,Ie=Fe.text?Fe.text.toString():null;if(!Ie){Ce(He);continue}const Se=Ye(Ie,Ge),Ue=Ye(Ie,Ge,!0);if(Se in ue&&Ue in le&&ue[Se]!==le[Ue]){const Ze=Ne(Se,Ue,Ge),ke=Oe(Se,Ue,Me[Ze].geometry);delete le[Se],delete ue[Ue],ue[Ye(Ie,Me[ke].geometry,!0)]=ke,Me[Ze].geometry=null}else Se in ue?Oe(Se,Ue,Ge):Ue in le?Ne(Se,Ue,Ge):(Ce(He),le[Se]=ye-1,ue[Ue]=ye-1)}return Me.filter((He=>He.geometry))})(this.features)),h.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",i.elevationFeatures){!this.elevationFeatures&&i.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const oe of i.elevationFeatures)this.elevationFeatureIdToIndex.set(oe.id,this.elevationFeatures.length),this.elevationFeatures.push(oe)}}else h.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort(((oe,le)=>oe.sortKey-le.sortKey))}getCombinedIconPrimary(e,i,o,a,u,h,f){let _,g;const v=e.getUnevaluatedProperties();if(v._values["icon-image"].value!==void 0){const b=i.getAppearanceValueAndResolveTokens(e,"icon-image",o,a,u);_=this.getResolvedImageFromTokens(b)}else{const b=i.getValueAndResolveTokens("icon-image",o,a,u);_=this.getResolvedImageFromTokens(b)}if(_){const b=v._values["icon-size"]||i._unevaluatedLayout._values["icon-size"];g=qd(_,Hu(this.zoom,b,this.worldview),b,a,this.zoom,h,this.pixelRatio,f,this.worldview).iconPrimary}return g}updateAppearanceBasedIconTextures(e,i,o,a){if(!this.appearanceFeatureData||!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)return!1;const u=this.layers[0];let h=!1,f=0;const _=u.layout,[g,v]=_.get("icon-size-scale-range"),b=B(1,g,v);for(let w=0;w<this.symbolInstances.length;w++){const I=this.symbolInstances.get(w),A=this.appearanceFeatureData[I.featureIndex];if(A&&I.placedIconSymbolIndex>=0){const P=A.id,D=i&&P!==void 0?i[String(P)]:void 0,L={type:"Point",id:A.id,properties:A.properties,geometry:[]},V=this.layers[0].appearances&&this.layers[0].appearances.find((j=>j.isActive({globals:a,feature:L,canonical:e,featureState:D})));if(A.activeAppearance===V)continue;if(V){A.activeAppearance=V;const j={sortKey:void 0,text:void 0,icon:null,index:I.featureIndex,sourceLayerIndex:I.featureIndex,geometry:[],properties:A.properties,type:"Point",id:A.id};if(!V.hasCachedIconPrimary()){const oe=this.getCombinedIconPrimary(V,u,L,e,o,j,b);V.setCachedIconPrimary(oe)}const H=V.getCachedIconPrimary();if(!H)continue;const te=H.toString(),K=this.iconAtlasPositions&&this.iconAtlasPositions.get(te);if(K){const oe=u.getAppearanceValueAndResolveTokens(V,"icon-offset",L,e,o),le=oe&&Array.isArray(oe)?oe:[0,0];let ue=Vp(K,void 0,le,u.layout.get("icon-anchor").evaluate(L,{},e));const Me=u.getAppearanceValueAndResolveTokens(V,"icon-rotate",L,e,o),ye=typeof Me=="number"?Me:0,Ce=K.sdf,Oe=u.layout.get("icon-text-fit").constantOr("none");Oe!=="none"&&A.textShaping&&A.iconTextFitPadding&&A.fontScale&&(ue=H_(ue,A.textShaping,Oe,A.iconTextFitPadding,le,A.fontScale));const Ne=this.calculateEffectiveAppearanceIconSize(V,a.zoom,L,e,o,b),Ye=0,He=1+(Math.min(ka,Math.round(Ne*qs))<<1),Fe=W_(ue,ye,Ce,Oe!=="none",b);A.isUsingAppearanceVertexData||(A.isUsingAppearanceVertexData=!0,A.layoutBasedVertexData=this.icon.getIconVertexData(f,I.numIconVertices));for(let Ie=0;Ie<Fe.length;++Ie){const Se=Fe[Ie],Ue=A.layoutBasedVertexData[0]||I.tileAnchorX,Ze=A.layoutBasedVertexData[1]||I.tileAnchorY,ke=16*Se.pixelOffsetTL.x,ft=16*Se.pixelOffsetTL.y,_t=16*Se.pixelOffsetBR.x,ut=16*Se.pixelOffsetBR.y,ot=16*Se.minFontScaleX,jt=16*Se.minFontScaleY;this.icon.updateIconVertexData(f,Ue,Ze,Math.round(32*Se.tl.x),Math.round(32*Se.tl.y),Se.texPrimary.x,Se.texPrimary.y,Ye,He,ke,ft,ot,jt),this.icon.updateIconVertexData(f+1,Ue,Ze,Math.round(32*Se.tr.x),Math.round(32*Se.tr.y),Se.texPrimary.x+Se.texPrimary.w,Se.texPrimary.y,Ye,He,_t,ft,ot,jt),this.icon.updateIconVertexData(f+2,Ue,Ze,Math.round(32*Se.bl.x),Math.round(32*Se.bl.y),Se.texPrimary.x,Se.texPrimary.y+Se.texPrimary.h,Ye,He,ke,ut,ot,jt),this.icon.updateIconVertexData(f+3,Ue,Ze,Math.round(32*Se.br.x),Math.round(32*Se.br.y),Se.texPrimary.x+Se.texPrimary.w,Se.texPrimary.y+Se.texPrimary.h,Ye,He,_t,ut,ot,jt),f+=4}const Ge=I.numIconVertices-4*Fe.length;for(let Ie=0;Ie<Ge;++Ie)this.icon.updateIconVertexData(f+Ie,0,0,0,0,0,0,0,0,0,0,0,0);h=!0}else f+=I.numIconVertices}else if(A.usesAppearanceIconAsPlaceholder)this.layers[0].appearances&&this.layers[0].appearances.length>0&&(this.icon.updateIconVertexData(f,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(f+1,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(f+2,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(f+3,0,0,0,0,0,0,0,0,0,0,0,0),h=!0),f+=I.numIconVertices,A.activeAppearance=null;else if(A.isUsingAppearanceVertexData){const H=A.layoutBasedVertexData.length/12;for(let te=0;te<H;++te){const K=te*12;this.icon.updateIconVertexData(f+te,A.layoutBasedVertexData[K+0],A.layoutBasedVertexData[K+1],A.layoutBasedVertexData[K+2],A.layoutBasedVertexData[K+3],A.layoutBasedVertexData[K+4],A.layoutBasedVertexData[K+5],A.layoutBasedVertexData[K+6],A.layoutBasedVertexData[K+7],A.layoutBasedVertexData[K+8],A.layoutBasedVertexData[K+9],A.layoutBasedVertexData[K+10],A.layoutBasedVertexData[K+11])}f+=H,A.isUsingAppearanceVertexData=!1,A.activeAppearance=null,h=!0}else f+=I.numIconVertices,A.activeAppearance=null}}return h}update(e,i,o,a,u,h,f){this.text.programConfigurations.updatePaintArrays(e,i,u,o,a,h,f,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,i,u,o,a,h,f,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let i=!1;const o=re(e),a=1/o;let u=!1,h=!1;for(let f=0;f<this.symbolInstances.length;f++){const _=this.symbolInstances.get(f),g=rr(1,0,0),v=rr(0,1,0),{numHorizontalGlyphVertices:b,numVerticalGlyphVertices:w,numIconVertices:I,numVerticalIconVertices:A}=_,P=b>0||w>0,D=I>0,L=this.elevationFeatures[_.elevationFeatureIndex];if(L){const V=new Be(_.tileAnchorX,_.tileAnchorY),j=.075+L.pointElevation(V);_.zOffset!==j&&(i=!0,_.zOffset=j),j!==0&&(this.hasAnyZOffset=!0);const H=L.computeSlopeNormal(V,a),te=Xo(Po(),rr(0,0,1),H);In(g,g,te),In(v,v,te),g[2]*=o,v[2]*=o,g[0]===1&&g[1]===0&&g[2]===0&&v[0]===0&&v[1]===1&&v[2]===0||(u=u||P,h=h||D)}if(P&&(Xp(this.text.orientationVertexArray,b,g,v),Xp(this.text.orientationVertexArray,w,g,v)),D){const{placedIconSymbolIndex:V,verticalPlacedIconSymbolIndex:j}=_;V>=0&&Xp(this.icon.orientationVertexArray,I,g,v),j>=0&&Xp(this.icon.orientationVertexArray,A,g,v)}}u||(this.text.orientationVertexArray=void 0),h||(this.icon.orientationVertexArray=void 0),i&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(u,h,f)=>{o+=h,o>u.length&&u.resize(o);for(let _=-h;_<0;_++)u.emplace(_+o,f)},i=(u,h,f)=>{a+=h,a>u.length&&u.resize(a);for(let _=-h;_<0;_++)u.emplace(_+a,f)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let o=0,a=0;for(let u=0;u<this.symbolInstances.length;u++){const h=this.symbolInstances.get(u),{numHorizontalGlyphVertices:f,numVerticalGlyphVertices:_,numIconVertices:g}=h,v=h.zOffset,b=g>0;if((f>0||_>0)&&(e(this.text.zOffsetVertexArray,f,v),e(this.text.zOffsetVertexArray,_,v)),b){const{placedIconSymbolIndex:w,verticalPlacedIconSymbolIndex:I}=h;w>=0&&i(this.icon.zOffsetVertexArray,g,v),I>=0&&i(this.icon.zOffsetVertexArray,h.numVerticalIconVertices,v)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e,i,o,a,u){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,!1),this.hasAppearances===null&&(this.hasAppearances=this.layers.some((h=>h.appearances&&h.appearances.length>0))),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),this.uploaded=!0}updateAppearances(e,i,o,a){return!!(e&&i&&o)&&!(!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)&&!!this.icon.layoutVertexArray.arrayBuffer&&void(this.updateAppearanceBasedIconTextures(e,i,o,a)&&this.icon.layoutVertexBuffer&&this.icon.layoutVertexArray.arrayBuffer!==null&&this.icon.layoutVertexArray.length===this.icon.layoutVertexBuffer.length&&this.icon.layoutVertexBuffer.updateData(this.icon.layoutVertexArray))}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Sv(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const o=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:a,y:u}of i)this.lineVertexArray.emplaceBack(a,u);return{lineStartIndex:o,lineLength:this.lineVertexArray.length-o}}addSymbols(e,i,o,a,u,h,f,_,g,v,b,w,I,A,P,D,L,V){const j=e.indexArray,H=e.layoutVertexArray,te=e.globeExtVertexArray,K=e.segments.prepareSegment(4*V,H,j,this.canOverlap?h.sortKey:void 0),oe=this.glyphOffsetArray.length,le=K.vertexLength,ue=this.allowVerticalPlacement&&f===Go.vertical?Math.PI/2:0,Me=h.text&&h.text.sections;for(let Oe=0;Oe<i.length;Oe++){const{tl:Ne,tr:Ye,bl:He,br:Fe,texPrimary:Ge,texSecondary:Ie,pixelOffsetTL:Se,pixelOffsetBR:Ue,minFontScaleX:Ze,minFontScaleY:ke,glyphOffset:ft,isSDF:_t,sectionIndex:ut}=i[Oe],ot=K.vertexLength,jt=ft[1];if(Jd(H,g.x,g.y,Ne.x,jt+Ne.y,Ge.x,Ge.y,o,_t,Se.x,Se.y,Ze,ke),Jd(H,g.x,g.y,Ye.x,jt+Ye.y,Ge.x+Ge.w,Ge.y,o,_t,Ue.x,Se.y,Ze,ke),Jd(H,g.x,g.y,He.x,jt+He.y,Ge.x,Ge.y+Ge.h,o,_t,Se.x,Ue.y,Ze,ke),Jd(H,g.x,g.y,Fe.x,jt+Fe.y,Ge.x+Ge.w,Ge.y+Ge.h,o,_t,Ue.x,Ue.y,Ze,ke),_){const{x:at,y:Et,z:Ht}=_.anchor,[oi,yi,$t]=_.up;ef(te,at,Et,Ht,oi,yi,$t),ef(te,at,Et,Ht,oi,yi,$t),ef(te,at,Et,Ht,oi,yi,$t),ef(te,at,Et,Ht,oi,yi,$t),Xu(e.dynamicLayoutVertexArray,at,Et,Ht,ue)}else Xu(e.dynamicLayoutVertexArray,g.x,g.y,g.z,ue);if(D){const at=Ie||Ge;Qd(e.iconTransitioningVertexArray,at.x,at.y),Qd(e.iconTransitioningVertexArray,at.x+at.w,at.y),Qd(e.iconTransitioningVertexArray,at.x,at.y+at.h),Qd(e.iconTransitioningVertexArray,at.x+at.w,at.y+at.h)}j.emplaceBack(ot,ot+1,ot+2),j.emplaceBack(ot+1,ot+2,ot+3),K.vertexLength+=4,K.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(ft[0]),Oe!==i.length-1&&ut===i[Oe+1].sectionIndex||e.programConfigurations.populatePaintArrays(H.length,h,h.index,{},I,A,P,Me&&Me[ut],this.worldview)}const ye=V-i.length;ye!==0&&this._addNullVertices(ye,H,o,_,te,e,D,K,j);const Ce=_?_.anchor:g;e.placedSymbolArray.emplaceBack(Ce.x,Ce.y,Ce.z,g.x,g.y,oe,this.glyphOffsetArray.length-oe,le,v,b,g.segment,o?o[0]:0,o?o[1]:0,a[0],a[1],f,0,0,0,w,0),e.symbolInstanceIndices.push(L)}_addNullVertices(e,i,o,a,u,h,f,_,g){for(let v=0;v<e;v++){for(let w=0;w<4;w++)Jd(i,0,0,0,0,0,0,o,!1,0,0,0,0),a&&ef(u,0,0,0,0,0,0),Xu(h.dynamicLayoutVertexArray,0,0,0,0),f&&Qd(h.iconTransitioningVertexArray,0,0);const b=_.vertexLength;g.emplaceBack(b,b+1,b+2),g.emplaceBack(b+1,b+2,b+3),_.vertexLength+=4,_.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(0)}}_commitLayoutVertex(e,i,o,a,u,h,f){e.emplaceBack(i,o,a,u,h,Math.round(f.x),Math.round(f.y))}_addCollisionDebugVertices(e,i,o,a,u,h,f){const _=o.segments.prepareSegment(4,o.layoutVertexArray,o.indexArray),g=_.vertexLength,v=f.tileAnchorX,b=f.tileAnchorY;for(let I=0;I<4;I++)o.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(o.collisionVertexArrayExt,i,e.padding,f.zOffset),this._commitLayoutVertex(o.layoutVertexArray,a,u,h,v,b,new Be(e.x1,e.y1)),this._commitLayoutVertex(o.layoutVertexArray,a,u,h,v,b,new Be(e.x2,e.y1)),this._commitLayoutVertex(o.layoutVertexArray,a,u,h,v,b,new Be(e.x2,e.y2)),this._commitLayoutVertex(o.layoutVertexArray,a,u,h,v,b,new Be(e.x1,e.y2)),_.vertexLength+=4;const w=o.indexArray;w.emplaceBack(g,g+1),w.emplaceBack(g+1,g+2),w.emplaceBack(g+2,g+3),w.emplaceBack(g+3,g),_.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,o,a,u,h){for(let f=a;f<u;f++){const _=o.get(f),g=this.getSymbolInstanceTextSize(e,h,i,f);this._addCollisionDebugVertices(_,g,this.textCollisionBox,_.projectedAnchorX,_.projectedAnchorY,_.projectedAnchorZ,h)}}_addIconDebugCollisionBoxes(e,i,o,a,u,h){for(let f=a;f<u;f++){const _=o.get(f),g=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._addCollisionDebugVertices(_,g,this.iconCollisionBox,_.projectedAnchorX,_.projectedAnchorY,_.projectedAnchorZ,h)}}generateCollisionDebugBuffers(e,i,o){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new eg(Su,Ux.members,ss),this.iconCollisionBox=new eg(Su,Ux.members,ss);const a=qu(this.iconSizeData,e),u=qu(this.textSizeData,e,o);for(let h=0;h<this.symbolInstances.length;h++){const f=this.symbolInstances.get(h);this._addTextDebugCollisionBoxes(u,e,i,f.textBoxStartIndex,f.textBoxEndIndex,f),this._addTextDebugCollisionBoxes(u,e,i,f.verticalTextBoxStartIndex,f.verticalTextBoxEndIndex,f),this._addIconDebugCollisionBoxes(a,e,i,f.iconBoxStartIndex,f.iconBoxEndIndex,f),this._addIconDebugCollisionBoxes(a,e,i,f.verticalIconBoxStartIndex,f.verticalIconBoxEndIndex,f)}}getSymbolInstanceTextSize(e,i,o,a){const u=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:a),h=q_(this.textSizeData,e,u)/zn;return this.tilePixelRatio*h}getSymbolInstanceIconSize(e,i,o){const a=this.icon.placedSymbolArray.get(o),u=q_(this.iconSizeData,e,a);return this.tilePixelRatio*u}_commitDebugCollisionVertexUpdate(e,i,o,a){e.emplaceBack(i,-o,-o,a),e.emplaceBack(i,o,-o,a),e.emplaceBack(i,o,o,a),e.emplaceBack(i,-o,o,a)}_updateTextDebugCollisionBoxes(e,i,o,a,u,h,f){for(let _=a;_<u;_++){const g=o.get(_),v=this.getSymbolInstanceTextSize(e,h,i,_);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,v,g.padding,h.zOffset)}}_updateIconDebugCollisionBoxes(e,i,o,a,u,h,f){for(let _=a;_<u;_++){const g=o.get(_),v=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,v,g.padding,h.zOffset)}}updateCollisionDebugBuffers(e,i,o,a){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const u=qu(this.iconSizeData,e,a),h=qu(this.textSizeData,e,o);for(let f=0;f<this.symbolInstances.length;f++){const _=this.symbolInstances.get(f);this._updateTextDebugCollisionBoxes(h,e,i,_.textBoxStartIndex,_.textBoxEndIndex,_,o),this._updateTextDebugCollisionBoxes(h,e,i,_.verticalTextBoxStartIndex,_.verticalTextBoxEndIndex,_,o),this._updateIconDebugCollisionBoxes(u,e,i,_.iconBoxStartIndex,_.iconBoxEndIndex,_,a),this._updateIconDebugCollisionBoxes(u,e,i,_.verticalIconBoxStartIndex,_.verticalIconBoxEndIndex,_,a)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,o,a,u,h,f,_,g){const v={};if(i<o){const{x1:b,y1:w,x2:I,y2:A,padding:P,projectedAnchorX:D,projectedAnchorY:L,projectedAnchorZ:V,tileAnchorX:j,tileAnchorY:H,featureIndex:te}=e.get(i);v.textBox={x1:b,y1:w,x2:I,y2:A,padding:P,projectedAnchorX:D,projectedAnchorY:L,projectedAnchorZ:V,tileAnchorX:j,tileAnchorY:H},v.textFeatureIndex=te}if(a<u){const{x1:b,y1:w,x2:I,y2:A,padding:P,projectedAnchorX:D,projectedAnchorY:L,projectedAnchorZ:V,tileAnchorX:j,tileAnchorY:H,featureIndex:te}=e.get(a);v.verticalTextBox={x1:b,y1:w,x2:I,y2:A,padding:P,projectedAnchorX:D,projectedAnchorY:L,projectedAnchorZ:V,tileAnchorX:j,tileAnchorY:H},v.verticalTextFeatureIndex=te}if(h<f){const{x1:b,y1:w,x2:I,y2:A,padding:P,projectedAnchorX:D,projectedAnchorY:L,projectedAnchorZ:V,tileAnchorX:j,tileAnchorY:H,featureIndex:te}=e.get(h);v.iconBox={x1:b,y1:w,x2:I,y2:A,padding:P,projectedAnchorX:D,projectedAnchorY:L,projectedAnchorZ:V,tileAnchorX:j,tileAnchorY:H},v.iconFeatureIndex=te}if(_<g){const{x1:b,y1:w,x2:I,y2:A,padding:P,projectedAnchorX:D,projectedAnchorY:L,projectedAnchorZ:V,tileAnchorX:j,tileAnchorY:H,featureIndex:te}=e.get(_);v.verticalIconBox={x1:b,y1:w,x2:I,y2:A,padding:P,projectedAnchorX:D,projectedAnchorY:L,projectedAnchorZ:V,tileAnchorX:j,tileAnchorY:H},v.verticalIconFeatureIndex=te}return v}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const o=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,o.textBoxStartIndex,o.textBoxEndIndex,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o.iconBoxStartIndex,o.iconBoxEndIndex,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const o=e.placedSymbolArray.get(i),a=o.vertexStartIndex+4*o.numGlyphs;for(let u=o.vertexStartIndex;u<a;u+=4)e.indexArray.emplaceBack(u,u+1,u+2),e.indexArray.emplaceBack(u+1,u+2,u+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(e),o=Math.cos(e),a=[],u=[],h=[];for(let f=0;f<this.symbolInstances.length;++f){h.push(f);const _=this.symbolInstances.get(f);a.push(0|Math.round(i*_.tileAnchorX+o*_.tileAnchorY)),u.push(_.featureIndex)}return h.sort(((f,_)=>a[f]-a[_]||u[_]-u[f])),h}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset))}addToSortKeyRanges(e,i){const o=this.sortKeyRanges[this.sortKeyRanges.length-1];o&&o.sortKey===i?o.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const o=this.symbolInstances.get(i);this.featureSortOrder.push(o.featureIndex);const{rightJustifiedTextSymbolIndex:a,centerJustifiedTextSymbolIndex:u,leftJustifiedTextSymbolIndex:h,verticalPlacedTextSymbolIndex:f,placedIconSymbolIndex:_,verticalPlacedIconSymbolIndex:g}=o;a>=0&&this.addIndicesForPlacedSymbol(this.text,a),u>=0&&u!==a&&this.addIndicesForPlacedSymbol(this.text,u),h>=0&&h!==u&&h!==a&&this.addIndicesForPlacedSymbol(this.text,h),f>=0&&this.addIndicesForPlacedSymbol(this.text,f),_>=0&&this.addIndicesForPlacedSymbol(this.icon,_),g>=0&&this.addIndicesForPlacedSymbol(this.icon,g)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}getElevationFeatureForText(e){const i=this.symbolInstances.get(this.text.symbolInstanceIndices[e]).elevationFeatureIndex;let o;return this.elevationFeatures&&i<this.elevationFeatures.length&&(o=this.elevationFeatures[i]),o}}function Ev(r,e){return e.replace(/{([^{}]+)}/g,((i,o)=>o in r?String(r[o]):""))}let Iv,Av,tg;pt(Yp,"SymbolBucket",{omit:["layers","collisionBoxArray","compareText","features"]}),Yp.addDynamicAttributes=Xu;class Mv{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:Ua,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}pt(Mv,"FormatSectionOverride",{omit:["defaultValue"]});const ig=()=>tg||(tg={layout:Iv||(Iv=new kr({"symbol-placement":new qe(ge.layout_symbol["symbol-placement"]),"symbol-spacing":new qe(ge.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new qe(ge.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new lt(ge.layout_symbol["symbol-sort-key"]),"symbol-z-order":new qe(ge.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new qe(ge.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new qe(ge.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new qe(ge.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new qe(ge.layout_symbol["icon-ignore-placement"]),"icon-optional":new qe(ge.layout_symbol["icon-optional"]),"icon-rotation-alignment":new qe(ge.layout_symbol["icon-rotation-alignment"]),"icon-size":new lt(ge.layout_symbol["icon-size"]),"icon-size-scale-range":new qe(ge.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new lt(ge.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new lt(ge.layout_symbol["icon-text-fit-padding"]),"icon-image":new lt(ge.layout_symbol["icon-image"]),"icon-image-use-theme":new qe({type:"string",default:"default","property-type":"data-constant"}),"icon-rotate":new lt(ge.layout_symbol["icon-rotate"]),"icon-padding":new qe(ge.layout_symbol["icon-padding"]),"icon-keep-upright":new qe(ge.layout_symbol["icon-keep-upright"]),"icon-offset":new lt(ge.layout_symbol["icon-offset"]),"icon-anchor":new lt(ge.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new qe(ge.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new qe(ge.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new qe(ge.layout_symbol["text-rotation-alignment"]),"text-field":new lt(ge.layout_symbol["text-field"]),"text-font":new lt(ge.layout_symbol["text-font"]),"text-size":new lt(ge.layout_symbol["text-size"]),"text-size-scale-range":new qe(ge.layout_symbol["text-size-scale-range"]),"text-max-width":new lt(ge.layout_symbol["text-max-width"]),"text-line-height":new lt(ge.layout_symbol["text-line-height"]),"text-letter-spacing":new lt(ge.layout_symbol["text-letter-spacing"]),"text-justify":new lt(ge.layout_symbol["text-justify"]),"text-radial-offset":new lt(ge.layout_symbol["text-radial-offset"]),"text-variable-anchor":new qe(ge.layout_symbol["text-variable-anchor"]),"text-anchor":new lt(ge.layout_symbol["text-anchor"]),"text-max-angle":new qe(ge.layout_symbol["text-max-angle"]),"text-writing-mode":new qe(ge.layout_symbol["text-writing-mode"]),"text-rotate":new lt(ge.layout_symbol["text-rotate"]),"text-padding":new qe(ge.layout_symbol["text-padding"]),"text-keep-upright":new qe(ge.layout_symbol["text-keep-upright"]),"text-transform":new lt(ge.layout_symbol["text-transform"]),"text-offset":new lt(ge.layout_symbol["text-offset"]),"text-allow-overlap":new qe(ge.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new qe(ge.layout_symbol["text-ignore-placement"]),"text-optional":new qe(ge.layout_symbol["text-optional"]),visibility:new qe(ge.layout_symbol.visibility)})),paint:Av||(Av=new kr({"icon-opacity":new lt(ge.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new lt(ge.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new lt(ge.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new lt(ge.paint_symbol["text-emissive-strength"]),"icon-color":new lt(ge.paint_symbol["icon-color"]),"icon-halo-color":new lt(ge.paint_symbol["icon-halo-color"]),"icon-halo-width":new lt(ge.paint_symbol["icon-halo-width"]),"icon-halo-blur":new lt(ge.paint_symbol["icon-halo-blur"]),"icon-translate":new qe(ge.paint_symbol["icon-translate"]),"icon-translate-anchor":new qe(ge.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new qe(ge.paint_symbol["icon-image-cross-fade"]),"text-opacity":new lt(ge.paint_symbol["text-opacity"]),"text-occlusion-opacity":new lt(ge.paint_symbol["text-occlusion-opacity"]),"text-color":new lt(ge.paint_symbol["text-color"],{runtimeType:So,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new lt(ge.paint_symbol["text-halo-color"]),"text-halo-width":new lt(ge.paint_symbol["text-halo-width"]),"text-halo-blur":new lt(ge.paint_symbol["text-halo-blur"]),"text-translate":new qe(ge.paint_symbol["text-translate"]),"text-translate-anchor":new qe(ge.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new qe(ge.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new qe(ge.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new qe(ge.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new qe(ge.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new lt(ge.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},tg);class Kp extends Kn{constructor(e,i,o,a){super(e,ig(),i,o,a,e.layout?e.layout["icon-image-use-theme"]:null),this._colorAdjustmentMatrix=Dt([]),this.hasOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}_handleSpecialPaintPropertyUpdate(e){e!=="icon-occlusion-opacity"&&e!=="text-occlusion-opacity"||(this.hasOcclusionOpacityProperties=!0)}recalculate(e,i){super.recalculate(e,i),this.appearances&&this.appearances.forEach((a=>{a.recalculate(e,i,this.iconImageUseTheme)})),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const o=this.layout.get("text-writing-mode");if(o){const a=[];for(const u of o)a.indexOf(u)<0&&a.push(u);this.layout._values["text-writing-mode"]=a}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,o,a){return this._saturation===e&&this._contrast===i&&this._brightnessMin===o&&this._brightnessMax===a||(this._colorAdjustmentMatrix=(function(u,h,f,_){u=Rr(u),h=dr(h);const g=Vi(),v=u/3,b=1-2*v,w=[b,v,v,0,v,b,v,0,v,v,b,0,0,0,0,1],I=.5-.5*h,A=_-f;return Yt(g,[A,0,0,0,0,A,0,0,0,0,A,0,f,f,f,1],[h,0,0,0,0,h,0,0,0,0,h,0,I,I,I,1]),Yt(g,g,w),g})(e,i,o,a),this._saturation=e,this._contrast=i,this._brightnessMin=o,this._brightnessMax=a),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,o,a){const u=this.layout.get(e).evaluate(i,{},o,a),h=this._unevaluatedLayout._values[e];return h.isDataDriven()||hu(h.value)||!u?u:Ev(i.properties,u)}getAppearanceValueAndResolveTokens(e,i,o,a,u){const h=e.getProperty(i);if(!h)return;const f=h.evaluate(o,{},a,u),_=e.getUnevaluatedProperties()._values[i];return _.isDataDriven()||hu(_.value)||!f||typeof f!="string"?f:Ev(o.properties,f)}createBucket(e){return new Yp(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of ig().paint.overridableProperties){if(!Kp.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),o=new Mv(i),a=new uu(o,i.property.specification,this.scope,this.options,this.layout.get("icon-image-use-theme"));let u=null;u=i.value.kind==="constant"||i.value.kind==="source"?new cc("source",a):new ia("composite",a,i.value.zoomStops,i.value.interpolationType),this.paint._values[e]=new os(i.property,u,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,o){return!(!this.layout||i.isDataDriven()||o.isDataDriven())&&Kp.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const o=e.get("text-field"),a=ig().paint.properties[i];let u=!1;const h=f=>{for(const _ of f)if(a.overrides&&a.overrides.hasOverride(_))return void(u=!0)};if(o.value.kind==="constant"&&o.value.value instanceof bn)h(o.value.value.sections);else if(o.value.kind==="source"){const f=g=>{u||(g instanceof Os&&_n(g.value)===xa?h(g.value.sections):g instanceof va?h(g.sections):g.eachChild(f))},_=o.value;_._styleExpression&&f(_._styleExpression.expression)}return u}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,o){return{config:new js(this,{zoom:i,lut:o}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let Cv,Pv,Rv,Dv;var rg=ai([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function Jp(r,e,i,o,a,u,h,f){const _=[r,e,1,i,o,1,a,u,1],g=[h,f,1],v=Xt([],_),[b,w,I]=kn(g,g,v);return ei(_,_,[b,0,0,0,w,0,0,0,I])}function zv(r,e,i,o,a,u,h,f){const _=(function(g,v,b,w,I,A,P,D){const L=Jp(0,0,1,0,1,1,0,1),V=Jp(g,v,b,w,I,A,P,D);return ei(V,V,Xt([],L))})(r,e,i,o,a,u,h,f);return[_[2]/_[8]/Je,_[5]/_[8]/Je]}function Qp(r){return[r[0],Math.min(Math.max(r[1],-Z),Z)]}class Lv extends Ds{constructor(e,i,o,a){super(),this.id=e,this.dispatcher=o,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(a),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new Do("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=uh(this.map._requestManager.transformRequest(this.url,_a.Image),((o,a)=>{this._imageRequest=null,this._loaded=!0,o?this.fire(new jl(o)):a&&(this.image=a instanceof HTMLImageElement?To.getImageData(a):a,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())}))}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Bd(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Do("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Bd||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],o=e[0][1];for(const u of e)u[1]>o&&(o=u[1]),u[1]<i&&(i=u[1]);const a=(o+i)/2;if(a>Z?this.onNorthPole=!0:a<-Z&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const u=e.map(_e.fromLngLat);this.tileID=(function(h){let f=1/0,_=1/0,g=-1/0,v=-1/0;for(const P of h)f=Math.min(f,P.x),_=Math.min(_,P.y),g=Math.max(g,P.x),v=Math.max(v,P.y);const b=Math.max(g-f,v-_),w=Math.max(0,Math.floor(-Math.log2(b))),I=Math.pow(2,w);let A=Math.floor((f+g)/2*I);return A>1&&(A-=1),new Vo(w,A,Math.floor((_+v)/2*I))})(u),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Do("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof Bd||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const L in this.tiles){const V=this.tiles[L];V.state!=="loaded"&&(V.state="loaded",V.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=Zd(new Vo(0,0,0),this.map.transform.projection),o=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!(function(L){const V=L[1].x-L[0].x,j=L[1].y-L[0].y,H=L[2].x-L[1].x,te=L[2].y-L[1].y,K=L[3].x-L[2].x,oe=L[3].y-L[2].y,le=L[0].x-L[3].x,ue=L[0].y-L[3].y,Me=V*te-H*j,ye=H*oe-K*te,Ce=K*ue-le*oe,Oe=le*j-V*ue;return Me>0&&ye>0&&Ce>0&&Oe>0||Me<0&&ye<0&&Ce<0&&Oe<0})(o))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const a=Zd(this.tileID,this.map.transform.projection),[u,h,f,_]=this.coordinates.map((L=>{const V=a.projection.project(L[0],L[1]);return xv(a,V)._round()}));this.perspectiveTransform=zv(u.x,u.y,h.x,h.y,f.x,f.y,_.x,_.y);const g=this._boundsArray=new dl;g.emplaceBack(u.x,u.y,0,0),g.emplaceBack(h.x,h.y,Je,0),g.emplaceBack(_.x,_.y,0,Je),g.emplaceBack(f.x,f.y,Je,Je),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(g,rg.members),this.boundsSegments=Ar.simpleSegment(0,0,4,2);const v=[],b=[Qp((w=this.coordinates)[0]),Qp(w[1]),Qp(w[2]),Qp(w[3])];var w;const[I,A,P,D]=(function(L){let V=L[0][0],j=V,H=L[0][1],te=H;for(let K=1;K<L.length;K++)L[K][0]<V?V=L[K][0]:L[K][0]>j&&(j=L[K][0]),L[K][1]<H?H=L[K][1]:L[K][1]>te&&(te=L[K][1]);return[V,H,j-V,te-H]})(b);{const L=new dl,[V,j,H,te]=(function(Fe){let Ge=Fe[0].x,Ie=Ge,Se=Fe[0].y,Ue=Se;for(let Ze=1;Ze<Fe.length;Ze++)Fe[Ze].x<Ge?Ge=Fe[Ze].x:Fe[Ze].x>Ie&&(Ie=Fe[Ze].x),Fe[Ze].y<Se?Se=Fe[Ze].y:Fe[Ze].y>Ue&&(Ue=Fe[Ze].y);return[Ge,Se,Ie-Ge,Ue-Se]})(o),K=Fe=>[(Fe.x-V)/H,(Fe.y-j)/te],[oe,le,ue,Me]=o.map(K),ye=(function(Fe,Ge,Ie,Se,Ue,Ze,ke,ft){const _t=Jp(0,0,1,0,1,1,0,1);return ei(_t,_t,Xt([],Jp(Fe,Ge,Ie,Se,Ue,Ze,ke,ft)))})(oe[0],oe[1],le[0],le[1],ue[0],ue[1],Me[0],Me[1]);this.elevatedGlobePerspectiveTransform=zv(oe[0],oe[1],le[0],le[1],ue[0],ue[1],Me[0],Me[1]);const Ce=(Fe,Ge)=>{v.push(Fe.lng);const Ie=Math.round((Fe.lng-I)/P*Je),Se=Math.round((Fe.lat-A)/D*Je),Ue=K(Ge),Ze=kn([],[Ue[0],Ue[1],1],ye),ke=Math.round(Ze[0]/Ze[2]*Je),ft=Math.round(Ze[1]/Ze[2]*Je);L.emplaceBack(Ie,Se,ke,ft)},Oe=o[3].x-o[0].x,Ne=o[3].y-o[0].y,Ye=o[2].x-o[1].x,He=o[2].y-o[1].y;for(let Fe=0;Fe<65;Fe++){const Ge=Fe/64,Ie=[o[0].x+Ge*Oe,o[0].y+Ge*Ne],Se=[o[1].x+Ge*Ye,o[1].y+Ge*He],Ue=Se[0]-Ie[0],Ze=Se[1]-Ie[1];for(let ke=0;ke<65;ke++){const ft=ke/64,_t={x:Ie[0]+Ue*ft,y:Ie[1]+Ze*ft};Ce(i.projection.unproject(_t.x,_t.y),_t)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(L,rg.members)}{this.maxLongitudeTriangleSize=0;let L=[],V=new vr;const j=(H,te,K)=>{V.emplaceBack(H,te,K);const oe=v[H],le=v[te],ue=v[K],Me=Math.min(Math.min(oe,le),ue),ye=Math.max(Math.max(oe,le),ue)-Me;ye>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=ye),L.push(Me+ye/2)};for(let H=0;H<64;H++)for(let te=0;te<64;te++){const K=65*H+te,oe=K+1,le=K+65,ue=le+1;j(K,le,oe),j(oe,le,ue)}[L,V]=(function(H,te){const K=Array.from({length:H.length},((ue,Me)=>Me));K.sort(((ue,Me)=>H[ue]-H[Me]));const oe=[],le=new vr;for(let ue=0;ue<K.length;ue++){const Me=K[ue];oe.push(H[Me]);const ye=3*Me,Ce=ye+1;le.emplaceBack(te.uint16[ye],te.uint16[Ce],te.uint16[Ce+1])}return[oe,le]})(L,V),this.elevatedGlobeTrianglesCenterLongitudes=L,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(V)}this.elevatedGlobeSegments=Ar.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,P/Je,0,D/Je,0,0,A,I,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const i=this.map.painter.context,o=i.gl;!this._dirty||this.texture instanceof Bd||(this.texture?this.texture.update(this.image):(this.texture=new C_(i,this.image,o.RGBA8),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const o=this.elevatedGlobeTrianglesCenterLongitudes;let a=(u=e+180)+360*Math.round((o[0]-u)/360);var u;const h=new Ar,f=(b,w)=>{h.segments.push({vertexOffset:0,primitiveOffset:b,vertexLength:i.segments[0].vertexLength,primitiveLength:w,sortKey:void 0,vaos:{}})},_=.51*this.maxLongitudeTriangleSize;if(Math.abs(o[0]-a)<=_){const b=di(o,0,o.length,a+_);return b===o.length||f(b,$i(o,b+1,o.length,a+360-_)-b),h}a<o[0]&&(a+=360);const g=$i(o,0,o.length,a-_);if(g===o.length)return f(0,o.length),h;f(0,g-0);const v=di(o,g+1,o.length,a+_);return v!==o.length&&f(v,o.length-v),h}}const rT=(Math.pow(256,2)-1)/16907520;class Ov extends Kn{constructor(e,i,o,a){super(e,{layout:Rv||(Rv=new kr({visibility:new qe(ge.layout_raster.visibility)})),paint:Dv||(Dv=new kr({"raster-opacity":new qe(ge.paint_raster["raster-opacity"]),"raster-color":new al(ge.paint_raster["raster-color"]),"raster-color-mix":new qe(ge.paint_raster["raster-color-mix"]),"raster-color-range":new qe(ge.paint_raster["raster-color-range"]),"raster-hue-rotate":new qe(ge.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new qe(ge.paint_raster["raster-brightness-min"]),"raster-brightness-max":new qe(ge.paint_raster["raster-brightness-max"]),"raster-saturation":new qe(ge.paint_raster["raster-saturation"]),"raster-contrast":new qe(ge.paint_raster["raster-contrast"]),"raster-resampling":new qe(ge.paint_raster["raster-resampling"]),"raster-fade-duration":new qe(ge.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new qe(ge.paint_raster["raster-emissive-strength"]),"raster-array-band":new qe(ge.paint_raster["raster-array-band"]),"raster-elevation":new qe(ge.paint_raster["raster-elevation"]),"raster-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},i,o,a),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof Lv&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[o,a]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(o)&&isNaN(a)||o===this._curRampRange[0]&&a===this._curRampRange[1]||(this.colorRamp=Td({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:o,end:a}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[o,a])}}let Fv,kv,Bv,Nv,Vv;class Uv extends Kn{constructor(e,i,o,a){super(e,{layout:Fv||(Fv=new kr({visibility:new qe(ge["layout_raster-particle"].visibility)})),paint:kv||(kv=new kr({"raster-particle-array-band":new qe(ge["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new qe(ge["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new al(ge["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new qe(ge["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new qe(ge["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new qe(ge["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new qe(ge["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new qe(ge["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},i,o,a),this._updateColorRamp(),this.lastInvalidatedAt=To.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Td({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=To.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class nT extends Kn{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function ng(r,e,i){const o=[0,0,1],a=Rt([]);return bi(a,a,i?-ii(r)+Math.PI:ii(r)),qt(a,a,-ii(e)),In(o,o,a),Oi(o,o)}const jv={None:0,Model:1,Symbol:2,FillExtrusion:4};class em{constructor(e,i,o,a){this.message=(e?"".concat(e,": "):"")+o,a&&(this.identifier=a),i!=null&&i.__line__&&(this.line=i.__line__)}}function og(r,e){const i=r.indexOf("://")===-1;try{return new URL(r,i&&e?"http://example.com":void 0),!0}catch(o){return!1}}class Gv{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Hv{constructor(){this.maxScale=1,this.maxXYTranslationDistance=0,this.instancedDataArray=new Iu,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}colorForInstance(e){const i=16*e,o=this.instancedDataArray.float32;let a=Math.floor(o[i+2]);const u=1.05*(o[i+2]-a);return a/=100,[o[i]%1*1.05,o[i+1]%1*1.05,u,a]}tileCoordinatesForInstance(e){const i=16*e,o=this.instancedDataArray.float32;let a=o[i+0];return a=a>Je?a-Je:a,new Be(Math.trunc(a),Math.trunc(o[i+1]))}translationForInstance(e){const i=16*e,o=this.instancedDataArray.float32;return[o[i+4],o[i+5],o[i+6]]}rotationScaleForInstance(e){const i=16*e,o=this.instancedDataArray.float32;return[o[i+7],o[i+8],o[i+9],o[i+10],o[i+11],o[i+12],o[i+13],o[i+14],o[i+15]]}transformForInstance(e){const i=16*e,o=this.instancedDataArray.float32;return[o[i+7],o[i+8],o[i+9],o[i+4],o[i+10],o[i+11],o[i+12],o[i+5],o[i+13],o[i+14],o[i+15],o[i+6],0,0,0,1]}}class sg{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaledZ=this.canonical.z+Math.log2(e.overscaling),this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z+1?0:this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,o,a){}populate(e,i,o,a){this.tileToMeter=re(o);const u=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:h,id:f,index:_,sourceLayerIndex:g}of e){const v=f!=null?f:h.properties&&h.properties.hasOwnProperty("id")?h.properties.id:void 0,b=be(h,u);if(!this.layers[0]._featureFilter.filter(new lr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),b,o))continue;const w={id:v,sourceLayerIndex:g,index:_,geometry:u?b.geometry:Le(h,o,a),properties:h.properties,type:h.type,patterns:{}},I=this.addFeature(w,w.geometry,b);I&&i.featureIndex.insert(h,w.geometry,_,g,this.index,this.instancesPerModel[I].instancedDataArray.length,Je/32)}this.lookup=null}evaluateQueryRenderedFeaturePadding(){const e=this.layers[0].modelManager,i=this.layers[0].scope;let o=0;for(const a of this.modelUris){const u=e.getModel(a,i);if(!u)continue;const h=this.instancesPerModel[a];if(h){const f=.5*Wo(u.aabb.max,u.aabb.min)*h.maxScale+h.maxXYTranslationDistance,_=Math.min(Je,Math.max(f/this.tileToMeter,Je/32));o=Math.max(_,o)}}return o}update(e,i,o,a){for(const u in this.instancesPerModel){const h=this.instancesPerModel[u];for(const f in e)h.idToFeaturesIndex.hasOwnProperty(f)&&(this.evaluate(h.features[h.idToFeaturesIndex[f]],e[f],h,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];for(const a of o.features){const u=this.layers[0],h=a.feature,f=this.canonical,_=u.paint.get("model-rotation").evaluate(h,{},f),g=u.paint.get("model-scale").evaluate(h,{},f),v=u.paint.get("model-translation").evaluate(h,{},f);co(a.rotation,_)&&co(a.scale,g)&&co(a.translation,v)||(this.evaluate(a,a.featureStates,o,!0),e=!0)}}return e}updateReplacement(e,i,o,a){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const u=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(Sp(this.activeReplacements,u))return!1;this.activeReplacements=u;let h=!1;for(const f in this.instancesPerModel){const _=this.instancesPerModel[f],g=_.instancedDataArray;for(const v of _.features){const b=v.instancedDataOffset,w=v.instancedDataCount;for(let I=0;I<w;I++){const A=16*(I+b);let P=g.float32[A+0];const D=P>Je;P=D?P-Je:P;const L=Math.floor(P),V=Math.floor(g.float32[A+1]);let j=!1;for(const H of this.activeReplacements)if(!Cy(H,o,jv.Model,a)&&!(H.min.x>L||L>H.max.x||H.min.y>V||V>H.max.y)&&(j=g_(zy(L,V,e.canonical,H.footprintTileId.canonical),H.footprint),j))break;g.float32[A]=j?P+Je:P,h=h||j!==D}}}return h}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];o.instancedDataArray.length<0||o.instancedDataArray.length===0||(o.instancedDataBuffer?o.instancedDataBuffer.updateData(o.instancedDataArray):o.instancedDataBuffer=e.createVertexBuffer(o.instancedDataArray,R1.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];o.instancedDataArray.length!==0&&o.instancedDataBuffer&&o.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(const i of this.modelUris)e.removeModel(i,"",!0)}addFeature(e,i,o){const a=this.layers[0],u=a.layout.get("model-id").evaluate(o,{},this.canonical);if(!u)return Mt("modelId is not evaluated for layer ".concat(a.id," and it is not going to get rendered.")),u;(og(u,!1)||this.styleDefinedModelURLs[u]!==void 0)&&(this.modelUris.includes(u)||this.modelUris.push(u)),this.instancesPerModel[u]||(this.instancesPerModel[u]=new Hv);const h=this.instancesPerModel[u],f=h.instancedDataArray,_=new Gv(o,f.length);for(const g of i)for(const v of g){if(v.x<0||v.x>=Je||v.y<0||v.y>=Je)continue;if(this.lookupDim!==0){const w=(this.lookupDim-1)/Je,I=this.lookupDim*(v.y*w|0)+v.x*w|0;if(this.lookup){if(this.lookup[I]!==0)continue;this.lookup[I]=1}}this.instanceCount++;const b=f.length;f.resize(b+1),h.instancesEvaluatedElevation.push(0),f.float32[16*b]=v.x,f.float32[16*b+1]=v.y}return _.instancedDataCount=h.instancedDataArray.length-_.instancedDataOffset,_.instancedDataCount>0&&(e.id&&(h.idToFeaturesIndex[e.id]=h.features.length),h.features.push(_),this.evaluate(_,{},h,!1)),u}getModelUris(){return this.modelUris}evaluate(e,i,o,a){const u=this.layers[0],h=e.feature,f=this.canonical,_=e.rotation=u.paint.get("model-rotation").evaluate(h,i,f),g=e.scale=u.paint.get("model-scale").evaluate(h,i,f),v=e.translation=u.paint.get("model-translation").evaluate(h,i,f),b=Object.assign({},u.paint.get("model-color").evaluate(h,i,f));b.a=u.paint.get("model-color-mix-intensity").evaluate(h,i,f);const w=[];this.maxVerticalOffset<v[2]&&(this.maxVerticalOffset=v[2]);const I=v[0]*v[0]+v[1]*v[1],A=I>0?Math.sqrt(I):0;o.maxScale=Math.max(Math.max(o.maxScale,g[0]),Math.max(g[1],g[2])),o.maxXYTranslationDistance=Math.max(o.maxXYTranslationDistance,A),this.maxScale=Math.max(Math.max(this.maxScale,g[0]),Math.max(g[1],g[2])),xx(w,_,g);const P=Math.round(100*b.a)+b.b/1.05;for(let D=0;D<e.instancedDataCount;++D){const L=e.instancedDataOffset+D,V=16*L,j=o.instancedDataArray.float32;let H=0;a&&(H=j[V+6]-o.instancesEvaluatedElevation[L]);const te=0|j[V+1];j[V]=(0|j[V])+b.r/1.05,j[V+1]=te+b.g/1.05,j[V+2]=P,j[V+3]=1/(f.z>10?this.tileToMeter:re(f,te)),j[V+4]=v[0],j[V+5]=v[1],j[V+6]=v[2]+H,j[V+7]=w[0],j[V+8]=w[1],j[V+9]=w[2],j[V+10]=w[4],j[V+11]=w[5],j[V+12]=w[6],j[V+13]=w[8],j[V+14]=w[9],j[V+15]=w[10],o.instancesEvaluatedElevation[L]=v[2]}}}let qv,$v;pt(sg,"ModelBucket",{omit:["layers"]}),pt(Hv,"PerModelAttributes"),pt(Gv,"ModelFeature");class Yu{constructor(e,i,o){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=o}static create(e,i,o){const a=o||e.findDEMTileFor(i);if(!a||!a.dem)return;const u=a.dem,h=a.tileID,f=1<<i.canonical.z-h.canonical.z;return new Yu(a,u.dim/Je/f,[(i.canonical.x/f-h.canonical.x)*u.dim,(i.canonical.y/f-h.canonical.y)*u.dim])}tileCoordToPixel(e,i){const o=i*this._scale+this._offset[1];return new Be(Math.floor(e*this._scale+this._offset[0]),Math.floor(o))}getElevationAt(e,i,o,a){const u=e*this._scale+this._offset[0],h=i*this._scale+this._offset[1],f=Math.floor(u),_=Math.floor(h),g=this._dem;return a=!!a,o?Ft(Ft(g.get(f,_,a),g.get(f,_+1,a),h-_),Ft(g.get(f+1,_,a),g.get(f+1,_+1,a),h-_),u-f):g.get(f,_,a)}getElevationAtPixel(e,i,o){return this._dem.get(e,i,!!o)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*U(1,e)*this._dem.stride}}const ag=new Float32Array(262144),Ac=new Uint8Array(262144);function Zv(r){let e=0;if(r.meshes)for(const i of r.meshes)e=Math.max(e,i.aabb.max[2]);if(r.children)for(const i of r.children)e=Math.max(e,Zv(i));return e}function Wv(r,e,i){if(r.meshes)for(const o of r.meshes){if(o.aabb.min[0]===1/0)continue;const a=ri.applyTransform(o.aabb,r.globalMatrix);i.insert(e,a.min[0],a.min[1],a.max[0],a.max[1])}if(r.children)for(const o of r.children)Wv(o,e,i)}const Xv=["","wall","door","roof","window","lamp","logo"];class Yv{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:Zv(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new ri([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new ri([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const o of this.node.meshes)this.node.lightMeshIndex!==e&&(o.transformedAabb=ri.applyTransformFast(o.aabb,this.node.globalMatrix),i.encapsulate(o.transformedAabb)),e++;this.aabb=i}return this.aabb}}class tm{constructor(e,i,o,a,u,h,f,_){this.id=o,this.layers=e,this.layerIds=this.layers.map((g=>g.fqid)),this.stateDependentLayerIds=this.layers.filter((g=>g.isStateDependent())).map((g=>g.id)),this.modelTraits|=Uu.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,a&&(this.modelTraits|=Uu.HasMapboxMeshFeatures),u&&(this.modelTraits|=Uu.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=h,this.worldview=_,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const g of i)this.nodesInfo.push(new Yv(g)),Wv(g,f.featureIndexArray.length,f.grid),f.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,f.bucketLayerIDs.length-1,0);this.states={},this.hasAppearances=null}updateFootprints(e,i){for(const o of this.getNodesInfo()){const a=o.node;a.footprint&&i.push({footprint:a.footprint,id:e})}}updateAppearances(e,i,o,a){}update(e){const i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;const o=i?this.stateDependentLayers:this.layers;if(!to(e,this.states))for(const a of o)this.evaluate(a,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const o of i){const a=o.node;this.uploaded?this.updatePbrBuffer(a):D_(a,e,!0)}for(const o of i)Fp(o.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const o of e.meshes)o.pbrBuffer&&(o.pbrBuffer.updateData(o.featureArray),i=!0);return i}needsReEvaluation(e,i,o){const a=e.transform.projectionOptions,u=e.style.getBrightness(),h=this.brightness!==u;if(!this.uploaded||this.dirty||a.name!==this.projection.name||tf(o.paint.get("model-color").value,h)||tf(o.paint.get("model-color-mix-intensity").value,h)||tf(o.paint.get("model-roughness").value,h)||tf(o.paint.get("model-emissive-strength").value,h)||tf(o.paint.get("model-height-based-emissive-strength-multiplier").value,h)){this.projection=a,this.brightness=u;const f=this.getNodesInfo();for(const _ of f)_.state=null;return!0}return!1}evaluateTransform(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const o=this.getNodesInfo(),a=this.id.canonical;for(const u of o){const h=u.feature;u.evaluatedTranslation=i.paint.get("model-translation").evaluate(h,{},a),u.evaluatedScale=i.paint.get("model-scale").evaluate(h,{},a)}}evaluate(e,i){const o=this.getNodesInfo();for(const a of o){if(!a.node.meshes)continue;const u=a.feature,h=i&&i[u.id];if(to(h,a.state))continue;a.state=structuredClone(h);const f=a.node.meshes&&a.node.meshes[0].featureData,_=a.evaluatedColor[2],g=a.evaluatedRMEA[2],v=this.id.canonical;if(a.hasTranslucentParts=!1,f){for(let b=0;b<Xv.length;b++){const w=Xv[b];w.length&&(u.properties.part=w);const I=e.paint.get("model-color").evaluate(u,h,v).toPremultipliedRenderColor(null),A=e.paint.get("model-color-mix-intensity").evaluate(u,h,v);a.evaluatedColor[b]=[I.r,I.g,I.b,A],a.evaluatedRMEA[b][0]=e.paint.get("model-roughness").evaluate(u,h,v),a.evaluatedRMEA[b][2]=e.paint.get("model-emissive-strength").evaluate(u,h,v),a.evaluatedRMEA[b][3]=I.a,a.emissionHeightBasedParams[b]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(u,h,v),!a.hasTranslucentParts&&I.a<1&&(a.hasTranslucentParts=!0)}delete u.properties.part,sT(a,_!==a.evaluatedColor[2]||g!==a.evaluatedRMEA[2],this.modelTraits)}else a.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(u,h,v);a.evaluatedTranslation=e.paint.get("model-translation").evaluate(u,h,v),a.evaluatedScale=e.paint.get("model-scale").evaluate(u,h,v),this.updatePbrBuffer(a.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,o,a){const u=e.findDEMTileFor(o);if(u&&(u.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(u.dem&&u.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=u.tileID.overscaledZ;const h=Yu.create(e,o,u);if(!h)return;this.modelTraits&Uu.HasMapboxMeshFeatures&&this.updateDEM(e,h,o,a);for(const f of this.getNodesInfo()){const _=f.node;if(!_.footprint||!_.footprint.vertices||!_.footprint.vertices.length)continue;const g=_.footprint.vertices;let v=h.getElevationAt(g[0].x,g[0].y,!0,!0);for(let b=1;b<g.length;b++)v=Math.min(v,h.getElevationAt(g[b].x,g[b].y,!0,!0));_.elevation=v}}this.terrainTile=u.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,o,a){let u=i._dem._modifiedForSources[a];if(u===void 0&&(i._dem._modifiedForSources[a]=[],u=i._dem._modifiedForSources[a]),u.includes(o.canonical))return;const h=i._dem.dim;u.push(o.canonical);let f=!1;for(const _ of this.getNodesInfo()){const g=_.node;if(!g.footprint||!g.footprint.grid)continue;const v=g.footprint.grid,b=i.tileCoordToPixel(v.min.x,v.min.y),w=i.tileCoordToPixel(v.max.x,v.max.y),I=Math.min(Math.min(h-w.y,b.x),Math.min(b.y,h-w.x));if(I<0)continue;const A=B(I,2,5);let P=Math.max(0,b.x-A),D=Math.max(0,b.y-A),L=Math.min(w.x+A,h-1),V=Math.min(w.y+A,h-1);for(let K=D;K<=V;++K)for(let oe=P;oe<=L;++oe)Ac[K*h+oe]=255;let j=0,H=0;for(let K=0;K<v.cellsY;++K)for(let oe=0;oe<v.cellsX;++oe){if(!v.cells[K*v.cellsX+oe])continue;const le=i.tileCoordToPixel(v.min.x+oe/v.xScale,v.min.y+K/v.yScale),ue=i.tileCoordToPixel(v.min.x+(oe+1)/v.xScale,v.min.y+(K+1)/v.yScale);for(let Me=le.y;Me<=Math.min(ue.y+1,h-1);++Me)for(let ye=le.x;ye<=Math.min(ue.x+1,h-1);++ye)Ac[Me*h+ye]===255&&(Ac[Me*h+ye]=0,j+=i.getElevationAtPixel(ye,Me),H++)}const te=j/H;P=Math.max(1,b.x-A),D=Math.max(1,b.y-A),L=Math.min(w.x+A,h-2),V=Math.min(w.y+A,h-2),f=!0;for(let K=D;K<=V;++K)for(let oe=P;oe<=L;++oe)Ac[K*h+oe]===0&&(ag[K*h+oe]=i._dem.set(oe,K,te));for(let K=1;K<A;++K){P=Math.max(1,b.x-K),D=Math.max(1,b.y-K),L=Math.min(w.x+K,h-2),V=Math.min(w.y+K,h-2);for(let oe=D;oe<=V;++oe)for(let le=P;le<=L;++le){const ue=oe*h+le;if(Ac[ue]===255){let Me=0,ye=0,Ce=-1,Oe=-1;for(let Ne=-1;Ne<=1;++Ne)for(let Ye=-1;Ye<=1;++Ye){const He=(oe+Ne)*h+le+Ye;if(Ac[He]>=K)continue;const Fe=ag[He],Ge=Math.abs(Fe);Ge>ye&&(Me=Fe,ye=Ge,Ce=Ye,Oe=Ne)}if(ye>.1){const Ne=1-(K+.5*Math.abs(Ce*Oe))/A;let Ye=i._dem.get(le,oe)+Me*Ne;const He=i._dem.get(le+Ce,oe+Oe),Fe=i._dem.get(le-Ce,oe-Oe,!0);(Ye-He)*(Ye-Fe)>0&&(Ye=(He+Fe)/2),ag[ue]=i._dem.set(le,oe,Ye),Ac[ue]=K}}}}}f&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=To.now())}setFilter(e){this.filter=e?gu(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter((e=>this.filter.filter(new lr(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical))):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)Fp(i.node),z_(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const o=i.getReplacementRegionsForTile(e.toUnwrapped());for(const a of this.getNodesInfo()){const u=a.node.footprint;a.hiddenByReplacement=!!u&&!o.find((h=>h.footprint===u))}}getHeightAtTileCoord(e,i){const o=[],a=[0,0,0],u=Dt([]);for(const h of this.getNodesInfo()){const f=h.node.meshes[0],_=f.transformedAabb;if(e<_.min[0]||i<_.min[1]||e>_.max[0]||i>_.max[1])continue;if(h.node.hidden===!0)return{height:1/0,maxHeight:h.feature.properties.height,hidden:!1,verticalScale:h.evaluatedScale[2]};Mi(u,h.node.globalMatrix),a[0]=e,a[1]=i,nr(a,a,u);const g=(a[0]-f.aabb.min[0])/(f.aabb.max[0]-f.aabb.min[0])*Sc|0,v=Math.min(63,(a[1]-f.aabb.min[1])/(f.aabb.max[1]-f.aabb.min[1])*Sc|0)*Sc+Math.min(63,g),b=f.heightmap[v];if(!(b<0&&h.node.footprint))return h.hiddenByReplacement?void 0:{height:b,maxHeight:h.feature.properties.height,hidden:!1,verticalScale:h.evaluatedScale[2]};if(h.node.footprint.grid.query(new Be(e,i),new Be(e,i),o),o.length>0)return{height:void 0,maxHeight:h.feature.properties.height,hidden:h.hiddenByReplacement,verticalScale:h.evaluatedScale[2]}}}}function tf(r,e){return r instanceof cc&&!r.isLightConstant&&e}function oT(r,e,i,o,a,u,h,f){let _=(61440&e|(61440&e)>>4)>>8,g=(3840&e|(3840&e)>>4)>>4,v=240&e|(240&e)>>4;i[3]>0&&(_=Ft(_,255*i[0],i[3]),g=Ft(g,255*i[1],i[3]),v=Ft(v,255*i[2],i[3]));const b=_<<8|g,w=v<<8|Math.floor(255*o[3]),I=(function(K){const oe=B(K,0,2);return Math.min(Math.round(.5*oe*255),255)})(o[2])<<8|15*o[0]<<4|15*o[1],A=B(a[0],0,1),P=B(a[1],0,1),D=B(a[2],0,1),L=B(a[3],0,1);let V,j,H,te;if(A!==P&&h!==u&&P!==A){const K=h-u;j=1/(K*(P-A)),H=-(u+K*A)/(K*(P-A));const oe=B(a[4],-1,1);te=Math.pow(10,oe),V=255*D<<8|255*L}else V=65535,j=0,H=1,te=1;if(r.emplaceBack(b,w,I,V,j,H,te),f){const K=f.length;f.clear();for(let oe=0;oe<K;oe++)f.emplaceBack(b,w,I,V,j,H,te)}}function sT(r,e,i){const o=r.node;let a=0;const u=i&Uu.HasMeshoptCompression;for(const h of o.meshes){if(o.lights&&o.lightMeshIndex===a||!h.featureData)continue;h.featureArray=new gl,h.featureArray.reserve(h.featureData.length);let f=e;for(const _ of h.featureData){const g=u?65535&_:_>>16&65535,v=u?_>>16&65535:65535&_,b=(15&v)<8?15&v:0,w=r.evaluatedRMEA[b],I=r.evaluatedColor[b],A=r.emissionHeightBasedParams[b];let P;if(f&&b===2&&o.lights&&(P=new gl,P.resize(10*o.lights.length)),oT(h.featureArray,g,I,w,A,h.aabb.min[2],h.aabb.max[2],P),P&&f){f=!1;const D=o.meshes[o.lightMeshIndex];D.featureArray=P,D.featureArray._trim()}}h.featureArray._trim(),a++}}pt(tm,"Tiled3dModelBucket",{omit:["layers"]}),pt(Yv,"Tiled3dModelFeature");const aT=["id","tile","layer","source","sourceLayer","state"];class Mc{constructor(e,i,o,a,u){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=o,this._y=a,this.properties=e?e.properties:{},this.id=u}clone(){const e=new Mc(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&this._vectorTileFeature&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const i of aT)this[i]!==void 0&&(e[i]=this[i]);return e}}class Cc extends Ds{constructor(e,i,o,a){super(),this.id=e,this.type="model",this.models=[],this._loaded=!1,this._options=i,this._modelsInfo=new Map}load(){const e=[];for(const i in this._options.models){const o=this._options.models[i],a=this._modelsInfo.get(i);if(a){const u=a.model;u.position=o.position!=null?new M(o.position[0],o.position[1]):new M(0,0),u.orientation=o.orientation!=null?o.orientation:[0,0,0],a.modelSpec=o,Cc.applyModelSpecification(u,o),u.computeBoundsAndApplyParent(),this.models.push(u)}else{const u=mx(this.map._requestManager.transformRequest(o.uri,_a.Model).url).then((h=>{if(!h)return;const f=O_(h),_=new vx(i,o.uri,o.position,o.orientation,f);Cc.applyModelSpecification(_,o),_.computeBoundsAndApplyParent(),this.models.push(_),this._modelsInfo.set(i,{modelSpec:o,model:_})})).catch((h=>{this.fire(new jl(new Error("Could not load model ".concat(i," from ").concat(o.uri,": ").concat(h.message))))}));e.push(u)}}Promise.allSettled(e).then((()=>{this._loaded=!0,this.fire(new Do("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((i=>{this._loaded=!0,this.fire(new jl(new Error("Could not load models: ".concat(i.message))))}))}static applyModelSpecification(e,i){i.nodeOverrides&&Cc.convertNodeOverrides(e,i.nodeOverrides),i.materialOverrides&&Cc.convertMaterialOverrides(e,i.materialOverrides),i.nodeOverrideNames&&(e.nodeOverrideNames=[...i.nodeOverrideNames]),i.materialOverrideNames&&(e.materialOverrideNames=[...i.materialOverrideNames]),i.featureProperties&&(e.featureProperties=i.featureProperties)}static convertNodeOverrides(e,i){if(Array.isArray(i)&&i.every((o=>typeof o=="string"))){e.nodeOverrideNames=[];for(const o of i)e.nodeOverrideNames.push(o)}else Object.entries(i).forEach((([o,a])=>{const u={orientation:[0,0,0]};if(a.hasOwnProperty("orientation")){const h=a.orientation;h&&(u.orientation=h)}e.nodeOverrides.set(o,u)}))}static convertMaterialOverrides(e,i){if(Array.isArray(i)&&i.every((o=>typeof o=="string"))){e.materialOverrideNames=[];for(const o of i)e.materialOverrideNames.push(o)}else Object.entries(i).forEach((([o,a])=>{const u={color:new Ui(1,1,1),colorMix:0,emissionStrength:0,opacity:1},h=a["model-color"];h!==void 0&&(u.color.r=h[0],u.color.g=h[1],u.color.b=h[2]);const f=a["model-color-mix-intensity"];f!==void 0&&(u.colorMix=f);const _=a["model-emissive-strength"];_!==void 0&&(u.emissionStrength=_);const g=a["model-opacity"];g!==void 0&&(u.opacity=g),e.materialOverrides.set(o,u)}))}onAdd(e){this.map=e,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(e,i){}serialize(){return this._options}setProperty(e,i){return!1}reload(){const e=Ca(this.id,this.scope);this.map.style.clearSource(e),this.models=[],this._modelsInfo.clear(),this._loaded=!1,this.load()}setModels(e){this.models=[];const i=new Map;for(const o in e){const a=e[o];if(this._modelsInfo.has(o)){const u=this._modelsInfo.get(o);u&&u.modelSpec.uri===a.uri&&i.set(o,u)}}this._modelsInfo=i,this._options.models=e,this._loaded=!1,this.load()}}function lg(r,e,i,o){const a=1<<r.z;e.lat=G((o/Je+r.y)/a),e.lng=$((i/Je+r.x)/a)}function lT(r,e,i,o){const a=r.getNodesInfo()[e];if(!a||a.hiddenByReplacement||!a.node.meshes)return;let u=Number.MAX_VALUE;const h=a.node,f=i.tile,_=o.calculatePosMatrix(f.tileID.toUnwrapped(),o.worldSize),g=a.evaluatedScale;let v=0;o.elevation&&h.elevation&&(v=h.elevation*o.elevation.exaggeration()),wi(_,_,[(h.anchor?h.anchor[0]:0)*(g[0]-1),(h.anchor?h.anchor[1]:0)*(g[1]-1),v]),Ci(_,_,g);const b=i.queryGeometry,w=b.isPointQuery()?b.screenBounds:b.screenGeometry,I=function(P){const D=Yt([],_,P.globalMatrix);Yt(D,o.expandedFarZProjMatrix,D);for(let L=0;L<P.meshes.length;++L){const V=P.meshes[L];if(L===P.lightMeshIndex)continue;const j=R_(w,o,D,V.aabb);j!=null&&(u=Math.min(j,u))}if(P.children)for(const L of P.children)I(L)};if(I(h),u===Number.MAX_VALUE)return;const A=new M(0,0);return lg(f.tileID.canonical,A,a.node.anchor[0],a.node.anchor[1]),{intersectionZ:u,position:A,feature:a.feature}}const cT={circle:class extends Kn{constructor(r,e,i,o){super(r,{layout:Gs||(Gs=new kr({"circle-sort-key":new lt(ge.layout_circle["circle-sort-key"]),"circle-elevation-reference":new qe(ge.layout_circle["circle-elevation-reference"]),visibility:new qe(ge.layout_circle.visibility)})),paint:vl||(vl=new kr({"circle-radius":new lt(ge.paint_circle["circle-radius"]),"circle-color":new lt(ge.paint_circle["circle-color"]),"circle-blur":new lt(ge.paint_circle["circle-blur"]),"circle-opacity":new lt(ge.paint_circle["circle-opacity"]),"circle-translate":new qe(ge.paint_circle["circle-translate"]),"circle-translate-anchor":new qe(ge.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new qe(ge.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new qe(ge.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new lt(ge.paint_circle["circle-stroke-width"]),"circle-stroke-color":new lt(ge.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new lt(ge.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new qe(ge.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}createBucket(r){return new wr(r)}queryRadius(r){const e=r;return Tn("circle-radius",this,e)+Tn("circle-stroke-width",this,e)+zr(this.paint.get("circle-translate"))}queryIntersectsFeature(r,e,i,o,a,u,h,f){const _=xl(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),g=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return iy(r,o,u,h,f,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",_,g)}getProgramIds(){return["circle"]}getDefaultProgramParams(r,e,i){const o=ty(this);return{config:new js(this,{zoom:e,lut:i}),defines:o,overrideFog:!1}}is3D(r){return!r&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends Kn{createBucket(r){return new ny(r)}constructor(r,e,i,o){super(r,{layout:oy||(oy=new kr({visibility:new qe(ge.layout_heatmap.visibility)})),paint:sy||(sy=new kr({"heatmap-radius":new lt(ge.paint_heatmap["heatmap-radius"]),"heatmap-weight":new lt(ge.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new qe(ge.paint_heatmap["heatmap-intensity"]),"heatmap-color":new al(ge.paint_heatmap["heatmap-color"]),"heatmap-opacity":new qe(ge.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Td({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(r){return Tn("heatmap-radius",this,r)}queryIntersectsFeature(r,e,i,o,a,u,h,f){const _=this.paint.get("heatmap-radius").evaluate(e,i);return iy(r,o,u,h,f,!0,!0,new Be(0,0),_)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(r,e,i){return r==="heatmap"?{config:new js(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends Kn{constructor(r,e,i,o){super(r,{layout:ay||(ay=new kr({visibility:new qe(ge.layout_hillshade.visibility)})),paint:ly||(ly=new kr({"hillshade-illumination-direction":new qe(ge.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new qe(ge.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new qe(ge.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new qe(ge.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new qe(ge.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new qe(ge.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new qe(ge.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}},fill:class extends Kn{constructor(r,e,i,o){super(r,{layout:Ty||(Ty=new kr({"fill-sort-key":new lt(ge.layout_fill["fill-sort-key"]),visibility:new qe(ge.layout_fill.visibility),"fill-elevation-reference":new qe(ge.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new lt(ge.layout_fill["fill-construct-bridge-guard-rail"])})),paint:Sy||(Sy=new kr({"fill-antialias":new qe(ge.paint_fill["fill-antialias"]),"fill-opacity":new lt(ge.paint_fill["fill-opacity"]),"fill-color":new lt(ge.paint_fill["fill-color"]),"fill-outline-color":new lt(ge.paint_fill["fill-outline-color"]),"fill-translate":new qe(ge.paint_fill["fill-translate"]),"fill-translate-anchor":new qe(ge.paint_fill["fill-translate-anchor"]),"fill-pattern":new lt(ge.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new qe(ge.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new qe(ge.paint_fill["fill-emissive-strength"]),"fill-z-offset":new lt(ge.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new lt(ge.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new lt(ge.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}getProgramIds(){const r=this.paint.get("fill-pattern"),e=r&&r.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(r,e,i){return{config:new js(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(r,e){super.recalculate(r,e);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(r){return new p_(r)}queryRadius(){return zr(this.paint.get("fill-translate"))}queryIntersectsFeature(r,e,i,o,a,u){return!r.queryGeometry.isAboveHorizon&&Br(No(r.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),o)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(r){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return r!=null?e&&!r:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends Kn{constructor(r,e,i,o){super(r,{layout:Xy||(Xy=new kr({visibility:new qe(ge["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new qe(ge["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:Yy||(Yy=new kr({"fill-extrusion-opacity":new qe(ge["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new lt(ge["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new qe(ge["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new qe(ge["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new lt(ge["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new qe(ge["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new lt(ge["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new lt(ge["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new qe(ge["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new qe(ge["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new qe(ge["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new qe(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new qe(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new qe(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new qe(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new qe(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new qe(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new qe(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new lt(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new lt(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new qe(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new qe(ge["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new qe(ge["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new qe(ge["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new lt(ge["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new lt(ge["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new qe(ge["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Ip(r)}queryRadius(){return zr(this.paint.get("fill-extrusion-translate"))}is3D(r){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(r,e,i,o,a,u,h,f,_){const g=xl(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),v=this.paint.get("fill-extrusion-height").evaluate(e,i),b=this.paint.get("fill-extrusion-base").evaluate(e,i),w=[0,0],I=f&&u.elevation,A=u.elevation?u.elevation.exaggeration():1,P=r.tile.getBucket(this);if(I&&P instanceof Ip){const H=P.centroidVertexArray,te=_+1;te<H.length&&(w[0]=H.geta_centroid_pos0(te),w[1]=H.geta_centroid_pos1(te))}if(w[0]===0&&w[1]===1)return!1;u.projection.name==="globe"&&(o=Wy([o],[new Be(0,0),new Be(Je,Je)],r.tileID.canonical).map((H=>H.polygon)).flat());const D=I?f:null,[L,V]=rx(u,o,b,v,g,h,D,w,A,u.center.lat,r.tileID.canonical),j=r.queryGeometry;return ix(L,V,j.isPointQuery()?j.screenBounds:j.screenGeometry)}},building:class extends Kn{constructor(r,e,i,o){super(r,{layout:Mx||(Mx=new kr({visibility:new qe(ge.layout_building.visibility),"building-facade":new lt(ge.layout_building["building-facade"]),"building-facade-floors":new lt(ge.layout_building["building-facade-floors"]),"building-facade-unit-width":new lt(ge.layout_building["building-facade-unit-width"]),"building-facade-window":new lt(ge.layout_building["building-facade-window"]),"building-roof-shape":new lt(ge.layout_building["building-roof-shape"]),"building-height":new lt(ge.layout_building["building-height"]),"building-base":new lt(ge.layout_building["building-base"]),"building-flood-light-wall-radius":new lt(ge.layout_building["building-flood-light-wall-radius"]),"building-flood-light-ground-radius":new lt(ge.layout_building["building-flood-light-ground-radius"]),"building-flip-roof-orientation":new lt(ge.layout_building["building-flip-roof-orientation"])})),paint:Cx||(Cx=new kr({"building-opacity":new qe(ge.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new qe(ge.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new qe(ge.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new qe(ge.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new qe(ge.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new qe(ge.paint_building["building-vertical-scale"]),"building-cast-shadows":new qe(ge.paint_building["building-cast-shadows"]),"building-color":new lt(ge.paint_building["building-color"]),"building-emissive-strength":new lt(ge.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new qe(ge.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new qe(ge.paint_building["building-cutoff-fade-range"]),"building-flood-light-color":new qe(ge.paint_building["building-flood-light-color"]),"building-flood-light-intensity":new qe(ge.paint_building["building-flood-light-intensity"]),"building-flood-light-ground-attenuation":new qe(ge.paint_building["building-flood-light-ground-attenuation"]),"building-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"building-flood-light-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Ax(r)}cutoffRange(){return this.paint.get("building-cutoff-fade-range")}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(r){return!0}queryRadius(r){return 0}queryIntersectsFeature(r,e,i,o,a,u,h,f,_){let g=this.layout.get("building-height").evaluate(e,i);const v=this.layout.get("building-base").evaluate(e,i),b=r.tile.getBucket(this).getFootprint(e);if(b){if(b.hiddenFlags!==0)return!1;g=b.height}const[w,I]=rx(u,o,v,g,new Be(0,0),h,null,[0,0],1,u.center.lat,r.tileID.canonical),A=r.queryGeometry;return ix(w,I,A.isPointQuery()?A.screenBounds:A.screenGeometry)}},line:class extends Kn{constructor(r,e,i,o){const a=Nx();super(r,a,e,i,o),a.layout&&(this.layout=new Ma(a.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(r){if(r==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof rc,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(r,e){super.recalculate(r,e),this.paint._values["line-floorwidth"]=(()=>{if(Vd)return Vd;const i=Nx();return Vd=new ow(i.paint.properties["line-width"].specification),Vd.useIntegerZoom=!0,Vd})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,r)}createBucket(r){return new k_(r)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(r,e,i){const o=kx(this);return{config:new js(this,{zoom:e,lut:i}),defines:o,overrideFog:!1}}queryRadius(r){const e=r,i=Vx(Tn("line-width",this,e),Tn("line-gap-width",this,e)),o=Tn("line-offset",this,e);return i/2+Math.abs(o)+zr(this.paint.get("line-translate"))}queryIntersectsFeature(r,e,i,o,a,u){if(r.queryGeometry.isAboveHorizon)return!1;const h=No(r.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),f=r.pixelToTileUnitsFactor/2*Vx(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),_=this.paint.get("line-offset").evaluate(e,i);return _&&(o=(function(g,v){const b=[],w=new Be(0,0);for(let I=0;I<g.length;I++){const A=g[I],P=[];for(let D=0;D<A.length;D++){const L=A[D],V=A[D+1],j=D===0?w:L.sub(A[D-1])._unit()._perp(),H=D===A.length-1?w:V.sub(L)._unit()._perp(),te=j._add(H)._unit();te._mult(1/(te.x*H.x+te.y*H.y)),P.push(te._mult(v)._add(L))}b.push(P)}return b})(o,_*r.pixelToTileUnitsFactor)),(function(g,v,b){for(let w=0;w<v.length;w++){const I=v[w];if(g.length>=3){for(let A=0;A<I.length;A++)if(wn(g,I[A]))return!0}if(go(g,I,b))return!0}return!1})(h,o,f)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(r){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:Kp,background:class extends Kn{constructor(r,e,i,o){super(r,{layout:Cv||(Cv=new kr({visibility:new qe(ge.layout_background.visibility)})),paint:Pv||(Pv=new kr({"background-pitch-alignment":new qe(ge.paint_background["background-pitch-alignment"]),"background-color":new qe(ge.paint_background["background-color"]),"background-pattern":new qe(ge.paint_background["background-pattern"]),"background-opacity":new qe(ge.paint_background["background-opacity"]),"background-emissive-strength":new qe(ge.paint_background["background-emissive-strength"]),"background-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}is3D(r){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:Ov,"raster-particle":Uv,sky:class extends Kn{constructor(r,e,i,o){super(r,{layout:Bv||(Bv=new kr({visibility:new qe(ge.layout_sky.visibility)})),paint:Nv||(Nv=new kr({"sky-type":new qe(ge.paint_sky["sky-type"]),"sky-atmosphere-sun":new qe(ge.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new qe(ge.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new qe(ge.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new qe(ge.paint_sky["sky-gradient-radius"]),"sky-gradient":new al(ge.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new qe(ge.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new qe(ge.paint_sky["sky-atmosphere-color"]),"sky-opacity":new qe(ge.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(r){r==="sky-gradient"?this._updateColorRamp():r!=="sky-atmosphere-sun"&&r!=="sky-atmosphere-halo-color"&&r!=="sky-atmosphere-color"&&r!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Td({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(r){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=r.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(r,e){if(this.paint.get("sky-type")==="atmosphere"){const o=this.paint.get("sky-atmosphere-sun"),a=!o,u=r.style.light,h=u.properties.get("position");return a&&u.properties.get("anchor")==="viewport"&&Mt("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),a?ng(h.azimuthal,90-h.polar,e):ng(o[0],90-o[1],e)}const i=this.paint.get("sky-gradient-center");return ng(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(r){this._skyboxInvalidated=!1,this._lightPosition=r.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const r=this.paint.get("sky-type");return r==="atmosphere"?["skyboxCapture","skybox"]:r==="gradient"?["skyboxGradient"]:null}},slot:class extends Kn{constructor(r,e,i,o){super(r,{paint:Vv||(Vv=new kr({}))},e,null)}},model:class extends Kn{constructor(r,e,i,o){super(r,{layout:qv||(qv=new kr({visibility:new qe(ge.layout_model.visibility),"model-id":new lt(ge.layout_model["model-id"])})),paint:$v||($v=new kr({"model-opacity":new lt(ge.paint_model["model-opacity"]),"model-rotation":new lt(ge.paint_model["model-rotation"]),"model-scale":new lt(ge.paint_model["model-scale"]),"model-translation":new lt(ge.paint_model["model-translation"]),"model-color":new lt(ge.paint_model["model-color"]),"model-color-mix-intensity":new lt(ge.paint_model["model-color-mix-intensity"]),"model-type":new qe(ge.paint_model["model-type"]),"model-cast-shadows":new qe(ge.paint_model["model-cast-shadows"]),"model-receive-shadows":new qe(ge.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new qe(ge.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new lt(ge.paint_model["model-emissive-strength"]),"model-roughness":new lt(ge.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new lt(ge.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new qe(ge.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new qe(ge.paint_model["model-front-cutoff"]),"model-elevation-reference":new qe(ge.paint_model["model-elevation-reference"]),"model-color-use-theme":new lt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this.layer=r,this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new sg(r)}getProgramIds(){return["model"]}is3D(r){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(r){return r instanceof tm?Je-1:0}queryRenderedFeatures(r,e,i){const o=e.getSource();if(!(o&&o instanceof Cc))return{};const a=o,u={};u[this.id]=[];const h=u[this.id];let f=0;for(const _ of a.models){const g=e.getFeatureState(this.sourceLayer,_.id),v={type:"Unknown",id:_.id,properties:_.featureProperties},b=this.paint.get("model-rotation").evaluate(v,g),w=this.paint.get("model-scale").evaluate(v,g),I=this.paint.get("model-translation").evaluate(v,g),A=this.paint.get("model-elevation-reference");let P=[];Op(P,_,i,_.position,b,w,I,A==="ground",A==="ground",!1),i.projection.name==="globe"&&(P=Lp(P,i));const D=Yt([],i.projMatrix,P),L=R_(r.isPointQuery()?r.screenBounds:r.screenGeometry,i,D,_.aabb);if(L!=null){const V=new Mc(void 0,0,0,0,_.id);V.layer=this.layer,V.properties=structuredClone(_.featureProperties),V.properties.layer=this.id,V.properties.uri=_.uri,V.properties.orientation=_.orientation,V.sourceLayer=this.sourceLayer,V.geometry={type:"Point",coordinates:[_.position.lng,_.position.lat]},V.state=g,V.source=this.source,h.push({featureIndex:f,feature:V,intersectionZ:L})}++f}return u}queryIntersectsFeature(r,e,i,o,a,u){if(!this.modelManager)return!1;const h=this.modelManager,f=r.tile.getBucket(this);if(!(f&&f instanceof sg))return!1;for(const _ in f.instancesPerModel){const g=f.instancesPerModel[_],v=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(g.idToFeaturesIndex.hasOwnProperty(v)){const b=g.features[g.idToFeaturesIndex[v]],w=h.getModel(_,this.scope);if(!w)return!1;let I=[];const A=new M(0,0),P=f.canonical;let D=Number.MAX_VALUE;for(let L=0;L<b.instancedDataCount;++L){const V=16*(b.instancedDataOffset+L),j=g.instancedDataArray.float32,H=[j[V+4],j[V+5],j[V+6]];lg(P,A,Math.floor(j[V]),Math.floor(j[V+1])),Op(I,w,u,A,b.rotation,b.scale,H,!1,!1,!1),u.projection.name==="globe"&&(I=Lp(I,u));const te=Yt([],u.projMatrix,I),K=r.queryGeometry,oe=R_(K.isPointQuery()?K.screenBounds:K.screenGeometry,u,te,w.aabb);oe!=null&&(D=Math.min(oe,D))}return D!==Number.MAX_VALUE&&D}}return!1}_handleOverridablePaintPropertyUpdate(r,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||r!=="model-color"&&r!=="model-color-mix-intensity"&&r!=="model-rotation"&&r!=="model-scale"&&r!=="model-translation"&&r!=="model-emissive-strength")}_isPropertyZoomDependent(r){const e=this._transitionablePaint._values[r];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof ia}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends Kn{constructor(r,e,i,o){super(r,{layout:Ey||(Ey=new kr({"clip-layer-types":new qe(ge.layout_clip["clip-layer-types"]),"clip-layer-scope":new qe(ge.layout_clip["clip-layer-scope"])})),paint:Iy||(Iy=new kr({}))},e,i,o)}recalculate(r,e){super.recalculate(r,e)}createBucket(r){return new Ay(r)}is3D(r){return!0}}},cg=new Ui(0,0,0),ug={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},hg={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},im={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},uT={PAINT_ORDER_FILL_AND_STROKE:1},rf={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},Kv={MASK_TYPE_LUMINANCE:1};function hT(r,e,i){r===1&&e.icons.push((function(o,a){return(function(u){if(u.usvg_tree.height||(u.usvg_tree.height=u.usvg_tree.width),!u.metadata)return u;const{metadata:h}=u;if(h.content_area){const{content_area:f}=h;f.left==null&&(f.left=0),f.top==null&&(f.top=f.left),f.width==null&&(f.width=u.usvg_tree.width),f.height==null&&(f.height=f.width)}if(h.text_placeholder){const{text_placeholder:f}=h;f.top==null&&(f.top=f.left),f.height==null&&(f.height=f.width)}return h.stretch_x&&h.stretch_x.length&&Jv(h,"x"),h.stretch_y&&h.stretch_y.length&&Jv(h,"y"),u})(o.readFields(dT,{name:void 0},a))})(i,i.readVarint()+i.pos))}function Jv(r,e){const i=[],o=r["stretch_".concat(e)];let a=null;for(let u=0;u<o.length;u++)a===null?a=i.length===0?o[0]:i[i.length-1][1]+o[u]:(i.push([a,a+o[u]]),a=null);r["stretch_".concat(e,"_areas")]=i}function dT(r,e,i){r===1?e.name=i.readString():r===2?e.metadata=(function(o,a){return o.readFields(fT,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},a)})(i,i.readVarint()+i.pos):r===3&&(e.usvg_tree=(function(o,a){return o.readFields(_T,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},a)})(i,i.readVarint()+i.pos),e.data="usvg_tree")}function fT(r,e,i){r===1?e.stretch_x=i.readPackedVarint():r===2?e.stretch_y=i.readPackedVarint():r===3?e.content_area=Qv(i,i.readVarint()+i.pos):r===4?e.variables.push((function(o,a){return o.readFields(mT,{name:void 0},a)})(i,i.readVarint()+i.pos)):r===5&&(e.text_placeholder=Qv(i,i.readVarint()+i.pos))}function Qv(r,e){return r.readFields(pT,{},e)}function pT(r,e,i){r===1?e.left=i.readVarint():r===2?e.width=i.readVarint():r===3?e.top=i.readVarint():r===4&&(e.height=i.readVarint())}function mT(r,e,i){r===1?e.name=i.readString():r===2&&(e.rgb_color=om(i.readVarint()),e.value="rgb_color")}function _T(r,e,i){r===1?e.width=e.height=i.readVarint():r===2?e.height=i.readVarint():r===3?e.children.push(rm(i,i.readVarint()+i.pos)):r===4?e.linear_gradients.push((function(o,a){return o.readFields(TT,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},a)})(i,i.readVarint()+i.pos)):r===5?e.radial_gradients.push((function(o,a){return o.readFields(ET,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},a)})(i,i.readVarint()+i.pos)):r===7?e.clip_paths.push((function(o,a){return o.readFields(IT,{children:[]},a)})(i,i.readVarint()+i.pos)):r===8&&e.masks.push((function(o,a){const u=o.readFields(AT,{left:0,width:20,mask_type:Kv.MASK_TYPE_LUMINANCE,children:[]},a);return u.height==null&&(u.height=u.width),u.top==null&&(u.top=u.left),u})(i,i.readVarint()+i.pos))}function rm(r,e){return r.readFields(gT,{},e)}function gT(r,e,i){r===1?(e.group=(function(o,a){return o.readFields(yT,{opacity:255,children:[]},a)})(i,i.readVarint()+i.pos),e.node="group"):r===2&&(e.path=(function(o,a){return o.readFields(vT,{paint_order:1,commands:[],step:1,diffs:[],rule:ug.PATH_RULE_NON_ZERO},a)})(i,i.readVarint()+i.pos),e.node="path")}function yT(r,e,i){r===1?e.transform=nm(i,i.readVarint()+i.pos):r===2?e.opacity=i.readVarint():r===5?e.clip_path_idx=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(rm(i,i.readVarint()+i.pos))}function nm(r,e){return r.readFields(xT,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function xT(r,e,i){r===1?e.sx=i.readFloat():r===2?e.ky=i.readFloat():r===3?e.kx=i.readFloat():r===4?e.sy=i.readFloat():r===5?e.tx=i.readFloat():r===6&&(e.ty=i.readFloat())}function vT(r,e,i){r===1?e.fill=(function(o,a){return o.readFields(bT,{rgb_color:cg,paint:"rgb_color",opacity:255},a)})(i,i.readVarint()+i.pos):r===2?e.stroke=(function(o,a){return o.readFields(wT,{rgb_color:cg,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},a)})(i,i.readVarint()+i.pos):r===3?e.paint_order=i.readVarint():r===5?i.readPackedVarint(e.commands):r===6?e.step=i.readFloat():r===7?i.readPackedSVarint(e.diffs):r===8&&(e.rule=i.readVarint())}function bT(r,e,i){r===1?(e.rgb_color=om(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5&&(e.opacity=i.readVarint())}function om(r){return new Ui((r>>16&255)/255,(r>>8&255)/255,(255&r)/255,1)}function wT(r,e,i){r===1?(e.rgb_color=om(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5?i.readPackedFloat(e.dasharray):r===6?e.dashoffset=i.readFloat():r===7?e.miterlimit=i.readFloat():r===8?e.opacity=i.readVarint():r===9?e.width=i.readFloat():r===10?e.linecap=i.readVarint():r===11&&(e.linejoin=i.readVarint())}function TT(r,e,i){r===1?e.transform=nm(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(e0(i,i.readVarint()+i.pos)):r===4?e.x1=i.readFloat():r===5?e.y1=i.readFloat():r===6?e.x2=i.readFloat():r===7&&(e.y2=i.readFloat())}function e0(r,e){return r.readFields(ST,{offset:0,opacity:255,rgb_color:cg},e)}function ST(r,e,i){r===1?e.offset=i.readFloat():r===2?e.opacity=i.readVarint():r===3&&(e.rgb_color=om(i.readVarint()))}function ET(r,e,i){r===1?e.transform=nm(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(e0(i,i.readVarint()+i.pos)):r===4?e.cx=i.readFloat():r===5?e.cy=i.readFloat():r===6?e.r=i.readFloat():r===7?e.fx=i.readFloat():r===8?e.fy=i.readFloat():r===9&&(e.fr=i.readFloat())}function IT(r,e,i){r===1?e.transform=nm(i,i.readVarint()+i.pos):r===2?e.clip_path_idx=i.readVarint():r===3&&e.children.push(rm(i,i.readVarint()+i.pos))}function AT(r,e,i){r===1?e.left=e.top=i.readFloat():r===2?e.width=e.height=i.readFloat():r===3?e.top=i.readFloat():r===4?e.height=i.readFloat():r===5?e.mask_type=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(rm(i,i.readVarint()+i.pos))}class MT{static calculate(e={},i=[]){const o=new Map,a=new Map;if(Object.keys(e).length===0)return o;i.forEach((u=>{a.set(u.name,u.rgb_color||new Ui(0,0,0))}));for(const[u,h]of Object.entries(e))a.has(u)?o.set(a.get(u).toString(),h):console.warn('Ignoring unknown image variable "'.concat(u,'"'));return o}}function Ku(r,e=255,i){const o=e/255,a=r.toString(),u=i.has(a)?i.get(a).clone():r.clone();return u.a*=o,u.toString()}function nf(r,e){if(!wo()){const i=document.createElement("canvas");return i.width=r,i.height=e,i}return new OffscreenCanvas(r,e)}function CT(r,e){const i=MT.calculate(e.params,r.metadata?r.metadata.variables:[]),o=r.usvg_tree,a=o.width,u=o.height,h=e.transform?e.transform:new DOMMatrix,f=Math.max(1,Math.round(a*h.a)),_=Math.max(1,Math.round(u*h.d)),g=new DOMMatrix([f/a,0,0,_/u,0,0]),v=nf(f,_).getContext("2d");return dg(v,g,o,o,i),v.getImageData(0,0,f,_)}function dg(r,e,i,o,a){for(const u of o.children)t0(r,e,i,u,a)}function t0(r,e,i,o,a){o.group?(r.save(),(function(u,h,f,_,g){const v=_.mask_idx!=null?f.masks[_.mask_idx]:null,b=_.clip_path_idx!=null?f.clip_paths[_.clip_path_idx]:null;if(_.transform&&(h=Ju(_.transform).preMultiplySelf(h)),!(function(A,P,D){return A.opacity!==255||P||D})(_,b!=null,v!=null))return void dg(u,h,f,_,g);const w=nf(u.canvas.width,u.canvas.height),I=w.getContext("2d");dg(I,h,f,_,g),b&&l0(I,h,f,b),v&&c0(I,h,f,v,g),u.globalAlpha=_.opacity/255,u.drawImage(w,0,0)})(r,e,i,o.group,a),r.restore()):o.path&&(r.save(),(function(u,h,f,_,g){u.setTransform(h),_.paint_order===uT.PAINT_ORDER_FILL_AND_STROKE?(i0(u,f,_,g),n0(u,f,_,g)):(n0(u,f,_,g),i0(u,f,_,g))})(r,e,i,o.path,a),r.restore())}function i0(r,e,i,o){const a=i.fill;if(!a)return;const u=a.opacity/255;switch(r.save(),r.beginPath(),u0(i,r),a.paint){case"rgb_color":r.fillStyle=Ku(a.rgb_color,a.opacity,o);break;case"linear_gradient_idx":{const h=e.linear_gradients[a.linear_gradient_idx];h.transform&&r.setTransform(Ju(h.transform).preMultiplySelf(r.getTransform())),r.fillStyle=o0(r,h,u,o);break}case"radial_gradient_idx":{const h=e.radial_gradients[a.radial_gradient_idx];h.transform&&r.setTransform(Ju(h.transform).preMultiplySelf(r.getTransform())),r.fillStyle=s0(r,h,u,o)}}r.fill(r0(i)),r.restore()}function r0(r){return r.rule===ug.PATH_RULE_NON_ZERO?"nonzero":r.rule===ug.PATH_RULE_EVEN_ODD?"evenodd":void 0}function n0(r,e,i,o){const a=i.stroke;if(!a)return;const u=h0(i);r.lineWidth=a.width,r.miterLimit=a.miterlimit,r.setLineDash(a.dasharray),r.lineDashOffset=a.dashoffset;const h=a.opacity/255;switch(a.paint){case"rgb_color":r.strokeStyle=Ku(a.rgb_color,a.opacity,o);break;case"linear_gradient_idx":r.strokeStyle=o0(r,e.linear_gradients[a.linear_gradient_idx],h,o,!0);break;case"radial_gradient_idx":r.strokeStyle=s0(r,e.radial_gradients[a.radial_gradient_idx],h,o,!0)}switch(a.linejoin){case im.LINE_JOIN_MITER_CLIP:case im.LINE_JOIN_MITER:r.lineJoin="miter";break;case im.LINE_JOIN_ROUND:r.lineJoin="round";break;case im.LINE_JOIN_BEVEL:r.lineJoin="bevel"}switch(a.linecap){case hg.LINE_CAP_BUTT:r.lineCap="butt";break;case hg.LINE_CAP_ROUND:r.lineCap="round";break;case hg.LINE_CAP_SQUARE:r.lineCap="square"}r.stroke(u)}function o0(r,e,i,o,a=!1){if(e.stops.length===1){const w=e.stops[0];return Ku(w.rgb_color,w.opacity*i,o)}const{x1:u,y1:h,x2:f,y2:_}=e;let g=new DOMPoint(u,h),v=new DOMPoint(f,_);if(a){const w=Ju(e.transform);g=w.transformPoint(g),v=w.transformPoint(v)}const b=r.createLinearGradient(g.x,g.y,v.x,v.y);for(const w of e.stops)b.addColorStop(w.offset,Ku(w.rgb_color,w.opacity*i,o));return b}function s0(r,e,i,o,a=!1){if(e.stops.length===1){const L=e.stops[0];return Ku(L.rgb_color,L.opacity*i,o)}const u=Ju(e.transform),{fx:h,fy:f,fr:_,cx:g,cy:v,r:b}=e;let w=new DOMPoint(h,f),I=new DOMPoint(g,v),A=_,P=b;if(a){w=u.transformPoint(w),I=u.transformPoint(I);const L=(u.a+u.d)/2;A=_*L,P=e.r*L}const D=r.createRadialGradient(w.x,w.y,A,I.x,I.y,P);for(const L of e.stops)D.addColorStop(L.offset,Ku(L.rgb_color,L.opacity*i,o));return D}function a0(r,e,i,o){const a=o.transform?Ju(o.transform).preMultiplySelf(e):e,u=nf(r.canvas.width,r.canvas.height),h=u.getContext("2d");for(const _ of o.children)if(_.group)a0(h,a,i,_.group);else if(_.path){const g=_.path,v=new Path2D;v.addPath(h0(g),a),h.fill(v,r0(g))}const f=o.clip_path_idx!=null?i.clip_paths[o.clip_path_idx]:null;f&&l0(h,a,i,f),r.globalCompositeOperation="source-over",r.drawImage(u,0,0)}function l0(r,e,i,o){const a=nf(r.canvas.width,r.canvas.height);a0(a.getContext("2d"),e,i,o),r.globalCompositeOperation="destination-in",r.drawImage(a,0,0)}function c0(r,e,i,o,a){if(o.children.length===0)return;const u=o.mask_idx!=null?i.masks[o.mask_idx]:null;u&&c0(r,e,i,u,a);const h=r.canvas.width,f=r.canvas.height,_=nf(h,f),g=_.getContext("2d"),v=o.width,b=o.height,w=o.left,I=o.top,A=new Path2D,P=new Path2D;P.rect(w,I,v,b),A.addPath(P,e),g.clip(A);for(const V of o.children)t0(g,e,i,V,a);const D=g.getImageData(0,0,h,f),L=D.data;if(o.mask_type===Kv.MASK_TYPE_LUMINANCE)for(let V=0;V<L.length;V+=4)L[V+3]=L[V+3]/255*(.2126*L[V]+.7152*L[V+1]+.0722*L[V+2]);g.putImageData(D,0,0),r.globalCompositeOperation="destination-in",r.drawImage(_,0,0)}function Ju(r){return r?new DOMMatrix([r.sx,r.ky,r.kx,r.sy,r.tx,r.ty]):new DOMMatrix}function u0(r,e){const i=r.step;let o=r.diffs[0]*i,a=r.diffs[1]*i;e.moveTo(o,a);for(let u=0,h=2;u<r.commands.length;u++)switch(r.commands[u]){case rf.PATH_COMMAND_MOVE:o+=r.diffs[h++]*i,a+=r.diffs[h++]*i,e.moveTo(o,a);break;case rf.PATH_COMMAND_LINE:o+=r.diffs[h++]*i,a+=r.diffs[h++]*i,e.lineTo(o,a);break;case rf.PATH_COMMAND_QUAD:{const f=o+r.diffs[h++]*i,_=a+r.diffs[h++]*i;o=f+r.diffs[h++]*i,a=_+r.diffs[h++]*i,e.quadraticCurveTo(f,_,o,a);break}case rf.PATH_COMMAND_CUBIC:{const f=o+r.diffs[h++]*i,_=a+r.diffs[h++]*i,g=f+r.diffs[h++]*i,v=_+r.diffs[h++]*i;o=g+r.diffs[h++]*i,a=v+r.diffs[h++]*i,e.bezierCurveTo(f,_,g,v,o,a);break}case rf.PATH_COMMAND_CLOSE:e.closePath()}return e}function h0(r){return u0(r,new Path2D)}class sm{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}pt(sm,"LRUCache");class fg{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new Hn(e,e.data)}getFromCache(e,i,o){return this.cacheMap.has(o)||this.cacheMap.set(o,new sm(150)),this.cacheMap.get(o).get(Ca(e.toString(),i))}setInCache(e,i,o,a){this.cacheDependenciesMap.has(a)||this.cacheDependenciesMap.set(a,new Map),this.cacheMap.has(a)||this.cacheMap.set(a,new sm(150));const u=this.cacheDependenciesMap.get(a),h=Ca(e.id.toString(),o);u.get(h)||u.set(h,new Set);const f=this.cacheMap.get(a),_=e.toString();u.get(h).add(_),f.put(Ca(e.toString(),o),i)}removeImagesFromCacheByIds(e,i,o=0){if(!this.cacheMap.has(o)||!this.cacheDependenciesMap.has(o))return;const a=this.cacheMap.get(o),u=this.cacheDependenciesMap.get(o);for(const h of e){const f=Ca(h.toString(),i);if(u.has(f)){for(const _ of u.get(f))a.delete(_);u.delete(f)}}}rasterize(e,i,o,a,u=CT){const h=this.getFromCache(e,o,a);if(h)return h.clone();const f=u(i.icon,e.options),_=fg._getImage(f);return this.setInCache(e,_,o,a),_.clone()}}class d0{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const o=this.toIdx(e,i);return{min:this.minimums[o],max:this.maximums[o]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function f0(r,e,i,o){let a=0,u=Number.MAX_VALUE;for(let h=0;h<3;h++)if(Math.abs(o[h])<1e-15){if(i[h]<r[h]||i[h]>e[h])return null}else{const f=1/o[h];let _=(r[h]-i[h])*f,g=(e[h]-i[h])*f;if(_>g){const v=_;_=g,g=v}if(_>a&&(a=_),g<u&&(u=g),a>u)return null}return a}function p0(r,e,i,o,a,u,h,f,_,g,v){const b=o-r,w=a-e,I=u-i,A=h-r,P=f-e,D=_-i,L=v[1]*D-v[2]*P,V=v[2]*A-v[0]*D,j=v[0]*P-v[1]*A,H=b*L+w*V+I*j;if(Math.abs(H)<1e-15)return null;const te=1/H,K=g[0]-r,oe=g[1]-e,le=g[2]-i,ue=(K*L+oe*V+le*j)*te;if(ue<0||ue>1)return null;const Me=oe*I-le*w,ye=le*b-K*I,Ce=K*w-oe*b,Oe=(v[0]*Me+v[1]*ye+v[2]*Ce)*te;return Oe<0||ue+Oe>1?null:(A*Me+P*ye+D*Ce)*te}function m0(r,e,i){return(r-e)/(i-e)}function _0(r,e,i,o,a,u,h,f,_){const g=1<<i,v=u-o,b=h-a,w=(r+1)/g*v+o,I=(e+0)/g*b+a,A=(e+1)/g*b+a;f[0]=(r+0)/g*v+o,f[1]=I,_[0]=w,_[1]=A}class g0{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=(function(u){const h=Math.ceil(Math.log2(u.dim/8)),f=[];let _=Math.ceil(Math.pow(2,h));const g=1/_,v=(I,A,P,D,L)=>{const V=D?1:0,j=(I+1)*P-V,H=A*P,te=(A+1)*P-V;L[0]=I*P,L[1]=H,L[2]=j,L[3]=te};let b=new d0(_);const w=[];for(let I=0;I<_*_;I++){v(I%_,Math.floor(I/_),g,!1,w);const A=Al(w[0],w[1],u),P=Al(w[2],w[1],u),D=Al(w[2],w[3],u),L=Al(w[0],w[3],u);b.minimums.push(Math.min(A,P,D,L)),b.maximums.push(Math.max(A,P,D,L)),b.leaves.push(1)}for(f.push(b),_/=2;_>=1;_/=2){const I=f[f.length-1];b=new d0(_);for(let A=0;A<_*_;A++){v(A%_,Math.floor(A/_),2,!0,w);const P=I.getElevation(w[0],w[1]),D=I.getElevation(w[2],w[1]),L=I.getElevation(w[2],w[3]),V=I.getElevation(w[0],w[3]),j=I.isLeaf(w[0],w[1]),H=I.isLeaf(w[2],w[1]),te=I.isLeaf(w[2],w[3]),K=I.isLeaf(w[0],w[3]),oe=Math.min(P.min,D.min,L.min,V.min),le=Math.max(P.max,D.max,L.max,V.max),ue=j&&H&&te&&K;b.maximums.push(le),b.minimums.push(oe),b.leaves.push(le-oe<=5&&ue?1:0)}f.push(b)}return f})(this.dem),o=i.length-1,a=i[o];this._addNode(a.minimums[0],a.maximums[0],a.leaves[0]),this._construct(i,0,0,o,0)}raycastRoot(e,i,o,a,u,h,f=1){return f0([e,i,-100],[o,a,this.maximums[0]*f],u,h)}raycast(e,i,o,a,u,h,f=1){if(!this.nodeCount)return null;const _=this.raycastRoot(e,i,o,a,u,h,f);if(_==null)return null;const g=[],v=[],b=[],w=[],I=[{idx:0,t:_,nodex:0,nodey:0,depth:0}];for(;I.length>0;){const{idx:A,t:P,nodex:D,nodey:L,depth:V}=I.pop();if(this.leaves[A]){_0(D,L,V,e,i,o,a,b,w);const H=1<<V,te=(D+0)/H,K=(D+1)/H,oe=(L+0)/H,le=(L+1)/H,ue=Al(te,oe,this.dem)*f,Me=Al(K,oe,this.dem)*f,ye=Al(K,le,this.dem)*f,Ce=Al(te,le,this.dem)*f,Oe=p0(b[0],b[1],ue,w[0],b[1],Me,w[0],w[1],ye,u,h),Ne=p0(w[0],w[1],ye,b[0],w[1],Ce,b[0],b[1],ue,u,h),Ye=Math.min(Oe!==null?Oe:Number.MAX_VALUE,Ne!==null?Ne:Number.MAX_VALUE);if(Ye!==Number.MAX_VALUE)return Ye;{const He=Fn([],u,h,P);if(y0(ue,Me,Ce,ye,m0(He[0],b[0],w[0]),m0(He[1],b[1],w[1]))>=He[2])return P}continue}let j=0;for(let H=0;H<this._siblingOffset.length;H++){_0((D<<1)+this._siblingOffset[H][0],(L<<1)+this._siblingOffset[H][1],V+1,e,i,o,a,b,w),b[2]=-100,w[2]=this.maximums[this.childOffsets[A]+H]*f;const te=f0(b,w,u,h);if(te!=null){const K=te;g[H]=K;let oe=!1;for(let le=0;le<j&&!oe;le++)K>=g[v[le]]&&(v.splice(le,0,H),oe=!0);oe||(v[j]=H),j++}}for(let H=0;H<j;H++){const te=v[H];I.push({idx:this.childOffsets[A]+te,t:g[te],nodex:(D<<1)+this._siblingOffset[te][0],nodey:(L<<1)+this._siblingOffset[te][1],depth:V+1})}}return null}_addNode(e,i,o){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(o),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,o,a,u){if(e[a].isLeaf(i,o)===1)return;this.childOffsets[u]||(this.childOffsets[u]=this.nodeCount);const h=a-1,f=e[h];let _=0,g=0;for(let v=0;v<this._siblingOffset.length;v++){const b=2*i+this._siblingOffset[v][0],w=2*o+this._siblingOffset[v][1],I=f.getElevation(b,w),A=f.isLeaf(b,w),P=this._addNode(I.min,I.max,A);A&&(_|=1<<v),g||(g=P)}for(let v=0;v<this._siblingOffset.length;v++)_&1<<v||this._construct(e,2*i+this._siblingOffset[v][0],2*o+this._siblingOffset[v][1],h,g+v)}}function y0(r,e,i,o,a,u){return Ft(Ft(r,i,u),Ft(e,o,u),a)}function Al(r,e,i){const o=i.dim,a=B(r*o-.5,0,o-1),u=B(e*o-.5,0,o-1),h=Math.floor(a),f=Math.floor(u),_=Math.min(h+1,o-1),g=Math.min(f+1,o-1);return y0(i.get(h,f),i.get(_,f),i.get(h,g),i.get(_,g),a-h,u-f)}const PT={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function RT(r,e,i){return(256*r*256+256*e+i)/10-1e4}function DT(r,e,i){return 256*r+e+i/256-32768}class am{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,o,a=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(o&&o!=="mapbox"&&o!=="terrarium")return void Mt('"'.concat(o,'" is not a valid encoding type. Valid types include "mapbox" and "terrarium".'));this.stride=i.height;const u=this.dim=i.height-2,h=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=a,this._modifiedForSources={},!a){for(let _=0;_<u;_++)h[this._idx(-1,_)]=h[this._idx(0,_)],h[this._idx(u,_)]=h[this._idx(u-1,_)],h[this._idx(_,-1)]=h[this._idx(_,0)],h[this._idx(_,u)]=h[this._idx(_,u-1)];h[this._idx(-1,-1)]=h[this._idx(0,0)],h[this._idx(u,-1)]=h[this._idx(u-1,0)],h[this._idx(-1,u)]=h[this._idx(0,u-1)],h[this._idx(u,u)]=h[this._idx(u-1,u-1)]}const f=o==="terrarium"?DT:RT;for(let _=0;_<h.length;++_){const g=4*_;this.floatView[_]=f(this.pixels[g],this.pixels[g+1],this.pixels[g+2])}this._timestamp=To.now()}_buildQuadTree(){this._tree=new g0(this)}get(e,i,o=!1){o&&(e=B(e,-1,this.dim),i=B(i,-1,this.dim));const a=this._idx(e,i);return this.floatView[a]}set(e,i,o){const a=this._idx(e,i),u=this.floatView[a];return this.floatView[a]=o,o-u}static getUnpackVector(e){return PT[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const o=[0,0,0,0],a=am.getUnpackVector(i);let u=Math.floor((e+a[3])/a[2]);return o[2]=u%256,u=Math.floor(u/256),o[1]=u%256,u=Math.floor(u/256),o[0]=u,o}getPixels(){return new hy({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,o){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let a=i*this.dim,u=i*this.dim+this.dim,h=o*this.dim,f=o*this.dim+this.dim;switch(i){case-1:a=u-1;break;case 1:u=a+1}switch(o){case-1:h=f-1;break;case 1:f=h+1}const _=-i*this.dim,g=-o*this.dim;for(let v=h;v<f;v++)for(let b=a;b<u;b++){const w=4*this._idx(b,v),I=4*this._idx(b+_,v+g);this.pixels[w+0]=e.pixels[I+0],this.pixels[w+1]=e.pixels[I+1],this.pixels[w+2]=e.pixels[I+2],this.pixels[w+3]=e.pixels[I+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function zT(r,e,i){r===1?e.headerLength=i.readFixed32():r===2?e.x=i.readVarint():r===3?e.y=i.readVarint():r===4?e.z=i.readVarint():r===5&&e.layers.push((function(o,a){return o.readFields(BT,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},a)})(i,i.readVarint()+i.pos))}function LT(r,e,i){r===1?(e.delta_filter=(function(o,a){return o.readFields(OT,{blockSize:0},a)})(i,i.readVarint()+i.pos),e.filter="delta_filter"):r===2?(i.readVarint(),e.filter="zigzag_filter"):r===3?(i.readVarint(),e.filter="bitshuffle_filter"):r===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function OT(r,e,i){r===1&&(e.blockSize=i.readVarint())}function FT(r,e,i){r===1?(i.readVarint(),e.codec="gzip_data"):r===2?(i.readVarint(),e.codec="jpeg_image"):r===3?(i.readVarint(),e.codec="webp_image"):r===4&&(i.readVarint(),e.codec="png_image")}function kT(r,e,i){let o=0,a=0;r===1?e.firstByte=i.readFixed64():r===2?e.lastByte=i.readFixed64():r===3?e.filters.push((function(u,h){return u.readFields(LT,{},h)})(i,i.readVarint()+i.pos)):r===4?e.codec=(function(u,h){return u.readFields(FT,{},h)})(i,i.readVarint()+i.pos):r===5?a=i.readFloat():r===6?o=i.readFloat():r===7?e.bands.push(i.readString()):r===8?e.offset=i.readDouble():r===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=a),e.scale===0&&(e.scale=o)}function BT(r,e,i){r===1?e.version=i.readVarint():r===2?e.name=i.readString():r===3?e.units=i.readString():r===4?e.tileSize=i.readVarint():r===5?e.buffer=i.readVarint():r===6?e.pixelFormat=i.readVarint():r===7&&e.dataIndex.push((function(o,a){return o.readFields(kT,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},a)})(i,i.readVarint()+i.pos))}function NT(r,e,i){if(r===2)(function(o,a,u){o.readFields(VT,u,a)})(i,i.readVarint()+i.pos,e);else if(r===3)throw new Error("Not implemented")}function VT(r,e,i){if(r===1){let o=0;const a=i.readVarint()+i.pos;for(;i.pos<a;)e[o++]=i.readVarint()}}function UT(r,e){if(e.length!==4)throw new Error("Expected data of dimension 4 but got ".concat(e.length,"."));let i=e[3];for(let o=2;o>=1;o--){const a=o===1?1:0,u=o===2?1:0;for(let h=0;h<e[0];h++){const f=e[1]*h;for(let _=a;_<e[1];_++){const g=e[2]*(_+f);for(let v=u;v<e[2];v++){const b=e[3]*(v+g);for(let w=0;w<e[3];w++){const I=b+w;r[I]+=r[I-i]}}}}i*=e[o]}return r}function jT(r){for(let e=0,i=r.length;e<i;e++)r[e]=r[e]>>>1^-(1&r[e]);return r}function GT(r,e){switch(e){case"uint32":return r;case"uint16":for(let i=0;i<r.length;i+=2){const o=r[i],a=r[i+1];r[i]=(240&o)>>4|(61440&o)>>8|(240&a)<<4|61440&a,r[i+1]=15&o|(3840&o)>>4|(15&a)<<8|(3840&a)<<4}return r;case"uint8":for(let i=0;i<r.length;i+=4){const o=r[i],a=r[i+1],u=r[i+2],h=r[i+3];r[i+0]=(192&o)>>6|(192&a)>>4|(192&u)>>2|192&h,r[i+1]=(48&o)>>4|(48&a)>>2|48&u|(48&h)<<2,r[i+2]=(12&o)>>2|12&a|(12&u)<<2|(12&h)<<4,r[i+3]=3&o|(3&a)<<2|(3&u)<<4|(3&h)<<6}return r;default:throw new Error('Invalid pixel format, "'.concat(e,'"'))}}pt(am,"DEMData"),pt(g0,"DemMinMaxQuadTree",{omit:["dem"]});var gs=Uint8Array,of=Uint16Array,HT=Int32Array,x0=new gs([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),v0=new gs([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),qT=new gs([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),b0=function(r,e){for(var i=new of(31),o=0;o<31;++o)i[o]=e+=1<<r[o-1];var a=new HT(i[30]);for(o=1;o<30;++o)for(var u=i[o];u<i[o+1];++u)a[u]=u-i[o]<<5|o;return{b:i,r:a}},w0=b0(x0,2),T0=w0.b,$T=w0.r;T0[28]=258,$T[258]=28;for(var ZT=b0(v0,0).b,S0=new of(32768),dn=0;dn<32768;++dn){var Qu=(43690&dn)>>1|(21845&dn)<<1;S0[dn]=((65280&(Qu=(61680&(Qu=(52428&Qu)>>2|(13107&Qu)<<2))>>4|(3855&Qu)<<4))>>8|(255&Qu)<<8)>>1}var sf=function(r,e,i){for(var o=r.length,a=0,u=new of(e);a<o;++a)r[a]&&++u[r[a]-1];var h,f=new of(e);for(a=1;a<e;++a)f[a]=f[a-1]+u[a-1]<<1;h=new of(1<<e);var _=15-e;for(a=0;a<o;++a)if(r[a])for(var g=a<<4|r[a],v=e-r[a],b=f[r[a]-1]++<<v,w=b|(1<<v)-1;b<=w;++b)h[S0[b]>>_]=g;return h},af=new gs(288);for(dn=0;dn<144;++dn)af[dn]=8;for(dn=144;dn<256;++dn)af[dn]=9;for(dn=256;dn<280;++dn)af[dn]=7;for(dn=280;dn<288;++dn)af[dn]=8;var E0=new gs(32);for(dn=0;dn<32;++dn)E0[dn]=5;var WT=sf(af,9),XT=sf(E0,5),pg=function(r){for(var e=r[0],i=1;i<r.length;++i)r[i]>e&&(e=r[i]);return e},Zs=function(r,e,i){var o=e/8|0;return(r[o]|r[o+1]<<8)>>(7&e)&i},mg=function(r,e){var i=e/8|0;return(r[i]|r[i+1]<<8|r[i+2]<<16)>>(7&e)},YT=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ws=function(r,e,i){var o=new Error(e||YT[r]);if(o.code=r,Error.captureStackTrace&&Error.captureStackTrace(o,Ws),!i)throw o;return o},KT=new gs(0),JT=typeof TextDecoder<"u"&&new TextDecoder;try{JT.decode(KT,{stream:!0})}catch(r){}const QT={gzip_data:"gzip"};class Ms extends Error{constructor(e){super(e),this.name="MRTError"}}const e2={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},I0={uint32:1,uint16:2,uint8:4},t2={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let _g;class lm{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const i=this.layers[e];if(!i)throw new Ms("Layer '".concat(e,"' not found"));return i}getHeaderLength(e){const i=new Uint8Array(e),o=new DataView(e);if(i[0]!==13)throw new Ms("File is not a valid MRT.");return o.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),o=this.getHeaderLength(e);if(i.length<o)throw new Ms("Expected header with length >= ".concat(o," but got buffer of length ").concat(i.length));const a=new _g(i.subarray(0,o)).readFields(zT,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==a.x||this.y!==a.y||this.z!==a.z))throw new Ms("Invalid attempt to parse header ".concat(a.z,"/").concat(a.x,"/").concat(a.y," for tile ").concat(this.z,"/").concat(this.x,"/").concat(this.y));this.x=a.x,this.y=a.y,this.z=a.z;for(const u of a.layers)this.layers[u.name]=new A0(u,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],o=this.getLayer(e.layerName);for(let a of e.blockIndices){const u=o.dataIndex[a],h=u.firstByte-e.firstByte,f=u.lastByte-e.firstByte;if(o._blocksInProgress.has(a))continue;const _={layerName:o.name,firstByte:h,lastByte:f,pixelFormat:o.pixelFormat,blockIndex:a,blockShape:[u.bands.length].concat(o.bandShape),buffer:o.buffer,codec:u.codec.codec,filters:u.filters.map((g=>g.filter))};o._blocksInProgress.add(a),i.push(_)}return new M0(i,(()=>{i.forEach((a=>o._blocksInProgress.delete(a.blockIndex)))}),((a,u)=>{if(i.forEach((h=>o._blocksInProgress.delete(h.blockIndex))),a)throw a;u.forEach((h=>{this.getLayer(h.layerName).processDecodedData(h)}))}))}}class A0{constructor({version:e,name:i,units:o,tileSize:a,pixelFormat:u,buffer:h,dataIndex:f},_){if(this.version=e,this.version!==1)throw new Ms("Cannot parse raster layer encoded with MRT version ".concat(e));this.name=i,this.units=o,this.tileSize=a,this.buffer=h,this.pixelFormat=e2[u],this.dataIndex=f,this.bandShape=[a+2*h,a+2*h,I0[this.pixelFormat]],this._decodedBlocks=new sm(_?_.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return I0[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map((({bands:e})=>e)).flat()}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[o,a]of this.dataIndex.entries()){for(const[u,h]of a.bands.entries())if(h===e)return{bandIndex:i+u,blockIndex:o,blockBandIndex:u};i+=a.bands.length}break;case"number":for(const[o,a]of this.dataIndex.entries()){if(e>=i&&e<i+a.bands.length)return{bandIndex:e,blockIndex:o,blockBandIndex:e-i};i+=a.bands.length}break;default:throw new Ms("Invalid band `".concat(JSON.stringify(e),"`. Expected string or integer."))}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let i=1/0,o=-1/0;const a=[],u=new Set;for(const h of e){const{blockIndex:f}=this.getBlockForBand(h);if(f<0)throw new Ms("Invalid band: ".concat(JSON.stringify(h)));const _=this.dataIndex[f];a.includes(f)||a.push(f),u.add(f),i=Math.min(i,_.firstByte),o=Math.max(o,_.lastByte)}if(u.size>this.cacheSize)throw new Ms("Number of blocks to decode (".concat(u.size,") exceeds cache size (").concat(this.cacheSize,")."));return{layerName:this.name,firstByte:i,lastByte:o,blockIndices:a}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:o}=this.getBlockForBand(e);if(i<0)throw new Ms("Band not found: ".concat(JSON.stringify(e)));const a=this._decodedBlocks.get(i.toString());if(!a)throw new Ms("Data for band ".concat(JSON.stringify(e),' of layer "').concat(this.name,'" not decoded.'));const u=this.dataIndex[i],h=this.bandShape.reduce(((g,v)=>g*v),1),f=o*h,_=a.subarray(f,f+h);return{data:_,bytes:new Uint8Array(_.buffer).subarray(_.byteOffset,_.byteOffset+_.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:u.offset,scale:u.scale}}}lm.setPbf=function(r){_g=r};class M0{constructor(e,i,o){this.tasks=e,this._onCancel=i,this._onComplete=o,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}lm.performDecoding=function(r,e){const i=new Uint8Array(r);return Promise.all(e.tasks.map((o=>{const{layerName:a,firstByte:u,lastByte:h,pixelFormat:f,blockShape:_,blockIndex:g,filters:v,codec:b}=o,w=i.subarray(u,h+1),I=new Uint32Array(_[0]*_[1]*_[2]);let A;if(b!=="gzip_data")throw new Ms("Unhandled codec: ".concat(b));return A=(function(P,D){if(!globalThis.DecompressionStream&&D==="gzip_data")return Promise.resolve(((H=(function(oe){oe[0]==31&&oe[1]==139&&oe[2]==8||Ws(6,"invalid gzip data");var le=oe[3],ue=10;4&le&&(ue+=2+(oe[10]|oe[11]<<8));for(var Me=(le>>3&1)+(le>>4&1);Me>0;Me-=!oe[ue++]);return ue+(2&le)})(j=P))+8>j.length&&Ws(6,"invalid gzip data"),(function(oe,le,ue,Me){var ye=oe.length;if(!ye||le.f&&!le.l)return ue||new gs(0);var Ce=!ue,Oe=Ce||le.i!=2,Ne=le.i;Ce&&(ue=new gs(3*ye));var Ye,He,Fe=function(Lr){var mr=ue.length;if(Lr>mr){var or=new gs(Math.max(2*mr,Lr));or.set(ue),ue=or}},Ge=le.f||0,Ie=le.p||0,Se=le.b||0,Ue=le.l,Ze=le.d,ke=le.m,ft=le.n,_t=8*ye;do{if(!Ue){Ge=Zs(oe,Ie,1);var ut=Zs(oe,Ie+1,3);if(Ie+=3,!ut){var ot=oe[(J=4+((Ie+7)/8|0))-4]|oe[J-3]<<8,jt=J+ot;if(jt>ye){Ne&&Ws(0);break}Oe&&Fe(Se+ot),ue.set(oe.subarray(J,jt),Se),le.b=Se+=ot,le.p=Ie=8*jt,le.f=Ge;continue}if(ut==1)Ue=WT,Ze=XT,ke=9,ft=5;else if(ut==2){var at=Zs(oe,Ie,31)+257,Et=Zs(oe,Ie+10,15)+4,Ht=at+Zs(oe,Ie+5,31)+1;Ie+=14;for(var oi=new gs(Ht),yi=new gs(19),$t=0;$t<Et;++$t)yi[qT[$t]]=Zs(oe,Ie+3*$t,7);Ie+=3*Et;var Pi=pg(yi),Ri=(1<<Pi)-1,Tr=sf(yi,Pi);for($t=0;$t<Ht;){var J,W=Tr[Zs(oe,Ie,Ri)];if(Ie+=15&W,(J=W>>4)<16)oi[$t++]=J;else{var Re=0,it=0;for(J==16?(it=3+Zs(oe,Ie,3),Ie+=2,Re=oi[$t-1]):J==17?(it=3+Zs(oe,Ie,7),Ie+=3):J==18&&(it=11+Zs(oe,Ie,127),Ie+=7);it--;)oi[$t++]=Re}}var De=oi.subarray(0,at),st=oi.subarray(at);ke=pg(De),ft=pg(st),Ue=sf(De,ke),Ze=sf(st,ft)}else Ws(1);if(Ie>_t){Ne&&Ws(0);break}}Oe&&Fe(Se+131072);for(var wt=(1<<ke)-1,vt=(1<<ft)-1,Zt=Ie;;Zt=Ie){var zt=(Re=Ue[mg(oe,Ie)&wt])>>4;if((Ie+=15&Re)>_t){Ne&&Ws(0);break}if(Re||Ws(2),zt<256)ue[Se++]=zt;else{if(zt==256){Zt=Ie,Ue=null;break}var yt=zt-254;zt>264&&(yt=Zs(oe,Ie,(1<<(Ot=x0[$t=zt-257]))-1)+T0[$t],Ie+=Ot);var Ai=Ze[mg(oe,Ie)&vt],Ji=Ai>>4;if(Ai||Ws(3),Ie+=15&Ai,st=ZT[Ji],Ji>3){var Ot=v0[Ji];st+=mg(oe,Ie)&(1<<Ot)-1,Ie+=Ot}if(Ie>_t){Ne&&Ws(0);break}Oe&&Fe(Se+131072);var _i=Se+yt;if(Se<st){var Qi=0-st,ji=Math.min(st,_i);for(Qi+Se<0&&Ws(3);Se<ji;++Se)ue[Se]=(void 0)[Qi+Se]}for(;Se<_i;++Se)ue[Se]=ue[Se-st]}}le.l=Ue,le.p=Zt,le.b=Se,le.f=Ge,Ue&&(Ge=1,le.m=ke,le.d=Ze,le.n=ft)}while(!Ge);return Se!=ue.length&&Ce?(Ye=ue,((He=Se)==null||He>Ye.length)&&(He=Ye.length),new gs(Ye.subarray(0,He))):ue.subarray(0,Se)})(j.subarray(H,-8),{i:2},new gs(((L=j)[(V=L.length)-4]|L[V-3]<<8|L[V-2]<<16|L[V-1]<<24)>>>0))));var L,V,j,H;const te=QT[D];if(!te)throw new Error("Unhandled codec: ".concat(D));const K=new globalThis.DecompressionStream(te);return new Response(new Blob([P]).stream().pipeThrough(K)).arrayBuffer().then((oe=>new Uint8Array(oe)))})(w,b).then((P=>((function(D,L){D.readFields(NT,L)})(new _g(P),I),new t2[f](I.buffer)))),A.then((P=>{for(let D=v.length-1;D>=0;D--)switch(v[D]){case"delta_filter":UT(P,_);break;case"zigzag_filter":jT(P);break;case"bitshuffle_filter":GT(P,f);break;default:throw new Ms('Unhandled filter "'.concat(v[D],'"'))}return{layerName:a,blockIndex:g,data:P}})).catch((P=>{throw P}))})))},pt(M0,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),pt(lm,"MapboxRasterTile"),pt(A0,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class C0{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const o=e[i];this._stringToNumber[o]=i,this._numberToString[i]=o}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}class P0{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Aa(Je,16,0),this.featureIndexArray=new sp,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,o,a,u,h=0,f=0){const _=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(o,a,u,h);const g=this.grid;for(let v=0;v<i.length;v++){const b=i[v],w=[1/0,1/0,-1/0,-1/0];for(let I=0;I<b.length;I++){const A=b[I];w[0]=Math.min(w[0],A.x),w[1]=Math.min(w[1],A.y),w[2]=Math.max(w[2],A.x),w[3]=Math.max(w[3],A.y)}f!==0&&(w[0]-=f,w[1]-=f,w[2]+=f,w[3]+=f),w[0]<Je&&w[1]<Je&&w[2]>=0&&w[3]>=0&&g.insert(_,w[0],w[1],w[2],w[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new gt(new Bp(this.rawTileData)).layers,this.sourceLayerCoder=new C0(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){const{tilespaceGeometry:o,transform:a,tileTransform:u,pixelPosMatrix:h,availableImages:f,worldview:_}=i;this.loadVTLayers(),this.serializedLayersCache.clear();const g=i.queryRadius?i.queryRadius:0,v=o.bufferedTilespaceBounds,b=this.grid.query(v.min.x,v.min.y,v.max.x,v.max.y,((P,D,L,V)=>Dr(o.bufferedTilespaceGeometry,P-g,D-g,L+g,V+g)));b.sort(i2);let w=null;a.elevation&&b.length>0&&(w=Yu.create(a.elevation,this.tileID));const I={};let A;for(let P=0;P<b.length;P++){const D=b[P];if(D===A)continue;A=D;const L=this.featureIndexArray.get(D);let V=null;this.is3DTile?this.loadMatchingModelFeature(I,L,e,o,a,_):this.loadMatchingFeature(I,L,e,f,_,((j,H,te,K=0)=>(V||(V=Le(j,this.tileID.canonical,u)),H.queryIntersectsFeature(o,j,te,V,this.z,a,h,w,K))))}return I}loadMatchingFeature(e,i,o,a,u,h){const{featureIndex:f,bucketIndex:_,sourceLayerIndex:g,layoutVertexArrayOffset:v}=i,b=this.bucketLayerIDs[_],w=o.layers,I=Object.keys(w);if(I.length&&!Vt(I,b))return;const A=o.sourceCache,P=this.sourceLayerCoder.decode(g),D=this.vtLayers[P].feature(f),L=this.getId(D,P);for(let V=0;V<b.length;V++){const j=b[V];if(!w[j])continue;const{styleLayer:H,targets:te}=w[j];let K={};L!==void 0&&(K=A.getFeatureState(H.sourceLayer,L));const oe=!h||h(D,H,K,v);if(!oe)continue;const le=new Mc(D,this.z,this.x,this.y,L);le.tile=this.tileID.canonical,le.state=K;let ue=this.serializedLayersCache.get(j);ue||(ue=H.serialize(),ue.id=j,this.serializedLayersCache.set(j,ue)),le.source=ue.source,le.sourceLayer=ue["source-layer"],le.layer=Object.assign({},ue),le.layer.paint=R0(ue.paint,H.paint,D,K,a),le.layer.layout=R0(ue.layout,H.layout,D,K,a);let Me=!1;for(const ye of te){this.updateFeatureProperties(le,ye);const{filter:Ce}=ye;if(Ce){if(D.properties=le.properties,Ce.needGeometry){const Oe=be(D,!0);if(!Ce.filter(new lr(this.tileID.overscaledZ,{worldview:u}),Oe,this.tileID.canonical))continue}else if(!Ce.filter(new lr(this.tileID.overscaledZ,{worldview:u}),D))continue}Me=!0,ye.targetId&&this.addFeatureVariant(le,ye)}Me&&this.appendToResult(e,j,f,le,oe)}}loadMatchingModelFeature(e,i,o,a,u,h){const{featureIndex:f,bucketIndex:_}=i,g=this.bucketLayerIDs[_],v=o.layers,b=Object.keys(v);if(!b.length||Vt(b,g))for(let w=0;w<g.length;w++){const I=g[w],{styleLayer:A,targets:P}=v[I];if(A.type!=="model")continue;const D=a.tile,L=D.getBucket(A);if(!(L&&L instanceof tm))continue;const V=lT(L,f,a,u);if(!V)continue;const{z:j,x:H,y:te}=D.tileID.canonical,{feature:K,intersectionZ:oe,position:le}=V;let ue={};K.id!==void 0&&(ue=o.sourceCache.getFeatureState(A.sourceLayer,K.id));const Me=new Mc({},j,H,te,K.id);Me.tile=this.tileID.canonical,Me.state=ue,Me.properties=K.properties,Me.geometry={type:"Point",coordinates:[le.lng,le.lat]};let ye=this.serializedLayersCache.get(I);ye||(ye=A.serialize(),ye.id=I,this.serializedLayersCache.set(I,ye)),Me.source=ye.source,Me.sourceLayer=ye["source-layer"],Me.layer=Object.assign({},ye);let Ce=!1;for(const Oe of P){this.updateFeatureProperties(Me,Oe);const{filter:Ne}=Oe;if(Ne){if(K.properties=Me.properties,Ne.needGeometry){if(!Ne.filter(new lr(this.tileID.overscaledZ,{worldview:h}),K,this.tileID.canonical))continue}else if(!Ne.filter(new lr(this.tileID.overscaledZ,{worldview:h}),K))continue}Ce=!0,Oe.targetId&&this.addFeatureVariant(Me,Oe)}Ce&&this.appendToResult(e,I,f,Me,oe)}}updateFeatureProperties(e,i,o){if(i.properties){const a={};for(const u in i.properties){const h=i.properties[u].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,o);h!=null&&(a[u]=h)}e.properties=a}}addFeatureVariant(e,i,o){const a={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(a.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(a)}appendToResult(e,i,o,a,u){let h=e[i];h===void 0&&(h=e[i]=[]),h.push({featureIndex:o,feature:a,intersectionZ:u})}lookupSymbolFeatures(e,i,o,a,u,h){const f={};this.loadVTLayers();for(const _ of e)this.loadMatchingFeature(f,{bucketIndex:i,sourceLayerIndex:o,featureIndex:_,layoutVertexArrayOffset:0},a,u,h);return f}loadFeature(e){const{featureIndex:i,sourceLayerIndex:o}=e;this.loadVTLayers();const a=this.sourceLayerCoder.decode(o),u=this.vtFeatures[a];if(u[i])return u[i];const h=this.vtLayers[a].feature(i);return u[i]=h,h}hasLayer(e){for(const i of this.bucketLayerIDs)for(const o of i)if(e===o)return!0;return!1}getId(e,i){let o=e.id;if(this.promoteId){const a=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(a!=null)if(Array.isArray(a)){if(!this.promoteIdExpression){const u=Es(a);if(u.result!=="success"){const h=u.value.map((f=>"".concat(f.key,": ").concat(f.message))).join(", ");return void Mt("Failed to create expression for promoteId: ".concat(h))}this.promoteIdExpression=u.value}o=this.promoteIdExpression.evaluate({zoom:0},e)}else o=e.properties[a];typeof o=="boolean"&&(o=Number(o))}return o}}function R0(r,e,i,o,a){return We(r,((u,h)=>{const f=e instanceof Ma?e.get(h):null;return f&&f.evaluate?f.evaluate(i,o,void 0,a):f}))}function i2(r,e){return e-r}pt(P0,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const D0=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class gg{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,o]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const a=o>>4;if(a!==1)throw new Error("Got v".concat(a," data when expected v1."));const u=D0[15&o];if(!u)throw new Error("Unrecognized array type.");const[h]=new Uint16Array(e,2,1),[f]=new Uint32Array(e,4,1);return new gg(f,h,u,e)}constructor(e,i=64,o=Float64Array,a){if(isNaN(e)||e<0)throw new Error("Unpexpected numItems value: ".concat(e,"."));this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=o,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const u=D0.indexOf(this.ArrayType),h=2*e*this.ArrayType.BYTES_PER_ELEMENT,f=e*this.IndexArrayType.BYTES_PER_ELEMENT,_=(8-f%8)%8;if(u<0)throw new Error("Unexpected typed array class: ".concat(o,"."));a&&a instanceof ArrayBuffer?(this.data=a,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+_,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+h+f+_),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+_,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+u]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=e,this.coords[this._pos++]=i,o}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error("Added ".concat(e," items when expected ").concat(this.numItems,"."));return yg(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,o,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:u,coords:h,nodeSize:f}=this,_=[0,u.length-1,0],g=[];for(;_.length;){const v=_.pop()||0,b=_.pop()||0,w=_.pop()||0;if(b-w<=f){for(let D=w;D<=b;D++){const L=h[2*D],V=h[2*D+1];L>=e&&L<=o&&V>=i&&V<=a&&g.push(u[D])}continue}const I=w+b>>1,A=h[2*I],P=h[2*I+1];A>=e&&A<=o&&P>=i&&P<=a&&g.push(u[I]),(v===0?e<=A:i<=P)&&(_.push(w),_.push(I-1),_.push(1-v)),(v===0?o>=A:a>=P)&&(_.push(I+1),_.push(b),_.push(1-v))}return g}within(e,i,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:u,nodeSize:h}=this,f=[0,a.length-1,0],_=[],g=o*o;for(;f.length;){const v=f.pop()||0,b=f.pop()||0,w=f.pop()||0;if(b-w<=h){for(let D=w;D<=b;D++)L0(u[2*D],u[2*D+1],e,i)<=g&&_.push(a[D]);continue}const I=w+b>>1,A=u[2*I],P=u[2*I+1];L0(A,P,e,i)<=g&&_.push(a[I]),(v===0?e-o<=A:i-o<=P)&&(f.push(w),f.push(I-1),f.push(1-v)),(v===0?e+o>=A:i+o>=P)&&(f.push(I+1),f.push(b),f.push(1-v))}return _}}function yg(r,e,i,o,a,u){if(a-o<=i)return;const h=o+a>>1;z0(r,e,h,o,a,u),yg(r,e,i,o,h-1,1-u),yg(r,e,i,h+1,a,1-u)}function z0(r,e,i,o,a,u){for(;a>o;){if(a-o>600){const g=a-o+1,v=i-o+1,b=Math.log(g),w=.5*Math.exp(2*b/3),I=.5*Math.sqrt(b*w*(g-w)/g)*(v-g/2<0?-1:1);z0(r,e,i,Math.max(o,Math.floor(i-v*w/g+I)),Math.min(a,Math.floor(i+(g-v)*w/g+I)),u)}const h=e[2*i+u];let f=o,_=a;for(lf(r,e,o,i),e[2*a+u]>h&&lf(r,e,o,a);f<_;){for(lf(r,e,f,_),f++,_--;e[2*f+u]<h;)f++;for(;e[2*_+u]>h;)_--}e[2*o+u]===h?lf(r,e,o,_):(_++,lf(r,e,_,a)),_<=i&&(o=_+1),i<=_&&(a=_-1)}}function lf(r,e,i,o){xg(r,i,o),xg(e,2*i,2*o),xg(e,2*i+1,2*o+1)}function xg(r,e,i){const o=r[e];r[e]=r[i],r[i]=o}function L0(r,e,i,o){const a=r-i,u=e-o;return a*a+u*u}s.$=kc,s.A=Ls,s.B=Ca,s.C=2,s.D=ku,s.E=Ds,s.F=Gd,s.G=sv,s.H=Fc,s.I=hn,s.J=ed,s.K=Ha,s.L=Yl,s.M=au,s.N=su,s.O=Uh,s.P=Be,s.Q=hu,s.R=_a,s.S=ll,s.T=C_,s.U=Es,s.V=em,s.W=Gh,s.X=Ja,s.Y=Ka,s.Z=ic,s._=Yn,s.a=function(r){return fr.API_CDN_URL_REGEX.test(r)},s.a$=dl,s.a0=Bt,s.a1=fh,s.a2=cl,s.a3=class extends em{},s.a4=lu,s.a5=Vh,s.a6=ge,s.a7=function(r){const e=r.value;return e?Bt(e)?og(e,!0)?[]:[new em(r.key,e,'invalid url "'.concat(e,'"'))]:[new em(r.key,e,'string expected, "'.concat(Ha(e),'" found'))]:[]},s.a8=Xf,s.a9=kr,s.aA=B,s.aB=Yt,s.aC=pn,s.aD=_o,s.aE=wn,s.aF=N,s.aG=Ae,s.aH=function(r,e){const i={};for(let o=0;o<e.length;o++){const a=e[o];a in r&&(i[a]=r[a])}return i},s.aI=E,s.aJ=k,s.aK=class{constructor(r){this.entries={},this.scheduler=r}request(r,e,i,o){const a=this.entries[r]=this.entries[r]||{callbacks:[]};if(a.result){const[u,h]=a.result;return this.scheduler?this.scheduler.add((()=>{o(u,h)}),e):o(u,h),()=>{}}return a.callbacks.push(o),a.cancel||(a.cancel=i(((u,h)=>{a.result=[u,h];for(const f of a.callbacks)this.scheduler?this.scheduler.add((()=>{f(u,h)}),e):f(u,h);setTimeout((()=>delete this.entries[r]),3e3)}))),()=>{a.result||(a.callbacks=a.callbacks.filter((u=>u!==o)),a.callbacks.length||(a.cancel(),delete this.entries[r]))}}},s.aL=function(r,e,i){const o=JSON.stringify(r.request);return r.data&&(this.deduped.entries[o]={result:[null,r.data]}),this.deduped.request(o,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom},(a=>{const u=Na(r.request,((h,f,_)=>{h?a(h):f&&a(null,{vectorTile:i?void 0:new gt(new Bp(f)),rawData:f,responseHeaders:new Map(_.entries())})}));return()=>{u.cancel(),a()}}),e)},s.aM=function(r){return r?{cacheControl:r.get("Cache-Control"),expires:r.get("Expires")}:{cacheControl:void 0,expires:void 0}},s.aN=function(r){Rc++,Rc>fo&&(r.getActor().send("enforceCacheSizeLimit",Ll),Rc=0)},s.aO=function(r){return r<=1?1:Math.pow(2,Math.floor(Math.log2(r)))},s.aP=gn,s.aQ=Ov,s.aR=Uv,s.aS=M,s.aT=Lv,s.aU=function(r,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let o=0;o<r.length;o++){const a=document.createElement("source");Fi(r[o])||(i.crossOrigin="Anonymous"),a.src=r[o],i.appendChild(a)}return{cancel:()=>{}}},s.aV=Bd,s.aW=Cc,s.aX=Te,s.aY=Zd,s.aZ=$,s.a_=G,s.aa=qe,s.ab=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return Xi(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Ft(r.x,e.x,i),y:Ft(r.y,e.y,i),z:Ft(r.z,e.z,i),azimuthal:Ft(r.azimuthal,e.azimuthal,i),polar:Ft(r.polar,e.polar,i)}}},s.ac=lr,s.ad=ia,s.ae=_e,s.af=nr,s.ag=yn,s.ah=X,s.ai=Ma,s.aj=wl,s.ak=Ft,s.al=Je,s.am=Hl,s.an=ii,s.ao=Ui,s.ap=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return(function([i,o]){const a=Xi([1,i,o]);return{x:a.x,y:a.y,z:a.z}})(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Ft(r.x,e.x,i),y:Ft(r.y,e.y,i),z:Ft(r.z,e.z,i)}}},s.aq=function(r,e,i=0,o=!0){const a=new Be(i,i),u=r.sub(a),h=e.add(a),f=[u,new Be(h.x,u.y),h,new Be(u.x,h.y)];return o&&f.push(u.clone()),f},s.ar=function(r,e){const i=[];for(let o=0;o<r.length;o++){const a=ae(o-1,-1,r.length-1),u=ae(o+1,-1,r.length-1),h=r[o],f=r[u],_=r[a].sub(h).unit(),g=f.sub(h).unit(),v=g.angleWithSep(_.x,_.y),b=_.add(g).unit().mult(-1*e/Math.sin(v/2));i.push(h.add(b))}return i},s.as=xv,s.at=Dr,s.au=function(r,e,i=0){return rr(((e.x-i)*r.scale-r.x)*Je,(e.y*r.scale-r.y)*Je,ee(e.z,e.y))},s.av=Pr,s.aw=Oi,s.ax=Kt,s.ay=zx,s.az=function(r){let e=1/0,i=1/0,o=-1/0,a=-1/0;for(const u of r)e=Math.min(e,u.x),i=Math.min(i,u.y),o=Math.max(o,u.x),a=Math.max(a,u.y);return{min:new Be(e,i),max:new Be(o,a)}},s.b=function(r){return fr.API_FONTS_REGEX.test(r)},s.b$=g_,s.b0=vr,s.b1=Ee,s.b2=rp,s.b3=Yp,s.b4=function(){Io.isLoading()||Io.isLoaded()||Kh()!=="deferred"||Jh()},s.b5=gu,s.b6=be,s.b7=Mc,s.b8=tn,s.b9=k_,s.bA=Ti,s.bB=Vi,s.bC=function(r,e){const{x:i,y:o}=r.point,a=Jg(i,o,r.worldSize/r._pixelsPerMercatorPixel,0,0);return Yt(a,a,n_(ca(e)))},s.bD=It,s.bE=An,s.bF=Wo,s.bG=Fn,s.bH=Cr,s.bI=Gi,s.bJ=qu,s.bK=Go,s.bL=q_,s.bM=function(r,e,i,o,a){const u=5*e+2;r.float32[u+0]=i,r.float32[u+1]=o,r.float32[u+2]=a},s.bN=Xu,s.bO=yo,s.bP=Mn,s.bQ=xo,s.bR=Un,s.bS=ae,s.bT=function(r,e,i,o){var a=new nt(4);return a[0]=r,a[1]=e,a[2]=i,a[3]=o,a},s.bU=class{isDataAvailableAtPoint(r){const e=this._source();if(this.isUsingMockSource()||!e||r.y<0||r.y>1)return!1;const i=e.getSource().maxzoom,o=1<<i,a=Math.floor(r.x),u=Math.floor((r.x-a)*o),h=Math.floor(r.y*o),f=this.findDEMTileFor(new gn(i,a,i,u,h));return!(!f||!f.dem)}getAtPointOrZero(r,e=0){return this.getAtPoint(r,e)||0}getAtPoint(r,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const o=this._source();if(!o||r.y<0||r.y>1)return e;const a=o.getSource().maxzoom,u=1<<a,h=Math.floor(r.x),f=r.x-h,_=new gn(a,h,a,Math.floor(f*u),Math.floor(r.y*u)),g=this.findDEMTileFor(_);if(!g||!g.dem)return e;const v=g.dem,b=1<<g.tileID.canonical.z,w=(f*b-g.tileID.canonical.x)*v.dim,I=(r.y*b-g.tileID.canonical.y)*v.dim,A=Math.floor(w),P=Math.floor(I);return(i?this.exaggeration():1)*Ft(Ft(v.get(A,P),v.get(A,P+1),I-P),Ft(v.get(A+1,P),v.get(A+1,P+1),I-P),w-A)}static getAtTileOffset(r,e,i,o){const a=1<<r.canonical.z;return o?o.pointElevation(e):i?i.getAtPointOrZero(new _e(r.wrap+(r.canonical.x+e.x/Je)/a,(r.canonical.y+e.y/Je)/a)):0}static getAtTileOffsetFunc(r,e,i,o){return(a,u,h)=>{const f=this.getAtTileOffset(r,a,u,h),_=o.upVector(r.canonical,a.x,a.y);return Wi(_,_,f*o.upVectorScale(r.canonical,e,i).metersToTile),_}}getForTilePoints(r,e,i,o){if(this.isUsingMockSource())return!1;const a=Yu.create(this,r,o);return!!a&&(e.forEach((u=>{u[2]=this.exaggeration()*a.getElevationAt(u[0],u[1],i)})),!0)}getMinMaxForTile(r){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(r);if(!e||!e.dem)return null;const i=e.dem.tree,o=e.tileID,a=1<<r.canonical.z-o.canonical.z;let u=r.canonical.x/a-o.canonical.x,h=r.canonical.y/a-o.canonical.y,f=0;for(let _=0;_<r.canonical.z-o.canonical.z&&!i.leaves[f];_++){u*=2,h*=2;const g=2*Math.floor(h)+Math.floor(u);f=i.childOffsets[f]+g,u%=1,h%=1}return{min:this.exaggeration()*i.minimums[f],max:this.exaggeration()*i.maximums[f]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(r,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(r){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(r){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const r=this.visibleDemTiles;if(r.length===0)return null;let e=!1,i=Number.MAX_VALUE,o=Number.MIN_VALUE;for(const a of r){const u=this.getMinMaxForTile(a.tileID);u&&(i=Math.min(i,u.min),o=Math.max(o,u.max),e=!0)}return e?{min:i,max:o}:null}},s.bV=Ap,s.bW=jr,s.bX=zn,s.bY=Cy,s.bZ=jv,s.b_=zy,s.ba=p_,s.bb=Le,s.bc=mo,s.bd=Eu,s.be=$g,s.bf=Ar,s.bg=Ou,s.bh=rg,s.bi=function(r,e){const i=wl(e.zoom);if(i===0)return ca(r);const o=_p(r),a=r_(o),u=N(o.getWest())*e.worldSize,h=N(o.getEast())*e.worldSize,f=k(o.getNorth())*e.worldSize,_=k(o.getSouth())*e.worldSize,g=[u,f,0],v=[h,f,0],b=[u,_,0],w=[h,_,0],I=Mi([],e.globeMatrix);return nr(g,g,I),nr(v,v,I),nr(b,b,I),nr(w,w,I),a[0]=La(a[0],b,i),a[1]=La(a[1],w,i),a[2]=La(a[2],v,i),a[3]=La(a[3],g,i),ri.fromPoints(a)},s.bj=yp,s.bk=Mi,s.bl=wd,s.bm=La,s.bn=Pa,s.bo=Ab,s.bp=Si,s.bq=wi,s.br=lm,s.bs=Bp,s.bt=Na,s.bu=function(r,e){const i=[];for(const o in r)o in e||i.push(o);return i},s.bv=se,s.bw=["type","source","source-layer","minzoom","maxzoom","filter","layout"],s.bx=to,s.by=Tt,s.bz=Dt,s.c=Xn,s.c$=function(r){return r*r*r*r*r},s.c0=G_,s.c1=fv,s.c2=Y_,s.c3=gg,s.c4=Wi,s.c5=Bn,s.c6=Rt,s.c7=function(r,e,i){i*=.5;var o=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),_=Math.cos(i);return r[0]=o*_+a*f,r[1]=a*_-o*f,r[2]=u*_+h*f,r[3]=h*_-u*f,r},s.c8=qt,s.c9=Ur,s.cA=ki,s.cB=gx,s.cC=Vo,s.cD=Xg,s.cE=function(r,e,i,o,a,u,h,f,_){if(_.name==="globe")return Xg(r,e,new Vo(i,o,a),!1);const g=Zd({z:i,x:o,y:a},_);return new ri([(u+g.x/g.scale)*e,e*(g.y/g.scale),h],[(u+g.x2/g.scale)*e,e*(g.y2/g.scale),f])},s.cF=function(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r[3]=Math.min(e[3],i[3]),r},s.cG=function(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r[3]=Math.max(e[3],i[3]),r},s.cH=function(r){const e=Math.round((r+45+360)%360/90)%4;return Ps[e]},s.cI=Z,s.cJ=uo,s.cK=t,s.cL=function(r){const e=Dt(new Float64Array(16));Yt(e,r.pixelMatrix,r.globeMatrix);const i=[0,p,0],o=[0,m,0];return nr(i,i,e),nr(o,o,e),[i[0]>0&&i[0]<=r.width&&i[1]>0&&i[1]<=r.height&&!s_(r,new M(r.center.lat,90)),o[0]>0&&o[0]<=r.width&&o[1]>0&&o[1]<=r.height&&!s_(r,new M(r.center.lat,-90))]},s.cM=function(r,e){const{scale:i}=r.tileTransform,o=i*Je/(r.tileSize*Math.pow(2,e.zoom-r.tileID.overscaledZ+r.tileID.canonical.z));return(function(a,u,h){var f=u[1],_=u[2],g=u[3],v=h[0],b=h[1];return a[0]=u[0]*v,a[1]=f*v,a[2]=_*b,a[3]=g*b,a})(new Float32Array(4),e.inverseAdjustmentMatrix,[o,o])},s.cN=Dp,s.cO=Or,s.cP=_x,s.cQ=function(r){const e=_x(r,!0);return It([],[e[0],e[1],e[4],e[5]])},s.cR=Ci,s.cS=qi,s.cT=tr,s.cU=function(r){const{x:e,y:i}=r.point,{lng:o,lat:a}=r._center;return Jg(e,i,r.worldSize,o,a)},s.cV=Zn,s.cW=Jr,s.cX=Uo,s.cY=Gr,s.cZ=l,s.c_=function(r,e,i){let o=0;for(let a=0;a<2;++a)r[a]>0&&(o+=(r[a]-0)*(r[a]-0)),e[a]<0&&(o+=(0-e[a])*(0-e[a]));return o},s.ca=function(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r[3]=e[3],r},s.cb=br,s.cc=function(r,e,i,o,a){var u=1/Math.tan(e/2);if(r[0]=u/i,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=u,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,a!=null&&a!==1/0){var h=1/(o-a);r[10]=(a+o)*h,r[14]=2*a*o*h}else r[10]=-1,r[14]=-2*o;return r},s.cd=function(r,e,i,o,a,u,h){var f=1/(e-i),_=1/(o-a),g=1/(u-h);return r[0]=-2*f,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*_,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*g,r[11]=0,r[12]=(e+i)*f,r[13]=(a+o)*_,r[14]=(h+u)*g,r[15]=1,r},s.ce=U,s.cf=function(r,e,i){r[4*e+0]=i[0],r[4*e+1]=i[1],r[4*e+2]=i[2],r[4*e+3]=i[3]},s.cg=Ru,s.ch=yl,s.ci=Qr,s.cj=Is,s.ck=xc,s.cl=Sv,s.cm=function(){var r=new nt(4);return nt!=Float32Array&&(r[1]=0,r[2]=0),r[0]=1,r[3]=1,r},s.cn=function(r,e,i){var o=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),_=Math.cos(i);return r[0]=o*_+u*f,r[1]=a*_+h*f,r[2]=o*-f+u*_,r[3]=a*-f+h*_,r},s.co=function(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]},s.cp=co,s.cq=function(r){var e=r[0],i=r[1],o=r[2],a=r[3];return Math.sqrt(e*e+i*i+o*o+a*a)},s.cr=hi,s.cs=In,s.ct=As,s.cu=3,s.cv=2,s.cw=7,s.cx=6,s.cy=fn,s.cz=Jt,s.d=function(r){return fr.API_TILEJSON_REGEX.test(r)},s.d$=ty,s.d0=z,s.d1=45,s.d2=yc,s.d3=function(r,e,i){const o=Math.sqrt(r*r+e*e+i*i),a=o>0?Math.acos(i/o)*bo:0;let u=r!==0||e!==0?Math.atan2(-e,-r)*bo+90:0;return u<0&&(u+=360),[o,u,a]},s.d4=rr,s.d5=Xi,s.d6=re,s.d7=Er,s.d8=ri,s.d9=en,s.dA=yd,s.dB=class extends as{constructor(r){super(r),this.current=Km}set(r,e,i){if(this.fetchUniformLocation(r,e)){for(let o=0;o<9;o++)if(i[o]!==this.current[o]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},s.dC=ds,s.dD=function(r,e,i){const o=wl(i.zoom),a=r.style.map._antialias,u=r.terrain&&r.terrain.exaggeration()>0;return o===0&&!a&&!u},s.dE=function(r){const e=r.pixelsPerMeter,i=e/U(1,r.center.lat),o=Dt(new Float64Array(16));return wi(o,o,[r.point.x,r.point.y,0]),Ci(o,o,[i,i,e]),Float32Array.from(o)},s.dF=_p,s.dG=function(r){const e=Z-5;r=B(r,-e,e)/e*90;const i=Math.pow(Math.abs(Math.sin(ii(r))),3);return Math.round(i*(d.length-1))},s.dH=function(r,e,i,o){const a=e.getNorth(),u=e.getSouth(),h=e.getWest(),f=e.getEast(),_=1<<r.z,g=f-h,v=a-u,b=g/c,w=-v/d[i],I=[0,b,0,w,0,0,a,h,0];if(r.z>0){const A=180/o;ei(I,I,[A/g+1,0,0,0,A/v+1,0,-.5*A/b,.5*A/w,1])}return I[2]=_,I[5]=r.x,I[8]=r.y,I},s.dI=ca,s.dJ=function(r,e,i){const o=Dt(new Float64Array(16)),a=(e/(1<<r)-.5)*Math.PI*2;return vi(o,i.globeMatrix,a),Float32Array.from(o)},s.dK=hy,s.dL=mp,s.dM=function(r,e){return[Math.pow(r[0],2.2)*e,Math.pow(r[1],2.2)*e,Math.pow(r[2],2.2)*e]},s.dN=At,s.dO=function(r,e){var i=Math.sin(e),o=Math.cos(e);return r[0]=o,r[1]=i,r[2]=0,r[3]=-i,r[4]=o,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},s.dP=kn,s.dQ=Kg,s.dR=dr,s.dS=Rr,s.dT=256,s.dU=function(r,e){const i=[0,0,0];return nr(i,i,yp(ca(e.canonical))),nr(i,i,r),i},s.dV=r=>({u_matrix:new xc(r),u_texsize:new Is(r),u_pixels_to_tile_units:new xd(r),u_device_pixel_ratio:new Qr(r),u_width_scale:new Qr(r),u_floor_width_scale:new Qr(r),u_image:new Ru(r),u_units_to_pixels:new Is(r),u_tile_units_to_pixels:new Qr(r),u_alpha_discard_threshold:new Qr(r),u_trim_offset:new Is(r),u_trim_fade_range:new Is(r),u_trim_color:new yc(r),u_emissive_strength:new Qr(r),u_zbias_factor:new Qr(r),u_tile_to_meter:new Qr(r),u_ground_shadow_factor:new yl(r),u_pattern_transition:new Qr(r)}),s.dW=r=>({u_matrix:new xc(r),u_pixels_to_tile_units:new xd(r),u_device_pixel_ratio:new Qr(r),u_width_scale:new Qr(r),u_floor_width_scale:new Qr(r),u_units_to_pixels:new Is(r),u_dash_image:new Ru(r),u_gradient_image:new Ru(r),u_image_height:new Qr(r),u_texsize:new Is(r),u_tile_units_to_pixels:new Qr(r),u_alpha_discard_threshold:new Qr(r),u_trim_offset:new Is(r),u_trim_fade_range:new Is(r),u_trim_color:new yc(r),u_emissive_strength:new Qr(r),u_zbias_factor:new Qr(r),u_tile_to_meter:new Qr(r),u_ground_shadow_factor:new yl(r)}),s.dX=r=>({u_camera_to_center_distance:new Qr(r),u_extrude_scale:new xd(r),u_device_pixel_ratio:new Qr(r),u_matrix:new xc(r),u_inv_rot_matrix:new xc(r),u_merc_center:new Is(r),u_tile_id:new yl(r),u_zoom_transition:new Qr(r),u_up_dir:new yl(r),u_emissive_strength:new Qr(r)}),s.dY=pl,s.dZ=pw,s.d_=class{constructor(r,e,i,o){this.context=r,this.format=o,this.size=i,this.texture=r.gl.createTexture();const[a,u,h]=this.size,{gl:f}=r;f.bindTexture(f.TEXTURE_3D,this.texture),r.pixelStoreUnpackFlipY.set(!1),r.pixelStoreUnpack.set(1),r.pixelStoreUnpackPremultiplyAlpha.set(!1),"data"in e&&e.data&&f.texImage3D(f.TEXTURE_3D,0,this.format,a,u,h,0,A_(this.format),M_(this.format),e.data)}bind(r,e){const{context:i}=this,{gl:o}=i;o.bindTexture(o.TEXTURE_3D,this.texture),r!==this.minFilter&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MAG_FILTER,r),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MIN_FILTER,r),this.minFilter=r),e!==this.wrapS&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_S,e),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:r}=this.context;r.deleteTexture(this.texture),this.texture=null}},s.da=function(r){return[Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)]},s.db=mx,s.dc=O_,s.dd=vx,s.de=og,s.df=function(r,e){return r.readFields(hT,{icons:[]},e)},s.dg=Mp,s.dh=$u,s.di=Z_,s.dj=lh,s.dk=Wf,s.dl=Dl,s.dm=Ul,s.dn=bt,s.dp=function(r){const e=r.indexOf(dc);return e>=0?r.slice(0,e):r},s.dq=function(r){return r.indexOf(dc)>=0},s.dr=function(r){const e=r.lastIndexOf(dc);return e>=0?r.slice(e+1):""},s.ds=function(r){const e=[],i=r.id;return i===void 0&&e.push({message:"layers.".concat(i,': missing required property "id"')}),r.render===void 0&&e.push({message:"layers.".concat(i,': missing required method "render"')}),r.renderingMode&&r.renderingMode!=="2d"&&r.renderingMode!=="3d"&&e.push({message:"layers.".concat(i,': property "renderingMode" must be either "2d" or "3d"')}),e},s.dt=function(r,e,i,o){return r.type==="custom"?new nT(r,e):new cT[r.type](r,e,i,o)},s.du=je,s.dv=function(r){const e=r.indexOf(dc);return e>=0?r.slice(e+1):""},s.dw=class extends Mc{constructor(r,e){super(r._vectorTileFeature,r._z,r._x,r._y,r.id),r.state&&(this.state=Object.assign({},r.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=r.source,this.sourceLayer=r.sourceLayer,this.layer=r.layer)}toJSON(){const r=super.toJSON();return r.target=this.target,r.namespace=this.namespace,r}},s.dx=Yh,s.dy=Ol,s.dz=function(r){return r({pluginStatus:no,pluginURL:oa}),Yh.on("pluginStateChange",r),r},s.e=fr,s.e$=function([r,e,i]){const o=Math.hypot(r,e,i),a=Math.atan2(r,i),u=.5*Math.PI-Math.acos(-e/o);return new M(Jr(a),Jr(u))},s.e0=(r,e,i,o,a,u)=>{const h=r.transform,f=h.projection.name==="globe";let _;if(u.paint.get("circle-pitch-alignment")==="map")if(f){const v=Kg(h.zoom,e.canonical)*h._pixelsPerMercatorPixel;_=Float32Array.from([v,0,0,v])}else _=h.calculatePixelsToTileUnitsMatrix(i);else _=new Float32Array([h.pixelsToGLUnits[0],0,0,h.pixelsToGLUnits[1]]);const g={u_camera_to_center_distance:r.transform.getCameraToCenterDistance(h.projection),u_matrix:r.translatePosMatrix(e.projMatrix,i,u.paint.get("circle-translate"),u.paint.get("circle-translate-anchor")),u_device_pixel_ratio:To.devicePixelRatio,u_extrude_scale:_,u_inv_rot_matrix:Db,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:u.paint.get("circle-emissive-strength")};if(f){g.u_inv_rot_matrix=o,g.u_merc_center=a,g.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],g.u_zoom_transition=wl(h.zoom);const v=a[0]*Je,b=a[1]*Je;g.u_up_dir=h.projection.upVector(new Vo(0,0,0),v,b)}return g},s.e1=kx,s.e2=po,s.e3=(r,e,i,o,a,u,h,f,_,g)=>{const v=r.transform,b=v.pitch<15?Lx(.07,.7,B((14-v.zoom)/5,0,1)):.07,w=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:Fx(r,e,i,o),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:v.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:a,u_width_scale:u,u_floor_width_scale:h,u_image:0,u_tile_units_to_pixels:Ox(e,v),u_units_to_pixels:[1/v.pixelsToGLUnits[0],1/v.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:f,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(w?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:b,u_tile_to_meter:re(e.tileID.canonical,0),u_ground_shadow_factor:_,u_pattern_transition:g}},s.e4=(r,e,i,o,a,u,h,f,_,g)=>{const v=r.transform,b=v.calculatePixelsToTileUnitsMatrix(e),w=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",I=v.pitch<15?Lx(.07,.7,B((14-v.zoom)/5,0,1)):.07;return{u_matrix:Fx(r,e,i,o),u_pixels_to_tile_units:b,u_device_pixel_ratio:u,u_width_scale:h,u_floor_width_scale:f,u_units_to_pixels:[1/v.pixelsToGLUnits[0],1/v.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:a,u_texsize:Bx(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Ox(e,r.transform),u_alpha_discard_threshold:0,u_trim_offset:_,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(w?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:I,u_tile_to_meter:re(e.tileID.canonical,0),u_ground_shadow_factor:g}},s.e5=pe,s.e6=Td,s.e7=ee,s.e8=za,s.e9=Ip,s.eA=lg,s.eB=Op,s.eC=Lp,s.eD=[1,1,1],s.eE=Yu,s.eF=vn,s.eG=function(r,e,i,o){var a=e[0],u=e[1],h=e[2],f=e[3];return r[0]=a+o*(i[0]-a),r[1]=u+o*(i[1]-u),r[2]=h+o*(i[2]-h),r[3]=f+o*(i[3]-f),r},s.eH=Uu,s.eI=ss,s.eJ=la,s.eK=function(r,e,i,o,a,u,h,f,_,g,v,b,w,I,A,P){var D=new nt(16);return D[0]=r,D[1]=e,D[2]=i,D[3]=o,D[4]=a,D[5]=u,D[6]=h,D[7]=f,D[8]=_,D[9]=g,D[10]=v,D[11]=b,D[12]=w,D[13]=I,D[14]=A,D[15]=P,D},s.eL=T,s.eM=hd,s.eN=pc,s.eO=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Be(1/0,1/0),max:new Be(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(r,e=!1){const i=Ry(new Be(0,0),new Be(Je,Je),r),o=[];if(e&&!m_(i,this._globalClipBounds))return o;for(const a of this._activeRegions){if(a.hiddenByOverlap||!m_(i,a))continue;const u=a1(a.min,a.max,r);o.push({min:u.min,max:u.max,sourceId:this._sourceIds[a.priority],footprint:a.footprint,footprintTileId:a.tileId,order:a.order,clipMask:a.clipMask,clipScope:a.clipScope})}return o}setSources(r){this._setSources(r.map((e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const o of e.cache.getVisibleCoordinates()){const a=e.cache.getTile(o).buckets[e.layer];a&&a.updateFootprints(o.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope}))))}_addSource(r){const e=r.getFootprints();if(e.length===0)return;const i=r.getOrder(),o=r.getClipMask(),a=r.getClipScope();for(const u of e){if(!u.footprint)continue;const h=Ry(u.footprint.min,u.footprint.max,u.id);this._activeRegions.push({min:h.min,max:h.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:u.id,footprint:u.footprint,order:i,clipMask:o,clipScope:a})}this._sourceIds.push(r.getSourceId())}_computeReplacement(){this._activeRegions.sort(((e,i)=>e.priority-i.priority||Tp(e.min,i.min)||Tp(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||(function(o,a){const u=(h,f)=>h+f;return o.length-a.length||o.reduce(u,"").localeCompare(a.reduce(u,""))})(e.clipScope,i.clipScope)));let r=this._activeRegions.length!==this._prevRegions.length;if(!r){let e=0;for(;!r&&e!==this._activeRegions.length;){const i=this._activeRegions[e],o=this._prevRegions[e];r=i.priority!==o.priority||!Py(i,o)||i.order!==o.order||i.clipMask!==o.clipMask||!to(i.clipScope,o.clipScope),this._activeRegions[e].hiddenByOverlap=o.hiddenByOverlap,++e}}if(r){++this._updateTime;for(const i of this._activeRegions)i.order!==Cd&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));const e=i=>{const o=this._activeRegions;if(i>=o.length)return i;const a=o[i].priority;for(;i<o.length&&o[i].priority===a;)++i;return i};if(this._sourceIds.length>1){let i=0,o=e(i);for(;i!==o;){let a=i;const u=i;for(;a!==o;){const h=this._activeRegions[a];h.hiddenByOverlap=!1;for(let f=0;f<u;f++){const _=this._activeRegions[f];if(!_.hiddenByOverlap&&h.order===Cd&&m_(h,_)&&(h.hiddenByOverlap=Dy(h.footprint,h.tileId,_.footprint,_.tileId),h.hiddenByOverlap))break}++a}i=o,o=e(i)}}}}_setSources(r){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=r.length-1;e>=0;e--)this._addSource(r[e]);this._computeReplacement()}},s.eP=Cd,s.eQ=class{constructor(r){this._createGrid(r),this._createPoles(r)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const r of this._poleSegments)r.destroy();for(const r of this._gridSegments)r.withSkirts.destroy(),r.withoutSkirts.destroy()}_fillGridMeshWithLods(r,e){const i=new mo,o=new vr,a=[],u=r+1+2,h=e[0]+1,f=e[0]+1+(1+e.length),_=(g,v,b)=>{let w=g===u-1?g-2:g===0?g:g-1;return w+=b?24575:0,[w,v]};for(let g=0;g<u;++g)i.emplaceBack(..._(g,0,!0));for(let g=0;g<h;++g)for(let v=0;v<u;++v)i.emplaceBack(..._(v,g,(v===0||v===u-1)&&!0));for(let g=0;g<e.length;++g){const v=e[g];for(let b=0;b<u;++b)i.emplaceBack(..._(b,v,!0))}for(let g=0;g<e.length;++g){const v=o.length,b=e[g]+1+2,w=new vr;for(let P=0;P<b-1;P++){const D=P===b-2,L=D?u*(f-e.length+g-P):u;for(let V=0;V<u-1;V++){const j=P*u+V;P===0||D||V===0||V===u-2?(w.emplaceBack(j+1,j,j+L),w.emplaceBack(j+L,j+L+1,j+1)):(o.emplaceBack(j+1,j,j+L),o.emplaceBack(j+L,j+L+1,j+1))}}const I=Ar.simpleSegment(0,v,i.length,o.length-v);for(let P=0;P<w.uint16.length;P+=3)o.emplaceBack(w.uint16[P],w.uint16[P+1],w.uint16[P+2]);const A=Ar.simpleSegment(0,v,i.length,o.length-v);a.push({withoutSkirts:I,withSkirts:A})}return{vertices:i,indices:o,segments:a}}_createGrid(r){const e=this._fillGridMeshWithLods(c,d);this._gridSegments=e.segments,this._gridBuffer=r.createVertexBuffer(e.vertices,$g.members),this._gridIndexBuffer=r.createIndexBuffer(e.indices,!0)}_createPoles(r){const e=new vr;for(let h=0;h<=c;h++)e.emplaceBack(0,h+1,h+2);this._poleIndexBuffer=r.createIndexBuffer(e,!0);const i=new Da,o=new Da,a=new Da,u=new Da;this._poleSegments=[];for(let h=0,f=0;h<l;h++){const _=360/(1<<h);i.emplaceBack(0,-_o,0,.5,0),o.emplaceBack(0,-_o,0,.5,1),a.emplaceBack(0,-_o,0,.5,.5),u.emplaceBack(0,-_o,0,.5,.5);for(let g=0;g<=c;g++){let v=g/c,b=0;const w=Ft(0,_,v),[I,A,P]=y(Pb,Rb,w,_o);i.emplaceBack(I,A,P,v,b),o.emplaceBack(I,A,P,v,1-b);const D=ii(w);v=.5+.5*Math.sin(D),b=.5+.5*Math.cos(D),a.emplaceBack(I,A,P,v,b),u.emplaceBack(I,A,P,v,1-b)}this._poleSegments.push(Ar.simpleSegment(f,0,66,64)),f+=66}this._poleNorthVertexBuffer=r.createVertexBuffer(i,Lu,!1),this._poleSouthVertexBuffer=r.createVertexBuffer(o,Lu,!1),this._texturedPoleNorthVertexBuffer=r.createVertexBuffer(a,Lu,!1),this._texturedPoleSouthVertexBuffer=r.createVertexBuffer(u,Lu,!1)}getGridBuffers(r,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[r].withSkirts:this._gridSegments[r].withoutSkirts]}getPoleBuffers(r,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[r]]}},s.eR=My,s.eS=fe,s.eT=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},s.eU=O,s.eV=Y,s.eW=function(r,e,i){return r[0]=e[0]/i[0],r[1]=e[1]/i[1],r[2]=e[2]/i[2],r},s.eX=hs,s.eY=x,s.eZ=us,s.e_=Li,s.ea=Zy,s.eb=Sl,s.ec=ky,s.ed=Fy,s.ee=Q,s.ef=function(r,e){if(r===e){var i=e[1],o=e[2],a=e[3],u=e[6],h=e[7],f=e[11];r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=i,r[6]=e[9],r[7]=e[13],r[8]=o,r[9]=u,r[11]=e[14],r[12]=a,r[13]=h,r[14]=f}else r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15];return r},s.eg=rT,s.eh=ai,s.ei=fd,s.ej=256,s.ek=n_,s.el=Fo,s.em=vi,s.en=function(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],r},s.eo=Da,s.ep=ud,s.eq=Uf,s.er=function(r,e,i,o,a){return B((r-e)/(i-e)*(a-o)+o,o,a)},s.es=bi,s.et=function(r,e){var i=e[0],o=e[1],a=e[2],u=e[3],h=e[4],f=e[5],_=e[6],g=e[7],v=e[8],b=v*h-f*g,w=-v*u+f*_,I=g*u-h*_,A=i*b+o*w+a*I;return A?(r[0]=b*(A=1/A),r[1]=(-v*o+a*g)*A,r[2]=(f*o-a*h)*A,r[3]=w*A,r[4]=(v*i-a*_)*A,r[5]=(-f*i+a*u)*A,r[6]=I*A,r[7]=(-g*i+o*_)*A,r[8]=(h*i-o*u)*A,r):null},s.eu=2,s.ev=Qn,s.ew=Po,s.ex=Sr,s.ey=function(r,e){var i=new nt(3);Sr(i,e);var o=1/i[0],a=1/i[1],u=1/i[2],h=e[0]*o,f=e[1]*a,_=e[2]*u,g=e[4]*o,v=e[5]*a,b=e[6]*u,w=e[8]*o,I=e[9]*a,A=e[10]*u,P=h+v+A,D=0;return P>0?(D=2*Math.sqrt(P+1),r[3]=.25*D,r[0]=(b-I)/D,r[1]=(w-_)/D,r[2]=(f-g)/D):h>v&&h>A?(D=2*Math.sqrt(1+h-v-A),r[3]=(b-I)/D,r[0]=.25*D,r[1]=(f+g)/D,r[2]=(w+_)/D):v>A?(D=2*Math.sqrt(1+v-h-A),r[3]=(w-_)/D,r[0]=(f+g)/D,r[1]=.25*D,r[2]=(b+I)/D):(D=2*Math.sqrt(1+A-h-v),r[3]=(f-g)/D,r[0]=(w+_)/D,r[1]=(b+I)/D,r[2]=.25*D),r},s.ez=function(r,e){var i=2*Math.acos(e[3]),o=Math.sin(i/2);return o>et?(r[0]=e[0]/o,r[1]=e[1]/o,r[2]=e[2]/o):(r[0]=1,r[1]=0,r[2]=0),i},s.f=function(r){return btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,((e,i)=>String.fromCharCode(+("0x"+i)))))},s.f0=vs,s.f1=P_,s.f2=function(r){const e=r.navigator?r.navigator.userAgent:null;return!!(function(i){if(Hr==null){const o=i.navigator?i.navigator.userAgent:null;Hr=!!i.safari||!(!o||!(/\b(iPad|iPhone|iPod)\b/.test(o)||o.match("Safari")&&!o.match("Chrome")))}return Hr})(r)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},s.f3=function(r,e){Ll=r,fo=e},s.f4=s_,s.f5=Qg,s.f6=function(r){const e=[0,0,0],i=Dt(new Float64Array(16));return Yt(i,r.pixelMatrix,r.globeMatrix),nr(e,e,i),new Be(e[0],e[1])},s.f7=function(){const r=Od;r&&(r.isPreloaded()&&r.numActive()===1?(r.release(w_),Od=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},s.f8=function(){Mp().acquire(w_)},s.f9=Kh,s.fA=Ve,s.fB=function(r){let e=0;if(new Uint32Array(r,0,1)[0]!==ux){const i=new Uint32Array(r,0,7),[,,o,a,u,h]=i;e=i.byteLength+a+u+h+u,(o!==r.byteLength||e>=r.byteLength)&&Mt("Invalid b3dm header information.")}return px(r,e)},s.fC=function(r,e){const i=O_(r);for(const o of i){for(const a of o.meshes)B1(a);o.lights&&(o.lightMeshIndex=o.meshes.length,o.meshes.push(N1(o.lights,e)))}return i},s.fD=tm,s.fE=Fr,s.fF=ox,s.fG=Io,s.fH=Eo,s.fI=function(r){ma(),ro!=null&&ro.then((e=>{e.keys().then((i=>{for(let o=0;o<i.length-r;o++)e.delete(i[o]).catch((a=>Mt(a.message)))})).catch((i=>Mt(i.message)))})).catch((e=>Mt(e.message)))},s.fa=function(r,e,i=!1){if(no===Eo.deferred||no===Eo.loading||no===Eo.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");oa=To.resolveURL(r),no=Eo.deferred,Wh=e,Xh(),i||Jh()},s.fb=function(r){Bu=To.resolveURL(r),Nu||(Nu=new ku(Mp(),new Ds)),Nu.broadcast("setMeshoptUrl",Bu)},s.fc=lx,s.fd=function(r){S_=To.resolveURL(r),Nu||(Nu=new ku(Mp(),new Ds)),Nu.broadcast("setDracoUrl",S_)},s.fe=ax,s.ff=Ld,s.fg=function(r){const e=Rs();if(!e)return;const i=e.delete(zl);r&&i.then((()=>r())).catch(r)},s.fh=Tc,s.fi=pt,s.fj=Tl,s.fk=$s,s.fl=C0,s.fm=P0,s.fn=Px,s.fo=ct,s.fp="hd_road_elevation",s.fq=Ut,s.fr=We,s.fs=Oa,s.ft=$_,s.fu=Ic,s.fv=function(r,e,i,o,a,u,h,f=1,_,g,v){r.createArrays(),r.tilePixelRatio=Je/(512*r.overscaling),r.compareText={},r.iconsNeedLinear=!1;const b=r.layers[0].layout,w=r.layers[0]._unevaluatedLayout._values,I={};I.scaleFactor=f,I.textSizeScaleRange=b.get("text-size-scale-range"),I.iconSizeScaleRange=b.get("icon-size-scale-range");const[A,P]=I.textSizeScaleRange,[D,L]=I.iconSizeScaleRange;I.textScaleFactor=B(I.scaleFactor,A,P),I.iconScaleFactor=B(I.scaleFactor,D,L);const V=w["text-size"],j=w["icon-size"];if(r.textSizeData.kind==="composite"){const{minZoom:ue,maxZoom:Me}=r.textSizeData;I.compositeTextSizes=[V.possiblyEvaluate(new lr(ue,{worldview:v}),u),V.possiblyEvaluate(new lr(Me,{worldview:v}),u)]}if(r.iconSizeData.kind==="composite"){const{minZoom:ue,maxZoom:Me}=r.iconSizeData;I.compositeIconSizes=[j.possiblyEvaluate(new lr(ue,{worldview:v}),u),j.possiblyEvaluate(new lr(Me,{worldview:v}),u)]}I.layoutTextSize=V.possiblyEvaluate(new lr(h+1,{worldview:v}),u),I.layoutIconSize=j.possiblyEvaluate(new lr(h+1,{worldview:v}),u),I.textMaxSize=V.possiblyEvaluate(new lr(18,{worldview:v}),u);const H=b.get("symbol-placement"),te=b.get("text-rotation-alignment")==="map"&&H!=="point",K=b.get("text-size");let oe=!1;const le=[];for(const ue of r.features){const Me=b.get("text-font").evaluate(ue,{},u).join(","),ye=K.evaluate(ue,{},u)*I.textScaleFactor,Ce=I.layoutTextSize.evaluate(ue,{},u)*I.textScaleFactor,Oe=I.layoutIconSize.evaluate(ue,{},u)*I.iconScaleFactor,Ne={horizontal:{},vertical:void 0},Ye=ue.text;let He,Fe=[0,0];if(Ye){const oi=Ye.toString(),yi=b.get("text-letter-spacing").evaluate(ue,{},u)*zn,$t=b.get("text-line-height").evaluate(ue,{},u)*zn,Pi=$f(oi)?yi:0,Ri=b.get("text-anchor").evaluate(ue,{},u),Tr=b.get("text-variable-anchor");if(!Tr){const De=b.get("text-radial-offset").evaluate(ue,{},u);if(De)Fe=fv(Ri,[De*zn,X_]);else{const st=b.get("text-offset").evaluate(ue,{},u);Fe=[st[0]*zn,st[1]*zn]}}let J=te?"center":b.get("text-justify").evaluate(ue,{},u);const W=H==="point",Re=W?b.get("text-max-width").evaluate(ue,{},u)*zn:1/0,it=De=>{r.allowVerticalPlacement&&qh(oi)&&(Ne.vertical=j_(Ye,e,i,a,Me,Re,$t,Ri,De,Pi,Fe,Go.vertical,!0,Ce,ye,_))};if(!te&&Tr){const De=J==="auto"?Tr.map((wt=>Y_(wt))):[J];let st=!1;for(let wt=0;wt<De.length;wt++){const vt=De[wt];if(!Ne.horizontal[vt])if(st)Ne.horizontal[vt]=Ne.horizontal[0];else{const Zt=j_(Ye,e,i,a,Me,Re,$t,"center",vt,Pi,Fe,Go.horizontal,!1,Ce,ye,_);Zt&&(Ne.horizontal[vt]=Zt,st=Zt.positionedLines.length===1)}}it("left")}else{if(J==="auto"&&(J=Y_(Ri)),W||b.get("text-writing-mode").indexOf("horizontal")>=0||!qh(oi)){const De=j_(Ye,e,i,a,Me,Re,$t,Ri,J,Pi,Fe,Go.horizontal,!1,Ce,ye,_);De&&(Ne.horizontal[J]=De)}it(W?"left":J)}}let Ge,Ie,Se,Ue,Ze,ke,ft=!1;const _t=b.get("icon-text-fit").evaluate(ue,{},u);if(ue.icon&&ue.icon.hasPrimary()){const oi=qd(ue.icon,r.iconSizeData,w["icon-size"],u,r.zoom,ue,_,I.iconScaleFactor,v);Ge=oi.iconPrimary,Se=oi.iconSecondary;const yi=Ge.toString();if(Ie=o.get(yi),Ie&&(Ze=b.get("icon-offset").evaluate(ue,{},u),ke=b.get("icon-anchor").evaluate(ue,{},u),He=Vp(a.get(yi),Se?a.get(Se.toString()):void 0,Ze,ke),ft=Ie.sdf,r.sdfIcons===void 0?r.sdfIcons=Ie.sdf:r.sdfIcons!==Ie.sdf&&Mt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ie.pixelRatio!==r.pixelRatio||b.get("icon-rotate").constantOr(1)!==0)&&(r.iconsNeedLinear=!0)),Se){const $t=Se.toString();Ue=o.get($t)}}oe=oe||!(!ue.icon||!ue.icon.hasSecondary());const ut=K_(Ne.horizontal)||Ne.vertical;r.iconsInText||(r.iconsInText=!!ut&&ut.iconsInText);const ot=Ce*I.textScaleFactor/zn,{defaultShapedIcon:jt,verticallyShapedIcon:at}=Gw(r,He,b,ue,u,Ne,ot,Ze,_t);_t!=="none"&&He&&(Jx(He)||Qx(He))&&(qp(0,Ie,Ge,He,jt,_t,g,o,a),qp(0,Ue,Se,He,jt,_t,g,o,a),at&&(qp(0,Ie,Ge,He,at,_t,g,o,a),qp(0,Ue,Se,He,at,_t,g,o,a))),He=jt;const{iconBBox:Et,iconVerticalBBox:Ht}=Vw(r,He,at,b,ue,u,Oe,Ze,I,a,ke);le.push({feature:ue,shapedTextOrientations:Ne,shapedText:ut,shapedIcon:He,iconPrimary:Ge,iconSecondary:Se,iconOffset:Ze,iconAnchor:ke,verticallyShapedIcon:at,layoutTextSize:Ce,layoutIconSize:Oe,textOffset:Fe,isSDFIcon:ft,iconTextFit:_t,iconCollisionBounds:Et,iconVerticalCollisionBounds:Ht})}return{featureData:le,sizes:I,hasAnySecondaryIcon:oe,textAlongLine:te,symbolPlacement:H}},s.fw=av,s.fx=function(r,e,i,o,a,u,h,f,_,g){r.iconAtlasPositions=g.iconPositions;const{featureData:v,hasAnySecondaryIcon:b,sizes:w,textAlongLine:I,symbolPlacement:A}=e;for(const P of v){const{shapedIcon:D,verticallyShapedIcon:L,feature:V,shapedTextOrientations:j,shapedText:H,layoutTextSize:te,textOffset:K,isSDFIcon:oe,iconPrimary:le,iconSecondary:ue,iconTextFit:Me,iconOffset:ye,iconCollisionBounds:Ce,iconVerticalCollisionBounds:Oe}=P;mv(D,g.iconPositions,le,ue),mv(L,g.iconPositions,le,ue),jw(j,g.iconPositions),Uw(le,ue,g.iconPositions),(H||D)&&Hw(r,V,j,D,L,_,w,te,0,K,oe,o,a,h,f,b,Me,ye,I,A,Ce,Oe)}i&&r.generateCollisionDebugBuffers(u,r.collisionBoxArray,w.textScaleFactor)},s.fy=gt,s.fz=am,s.g=function(r,e){return Ol(Object.assign(r,{method:"GET"}),e)},s.h=function(r){return r.indexOf("mapbox:")===0},s.i=function(r){return fr.API_STYLE_REGEX.test(r)&&!Xn(r)},s.j=un,s.k=Dc,s.l=function(r){return decodeURIComponent(atob(r).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""))},s.m=function(r,e){return Ol(Object.assign(r,{type:"json"}),e)},s.n=uh,s.o=To,s.p=function(r,e){return Ol(Object.assign(r,{method:"POST"}),e)},s.q=Hn,s.r=wo,s.s=function(r){try{const e=self[r];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch(e){return!1}},s.t=function(){return T_||(T_=new Tc),T_},s.u=function(){return(function r(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,r)})()},s.v=function(r){return!!r&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)},s.w=Mt,s.x=fg,s.y=jl,s.z=Do})),we(["./shared"],(function(s){function et(fe){const O=fe?fe.url.toString():void 0;return O?performance.getEntriesByName(O):[]}function nt(fe){if(typeof fe=="number"||typeof fe=="boolean"||typeof fe=="string"||fe==null)return JSON.stringify(fe);if(Array.isArray(fe)){let B="[";for(const X of fe)B+="".concat(nt(X),",");return"".concat(B,"]")}let O="{";for(const B of Object.keys(fe).sort())O+="".concat(B,":").concat(nt(fe[B]),",");return"".concat(O,"}")}function It(fe){let O="";for(const B of s.bw)O+="/".concat(nt(fe[B]));return O}class At{constructor(O){this.keyCache={},this._layers={},this._layerConfigs={},O&&this.replace(O)}replace(O,B){this._layerConfigs={},this._layers={},this.update(O,[],B)}update(O,B,X){this._options=X;for(const se of O)this._layerConfigs[se.id]=se,(this._layers[se.id]=s.dt(se,this.scope,null,this._options)).compileFilter(X),this.keyCache[se.id]&&delete this.keyCache[se.id];for(const se of B)delete this.keyCache[se],delete this._layerConfigs[se],delete this._layers[se];this.familiesBySource={};const ae=(function(se,de){const Ee={};for(let Te=0;Te<se.length;Te++){const We=se[Te];let je=de&&de[We.id];je||(We.type==="symbol"?je=We.id:(je=It(We),We.type==="line"&&We.paint&&(function Vt(kt){return typeof kt=="string"&&kt==="line-progress"||(Array.isArray(kt)?kt.some(Vt):!(!kt||typeof kt!="object")&&Object.values(kt).some(Vt))})(We.paint["line-width"])&&(je+="/".concat(nt(We.paint["line-width"]))))),de&&(de[We.id]=je);let bt=Ee[je];bt||(bt=Ee[je]=[]),bt.push(We)}const pe=[];for(const Te in Ee)pe.push(Ee[Te]);return pe})(Object.values(this._layerConfigs),this.keyCache);for(const se of ae){const de=se.map((bt=>this._layers[bt.id])),Ee=de[0];if(Ee.visibility==="none")continue;const pe=Ee.source||"";let Te=this.familiesBySource[pe];Te||(Te=this.familiesBySource[pe]={});const We=Ee.sourceLayer||"_geojsonTileLayer";let je=Te[We];je||(je=Te[We]=[]),je.push(de)}}}const Xt=1*s.fk;class ei{constructor(O){const B={},X=[];for(const Ee in O){const pe=O[Ee],Te=B[Ee]={};for(const We in pe.glyphs){const je=pe.glyphs[+We];if(!je||je.bitmap.width===0||je.bitmap.height===0)continue;const bt=je.metrics.localGlyph?Xt:1,Vt={x:0,y:0,w:je.bitmap.width+2*bt,h:je.bitmap.height+2*bt};X.push(Vt),Te[We]=Vt}}const{w:ae,h:se}=s.G(X),de=new s.fj({width:ae||1,height:se||1});for(const Ee in O){const pe=O[Ee];for(const Te in pe.glyphs){const We=pe.glyphs[+Te];if(!We||We.bitmap.width===0||We.bitmap.height===0)continue;const je=B[Ee][Te],bt=We.metrics.localGlyph?Xt:1;s.fj.copy(We.bitmap,de,{x:0,y:0},{x:je.x+bt,y:je.y+bt},We.bitmap)}}this.image=de,this.positions=B}}function Vi(fe,O,B){fe[O]?B&&(fe[O].center=B):fe[O]={floorIds:new Set,center:B||[0,0],floors:{}}}function Tt(fe,O,B,X){for(const ae of O)Vi(fe,ae),fe[ae].floors[B]=X,fe[ae].floorIds.add(B)}function Dt(fe){return{id:fe.properties.id.toString(),center:fe.properties.center.toString().split(";").map(Number)}}function Mi(fe){return{id:fe.properties.id.toString(),isDefault:!!fe.properties.is_default&&fe.properties.is_default,connections:fe.properties.connected_floor_ids?new Set(fe.properties.connected_floor_ids.toString().split(";")):new Set,conflicts:fe.properties.conflicted_floor_ids?new Set(fe.properties.conflicted_floor_ids.toString().split(";")):new Set,buildings:fe.properties.building_ids?new Set(fe.properties.building_ids.toString().split(";")):new Set,name:fe.properties.name.toString(),zIndex:fe.properties.z_index}}function Yt(fe,O){return O.every((B=>fe.properties&&fe.properties[B]!=null))}function wi(fe){return Yt(fe,["type","id","name"])&&fe.properties.type==="building"}function Ci(fe){return Yt(fe,["type","id","name","z_index"])&&fe.properties.type==="floor"}s.fi(ei,"GlyphAtlas");class tr{constructor(O){this.tileID=new s.aP(O.tileID.overscaledZ,O.tileID.wrap,O.tileID.canonical.z,O.tileID.canonical.x,O.tileID.canonical.y),this.tileZoom=O.tileZoom,this.uid=O.uid,this.zoom=O.zoom,this.lut=O.lut,this.canonical=O.tileID.canonical,this.pixelRatio=O.pixelRatio,this.tileSize=O.tileSize,this.source=O.source,this.scope=O.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=O.showCollisionBoxes,this.collectResourceTiming=!!O.request&&O.request.collectResourceTiming,this.promoteId=O.promoteId,this.isSymbolTile=O.isSymbolTile,this.tileTransform=s.aY(O.tileID.canonical,O.projection),this.projection=O.projection,this.worldview=O.worldview,this.localizableLayerIds=O.localizableLayerIds,this.brightness=O.brightness,this.extraShadowCaster=!!O.extraShadowCaster,this.tessellationStep=O.tessellationStep,this.scaleFactor=O.scaleFactor,this.worldview=O.worldview,this.indoor=O.indoor}parse(O,B,X,ae,se,de){this.status="parsing",this.data=O,this.collisionBoxArray=new s.b2;const Ee=new s.fl(Object.keys(O.layers).sort()),pe=new s.fm(this.tileID,this.promoteId);pe.bucketLayerIDs=[];const Te={},We=new s.fn(256,256),je={featureIndex:pe,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:We,availableImages:X,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0,activeFloors:void 0};if(this.indoor){const Mt=this.indoor.indoorState.activeFloorsVisible,ni=(function(si,Xi,Fr){const tn=(function($i,di){if(!$i)return s.w("No source layers defined in indoor specification"),di;if($i.size===0)return di;const dr=$i.difference(di);for(const Rr of dr)s.w("Missing source layer required in indoor specification: ".concat(Rr));return di.intersection(di)})(Xi.sourceLayers,new Set(Object.keys(si.layers))),Hr=Xi.indoorState,Ur=(function($i,di,dr,Rr){const Ki=new Set,fr=new Set,un=new Set,Xn=new Map,Ko={},pa=mn=>{const Jo=Xn.get(mn)||new Set;for(const io of Ki)if((Xn.get(io)||new Set).has(mn)||Jo.has(io))return!0;return!1};for(const mn of di){const Jo=$i.layers[mn];if(Jo)for(let io=0;io<Jo.length;io++){const fs=Jo.feature(io);if(wi(fs)){const{id:wo,center:To}=Dt(fs);Vi(Ko,wo,To),Ki.add(wo)}else if(Ci(fs)){const{id:wo,isDefault:To,connections:Pc,conflicts:Dl,buildings:zl,name:Ll,zIndex:fo}=Mi(fs);Tt(Ko,zl,wo,{name:Ll,zIndex:fo}),Xn.set(wo,Dl),(wo===Rr||Pc.has(Rr))&&Ki.add(wo),fr.add(wo),To&&un.add(wo)}}else s.w("indoor source layer not found: ".concat(mn))}if(dr)for(const mn of dr)fr.has(mn)&&(pa(mn)||Ki.add(mn));for(const mn of un)Ki.has(mn)||pa(mn)||Ki.add(mn);return{buildings:Ko,activeFloors:Ki}})(si,tn,Hr.lastActiveFloors,Hr.selectedFloorId);return Fr.send("setIndoorData",Ur),Ur})(O,this.indoor,se);je.activeFloors=Mt?ni.activeFloors:void 0}const bt=[],Vt=B.familiesBySource[this.source];for(const Mt in Vt){const ni=O.layers[Mt];if(!ni)continue;let si=!1,Xi=!1,Fr=!1;for(const $i of Vt[Mt])$i[0].type==="symbol"?si=!0:Xi=!0,$i[0].is3D()&&$i[0].type!=="model"&&(Fr=!0);if(this.extraShadowCaster&&!Fr||this.isSymbolTile===!0&&!si||this.isSymbolTile===!1&&!Xi)continue;ni.version===1&&s.w('Vector tile source "'.concat(this.source,'" layer "').concat(Mt,'" does not use vector tile spec v2 and therefore may have some rendering errors.'));const tn=Ee.encode(Mt),Hr=[];let Ur=!1;for(let $i=0,di=0;$i<ni.length;$i++){const dr=ni.feature($i),Rr=pe.getId(dr,Mt);if(this.localizableLayerIds&&this.localizableLayerIds.has(Mt)){const Ki=dr.properties?dr.properties.worldview:null;if(this.worldview&&typeof Ki=="string")if(Ki==="all")dr.properties.$localized=!0;else{if(!Ki.split(",").includes(this.worldview))continue;dr.properties.$localized=!0,dr.properties.worldview=this.worldview}}!Ur&&dr.properties&&dr.properties.hasOwnProperty(s.fo)&&(Ur=!0),Hr.push({feature:dr,id:Rr,index:di,sourceLayerIndex:tn}),di++}Ur&&!je.elevationFeatures&&O.layers.hasOwnProperty(s.fp)&&(je.elevationFeatures=s.fq.parseFrom(O.layers[s.fp],this.canonical));for(const $i of Vt[Mt]){const di=$i[0];if(this.extraShadowCaster&&(!di.is3D()||di.type==="model")||this.isSymbolTile!==void 0&&di.type==="symbol"!==this.isSymbolTile||di.minzoom&&this.zoom<Math.floor(di.minzoom)||di.maxzoom&&this.zoom>=di.maxzoom||di.visibility==="none")continue;vi($i,this.zoom,je.brightness,X,this.worldview);const dr=Te[di.id]=di.createBucket({index:pe.bucketLayerIDs.length,layers:$i,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:tn,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:ae,worldview:this.worldview});pe.bucketLayerIDs.push($i.map((Ki=>s.B(Ki.id,Ki.scope))));let Rr=dr.prepare?dr.prepare():null;Rr!=null?(Rr=Rr.then((()=>dr.populate(Hr,je,this.tileID.canonical,this.tileTransform))),bt.push(Rr)):dr.populate(Hr,je,this.tileID.canonical,this.tileTransform)}}const kt=()=>{let Mt,ni,si,Xi,Fr,tn;We.trim();const Hr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Ur=()=>{if(Mt)return this.status="done",de(Mt);if(this.extraShadowCaster)this.status="done",de(null,{buckets:Object.values(Te).filter((di=>!di.isEmpty())),featureIndex:pe,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:je.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(ni&&si&&Xi){const di=new ei(ni),dr=new Map;for(const[fr,un]of si.entries()){const{imagePosition:Xn}=s.ft(fr,un,s.fu);dr.set(fr,Xn)}const Rr={};for(const fr in Te){const un=Te[fr];un instanceof s.b3&&(vi(un.layers,this.zoom,je.brightness,X,this.worldview),Rr[fr]=s.fv(un,ni,di.positions,si,dr,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,Fr,this.worldview))}const Ki={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(se,si,Fr,(()=>{Ki.iconsPending=!1,$i(Rr,di,Ki)})),this.rasterizeIfNeeded(se,Xi,tn,(()=>{Ki.patternsPending=!1,$i(Rr,di,Ki)}))}},$i=(di,dr,Rr,Ki)=>{if(Rr.iconsPending||Rr.patternsPending)return;const fr=new s.fw(si,Xi,this.lut);for(const un in Te){const Xn=Te[un];if(un in di)s.fx(Xn,di[un],this.showCollisionBoxes,X,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,si,fr);else if(Xn.hasPattern&&(Xn instanceof s.b9||Xn instanceof s.ba||Xn instanceof s.e9)){vi(Xn.layers,this.zoom,je.brightness,X,this.worldview);const Ko=Object.fromEntries(fr.patternPositions);Xn.addFeatures(je,this.tileID.canonical,Ko,X,this.tileTransform,this.brightness)}}this.status="done",de(null,{buckets:Object.values(Te).filter((un=>!un.isEmpty())),featureIndex:pe,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:dr.image,lineAtlas:We,imageAtlas:fr,brightness:je.brightness})};if(!this.extraShadowCaster){const di=s.fr(je.glyphDependencies,(Ki=>Object.keys(Ki).map(Number)));Object.keys(di).length?se.send("getGlyphs",{uid:this.uid,stacks:di},((Ki,fr)=>{Mt||(Mt=Ki,ni=fr,Ur())}),void 0,!1,Hr):ni={};const dr=Array.from(je.iconDependencies.keys()).map((Ki=>s.I.parse(Ki)));dr.length?se.send("getImages",{images:dr,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((Ki,fr)=>{Mt||(Mt=Ki,si=new Map,Fr=this.updateImageMapAndGetImageTaskQueue(si,fr,je.iconDependencies),Ur())}),void 0,!1,Hr):(si=new Map,Fr=new Map);const Rr=Array.from(je.patternDependencies.keys()).map((Ki=>s.I.parse(Ki)));Rr.length?se.send("getImages",{images:Rr,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((Ki,fr)=>{Mt||(Mt=Ki,Xi=new Map,tn=this.updateImageMapAndGetImageTaskQueue(Xi,fr,je.patternDependencies),Ur())}),void 0,!1,Hr):(Xi=new Map,tn=new Map)}if(je.elevationFeatures&&je.elevationFeatures.length>0){const di=[];for(const Rr of Object.values(Te))if(Rr instanceof s.ba){const Ki=Rr.getUnevaluatedPortalGraph();Ki&&di.push(Ki)}const dr=s.fs.evaluate(di);for(const Rr of Object.values(Te))if(Rr instanceof s.ba){const Ki=O.layers[Ee.decode(Rr.sourceLayerIndex)];Rr.setEvaluatedPortalGraph(dr,Ki,this.tileID.canonical,je.availableImages,je.brightness)}}Ur()};bt.length>0?Promise.allSettled(bt).then(kt).catch(de):kt()}updateParameters(O){this.scaleFactor=O.scaleFactor,this.showCollisionBoxes=O.showCollisionBoxes,this.projection=O.projection,this.brightness=O.brightness,this.tileTransform=s.aY(O.tileID.canonical,O.projection),this.extraShadowCaster=O.extraShadowCaster,this.lut=O.lut,this.worldview=O.worldview,this.indoor=O.indoor}rasterizeIfNeeded(O,B,X,ae){Array.from(B.values()).some((se=>se.usvg))?this.rasterize(O,B,X,ae):ae()}updateImageMapAndGetImageTaskQueue(O,B,X){const ae=new Map;for(const se of B.keys()){const de=X.get(se)||[];for(const Ee of de){const pe=Ee.toString(),Te=B.get(Ee.id.toString());Te.usvg?ae.has(pe)||(ae.set(pe,Ee),O.set(pe,Object.assign({},Te))):O.set(pe,Te)}}return ae}rasterize(O,B,X,ae){this.rasterizeTask=O.send("rasterizeImages",{scope:this.scope,tasks:X},((se,de)=>{if(!se)for(const[Ee,pe]of de.entries()){const Te=Object.assign(B.get(Ee),{data:pe});B.set(Ee,Te)}ae()}))}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function vi(fe,O,B,X,ae){const se=new s.ac(O,{brightness:B,worldview:ae});for(const de of fe)de.recalculate(se,X)}class Ti extends s.E{constructor(O,B,X,ae,se,de,Ee){super(),this.actor=O,this.layerIndex=B,this.availableImages=X,this.availableModels=ae,this.loadVectorData=de||s.aL,this.loading={},this.loaded={},this.deduped=new s.aK(O.scheduler),this.isSpriteLoaded=se,this.scheduler=O.scheduler,this.brightness=Ee}loadTile(O,B){const X=O.uid,ae=O&&O.request,se=ae&&ae.collectResourceTiming,de=this.loading[X]=new tr(O);de.abort=this.loadVectorData(O,((Ee,pe)=>{const Te=!this.loading[X];if(delete this.loading[X],de.cancelRasterize(),Te||Ee||!pe)return de.status="done",Te||(this.loaded[X]=de),B(Ee);const We=pe.rawData,je={},bt=s.aM(pe.responseHeaders);bt&&bt.expires&&(je.expires=bt.expires),bt&&bt.cacheControl&&(je.cacheControl=bt.cacheControl),de.vectorTile=pe.vectorTile||new s.fy(new s.bs(We));const Vt=()=>{de.parse(de.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,((kt,Mt)=>{if(kt||!Mt)return B(kt);const ni={};if(se){const si=et(ae);si.length>0&&(ni.resourceTiming=JSON.parse(JSON.stringify(si)))}B(null,Object.assign({rawTileData:We.slice(0),responseHeaders:pe.responseHeaders},Mt,je,ni))}))};this.isSpriteLoaded?Vt():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(Vt,{type:"parseTile",isSymbolTile:O.isSymbolTile,zoom:O.tileZoom}):Vt()})),this.loaded=this.loaded||{},this.loaded[X]=de}))}reloadTile(O,B){const X=this.loaded,ae=O.uid;if(X&&X[ae]){const se=X[ae];se.updateParameters(O);const de=(Ee,pe)=>{const Te=se.reloadCallback;Te&&(delete se.reloadCallback,se.parse(se.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Te)),B(Ee,pe)};se.status==="parsing"?se.reloadCallback=de:se.status==="done"&&(se.vectorTile?se.parse(se.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,de):de())}else B(null,void 0)}abortTile(O,B){const X=O.uid,ae=this.loading[X];ae&&(ae.abort&&ae.abort(),delete this.loading[X]),B()}removeTile(O,B){const X=this.loaded,ae=O.uid;X&&X[ae]&&delete X[ae],B()}}class Si{loadTile(O,B){const{uid:X,encoding:ae,rawImageData:se,padding:de}=O,Ee=ImageBitmap&&se instanceof ImageBitmap?this.getImageData(se,de):se;B(null,new s.fz(X,Ee,ae,de<1))}reloadTile(O,B){B(null,null)}abortTile(O,B){B()}removeTile(O,B){B()}getImageData(O,B){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(O.width,O.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=O.width,this.offscreenCanvas.height=O.height,this.offscreenCanvasContext.drawImage(O,0,0,O.width,O.height);const X=this.offscreenCanvasContext.getImageData(-B,-B,O.width+2*B,O.height+2*B);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),X}}s.br.setPbf(s.bs);class hr{constructor(O){this._mrt=new s.br(O.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=O.uid,this.tileID=O.tileID,this.source=O.source}parse(O,B){const X=this._mrt;this.status="parsing",this._entireBuffer=O;try{X.parseHeader(O),this._isHeaderLoaded=!0;const ae=[];for(const se in X.layers){const de=X.getLayer(se),Ee=de.getDataRange(de.getBandList()),pe=X.createDecodingTask(Ee),Te=O.slice(Ee.firstByte,Ee.lastByte+1),We=s.br.performDecoding(Te,pe).then((je=>pe.complete(null,je))).catch((je=>pe.complete(je,null)));ae.push(We)}Promise.allSettled(ae).then((()=>B(null,X))).catch((se=>B(se)))}catch(ae){B(ae)}}}class Sr{constructor(O){this.actor=O,this.loading={},this.loaded={}}loadTile(O,B){const X=O.uid,ae=O.request,se=this.loading[X]=new hr(O),{cancel:de}=s.bt(ae,((Ee,pe,Te)=>{const We=!this.loading[X];if(delete this.loading[X],We||Ee||!pe)return se.status="done",We||(this.loaded[X]=se),B(Ee);se.parse(pe,((je,bt)=>{if(je||!bt)return B(je);B(null,bt,Te)})),this.loaded[X]=se}));se.abort=de}reloadTile(O,B){B(null,void 0)}abortTile(O,B){const X=O.uid,ae=this.loading[X];ae&&(ae.abort&&ae.abort(),delete this.loading[X]),B()}removeTile(O,B){const X=O.uid;this.loaded[X]&&delete this.loaded[X],B()}decodeRasterArray(O,B){s.br.performDecoding(O.buffer,O.task).then((X=>B(null,X))).catch((X=>B(X)))}}const br=s.fA.prototype.toGeoJSON;class Or{constructor(O){this._feature=O,this.extent=s.al,this.type=O.type,this.properties=O.tags,"id"in O&&!isNaN(O.id)&&(this.id=parseInt(O.id,10))}loadGeometry(){if(this._feature.type===1){const O=[];for(const B of this._feature.geometry)O.push([new s.P(B[0],B[1])]);return O}{const O=[];for(const B of this._feature.geometry){const X=[];for(const ae of B)X.push(new s.P(ae[0],ae[1]));O.push(X)}return O}}toGeoJSON(O,B,X){return br.call(this,O,B,X)}}class Jt{constructor(O,B){this.name=O,this.extent=s.al,this.length=B.length,this._jsonFeatures=B}feature(O){return new Or(this._jsonFeatures[O])}}class On{constructor(O){this.layers={},this.extent=s.al;for(const B of Object.keys(O))this.layers[B]=new Jt(B,O[B])}}const yn=64/4096,rr=128;class Li{constructor(){this.features=new Map}clear(){this.features.clear()}load(O=[],B){for(const X of O){const ae=X.id;if(ae==null)continue;let se=this.features.get(ae);se&&this.updateCache(se,B),X.geometry?(se=en(X),this.updateCache(se,B),this.features.set(ae,se)):this.features.delete(ae),this.updateCache(se,B)}}updateCache(O,B){for(const{canonical:X,uid:ae}of Object.values(B)){const{z:se,x:de,y:Ee}=X;Er(O,Math.pow(2,se),de,Ee)&&delete B[ae]}}getTile(O,B,X){const ae=Math.pow(2,O),se=[];for(const de of this.features.values())Er(de,ae,B,X)&&se.push(Wi(de,ae,B,X));return{features:se}}getFeatures(){return[...this.features.values()]}}function Er({minX:fe,minY:O,maxX:B,maxY:X},ae,se,de){return fe<(se+1+yn)/ae&&O<(de+1+yn)/ae&&B>(se-yn)/ae&&X>(de-yn)/ae}function en(fe){const{id:O,geometry:B,properties:X}=fe;if(!B)return;if(B.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:ae,coordinates:se}=B,de={id:O,type:1,geometry:[],tags:X,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Ee=de.geometry;if(ae==="Point")Zn(se,Ee,de);else if(ae==="MultiPoint")for(const pe of se)Zn(pe,Ee,de);else if(ae==="LineString")de.type=2,lo(se,Ee,de);else if(ae==="MultiLineString")de.type=2,xn(se,Ee,de);else if(ae==="Polygon")de.type=3,xn(se,Ee,de,!0);else{if(ae!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");de.type=3;for(const pe of se)xn(pe,Ee,de,!0)}return de}function Zn([fe,O],B,X){const ae=s.aF(fe);let se=s.aJ(O);se=se<0?0:se>1?1:se,B.push(ae,se),X.minX=Math.min(X.minX,ae),X.minY=Math.min(X.minY,se),X.maxX=Math.max(X.maxX,ae),X.maxY=Math.max(X.maxY,se)}function lo(fe,O,B,X=!1,ae=!1){const se=[];for(const de of fe)Zn(de,se,B);O.push(se),X&&(function(de,Ee){let pe=0;for(let Te=0,We=de.length,je=We-2;Te<We;je=Te,Te+=2)pe+=(de[Te]-de[je])*(de[Te+1]+de[je+1]);if(pe>0===Ee)for(let Te=0,We=de.length;Te<We/2;Te+=2){const je=de[Te],bt=de[Te+1];de[Te]=de[We-2-Te],de[Te+1]=de[We-1-Te],de[We-2-Te]=je,de[We-1-Te]=bt}})(se,ae)}function xn(fe,O,B,X=!1){for(let ae=0;ae<fe.length;ae++)lo(fe[ae],O,B,X,ae===0)}function Wi(fe,O,B,X){const{id:ae,type:se,geometry:de,tags:Ee}=fe,pe=[];if(se===1)(function(Te,We,je,bt,Vt){for(let kt=0;kt<Te.length;kt+=2){const Mt=Math.round(s.al*(Te[kt+0]*We-je)),ni=Math.round(s.al*(Te[kt+1]*We-bt));Vt.push([Mt,ni])}})(de,O,B,X,pe);else for(const Te of de)Fn(Te,O,B,X,pe);return{id:ae,type:se,geometry:pe,tags:Ee}}function Fn(fe,O,B,X,ae){const se=-rr,de=s.al+rr;let Ee;for(let pe=0;pe<fe.length-2;pe+=2){let Te=Math.round(s.al*(fe[pe+0]*O-B)),We=Math.round(s.al*(fe[pe+1]*O-X)),je=Math.round(s.al*(fe[pe+2]*O-B)),bt=Math.round(s.al*(fe[pe+3]*O-X));const Vt=je-Te,kt=bt-We;Te<se&&je<se||(Te<se?(We+=Math.round(kt*((se-Te)/Vt)),Te=se):je<se&&(bt=We+Math.round(kt*((se-Te)/Vt)),je=se),We<se&&bt<se||(We<se?(Te+=Math.round(Vt*((se-We)/kt)),We=se):bt<se&&(je=Te+Math.round(Vt*((se-We)/kt)),bt=se),Te>=de&&je>=de||(Te>=de?(We+=Math.round(kt*((de-Te)/Vt)),Te=de):je>=de&&(bt=We+Math.round(kt*((de-Te)/Vt)),je=de),We>=de&&bt>=de||(We>=de?(Te+=Math.round(Vt*((de-We)/kt)),We=de):bt>=de&&(je=Te+Math.round(Vt*((de-We)/kt)),bt=de),Ee&&Te===Ee[Ee.length-1][0]&&We===Ee[Ee.length-1][1]||(Ee=[[Te,We]],ae.push(Ee)),Ee.push([je,bt])))))}}function Wo({name:fe,features:O},B){B.writeStringField(1,fe),B.writeVarintField(5,s.al);const X=new Map,ae=new Map,se={keys:X,values:ae,feature:null};for(const de of O)se.feature=de,B.writeMessage(2,En,se);for(const de of X.keys())B.writeStringField(3,de);for(const de of ae.keys())B.writeMessage(4,Cr,de)}function En(fe,O){const B=fe.feature;B.id!==void 0&&Number.isSafeInteger(+B.id)&&O.writeVarintField(1,+B.id),B.tags&&O.writeMessage(2,us,fe),O.writeVarintField(3,B.type),O.writeMessage(4,Gi,B)}function us({keys:fe,values:O,feature:B},X){for(const ae of Object.keys(B.tags)){let se=B.tags[ae];if(se===null)continue;let de=fe.get(ae);de===void 0&&(de=fe.size,fe.set(ae,de)),X.writeVarint(de);const Ee=typeof se;Ee!=="string"&&Ee!=="boolean"&&Ee!=="number"&&(se=JSON.stringify(se));let pe=O.get(se);pe===void 0&&(pe=O.size,O.set(se,pe)),X.writeVarint(pe)}}function Qn(fe,O){return(O<<3)+(7&fe)}function Oi(fe){return fe<<1^fe>>31}function Gi(fe,O){const{geometry:B,type:X}=fe;let ae=0,se=0;if(X===1){O.writeVarint(Qn(1,B.length));for(const de of B){const Ee=de[0]-ae,pe=de[1]-se;O.writeVarint(Oi(Ee)),O.writeVarint(Oi(pe)),ae+=Ee,se+=pe}}else for(const de of B){O.writeVarint(Qn(1,1));const Ee=de.length-(X===3?1:0);for(let pe=0;pe<Ee;pe++){pe===1&&O.writeVarint(Qn(2,Ee-1));const Te=de[pe][0]-ae,We=de[pe][1]-se;O.writeVarint(Oi(Te)),O.writeVarint(Oi(We)),ae+=Te,se+=We}X===3&&O.writeVarint(Qn(7,1))}}function Cr(fe,O){const B=typeof fe;B==="string"?O.writeStringField(1,fe):B==="boolean"?O.writeBooleanField(7,fe):B==="number"&&(fe%1!=0?O.writeDoubleField(3,fe):fe<0?O.writeSVarintField(6,fe):O.writeVarintField(5,fe))}const fn={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:fe=>fe},nr=Math.fround||(kn=new Float32Array(1),fe=>(kn[0]=+fe,kn[0]));var kn;const In=3,An=5,co=6;class Pr{constructor(O){this.options=Object.assign(Object.create(fn),O),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(O){const{log:B,minZoom:X,maxZoom:ae}=this.options;B&&console.time("total time");const se="prepare ".concat(O.length," points");B&&console.time(se),this.points=O;const de=[];for(let pe=0;pe<O.length;pe++){const Te=O[pe];if(!Te.geometry)continue;const[We,je]=Te.geometry.coordinates,bt=nr(vn(We)),Vt=nr(uo(je));de.push(bt,Vt,1/0,pe,-1,1),this.options.reduce&&de.push(0)}let Ee=this.trees[ae+1]=this._createTree(de);B&&console.timeEnd(se);for(let pe=ae;pe>=X;pe--){const Te=+Date.now();Ee=this.trees[pe]=this._createTree(this._cluster(Ee,pe)),B&&console.log("z%d: %d clusters in %dms",pe,Ee.numItems,+Date.now()-Te)}return B&&console.timeEnd("total time"),this}getClusters(O,B){let X=((O[0]+180)%360+360)%360-180;const ae=Math.max(-90,Math.min(90,O[1]));let se=O[2]===180?180:((O[2]+180)%360+360)%360-180;const de=Math.max(-90,Math.min(90,O[3]));if(O[2]-O[0]>=360)X=-180,se=180;else if(X>se){const je=this.getClusters([X,ae,180,de],B),bt=this.getClusters([-180,ae,se,de],B);return je.concat(bt)}const Ee=this.trees[this._limitZoom(B)],pe=Ee.range(vn(X),uo(de),vn(se),uo(ae)),Te=Ee.data,We=[];for(const je of pe){const bt=this.stride*je;We.push(Te[bt+An]>1?hs(Te,bt,this.clusterProps):this.points[Te[bt+In]])}return We}getChildren(O){const B=this._getOriginId(O),X=this._getOriginZoom(O),ae="No cluster with the specified id.",se=this.trees[X];if(!se)throw new Error(ae);const de=se.data;if(B*this.stride>=de.length)throw new Error(ae);const Ee=this.options.radius/(this.options.extent*Math.pow(2,X-1)),pe=se.within(de[B*this.stride],de[B*this.stride+1],Ee),Te=[];for(const We of pe){const je=We*this.stride;de[je+4]===O&&Te.push(de[je+An]>1?hs(de,je,this.clusterProps):this.points[de[je+In]])}if(Te.length===0)throw new Error(ae);return Te}getLeaves(O,B,X){const ae=[];return this._appendLeaves(ae,O,B=B||10,X=X||0,0),ae}getTile(O,B,X){const ae=this.trees[this._limitZoom(O)],se=Math.pow(2,O),{extent:de,radius:Ee}=this.options,pe=Ee/de,Te=(X-pe)/se,We=(X+1+pe)/se,je={features:[]};return this._addTileFeatures(ae.range((B-pe)/se,Te,(B+1+pe)/se,We),ae.data,B,X,se,je),B===0&&this._addTileFeatures(ae.range(1-pe/se,Te,1,We),ae.data,se,X,se,je),B===se-1&&this._addTileFeatures(ae.range(0,Te,pe/se,We),ae.data,-1,X,se,je),je.features.length?je:null}getClusterExpansionZoom(O){let B=this._getOriginZoom(O)-1;for(;B<=this.options.maxZoom;){const X=this.getChildren(O);if(B++,X.length!==1)break;O=X[0].properties.cluster_id}return B}_appendLeaves(O,B,X,ae,se){const de=this.getChildren(B);for(const Ee of de){const pe=Ee.properties;if(pe&&pe.cluster?se+pe.point_count<=ae?se+=pe.point_count:se=this._appendLeaves(O,pe.cluster_id,X,ae,se):se<ae?se++:O.push(Ee),O.length===X)break}return se}_createTree(O){const B=new s.c3(O.length/this.stride|0,this.options.nodeSize,Float32Array);for(let X=0;X<O.length;X+=this.stride)B.add(O[X],O[X+1]);return B.finish(),B.data=O,B}_addTileFeatures(O,B,X,ae,se,de){for(const Ee of O){const pe=Ee*this.stride,Te=B[pe+An]>1;let We,je,bt;if(Te)We=Bn(B,pe,this.clusterProps),je=B[pe],bt=B[pe+1];else{const Mt=this.points[B[pe+In]];We=Mt.properties;const[ni,si]=Mt.geometry.coordinates;je=vn(ni),bt=uo(si)}const Vt={type:1,geometry:[[Math.round(this.options.extent*(je*se-X)),Math.round(this.options.extent*(bt*se-ae))]],tags:We};let kt;kt=Te||this.options.generateId?B[pe+In]:this.points[B[pe+In]].id,kt!==void 0&&(Vt.id=kt),de.features.push(Vt)}}_limitZoom(O){return Math.max(this.options.minZoom,Math.min(Math.floor(+O),this.options.maxZoom+1))}_cluster(O,B){const{radius:X,extent:ae,reduce:se,minPoints:de}=this.options,Ee=X/(ae*Math.pow(2,B)),pe=O.data,Te=[],We=this.stride;for(let je=0;je<pe.length;je+=We){if(pe[je+2]<=B)continue;pe[je+2]=B;const bt=pe[je],Vt=pe[je+1],kt=O.within(pe[je],pe[je+1],Ee),Mt=pe[je+An];let ni=Mt;for(const si of kt){const Xi=si*We;pe[Xi+2]>B&&(ni+=pe[Xi+An])}if(ni>Mt&&ni>=de){let si,Xi=bt*Mt,Fr=Vt*Mt,tn=-1;const Hr=(je/We<<5)+(B+1)+this.points.length;for(const Ur of kt){const $i=Ur*We;if(pe[$i+2]<=B)continue;pe[$i+2]=B;const di=pe[$i+An];Xi+=pe[$i]*di,Fr+=pe[$i+1]*di,pe[$i+4]=Hr,se&&(si||(si=this._map(pe,je,!0),tn=this.clusterProps.length,this.clusterProps.push(si)),se(si,this._map(pe,$i)))}pe[je+4]=Hr,Te.push(Xi/ni,Fr/ni,1/0,Hr,-1,ni),se&&Te.push(tn)}else{for(let si=0;si<We;si++)Te.push(pe[je+si]);if(ni>1)for(const si of kt){const Xi=si*We;if(!(pe[Xi+2]<=B)){pe[Xi+2]=B;for(let Fr=0;Fr<We;Fr++)Te.push(pe[Xi+Fr])}}}}return Te}_getOriginId(O){return O-this.points.length>>5}_getOriginZoom(O){return(O-this.points.length)%32}_map(O,B,X){if(O[B+An]>1){const de=this.clusterProps[O[B+co]];return X?Object.assign({},de):de}const ae=this.points[O[B+In]].properties,se=this.options.map(ae);return X&&se===ae?Object.assign({},se):se}}function hs(fe,O,B){return{type:"Feature",id:fe[O+In],properties:Bn(fe,O,B),geometry:{type:"Point",coordinates:[(X=fe[O],360*(X-.5)),vs(fe[O+1])]}};var X}function Bn(fe,O,B){const X=fe[O+An],ae=X>=1e4?"".concat(Math.round(X/1e3),"k"):X>=1e3?Math.round(X/100)/10+"k":X,se=fe[O+co],de=se===-1?{}:Object.assign({},B[se]);return Object.assign(de,{cluster:!0,cluster_id:fe[O+In],point_count:X,point_count_abbreviated:ae})}function vn(fe){return fe/360+.5}function uo(fe){const O=Math.sin(fe*Math.PI/180),B=.5-.25*Math.log((1+O)/(1-O))/Math.PI;return B<0?0:B>1?1:B}function vs(fe){const O=(180-360*fe)*Math.PI/180;return 360*Math.atan(Math.exp(O))/Math.PI-90}function pn(fe,O,B,X){let ae=X;const se=O+(B-O>>1);let de,Ee=B-O;const pe=fe[O],Te=fe[O+1],We=fe[B],je=fe[B+1];for(let bt=O+3;bt<B;bt+=3){const Vt=Po(fe[bt],fe[bt+1],pe,Te,We,je);if(Vt>ae)de=bt,ae=Vt;else if(Vt===ae){const kt=Math.abs(bt-se);kt<Ee&&(de=bt,Ee=kt)}}ae>X&&(de-O>3&&pn(fe,O,de,X),fe[de+2]=ae,B-de>3&&pn(fe,de,B,X))}function Po(fe,O,B,X,ae,se){let de=ae-B,Ee=se-X;if(de!==0||Ee!==0){const pe=((fe-B)*de+(O-X)*Ee)/(de*de+Ee*Ee);pe>1?(B=ae,X=se):pe>0&&(B+=de*pe,X+=Ee*pe)}return de=fe-B,Ee=O-X,de*de+Ee*Ee}function Rt(fe,O,B,X){const ae={id:fe!=null?fe:null,type:O,geometry:B,tags:X,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(O==="Point"||O==="MultiPoint"||O==="LineString")qt(ae,B);else if(O==="Polygon")qt(ae,B[0]);else if(O==="MultiLineString")for(const se of B)qt(ae,se);else if(O==="MultiPolygon")for(const se of B)qt(ae,se[0]);return ae}function qt(fe,O){for(let B=0;B<O.length;B+=3)fe.minX=Math.min(fe.minX,O[B]),fe.minY=Math.min(fe.minY,O[B+1]),fe.maxX=Math.max(fe.maxX,O[B]),fe.maxY=Math.max(fe.maxY,O[B+1])}function bi(fe,O,B,X){if(!O.geometry)return;const ae=O.geometry.coordinates;if(ae&&ae.length===0)return;const se=O.geometry.type,de=Math.pow(B.tolerance/((1<<B.maxZoom)*B.extent),2);let Ee=[],pe=O.id;if(B.promoteId?pe=O.properties[B.promoteId]:B.generateId&&(pe=X||0),se==="Point")ci(ae,Ee);else if(se==="MultiPoint")for(const Te of ae)ci(Te,Ee);else if(se==="LineString")xr(ae,Ee,de,!1);else if(se==="MultiLineString"){if(B.lineMetrics){for(const Te of ae)Ee=[],xr(Te,Ee,de,!1),fe.push(Rt(pe,"LineString",Ee,O.properties));return}ar(ae,Ee,de,!1)}else if(se==="Polygon")ar(ae,Ee,de,!0);else{if(se!=="MultiPolygon"){if(se==="GeometryCollection"){for(const Te of O.geometry.geometries)bi(fe,{id:pe,geometry:Te,properties:O.properties},B,X);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const Te of ae){const We=[];ar(Te,We,de,!0),Ee.push(We)}}fe.push(Rt(pe,se,Ee,O.properties))}function ci(fe,O){O.push(hi(fe[0]),Xo(fe[1]),0)}function xr(fe,O,B,X){let ae,se,de=0;for(let pe=0;pe<fe.length;pe++){const Te=hi(fe[pe][0]),We=Xo(fe[pe][1]);O.push(Te,We,0),pe>0&&(de+=X?(ae*We-Te*se)/2:Math.sqrt(Math.pow(Te-ae,2)+Math.pow(We-se,2))),ae=Te,se=We}const Ee=O.length-3;O[2]=1,pn(O,0,Ee,B),O[Ee+2]=1,O.size=Math.abs(de),O.start=0,O.end=O.size}function ar(fe,O,B,X){for(let ae=0;ae<fe.length;ae++){const se=[];xr(fe[ae],se,B,X),O.push(se)}}function hi(fe){return fe/360+.5}function Xo(fe){const O=Math.sin(fe*Math.PI/180),B=.5-.25*Math.log((1+O)/(1-O))/Math.PI;return B<0?0:B>1?1:B}function Nr(fe,O,B,X,ae,se,de,Ee){if(X/=O,se>=(B/=O)&&de<X)return fe;if(de<B||se>=X)return null;const pe=[];for(const Te of fe){const We=Te.geometry;let je=Te.type;const bt=ae===0?Te.minX:Te.minY,Vt=ae===0?Te.maxX:Te.maxY;if(bt>=B&&Vt<X){pe.push(Te);continue}if(Vt<B||bt>=X)continue;let kt=[];if(je==="Point"||je==="MultiPoint")yo(We,kt,B,X,ae);else if(je==="LineString")Yo(We,kt,B,X,ae,!1,Ee.lineMetrics);else if(je==="MultiLineString")Wn(We,kt,B,X,ae,!1);else if(je==="Polygon")Wn(We,kt,B,X,ae,!0);else if(je==="MultiPolygon")for(const Mt of We){const ni=[];Wn(Mt,ni,B,X,ae,!0),ni.length&&kt.push(ni)}if(kt.length){if(Ee.lineMetrics&&je==="LineString"){for(const Mt of kt)pe.push(Rt(Te.id,je,Mt,Te.tags));continue}je!=="LineString"&&je!=="MultiLineString"||(kt.length===1?(je="LineString",kt=kt[0]):je="MultiLineString"),je!=="Point"&&je!=="MultiPoint"||(je=kt.length===3?"Point":"MultiPoint"),pe.push(Rt(Te.id,je,kt,Te.tags))}}return pe.length?pe:null}function yo(fe,O,B,X,ae){for(let se=0;se<fe.length;se+=3){const de=fe[se+ae];de>=B&&de<=X&&Mn(O,fe[se],fe[se+1],fe[se+2])}}function Yo(fe,O,B,X,ae,se,de){let Ee=xo(fe);const pe=ae===0?cr:Xr;let Te,We,je=fe.start;for(let ni=0;ni<fe.length-3;ni+=3){const si=fe[ni],Xi=fe[ni+1],Fr=fe[ni+2],tn=fe[ni+3],Hr=fe[ni+4],Ur=ae===0?si:Xi,$i=ae===0?tn:Hr;let di=!1;de&&(Te=Math.sqrt(Math.pow(si-tn,2)+Math.pow(Xi-Hr,2))),Ur<B?$i>B&&(We=pe(Ee,si,Xi,tn,Hr,B),de&&(Ee.start=je+Te*We)):Ur>X?$i<X&&(We=pe(Ee,si,Xi,tn,Hr,X),de&&(Ee.start=je+Te*We)):Mn(Ee,si,Xi,Fr),$i<B&&Ur>=B&&(We=pe(Ee,si,Xi,tn,Hr,B),di=!0),$i>X&&Ur<=X&&(We=pe(Ee,si,Xi,tn,Hr,X),di=!0),!se&&di&&(de&&(Ee.end=je+Te*We),O.push(Ee),Ee=xo(fe)),de&&(je+=Te)}let bt=fe.length-3;const Vt=fe[bt],kt=fe[bt+1],Mt=ae===0?Vt:kt;Mt>=B&&Mt<=X&&Mn(Ee,Vt,kt,fe[bt+2]),bt=Ee.length-3,se&&bt>=3&&(Ee[bt]!==Ee[0]||Ee[bt+1]!==Ee[1])&&Mn(Ee,Ee[0],Ee[1],Ee[2]),Ee.length&&O.push(Ee)}function xo(fe){const O=[];return O.size=fe.size,O.start=fe.start,O.end=fe.end,O}function Wn(fe,O,B,X,ae,se){for(const de of fe)Yo(de,O,B,X,ae,se,!1)}function Mn(fe,O,B,X){fe.push(O,B,X)}function cr(fe,O,B,X,ae,se){const de=(se-O)/(X-O);return Mn(fe,se,B+(ae-B)*de,1),de}function Xr(fe,O,B,X,ae,se){const de=(se-B)/(ae-B);return Mn(fe,O+(X-O)*de,se,1),de}function ho(fe,O){const B=[];for(let X=0;X<fe.length;X++){const ae=fe[X],se=ae.type;let de;if(se==="Point"||se==="MultiPoint"||se==="LineString")de=Yr(ae.geometry,O);else if(se==="MultiLineString"||se==="Polygon"){de=[];for(const Ee of ae.geometry)de.push(Yr(Ee,O))}else if(se==="MultiPolygon"){de=[];for(const Ee of ae.geometry){const pe=[];for(const Te of Ee)pe.push(Yr(Te,O));de.push(pe)}}B.push(Rt(ae.id,se,de,ae.tags))}return B}function Yr(fe,O){const B=[];B.size=fe.size,fe.start!==void 0&&(B.start=fe.start,B.end=fe.end);for(let X=0;X<fe.length;X+=3)B.push(fe[X]+O,fe[X+1],fe[X+2]);return B}function Kr(fe,O){if(fe.transformed)return fe;const B=1<<fe.z,X=fe.x,ae=fe.y;for(const se of fe.features){const de=se.geometry,Ee=se.type;if(se.geometry=[],Ee===1)for(let pe=0;pe<de.length;pe+=2)se.geometry.push(Un(de[pe],de[pe+1],O,B,X,ae));else for(let pe=0;pe<de.length;pe++){const Te=[];for(let We=0;We<de[pe].length;We+=2)Te.push(Un(de[pe][We],de[pe][We+1],O,B,X,ae));se.geometry.push(Te)}}return fe.transformed=!0,fe}function Un(fe,O,B,X,ae,se){return[Math.round(B*(fe*X-ae)),Math.round(B*(O*X-se))]}function vo(fe,O,B,X,ae){const se=O===ae.maxZoom?0:ae.tolerance/((1<<O)*ae.extent),de={features:[],numPoints:0,numSimplified:0,numFeatures:fe.length,source:null,x:B,y:X,z:O,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Ee of fe)eo(de,Ee,se,ae);return de}function eo(fe,O,B,X){const ae=O.geometry,se=O.type,de=[];if(fe.minX=Math.min(fe.minX,O.minX),fe.minY=Math.min(fe.minY,O.minY),fe.maxX=Math.max(fe.maxX,O.maxX),fe.maxY=Math.max(fe.maxY,O.maxY),se==="Point"||se==="MultiPoint")for(let Ee=0;Ee<ae.length;Ee+=3)de.push(ae[Ee],ae[Ee+1]),fe.numPoints++,fe.numSimplified++;else if(se==="LineString")Cn(de,ae,fe,B,!1,!1);else if(se==="MultiLineString"||se==="Polygon")for(let Ee=0;Ee<ae.length;Ee++)Cn(de,ae[Ee],fe,B,se==="Polygon",Ee===0);else if(se==="MultiPolygon")for(let Ee=0;Ee<ae.length;Ee++){const pe=ae[Ee];for(let Te=0;Te<pe.length;Te++)Cn(de,pe[Te],fe,B,!0,Te===0)}if(de.length){let Ee=O.tags||null;if(se==="LineString"&&X.lineMetrics){Ee={};for(const Te in O.tags)Ee[Te]=O.tags[Te];Ee.mapbox_clip_start=ae.start/ae.size,Ee.mapbox_clip_end=ae.end/ae.size}const pe={geometry:de,type:se==="Polygon"||se==="MultiPolygon"?3:se==="LineString"||se==="MultiLineString"?2:1,tags:Ee};O.id!==null&&(pe.id=O.id),fe.features.push(pe)}}function Cn(fe,O,B,X,ae,se){const de=X*X;if(X>0&&O.size<(ae?de:X))return void(B.numPoints+=O.length/3);const Ee=[];for(let pe=0;pe<O.length;pe+=3)(X===0||O[pe+2]>de)&&(B.numSimplified++,Ee.push(O[pe],O[pe+1])),B.numPoints++;ae&&(function(pe,Te){let We=0;for(let je=0,bt=pe.length,Vt=bt-2;je<bt;Vt=je,je+=2)We+=(pe[je]-pe[Vt])*(pe[je+1]+pe[Vt+1]);if(We>0===Te)for(let je=0,bt=pe.length;je<bt/2;je+=2){const Vt=pe[je],kt=pe[je+1];pe[je]=pe[bt-2-je],pe[je+1]=pe[bt-1-je],pe[bt-2-je]=Vt,pe[bt-1-je]=kt}})(Ee,se),fe.push(Ee)}const Be={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class to{constructor(O,B){const X=(B=this.options=(function(se,de){for(const Ee in de)se[Ee]=de[Ee];return se})(Object.create(Be),B)).debug;if(X&&console.time("preprocess data"),B.maxZoom<0||B.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(B.promoteId&&B.generateId)throw new Error("promoteId and generateId cannot be used together.");let ae=(function(se,de){const Ee=[];if(se.type==="FeatureCollection")for(let pe=0;pe<se.features.length;pe++)bi(Ee,se.features[pe],de,pe);else bi(Ee,se.type==="Feature"?se:{geometry:se},de);return Ee})(O,B);this.tiles={},this.tileCoords=[],X&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",B.indexMaxZoom,B.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ae=(function(se,de){const Ee=de.buffer/de.extent;let pe=se;const Te=Nr(se,1,-1-Ee,Ee,0,-1,2,de),We=Nr(se,1,1-Ee,2+Ee,0,-1,2,de);return(Te||We)&&(pe=Nr(se,1,-Ee,1+Ee,0,-1,2,de)||[],Te&&(pe=ho(Te,1).concat(pe)),We&&(pe=pe.concat(ho(We,-1)))),pe})(ae,B),ae.length&&this.splitTile(ae,0,0,0),X&&(ae.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(O,B,X,ae,se,de,Ee){const pe=[O,B,X,ae],Te=this.options,We=Te.debug;for(;pe.length;){ae=pe.pop(),X=pe.pop(),B=pe.pop(),O=pe.pop();const je=1<<B,bt=cn(B,X,ae);let Vt=this.tiles[bt];if(!Vt&&(We>1&&console.time("creation"),Vt=this.tiles[bt]=vo(O,B,X,ae,Te),this.tileCoords.push({z:B,x:X,y:ae}),We)){We>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",B,X,ae,Vt.numFeatures,Vt.numPoints,Vt.numSimplified),console.timeEnd("creation"));const di="z".concat(B);this.stats[di]=(this.stats[di]||0)+1,this.total++}if(Vt.source=O,se==null){if(B===Te.indexMaxZoom||Vt.numPoints<=Te.indexMaxPoints)continue}else{if(B===Te.maxZoom||B===se)continue;if(se!=null){const di=se-B;if(X!==de>>di||ae!==Ee>>di)continue}}if(Vt.source=null,O.length===0)continue;We>1&&console.time("clipping");const kt=.5*Te.buffer/Te.extent,Mt=.5-kt,ni=.5+kt,si=1+kt;let Xi=null,Fr=null,tn=null,Hr=null,Ur=Nr(O,je,X-kt,X+ni,0,Vt.minX,Vt.maxX,Te),$i=Nr(O,je,X+Mt,X+si,0,Vt.minX,Vt.maxX,Te);O=null,Ur&&(Xi=Nr(Ur,je,ae-kt,ae+ni,1,Vt.minY,Vt.maxY,Te),Fr=Nr(Ur,je,ae+Mt,ae+si,1,Vt.minY,Vt.maxY,Te),Ur=null),$i&&(tn=Nr($i,je,ae-kt,ae+ni,1,Vt.minY,Vt.maxY,Te),Hr=Nr($i,je,ae+Mt,ae+si,1,Vt.minY,Vt.maxY,Te),$i=null),We>1&&console.timeEnd("clipping"),pe.push(Xi||[],B+1,2*X,2*ae),pe.push(Fr||[],B+1,2*X,2*ae+1),pe.push(tn||[],B+1,2*X+1,2*ae),pe.push(Hr||[],B+1,2*X+1,2*ae+1)}}getTile(O,B,X){O=+O,B=+B,X=+X;const ae=this.options,{extent:se,debug:de}=ae;if(O<0||O>24)return null;const Ee=1<<O,pe=cn(O,B=B+Ee&Ee-1,X);if(this.tiles[pe])return Kr(this.tiles[pe],se);de>1&&console.log("drilling down to z%d-%d-%d",O,B,X);let Te,We=O,je=B,bt=X;for(;!Te&&We>0;)We--,je>>=1,bt>>=1,Te=this.tiles[cn(We,je,bt)];return Te&&Te.source?(de>1&&(console.log("found parent tile z%d-%d-%d",We,je,bt),console.time("drilling down")),this.splitTile(Te.source,We,je,bt,O,B,X),de>1&&console.timeEnd("drilling down"),this.tiles[pe]?Kr(this.tiles[pe],se):null):null}}function cn(fe,O,B){return 32*((1<<fe)*B+O)+fe}function bo(fe,O){const B=fe.tileID.canonical;if(!this._geoJSONIndex)return void O(null,null);const X=this._geoJSONIndex.getTile(B.z,B.x,B.y);if(!X)return void O(null,null);const ae=Te=>Te.tags&&"3d_elevation_id"in Te.tags&&"source"in Te.tags&&Te.tags.source==="elevation",se=X.features.filter((Te=>ae(Te)));let de={_geojsonTileLayer:X.features};se.length>0&&(de={_geojsonTileLayer:X.features.filter((Te=>!ae(Te))),hd_road_elevation:se});const Ee=new On(de),pe=(function(Te){const We=new s.bs;for(const je of Object.keys(Te))We.writeMessage(3,Wo,{name:je,features:Te[je]});return We.finish()})(de).buffer;O(null,{vectorTile:Ee,rawData:pe})}class ii extends Ti{constructor(O,B,X,ae,se,de,Ee){super(O,B,X,ae,se,bo,Ee),de&&(this.loadGeoJSON=de),this._dynamicIndex=new Li}loadData(O,B){const X=O&&O.request,ae=X&&X.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(O,((se,de)=>{if(se||!de)return B(se);if(typeof de!="object")return B(new Error("Input data given to '".concat(O.source,"' is not a valid GeoJSON object.")));{try{if(O.filter){const pe=s.U(O.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(pe.result==="error")throw new Error(pe.value.map((Te=>"".concat(Te.key,": ").concat(Te.message))).join(", "));de.features=de.features.filter((Te=>pe.value.evaluate({zoom:0},Te)))}O.dynamic?(de.type==="Feature"&&(de={type:"FeatureCollection",features:[de]}),O.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(de.features,this.loaded),O.cluster&&(de.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=O.cluster?new Pr((function({superclusterOptions:pe,clusterProperties:Te}){if(!Te||!pe)return pe;const We={},je={},bt={accumulated:null,zoom:0},Vt={properties:null},kt=Object.keys(Te);for(const Mt of kt){const[ni,si]=Te[Mt],Xi=s.U(si),Fr=s.U(typeof ni=="string"?[ni,["accumulated"],["get",Mt]]:ni);We[Mt]=Xi.value,je[Mt]=Fr.value}return pe.map=Mt=>{Vt.properties=Mt;const ni={};for(const si of kt)ni[si]=We[si].evaluate(bt,Vt);return ni},pe.reduce=(Mt,ni)=>{Vt.properties=ni;for(const si of kt)bt.accumulated=Mt[si],Mt[si]=je[si].evaluate(bt,Vt)},pe})(O)).load(de.features):O.dynamic?this._dynamicIndex:(function(pe,Te){return new to(pe,Te)})(de,O.geojsonVtOptions)}catch(pe){return B(pe)}const Ee={};if(ae){const pe=et(X);pe&&(Ee.resourceTiming={},Ee.resourceTiming[O.source]=JSON.parse(JSON.stringify(pe)))}B(null,Ee)}}))}reloadTile(O,B){const X=this.loaded;return X&&X[O.uid]?O.partial?B(null,void 0):super.reloadTile(O,B):this.loadTile(O,B)}loadGeoJSON(O,B){if(O.request)s.m(O.request,B);else{if(typeof O.data!="string")return B(new Error("Input data given to '".concat(O.source,"' is not a valid GeoJSON object.")));setTimeout((()=>{try{return B(null,JSON.parse(O.data))}catch(X){return B(new Error("Input data given to '".concat(O.source,"' is not a valid GeoJSON object.")))}}),0)}}getClusterExpansionZoom(O,B){try{B(null,this._geoJSONIndex.getClusterExpansionZoom(O.clusterId))}catch(X){B(X)}}getClusterChildren(O,B){try{B(null,this._geoJSONIndex.getChildren(O.clusterId))}catch(X){B(X)}}getClusterLeaves(O,B){try{B(null,this._geoJSONIndex.getLeaves(O.clusterId,O.limit,O.offset))}catch(X){B(X)}}}class Jr{constructor(O,B,X){this.tileID=new s.aP(O.tileID.overscaledZ,O.tileID.wrap,O.tileID.canonical.z,O.tileID.canonical.x,O.tileID.canonical.y),this.tileZoom=O.tileZoom,this.uid=O.uid,this.zoom=O.zoom,this.canonical=O.tileID.canonical,this.pixelRatio=O.pixelRatio,this.tileSize=O.tileSize,this.source=O.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=O.projection,this.brightness=B,this.worldview=X}parse(O,B,X,ae){this.status="parsing";const se=new s.aP(X.tileID.overscaledZ,X.tileID.wrap,X.tileID.canonical.z,X.tileID.canonical.x,X.tileID.canonical.y),de=[],Ee=B.familiesBySource[X.source],pe=new s.fm(se,X.promoteId);pe.bucketLayerIDs=[],pe.is3DTile=!0,s.fB(O).then((Te=>{if(!Te)return ae(new Error("Could not parse tile"));const We=Te.json.extensionsUsed&&Te.json.extensionsUsed.includes("MAPBOX_mesh_features")||Te.json.asset.extras&&Te.json.asset.extras.MAPBOX_mesh_features,je=Te.json.extensionsUsed&&Te.json.extensionsUsed.includes("EXT_meshopt_compression"),bt=new s.ac(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const Vt in Ee)for(const kt of Ee[Vt]){const Mt=kt[0];pe.bucketLayerIDs.push(kt.map((Xi=>s.B(Xi.id,Xi.scope)))),Mt.recalculate(bt,[]);const ni=s.fC(Te,1/s.d6(X.tileID.canonical)),si=new s.fD(kt,ni,se,We,je,this.brightness,pe,this.worldview);We||(si.needsUpload=!0),de.push(si),si.evaluate(Mt)}this.status="done",ae(null,{buckets:de,featureIndex:pe,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})})).catch((Te=>ae(new Error(Te.message))))}}class Ps{constructor(O,B,X,ae,se,de,Ee,pe){this.actor=O,this.layerIndex=B,this.availableImages=X,this.availableModels=ae,this.brightness=Ee,this.loading={},this.loaded={},this.worldview=pe}loadTile(O,B){const X=O.uid,ae=this.loading[X]=new Jr(O,this.brightness,this.worldview);s.bt(O.request,((se,de)=>{const Ee=!this.loading[X];return delete this.loading[X],Ee||se?(ae.status="done",Ee||(this.loaded[X]=ae),B(se)):de&&de.byteLength!==0?void ae.parse(de,this.layerIndex,O,((pe,Te)=>{ae.status="done",this.loaded=this.loaded||{},this.loaded[X]=ae,pe||!Te?B(pe):B(null,Te)})):(ae.status="done",this.loaded[X]=ae,B())}))}reloadTile(O,B){const X=this.loaded,ae=O.uid;if(X&&X[ae]){const se=X[ae];se.projection=O.projection,se.brightness=O.brightness;const de=(Ee,pe)=>{se.reloadCallback&&(delete se.reloadCallback,this.loadTile(O,B)),B(Ee,pe)};se.status==="parsing"?se.reloadCallback=de:se.status==="done"&&this.loadTile(O,B)}}abortTile(O,B){const X=O.uid;this.loading[X]&&delete this.loading[X],B()}removeTile(O,B){const X=this.loaded,ae=O.uid;X&&X[ae]&&delete X[ae],B()}}class ds{constructor(O){this.self=O,this.actor=new s.fF(O,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new s.x,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=s.cl({name:"mercator"}),this.workerSourceTypes={vector:Ti,geojson:ii,"raster-dem":Si,"raster-array":Sr,"batched-model":Ps},this.workerSources={},this.self.registerWorkerSource=(B,X)=>{if(this.workerSourceTypes[B])throw new Error('Worker source with name "'.concat(B,'" already registered.'));this.workerSourceTypes[B]=X},this.self.registerRTLTextPlugin=B=>{if(s.fG.isParsed())throw new Error("RTL text plugin already registered.");s.fG.setState({pluginStatus:s.fH.parsed,pluginURL:s.fG.getPluginURL()}),s.fG.applyArabicShaping=B.applyArabicShaping,s.fG.processBidirectionalText=B.processBidirectionalText,s.fG.processStyledBidirectionalText=B.processStyledBidirectionalText;for(const X of this.rtlPluginParsingListeners)X(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(O,B,X){delete this.layerIndexes[O],delete this.availableImages[O],delete this.availableModels[O],delete this.workerSources[O],X()}checkIfReady(O,B,X){X()}setReferrer(O,B){this.referrer=B}spriteLoaded(O,B){this.isSpriteLoaded[O]||(this.isSpriteLoaded[O]={});const{scope:X,isLoaded:ae}=B;if(this.isSpriteLoaded[O][X]=ae,this.workerSources[O]&&this.workerSources[O][X])for(const se in this.workerSources[O][X]){const de=this.workerSources[O][X][se];for(const Ee in de){const pe=de[Ee];pe instanceof Ti&&(pe.isSpriteLoaded=ae,pe.fire(new s.z("isSpriteLoaded")))}}}setImages(O,B,X){this.availableImages[O]||(this.availableImages[O]={});const{scope:ae,images:se}=B;if(this.availableImages[O][ae]=se,this.workerSources[O]&&this.workerSources[O][ae]){for(const de in this.workerSources[O][ae]){const Ee=this.workerSources[O][ae][de];for(const pe in Ee)Ee[pe].availableImages=se}X()}else X()}setModels(O,{scope:B,models:X},ae){if(this.availableModels[O]||(this.availableModels[O]={}),this.availableModels[O][B]=X,this.workerSources[O]&&this.workerSources[O][B]){for(const se in this.workerSources[O][B]){const de=this.workerSources[O][B][se];for(const Ee in de)de[Ee].availableModels=X}ae()}else ae()}setProjection(O,B){this.projections[O]=s.cl(B)}setBrightness(O,B,X){this.brightness=B,X()}setWorldview(O,B,X){this.worldview=B,X()}setLayers(O,B,X){this.getLayerIndex(O,B.scope).replace(B.layers,B.options),X()}updateLayers(O,B,X){this.getLayerIndex(O,B.scope).update(B.layers,B.removedIds,B.options),X()}loadTile(O,B,X){B.projection=this.projections[O]||this.defaultProjection,this.getWorkerSource(O,B.type,B.source,B.scope).loadTile(B,X)}decodeRasterArray(O,B,X){this.getWorkerSource(O,B.type,B.source,B.scope).decodeRasterArray(B,X)}reloadTile(O,B,X){B.projection=this.projections[O]||this.defaultProjection,this.getWorkerSource(O,B.type,B.source,B.scope).reloadTile(B,X)}abortTile(O,B,X){this.getWorkerSource(O,B.type,B.source,B.scope).abortTile(B,X)}removeTile(O,B,X){this.getWorkerSource(O,B.type,B.source,B.scope).removeTile(B,X)}removeSource(O,B,X){if(!(this.workerSources[O]&&this.workerSources[O][B.scope]&&this.workerSources[O][B.scope][B.type]&&this.workerSources[O][B.scope][B.type][B.source]))return;const ae=this.workerSources[O][B.scope][B.type][B.source];delete this.workerSources[O][B.scope][B.type][B.source],ae.removeSource!==void 0?ae.removeSource(B,X):X()}loadWorkerSource(O,B,X){try{this.self.importScripts(B.url),X()}catch(ae){X(ae.toString())}}syncRTLPluginState(O,B,X){if(s.fG.isParsed())X(null,!0);else if(s.fG.isParsing())this.rtlPluginParsingListeners.push(X);else try{s.fG.setState(B);const ae=s.fG.getPluginURL();!s.fG.isLoaded()||s.fG.isParsed()||s.fG.isParsing()||ae==null||(s.fG.setState({pluginStatus:s.fH.parsing,pluginURL:s.fG.getPluginURL()}),this.self.importScripts(ae),s.fG.isParsed()?X(null,!0):this.rtlPluginParsingListeners.push(X))}catch(ae){X(ae.toString())}}setDracoUrl(O,B){this.dracoUrl=B}getAvailableImages(O,B){this.availableImages[O]||(this.availableImages[O]={});let X=this.availableImages[O][B];return X||(X=[]),X}getAvailableModels(O,B){this.availableModels[O]||(this.availableModels[O]={});let X=this.availableModels[O][B];return X||(X={}),X}getLayerIndex(O,B){this.layerIndexes[O]||(this.layerIndexes[O]={});let X=this.layerIndexes[O][B];return X||(X=this.layerIndexes[O][B]=new At,X.scope=B),X}getWorkerSource(O,B,X,ae){const se=this.workerSources;return se[O]||(se[O]={}),se[O][ae]||(se[O][ae]={}),se[O][ae][B]||(se[O][ae][B]={}),this.isSpriteLoaded[O]||(this.isSpriteLoaded[O]={}),se[O][ae][B][X]||(se[O][ae][B][X]=new this.workerSourceTypes[B]({send:(de,Ee,pe,Te,We,je)=>this.actor.send(de,Ee,pe,O,We,je),scheduler:this.actor.scheduler},this.getLayerIndex(O,ae),this.getAvailableImages(O,ae),this.getAvailableModels(O,ae),this.isSpriteLoaded[O][ae],void 0,this.brightness,this.worldview)),se[O][ae][B][X]}rasterizeImagesWorker(O,B,X){const ae=new Map;for(const[se,{image:de,imageVariant:Ee}]of B.tasks.entries()){const pe=this.imageRasterizer.rasterize(Ee,de,B.scope,O);ae.set(se,pe)}X(void 0,ae)}removeRasterizedImages(O,B,X){this.imageRasterizer.removeImagesFromCacheByIds(B.imageIds,B.scope,O),X()}enforceCacheSizeLimit(O,B){s.fI(B)}getWorkerPerformanceMetrics(O,B,X){X(void 0,void 0)}}return s.fE(self)&&(self.worker=new ds(self)),ds})),we(["./shared"],(function(s){var et="3.16.0";const nt={create:"create",load:"load",fullLoad:"fullLoad"},It={mark(l){performance.mark(l)},measure(l,t,n){performance.measure(l,t,n)}};function At(l){const t=l.name.split("?")[0];return s.a(t)&&t.includes("mapbox-gl.js")?"javascript":s.a(t)&&t.includes("mapbox-gl.css")?"css":s.b(t)?"fontRange":s.c(t)?"sprite":s.i(t)?"style":s.d(t)?"tilejson":"other"}var Xt,ei={},Vi=(function(){if(Xt)return ei;function l(c){return!t(c)}function t(c){return typeof window>"u"||typeof document>"u"?"not a browser":(function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var p,m,y=new Blob([""],{type:"text/javascript"}),x=URL.createObjectURL(y);try{m=new Worker(x),p=!0}catch(T){p=!1}return m&&m.terminate(),URL.revokeObjectURL(x),p})()?(function(){var p=document.createElement("canvas");p.width=p.height=1;var m=p.getContext("2d");if(!m)return!1;var y=m.getImageData(0,0,1,1);return y&&y.width===p.width})()?(n[d=c&&c.failIfMajorPerformanceCaveat]===void 0&&(n[d]=(function(p){var m,y=(function(x){var T=document.createElement("canvas"),S=Object.create(l.webGLContextAttributes);return S.failIfMajorPerformanceCaveat=x,T.getContext("webgl2",S)})(p);if(!y)return!1;try{m=y.createShader(y.VERTEX_SHADER)}catch(x){return!1}return!(!m||y.isContextLost())&&(y.shaderSource(m,"void main() {}"),y.compileShader(m),y.getShaderParameter(m,y.COMPILE_STATUS)===!0)})(d)),n[d]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var d}Xt=1,ei.supported=l,ei.notSupportedReason=t;var n={};return l.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},ei})();function Tt(l,t,n){const c=document.createElement(l);return t!=null&&(c.className=t),n&&n.appendChild(c),c}function Dt(l,t,n){const c=document.createElementNS("http://www.w3.org/2000/svg",l);for(const d of Object.keys(t))c.setAttributeNS(null,d,String(t[d]));return n&&n.appendChild(c),c}const Mi=typeof document<"u"?document.documentElement&&document.documentElement.style:null,Yt=Mi&&Mi.userSelect!==void 0?"userSelect":"WebkitUserSelect";let wi;function Ci(){Mi&&Yt&&(wi=Mi[Yt],Mi[Yt]="none")}function tr(){Mi&&Yt&&(Mi[Yt]=wi)}function vi(l){l.preventDefault(),l.stopPropagation(),window.removeEventListener("click",vi,!0)}function Ti(){window.addEventListener("click",vi,!0),window.setTimeout((()=>{window.removeEventListener("click",vi,!0)}),0)}function Si(l,t){const n=l.getBoundingClientRect();return br(l,n,t)}function hr(l,t){const n=l.getBoundingClientRect(),c=[];for(let d=0;d<t.length;d++)c.push(br(l,n,t[d]));return c}function Sr(l){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&l.button===2&&l.ctrlKey?0:l.button}function br(l,t,n){const c=l.offsetWidth===t.width?1:l.offsetWidth/t.width;return new s.P((n.clientX-t.left)*c,(n.clientY-t.top)*c)}const Or="01",Jt="NO_ACCESS_TOKEN";class On{constructor(t,n,c){this._transformRequestFn=t,this._customAccessToken=n,this._silenceAuthErrors=!!c,this._createSkuToken()}_createSkuToken(){const t=(function(){let n="";for(let c=0;c<10;c++)n+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Or,n].join(""),tokenExpiresAt:Date.now()+432e5}})();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,n){return this._transformRequestFn&&this._transformRequestFn(t,n)||{url:t}}normalizeStyleURL(t,n){if(!s.h(t))return t;const c=rr(t);return c.params.push("sdk=js-".concat(et)),c.path="/styles/v1".concat(c.path),this._makeAPIURL(c,this._customAccessToken||n)}normalizeGlyphsURL(t,n){if(!s.h(t))return t;const c=rr(t);return c.path="/fonts/v1".concat(c.path),this._makeAPIURL(c,this._customAccessToken||n)}normalizeModelURL(t,n){if(!s.h(t))return t;const c=rr(t);return c.path="/models/v1".concat(c.path),this._makeAPIURL(c,this._customAccessToken||n)}normalizeSourceURL(t,n,c,d){if(!s.h(t))return t;const p=rr(t);return p.path="/v4/".concat(p.authority,".json"),p.params.push("secure"),c&&p.params.push("language=".concat(c)),d&&p.params.push("worldview=".concat(d)),this._makeAPIURL(p,this._customAccessToken||n)}normalizeIconsetURL(t,n){const c=rr(t);return s.h(t)?(c.path="/styles/v1".concat(c.path,"/iconset.pbf"),this._makeAPIURL(c,this._customAccessToken||n)):Li(c)}normalizeSpriteURL(t,n,c,d){const p=rr(t);return s.h(t)?(p.path="/styles/v1".concat(p.path,"/sprite").concat(n).concat(c),this._makeAPIURL(p,this._customAccessToken||d)):(p.path+="".concat(n).concat(c),Li(p))}normalizeTileURL(t,n,c){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!s.h(t))return t;const d=rr(t);d.path=d.path.replace(/(\.(png|jpg)\d*)(?=$)/,"".concat(n||c&&d.authority!=="raster"&&c===512?"@2x":"").concat(s.k.supported?".webp":"$1")),d.authority==="raster"?d.path="/".concat(s.e.RASTER_URL_PREFIX).concat(d.path):d.authority==="rasterarrays"?d.path="/".concat(s.e.RASTERARRAYS_URL_PREFIX).concat(d.path):d.authority==="3dtiles"?d.path="/".concat(s.e.TILES3D_URL_PREFIX).concat(d.path):(d.path=d.path.replace(/^.+\/v4\//,"/"),d.path="/".concat(s.e.TILE_URL_VERSION).concat(d.path));const p=this._customAccessToken||(function(m){for(const y of m){const x=y.match(/^access_token=(.*)$/);if(x)return x[1]}return null})(d.params)||s.e.ACCESS_TOKEN;return s.e.REQUIRE_ACCESS_TOKEN&&p&&this._skuToken&&d.params.push("sku=".concat(this._skuToken)),this._makeAPIURL(d,p)}canonicalizeTileURL(t,n){const c=rr(t);if(!c.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!c.path.match(/\.[\w]+$/))return t;let d="mapbox://";c.path.match(/^\/raster\/v1\//)?d+="raster/".concat(c.path.replace("/".concat(s.e.RASTER_URL_PREFIX,"/"),"")):c.path.match(/^\/rasterarrays\/v1\//)?d+="rasterarrays/".concat(c.path.replace("/".concat(s.e.RASTERARRAYS_URL_PREFIX,"/"),"")):d+="tiles/".concat(c.path.replace("/".concat(s.e.TILE_URL_VERSION,"/"),""));let p=c.params;return n&&(p=p.filter((m=>!m.match(/^access_token=/)))),p.length&&(d+="?".concat(p.join("&"))),d}canonicalizeTileset(t,n){const c=!!n&&s.h(n),d=[];for(const p of t.tiles||[])s.j(p)?d.push(this.canonicalizeTileURL(p,c)):d.push(p);return d}_makeAPIURL(t,n){const c="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",d=rr(s.e.API_URL);if(t.protocol=d.protocol,t.authority=d.authority,t.protocol==="http"){const p=t.params.indexOf("secure");p>=0&&t.params.splice(p,1)}if(d.path!=="/"&&(t.path="".concat(d.path).concat(t.path)),!s.e.REQUIRE_ACCESS_TOKEN)return Li(t);if(n=n||s.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!n)throw new Error("An API access token is required to use Mapbox GL. ".concat(c));if(n[0]==="s")throw new Error("Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ".concat(c))}return t.params=t.params.filter((p=>p.indexOf("access_token")===-1)),t.params.push("access_token=".concat(n||"")),Li(t)}}const yn=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function rr(l){const t=l.match(yn);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function Li(l){const t=l.params.length?"?".concat(l.params.join("&")):"";return"".concat(l.protocol,"://").concat(l.authority).concat(l.path).concat(t)}const Er="mapbox.eventData";function en(l){if(!l)return null;const t=l.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(s.l(t[1]))}catch(n){return null}}class Zn{constructor(t){this.type=t,this.anonId=null,this.anonIdTimestamp=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const n=en(s.e.ACCESS_TOKEN);let c="";return c=n&&n.u?s.f(n.u):s.e.ACCESS_TOKEN||"",t?"".concat(Er,".").concat(t,":").concat(c):"".concat(Er,":").concat(c)}fetchEventData(){const t=s.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid"),d=this.getStorageKey("uuidTimestamp");if(t)try{const p=localStorage.getItem(n);p&&(this.eventData=JSON.parse(p));const m=localStorage.getItem(c);m&&(this.anonId=m);const y=localStorage.getItem(d);y&&(this.anonIdTimestamp=Number(y));const x=Date.now()-864e5;(!this.anonIdTimestamp||this.anonIdTimestamp<x)&&this.refreshUUID()}catch(p){s.w("Unable to read from LocalStorage")}}refreshUUID(){this.anonId=s.u(),this.anonIdTimestamp=Date.now()}saveEventData(){const t=s.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid"),d=this.getStorageKey("uuidTimestamp"),p=this.anonId,m=this.anonIdTimestamp;if(t&&p)try{localStorage.setItem(c,p),Object.keys(this.eventData).length>=1&&localStorage.setItem(n,JSON.stringify(this.eventData)),m&&localStorage.setItem(d,m.toString())}catch(y){s.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,n,c,d){if(!s.e.EVENTS_URL)return;const p=rr(s.e.EVENTS_URL);p.params.push("access_token=".concat(d||s.e.ACCESS_TOKEN||""));const m={event:this.type,created:new Date(t).toISOString()},y=n?Object.assign(m,n):m,x={url:Li(p),headers:{"Content-Type":"text/plain"},body:JSON.stringify([y])};this.pendingRequest=s.p(x,(T=>{this.pendingRequest=null,c(T),this.saveEventData(),this.processRequests(d)}))}queueRequest(t,n){this.queue.push(t),this.processRequests(n)}}const lo=new class extends Zn{constructor(l){super("appUserTurnstile"),this._customAccessToken=l}postTurnstileEvent(l,t){s.e.EVENTS_URL&&s.e.ACCESS_TOKEN&&Array.isArray(l)&&l.some((n=>s.h(n)||s.j(n)))&&this.queueRequest(Date.now(),t)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.anonIdTimestamp&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=en(s.e.ACCESS_TOKEN),n=t?t.u:s.e.ACCESS_TOKEN;let c=n!==this.eventData.tokenU;s.v(this.anonId)||(this.refreshUUID(),c=!0);const d=this.queue.shift();if(this.eventData.lastSuccess){const p=new Date(this.eventData.lastSuccess),m=new Date(d),y=(d-this.eventData.lastSuccess)/864e5;c=c||y>=1||y<-1||p.getDate()!==m.getDate()}else c=!0;c?this.postEvent(d,{sdkIdentifier:"mapbox-gl-js",sdkVersion:et,skuId:Or,"enabled.telemetry":!1,userId:this.anonId},(p=>{p||(this.eventData.lastSuccess=d,this.eventData.tokenU=n)}),l):this.processRequests()}},xn=lo.postTurnstileEvent.bind(lo),Wi=new class extends Zn{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(l,t,n,c){this.skuToken=t,this.errorCb=c,s.e.EVENTS_URL&&(n||s.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(Jt)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||(this.anonId&&this.anonIdTimestamp||this.fetchEventData(),s.v(this.anonId)||this.refreshUUID(),this.postEvent(n,{sdkIdentifier:"mapbox-gl-js",sdkVersion:et,skuId:Or,skuToken:this.skuToken,userId:this.anonId},(c=>{c?this.errorCb(c):t&&(this.success[t]=!0)}),l))}remove(){this.errorCb=null}},Fn=Wi.postMapLoadEvent.bind(Wi),Wo=new class extends Zn{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(l){let t=this.mapInstanceIdMap.get(l);return t||(t=s.u(),this.mapInstanceIdMap.set(l,t)),t}getEventId(l){const t=this.eventIdPerMapInstanceMap.get(l)||0;return this.eventIdPerMapInstanceMap.set(l,t+1),t}postStyleLoadEvent(l,t){const{map:n,style:c,importedStyles:d}=t;if(!s.e.EVENTS_URL||!l&&!s.e.ACCESS_TOKEN)return;const p=this.getMapInstanceId(n),m={mapInstanceId:p,eventId:this.getEventId(p),style:c};d.length&&(m.importedStyles=d),this.queueRequest({timestamp:Date.now(),payload:m},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:n}=this.queue.shift();this.postEvent(t,n,(()=>{}),l)}},En=Wo.postStyleLoadEvent.bind(Wo),us=new class extends Zn{constructor(l){super("metrics"),l&&(this.data=l)}postMetricsEvent(l){if(!s.e.EVENTS_URL||!l&&!s.e.ACCESS_TOKEN)return;this.anonId||this.fetchEventData(),s.v(this.anonId)||this.refreshUUID();const t=Object.assign({},this.data,{sessionId:this.anonId});this.queueRequest({timestamp:Date.now(),payload:t},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:n}=this.queue.shift();this.postEvent(t,n,(()=>{}),l)}}({attributes:[{name:"maps/js/layer-animations/style-with-appearances"}]}),Qn=us.postMetricsEvent.bind(us),Oi=new class extends Zn{constructor(){super("gljs.performance")}postPerformanceEvent(l,t){s.e.EVENTS_URL&&(l||s.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:n}=this.queue.shift(),c=(function(d){const p=performance.getEntriesByType("resource"),m=performance.getEntriesByType("mark"),y=(function(C){const R={};if(C){for(const z in C)if(z!=="other")for(const N of C[z]){const k="".concat(z,"ResolveRangeMin"),U="".concat(z,"ResolveRangeMax"),$="".concat(z,"RequestCount"),G="".concat(z,"RequestCachedCount");R[k]=Math.min(R[k]||1/0,N.startTime),R[U]=Math.max(R[U]||-1/0,N.responseEnd);const ee=Z=>{R[Z]===void 0&&(R[Z]=0),++R[Z]};N.transferSize!==void 0&&N.transferSize===0&&ee(G),ee($)}}return R})((function(C,R){const z={};if(C)for(const N of C){const k=R(N);z[k]===void 0&&(z[k]=[]),z[k].push(N)}return z})(p,At)),x=window.devicePixelRatio,T=navigator.connection||navigator.mozConnection||navigator.webkitConnection,S=T?T.effectiveType:void 0,M={counters:[],metadata:[],attributes:[]},E=(C,R,z)=>{z!=null&&C.push({name:R,value:z.toString()})};for(const C in y)E(M.counters,C,y[C]);if(d.interactionRange[0]!==1/0&&d.interactionRange[1]!==-1/0&&(E(M.counters,"interactionRangeMin",d.interactionRange[0]),E(M.counters,"interactionRangeMax",d.interactionRange[1])),m)for(const C of Object.values(nt)){const R=m.find((z=>z.name===C));R&&E(M.counters,C,R.startTime)}return E(M.counters,"visibilityHidden",d.visibilityHidden),E(M.attributes,"style",(function(C){if(C)for(const R of C){const z=R.name.split("?")[0];if(s.i(z)){const N=z.split("/").slice(-2);if(N.length===2)return"mapbox://styles/".concat(N[0],"/").concat(N[1])}}})(p)),E(M.attributes,"terrainEnabled",d.terrainEnabled?"true":"false"),E(M.attributes,"fogEnabled",d.fogEnabled?"true":"false"),E(M.attributes,"projection",d.projection),E(M.attributes,"zoom",d.zoom),E(M.metadata,"devicePixelRatio",x),E(M.metadata,"connectionEffectiveType",S),E(M.metadata,"navigatorUserAgent",navigator.userAgent),E(M.metadata,"screenWidth",window.screen.width),E(M.metadata,"screenHeight",window.screen.height),E(M.metadata,"windowWidth",window.innerWidth),E(M.metadata,"windowHeight",window.innerHeight),E(M.metadata,"mapWidth",d.width/x),E(M.metadata,"mapHeight",d.height/x),E(M.metadata,"webglRenderer",d.renderer),E(M.metadata,"webglVendor",d.vendor),E(M.metadata,"sdkVersion",et),E(M.metadata,"sdkIdentifier","mapbox-gl-js"),M})(n);for(const d of c.metadata);for(const d of c.counters);for(const d of c.attributes);this.postEvent(t,c,(()=>{}),l)}},Gi=Oi.postPerformanceEvent.bind(Oi),Cr=new class extends Zn{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(l,t,n,c){if(!s.e.API_URL||!s.e.SESSION_PATH)return;const d=rr(s.e.API_URL+s.e.SESSION_PATH);d.params.push("sku=".concat(t||"")),d.params.push("access_token=".concat(c||s.e.ACCESS_TOKEN||""));const p={url:Li(d),headers:{"Content-Type":"text/plain"}};this.pendingRequest=s.g(p,(m=>{this.pendingRequest=null,n(m),this.saveEventData(),this.processRequests(c)}))}getSessionAPI(l,t,n,c){this.skuToken=t,this.errorCb=c,s.e.SESSION_PATH&&s.e.API_URL&&(n||s.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(Jt)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||this.getSession(n,this.skuToken,(c=>{c?this.errorCb(c):t&&(this.success[t]=!0)}),l)}remove(){this.errorCb=null}},fn=Cr.getSessionAPI.bind(Cr),nr=new Set;function kn(l,t){t?nr.add(l):nr.delete(l)}class In{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,n){this._updatedSourceCaches[t]=n,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const n=t.scope;this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._updatedLayers[n].add(t.id),this.setDirty()}removeLayer(t){const n=t.scope;this._removedLayers[n]=this._removedLayers[n]||{},this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._removedLayers[n][t.id]=t,this._updatedLayers[n].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const n in this._updatedLayers)t[n]=t[n]||{},t[n].updatedIds=Array.from(this._updatedLayers[n].values());for(const n in this._removedLayers)t[n]=t[n]||{},t[n].removedIds=Object.keys(this._removedLayers[n]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,n){this._updatedImages[n]=this._updatedImages[n]||new Set,this._updatedImages[n].add(s.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function An(l){const{userImage:t}=l;return!!(t&&t.render&&t.render())&&(l.data.replace(new Uint8Array(t.data.buffer)),!0)}class co extends s.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&s.r()&&(this.imageRasterizerDispatcher=new s.D(s.t(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new s.q({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);const n=this.atlasTexture.get(t);n&&(n.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,n){this.imageProviders.has(n)||this.imageProviders.set(n,new Map),this.imageProviders.get(n).set(t.id,t)}removeImageProvider(t,n){this.imageProviders.has(n)&&this.imageProviders.get(n).delete(t)}getPendingImageProviders(){const t=[];for(const n of this.imageProviders.values())for(const c of n.values())c.hasPendingRequests()&&t.push(c);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new s.x),this._imageRasterizer}isLoaded(){for(const t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,n){if(this.loaded.get(n)!==t&&(this.loaded.set(n,t),t)){for(const{ids:c,callback:d}of this.requestors)this._notify(c,n,d);this.requestors=[]}}hasImage(t,n){return!!this.getImage(t,n)}getImage(t,n){return this.images.get(n).get(t.toString())}addImage(t,n,c){this._validate(t,c)&&this.images.get(n).set(t.toString(),c)}_validate(t,n){let c=!0;return this._validateStretch(n.stretchX,n.data&&n.data.width)||(this.fire(new s.y(new Error('Image "'.concat(t.name,'" has invalid "stretchX" value')))),c=!1),this._validateStretch(n.stretchY,n.data&&n.data.height)||(this.fire(new s.y(new Error('Image "'.concat(t.name,'" has invalid "stretchY" value')))),c=!1),this._validateContent(n.content,n)||(this.fire(new s.y(new Error('Image "'.concat(t.name,'" has invalid "content" value')))),c=!1),c}_validateStretch(t,n){if(!t)return!0;let c=0;for(const d of t){if(d[0]<c||d[1]<d[0]||n<d[1])return!1;c=d[1]}return!0}_validateContent(t,n){return t?t.length!==4||!n.usvg&&(t[0]<0||n.data.width<t[0]||t[1]<0||n.data.height<t[1]||t[2]<0||n.data.width<t[2]||t[3]<0||n.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,n,c){const d=this.images.get(n).get(t.toString());c.version=d.version+1,this.images.get(n).set(t.toString(),c),this.updatedImages.get(n).add(t),this.removeFromImageRasterizerCache(t,n)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,n){this.spriteFormat!=="raster"&&(s.r()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:n}):this.imageRasterizer.removeImagesFromCacheByIds([t],n))}removeImage(t,n){const c=this.images.get(n),d=c.get(t.toString());c.delete(t.toString()),this.patterns.get(n).delete(t.toString()),this.removeFromImageRasterizerCache(t,n),d.userImage&&d.userImage.onRemove&&d.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map((n=>s.I.from(n)))}getImages(t,n,c){const d=[],p=[],m=this.imageProviders.get(n);for(const S of t){if(!S.iconsetId){d.push(S);continue}const M=m.get(S.iconsetId);M&&(this.getImage(S,n)?p.push(S):M.addPendingRequest(S))}if(d.length===0)return void this._notify(p,n,c);let y=!0;const x=!!this.loaded.get(n),T=this.images.get(n);if(!x)for(const S of d)T.has(S.toString())||(y=!1);x||y?this._notify(d,n,c):this.requestors.push({ids:d,scope:n,callback:c})}rasterizeImages(t,n){const c=new Map,{tasks:d,scope:p}=t;for(const[m,y]of d.entries()){const x=this.getImage(y.id,p);x&&c.set(m,{image:x,imageVariant:y})}this._rasterizeImages(p,c,n)}_rasterizeImages(t,n,c){if(s.r())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:n,scope:t},c);else{const d=new Map;for(const[p,{image:m,imageVariant:y}]of n.entries())d.set(p,this.imageRasterizer.rasterize(y,m,t,0));c(void 0,d)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,n,c){const d=this.images.get(n),p=new Map;for(const m of t){if(!d.get(m.toString())){if(m.iconsetId)continue;this.fire(new s.z("styleimagemissing",{id:m.name}))}const y=d.get(m.toString());if(!y){s.w('Image "'.concat(m.name,'" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.'));continue}const x={data:y.usvg?null:y.data.clone(),pixelRatio:y.pixelRatio,sdf:y.sdf,usvg:y.usvg,version:y.version,stretchX:y.stretchX,stretchY:y.stretchY,content:y.content,hasRenderCallback:!!(y.userImage&&y.userImage.render)};y.usvg&&Object.assign(x,{width:y.icon.usvg_tree.width,height:y.icon.usvg_tree.height}),p.set(s.I.toString(m),x)}c(null,p)}getPixelSize(t){const{width:n,height:c}=this.atlasImage.get(t);return{width:n,height:c}}getPattern(t,n,c){const d=t.toString(),p=this.patterns.get(n),m=p.get(d),y=this.getImage(t,n);if(!y)return null;if(m){if(m.position.version===y.version)return m.position;m.position.version=y.version}else{if(y.usvg&&!y.data){const x=this.getPatternInFlightId(d,n);if(this.patternsInFlight.has(x))return null;this.patternsInFlight.add(x);const T=new s.A(t).scaleSelf(s.o.devicePixelRatio),S=new Map([[T.toString(),{image:y,imageVariant:T}]]);return this._rasterizeImages(n,S,((M,E)=>this.storePatternImage(T,n,y,c,E))),null}this.storePattern(t,n,y)}return this._updatePatternAtlas(n,c),p.get(d).position}getPatternInFlightId(t,n){return s.B(t,n)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,n,c,d,p){const m=t.toString(),y=p?p.get(m):void 0;y&&(c.data=y,this.storePattern(t.id,n,c),this._updatePatternAtlas(n,d),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),n)))}storePattern(t,n,c){const d={w:c.data.width+2*s.C,h:c.data.height+2*s.C,x:0,y:0},p=new s.F(d,c,s.C);this.patterns.get(n).set(t.toString(),{bin:d,position:p})}destroyAtlasTextures(){for(const t of this.atlasTexture.values())t&&t.destroy();this.atlasTexture.clear()}bind(t,n){const c=t.gl;let d=this.atlasTexture.get(n);d?this.dirty&&(d.update(this.atlasImage.get(n)),this.dirty=!1):(d=new s.T(t,this.atlasImage.get(n),c.RGBA8),this.atlasTexture.set(n,d)),d.bind(c.LINEAR,c.CLAMP_TO_EDGE)}_updatePatternAtlas(t,n){const c=this.patterns.get(t),d=Array.from(c.values()).map((({bin:T})=>T)),{w:p,h:m}=s.G(d),y=this.atlasImage.get(t);y.resize({width:p||1,height:m||1});const x=this.images.get(t);for(const[T,{bin:S,position:M}]of c.entries()){let E=M.padding;const C=S.x+E,R=S.y+E,z=x.get(T).data,N=z.width,k=z.height;E=E>1?E-1:E,s.q.copy(z,y,{x:0,y:0},{x:C,y:R},{width:N,height:k},n),s.q.copy(z,y,{x:0,y:k-E},{x:C,y:R-E},{width:N,height:E},n),s.q.copy(z,y,{x:0,y:0},{x:C,y:R+k},{width:N,height:E},n),s.q.copy(z,y,{x:N-E,y:0},{x:C-E,y:R},{width:E,height:k},n),s.q.copy(z,y,{x:0,y:0},{x:C+N,y:R},{width:E,height:k},n),s.q.copy(z,y,{x:N-E,y:k-E},{x:C-E,y:R-E},{width:E,height:E},n),s.q.copy(z,y,{x:0,y:k-E},{x:C+N,y:R-E},{width:E,height:E},n),s.q.copy(z,y,{x:0,y:0},{x:C+N,y:R+k},{width:E,height:E},n),s.q.copy(z,y,{x:N-E,y:0},{x:C-E,y:R+k},{width:E,height:E},n)}this.dirty=!0}beginFrame(){for(const t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,n){const c=this.images.get(n);for(const d of t){if(this.callbackDispatchedThisFrame.get(n).has(d.toString()))continue;this.callbackDispatchedThisFrame.get(n).add(d.toString());const p=c.get(d.toString());An(p)&&this.updateImage(d,n,p)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function Pr(l){const t=l.value,n=l.valueSpec,c=l.style,d=l.styleSpec,p=l.key,m=l.arrayElementValidator||cr;if(!Array.isArray(t))return[new s.V(p,t,"array expected, ".concat(s.K(t)," found"))];if(n.length&&t.length!==n.length)return[new s.V(p,t,"array length ".concat(n.length," expected, length ").concat(t.length," found"))];if(n["min-length"]&&t.length<n["min-length"])return[new s.V(p,t,"array length at least ".concat(n["min-length"]," expected, length ").concat(t.length," found"))];let y={type:n.value,values:n.values,minimum:n.minimum,maximum:n.maximum,function:void 0};d.$version<7&&(y.function=n.function),s.H(n.value)&&(y=n.value);let x=[];for(let T=0;T<t.length;T++)x=x.concat(m({array:t,arrayIndex:T,value:t[T],valueSpec:y,style:c,styleSpec:d,key:"".concat(p,"[").concat(T,"]")},!0));return x}function hs(l){const t=l.key,n=l.value,c=l.valueSpec;if(!s.L(n))return[new s.V(t,n,"number expected, ".concat(s.K(n)," found"))];if(n!=n)return[new s.V(t,n,"number expected, NaN found")];if("minimum"in c){let d=c.minimum;if(Array.isArray(c.minimum)&&(d=c.minimum[l.arrayIndex]),n<d)return[new s.V(t,n,"".concat(n," is less than the minimum value ").concat(d))]}if("maximum"in c){let d=c.maximum;if(Array.isArray(c.maximum)&&(d=c.maximum[l.arrayIndex]),n>d)return[new s.V(t,n,"".concat(n," is greater than the maximum value ").concat(d))]}return[]}function Bn(l){const t=l.key,n=l.value;if(!s.H(n))return[new s.V(t,n,"object expected, ".concat(s.K(n)," found"))];const c=l.valueSpec,d=s.J(n.type);let p,m,y,x={};const T=d!=="categorical"&&n.property===void 0,S=!T,M=(function(z){const N=z.stops;return Array.isArray(N)&&Array.isArray(N[0])&&s.H(N[0][0])})(n),E=Xr({key:l.key,value:l.value,valueSpec:l.styleSpec.function,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{stops:function(z){if(d==="identity")return[new s.V(z.key,z.value,'identity function may not have a "stops" property')];let N=[];const k=z.value;return N=N.concat(Pr({key:z.key,value:k,valueSpec:z.valueSpec,style:z.style,styleSpec:z.styleSpec,arrayElementValidator:C})),Array.isArray(k)&&k.length===0&&N.push(new s.V(z.key,k,"array must have at least one stop")),N},default:function(z){return cr({key:z.key,value:z.value,valueSpec:c,style:z.style,styleSpec:z.styleSpec})}}});return d==="identity"&&T&&E.push(new s.V(l.key,l.value,'missing required property "property"')),d==="identity"||n.stops||E.push(new s.V(l.key,l.value,'missing required property "stops"')),d==="exponential"&&c.expression&&!s.M(c)&&E.push(new s.V(l.key,l.value,"exponential functions not supported")),l.styleSpec.$version>=8&&(S&&!s.N(c)?E.push(new s.V(l.key,l.value,"property functions not supported")):T&&!s.O(c)&&E.push(new s.V(l.key,l.value,"zoom functions not supported"))),d!=="categorical"&&!M||n.property!==void 0||E.push(new s.V(l.key,l.value,'"property" property is required')),E;function C(z){let N=[];const k=z.value,U=z.key;if(!Array.isArray(k))return[new s.V(U,k,"array expected, ".concat(s.K(k)," found"))];if(k.length!==2)return[new s.V(U,k,"array length 2 expected, length ".concat(k.length," found"))];if(M){if(!s.H(k[0]))return[new s.V(U,k,"object expected, ".concat(s.K(k[0])," found"))];const $=k[0];if($.zoom===void 0)return[new s.V(U,k,"object stop key must have zoom")];if($.value===void 0)return[new s.V(U,k,"object stop key must have value")];const G=s.J($.zoom);if(typeof G!="number")return[new s.V(U,$.zoom,"stop zoom values must be numbers")];if(y&&y>G)return[new s.V(U,$.zoom,"stop zoom values must appear in ascending order")];G!==y&&(y=G,m=void 0,x={}),N=N.concat(Xr({key:"".concat(U,"[0]"),value:k[0],valueSpec:{zoom:{}},style:z.style,styleSpec:z.styleSpec,objectElementValidators:{zoom:hs,value:R}}))}else N=N.concat(R({key:"".concat(U,"[0]"),value:k[0],style:z.style,styleSpec:z.styleSpec},k));return s.Q(s.S(k[1]))?N.concat([new s.V("".concat(U,"[1]"),k[1],"expressions are not allowed in function stops.")]):N.concat(cr({key:"".concat(U,"[1]"),value:k[1],valueSpec:c,style:z.style,styleSpec:z.styleSpec}))}function R(z,N){const k=s.K(z.value),U=s.J(z.value),$=z.value!==null?z.value:N;if(p){if(k!==p)return[new s.V(z.key,$,"".concat(k," stop domain type must match previous stop domain type ").concat(p))]}else p=k;if(k!=="number"&&k!=="string"&&k!=="boolean"&&typeof U!="number"&&typeof U!="string"&&typeof U!="boolean")return[new s.V(z.key,$,"stop domain value must be a number, string, or boolean")];if(k!=="number"&&d!=="categorical"){let G="number expected, ".concat(k," found");return s.N(c)&&d===void 0&&(G+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new s.V(z.key,$,G)]}return d!=="categorical"||k!=="number"||typeof U=="number"&&isFinite(U)&&Math.floor(U)===U?d!=="categorical"&&k==="number"&&typeof U=="number"&&typeof m=="number"&&m!==void 0&&U<m?[new s.V(z.key,$,"stop domain values must appear in ascending order")]:(m=U,d==="categorical"&&U in x?[new s.V(z.key,$,"stop domain values must be unique")]:(x[U]=!0,[])):[new s.V(z.key,$,"integer expected, found ".concat(String(U)))]}}function vn(l){const t=(l.expressionContext==="property"?s.W:s.U)(s.S(l.value),l.valueSpec);if(t.result==="error")return t.value.map((c=>new s.V("".concat(l.key).concat(c.key),l.value,c.message)));const n=t.value.expression||t.value._styleExpression.expression;if(l.expressionContext==="property"&&l.propertyKey==="text-font"&&!n.outputDefined())return[new s.V(l.key,l.value,'Invalid data expression for "'.concat(l.propertyKey,'". Output values must be contained as literals within the expression.'))];if(l.expressionContext==="property"&&l.propertyType==="layout"&&!s.Z(n))return[new s.V(l.key,l.value,'"feature-state" data expressions are not supported with layout properties.')];if(l.expressionContext==="filter")return uo(n,l);if(l.expressionContext==="appearance")return vs(n,l);if(l.expressionContext&&l.expressionContext.indexOf("cluster")===0){if(!s.X(n,["zoom","feature-state"]))return[new s.V(l.key,l.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(l.expressionContext==="cluster-initial"&&!s.Y(n))return[new s.V(l.key,l.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function uo(l,t){const n=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const d of t.valueSpec.expression.parameters)n.delete(d);if(n.size===0)return[];const c=[];return l instanceof s._&&n.has(l.name)?[new s.V(t.key,t.value,'["'.concat(l.name,'"] expression is not supported in a filter for a ').concat(t.object.type," layer with id: ").concat(t.object.id))]:(l.eachChild((d=>{c.push(...uo(d,t))})),c)}function vs(l,t){const n=new Set;if(t.valueSpec&&t.valueSpec.expression)for(const d of t.valueSpec.expression.parameters)n.add(d);if(n.size===0)return[];const c=[];return l instanceof s._&&!n.has(l.name)?[new s.V(t.key,t.value,'["'.concat(l.name,'"] is not an allowed parameter'))]:(l.eachChild((d=>{c.push(...vs(d,t))})),c)}function pn(l){const t=l.key,n=l.value,c=l.valueSpec,d=[];return Array.isArray(c.values)?c.values.indexOf(s.J(n))===-1&&d.push(new s.V(t,n,"expected one of [".concat(c.values.join(", "),"], ").concat(JSON.stringify(n)," found"))):Object.keys(c.values).indexOf(s.J(n))===-1&&d.push(new s.V(t,n,"expected one of [".concat(Object.keys(c.values).join(", "),"], ").concat(JSON.stringify(n)," found"))),d}function Po(l){return s.a2(s.S(l.value))?vn(Object.assign({},l,{expressionContext:"filter",valueSpec:l.styleSpec["filter_".concat(l.layerType||"fill")]})):Rt(l)}function Rt(l){const t=l.value,n=l.key;if(!Array.isArray(t))return[new s.V(n,t,"array expected, ".concat(s.K(t)," found"))];if(t.length<1)return[new s.V(n,t,"filter array must have at least 1 element")];const c=l.styleSpec;let d=pn({key:"".concat(n,"[0]"),value:t[0],valueSpec:c.filter_operator});switch(s.J(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&s.J(t[1])==="$type"&&d.push(new s.V(n,t,'"$type" cannot be use with operator "'.concat(t[0],'"')));case"==":case"!=":t.length!==3&&d.push(new s.V(n,t,'filter array for operator "'.concat(t[0],'" must have 3 elements')));case"in":case"!in":t.length>=2&&(s.a0(t[1])||d.push(new s.V("".concat(n,"[1]"),t[1],"string expected, ".concat(s.K(t[1])," found"))));for(let p=2;p<t.length;p++)s.J(t[1])==="$type"?d=d.concat(pn({key:"".concat(n,"[").concat(p,"]"),value:t[p],valueSpec:c.geometry_type})):s.a0(t[p])||s.L(t[p])||s.$(t[p])||d.push(new s.V("".concat(n,"[").concat(p,"]"),t[p],"string, number, or boolean expected, ".concat(s.K(t[p])," found.")));break;case"any":case"all":case"none":for(let p=1;p<t.length;p++)d=d.concat(Rt({key:"".concat(n,"[").concat(p,"]"),value:t[p],style:l.style,styleSpec:l.styleSpec}));break;case"has":case"!has":t.length!==2?d.push(new s.V(n,t,'filter array for "'.concat(t[0],'" operator must have 2 elements'))):s.a0(t[1])||d.push(new s.V("".concat(n,"[1]"),t[1],"string expected, ".concat(s.K(t[1])," found")))}return d}function qt(l,t){const n=l.key,c=l.style,d=l.layer,p=l.styleSpec,m=l.value,y=l.objectKey,x=p["".concat(t,"_").concat(l.layerType)];if(!x)return[];const T=y.match(/^(.*)-use-theme$/);if(T&&x[T[1]])return s.Q(s.S(m))?[].concat(cr({key:n,value:m,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:y})):cr({key:n,value:m,valueSpec:{type:"string"},style:c,styleSpec:p});const S=y.match(/^(.*)-transition$/);if(t==="paint"&&S&&x[S[1]]&&x[S[1]].transition)return cr({key:n,value:m,valueSpec:p.transition,style:c,styleSpec:p});const M=l.valueSpec||x[y];if(!M)return[new s.a3(n,m,'unknown property "'.concat(y,'"'))];let E;if(s.a0(m)&&s.N(M)&&!M.tokens&&(E=/^{([^}]+)}$/.exec(m))){const R='`{ "type": "identity", "property": '.concat(E?JSON.stringify(E[1]):'"_"'," }`");return[new s.V(n,m,'"'.concat(y,'" does not support interpolation syntax\nUse an identity property function instead: ').concat(R,"."))]}const C=[];if(l.layerType==="symbol")y!=="text-field"||!c||c.glyphs||c.imports||C.push(new s.V(n,m,'use of "text-field" requires a style "glyphs" property')),y==="text-font"&&s.a4(s.S(m))&&s.J(m.type)==="identity"&&C.push(new s.V(n,m,'"text-font" does not support identity functions'));else if(l.layerType==="model"&&t==="paint"&&d&&d.layout&&d.layout.hasOwnProperty("model-id")&&s.N(M)&&(s.a5(M)||s.O(M))){const R=s.W(s.S(m),M).value,z="expression"in R&&R.expression||"_styleExpression"in R&&R._styleExpression&&R._styleExpression.expression;z&&!s.X(z,["measure-light"])&&(y==="model-emissive-strength"&&s.Y(z)&&s.Z(z)||C.push(new s.V(n,m,"".concat(y," does not support measure-light expressions when the model layer source is vector tile or GeoJSON."))))}return C.concat(cr({key:l.key,value:m,valueSpec:M,style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:y}))}function bi(l){return qt(l,"paint")}function ci(l){return qt(l,"layout")}function xr(l){let t=[];const n=l.value,c=l.key,d=l.style,p=l.styleSpec;if(!s.H(n))return[new s.V(c,n,"object expected")];n.type||n.ref||t.push(new s.V(c,n,'either "type" or "ref" is required'));let m=s.J(n.type);const y=s.J(n.ref);if(n.id){const x=s.J(n.id);for(let T=0;T<l.arrayIndex;T++){const S=d.layers[T];s.J(S.id)===x&&t.push(new s.V(c,n.id,'duplicate layer id "'.concat(x,'", previously used at line ').concat(S.id.__line__)))}}if("ref"in n){let x;["type","source","source-layer","filter","layout"].forEach((T=>{T in n&&t.push(new s.V(c,n[T],'"'.concat(T,'" is prohibited for ref layers')))})),d.layers.forEach((T=>{s.J(T.id)===y&&(x=T)})),x?x.ref?t.push(new s.V(c,n.ref,"ref cannot reference another ref layer")):m=s.J(x.type):typeof y=="string"&&t.push(new s.V(c,n.ref,'ref layer "'.concat(y,'" not found')))}else if(m!=="background"&&m!=="sky"&&m!=="slot")if(n.source)if(s.a0(n.source)){const x=d.sources&&d.sources[n.source],T=x&&s.J(x.type);x?T==="vector"&&m==="raster"?t.push(new s.V(c,n.source,'layer "'.concat(n.id,'" requires a raster source'))):T==="raster"&&m!=="raster"?t.push(new s.V(c,n.source,'layer "'.concat(n.id,'" requires a vector source'))):T!=="vector"||n["source-layer"]?T==="raster-dem"&&m!=="hillshade"?t.push(new s.V(c,n.source,"raster-dem source can only be used with layer type 'hillshade'.")):T!=="raster-array"||["raster","raster-particle"].includes(m)?m==="line"&&n.paint&&(n.paint["line-gradient"]||n.paint["line-trim-offset"])&&T==="geojson"&&!x.lineMetrics?t.push(new s.V(c,n,'layer "'.concat(n.id,'" specifies a line-gradient, which requires the GeoJSON source to have `lineMetrics` enabled.'))):m==="raster-particle"&&T!=="raster-array"&&t.push(new s.V(c,n.source,'layer "'.concat(n.id,"\" requires a 'raster-array' source."))):t.push(new s.V(c,n.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new s.V(c,n,'layer "'.concat(n.id,'" must specify a "source-layer"'))):t.push(new s.V(c,n.source,'source "'.concat(n.source,'" not found')))}else t.push(new s.V("".concat(c,".source"),n.source,'"source" must be a string'));else t.push(new s.V(c,n,'missing required property "source"'));return t=t.concat(Xr({key:c,value:n,valueSpec:p.layer,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":()=>[],type:()=>cr({key:"".concat(c,".type"),value:n.type,valueSpec:p.layer.type,style:l.style,styleSpec:l.styleSpec,object:n,objectKey:"type"}),filter:x=>Po(Object.assign({layerType:m},x)),layout:x=>Xr({layer:n,key:x.key,value:x.value,valueSpec:{},style:x.style,styleSpec:x.styleSpec,objectElementValidators:{"*":T=>ci(Object.assign({layerType:m},T))}}),paint:x=>Xr({layer:n,key:x.key,value:x.value,valueSpec:{},style:x.style,styleSpec:x.styleSpec,objectElementValidators:{"*":T=>bi(Object.assign({layerType:m,layer:n},T))}}),appearances(x){const T=Pr({key:x.key,value:x.value,valueSpec:x.valueSpec,style:x.style,styleSpec:x.styleSpec,arrayElementValidator:E=>(function(C){const{key:R,layer:z,layerType:N}=C,k=s.J(C.value),U=s.J(k.name),$=s.J(k.condition),G=Xr({key:R,value:k,valueSpec:C.styleSpec.appearance,style:C.style,styleSpec:C.styleSpec,objectElementValidators:{condition:ee=>(function(Z){const ie=[];return ie.push(...vn({key:Z.key,value:Z.object.condition,valueSpec:s.a6.appearance.condition,expressionContext:"appearance"})),ie})(Object.assign({layer:z,layerType:N},ee)),properties:ee=>(function(Z){const ie=[],{styleSpec:Q,layer:Y,layerType:re}=Z,_e=Q["paint_".concat(re)],he=Q["layout_".concat(re)],Ae=Z.object[Z.objectKey];for(const ve in Ae){const ze=ve in _e?"paint":ve in he?"layout":void 0;if(!ze){ie.push(new s.V(Z.key,ve,'unknown property "'.concat(ve,'" for layer type "').concat(re,'"')));continue}const Xe=Object.assign({},Z,{key:"".concat(Z.key,".").concat(ve),object:Ae,objectKey:ve,layer:Y,layerType:re,value:Ae[ve],valueSpec:ze==="paint"?_e[ve]:he[ve]});ie.push(...qt(Xe,ze))}return ie})(Object.assign({layer:z,layerType:N},ee))}});return U!=="hidden"&&$===void 0&&G.push(new s.V(C.key,"name",'Appearance with name different than "hidden" must have a condition')),G})(Object.assign({layerType:m,layer:n},E))}),S=Array.isArray(x.value)?x.value:[],M=new Set;return S.forEach(((E,C)=>{const R=s.J(E.name);if(R)if(M.has(R)){const z=s.J(n.id);T.push(new s.V(x.key,R,'Duplicated appearance name "'.concat(R,'" for layer "').concat(z,'"')))}else M.add(R)})),T}}})),t}function ar({key:l,value:t}){return s.a0(t)?[]:[new s.V(l,t,"string expected, ".concat(s.K(t)," found"))]}const hi={promoteId:function l({key:t,value:n}){if(s.a0(n))return ar({key:t,value:n});if(Array.isArray(n)){const d=[],p=s.S(n),m=s.U(p);return m.result==="error"&&m.value.forEach((y=>{d.push(new s.V("".concat(t).concat(y.key),null,"".concat(y.message)))})),s.X(m.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||d.push(new s.V("".concat(t),null,"promoteId expression should be only feature dependent")),d}if(!s.H(n))return[new s.V(t,n,'string, expression or object expected, "'.concat(s.K(n),'" found'))];const c=[];for(const d in n)c.push(...l({key:"".concat(t,".").concat(d),value:n[d]}));return c}};function Xo(l){const t=l.value,n=l.key,c=l.styleSpec,d=l.style;if(!s.H(t))return[new s.V(n,t,"object expected, ".concat(s.K(t)," found"))];if(!("type"in t))return[new s.V(n,t,'"type" is required')];const p=s.J(t.type);let m=[];switch(["vector","raster","raster-dem","raster-array"].includes(p)&&("url"in t||"tiles"in t||m.push(new s.a3(n,t,'Either "url" or "tiles" is required.'))),p){case"vector":case"raster":case"raster-dem":case"raster-array":return m=m.concat(Xr({key:n,value:t,valueSpec:c["source_".concat(p.replace("-","_"))],style:l.style,styleSpec:c,objectElementValidators:hi})),m;case"geojson":if(m=Xr({key:n,value:t,valueSpec:c.source_geojson,style:d,styleSpec:c,objectElementValidators:hi}),"cluster"in t&&"clusterProperties"in t){if(!s.H(t.clusterProperties))return[new s.V("".concat(n,".clusterProperties"),t,"object expected, ".concat(s.K(t)," found"))];for(const y in t.clusterProperties){const x=t.clusterProperties[y];if(!Array.isArray(x))return[new s.V("".concat(n,".clusterProperties.").concat(y),x,"array expected")];const[T,S]=x,M=typeof T=="string"?[T,["accumulated"],["get",y]]:T;m.push(...vn({key:"".concat(n,".").concat(y,".map"),value:S,expressionContext:"cluster-map"})),m.push(...vn({key:"".concat(n,".").concat(y,".reduce"),value:M,expressionContext:"cluster-reduce"}))}}return m;case"video":return Xr({key:n,value:t,valueSpec:c.source_video,style:d,styleSpec:c});case"image":return Xr({key:n,value:t,valueSpec:c.source_image,style:d,styleSpec:c});case"canvas":return[new s.V(n,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return pn({key:"".concat(n,".type"),value:t.type,valueSpec:{values:Nr(c)}})}}function Nr(l){return l.source.reduce(((t,n)=>{const c=l[n];return c.type.type==="enum"&&(t=t.concat(Object.keys(c.type.values||{}))),t}),[])}function yo(l){const t=l.value,n=l.styleSpec,c=n.light,d=l.style;if(t===void 0)return[];if(!s.H(t))return[new s.V("light",t,"object expected, ".concat(s.K(t)," found"))];let p=[];for(const m in t){const y=m.match(/^(.*)-transition$/),x=m.match(/^(.*)-use-theme$/);p=p.concat(x&&c[x[1]]?cr({key:m,value:t[m],valueSpec:{type:"string"},style:d,styleSpec:n}):y&&c[y[1]]&&c[y[1]].transition?cr({key:m,value:t[m],valueSpec:n.transition,style:d,styleSpec:n}):c[m]?cr({key:m,value:t[m],valueSpec:c[m],style:d,styleSpec:n}):[new s.V(m,t[m],'unknown property "'.concat(m,'"'))])}return p}function Yo(l){const t=l.value;if(!t)return[];const n=l.key;if(!s.H(t))return[new s.V(n,t,"object expected, ".concat(s.K(t)," found"))];let c=[];const d=l.styleSpec,p=d["light-3d"],m=l.style,y=l.style.lights;for(const S of["type","id"])if(!(S in t))return c=c.concat([new s.V(n,t,'missing property "'.concat(S,'"'))]),c;if(!s.a0(t.type))return c=c.concat([new s.V("".concat(n,".type"),t.type,"string expected")]),c;if(y)for(let S=0;S<l.arrayIndex;S++){const M=s.J(t.type),E=y[S];s.J(E.type)===M&&c.push(new s.V(n,t.id,'duplicate light type "'.concat(t.type,'", previously defined at line ').concat(E.id.__line__)))}const x="properties_light_".concat(t.type);if(!(x in d))return c=c.concat([new s.V("".concat(n,".type"),t,"Invalid light type ".concat(t.type))]),c;const T=d[x];for(const S in t)if(S==="properties"){const M=t[S];if(!s.H(M))return c=c.concat([new s.V("properties",M,"object expected, ".concat(s.K(M)," found"))]),c;for(const E in M){const C=E.match(/^(.*)-transition$/),R=E.match(/^(.*)-use-theme$/);c=c.concat(R&&T[R[1]]?cr({key:S,value:M[E],valueSpec:{type:"string"},style:m,styleSpec:d}):C&&T[C[1]]&&T[C[1]].transition?cr({key:S,value:t[S],valueSpec:d.transition,style:m,styleSpec:d}):T[E]?cr({key:E,value:M[E],valueSpec:T[E],style:m,styleSpec:d}):[new s.a3(l.key,M[E],'unknown property "'.concat(E,'"'))])}}else c=c.concat(p[S]?cr({key:S,value:t[S],valueSpec:p[S],style:m,styleSpec:d}):[new s.a3(S,t[S],'unknown property "'.concat(S,'"'))]);return c}function xo(l){const t=l.value,n=l.key,c=l.style,d=l.styleSpec,p=d.terrain;if(t==null)return[];if(!s.H(t))return[new s.V("terrain",t,"object expected, ".concat(s.K(t)," found"))];let m=[];for(const y in t){const x=y.match(/^(.*)-transition$/),T=y.match(/^(.*)-use-theme$/);m=m.concat(T&&p[T[1]]?cr({key:y,value:t[y],valueSpec:{type:"string"},style:c,styleSpec:d}):x&&p[x[1]]&&p[x[1]].transition?cr({key:y,value:t[y],valueSpec:d.transition,style:c,styleSpec:d}):p[y]?cr({key:y,value:t[y],valueSpec:p[y],style:c,styleSpec:d}):[new s.a3(y,t[y],'unknown property "'.concat(y,'"'))])}if(t.source)if(s.a0(t.source)){const y=c.sources&&c.sources[t.source],x=y&&s.J(y.type);y?x!=="raster-dem"&&m.push(new s.V("".concat(n,".source"),t.source,"terrain cannot be used with a source of type ".concat(x,', it only be used with a "raster-dem" source type'))):m.push(new s.V("".concat(n,".source"),t.source,'source "'.concat(t.source,'" not found')))}else m.push(new s.V("".concat(n,".source"),t.source,"source must be a string"));else m.push(new s.V(n,t,'terrain is missing required property "source"'));return m}function Wn(l){const t=l.value,n=l.style,c=l.styleSpec,d=c.fog;if(t===void 0)return[];if(!s.H(t))return[new s.V("fog",t,"object expected, ".concat(s.K(t)," found"))];let p=[];for(const m in t){const y=m.match(/^(.*)-transition$/),x=m.match(/^(.*)-use-theme$/);p=p.concat(x&&d[x[1]]?cr({key:m,value:t[m],valueSpec:{type:"string"},style:n,styleSpec:c}):y&&d[y[1]]&&d[y[1]].transition?cr({key:m,value:t[m],valueSpec:c.transition,style:n,styleSpec:c}):d[m]?cr({key:m,value:t[m],valueSpec:d[m],style:n,styleSpec:c}):[new s.a3(m,t[m],'unknown property "'.concat(m,'"'))])}return p}const Mn={"*":()=>[],array:Pr,boolean:function(l){const t=l.value,n=l.key;return s.$(t)?[]:[new s.V(n,t,"boolean expected, ".concat(s.K(t)," found"))]},number:hs,color:function({key:l,value:t}){return s.a0(t)?s.a1.parseCSSColor(t)===null?[new s.V(l,t,'color expected, "'.concat(t,'" found'))]:[]:[new s.V(l,t,"color expected, ".concat(s.K(t)," found"))]},enum:pn,filter:Po,function:Bn,layer:xr,object:Xr,source:Xo,model:s.a7,light:yo,"light-3d":Yo,terrain:xo,fog:Wn,string:ar,formatted:function(l){return ar(l).length===0?[]:vn(l)},resolvedImage:function(l){return ar(l).length===0?[]:vn(l)},projection:function(l){const t=l.value,n=l.styleSpec,c=n.projection,d=l.style;if(s.H(t)){let p=[];for(const m in t)p=p.concat(cr({key:m,value:t[m],valueSpec:c[m],style:d,styleSpec:n}));return p}return s.a0(t)?[]:[new s.V("projection",t,"object or string expected, ".concat(s.K(t)," found"))]},import:function(l){const t=l.key,{value:n,styleSpec:c}=l;if(!s.H(n))return[new s.V(t,n,"import must be an object")];const y=n,{data:d}=y,p=cf(y,["data"]);Object.defineProperty(p,"__line__",{value:n.__line__,enumerable:!1});let m=Xr(Object.assign({},l,{value:p,valueSpec:c.import}));return s.J(p.id)===""&&m.push(new s.V("".concat(l.key,".id"),p,"import id can't be an empty string")),d&&(m=m.concat(Yr(d,c,{key:"".concat(l.key,".data")}))),m},iconset:function(l){const t=l.value,n=l.key,c=l.styleSpec,d=l.style;if(!s.H(t))return[new s.V(n,t,"object expected")];if(!t.type)return[new s.V(n,t,'"type" is required')];const p=s.J(t.type);let m=[];if(m=m.concat(Xr({key:n,value:t,valueSpec:c["iconset_".concat(p)],style:d,styleSpec:c})),(function(y,x){return!(y!=="source"||!x.source)})(p,t)){const y=d.sources&&d.sources[t.source],x=y&&s.J(y.type);y?x!=="raster-array"&&m.push(new s.V(n,t.source,"iconset cannot be used with a source of type ".concat(String(x),', it only be used with a "raster-array" source type'))):m.push(new s.V(n,t.source,'source "'.concat(t.source,'" not found')))}return m}};function cr(l,t=!1){const n=l.value,c=l.valueSpec,d=l.styleSpec;if(c.expression){if(s.a4(s.J(n)))return Bn(l);if(s.Q(s.S(n)))return vn(l)}if(c.type&&Mn[c.type]){const p=Mn[c.type](l);return t===!0&&p.length>0&&Array.isArray(l.value)?vn(l):p}return Xr(Object.assign({},l,{valueSpec:c.type?d[c.type]:c}))}function Xr(l){const t=l.key,n=l.value,c=l.valueSpec||{},d=l.objectElementValidators||{},p=l.style,m=l.styleSpec;if(!s.H(n))return[new s.V(t,n,"object expected, ".concat(s.K(n)," found"))];let y=[];for(const x in n){const T=x.split(".")[0];let S;d[T]?S=d[T]:c[T]?S=cr:d["*"]?S=d["*"]:c["*"]&&(S=cr),S?y=y.concat(S({key:(t&&"".concat(t,"."))+x,value:n[x],valueSpec:c[T]||c["*"],style:p,styleSpec:m,object:n,objectKey:x},n)):y.push(new s.a3(t,n[x],'unknown property "'.concat(x,'"')))}for(const x in c){if(d[x])continue;const T=c[x];T.required&&T.default===void 0&&n[x]===void 0&&y.push(new s.V(t,n,'missing required property "'.concat(x,'"')))}return y}function ho({key:l,value:t}){const n=ar({key:l,value:t});if(n.length)return n;const c=t;return c.indexOf("{fontstack}")===-1&&n.push(new s.V(l,t,'"glyphs" url must include a "{fontstack}" token')),c.indexOf("{range}")===-1&&n.push(new s.V(l,t,'"glyphs" url must include a "{range}" token')),n}function Yr(l,t=s.a6,n={}){return Xr({key:n.key||"",value:l,valueSpec:Object.assign(t.$root,{"*":{type:"*"}}),styleSpec:t,style:l,objectElementValidators:{glyphs:ho}})}function Kr(l,t=s.a6){return fe(Yr(l,t))}const Un=l=>fe(Xo(l)),vo=l=>fe(yo(l)),eo=l=>fe(Yo(l)),Cn=l=>fe(xo(l)),Be=l=>fe(Wn(l)),to=l=>fe((function(t){const n=t.value,c=t.style,d=t.styleSpec,p=d.snow;if(n===void 0)return[];if(!s.H(n))return[new s.V("snow",n,"object expected, ".concat(s.K(n)," found"))];let m=[];for(const y in n){const x=y.match(/^(.*)-transition$/);m=m.concat(x&&p[x[1]]&&p[x[1]].transition?cr({key:y,value:n[y],valueSpec:d.transition,style:c,styleSpec:d}):p[y]?cr({key:y,value:n[y],valueSpec:p[y],style:c,styleSpec:d}):[new s.a3(y,n[y],'unknown property "'.concat(y,'"'))])}return m})(l)),cn=l=>fe((function(t){const n=t.value,c=t.style,d=t.styleSpec,p=d.rain;if(n===void 0)return[];if(!s.H(n))return[new s.V("rain",n,"object expected, ".concat(s.K(n)," found"))];let m=[];for(const y in n){const x=y.match(/^(.*)-transition$/);m=m.concat(x&&p[x[1]]&&p[x[1]].transition?cr({key:y,value:n[y],valueSpec:d.transition,style:c,styleSpec:d}):p[y]?cr({key:y,value:n[y],valueSpec:p[y],style:c,styleSpec:d}):[new s.a3(y,n[y],'unknown property "'.concat(y,'"'))])}return m})(l)),bo=l=>fe(xr(l)),ii=l=>fe(Po(l)),Jr=l=>fe(bi(l)),Ps=l=>fe(ci(l)),ds=l=>fe(s.a7(l));function fe(l){return l.slice().sort(((t,n)=>t.line&&n.line?t.line-n.line:0))}function O(l,t){let n=!1;if(t&&t.length)for(const c of t)c instanceof s.a3?s.w(c.message):(l.fire(new s.y(new Error(c.message))),n=!0);return n}const B=s.a6.light;let X;class ae extends s.E{constructor(t,n="flat"){super(),this._transitionable=new s.a8(X||(X=new s.a9({anchor:new s.aa(B.anchor),position:new s.ab(B.position),color:new s.aa(B.color),intensity:new s.aa(B.intensity)}))),this.setLight(t,n),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,n,c={}){this._validate(vo,t,c)||(this._transitionable.setTransitionOrValue(t),this.id=n)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||c.validate!==!1)&&O(this,t.call(Kr,Object.assign({value:n,style:{glyphs:!0,sprite:!0},styleSpec:s.a6})))}}const se=s.a6.terrain;let de=class extends s.E{constructor(l,t,n,c,d){super(),this.scope=n,this._transitionable=new s.a8(new s.a9({source:new s.aa(se.source),exaggeration:new s.aa(se.exaggeration)}),n,c),this._transitionable.setTransitionOrValue(l,c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=d}get(){return this._transitionable.serialize()}set(l,t){this._transitionable.setTransitionOrValue(l,t)}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}getExaggeration(l){return this._transitioning.possiblyEvaluate(new s.ac(l,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const l=this._transitionable._values.exaggeration;if(!l)return null;const t=l.value.expression;if(!t)return null;let n=-1,c=-1,d=1;for(const p of t.zoomStops)d=t.evaluate(new s.ac(p,{worldview:this.worldview})),d>.01?(n=p,c=-1):c=p;return d<.01&&n>0&&c>n?[n,c]:null}isZoomDependent(){const l=this._transitionable._values.exaggeration;return l!=null&&l.value!=null&&l.value.expression!=null&&l.value.expression instanceof s.ad}};const Ee=45,pe=65,Te=.05;function We(l,t,n,c){const d=s.ah(Ee,pe,n),[p,m]=je(l,c);let y=1-Math.min(1,Math.exp((t-p)/(m-p)*-6));return y*=y*y,y=Math.min(1,1.00747*y),y*d*l.alpha}function je(l,t){const n=.5/Math.tan(.5*t);return[l.range[0]+n,l.range[1]+n]}function bt(l,t,n,c,d){const p=s.af([],[t,n,c],d.mercatorFogMatrix);return We(l,s.ag(p),d.pitch,d._fov)}function Vt(l,t,n,c,d,p,m){const y=[[n,c,0],[d,c,0],[d,p,0],[n,p,0]];let x=Number.MAX_VALUE,T=-Number.MAX_VALUE;for(const S of y){const M=s.af([],S,t),E=s.ag(M);x=Math.min(x,E),T=Math.max(T,E)}return[We(l,x,m.pitch,m._fov),We(l,T,m.pitch,m._fov)]}const kt=s.a6.fog;class Mt extends s.E{constructor(t,n,c,d){super();const p=new s.a9({range:new s.aa(kt.range),color:new s.aa(kt.color),"color-use-theme":new s.aa({type:"string","property-type":"data-constant",default:"default"}),"high-color":new s.aa(kt["high-color"]),"high-color-use-theme":new s.aa({type:"string","property-type":"data-constant",default:"default"}),"space-color":new s.aa(kt["space-color"]),"space-color-use-theme":new s.aa({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new s.aa(kt["horizon-blend"]),"star-intensity":new s.aa(kt["star-intensity"]),"vertical-range":new s.aa(kt["vertical-range"])});this._transitionable=new s.a8(p,c,new Map(d)),this.set(t,d),this._transitioning=this._transitionable.untransitioned(),this._transform=n,this.properties=new s.ai(p),this.scope=c}get state(){const t=this._transform,n=t.projection.name==="globe",c=s.aj(t.zoom),d=this.properties.get("range"),p=[.5,3];return{range:n?[s.ak(p[0],d[0],c),s.ak(p[1],d[1],c)]:d,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,n,c={}){if(this._validate(Be,t,c))return;const d=Object.assign({},t);for(const p of Object.keys(kt))d[p]===void 0&&(d[p]=kt[p].default);this._options=d,this._transitionable.setTransitionOrValue(this._options,n)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const n=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:s.ah(Ee,pe,t))*n.a}getOpacityAtLatLng(t,n){return this._transform.projection.supportsFog?(function(c,d,p){const m=s.ae.fromLngLat(d),y=p.elevation?p.elevation.getAtPointOrZero(m):0;return bt(c,m.x,m.y,y,p)})(this.state,t,n):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const n=this._transform.calculateFogTileMatrix(t.toUnwrapped());return Vt(this.state,n,0,0,s.al,s.al,this._transform)}getOpacityForBounds(t,n,c,d,p){return this._transform.projection.supportsFog?Vt(this.state,t,n,c,d,p,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?je(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const n=[4,5,6,7];for(const c of n){const d=t.points[c];let p;if(d[2]>=0)p=d;else{const m=t.points[c-4];p=s.am(m,d,m[2]/(m[2]-d[2]))}if(bt(this.state,p[0],p[1],0,this._transform)>=Te)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||c.validate!==!1)&&O(this,t.call(Kr,Object.assign({value:n,style:{glyphs:!0,sprite:!0},styleSpec:s.a6})))}}let ni,si,Xi,Fr,tn=class extends s.E{constructor(l,t,n,c){super();const d=ni||(ni=new s.a9({density:new s.aa(s.a6.snow.density),intensity:new s.aa(s.a6.snow.intensity),color:new s.aa(s.a6.snow.color),opacity:new s.aa(s.a6.snow.opacity),vignette:new s.aa(s.a6.snow.vignette),"vignette-color":new s.aa(s.a6.snow["vignette-color"]),"center-thinning":new s.aa(s.a6.snow["center-thinning"]),direction:new s.aa(s.a6.snow.direction),"flake-size":new s.aa(s.a6.snow["flake-size"])}));this._transitionable=new s.a8(d,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.ai(d),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=s.an(n[0]),d=-Math.max(s.an(n[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],m=this.properties.get("vignette"),y=this.properties.get("vignette-color");return y.a=m,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.ao(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:y}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(to,l,n))return;const c=Object.assign({},l),d=s.a6.snow;for(const p of Object.keys(d))c[p]===void 0&&(c[p]=d[p].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||n.validate!==!1)&&O(this,l.call(Kr,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:s.a6})))}},Hr=class extends s.E{constructor(l,t,n,c){super();const d=si||(si=new s.a9({density:new s.aa(s.a6.rain.density),intensity:new s.aa(s.a6.rain.intensity),color:new s.aa(s.a6.rain.color),opacity:new s.aa(s.a6.rain.opacity),vignette:new s.aa(s.a6.rain.vignette),"vignette-color":new s.aa(s.a6.rain["vignette-color"]),"center-thinning":new s.aa(s.a6.rain["center-thinning"]),direction:new s.aa(s.a6.rain.direction),"droplet-size":new s.aa(s.a6.rain["droplet-size"]),"distortion-strength":new s.aa(s.a6.rain["distortion-strength"])}));this._transitionable=new s.a8(d,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.ai(d),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=s.an(n[0]),d=-Math.max(s.an(n[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],m=this.properties.get("vignette-color");return m.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.ao(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:m}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(cn,l,n))return;const c=Object.assign({},l),d=s.a6.rain;for(const p of Object.keys(d))c[p]===void 0&&(c[p]=d[p].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||n.validate!==!1)&&O(this,l.call(Kr,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:s.a6})))}};class Ur extends s.E{constructor(t,n,c,d){super(),this.scope=c,this._options=t,this.properties=new s.ai(n),this._transitionable=new s.a8(n,c,new Map(d)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,n){this._options=t,this._transitionable.setTransitionOrValue(t.properties,n)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class $i{constructor(t,n,c){this.screenBounds=t,this.cameraPoint=c.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=n,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,c)}static createFromScreenPoints(t,n){let c,d;if(t instanceof s.P||typeof t[0]=="number"){const p=s.P.convert(t);c=[p],d=n.isPointAboveHorizon(p)}else{const p=s.P.convert(t[0]),m=s.P.convert(t[1]),y=p.add(m)._div(2);c=[p,m],d=s.aq(p,m).every((x=>n.isPointAboveHorizon(x)))&&n.isPointAboveHorizon(y)}return new $i(c,d,n)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return s.aq(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const n=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],d=s.aq(n,c,0,!1);return this.cameraPoint.y>c.y&&(this.cameraPoint.x>n.x&&this.cameraPoint.x<c.x?d.splice(3,0,this.cameraPoint):this.cameraPoint.x>=c.x?d[2]=this.cameraPoint:this.cameraPoint.x<=n.x&&(d[3]=this.cameraPoint)),s.ar(d,t)}bufferedCameraGeometryGlobe(t){const n=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],d=s.aq(n,c,t),p=this.cameraPoint.clone();switch(3*((p.y>n.y)+(p.y>c.y))+((p.x>n.x)+(p.x>c.x))){case 0:d[0]=p,d[4]=p.clone();break;case 1:d.splice(1,0,p);break;case 2:d[1]=p;break;case 3:d.splice(4,0,p);break;case 5:d.splice(2,0,p);break;case 6:d[3]=p;break;case 7:d.splice(3,0,p);break;case 8:d[2]=p}return d}containsTile(t,n,c,d=0){const p=Math.max(t.queryPadding,t.evaluateQueryRenderedFeaturePadding())/n._pixelsPerMercatorPixel+1,m=c?this._bufferedCameraMercator(p,n):this._bufferedScreenMercator(p,n);let y=t.tileID.wrap+(m.unwrapped?d:0);const x=m.polygon.map((N=>s.as(t.tileTransform,N,y)));if(!s.at(x,0,0,s.al,s.al))return;y=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?d:0);const T=this.screenGeometryMercator.polygon.map((N=>s.au(t.tileTransform,N,y))),S=T.map((N=>new s.P(N[0],N[1]))),M=n.getFreeCameraOptions().position||new s.ae(0,0,0),E=s.au(t.tileTransform,M,y),C=T.map((N=>{const k=s.av(N,N,E);return s.aw(k,k),new s.ax(E,k)})),R=s.ay(t,1,n.zoom)*n._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:S,tilespaceRays:C,bufferedTilespaceGeometry:x,bufferedTilespaceBounds:(z=s.az(x),z.min.x=s.aA(z.min.x,0,s.al),z.min.y=s.aA(z.min.y,0,s.al),z.max.x=s.aA(z.max.x,0,s.al),z.max.y=s.aA(z.max.y,0,s.al),z),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:R};var z}_bufferedScreenMercator(t,n){const c=Rr(t);if(this._screenRaycastCache[c])return this._screenRaycastCache[c];{let d;return d=n.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),n):{polygon:this.bufferedScreenGeometry(t).map((p=>n.pointCoordinate3D(p))),unwrapped:!0},this._screenRaycastCache[c]=d,d}}_bufferedCameraMercator(t,n){const c=Rr(t);if(this._cameraRaycastCache[c])return this._cameraRaycastCache[c];{let d;return d=n.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),n):{polygon:this.bufferedCameraGeometry(t).map((p=>n.pointCoordinate3D(p))),unwrapped:!0},this._cameraRaycastCache[c]=d,d}}_projectAndResample(t,n){const c=(function(p,m){const y=s.aB([],m.pixelMatrix,m.globeMatrix),x=[0,-s.aD,0,1],T=[0,s.aD,0,1],S=[0,0,0,1];s.aC(x,x,y),s.aC(T,T,y),s.aC(S,S,y);const M=new s.P(x[0]/x[3],x[1]/x[3]),E=new s.P(T[0]/T[3],T[1]/T[3]),C=s.aE(p,M)&&x[3]<S[3],R=s.aE(p,E)&&T[3]<S[3];if(!C&&!R)return null;const z=(function(ie,Q,Y){for(let re=1;re<ie.length;re++){const _e=dr(Q.pointCoordinate3D(ie[re-1]).x),he=dr(Q.pointCoordinate3D(ie[re]).x);if(Y<0){if(_e<he)return{idx:re,t:-_e/(he-1-_e)}}else if(he<_e)return{idx:re,t:(1-_e)/(he+1-_e)}}return null})(p,m,C?-1:1);if(!z)return null;const{idx:N,t:k}=z;let U=N>1?di(p.slice(0,N),m):[],$=N<p.length?di(p.slice(N),m):[];U=U.map((ie=>new s.P(dr(ie.x),ie.y))),$=$.map((ie=>new s.P(dr(ie.x),ie.y)));const G=[...U];G.length===0&&G.push($[$.length-1]);const ee=s.ak(G[G.length-1].y,($.length===0?U[0]:$[0]).y,k);let Z;return Z=C?[new s.P(0,ee),new s.P(0,0),new s.P(1,0),new s.P(1,ee)]:[new s.P(1,ee),new s.P(1,1),new s.P(0,1),new s.P(0,ee)],G.push(...Z),$.length===0?G.push(U[0]):G.push(...$),{polygon:G.map((ie=>new s.ae(ie.x,ie.y))),unwrapped:!1}})(t,n);if(c)return c;const d=(function(p,m){let y=!1,x=-1/0,T=0;for(let M=0;M<p.length-1;M++)p[M].x>x&&(x=p[M].x,T=M);for(let M=0;M<p.length-1;M++){const E=(T+M)%(p.length-1),C=p[E],R=p[E+1];Math.abs(C.x-R.x)>.5&&(C.x<R.x?(C.x+=1,E===0&&(p[p.length-1].x+=1)):(R.x+=1,E+1===p.length-1&&(p[0].x+=1)),y=!0)}const S=s.aF(m.center.lng);return y&&S<Math.abs(S-1)&&p.forEach((M=>{M.x-=1})),{polygon:p,unwrapped:y}})(di(t,n).map((p=>new s.P(dr(p.x),p.y))),n);return{polygon:d.polygon.map((p=>new s.ae(p.x,p.y))),unwrapped:d.unwrapped}}}function di(l,t){return s.aG(l,(n=>{const c=t.pointCoordinate3D(n);n.x=c.x,n.y=c.y}),1/256)}function dr(l){return l<0?1+l%1:l%1}function Rr(l){return 100*l|0}function Ki(l,t,n,c,d){const p=function(y,x){if(y)return d(y);if(x){if(l.url&&x.tiles&&l.tiles&&delete l.tiles,x.variants){if(!Array.isArray(x.variants))return d(new Error("variants must be an array"));for(const S of x.variants){if(S==null||typeof S!="object"||S.constructor!==Object)return d(new Error("variant must be an object"));if(!Array.isArray(S.capabilities))return d(new Error("capabilities must be an array"));if(S.capabilities.length===1&&S.capabilities[0]==="meshopt"){x=Object.assign(x,S);break}}}const T=s.aH(Object.assign({},x,l),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);T.tiles=t.canonicalizeTileset(T,l.url),d(null,T)}},m=(function(y,x,T){if(!y)return null;if(!x&&!T)return y;T=T||y.worldview_default;const S=Object.values(y.language||{});if(S.length===0)return null;const M=Object.values(y.worldview||{});if(M.length===0)return null;const E=S.every((R=>R===x)),C=M.every((R=>R===T));return E&&C?y:x in(y.language_options||{})||T in(y.worldview_options||{})?null:y.language_options&&y.worldview_options?y:null})(l.data,n,c);return m?s.o.frame((()=>p(null,m))):l.url?s.m(t.transformRequest(t.normalizeSourceURL(l.url,null,n,c),s.R.Source),p):s.o.frame((()=>{const T=l,{data:y}=T,x=cf(T,["data"]);p(null,x)}))}function fr(l,t){const n=Math.pow(2,t.z),c=Math.floor(s.aF(l.getWest())*n),d=Math.floor(s.aJ(l.getNorth())*n),p=Math.ceil(s.aF(l.getEast())*n),m=Math.ceil(s.aJ(l.getSouth())*n);return t.x>=c&&t.x<p&&t.y>=d&&t.y<m}class un{constructor(t,n,c){this.bounds=t?s.aI.convert(this.validateBounds(t)):null,this.minzoom=n||0,this.maxzoom=c||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(const n of t)this.extraBounds.push(s.aI.convert(this.validateBounds(n)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!fr(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(const n of this.extraBounds)if(fr(n,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;const n=new un(t.bounds,t.minzoom,t.maxzoom);return n.addExtraBounds(t.extra_bounds),n}}class Xn extends s.E{constructor(t,n,c,d){if(super(),this.id=t,this.dispatcher=c,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Object.assign(this,s.aH(n,["url","scheme","tileSize","promoteId"])),this._options=Object.assign({type:"vector"},n),this._collectResourceTiming=!!n.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(d),this._tileWorkers={},this._deduped=new s.aK}load(t){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"}));const n=Array.isArray(this.map._language)?this.map._language.join():this.map._language,c=this.map.getWorldview();this._tileJSONRequest=Ki(this._options,this.map._requestManager,n,c,((d,p)=>{if(this._tileJSONRequest=null,this._loaded=!0,d)n&&console.warn("Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ".concat(n)),c&&console.warn("Requested worldview strings must be a valid ISO alpha-2 code. Found: ".concat(c)),this.fire(new s.y(d));else if(p){if(Object.assign(this,p),this.hasWorldviews=!!p.worldview_options,p.worldview_default&&(this.worldviewDefault=p.worldview_default),p.vector_layers){this.vectorLayers=p.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const m of p.vector_layers)this.vectorLayerIds.push(m.id),p.worldview&&p.worldview[m.source]&&this.localizableLayerIds.add(m.id)}this.tileBounds=un.fromTileJSON(p),xn(p.tiles,this.map._requestManager._customAccessToken),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}t&&t(d)}))}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=s.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}loadTile(t,n){const c=t.tileID.canonical.url(this.tiles,this.scheme),d=this.map._requestManager.normalizeTileURL(c),p=this.map._requestManager.transformRequest(d,s.R.Tile),m=this.map.style?this.map.style.getLut(this.scope):null,y=m?{image:m.image.clone()}:null,x={request:p,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:y,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:s.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault,indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};if(this.hasWorldviews&&s.h(c)&&(x.localizableLayerIds=this.localizableLayerIds),x.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=n:t.request=t.actor.send("reloadTile",x,T.bind(this));else if(t.actor=this._tileWorkers[d]=this._tileWorkers[d]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",x,T.bind(this),void 0,!0);else{const S=s.aL.call({deduped:this._deduped},x,((M,E)=>{if(M||!E)T.call(this,M);else{const C=s.aM(E.responseHeaders);x.data={cacheControl:C.cacheControl,expires:C.expires,rawData:E.rawData.slice(0)},t.actor&&t.actor.send("loadTile",x,T.bind(this),void 0,!0)}}),!0);t.request={cancel:S}}function T(S,M){return delete t.request,t.aborted?n(null):S&&S.status!==404?n(S):(M&&M.resourceTiming&&(t.resourceTiming=M.resourceTiming),this.map._refreshExpiredTiles&&M&&t.setExpiryData(M),t.loadVectorData(M,this.map.painter),s.aN(this.dispatcher),n(null,M),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,n){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Ko extends s.E{constructor(t,n,c,d){super(),this.id=t,this.dispatcher=c,this.setEventedParent(d),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Object.assign({type:"raster"},n),Object.assign(this,s.aH(n,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"}));const n=this.map.getWorldview();this._tileJSONRequest=Ki(this._options,this.map._requestManager,null,n,((c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?this.fire(new s.y(c)):d&&(Object.assign(this,d),d.raster_layers&&(this.rasterLayers=d.raster_layers,this.rasterLayerIds=this.rasterLayers.map((p=>p.id))),this.tileBounds=un.fromTileJSON(d),xn(d.tiles),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(c)}))}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=s.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,n){const c=s.o.devicePixelRatio>=2,d=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),c,this.tileSize);t.request=s.n(this.map._requestManager.transformRequest(d,s.R.Tile),((p,m,y)=>{if(delete t.request,t.aborted)return t.state="unloaded",n(null);if(p)return t.state="errored",n(p);if(!m)return n(null);const x=s.aM(y);this.map._refreshExpiredTiles&&t.setExpiryData(x),t.setTexture(m,this.map.painter),t.state="loaded",s.aN(this.dispatcher),n(null)}))}abortTile(t,n){t.request&&(t.request.cancel(),delete t.request),n&&n()}unloadTile(t,n){t.texture&&t.texture instanceof s.T?(t.destroy(!0),t.texture&&t.texture instanceof s.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),n&&n()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function pa([l,t],n,c,{scaled:d=!0}={}){const{tileSize:p,buffer:m}=c,{x:y,y:x,z:T}=n;if(!isFinite(y)||!isFinite(x)||!isFinite(T))throw new Error("Invalid MRT header");const S=2**T,M=S*s.aF(l),E=S*s.aJ(t);return(function([C,R],z,{scaled:N=!0}={}){if(!z)throw new Error("bandView is undefined");const{data:k,tileSize:U,buffer:$,offset:G,scale:ee,dimension:Z}=z;if(C<-$||C>U+$||R<-$||R>U+$)throw new Error("Point (".concat(C,", ").concat(R,") out of bounds for tileSize=").concat(U,", buffer=").concat($));const ie=(R+$)*(U+2*$)+(C+$);if(new Uint32Array(k.buffer)[ie]===4294967295)return null;let Q=[];Q=N?[]:new z.data.constructor(Z);for(let Y=0;Y<Z;Y++)Q[Y]=Math.round(1e12*(k[Z*ie+Y]*ee+G))/1e12;return Q})([Math.min(Math.max(-m,Math.floor((M-y)*p)),p-1+m),Math.min(Math.max(-m,Math.floor((E-x)*p)),p-1+m)],c,{scaled:d})}class mn extends Ko{constructor(t,n,c,d){super(t,n,c,d),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._loadTilePending={},this._loadTileLoaded={},this._options=Object.assign({type:"raster-array"},n)}triggerRepaint(t){const n=this.map.painter._terrain,c=this.map.style.getSourceCache(this.id);n&&n.enabled&&c&&n._clearRenderCacheForTile(c.id,t.tileID),this.map.triggerRepaint()}loadTile(t,n){const c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(c,s.R.Tile),p={request:d,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=d,t.actor||(t.actor=this.dispatcher.getActor());const m=(y,x,T)=>{if(delete t.request,t.aborted)return t.state="unloaded",n(null);if(y)return y.name==="AbortError"?void 0:(t.state="errored",n(y));if(this.map._refreshExpiredTiles&&x){const S=s.aM(T);t.setExpiryData(S)}if(this.partial&&t.state!=="expired")t.state="empty";else if(!this.partial){if(!x)return n(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=x}n(null)};t.request=this.partial?t.fetchHeader(void 0,m.bind(this)):t.actor.send("loadTile",p,m.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,n){const c=t.texturePerLayer;if(t.flushAllQueues(),c.size){t.destroy(!0);for(const d of c.values())this.map.painter.saveTileTexture(d)}else t.destroy()}prepareTile(t,n,c,d){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBandForRender(n,c,d,((p,m)=>{if(p)return t.state="errored",this.fire(new s.y(p)),void this.triggerRepaint(t);m&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(c,m,this.map.painter),t.state="loaded",this.triggerRepaint(t))})))}getInitialBand(t){if(!this.rasterLayers)return 0;const n=this.rasterLayers.find((({id:p})=>p===t)),c=n&&n.fields,d=c&&c.bands&&c.bands;return d?d[0]:0}getTextureDescriptor(t,n,c){if(!t)return;const d=n.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!d)return;let p=null;n instanceof s.aQ?p=n.paint.get("raster-array-band"):n instanceof s.aR&&(p=n.paint.get("raster-particle-array-band"));const m=p||this.getInitialBand(d);if(m==null)return;if(!t.textureDescriptorPerLayer.get(n.id))return void this.prepareTile(t,d,n.id,m);if(t.updateNeeded(n.id,m)&&!c)return;const y=t.textureDescriptorPerLayer.get(n.id);return Object.assign({},y,{texture:t.texturePerLayer.get(n.id)})}getImages(t,n){const c=new Map;for(const d of t)for(const p of n){const[m,y]=p.split("/"),x=d.getLayer(m);if(!x||!x.hasBand(y)||!x.hasDataForBand(y))continue;const{bytes:T,tileSize:S,buffer:M}=x.getBandView(y),E=S+2*M,C={data:new s.q({width:E,height:E},T),pixelRatio:2,sdf:!1,usvg:!1,version:0};c.set(p,C)}return c}queryRasterArrayValueByBandId(t,n,c){const d=n._mrt;return new Promise((p=>{const m={},y=new Set;for(const[x,T]of Object.entries(d.layers)){if(c.layerName&&x!==c.layerName)continue;const S={};m[x]=S;for(const{bands:M}of T.dataIndex)for(const E of M)c.bands&&!c.bands.includes(E)||(y.add(s.B(x,E)),n.fetchBand(x,null,E,(C=>{s.o.frame((()=>{S[E]=C?null:pa([t.lng,t.lat],d,T.getBandView(E)),y.delete(s.B(x,E)),y.size===0&&p(m)}))}),!1))}y.size===0&&p(m)}))}_loadTileForQuery(t,n){if(this._loadTileLoaded[t.uid])return void n(null,t._mrt);if(this._loadTilePending[t.uid])return void this._loadTilePending[t.uid].push(n);this._loadTilePending[t.uid]=[n];const c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(c,s.R.Tile);t.actor.send("loadTile",{request:d,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:!1},((p,m,y)=>{if(p)return this._loadTilePending[t.uid].forEach((x=>x(p,null))),void delete this._loadTilePending[t.uid];if(!m)return this._loadTilePending[t.uid].forEach((x=>x(null,null))),void delete this._loadTilePending[t.uid];if(this.map._refreshExpiredTiles&&m){const x=s.aM(y);t.setExpiryData(x)}t._mrt=m,t._isHeaderLoaded=!0,t.state="loaded",this._loadTilePending[t.uid].forEach((x=>x(null,m))),this._loadTileLoaded[t.uid]=!0,delete this._loadTilePending[t.uid]}),void 0,!0)}queryRasterArrayValueByAllBands(t,n,c){return new Promise(((d,p)=>{this._loadTileForQuery(n,((m,y)=>{m?p(m):d(y?this.queryRasterArrayValueByBandId(t,n,c):null)}))}))}queryRasterArrayValue(t,n){const c=s.aS.convert(t),d=this.findLoadedParent(c);return d&&d._mrt?n.bands||!this.partial?this.queryRasterArrayValueByBandId(c,d,n):this.queryRasterArrayValueByAllBands(c,d,n):Promise.resolve(null)}findLoadedParent(t){const n=s.ae.fromLngLat(t,this.map.transform.tileSize),c=this.maxzoom+1,d=1<<c,p=Math.floor(n.x),m=Math.floor((n.x-p)*d),y=Math.floor(n.y*d),x=this.map.style.getSourceCache(this.id),T=new s.aP(c,p,c,m,y);return x.findLoadedParent(T,this.minzoom)}}const Jo={vector:Xn,raster:Ko,"raster-dem":class extends Ko{constructor(l,t,n,c){super(l,t,n,c),this.type="raster-dem",this.maxzoom=22,this._options=Object.assign({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function c(d,p){d&&(l.state="errored",t(d)),p&&(l.dem=p,l.dem.onDeserialize(),l.needsHillshadePrepare=!0,l.needsDEMTextureUpload=!0,l.state="loaded",t(null))}l.request=s.n(this.map._requestManager.transformRequest(n,s.R.Tile),function(d,p,m){if(delete l.request,l.aborted)l.state="unloaded",t(null);else if(d)l.state="errored",t(d);else if(p){const y=s.aM(m);this.map._refreshExpiredTiles&&l.setExpiryData(y);const x=ImageBitmap&&p instanceof ImageBitmap&&s.r(),T=1-(p.width-s.aO(p.width))/2;T<1||l.neighboringTiles||(l.neighboringTiles=this._getNeighboringTiles(l.tileID));const S=x?p:s.o.getImageData(p,T),M={uid:l.uid,tileID:l.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:S,encoding:this.encoding,padding:T};l.actor&&l.state!=="expired"||(l.actor=this.dispatcher.getActor(),l.actor.send("loadTile",M,c.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(l){const t=l.canonical,n=Math.pow(2,t.z),c=(t.x-1+n)%n,d=t.x===0?l.wrap-1:l.wrap,p=(t.x+1+n)%n,m=t.x+1===n?l.wrap+1:l.wrap,y={};return y[new s.aP(l.overscaledZ,d,t.z,c,t.y).key]={backfilled:!1},y[new s.aP(l.overscaledZ,m,t.z,p,t.y).key]={backfilled:!1},t.y>0&&(y[new s.aP(l.overscaledZ,d,t.z,c,t.y-1).key]={backfilled:!1},y[new s.aP(l.overscaledZ,l.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},y[new s.aP(l.overscaledZ,m,t.z,p,t.y-1).key]={backfilled:!1}),t.y+1<n&&(y[new s.aP(l.overscaledZ,d,t.z,c,t.y+1).key]={backfilled:!1},y[new s.aP(l.overscaledZ,l.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},y[new s.aP(l.overscaledZ,m,t.z,p,t.y+1).key]={backfilled:!1}),y}},"raster-array":mn,geojson:class extends s.E{constructor(l,t,n,c){super(),this.id=l,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=n.getActor(),this.setEventedParent(c),this._data=t.data,this._options=Object.assign({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const d=s.al/this.tileSize;this.workerOptions=Object.assign({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*d,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*d,extent:s.al,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:s.al,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*d,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(l){this.map=l,this.setData(this._data)}setData(l){return this._data=l,this._updateWorkerData(),this}updateData(l){if(!this._options.dynamic)return this.fire(new s.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof l!="string"&&(l.type==="Feature"&&(l={type:"FeatureCollection",features:[l]}),l.type!=="FeatureCollection"))return this.fire(new s.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof l!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const t=new Map;for(const n of this._data.features)t.set(n.id,n);for(const n of l.features)t.set(n.id,n);this._data.features=[...t.values()]}else this._data=l;return this._updateWorkerData(!0),this}getClusterExpansionZoom(l,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterChildren(l,t){return this.actor.send("geojson.getClusterChildren",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterLeaves(l,t,n,c){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:l,limit:t,offset:n},c),this}_updateWorkerData(l=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new s.z("dataloading",{dataType:"source"})),this._loaded=!1;const t=Object.assign({append:l},this.workerOptions);t.scope=this.scope;const n=this._data;typeof n=="string"?(t.request=this.map._requestManager.transformRequest(s.o.resolveURL(n),s.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(n),this._pendingLoad=this.actor.send("".concat(this.type,".loadData"),t,((c,d)=>{if(this._loaded=!0,this._pendingLoad=null,c)this.fire(new s.y(c));else{const p={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&d&&d.resourceTiming&&d.resourceTiming[this.id]&&(p.resourceTiming=d.resourceTiming[this.id]),l&&(this._partialReload=!0),this.fire(new s.z("data",p)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(l),this._coalesce=!1)}))}loaded(){return this._loaded}reload(){const l=s.B(this.id,this.scope);this.map.style.clearSource(l),this._updateWorkerData()}loadTile(l,t){const n=l.actor?"reloadTile":"loadTile";l.actor=this.actor;const c=this.map.style?this.map.style.getLut(this.scope):null,d=c?{image:c.image.clone()}:null,p=this._partialReload,m={type:this.type,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:d,scope:this.scope,pixelRatio:s.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:l.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:p,worldview:this.map.getWorldview(),indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};l.request=this.actor.send(n,m,((y,x)=>p&&!x?(l.state="loaded",t(null)):(delete l.request,l.destroy(),l.aborted?t(null):y?t(y):(l.loadVectorData(x,this.map.painter,n==="reloadTile"),t(null)))),void 0,n==="loadTile")}abortTile(l){l.request&&(l.request.cancel(),delete l.request),l.aborted=!0}unloadTile(l,t){this.actor.send("removeTile",{uid:l.uid,type:this.type,source:this.id,scope:this.scope}),l.destroy()}onRemove(l){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Object.assign({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends s.aT{constructor(l,t,n,c){super(l,t,n,c),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const l=this.options;this.urls=[];for(const t of l.urls)this.urls.push(this.map._requestManager.transformRequest(t,s.R.Source).url);s.aU(this.urls,((t,n)=>{this._loaded=!0,t?this.fire(new s.y(t)):n&&(this.video=n,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(l){if(this.video){const t=this.video.seekable;l<t.start(0)||l>t.end(0)?this.fire(new s.y(new s.V("sources.".concat(this.id),null,"Playback for this video can be set only between the ".concat(t.start(0)," and ").concat(t.end(0),"-second mark.")))):this.video.currentTime=l}}getVideo(){return this.video}onAdd(l){this.map||(this.map=l,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const l=this.map.painter.context,t=l.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new s.T(l,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(l)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:s.aT,model:s.aW,"batched-model":class extends s.E{constructor(l,t,n,c){super(),this.type="batched-model",this.id=l,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=n,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(c)}onAdd(l){this.map=l,this.load()}reload(){this.cancelTileJSONRequest();const l=s.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(l)))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(l){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map.getWorldview();this._tileJSONRequest=Ki(this._options,this.map._requestManager,t,n,((c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?(t&&console.warn("Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ".concat(t)),n&&n.length!==2&&console.warn("Requested worldview strings must be a valid ISO alpha-2 code. Found: ".concat(n)),this.fire(new s.y(c))):d&&(Object.assign(this,d),d.bounds&&(this.tileBounds=new un(d.bounds,this.minzoom,this.maxzoom)),xn(d.tiles,this.map._requestManager._customAccessToken),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))),l&&l(c)}))}hasTransition(){return!1}hasTile(l){return!this.tileBounds||this.tileBounds.contains(l.canonical)}loaded(){return this._loaded}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme)),c={request:this.map._requestManager.transformRequest(n,s.R.Tile),data:void 0,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,tileSize:this.tileSize*l.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:l.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:s.o.devicePixelRatio,promoteId:this.promoteId};if(l.actor&&l.state!=="expired")if(l.state==="loading")l.reloadCallback=t;else{if(l.buckets){const p=Object.values(l.buckets);for(const m of p)m.dirty=!0;return void(l.state="loaded")}l.request=l.actor.send("reloadTile",c,d.bind(this))}else l.actor=this.dispatcher.getActor(),l.request=l.actor.send("loadTile",c,d.bind(this),void 0,!0);function d(p,m){return l.aborted?t(null):p&&p.status!==404?t(p):(this.map._refreshExpiredTiles&&m&&l.setExpiryData(m),l.loadModelData(m,this.map.painter),l.state="loaded",void t(null))}}serialize(){return Object.assign({},this._options)}},canvas:class extends s.aT{constructor(l,t,n,c){super(l,t,n,c),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some((d=>!Array.isArray(d)||d.length!==2||d.some((p=>typeof p!="number"))))||this.fire(new s.y(new s.V("sources.".concat(l),null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.y(new s.V("sources.".concat(l),null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new s.y(new s.V("sources.".concat(l),null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new s.y(new s.V("sources.".concat(l),null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.y(new s.V("sources.".concat(l),null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(l){this.map=l,this.load(),this.canvas&&this.animate&&this.play()}onRemove(l){this.pause()}prepare(){let l=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,l=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,l=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?!l&&!this._playing||this.texture instanceof s.aV||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new s.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const l of[this.canvas.width,this.canvas.height])if(isNaN(l)||l<=0)return!0;return!1}},custom:class extends s.E{constructor(l,t,n,c){super(),this.id=l,this.type="custom",this._dataType="raster",this._dispatcher=n,this._implementation=t,this.setEventedParent(c),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new s.y(new Error("Missing implementation for ".concat(this.id," custom source")))),this._implementation.loadTile||this.fire(new s.y(new Error("Missing loadTile implementation for ".concat(this.id," custom source")))),this._implementation.bounds&&(this.tileBounds=new un(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),Object.assign(this,s.aH(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return s.aH(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(l){this.map=l,this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(l),this.load()}onRemove(l){this._implementation.onRemove&&this._implementation.onRemove(l)}hasTile(l){if(this._implementation.hasTile){const{x:t,y:n,z:c}=l.canonical;return this._implementation.hasTile({x:t,y:n,z:c})}return!this.tileBounds||this.tileBounds.contains(l.canonical)}loadTile(l,t){const{x:n,y:c,z:d}=l.tileID.canonical,p=new AbortController;l.request=Promise.resolve(this._implementation.loadTile({x:n,y:c,z:d},{signal:p.signal})).then(function(m){return delete l.request,l.aborted?(l.state="unloaded",t(null)):m===void 0?(l.state="errored",t(null)):m===null?(this.loadTileData(l,{width:this.tileSize,height:this.tileSize,data:null}),l.state="loaded",t(null)):(function(y){return y instanceof ImageData||y instanceof HTMLCanvasElement||y instanceof ImageBitmap||y instanceof HTMLImageElement})(m)?(this.loadTileData(l,m),l.state="loaded",void t(null)):(l.state="errored",t(new Error("Can't infer data type for ".concat(this.id,", only raster data supported at the moment"))))}.bind(this)).catch((m=>{m.name!=="AbortError"&&(l.state="errored",t(m))})),l.request.cancel=()=>p.abort()}loadTileData(l,t){l.setTexture(t,this.map.painter)}unloadTile(l,t){if(l.texture&&l.texture instanceof s.T?(l.destroy(!0),l.texture&&l.texture instanceof s.T&&this.map.painter.saveTileTexture(l.texture)):l.destroy(),this._implementation.unloadTile){const{x:n,y:c,z:d}=l.tileID.canonical;this._implementation.unloadTile({x:n,y:c,z:d})}t&&t()}abortTile(l,t){l.request&&l.request.cancel&&(l.request.cancel(),delete l.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((l=>({x:l.canonical.x,y:l.canonical.y,z:l.canonical.z})))}_clearTiles(){const l=s.B(this.id,this.scope);this.map.style.clearSource(l)}_update(){this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}}},io=function(l,t,n,c){const d=new Jo[t.type](l,t,n,c);if(d.id!==l)throw new Error("Expected Source id to be ".concat(l," instead of ").concat(d.id));return s.aX(["load","abort","unload","serialize","prepare"],d),d};function fs(l,t,n=""){return"".concat(n,":").concat(t.id||"",":").concat(t.layer.id,":").concat((function(c){if("layerId"in c)return"layer:".concat(c.layerId);{const{featuresetId:d,importId:p}=c;return"featureset:".concat(d).concat(p?":import:".concat(p):"")}})(l.target))}function wo(l,t,n,c=""){if(l.uniqueFeatureID){const d=fs(l,t,c);if(n.has(d))return!0;n.add(d)}return!1}function To(l,t,n,c,d=!1){const p=t.sourceCache.transform,m=t.sourceCache.tilesIn(l,t.has3DLayers,d);m.sort(zl);const y=[];for(const x of m){const T=x.tile.queryRenderedFeatures(t,x,n,c,p,d);Object.keys(T).length&&y.push({wrappedTileID:x.tile.tileID.wrapped().key,queryResults:T})}for(const x in t.layers){const T=t.layers[x];if(T.styleLayer){const S=T.styleLayer.queryRenderedFeatures(l,t.sourceCache,c);Object.keys(S).length&&y.push({wrappedTileID:0,queryResults:S})}}return y.length===0?{}:(function(x){const T={},S={};for(const M of x){const E=M.queryResults,C=M.wrappedTileID,R=S[C]=S[C]||{};for(const z in E){const N=E[z],k=R[z]=R[z]||{},U=T[z]=T[z]||[];for(const $ of N)k[$.featureIndex]||(k[$.featureIndex]=!0,U.push($))}}return T})(y)}function Pc(l,t,n,c,d,p){const m={},y=c.queryRenderedSymbols(l),x=[];for(const T of Object.keys(y).map(Number))x.push(d[T]);x.sort(zl);for(const T of x){const S=T.featureIndex.lookupSymbolFeatures(y[T.bucketInstanceId],T.bucketIndex,T.sourceLayerIndex,t,n,p);for(const M in S){const E=m[M]=m[M]||[],C=S[M];C.sort(((R,z)=>{const N=T.featureSortOrder;if(N){const k=N.indexOf(R.featureIndex);return N.indexOf(z.featureIndex)-k}return z.featureIndex-R.featureIndex}));for(const R of C)E.push(R)}}return m}function Dl(l,t){const n=l.getRenderableIds().map((p=>l.getTileByID(p))),c=[],d={};for(let p=0;p<n.length;p++){const m=n[p],y=m.tileID.canonical.key;d[y]||(d[y]=!0,m.querySourceFeatures(c,t))}return c}function zl(l,t){const n=l.tileID,c=t.tileID;return n.overscaledZ-c.overscaledZ||n.canonical.y-c.canonical.y||n.wrap-c.wrap||n.canonical.x-c.canonical.x}function Ll(l,t){const n={};if(!t)return n;for(const c of l){const d=c.layerIds.map((p=>t.getLayer(p))).filter(Boolean);if(d.length!==0){c.layers=d,c.stateDependentLayerIds&&(c.stateDependentLayers=c.stateDependentLayerIds.map((p=>d.filter((m=>m.id===p))[0])));for(const p of d)n[p.fqid]=c}}return n}const fo=32,ps=33,ro=new Uint16Array(8184);for(let l=0;l<2046;l++){let t=l+2,n=0,c=0,d=0,p=0,m=0,y=0;for(1&t?d=p=m=fo:n=c=y=fo;(t>>=1)>1;){const T=n+d>>1,S=c+p>>1;1&t?(d=n,p=c,n=m,c=y):(n=d,c=p,d=m,p=y),m=T,y=S}const x=4*l;ro[x+0]=n,ro[x+1]=c,ro[x+2]=d,ro[x+3]=p}const Ro=new Uint16Array(2178),Rs=new Uint8Array(1089),ma=new Uint16Array(1089);function Rc(l){return l===0?-.03125:l===32?.03125:0}const Dc={type:2,extent:s.al,loadGeometry:()=>[[new s.P(0,0),new s.P(s.al+1,0),new s.P(s.al+1,s.al+1),new s.P(0,s.al+1),new s.P(0,0)]]};class bs{constructor(t,n,c,d,p,m){this.tileID=t,this.uid=s.b1(),this.uses=0,this.tileSize=n,this.tileZoom=c,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=p,d&&d.style&&(this._lastUpdatedBrightness=d.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",d&&d.transform&&(this.projection=d.transform.projection),this.worldview=m,this._hasAppearances=null}registerFadeDuration(t){const n=t+this.timeAdded;n<s.o.now()||this.fadeEndTime&&n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=s.aY(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,n,c){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=Ll(t.buckets,n.style),this.hasSymbolBuckets=!1;for(const d in this.buckets){const p=this.buckets[d];if(p instanceof s.b3){if(this.hasSymbolBuckets=!0,!c)break;p.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const d in this.buckets){const p=this.buckets[d];if(p instanceof s.b3&&p.hasRTLText){this.hasRTLText=!0,s.b4();break}}this.queryPadding=0;for(const d in this.buckets){const p=this.buckets[d],m=n.style.getOwnLayer(d);if(!m)continue;const y=m.queryRadius(p);this.queryPadding=Math.max(this.queryPadding,y)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new s.b2}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,n,c){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,Ll(t.buckets,n.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t,n){for(const p in this.buckets){const m=this.buckets[p];if(m.uploadPending()){let y={},x=[],T={zoom:0,pitch:0,brightness:0,worldview:""};if(n){if(n.style){x=n.style.listImages();const S=m.layers[0],M=S.sourceLayer||"_geojsonTileLayer",E=n.style.getLayerSourceCache(S);E&&(y=E._state.getState(M,void 0))}T={zoom:n.transform.zoom||0,pitch:n.transform.pitch||0,brightness:n.style.getBrightness()||0,worldview:n.worldview||""}}m.upload(t,this.tileID.canonical,y,x,T)}}const c=t.gl,d=this.imageAtlas;d&&!d.uploaded&&(this.imageAtlasTexture=new s.T(t,d.image,c.RGBA8,{useMipmap:!!d.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new s.T(t,this.glyphAtlasImage,c.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new s.T(t,this.lineAtlas.image,c.R8),this.lineAtlas.uploaded=!0)}prepare(t,n,c){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,c),!n||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const d=n.style.getBrightness();this._hasAppearances===null&&(this._hasAppearances=this.hasAppearances(n)),(this._lastUpdatedBrightness||d||this._hasAppearances)&&(!this._hasAppearances&&this._lastUpdatedBrightness&&d&&Math.abs(this._lastUpdatedBrightness-d)<.001||(this.updateBuckets(n,this._lastUpdatedBrightness!==d),this._lastUpdatedBrightness=d))}evaluateQueryRenderedFeaturePadding(){let t=0;for(const n in this.buckets){const c=this.buckets[n];c.evaluateQueryRenderedFeaturePadding&&(t=Math.max(t,c.evaluateQueryRenderedFeaturePadding()))}return t}queryRenderedFeatures(t,n,c,d,p,m){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const y=this.evaluateQueryRenderedFeaturePadding(),x=(function(T,S){const M=s.bp([],[.5*T.width,.5*-T.height,1]);return s.bq(M,M,[1,-1,0]),s.aB(M,M,T.calculateProjMatrix(S.toUnwrapped())),Float32Array.from(M)})(p,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:n,pixelPosMatrix:x,transform:d,availableImages:c,tileTransform:this.tileTransform,worldview:this.worldview,queryRadius:y})}querySourceFeatures(t,n){const c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;const d=c.loadVTLayers(),p=n?n.sourceLayer:"",m=d._geojsonTileLayer||d[p];if(!m)return;const y=s.b5(n&&n.filter),{z:x,x:T,y:S}=this.tileID.canonical,M={z:x,x:T,y:S};for(let E=0;E<m.length;E++){const C=m.feature(E);if(y.needGeometry){const N=s.b6(C,!0);if(!y.filter(new s.ac(this.tileID.overscaledZ,{worldview:this.worldview}),N,this.tileID.canonical))continue}else if(!y.filter(new s.ac(this.tileID.overscaledZ,{worldview:this.worldview}),C))continue;const R=c.getId(C,p),z=new s.b7(C,x,T,S,R);z.tile=M,t.push(z)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){const n=this.expirationTime;if(t.cacheControl){const c=s.b8(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const c=Date.now();let d=!1;if(this.expirationTime>c)d=!1;else if(n)if(this.expirationTime<n)d=!0;else{const p=this.expirationTime-n;p?this.expirationTime=c+Math.max(p,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}hasAppearances(t){for(const n in this.buckets)if(t.style.hasLayer(n)&&this.buckets[n].layers.some((c=>c.appearances&&c.appearances.length>0)))return!0;return!1}updateBuckets(t,n){if(!this.latestFeatureIndex||!t.style)return;const c=this.latestFeatureIndex.loadVTLayers(),d=t.style.listImages(),p=t.style.getBrightness();for(const m in this.buckets){if(!t.style.hasLayer(m))continue;const y=this.buckets[m],x=y.layers[0],T=x.sourceLayer||"_geojsonTileLayer",S=c[T],M=t.style.getLayerSourceCache(x);let E={};M&&(E=M._state.getState(T,void 0));const C=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},R=Object.keys(E).length>0&&!n;if(y.hasAppearances=y.layers.some((N=>N.appearances&&N.appearances.length>0)),(R&&y.stateDependentLayers.length!==0||n)&&y.update(E,S,d,C,R?y.stateDependentLayers:y.layers,n,p),R&&y.stateDependentLayers.length!==0||n||y.hasAppearances){const N={zoom:t.transform.zoom,pitch:t.transform.pitch,brightness:t.style.getBrightness()||0,worldview:t.worldview};y.updateAppearances(this.tileID.canonical,E,d,N)}(y instanceof s.b9||y instanceof s.ba)&&t._terrain&&t._terrain.enabled&&M&&y.uploadPending()&&t._terrain._clearRenderCacheForTile(M.id,this.tileID);const z=t&&t.style&&t.style.getOwnLayer(m);z&&(this.queryPadding=Math.max(this.queryPadding,z.queryRadius(y)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<s.o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=s.o.now()+t}setTexture(t,n){const c=n.context,d=c.gl;this.texture=this.texture||n.getTileTexture(t.width),this.texture&&this.texture instanceof s.T?this.texture.update(t):(this.texture=new s.T(c,t,d.RGBA8,{useMipmap:!0}),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE))}setDependencies(t,n){const c={};for(const d of n)c[d]=!0;this.dependencies[t]=c}hasDependency(t,n){for(const c of t){const d=this.dependencies[c];if(d){for(const p of n)if(d[p])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,n){if(!n||n.name==="mercator"||this._tileDebugBuffer)return;const c=s.bb(Dc,this.tileID.canonical,this.tileTransform)[0],d=new s.bc,p=new s.bd;for(let m=0;m<c.length;m++){const{x:y,y:x}=c[m];d.emplaceBack(y,x),p.emplaceBack(m)}p.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(p),this._tileDebugBuffer=t.createVertexBuffer(d,s.be.members),this._tileDebugSegments=s.bf.simpleSegment(0,0,d.length,p.length)}_makeTileBoundsBuffers(t,n){if(this._tileBoundsBuffer||!n||n.name==="mercator")return;const c=s.bb(Dc,this.tileID.canonical,this.tileTransform)[0];let d,p;if(this.isRaster){const m=(function(y,x){const T=s.aY(y,x),S=Math.pow(2,y.z);for(let N=0;N<ps;N++)for(let k=0;k<ps;k++){const U=s.aZ((y.x+(k+Rc(k))/fo)/S),$=s.a_((y.y+(N+Rc(N))/fo)/S),G=x.project(U,$),ee=N*ps+k;Ro[2*ee+0]=Math.round((G.x*T.scale-T.x)*s.al),Ro[2*ee+1]=Math.round((G.y*T.scale-T.y)*s.al)}Rs.fill(0),ma.fill(0);for(let N=2045;N>=0;N--){const k=4*N,U=ro[k+0],$=ro[k+1],G=ro[k+2],ee=ro[k+3],Z=U+G>>1,ie=$+ee>>1,Q=Z+ie-$,Y=ie+U-Z,re=$*ps+U,_e=ee*ps+G,he=ie*ps+Z,Ae=Math.hypot((Ro[2*re+0]+Ro[2*_e+0])/2-Ro[2*he+0],(Ro[2*re+1]+Ro[2*_e+1])/2-Ro[2*he+1])>=16;Rs[he]=Rs[he]||(Ae?1:0),N<1022&&(Rs[he]=Rs[he]||Rs[($+Y>>1)*ps+(U+Q>>1)]||Rs[(ee+Y>>1)*ps+(G+Q>>1)])}const M=new s.a$,E=new s.b0;let C=0;function R(N,k){const U=k*ps+N;return ma[U]===0&&(M.emplaceBack(Ro[2*U+0],Ro[2*U+1],N*s.al/fo,k*s.al/fo),ma[U]=++C),ma[U]-1}function z(N,k,U,$,G,ee){const Z=N+U>>1,ie=k+$>>1;if(Math.abs(N-G)+Math.abs(k-ee)>1&&Rs[ie*ps+Z])z(G,ee,N,k,Z,ie),z(U,$,G,ee,Z,ie);else{const Q=R(N,k),Y=R(U,$),re=R(G,ee);E.emplaceBack(Q,Y,re)}}return z(0,0,fo,fo,fo,0),z(fo,fo,0,0,0,fo),{vertices:M,indices:E}})(this.tileID.canonical,n);d=m.vertices,p=m.indices}else{d=new s.a$,p=new s.b0;for(const{x:y,y:x}of c)d.emplaceBack(y,x,0,0);const m=s.bg(d.int16.subarray(0,4*d.length),void 0,4);for(let y=0;y<m.length;y+=3)p.emplaceBack(m[y],m[y+1],m[y+2])}this._tileBoundsBuffer=t.createVertexBuffer(d,s.bh.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(p),this._tileBoundsSegments=s.bf.simpleSegment(0,0,d.length,p.length)}_makeGlobeTileDebugBuffers(t,n){const c=n.projection;if(!c||c.name!=="globe"||n.freezeTileCoverage)return;const d=this.tileID.canonical,p=s.bi(d,n),m=s.bj(p),y=s.aj(n.zoom);let x;y>0&&(x=s.bk(new Float64Array(16),n.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,d,n,m,x,y),this._makeGlobeTileDebugTextBuffer(t,d,n,m,x,y)}_globePoint(t,n,c,d,p,m,y){let x=s.bl(t,n,c);if(m){const T=1<<c.z,S=s.aF(d.center.lng),M=s.aJ(d.center.lat),E=(c.x+.5)/T-S;let C=0;E>.5?C=-1:E<-.5&&(C=1);let R=(t/s.al+c.x)/T+C,z=(n/s.al+c.y)/T;R=(R-S)*d._pixelsPerMercatorPixel+S,z=(z-M)*d._pixelsPerMercatorPixel+M;const N=[R*d.worldSize,z*d.worldSize,0];s.af(N,N,m),x=s.bm(x,N,y)}return s.af(x,x,p)}_makeGlobeTileDebugBorderBuffer(t,n,c,d,p,m){const y=new s.bc,x=new s.bd,T=new s.bn,S=(E,C,R,z,N)=>{const k=(R-E)/(N-1),U=(z-C)/(N-1),$=y.length;for(let G=0;G<N;G++){const ee=E+G*k,Z=C+G*U;y.emplaceBack(ee,Z);const ie=this._globePoint(ee,Z,n,c,d,p,m);T.emplaceBack(ie[0],ie[1],ie[2]),x.emplaceBack($+G)}},M=s.al;S(0,0,M,0,16),S(M,0,M,M,16),S(M,M,0,M,16),S(0,M,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(x),this._tileDebugBuffer=t.createVertexBuffer(y,s.be.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(T,s.bo.members),this._tileDebugSegments=s.bf.simpleSegment(0,0,y.length,x.length)}_makeGlobeTileDebugTextBuffer(t,n,c,d,p,m){const y=s.al/4,x=new s.bc,T=new s.b0,S=new s.bn,M=25;T.reserve(32),x.reserve(M),S.reserve(M);const E=(C,R)=>M*C+R;for(let C=0;C<M;C++){const R=C*y;for(let z=0;z<M;z++){const N=z*y;x.emplaceBack(N,R);const k=this._globePoint(N,R,n,c,d,p,m);S.emplaceBack(k[0],k[1],k[2])}}for(let C=0;C<4;C++)for(let R=0;R<4;R++){const z=E(C,R),N=E(C,R+1),k=E(C+1,R),U=E(C+1,R+1);T.emplaceBack(z,N,k),T.emplaceBack(k,N,U)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(T),this._tileDebugTextBuffer=t.createVertexBuffer(x,s.be.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(S,s.bo.members),this._tileDebugTextSegments=s.bf.simpleSegment(0,0,M,32)}destroy(t=!1){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof s.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}s.br.setPbf(s.bs);class Ys extends bs{constructor(t,n,c,d,p){super(t,n,c,d,p),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._taskQueue=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexturePerLayer(t,n,c){const d=c.context,p=d.gl;let m=this.texturePerLayer.get(t)||c.getTileTexture(n.width);m&&m instanceof s.T?m.update(n,{premultiply:!1}):m=new s.T(d,n,p.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,m)}flushQueues(t){const n=this._workQueuePerLayer.get(t)||[],c=this._fetchQueuePerLayer.get(t)||[];for(;n.length;)n.pop()();for(;c.length;)c.pop()()}flushAllQueues(){for(const t of this._workQueuePerLayer.keys()){const n=this._workQueuePerLayer.get(t)||[];for(;n.length;)n.pop()()}for(const t of this._fetchQueuePerLayer.keys()){const n=this._fetchQueuePerLayer.get(t)||[];for(;n.length;)n.pop()()}}fetchHeader(t=16384,n){const c=this._mrt=new s.br(30),d=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=s.bt(d,((p,m,y)=>{if(p)n(p);else try{const x=c.getHeaderLength(m);if(x>t)return void(this.request=this.fetchHeader(x,n));c.parseHeader(m),this._isHeaderLoaded=!0;let T=0;for(const S of Object.values(c.layers))T=Math.max(T,S.dataIndex[S.dataIndex.length-1].lastByte);m.byteLength>=T&&(this.entireBuffer=m),n(null,this.entireBuffer||m,y)}catch(x){n(x)}})),this.request}fetchBandForRender(t,n,c,d){this.fetchBand(t,n,c,(p=>{if(p)return void d(p);this.updateTextureDescriptor(t,n,c);const m=this.textureDescriptorPerLayer.get(n);d(null,m?m.img:null)}))}fetchBand(t,n,c,d,p=!0){const m=this._mrt;if(!this._isHeaderLoaded||!m)return void d(new Error("Tile header is not ready"));const y=this.actor;if(!y)return void d(new Error("Can't fetch tile band without an actor"));let x;const T=s.B(String(c),s.B(this.tileID.key,t));let S=this._taskQueue.get(T);S?S.add(d):(S=new Set,S.add(d),this._taskQueue.set(T,S));const M=(z,N)=>{x.complete(z,N),z?d(z):(S.values().forEach((k=>k(null,N))),this._taskQueue.delete(T))},E=(z,N)=>{if(z)return d(z);const k=y.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:N,task:x},M,void 0,!0);if(n!==null){const U=this._workQueuePerLayer.get(n)||[];U.push((()=>{k&&k.cancel(),x.cancel()})),this._workQueuePerLayer.has(n)||this._workQueuePerLayer.set(n,U)}};let C;try{C=m.getLayer(t)}catch(z){if(this.state==="reloading")return;throw z}if(!C)return void d(new Error('Unknown sourceLayer "'.concat(t,'"')));if(C.hasDataForBand(c))return S.values().forEach((z=>z(null,null))),void this._taskQueue.delete(T);const R=C.getDataRange([c]);if(x=m.createDecodingTask(R),!x||x.tasks.length)if(n!==null&&this.flushQueues(n),this.entireBuffer)E(null,this.entireBuffer.slice(R.firstByte,R.lastByte+1));else{const z=Object.assign({},this.requestParams,{headers:{Range:"bytes=".concat(R.firstByte,"-").concat(R.lastByte)}}),N=s.bt(z,E);if(n!==null){const k=this._fetchQueuePerLayer.get(n)||[];k.push((()=>{N.cancel(),x.cancel()})),this._fetchQueuePerLayer.has(n)||this._fetchQueuePerLayer.set(n,k)}}}updateNeeded(t,n){return(!this.textureDescriptorPerLayer.get(t)||this.textureDescriptorPerLayer.get(t).band!==n||this.refreshedUponExpiration)&&this.state!=="errored"}updateTextureDescriptor(t,n,c){if(!this._mrt)return;const d=this._mrt.getLayer(t);if(!d||!d.hasBand(c)||!d.hasDataForBand(c))return;const{bytes:p,tileSize:m,buffer:y,offset:x,scale:T}=d.getBandView(c),S=m+2*y,M=new s.q({width:S,height:S},p),E=this.texturePerLayer.get(n);E&&E instanceof s.T&&E.update(M,{premultiply:!1}),this.textureDescriptorPerLayer.set(n,{layer:t,band:c,img:M,buffer:y,offset:x,tileSize:m,format:d.pixelFormat,mix:[T,256*T,65536*T,16777216*T]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(const n of this.texturePerLayer.values())n&&n instanceof s.T&&n.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class sh{constructor(t,n){this.max=t,this.onRemove=n,this.reset()}reset(){for(const t in this.data)for(const n of this.data[t])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(t,n,c){const d=t.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);const p={value:n,timeout:void 0};if(c!==void 0&&(p.timeout=setTimeout((()=>{this.remove(t,p)}),c)),this.data[d].push(p),this.order.push(d),this.order.length>this.max){const m=this._getAndRemoveByKey(this.order[0]);m&&this.onRemove(m)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const n=this.data[t].shift();return n.timeout&&clearTimeout(n.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),n.value}getByKey(t){const n=this.data[t];return n?n[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,n){if(!this.has(t))return this;const c=t.wrapped().key,d=n===void 0?0:this.data[c].indexOf(n),p=this.data[c][d];return this.data[c].splice(d,1),p.timeout&&clearTimeout(p.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(p.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(t){const n=[];for(const c in this.data)for(const d of this.data[c])t(d.value)||n.push(d);for(const c of n)this.remove(c.value.tileID,c)}}class xf{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,n,c){const d=String(n);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][d]=this.stateChanges[t][d]||{},Object.assign(this.stateChanges[t][d],c),this.deletedStates[t]===null){this.deletedStates[t]={};for(const p in this.state[t])p!==d&&(this.deletedStates[t][p]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][d]===null){this.deletedStates[t][d]={};for(const p in this.state[t][d])c[p]||(this.deletedStates[t][d][p]=null)}else for(const p in c)this.deletedStates[t]&&this.deletedStates[t][d]&&this.deletedStates[t][d][p]===null&&delete this.deletedStates[t][d][p]}removeFeatureState(t,n,c){if(this.deletedStates[t]===null)return;const d=String(n);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&n!==void 0)this.deletedStates[t][d]!==null&&(this.deletedStates[t][d]=this.deletedStates[t][d]||{},this.deletedStates[t][d][c]=null);else if(n!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][d])for(c in this.deletedStates[t][d]={},this.stateChanges[t][d])this.deletedStates[t][d][c]=null;else this.deletedStates[t][d]=null;else this.deletedStates[t]=null}getState(t,n){const c=this.state[t]||{},d=this.stateChanges[t]||{},p=this.deletedStates[t];if(p===null)return{};if(n!==void 0){const y=String(n),x=Object.assign({},c[y],d[y]);if(p){const T=p[n];if(T===null)return{};for(const S in T)delete x[S]}return x}const m=Object.assign({},c,d);if(p)for(const y in p)delete m[y];return m}initializeTileState(t,n){t.refreshFeatureState(n)}coalesceChanges(t,n){const c={};for(const d in this.stateChanges){this.state[d]=this.state[d]||{};const p={};for(const m in this.stateChanges[d])this.state[d][m]||(this.state[d][m]={}),Object.assign(this.state[d][m],this.stateChanges[d][m]),p[m]=this.state[d][m];c[d]=p}for(const d in this.deletedStates){this.state[d]=this.state[d]||{};const p={};if(this.deletedStates[d]===null)for(const m in this.state[d])p[m]={},this.state[d][m]={};else for(const m in this.deletedStates[d]){if(this.deletedStates[d][m]===null)this.state[d][m]={};else if(this.state[d][m])for(const y of Object.keys(this.deletedStates[d][m]))delete this.state[d][m][y];p[m]=this.state[d][m]}c[d]=c[d]||{},Object.assign(c[d],p)}if(this.stateChanges={},this.deletedStates={},Object.keys(c).length!==0)for(const d in t)t[d].refreshFeatureState(n)}}class Qo extends s.E{constructor(t,n,c){super(),this.id=t,this._onlySymbols=c,n.on("data",(d=>{d.dataType==="source"&&d.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&d.dataType==="source"&&d.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))})),n.on("error",(()=>{this._sourceErrored=!0})),this._source=n,this._tiles={},this._cache=new sh(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=n.minTileCacheSize,this._maxTileCacheSize=n.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new xf,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,n){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,n)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const c=this._tiles[n];c.upload(t,this.map?this.map.painter:void 0),c.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map((t=>t.tileID)).sort(ah).map((t=>t.key))}getRenderableIds(t,n){const c=[];for(const d in this._tiles)this._isIdRenderable(+d,t,n)&&c.push(this._tiles[d]);return t?c.sort(((d,p)=>{const m=d.tileID,y=p.tileID,x=new s.P(m.canonical.x,m.canonical.y)._rotate(this.transform.angle),T=new s.P(y.canonical.x,y.canonical.y)._rotate(this.transform.angle);return m.overscaledZ-y.overscaledZ||T.y-x.y||T.x-x.x})).map((d=>d.tileID.key)):c.map((d=>d.tileID)).sort(ah).map((d=>d.key))}hasRenderableParent(t){const n=this.findLoadedParent(t,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(t,n,c){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(n||!this._tiles[t].holdingForFade())&&(c||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,n){const c=this._tiles[t];c&&(c.state!=="loading"&&(c.state=n),this._loadTile(c,this._tileLoaded.bind(this,c,t,n)))}_tileLoaded(t,n,c,d,p){if(d){if(t.state="errored",d.status!==404)this._source.fire(new s.y(d,{tile:t}));else{if(this._source.fire(new s.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const y=this.map.painter.terrain;this.update(this.transform,y.getScaledDemTileSize(),!0),y.resetTileLookupCache(this.id)}else this.update(this.transform)}return}t.timeAdded=s.o.now(),c==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(n,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null);let m=new Map;p&&p.responseHeaders&&(m=p.responseHeaders),this._source.fire(new s.z("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id,responseHeaders:m}))}_backfillDEM(t){const n=this.getRenderableIds();for(let d=0;d<n.length;d++){const p=n[d];if(t.neighboringTiles&&t.neighboringTiles[p]){const m=this.getTileByID(p);c(t,m),c(m,t)}}function c(d,p){if(!d.dem||d.dem.borderReady)return;d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0;let m=p.tileID.canonical.x-d.tileID.canonical.x;const y=p.tileID.canonical.y-d.tileID.canonical.y,x=Math.pow(2,d.tileID.canonical.z),T=p.tileID.key;m===0&&y===0||Math.abs(y)>1||(Math.abs(m)>1&&(Math.abs(m+x)===1?m+=x:Math.abs(m-x)===1&&(m-=x)),p.dem&&d.dem&&(d.dem.backfillBorder(p.dem,m,y),d.neighboringTiles&&d.neighboringTiles[T]&&(d.neighboringTiles[T].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,n,c,d){for(const p in this._tiles){let m=this._tiles[p];if(d[p]||!m.hasData()||m.tileID.overscaledZ<=n||m.tileID.overscaledZ>c)continue;let y=m.tileID;for(;m&&m.tileID.overscaledZ>n+1;){const T=m.tileID.scaledTo(m.tileID.overscaledZ-1);m=this._tiles[T.key],m&&m.hasData()&&(y=T)}let x=y;for(;x.overscaledZ>n;)if(x=x.scaledTo(x.overscaledZ-1),t[x.key]){d[y.key]=y;break}}}findLoadedParent(t,n){if(t.key in this._loadedParentTiles){const c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=n?c:null}for(let c=t.overscaledZ-1;c>=n;c--){const d=t.scaledTo(c),p=this._getLoadedTile(d);if(p)return p}}_getLoadedTile(t){const n=this._tiles[t.key];return n&&n.hasData()?n:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,n){n=n||this._source.tileSize;const c=Math.ceil(t.width/n)+1,d=Math.ceil(t.height/n)+1,p=Math.floor(c*d*5),m=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,p):p,y=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,m):m;this._cache.setMaxSize(y)}handleWrapJump(t){const n=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,n){const c={};for(const d in this._tiles){const p=this._tiles[d];p.tileID=p.tileID.unwrapTo(p.tileID.wrap+n),c[p.tileID.key]=p}this._tiles=c;for(const d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(const d in this._tiles)this._setTileReloadTimer(+d,this._tiles[d])}}update(t,n,c,d,p){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!c)return;this.updateCacheSize(t,n),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const m=this._source.type==="batched-model";let y,x=this._source.maxzoom;const T=this.map&&this.map.painter?this.map.painter._terrain:null;if(T&&T.sourceCache===this&&T.attenuationRange()){const E=T.attenuationRange()[0],C=Math.floor(E)-Math.log2(T.getDemUpscale());x>C&&(x=C)}if(this.used||this.usedForTerrain){if(this._source.tileID)y=t.getVisibleUnwrappedCoordinates(this._source.tileID).map((E=>new s.aP(E.canonical.z,E.wrap,E.canonical.z,E.canonical.x,E.canonical.y)));else if(this.tileCoverLift!==0){const E=t.clone();E.tileCoverLift=this.tileCoverLift,y=E.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:x,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:m}),this._source.minzoom<=1&&t.projection.name==="globe"&&(y.push(new s.aP(1,0,1,0,0)),y.push(new s.aP(1,0,1,1,0)),y.push(new s.aP(1,0,1,0,1)),y.push(new s.aP(1,0,1,1,1)))}else if(y=t.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:x,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:m}),this._source.hasTile){const E=this._source.hasTile.bind(this._source);y=y.filter((C=>E(C)))}}else y=[];if(y.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!_a(this._source.type)){const E=t.coveringZoomLevel({tileSize:n||this._source.tileSize,roundZoom:this._source.roundZoom&&!c}),C=Math.min(E,this._source.maxzoom);if(m){const R=t.extendTileCover(y,C);for(const z of R)y.push(z)}else if(p){const R=t.extendTileCoverToNearPlane(y,this.transform.getFrustum(C),C);for(const z of R)y.push(z)}else if(this.castsShadows&&d){const R=t.extendTileCover(y,C,d);for(const z of R)this._shadowCasterTiles[z.key]=!0,y.push(z)}}const S=this._updateRetainedTiles(y);if(_a(this._source.type)&&y.length!==0){const E={},C={},R=Object.keys(S);for(const N of R){const k=S[N],U=this._tiles[N];if(!U||U.fadeEndTime&&U.fadeEndTime<=s.o.now())continue;const $=this.findLoadedParent(k,Math.max(k.overscaledZ-Qo.maxOverzooming,this._source.minzoom));$&&(this._addTile($.tileID),E[$.tileID.key]=$.tileID),C[N]=k}const z=y[y.length-1].overscaledZ;for(const N in this._tiles){const k=this._tiles[N];if(S[N]||!k.hasData())continue;let U=k.tileID;for(;U.overscaledZ>z;){U=U.scaledTo(U.overscaledZ-1);const $=this._tiles[U.key];if($&&$.hasData()&&C[U.key]){S[N]=k.tileID;break}}}for(const N in E)S[N]||(this._coveredTiles[N]=!0,S[N]=E[N])}for(const E in S)this._tiles[E].clearFadeHold();const M=s.bu(this._tiles,S);for(const E of M){const C=this._tiles[E];C.hasSymbolBuckets&&!C.holdingForFade()?C.setHoldDuration(this.map._fadeDuration):C.hasSymbolBuckets&&!C.symbolFadeFinished()||this._removeTile(+E)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const n={};if(t.length===0)return n;const c={},d=t.reduce(((T,S)=>Math.min(T,S.overscaledZ)),1/0),p=t[0].overscaledZ,m=Math.max(p-Qo.maxOverzooming,this._source.minzoom),y=Math.max(p+Qo.maxUnderzooming,this._source.minzoom),x={};for(const T of t){const S=this._addTile(T);n[T.key]=T,S.hasData()||d<this._source.maxzoom&&(x[T.key]=T)}this._retainLoadedChildren(x,d,y,n);for(const T of t){let S=this._tiles[T.key];if(S.hasData())continue;if(T.canonical.z>=this._source.maxzoom){const E=T.children(this._source.maxzoom)[0],C=this.getTile(E);if(C&&C.hasData()){n[E.key]=E;continue}}else{const E=T.children(this._source.maxzoom);if(n[E[0].key]&&n[E[1].key]&&n[E[2].key]&&n[E[3].key])continue}let M=S.wasRequested();for(let E=T.overscaledZ-1;E>=m;--E){const C=T.scaledTo(E);if(c[C.key]||(c[C.key]=!0,S=this.getTile(C),!S&&M&&(S=this._addTile(C)),S&&(n[C.key]=C,M=S.wasRequested(),S.hasData())))break}}return n}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const n=[];let c,d=this._tiles[t].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){c=this._loadedParentTiles[d.key];break}n.push(d.key);const p=d.scaledTo(d.overscaledZ-1);if(c=this._getLoadedTile(p),c)break;d=p}for(const p of n)this._loadedParentTiles[p]=c}}_addTile(t){let n=this._tiles[t.key];if(n)return n.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),n;n=this._cache.getAndRemove(t),n&&(this._setTileReloadTimer(t.key,n),n.tileID=t,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,n)));const c=!!n;if(!c){const d=this.map?this.map.painter:null,p=this._source.tileSize*t.overscaleFactor();n=this._source.type==="raster-array"?new Ys(t,p,this.transform.tileZoom,d,this._isRaster):new bs(t,p,this.transform.tileZoom,d,this._isRaster,this._source.worldview),this._loadTile(n,this._tileLoaded.bind(this,n,t.key,n.state))}return n.uses++,this._tiles[t.key]=n,c||this._source.fire(new s.z("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n}_setTileReloadTimer(t,n){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const c=n.getExpiryTimeout();c&&(this._timers[t]=setTimeout((()=>{this._reloadTile(t,"expired"),delete this._timers[t]}),c))}_removeTile(t){const n=this._tiles[t];n&&(n.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),n.uses>0||(n.hasData()&&n.state!=="reloading"||n.state==="empty"?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,n,c){const d=[],p=this.transform;if(!p)return d;const m=p.projection.name==="globe",y=s.aF(p.center.lng);for(const x in this._tiles){const T=this._tiles[x];if(c&&T.clearQueryDebugViz(),T.holdingForFade())continue;let S;if(m){const M=T.tileID.canonical;if(M.z===0){const E=[Math.abs(s.aA(y,...ga(M,-1))-y),Math.abs(s.aA(y,...ga(M,1))-y)];S=[0,2*E.indexOf(Math.min(...E))-1]}else{const E=[Math.abs(s.aA(y,...ga(M,-1))-y),Math.abs(s.aA(y,...ga(M,0))-y),Math.abs(s.aA(y,...ga(M,1))-y)];S=[E.indexOf(Math.min(...E))-1]}}else S=[0];for(const M of S){const E=t.containsTile(T,p,n,M);E&&d.push(E)}}return d}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,n){const c=this.getRenderableIds(t,n).map((p=>this._tiles[p].tileID)),d=this.transform.projection.name==="globe";for(const p of c)p.projMatrix=this.transform.calculateProjMatrix(p.toUnwrapped()),p.expandedProjMatrix=d?this.transform.calculateProjMatrix(p.toUnwrapped(),!1,!0):p.projMatrix;return c}sortCoordinatesByDistance(t){const n=t.slice(),c=this.transform._camera.position,d=this.transform._camera.forward(),p={};for(const m of n){const y=1/(1<<m.canonical.z);p[m.key]=((m.canonical.x+.5)*y+m.wrap-c[0])*d[0]+((m.canonical.y+.5)*y-c[1])*d[1]-c[2]*d[2]}return n.sort(((m,y)=>p[m.key]-p[y.key])),n}hasTransition(){if(this._source.hasTransition())return!0;if(_a(this._source.type))for(const t in this._tiles){const n=this._tiles[t];if(n.fadeEndTime!==void 0&&n.fadeEndTime>=s.o.now())return!0}return!1}setFeatureState(t,n,c){this._state.updateState(t=t||"_geojsonTileLayer",n,c)}removeFeatureState(t,n,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",n,c)}getFeatureState(t,n){return this._state.getState(t=t||"_geojsonTileLayer",n)}setDependencies(t,n,c){const d=this._tiles[t];d&&d.setDependencies(n,c)}reloadTilesForDependencies(t,n){for(const c in this._tiles)this._tiles[c].hasDependency(t,n)&&this._reloadTile(+c,"reloading");this._cache.filter((c=>!c.hasDependency(t,n)))}_preloadTiles(t,n){if(!this._sourceLoaded){const x=()=>{this._sourceLoaded&&(this._source.off("data",x),this._preloadTiles(t,n))};return void this._source.on("data",x)}const c=new Map,d=Array.isArray(t)?t:[t],p=this.map.painter.terrain,m=this.usedForTerrain&&p?p.getScaledDemTileSize():this._source.tileSize;for(const x of d){const T=x.coveringTiles({tileSize:m,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const S of T)c.set(S.key,S);this.usedForTerrain&&x.updateElevation(!1)}const y=Array.from(c.values());s.bv(y,((x,T)=>{const S=new bs(x,this._source.tileSize*x.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(S,(M=>{this._source.type==="raster-dem"&&S.dem&&this._backfillDEM(S),T(M,S)}))}),n)}}function ah(l,t){const n=Math.abs(2*l.wrap)-+(l.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return l.overscaledZ-t.overscaledZ||c-n||t.canonical.y-l.canonical.y||t.canonical.x-l.canonical.x}function _a(l){return l==="raster"||l==="image"||l==="video"||l==="custom"}function ga(l,t){const n=1<<l.z;return[l.x/n+t,(l.x+1)/n+t]}Qo.maxOverzooming=10,Qo.maxUnderzooming=3;class lh{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const t=!1,n=!1;for(const c in this.style._mergedLayers){const d=this.style._mergedLayers[c];if(d.type==="fill-extrusion"||d.type==="building")this.layers.push({layer:d,visible:t,visibilityChanged:n});else if(d.type==="model"){const p=this.style.getLayerSource(d);p&&p.type==="batched-model"&&this.layers.push({layer:d,visible:t,visibilityChanged:n})}}}onNewFrame(t){this.layersGotHidden=!1;for(const n of this.layers){const c=n.layer;let d=!1;c.type==="fill-extrusion"?d=!c.isHidden(t)&&c.paint.get("fill-extrusion-opacity")>0:c.type==="building"?d=!c.isHidden(t)&&c.paint.get("building-opacity")>0:c.type==="model"&&(d=!c.isHidden(t)&&c.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!d&&n.visible,n.visible=d}}updateZOffset(t,n){this.currentBuildingBuckets=[];for(const d of this.layers){const p=d.layer,m=this.style.getLayerSourceCache(p);let y=1;p.type==="fill-extrusion"?y=d.visible?p.paint.get("fill-extrusion-vertical-scale"):0:p.type==="building"&&(y=d.visible?p.paint.get("building-vertical-scale"):0);let x=m?m.getTile(n):null;if(!x&&m)for(const T in m._tiles){const S=m._tiles[T];if(n.canonical.isChildOf(S.tileID.canonical)){x=S;break}}this.currentBuildingBuckets.push({bucket:x?x.getBucket(p):null,tileID:x?x.tileID:n,verticalScale:y})}t.hasAnyZOffset=!1;let c=!1;for(let d=0;d<t.symbolInstances.length;d++){const p=t.symbolInstances.get(d),m=p.zOffset,y=this._getHeightAtTileOffset(n,p.tileAnchorX,p.tileAnchorY);p.zOffset=y!==Number.NEGATIVE_INFINITY?y:m,c||m===p.zOffset||(c=!0),t.hasAnyZOffset||p.zOffset===0||(t.hasAnyZOffset=!0)}c&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,n,c,d){let p=n,m=c;if(t.canonical.z!==d.canonical.z){const y=d.canonical,x=1/(1<<t.canonical.z-y.z);p=(n+t.canonical.x*s.al)*x-y.x*s.al|0,m=(c+t.canonical.y*s.al)*x-y.y*s.al|0}return{tileX:p,tileY:m}}_getHeightAtTileOffset(t,n,c){let d,p;for(let m=0;m<this.layers.length;++m){const y=this.layers[m].layer;if(y.type!=="fill-extrusion"&&y.type!=="building")continue;const{bucket:x,tileID:T,verticalScale:S}=this.currentBuildingBuckets[m];if(!x)continue;const{tileX:M,tileY:E}=this._mapCoordToOverlappingTile(t,n,c,T),C=x.getHeightAtTileCoord(M,E);C&&C.height!==void 0&&(C.hidden?d=C.height:p=Math.max(C.height*S,p||0))}if(p!==void 0)return p;for(let m=0;m<this.layers.length;++m){const y=this.layers[m];if(y.layer.type!=="model"||!y.visible)continue;const{bucket:x,tileID:T}=this.currentBuildingBuckets[m];if(!x)continue;const{tileX:S,tileY:M}=this._mapCoordToOverlappingTile(t,n,c,T),E=x.getHeightAtTileCoord(S,M);if(E&&!E.hidden)return E.height===void 0&&d!==void 0?Math.min(E.maxHeight,d)*E.verticalScale:E.height?E.height*E.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Ol(l,t){const n={};for(const c in l)c!=="ref"&&(n[c]=l[c]);return s.bw.forEach((c=>{c in t&&(n[c]=t[c])})),n}function Na(l){l=l.slice();const t=Object.create(null);for(let n=0;n<l.length;n++)t[l[n].id]=l[n];for(let n=0;n<l.length;n++)"ref"in l[n]&&(l[n]=Ol(l[n],t[l[n].ref]));return l}const Fi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function ch(l,t,n){n.push({command:Fi.addSource,args:[l,t[l]]})}function Fl(l,t,n){t.push({command:Fi.removeSource,args:[l]}),n[l]=!0}function kl(l,t,n,c){Fl(l,n,c),ch(l,t,n)}function uh(l,t,n){let c;for(c in l[n])if(l[n].hasOwnProperty(c)&&c!=="data"&&!s.bx(l[n][c],t[n][c]))return!1;for(c in t[n])if(t[n].hasOwnProperty(c)&&c!=="data"&&!s.bx(l[n][c],t[n][c]))return!1;return!0}function Bl(l,t,n,c,d,p){let m;for(m in t=t||{},l=l||{})l.hasOwnProperty(m)&&(s.bx(l[m],t[m])||n.push({command:p,args:[c,m,t[m],d]}));for(m in t)t.hasOwnProperty(m)&&!l.hasOwnProperty(m)&&(s.bx(l[m],t[m])||n.push({command:p,args:[c,m,t[m],d]}))}function Nl(l){return l.id}function Vl(l,t){return l[t.id]=t,l}function ya(l,t,n){const c=t.createTileMatrix(l,l.worldSize,n.toUnwrapped());return s.aB(new Float32Array(16),l.projMatrix,c)}function vf(l,t,n){if(t.projection.name===n.projection.name)return l.projMatrix;const c=n.clone();return c.setProjection(t.projection),ya(c,t.getProjection(),l)}function zc(l,t,n){return t.name===n.projection.name?l.projMatrix:ya(n,t,l)}class gm{constructor(t,n){this.reset(t,n)}reset(t,n){this.points=t||[],this._distances=[0];for(let c=1;c<this.points.length;c++)this._distances[c]=this._distances[c-1]+this.points[c].dist(this.points[c-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=s.aA(t,0,1);let n=1,c=this._distances[n];const d=t*this.paddedLength+this.padding;for(;c<d&&n<this._distances.length;)c=this._distances[++n];const p=n-1,m=this._distances[p],y=c-m,x=y>0?(d-m)/y:0;return this.points[p].mult(1-x).add(this.points[n].mult(x))}}class Ul{constructor(t,n,c){const d=this.boxCells=[],p=this.circleCells=[];this.xCellCount=Math.ceil(t/c),this.yCellCount=Math.ceil(n/c);for(let m=0;m<this.xCellCount*this.yCellCount;m++)d.push([]),p.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,n,c,d,p){this._forEachCell(n,c,d,p,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(n),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(p)}insertCircle(t,n,c,d){this._forEachCell(n-d,c-d,n+d,c+d,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(n),this.circles.push(c),this.circles.push(d)}_insertBoxCell(t,n,c,d,p,m){this.boxCells[p].push(m)}_insertCircleCell(t,n,c,d,p,m){this.circleCells[p].push(m)}_query(t,n,c,d,p,m){if(c<0||t>this.width||d<0||n>this.height)return!p&&[];const y=[];if(t<=0&&n<=0&&this.width<=c&&this.height<=d){if(p)return!0;for(let x=0;x<this.boxKeys.length;x++)y.push({key:this.boxKeys[x],x1:this.bboxes[4*x],y1:this.bboxes[4*x+1],x2:this.bboxes[4*x+2],y2:this.bboxes[4*x+3]});for(let x=0;x<this.circleKeys.length;x++){const T=this.circles[3*x],S=this.circles[3*x+1],M=this.circles[3*x+2];y.push({key:this.circleKeys[x],x1:T-M,y1:S-M,x2:T+M,y2:S+M})}return m?y.filter(m):y}return this._forEachCell(t,n,c,d,this._queryCell,y,{hitTest:p,seenUids:{box:{},circle:{}}},m),p?y.length>0:y}_queryCircle(t,n,c,d,p){const m=t-c,y=t+c,x=n-c,T=n+c;if(y<0||m>this.width||T<0||x>this.height)return!d&&[];const S=[];return this._forEachCell(m,x,y,T,this._queryCellCircle,S,{hitTest:d,circle:{x:t,y:n,radius:c},seenUids:{box:{},circle:{}}},p),d?S.length>0:S}query(t,n,c,d,p){return this._query(t,n,c,d,!1,p)}hitTest(t,n,c,d,p){return this._query(t,n,c,d,!0,p)}hitTestCircle(t,n,c,d){return this._queryCircle(t,n,c,!0,d)}_queryCell(t,n,c,d,p,m,y,x){const T=y.seenUids,S=this.boxCells[p];if(S!==null){const E=this.bboxes;for(const C of S)if(!T.box[C]){T.box[C]=!0;const R=4*C;if(t<=E[R+2]&&n<=E[R+3]&&c>=E[R+0]&&d>=E[R+1]&&(!x||x(this.boxKeys[C]))){if(y.hitTest)return m.push(!0),!0;m.push({key:this.boxKeys[C],x1:E[R],y1:E[R+1],x2:E[R+2],y2:E[R+3]})}}}const M=this.circleCells[p];if(M!==null){const E=this.circles;for(const C of M)if(!T.circle[C]){T.circle[C]=!0;const R=3*C;if(this._circleAndRectCollide(E[R],E[R+1],E[R+2],t,n,c,d)&&(!x||x(this.circleKeys[C]))){if(y.hitTest)return m.push(!0),!0;{const z=E[R],N=E[R+1],k=E[R+2];m.push({key:this.circleKeys[C],x1:z-k,y1:N-k,x2:z+k,y2:N+k})}}}}}_queryCellCircle(t,n,c,d,p,m,y,x){const T=y.circle,S=y.seenUids,M=this.boxCells[p];if(M!==null){const C=this.bboxes;for(const R of M)if(!S.box[R]){S.box[R]=!0;const z=4*R;if(this._circleAndRectCollide(T.x,T.y,T.radius,C[z+0],C[z+1],C[z+2],C[z+3])&&(!x||x(this.boxKeys[R])))return m.push(!0),!0}}const E=this.circleCells[p];if(E!==null){const C=this.circles;for(const R of E)if(!S.circle[R]){S.circle[R]=!0;const z=3*R;if(this._circlesCollide(C[z],C[z+1],C[z+2],T.x,T.y,T.radius)&&(!x||x(this.circleKeys[R])))return m.push(!0),!0}}}_forEachCell(t,n,c,d,p,m,y,x){const T=this._convertToXCellCoord(t),S=this._convertToYCellCoord(n),M=this._convertToXCellCoord(c),E=this._convertToYCellCoord(d);for(let C=T;C<=M;C++)for(let R=S;R<=E;R++)if(p.call(this,t,n,c,d,this.xCellCount*R+C,m,y,x))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,n,c,d,p,m){const y=d-t,x=p-n,T=c+m;return T*T>y*y+x*x}_circleAndRectCollide(t,n,c,d,p,m,y){const x=(m-d)/2,T=Math.abs(t-(d+x));if(T>x+c)return!1;const S=(y-p)/2,M=Math.abs(n-(p+S));if(M>S+c)return!1;if(T<=x||M<=S)return!0;const E=T-x,C=M-S;return E*E+C*C<=c*c}}const Do={unknown:0,flipRequired:1,flipNotRequired:2},jl=Math.tan(85*Math.PI/180);function Va(l,t,n,c,d,p,m){const y=s.bB();if(n)if(p.name==="globe"){const x=s.bC(d,t);s.aB(y,y,x)}else{const x=s.bD([],m);y[0]=x[0],y[1]=x[1],y[4]=x[2],y[5]=x[3],c||s.bA(y,y,d.angle)}else s.aB(y,d.labelPlaneMatrix,l);return y}function Gl(l,t,n,c,d,p,m){const y=Va(l,t,n,c,d,p,m);return p.name==="globe"&&n||(y[2]=y[6]=y[10]=y[14]=0),y}function Ds(l,t,n,c,d,p,m){if(n){if(p.name==="globe"){const y=Va(l,t,n,c,d,p,m);return s.bk(y,y),s.aB(y,l,y),y}{const y=s.by(l),x=s.bz([]);return x[0]=m[0],x[1]=m[1],x[4]=m[2],x[5]=m[3],s.aB(y,y,x),c||s.bA(y,y,-d.angle),y}}return d.glCoordMatrix}function hn(l,t,n,c){const d=[l,t,n,1];n?s.aC(d,d,c):es(d,d,c);const p=d[3];return d[0]/=p,d[1]/=p,d[2]/=p,d}function hh(l,t){return Math.min(.5+l/t*.5,1.5)}function dh(l,t){const n=l[0]/l[3],c=l[1]/l[3];return n>=-t[0]&&n<=t[0]&&c>=-t[1]&&c<=t[1]}function fh(l,t,n,c,d,p,m,y,x,T,S=1){const M=n.transform,E=c?l.textSizeData:l.iconSizeData,C=s.bJ(E,n.transform.zoom,S),R=M.projection.name==="globe",z=[256/n.width*2+1,256/n.height*2+1],N=c?l.text.dynamicLayoutVertexArray:l.icon.dynamicLayoutVertexArray;N.clear();let k=null;R&&(k=c?l.text.globeExtVertexArray:l.icon.globeExtVertexArray);const U=l.lineVertexArray,$=c?l.text.placedSymbolArray:l.icon.placedSymbolArray,G=n.transform.width/n.transform.height;let ee,Z=!1;for(let ie=0;ie<$.length;ie++){const Q=$.get(ie),{numGlyphs:Y,writingMode:re}=Q;if(re!==s.bK.vertical||Z||ee===s.bK.horizontal||(Z=!0),ee=re,(Q.hidden||re===s.bK.vertical)&&!Z){zs(Y,N);continue}Z=!1;const _e=new s.P(Q.tileAnchorX,Q.tileAnchorY),he=l.elevationType==="road",Ae=!!M.elevation||he;let{x:ve,y:ze,z:Xe}=M.projection.projectTilePoint(_e.x,_e.y,T.canonical),xe=null;if(Ae){const dt=he?l.getElevationFeatureForText(ie):null;xe={getElevation:x,elevation:M.elevation,elevationFeature:dt};const[Pt,li,pi]=x(_e,M.elevation,dt);ve+=Pt,ze+=li,Xe+=pi}const ce=[ve,ze,Xe,1];if(s.aC(ce,ce,t),!dh(ce,z)){zs(Y,N);continue}const Le=ce[3],be=hh(n.transform.getCameraToCenterDistance(M.projection),Le),Ve=s.bL(E,C,Q),Qe=m?Ve/be:Ve*be,mt=hn(ve,ze,Xe,d);if(mt[3]<=0){zs(Y,N);continue}let $e={};const Ke=s.an(l.layers[0].layout.get("text-max-angle")),gt=Math.cos(Ke),ht=m?null:xe,ct=bf(Q,Qe,!1,y,t,d,p,l.glyphOffsetArray,U,N,k,mt,_e,$e,G,ht,M.projection,T,m,gt);Z=ct.useVertical,ht&&ct.needsFlipping&&($e={}),(ct.notEnoughRoom||Z||ct.needsFlipping&&bf(Q,Qe,!0,y,t,d,p,l.glyphOffsetArray,U,N,k,mt,_e,$e,G,ht,M.projection,T,m,gt).notEnoughRoom)&&zs(Y,N)}c?(l.text.dynamicLayoutVertexBuffer.updateData(N),k&&l.text.globeExtVertexBuffer&&l.text.globeExtVertexBuffer.updateData(k)):(l.icon.dynamicLayoutVertexBuffer.updateData(N),k&&l.icon.globeExtVertexBuffer&&l.icon.globeExtVertexBuffer.updateData(k))}function Ui(l,t,n,c,d,p,m,y,x,T,S,M,E,C,R,z,N){const{lineStartIndex:k,glyphStartIndex:U,segment:$}=y,G=U+y.numGlyphs,ee=k+y.lineLength,Z=t.getoffsetX(U),ie=t.getoffsetX(G-1),Q=Hl(l*Z,n,c,d,p,m,$,k,ee,x,T,S,M,E,!0,C,R,z,N);if(!Q)return null;const Y=Hl(l*ie,n,c,d,p,m,$,k,ee,x,T,S,M,E,!0,C,R,z,N);return Y?{first:Q,last:Y}:null}function ph(l,t,n,c){return l===s.bK.horizontal&&Math.abs(c)>Math.abs(n)?{useVertical:!0}:l===s.bK.vertical?c>0?{needsFlipping:!0}:null:t!==Do.unknown&&(function(d,p){return d===0||Math.abs(p/d)>jl})(n,c)?t===Do.flipRequired?{needsFlipping:!0}:null:n<0?{needsFlipping:!0}:null}function bf(l,t,n,c,d,p,m,y,x,T,S,M,E,C,R,z,N,k,U,$){const G=t/24,ee=l.lineOffsetX*G,Z=l.lineOffsetY*G,{lineStartIndex:ie,glyphStartIndex:Q,numGlyphs:Y,segment:re,writingMode:_e,flipState:he}=l,Ae=ie+l.lineLength,ve=ze=>{if(S){const[Le,be,Ve]=ze.up,Qe=T.length;s.bM(S,Qe+0,Le,be,Ve),s.bM(S,Qe+1,Le,be,Ve),s.bM(S,Qe+2,Le,be,Ve),s.bM(S,Qe+3,Le,be,Ve)}const[Xe,xe,ce]=ze.point;s.bN(T,Xe,xe,ce,ze.angle)};if(Y>1){const ze=Ui(G,y,ee,Z,n,M,E,l,x,p,C,z,!1,N,k,U,$);if(!ze)return{notEnoughRoom:!0};if(c&&!n){let[Xe,xe,ce]=ze.first.point,[Le,be,Ve]=ze.last.point;[Xe,xe]=hn(Xe,xe,ce,m),[Le,be]=hn(Le,be,Ve,m);const Qe=ph(_e,he,(Le-Xe)*R,be-xe);if(l.flipState=Qe&&Qe.needsFlipping?Do.flipRequired:Do.flipNotRequired,Qe)return Qe}ve(ze.first);for(let Xe=Q+1;Xe<Q+Y-1;Xe++){const xe=Hl(G*y.getoffsetX(Xe),ee,Z,n,M,E,re,ie,Ae,x,p,C,z,!1,!1,N,k,U,$);if(!xe)return T.length-=4*(Xe-Q),{notEnoughRoom:!0};ve(xe)}ve(ze.last)}else{if(c&&!n){const Xe=hn(E.x,E.y,0,d),xe=ie+re+1,ce=new s.P(x.getx(xe),x.gety(xe)),Le=hn(ce.x,ce.y,0,d),be=Le[3]>0?Le:Ft(E,ce,Xe,1,d,void 0,N,k.canonical),Ve=ph(_e,he,(be[0]-Xe[0])*R,be[1]-Xe[1]);if(l.flipState=Ve&&Ve.needsFlipping?Do.flipRequired:Do.flipNotRequired,Ve)return Ve}const ze=Hl(G*y.getoffsetX(Q),ee,Z,n,M,E,re,ie,Ae,x,p,C,z,!1,!1,N,k,U,$);if(!ze)return{notEnoughRoom:!0};ve(ze)}return{}}function wf(l,t,n,c,d){const{x:p,y:m,z:y}=c.projectTilePoint(l.x,l.y,t);if(!d)return hn(p,m,y,n);const[x,T,S]=d.getElevation(l,d.elevation,d.elevationFeature);return hn(p+x,m+T,y+S,n)}function Ft(l,t,n,c,d,p,m,y){const x=wf(l.sub(t)._unit()._add(l),y,d,m,p);return s.av(x,n,x),s.aw(x,x),s.bG(x,n,x,c)}function Hl(l,t,n,c,d,p,m,y,x,T,S,M,E,C,R,z,N,k,U){const $=c?l-t:l+t;let G=$>0?1:-1,ee=0;c&&(G*=-1,ee=Math.PI),G<0&&(ee+=Math.PI);let Z=y+m+(G>0?0:1)|0,ie=d,Q=d,Y=0,re=0;const _e=Math.abs($),he=[],Ae=[];let ve=p,ze=ve,Xe=s.bE([]);const xe=()=>Ft(ze,ve,Q,_e-Y+1,S,E,z,N.canonical);for(;Y+re<=_e;){if(Z+=G,Z<y||Z>=x)return null;if(Q=ie,ze=ve,he.push(Q),C&&Ae.push(ze),ve=new s.P(T.getx(Z),T.gety(Z)),ie=M[Z],!ie){const ht=wf(ve,N.canonical,S,z,E);ie=ht[3]>0?M[Z]=ht:xe()}Y+=re;const Ke=s.av([],ie,Q),gt=s.bF(Q,ie);if(n&&gt>0&&re>0&&s.bI(Xe,Ke)/(re*gt)<U)return null;re=gt,Xe=Ke}R&&E&&(M[Z]&&(ie=xe(),re=s.bF(Q,ie),Xe=s.av([],ie,Q)),M[Z]=ie);const ce=(_e-Y)/re,Le=ve.sub(ze)._mult(ce)._add(ze),be=s.bG([],Q,Xe,ce);let Ve=[0,0,1],Qe=Xe[0],mt=Xe[1];if(k&&(Ve=z.upVector(N.canonical,Le.x,Le.y),Ve[0]!==0||Ve[1]!==0||Ve[2]!==1)){const Ke=[Ve[2],0,-Ve[0]],gt=s.bH([],Ve,Ke);s.aw(Ke,Ke),s.aw(gt,gt),Qe=s.bI(Xe,Ke),mt=s.bI(Xe,gt)}if(n){const Ke=s.bH([],Ve,Xe);s.aw(Ke,Ke),s.bG(be,be,Ke,n*G)}const $e=ee+Math.atan2(mt,Qe);return he.push(be),C&&Ae.push(Le),{point:be,angle:$e,path:he,tilePath:Ae,up:Ve}}function zs(l,t){const n=t.length,c=n+4*l;t.resize(c),t.float32.fill(-1/0,4*n,4*c)}function es(l,t,n){const c=t[0],d=t[1];return l[0]=n[0]*c+n[4]*d+n[12],l[1]=n[1]*c+n[5]*d+n[13],l[3]=n[3]*c+n[7]*d+n[15],l}const ts=100;class Ua{constructor(t,n,c=new Ul(t.width+200,t.height+200,25),d=new Ul(t.width+200,t.height+200,25)){this.transform=t,this.grid=c,this.ignoredGrid=d,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+ts,this.screenBottomBoundary=t.height+ts,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=n}placeCollisionBox(t,n,c,d,p,m,y,x,T,S,M){let E=c.projectedAnchorX,C=c.projectedAnchorY,R=c.projectedAnchorZ;const z=c.tileAnchorX,N=c.tileAnchorY,k=c.elevation,U=c.tileID,$=t.getProjection();if(k&&U){const[Ae,ve,ze]=$.upVector(U.canonical,c.tileAnchorX,c.tileAnchorY),Xe=$.upVectorScale(U.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;E+=Ae*k*Xe,C+=ve*k*Xe,R+=ze*k*Xe}const G=t.projection.name==="globe",ee=t.projection.name==="globe"?s.aj(this.transform.zoom):0;if(U&&G&&ee<1&&!m){const Ae=1<<U.canonical.z,ve=s.bO(z,N);s.bP(ve,ve,1/s.al),s.bQ(ve,ve,s.bO(U.canonical.x,U.canonical.y)),s.bP(ve,ve,1/Ae),s.bR(ve,ve,s.bO(d[0],d[1])),ve[0]=s.bS(ve[0],-.5,.5),s.bP(ve,ve,s.al);const ze=s.bT(ve[0],ve[1],s.al/(2*Math.PI),1);s.aC(ze,ze,p),E=s.ak(E,ze[0],ee),C=s.ak(C,ze[1],ee),R=s.ak(R,ze[2],ee)}const Z=this.projectAndGetPerspectiveRatio(S,E,C,R,c.tileID,$.name==="globe"||!!k||this.transform.pitch>0,$),ie=T*Z.perspectiveRatio,Q=(c.x1*n+y.x-c.padding)*ie+Z.point.x,Y=(c.y1*n+y.y-c.padding)*ie+Z.point.y,re=(c.x2*n+y.x+c.padding)*ie+Z.point.x,_e=(c.y2*n+y.y+c.padding)*ie+Z.point.y,he=Z.perspectiveRatio<=.55||Z.occluded;return!this.isInsideGrid(Q,Y,re,_e)||!x&&this.grid.hitTest(Q,Y,re,_e,M)||he?{box:[],offscreen:!1,occluded:Z.occluded}:{box:[Q,Y,re,_e],offscreen:this.isOffscreen(Q,Y,re,_e),occluded:!1}}placeCollisionCircles(t,n,c,d,p,m,y,x,T,S,M,E,C,R,z,N){const k=[],U=this.transform.elevation,$=t.getProjection(),G=t.elevationType==="road",ee=!!U||G,Z=s.bU.getAtTileOffsetFunc(N,this.transform.center.lat,this.transform.worldSize,$),ie=new s.P(c.tileAnchorX,c.tileAnchorY),Q=new s.P(c.tileAnchorX,c.tileAnchorY);let{x:Y,y:re,z:_e}=$.projectTilePoint(Q.x,Q.y,N.canonical),he=null;if(ee){const gt=G?t.getElevationFeatureForText(d):null;he={getElevation:Z,elevation:U,elevationFeature:gt};const[ht,ct,dt]=Z(ie,U,gt);Y+=ht,re+=ct,_e+=dt}const Ae=$.name==="globe",ve=this.projectAndGetPerspectiveRatio(x,Y,re,_e,N,Ae||!!U||this.transform.pitch>0,$),{perspectiveRatio:ze}=ve,Xe=(E?y/ze:y*ze)/s.bX,xe=hn(Y,re,_e,T),ce=c.lineOffsetX*Xe,Le=c.lineOffsetY*Xe,be=s.an(t.layers[0].layout.get("text-max-angle")),Ve=Math.cos(be),Qe=ve.signedDistanceFromCamera>0?Ui(Xe,m,ce,Le,G&&c.flipState===1,xe,Q,c,p,T,{},ee&&!E?he:null,E&&ee,$,N,E,Ve):null;let mt=!1,$e=!1,Ke=!0;if(Qe&&!ve.occluded){const gt=.5*R*ze+z,ht=new s.P(-100,-100),ct=new s.P(this.screenRightBoundary,this.screenBottomBoundary),dt=new gm,{first:Pt,last:li}=Qe,pi=Pt.path.length;let Yi=[];for(let Kt=pi-1;Kt>=1;Kt--)Yi.push(Pt.path[Kt]);for(let Kt=1;Kt<li.path.length;Kt++)Yi.push(li.path[Kt]);const Nt=2.5*gt;S&&(Yi=Yi.map((([Kt,qi,mi],ir)=>(ee&&!Ae&&(mi=Z(ir<pi-1?Pt.tilePath[pi-1-ir]:li.tilePath[ir-pi+2],U,he.elevationFeature)[2]),hn(Kt,qi,mi,S)))),Yi.some((Kt=>Kt[3]<=0))&&(Yi=[]));let fi=[];if(Yi.length>0){let Kt=1/0,qi=-1/0,mi=1/0,ir=-1/0;for(const Ii of Yi)Kt=Math.min(Kt,Ii[0]),mi=Math.min(mi,Ii[1]),qi=Math.max(qi,Ii[0]),ir=Math.max(ir,Ii[1]);qi>=ht.x&&Kt<=ct.x&&ir>=ht.y&&mi<=ct.y&&(fi=[Yi.map((Ii=>new s.P(Ii[0],Ii[1])))],(Kt<ht.x||qi>ct.x||mi<ht.y||ir>ct.y)&&(fi=s.bV(fi,ht.x,ht.y,ct.x,ct.y)))}for(const Kt of fi){dt.reset(Kt,.25*gt);let qi=0;qi=dt.length<=.5*gt?1:Math.ceil(dt.paddedLength/Nt)+1;for(let mi=0;mi<qi;mi++){const ir=mi/Math.max(qi-1,1),Ii=dt.lerp(ir),Qt=Ii.x+ts,ki=Ii.y+ts;k.push(Qt,ki,gt,0);const ri=Qt-gt,ur=ki-gt,Ni=Qt+gt,Ut=ki+gt;if(Ke=Ke&&this.isOffscreen(ri,ur,Ni,Ut),$e=$e||this.isInsideGrid(ri,ur,Ni,Ut),!n&&this.grid.hitTestCircle(Qt,ki,gt,C)&&(mt=!0,!M))return{circles:[],offscreen:!1,collisionDetected:mt,occluded:!1}}}}return{circles:!M&&mt||!$e?[]:k,offscreen:Ke,collisionDetected:mt,occluded:ve.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const n=[];let c=1/0,d=1/0,p=-1/0,m=-1/0;for(const S of t){const M=new s.P(S.x+ts,S.y+ts);c=Math.min(c,M.x),d=Math.min(d,M.y),p=Math.max(p,M.x),m=Math.max(m,M.y),n.push(M)}const y=this.grid.query(c,d,p,m).concat(this.ignoredGrid.query(c,d,p,m)),x={},T={};for(const S of y){const M=S.key;if(x[M.bucketInstanceId]===void 0&&(x[M.bucketInstanceId]={}),x[M.bucketInstanceId][M.featureIndex])continue;const E=[new s.P(S.x1,S.y1),new s.P(S.x2,S.y1),new s.P(S.x2,S.y2),new s.P(S.x1,S.y2)];s.bW(n,E)&&(x[M.bucketInstanceId][M.featureIndex]=!0,T[M.bucketInstanceId]===void 0&&(T[M.bucketInstanceId]=[]),T[M.bucketInstanceId].push(M.featureIndex))}return T}insertCollisionBox(t,n,c,d,p){(n?this.ignoredGrid:this.grid).insert({bucketInstanceId:c,featureIndex:d,collisionGroupID:p},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,n,c,d,p){const m=n?this.ignoredGrid:this.grid,y={bucketInstanceId:c,featureIndex:d,collisionGroupID:p};for(let x=0;x<t.length;x+=4)m.insertCircle(y,t[x],t[x+1],t[x+2])}projectAndGetPerspectiveRatio(t,n,c,d,p,m,y){const x=[n,c,d,1];let T=!1;d||this.transform.pitch>0?(s.aC(x,x,t),this.fogState&&p&&y.name!=="globe"&&(T=(function(E,C,R,z,N,k){const U=k.calculateFogTileMatrix(N),$=[C,R,z];return s.af($,$,U),We(E,s.ag($),k.pitch,k._fov)})(this.fogState,n,c,d,p.toUnwrapped(),this.transform)>.9)):es(x,x,t);const S=x[3];return{point:new s.P((x[0]/S+1)/2*this.transform.width+ts,(-x[1]/S+1)/2*this.transform.height+ts),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(y)/S*.5,1.5),signedDistanceFromCamera:S,occluded:m&&x[2]>S||T}}isOffscreen(t,n,c,d){return c<ts||t>=this.screenRightBoundary||d<ts||n>this.screenBottomBoundary}isInsideGrid(t,n,c,d){return c>=0&&t<this.gridRightBoundary&&d>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const t=s.bz([]);return s.bq(t,t,[-100,-100,0]),t}}class St{constructor(t,n,c,d){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?n:-n))):d&&c?1:0,this.placed=c}isHidden(){return this.opacity===0&&!this.placed}}class Ei{constructor(t,n,c,d,p,m=!1){this.text=new St(t?t.text:null,n,c,p),this.icon=new St(t?t.icon:null,n,d,p),this.clipped=m}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Bi{constructor(t,n,c,d=!1){this.text=t,this.icon=n,this.skipFade=c,this.clipped=d}}class So{constructor(){this.invProjMatrix=s.bB(),this.viewportMatrix=s.bB(),this.circles=[]}}class ja{constructor(t,n,c,d,p){this.bucketInstanceId=t,this.featureIndex=n,this.sourceLayerIndex=c,this.bucketIndex=d,this.tileID=p}}class Hi{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const n=++this.maxGroupID;this.collisionGroups[t]={ID:n,predicate:c=>c.collisionGroupID===n}}return this.collisionGroups[t]}}function ql(l,t,n,c,d){const{horizontalAlign:p,verticalAlign:m}=s.c0(l),y=-(p-.5)*t,x=-(m-.5)*n,T=s.c1(l,c);return new s.P(y+T[0]*d,x+T[1]*d)}function xa(l,t,n,c,d){const p=new s.P(l,t);return n&&p._rotate(c?d:-d),p}class $l{constructor(t,n,c,d,p,m){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new Ua(this.transform,p),this.buildingIndex=m,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=n,this.retainedQueryData={},this.collisionGroups=new Hi(c),this.collisionCircleArrays={},this.prevPlacement=d,d&&(d.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,n,c,d,p=1){const m=c.getBucket(n),y=c.latestFeatureIndex;if(!m||!y||n.fqid!==m.layerIds[0])return;const x=m.layers[0].layout,T=m.layers[0].paint,S=c.collisionBoxArray,M=Math.pow(2,this.transform.zoom-c.tileID.overscaledZ),E=c.tileSize/s.al,C=c.tileID.toUnwrapped();this.transform.setProjection(m.projection);const R=(z=c.tileID,N=m.getProjection(),k=this.transform,N.name===this.projection?k.calculateProjMatrix(z.toUnwrapped()):ya(k,N,z));var z,N,k;const U=x.get("text-pitch-alignment")==="map",$=x.get("text-rotation-alignment")==="map";n.compileFilter(n.options);const G=n.dynamicFilter(),ee=n.dynamicFilterNeedsFeature(),Z=this.transform.calculatePixelsToTileUnitsMatrix(c),ie=Gl(R,c.tileID.canonical,U,$,this.transform,m.getProjection(),Z);let Q=null;const Y=m.getProjection().createInversionMatrix(this.transform,c.tileID.canonical);if(U){const ce=Ds(R,c.tileID.canonical,U,$,this.transform,m.getProjection(),Z);Q=s.aB([],this.transform.labelPlaneMatrix,ce)}let re=null;G&&c.latestFeatureIndex&&(re={unwrappedTileID:C,dynamicFilter:G,dynamicFilterNeedsFeature:ee}),this.retainedQueryData[m.bucketInstanceId]=new ja(m.bucketInstanceId,y,m.sourceLayerIndex,m.index,c.tileID);const[_e,he]=m.layers[0].layout.get("text-size-scale-range"),Ae=s.aA(p,_e,he),[ve,ze]=x.get("icon-size-scale-range"),Xe=s.aA(p,ve,ze),xe={bucket:m,layout:x,paint:T,posMatrix:R,invMatrix:Y,mercatorCenter:[s.aF(this.transform.center.lng),s.aJ(this.transform.center.lat)],textLabelPlaneMatrix:ie,labelToScreenMatrix:Q,clippingData:re,scale:M,textPixelRatio:E,holdingForFade:c.holdingForFade(),collisionBoxArray:S,partiallyEvaluatedTextSize:s.bJ(m.textSizeData,this.transform.zoom,Ae),partiallyEvaluatedIconSize:s.bJ(m.iconSizeData,this.transform.zoom,Xe),collisionGroup:this.collisionGroups.get(m.sourceID),latestFeatureIndex:c.latestFeatureIndex};if(d)for(const ce of m.sortKeyRanges){const{sortKey:Le,symbolInstanceStart:be,symbolInstanceEnd:Ve}=ce;t.push({sortKey:Le,symbolInstanceStart:be,symbolInstanceEnd:Ve,parameters:xe})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:m.symbolInstances.length,parameters:xe})}attemptAnchorPlacement(t,n,c,d,p,m,y,x,T,S,M,E,C,R,z,N,k,U,$,G,ee){const{textOffset0:Z,textOffset1:ie,crossTileID:Q}=z,Y=[Z,ie],re=ql(t,m,y,Y,x),_e=this.collisionIndex.placeCollisionBox(k,x,n,c,d,p,xa(re.x,re.y,T,S,this.transform.angle),R,M,E,C.predicate);if($){const he=k.getSymbolInstanceIconSize(ee,this.transform.zoom,z.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(k,he,$,c,d,p,xa(re.x,re.y,T,S,this.transform.angle),R,M,E,C.predicate).box.length===0)return}if(_e.box.length>0){let he;return this.prevPlacement&&this.prevPlacement.variableOffsets[Q]&&this.prevPlacement.placements[Q]&&this.prevPlacement.placements[Q].text&&(he=this.prevPlacement.variableOffsets[Q].anchor),this.variableOffsets[Q]={textOffset:Y,width:m,height:y,anchor:t,textScale:x,prevAnchor:he},this.markUsedJustification(k,t,z,U),k.allowVerticalPlacement&&(this.markUsedOrientation(k,U,z),this.placedOrientations[Q]=U),{shift:re,placedGlyphBoxes:_e}}}placeLayerBucketPart(t,n,c,d,p=1){const{bucket:m,layout:y,paint:x,posMatrix:T,textLabelPlaneMatrix:S,labelToScreenMatrix:M,clippingData:E,textPixelRatio:C,mercatorCenter:R,invMatrix:z,holdingForFade:N,collisionBoxArray:k,partiallyEvaluatedTextSize:U,partiallyEvaluatedIconSize:$,collisionGroup:G,latestFeatureIndex:ee}=t.parameters,Z=y.get("text-optional"),ie=y.get("icon-optional"),Q=y.get("text-allow-overlap"),Y=y.get("icon-allow-overlap"),re=y.get("text-rotation-alignment")==="map",_e=y.get("icon-rotation-alignment")==="map",he=y.get("text-pitch-alignment")==="map",Ae=x.get("symbol-z-offset"),ve=y.get("symbol-elevation-reference")==="sea",ze=y.get("symbol-placement"),[Xe,xe]=y.get("text-size-scale-range"),[ce,Le]=y.get("icon-size-scale-range"),be=s.aA(p,Xe,xe),Ve=s.aA(p,ce,Le),Qe=y.get("text-variable-anchor"),mt=re&&ze!=="point",$e=_e&&ze!=="point",Ke=Qe&&m.hasTextData(),gt=m.hasIconTextFit()&&Ke&&m.hasIconData();this.transform.setProjection(m.projection);const ht=Ke||mt,ct=$e||gt;let dt=Q&&(Y||!m.hasIconData()||ie),Pt=Y&&(Q||!m.hasTextData()||Z);const li=!Ae.isConstant();!m.collisionArrays&&k&&m.deserializeCollisionBoxes(k),c&&d&&m.updateCollisionDebugBuffers(this.transform.zoom,k,be,Ve);const pi=(Nt,fi,Kt)=>{const{crossTileID:qi,numVerticalGlyphVertices:mi}=Nt;let ir=null;if(E&&E.dynamicFilterNeedsFeature||li){const Dr=this.retainedQueryData[m.bucketInstanceId];ir=ee.loadFeature({featureIndex:Nt.featureIndex,bucketIndex:Dr.bucketIndex,sourceLayerIndex:Dr.sourceLayerIndex,layoutVertexArrayOffset:0})}if(E&&!(0,E.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch,worldview:m.worldview},ir,this.retainedQueryData[m.bucketInstanceId].tileID.canonical,new s.P(Nt.tileAnchorX,Nt.tileAnchorY),this.transform.calculateDistanceTileData(E.unwrappedTileID)))return this.placements[qi]=new Bi(!1,!1,!1,!0),void n.add(qi);const Ii=Ae.evaluate(ir,{});if(n.has(qi))return;if(N)return void(this.placements[qi]=new Bi(!1,!1,!1));let Qt=!1,ki=!1,ri=!0,ur=!1,Ni=!1,Ut=null,gi={box:null,offscreen:null,occluded:null},wr={box:null},jr=null,Mr=null,Br=null,go=0,oo=0,Nn=0;Kt.textFeatureIndex?go=Kt.textFeatureIndex:Nt.useRuntimeCollisionCircles&&(go=Nt.featureIndex),Kt.verticalTextFeatureIndex&&(oo=Kt.verticalTextFeatureIndex);const Gn=m.elevationFeatures?m.elevationFeatures[Nt.elevationFeatureIndex]:void 0,ko=Dr=>{Dr.tileID=this.retainedQueryData[m.bucketInstanceId].tileID;const Gr=this.transform.elevation;Dr.elevation=ve?Ii:Ii+s.bU.getAtTileOffset(Dr.tileID,new s.P(Dr.tileAnchorX,Dr.tileAnchorY),Gr,Gn),Dr.elevation+=Nt.zOffset},Vn=Kt.textBox;if(Vn){ko(Vn);const Dr=er=>{let $r=s.bK.horizontal;if(m.allowVerticalPlacement&&!er&&this.prevPlacement){const Tn=this.prevPlacement.placedOrientations[qi];Tn&&(this.placedOrientations[qi]=Tn,$r=Tn,this.markUsedOrientation(m,$r,Nt))}return $r},Gr=(er,$r)=>{if(m.allowVerticalPlacement&&mi>0&&Kt.verticalTextBox){for(const Tn of m.writingModes)if(Tn===s.bK.vertical?(gi=$r(),wr=gi):gi=er(),gi&&gi.box&&gi.box.length)break}else gi=er()};if(Qe){let er=Qe;if(this.prevPlacement&&this.prevPlacement.variableOffsets[qi]){const zr=this.prevPlacement.variableOffsets[qi];er.indexOf(zr.anchor)>0&&(er=er.filter((No=>No!==zr.anchor)),er.unshift(zr.anchor))}const $r=(zr,No,xl)=>{const Gs=m.getSymbolInstanceTextSize(U,Nt,this.transform.zoom,fi),vl=(zr.x2-zr.x1)*Gs+2*zr.padding,bl=(zr.y2-zr.y1)*Gs+2*zr.padding,Vo=Nt.hasIconTextFit&&!Y?No:null;Vo&&ko(Vo);let As={box:[],offscreen:!1,occluded:!1};const gn=Q?2*er.length:er.length;for(let Uo=0;Uo<gn;++Uo){const za=this.attemptAnchorPlacement(er[Uo%er.length],zr,R,z,ht,vl,bl,Gs,re,he,C,T,G,Uo>=er.length,Nt,fi,m,xl,Vo,U,$);if(za&&(As=za.placedGlyphBoxes,As&&As.box&&As.box.length)){Qt=!0,Ut=za.shift;break}}return As};Gr((()=>$r(Vn,Kt.iconBox,s.bK.horizontal)),(()=>{const zr=Kt.verticalTextBox;return zr&&ko(zr),m.allowVerticalPlacement&&!(gi&&gi.box&&gi.box.length)&&mi>0&&zr?$r(zr,Kt.verticalIconBox,s.bK.vertical):{box:null,offscreen:null,occluded:null}})),gi&&(Qt=gi.box,ri=gi.offscreen,ur=gi.occluded);const Tn=Dr(!(!gi||!gi.box));if(!Qt&&this.prevPlacement){const zr=this.prevPlacement.variableOffsets[qi];zr&&(this.variableOffsets[qi]=zr,this.markUsedJustification(m,zr.anchor,Nt,Tn))}}else{const er=($r,Tn)=>{const zr=m.getSymbolInstanceTextSize(U,Nt,this.transform.zoom,fi),No=this.collisionIndex.placeCollisionBox(m,zr,$r,R,z,ht,new s.P(0,0),Q,C,T,G.predicate);return No&&No.box&&No.box.length&&(this.markUsedOrientation(m,Tn,Nt),this.placedOrientations[qi]=Tn),No};Gr((()=>er(Vn,s.bK.horizontal)),(()=>{const $r=Kt.verticalTextBox;return m.allowVerticalPlacement&&mi>0&&$r?(ko($r),er($r,s.bK.vertical)):{box:null,offscreen:null,occluded:null}})),Dr(!!(gi&&gi.box&&gi.box.length))}}if(jr=gi,Qt=jr&&jr.box&&jr.box.length>0,ri=jr&&jr.offscreen,ur=jr&&jr.occluded,Nt.useRuntimeCollisionCircles){const Dr=Nt.centerJustifiedTextSymbolIndex>=0?Nt.centerJustifiedTextSymbolIndex:Nt.verticalPlacedTextSymbolIndex,Gr=m.text.placedSymbolArray.get(Dr),er=s.bL(m.textSizeData,U,Gr),$r=y.get("text-padding");Mr=this.collisionIndex.placeCollisionCircles(m,Q,Gr,Dr,m.lineVertexArray,m.glyphOffsetArray,er,T,S,M,c,he,G.predicate,Nt.collisionCircleDiameter*er/s.bX,$r,this.retainedQueryData[m.bucketInstanceId].tileID),Qt=Q||Mr.circles.length>0&&!Mr.collisionDetected,ri=ri&&Mr.offscreen,ur=Mr.occluded}if(Kt.iconFeatureIndex&&(Nn=Kt.iconFeatureIndex),Kt.iconBox){const Dr=Gr=>{ko(Gr);const er=Nt.hasIconTextFit&&Ut?xa(Ut.x,Ut.y,re,he,this.transform.angle):new s.P(0,0),$r=m.getSymbolInstanceIconSize($,this.transform.zoom,Nt.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(m,$r,Gr,R,z,ct,er,Y,C,T,G.predicate)};wr&&wr.box&&wr.box.length&&Kt.verticalIconBox?(Br=Dr(Kt.verticalIconBox),ki=Br.box.length>0):(Br=Dr(Kt.iconBox),ki=Br.box.length>0),ri=ri&&Br.offscreen,Ni=Br.occluded}const Bo=Z||Nt.numHorizontalGlyphVertices===0&&mi===0,ls=ie||Nt.numIconVertices===0;if(Bo||ls?ls?Bo||(ki=ki&&Qt):Qt=ki&&Qt:ki=Qt=ki&&Qt,Qt&&jr&&jr.box&&this.collisionIndex.insertCollisionBox(jr.box,y.get("text-ignore-placement"),m.bucketInstanceId,wr&&wr.box&&oo?oo:go,G.ID),ki&&Br&&this.collisionIndex.insertCollisionBox(Br.box,y.get("icon-ignore-placement"),m.bucketInstanceId,Nn,G.ID),Mr&&(Qt&&this.collisionIndex.insertCollisionCircles(Mr.circles,y.get("text-ignore-placement"),m.bucketInstanceId,go,G.ID),c)){const Dr=m.bucketInstanceId;let Gr=this.collisionCircleArrays[Dr];Gr===void 0&&(Gr=this.collisionCircleArrays[Dr]=new So);for(let er=0;er<Mr.circles.length;er+=4)Gr.circles.push(Mr.circles[er+0]),Gr.circles.push(Mr.circles[er+1]),Gr.circles.push(Mr.circles[er+2]),Gr.circles.push(Mr.collisionDetected?1:0)}const wn=m.projection.name!=="globe";dt=dt&&(wn||!ur),Pt=Pt&&(wn||!Ni),this.placements[qi]=new Bi(Qt||dt,ki||Pt,ri||m.justReloaded),n.add(qi)},Yi=this.retainedQueryData[m.bucketInstanceId].tileID;if(m.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(m,Yi),m.elevationType==="road"&&m.updateRoadElevation(Yi.canonical),m.updateZOffset(),m.sortFeaturesByY){const Nt=m.getSortedSymbolIndexes(this.transform.angle);for(let fi=Nt.length-1;fi>=0;--fi){const Kt=Nt[fi];pi(m.symbolInstances.get(Kt),Kt,m.collisionArrays[Kt])}m.hasAnyZOffset&&s.w("".concat(m.layerIds[0]," layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y"))}else if(m.hasAnyZOffset){const Nt=m.getSortedIndexesByZOffset();for(let fi=0;fi<Nt.length;++fi){const Kt=Nt[fi];pi(m.symbolInstances.get(Kt),Kt,m.collisionArrays[Kt])}}else for(let Nt=t.symbolInstanceStart;Nt<t.symbolInstanceEnd;Nt++)pi(m.symbolInstances.get(Nt),Nt,m.collisionArrays[Nt]);if(c&&m.bucketInstanceId in this.collisionCircleArrays){const Nt=this.collisionCircleArrays[m.bucketInstanceId];s.bk(Nt.invProjMatrix,T),Nt.viewportMatrix=this.collisionIndex.getViewportMatrix()}m.justReloaded=!1}markUsedJustification(t,n,c,d){const{leftJustifiedTextSymbolIndex:p,centerJustifiedTextSymbolIndex:m,rightJustifiedTextSymbolIndex:y,verticalPlacedTextSymbolIndex:x,crossTileID:T}=c,S=s.c2(n),M=d===s.bK.vertical?x:S==="left"?p:S==="center"?m:S==="right"?y:-1;p>=0&&(t.text.placedSymbolArray.get(p).crossTileID=M>=0&&p!==M?0:T),m>=0&&(t.text.placedSymbolArray.get(m).crossTileID=M>=0&&m!==M?0:T),y>=0&&(t.text.placedSymbolArray.get(y).crossTileID=M>=0&&y!==M?0:T),x>=0&&(t.text.placedSymbolArray.get(x).crossTileID=M>=0&&x!==M?0:T)}markUsedOrientation(t,n,c){const d=n===s.bK.horizontal||n===s.bK.horizontalOnly?n:0,p=n===s.bK.vertical?n:0,{leftJustifiedTextSymbolIndex:m,centerJustifiedTextSymbolIndex:y,rightJustifiedTextSymbolIndex:x,verticalPlacedTextSymbolIndex:T}=c,S=t.text.placedSymbolArray;m>=0&&(S.get(m).placedOrientation=d),y>=0&&(S.get(y).placedOrientation=d),x>=0&&(S.get(x).placedOrientation=d),T>=0&&(S.get(T).placedOrientation=p)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let c=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const d=n?n.symbolFadeChange(t):1,p=n?n.opacities:{},m=n?n.variableOffsets:{},y=n?n.placedOrientations:{};for(const x in this.placements){const T=this.placements[x],S=p[x];S?(this.opacities[x]=new Ei(S,d,T.text,T.icon,null,T.clipped),c=c||T.text!==S.text.placed||T.icon!==S.icon.placed):(this.opacities[x]=new Ei(null,d,T.text,T.icon,T.skipFade,T.clipped),c=c||T.text||T.icon)}for(const x in p){const T=p[x];if(!this.opacities[x]){const S=new Ei(T,d,!1,!1);S.isHidden()||(this.opacities[x]=S,c=c||T.text.placed||T.icon.placed)}}for(const x in m)this.variableOffsets[x]||!this.opacities[x]||this.opacities[x].isHidden()||(this.variableOffsets[x]=m[x]);for(const x in y)this.placedOrientations[x]||!this.opacities[x]||this.opacities[x].isHidden()||(this.placedOrientations[x]=y[x]);c?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:t)}updateLayerOpacities(t,n,c,d){const p=new Set;for(const m of n){const y=m.getBucket(t);y&&m.latestFeatureIndex&&t.fqid===y.layerIds[0]&&(this.updateBucketOpacities(y,p,m,m.collisionBoxArray,c,d,m.tileID,t.scope),y.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(y,m.tileID),y.elevationType==="road"&&y.updateRoadElevation(m.tileID.canonical),y.updateZOffset())}}updateBucketOpacities(t,n,c,d,p,m,y,x){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const T=t.layers[0].layout,S=t.layers[0].paint,M=!!t.layers[0].dynamicFilter(),E=new Ei(null,0,!1,!1,!0),C=T.get("text-allow-overlap"),R=T.get("icon-allow-overlap"),z=T.get("text-variable-anchor"),N=T.get("text-rotation-alignment")==="map",k=T.get("text-pitch-alignment")==="map",U=S.get("symbol-z-offset"),$=T.get("symbol-elevation-reference")==="sea",G=!U.isConstant(),ee=new Ei(null,0,C&&(R||!t.hasIconData()||T.get("icon-optional")),R&&(C||!t.hasTextData()||T.get("text-optional")),!0);!t.collisionArrays&&d&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(d);const Z=(Q,Y,re)=>{for(let _e=0;_e<Y/4;_e++)Q.opacityVertexArray.emplaceBack(re)};let ie=0;m&&t.updateReplacement(y,m);for(let Q=0;Q<t.symbolInstances.length;Q++){const Y=t.symbolInstances.get(Q),{numHorizontalGlyphVertices:re,numVerticalGlyphVertices:_e,crossTileID:he,numIconVertices:Ae,tileAnchorX:ve,tileAnchorY:ze}=Y;let Xe=null;const xe=this.retainedQueryData[t.bucketInstanceId];G&&Y&&xe&&(Xe=c.latestFeatureIndex.loadFeature({featureIndex:Y.featureIndex,bucketIndex:xe.bucketIndex,sourceLayerIndex:xe.sourceLayerIndex,layoutVertexArrayOffset:0}));const ce=U.evaluate(Xe,{}),Le=n.has(he);let be=this.opacities[he];Le?be=E:be||(be=ee,this.opacities[he]=be),n.add(he);const Ve=re>0||_e>0,Qe=Ae>0,mt=this.placedOrientations[he],$e=mt===s.bK.vertical,Ke=mt===s.bK.horizontal||mt===s.bK.horizontalOnly;!Ve&&!Qe||be.isHidden()||ie++;let gt=!1;if((Ve||Qe)&&m)for(const ht of t.activeReplacements){if(s.bY(ht,p,s.bZ.Symbol,x)||ht.min.x>ve||ve>ht.max.x||ht.min.y>ze||ze>ht.max.y)continue;const ct=s.b_(ve,ze,y.canonical,ht.footprintTileId.canonical);if(gt=s.b$(ct,ht.footprint),gt)break}if(Ve){const ht=gt?bn:Xl(be.text);Z(t.text,re,$e?bn:ht),Z(t.text,_e,Ke?bn:ht);const ct=be.text.isHidden(),{leftJustifiedTextSymbolIndex:dt,centerJustifiedTextSymbolIndex:Pt,rightJustifiedTextSymbolIndex:li,verticalPlacedTextSymbolIndex:pi}=Y,Yi=t.text.placedSymbolArray,Nt=ct||$e?1:0;dt>=0&&(Yi.get(dt).hidden=Nt),Pt>=0&&(Yi.get(Pt).hidden=Nt),li>=0&&(Yi.get(li).hidden=Nt),pi>=0&&(Yi.get(pi).hidden=ct||Ke?1:0);const fi=this.variableOffsets[he];fi&&this.markUsedJustification(t,fi.anchor,Y,mt);const Kt=this.placedOrientations[he];Kt&&(this.markUsedJustification(t,"left",Y,Kt),this.markUsedOrientation(t,Kt,Y))}if(Qe){const ht=gt?bn:Xl(be.icon),{placedIconSymbolIndex:ct,verticalPlacedIconSymbolIndex:dt}=Y,Pt=t.icon.placedSymbolArray,li=be.icon.isHidden()?1:0;ct>=0&&(Z(t.icon,Ae,$e?bn:ht),Pt.get(ct).hidden=li),dt>=0&&(Z(t.icon,Y.numVerticalIconVertices,Ke?bn:ht),Pt.get(dt).hidden=li)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const ht=t.collisionArrays[Q];if(ht){let ct=new s.P(0,0),dt=!0;if(ht.textBox||ht.verticalTextBox){if(z){const li=this.variableOffsets[he];li?(ct=ql(li.anchor,li.width,li.height,li.textOffset,li.textScale),N&&ct._rotate(k?this.transform.angle:-this.transform.angle)):dt=!1}M&&(dt=!be.clipped),ht.textBox&&Pn(t.textCollisionBox.collisionVertexArray,be.text.placed,!dt||$e,ce,$,ct.x,ct.y),ht.verticalTextBox&&Pn(t.textCollisionBox.collisionVertexArray,be.text.placed,!dt||Ke,ce,$,ct.x,ct.y)}const Pt=dt&&!!(!Ke&&ht.verticalIconBox);ht.iconBox&&Pn(t.iconCollisionBox.collisionVertexArray,be.icon.placed,Pt,ce,$,Y.hasIconTextFit?ct.x:0,Y.hasIconTextFit?ct.y:0),ht.verticalIconBox&&Pn(t.iconCollisionBox.collisionVertexArray,be.icon.placed,!Pt,ce,$,Y.hasIconTextFit?ct.x:0,Y.hasIconTextFit?ct.y:0)}}}if(t.fullyClipped=ie===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const Q=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=Q.invProjMatrix,t.placementViewportMatrix=Q.viewportMatrix,t.collisionCircleArray=Q.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,n){const c=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*c>t}setStale(){this.stale=!0}}function Pn(l,t,n,c,d,p,m){l.emplaceBack(t?1:0,n?1:0,p||0,m||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,m||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,m||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,m||0,c,d?1:0)}const an=Math.pow(2,25),ym=Math.pow(2,24),Zl=Math.pow(2,17),mh=Math.pow(2,16),Wl=Math.pow(2,9),Lc=Math.pow(2,8),_h=Math.pow(2,1);function Xl(l){if(l.opacity===0&&!l.placed)return 0;if(l.opacity===1&&l.placed)return 4294967295;const t=l.placed?1:0,n=Math.floor(127*l.opacity);return n*an+t*ym+n*Zl+t*mh+n*Wl+t*Lc+n*_h+t}const bn=0;class Ls{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,n,c,d,p,m){const y=this._bucketParts;for(;this._currentTileIndex<t.length;)if(n.getBucketParts(y,d,t[this._currentTileIndex],this._sortAcrossTiles,m),this._currentTileIndex++,p())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,y.sort(((x,T)=>x.sortKey-T.sortKey)));this._currentPartIndex<y.length;){const x=y[this._currentPartIndex];if(n.placeLayerBucketPart(x,this._seenCrossTileIDs,c,x.symbolInstanceStart===0,m),this._currentPartIndex++,p())return!0}return!1}}class po{constructor(t,n,c,d,p,m,y,x,T){this.placement=new $l(t,p,m,y,x,T),this._currentPlacementIndex=n.length-1,this._forceFullPlacement=c,this._showCollisionBoxes=d,this._done=!1}isDone(){return this._done}continuePlacement(t,n,c,d,p){const m=s.o.now(),y=()=>{const x=s.o.now()-m;return!this._forceFullPlacement&&x>2};for(;this._currentPlacementIndex>=0;){const x=n[t[this._currentPlacementIndex]],T=this.placement.collisionIndex.transform.zoom;if(x.type==="symbol"&&(!x.minzoom||x.minzoom<=T)&&(!x.maxzoom||x.maxzoom>T)){const S=x,M=S.layout.get("symbol-z-elevate"),E=S.layout.get("symbol-sort-key").constantOr(1)!==void 0,C=S.layout.get("symbol-z-order"),R=C==="viewport-y"||C==="auto"&&!(C!=="viewport-y"&&E),z=S.layout.get("text-allow-overlap")||S.layout.get("icon-allow-overlap")||S.layout.get("text-ignore-placement")||S.layout.get("icon-ignore-placement"),N=R&&z,k=this._inProgressLayer=this._inProgressLayer||new Ls(S),U=s.B(x.source,x.scope);if(k.continuePlacement(M||N?d[U]:c[U],this.placement,this._showCollisionBoxes,x,y,p))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Oc=512/s.al/2;class Ga{constructor(t,n,c){this.tileID=t,this.bucketInstanceId=c,this.index=new s.c3(n.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const d=t.canonical.x*s.al,p=t.canonical.y*s.al;for(let m=0;m<n.length;m++){const{key:y,crossTileID:x,tileAnchorX:T,tileAnchorY:S}=n.get(m),M=Math.floor((d+T)*Oc),E=Math.floor((p+S)*Oc);this.index.add(M,E),this.keys.push(y),this.crossTileIDs.push(x)}this.index.finish()}findMatches(t,n,c){const d=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z),p=Oc/Math.pow(2,n.canonical.z-this.tileID.canonical.z),m=n.canonical.x*s.al,y=n.canonical.y*s.al;for(let x=0;x<t.length;x++){const T=t.get(x);if(T.crossTileID)continue;const{key:S,tileAnchorX:M,tileAnchorY:E}=T,C=Math.floor((m+M)*p),R=Math.floor((y+E)*p),z=this.index.range(C-d,R-d,C+d,R+d).sort(((N,k)=>N-k));for(const N of z){const k=this.crossTileIDs[N];if(this.keys[N]===S&&!c.has(k)){c.add(k),T.crossTileID=k;break}}}}}class _n{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class ws{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const n=Math.round((t-this.lng)/360);if(n!==0)for(const c in this.indexes){const d=this.indexes[c],p={};for(const m in d){const y=d[m];y.tileID=y.tileID.unwrapTo(y.tileID.wrap+n),p[y.tileID.key]=y}this.indexes[c]=p}this.lng=t}addBucket(t,n,c){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let p=0;p<n.symbolInstances.length;p++)n.symbolInstances.get(p).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const d=this.usedCrossTileIDs[t.overscaledZ];for(const p in this.indexes){const m=this.indexes[p];if(Number(p)>t.overscaledZ)for(const y in m){const x=m[y];x.tileID.isChildOf(t)&&x.findMatches(n.symbolInstances,t,d)}else{const y=m[t.scaledTo(Number(p)).key];y&&y.findMatches(n.symbolInstances,t,d)}}for(let p=0;p<n.symbolInstances.length;p++){const m=n.symbolInstances.get(p);m.crossTileID||(m.crossTileID=c.generate(),d.add(m.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new Ga(t,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(t,n){for(const c of n.crossTileIDs)this.usedCrossTileIDs[t].delete(c)}removeStaleBuckets(t){let n=!1;for(const c in this.indexes){const d=this.indexes[c];for(const p in d)t[d[p].bucketInstanceId]||(this.removeBucketCrossTileIDs(c,d[p]),delete d[p],n=!0)}return n}}class Os{constructor(){this.layerIndexes={},this.crossTileIDs=new _n,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,n,c,d){let p=this.layerIndexes[t.fqid];p===void 0&&(p=this.layerIndexes[t.fqid]=new ws);let m=!1;const y={};d.name!=="globe"&&p.handleWrapJump(c);for(const x of n){const T=x.getBucket(t);T&&t.fqid===T.layerIds[0]&&(T.bucketInstanceId||(T.bucketInstanceId=++this.maxBucketInstanceId),p.addBucket(x.tileID,T,this.crossTileIDs)&&(m=!0),y[T.bucketInstanceId]=!0)}return p.removeStaleBuckets(y)&&(m=!0),m}pruneUnusedLayers(t){const n={};t.forEach((c=>{n[c]=!0}));for(const c in this.layerIndexes)n[c]||delete this.layerIndexes[c]}}const qr=771;class ti{constructor(t,n,c,d){this.blendFunction=t,this.blendColor=n.toNonPremultipliedRenderColor(null),this.mask=c,this.blendEquation=d}}ti.Replace=[1,0,1,0],ti.disabled=new ti(ti.Replace,s.ao.transparent,[!1,!1,!1,!1]),ti.unblended=new ti(ti.Replace,s.ao.transparent,[!0,!0,!0,!0]),ti.alphaBlended=new ti([1,qr,1,qr],s.ao.transparent,[!0,!0,!0,!0]),ti.alphaBlendedNonPremultiplied=new ti([770,qr,770,qr],s.ao.transparent,[!0,!0,!0,!0]),ti.multiply=new ti([774,0,774,0],s.ao.transparent,[!0,!0,!0,!0]),ti.additive=new ti([1,1,1,1],s.ao.transparent,[!0,!0,!0,!0]);class xt{constructor(t,n,c){this.func=t,this.mask=n,this.range=c}}xt.ReadOnly=!1,xt.ReadWrite=!0,xt.disabled=new xt(519,xt.ReadOnly,[0,1]);const va=7680;class Gt{constructor(t,n,c,d,p,m){this.test=t,this.ref=n,this.mask=c,this.fail=d,this.depthFail=p,this.pass=m}}Gt.disabled=new Gt({func:519,mask:0},0,0,va,va,va);const Ha=1029,Fc=2305;class Bt{constructor(t,n,c){this.enable=t,this.mode=n,this.frontFace=c}}function Yl(l,t){const n=s.c9(l,3);s.cb(l,t),s.cf(l,3,n)}function kc(l,t){const n=s.c6([]);return s.c7(n,n,-t),s.c8(n,n,-l),n}function Tf(l,t){const n=[l[0],l[1],0],c=[t[0],t[1],0];if(s.ag(n)>=1e-15){const m=s.aw([],n);s.c4(c,m,s.bI(c,m)),t[0]=c[0],t[1]=c[1]}const d=s.bH([],t,l);if(s.c5(d)<1e-15)return null;const p=Math.atan2(-d[1],d[0]);return kc(Math.atan2(Math.sqrt(l[0]*l[0]+l[1]*l[1]),-l[2]),p)}Bt.disabled=new Bt(!1,Ha,Fc),Bt.backCCW=new Bt(!0,Ha,Fc),Bt.backCW=new Bt(!0,Ha,2304),Bt.frontCW=new Bt(!0,1028,2304),Bt.frontCCW=new Bt(!0,1028,Fc);class Ts{constructor(t,n){this.position=t,this.orientation=n}get position(){return this._position}set position(t){if(t){const n=t instanceof s.ae?t:new s.ae(t[0],t[1],t[2]);this._renderWorldCopies&&(n.x=s.bS(n.x,0,1)),this._position=n}else this._position=null}lookAtPoint(t,n,c){if(this.orientation=null,!this.position)return;const d=this.position,p=c||(this._elevation?this._elevation.getAtPointOrZero(s.ae.fromLngLat(t)):0),m=s.ae.fromLngLat(t,p),y=[m.x-d.x,m.y-d.y,m.z-d.z];n||(n=[0,0,1]),n[2]=Math.abs(n[2]),this.orientation=Tf(y,n)}setPitchBearing(t,n){this.orientation=kc(s.an(t),s.an(-n))}}class Bc{constructor(t,n){this._transform=s.bz([]),this.orientation=n,this.position=t}get mercatorPosition(){const t=this.position;return new s.ae(t[0],t[1],t[2])}get position(){const t=s.c9(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var n;t&&s.cf(this._transform,3,[(n=t)[0],n[1],n[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||s.c6([]),t&&Yl(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),n=this.right();return{bearing:Math.atan2(-n[1],n[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,n){this._orientation=kc(t,n),Yl(this._transform,this._orientation)}forward(){const t=s.c9(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=s.c9(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=s.c9(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,n){const c=new Float64Array(16);return s.bk(c,this.getWorldToCamera(t,n)),c}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,n,c){const d=this.position;s.c4(d,d,-t);const p=new Float64Array(16);return s.bp(p,[c,c,c]),s.bq(p,p,d),p[10]*=n,p}getWorldToCamera(t,n){const c=new Float64Array(16),d=new Float64Array(4),p=this.position;return s.ca(d,this._orientation),s.c4(p,p,-t),s.cb(c,d),s.bq(c,c,p),c[1]*=-1,c[5]*=-1,c[9]*=-1,c[13]*=-1,c[8]*=n,c[9]*=n,c[10]*=n,c[11]*=n,c}getCameraToClipPerspective(t,n,c,d){const p=new Float64Array(16);return s.cc(p,t,n,c,d),p}getCameraToClipOrthographic(t,n,c,d,p,m){const y=new Float64Array(16);return s.cd(y,t,n,c,d,p,m),y}getDistanceToElevation(t,n=!1){const c=t===0?0:s.ce(t,n?s.a_(this.position[1]):this.position[1]),d=this.forward();return(c-this.position[2])/d[2]}clone(){return new Bc([...this.position],[...this.orientation])}}const Rn={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Yn{constructor(t=0,n=0,c=0,d=0){if(isNaN(t)||t<0||isNaN(n)||n<0||isNaN(c)||c<0||isNaN(d)||d<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=n,this.left=c,this.right=d}interpolate(t,n,c){return n.top!=null&&t.top!=null&&(this.top=s.ak(t.top,n.top,c)),n.bottom!=null&&t.bottom!=null&&(this.bottom=s.ak(t.bottom,n.bottom,c)),n.left!=null&&t.left!=null&&(this.left=s.ak(t.left,n.left,c)),n.right!=null&&t.right!=null&&(this.right=s.ak(t.right,n.right,c)),this}getCenter(t,n){const c=s.aA((this.left+t-this.right)/2,0,t),d=s.aA((this.top+n-this.bottom)/2,0,n);return new s.P(c,d)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Yn(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const ba=15;class qa{constructor(t,n,c,d,p,m,y){this.tileSize=512,this._renderWorldCopies=p===void 0||p,this._minZoom=t||0,this._maxZoom=n||22,this._minPitch=c!=null?c:0,this._maxPitch=d!=null?d:60,this.setProjection(m),this.setMaxBounds(y),this.width=0,this.height=0,this._center=new s.aS(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Yn,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Bc,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const t=new qa(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<ba}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,n=!1){const c=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||c)&&this._updateCameraOnTerrain(),(t||c)&&this._constrainCamera(n),this._calcMatrices()}getProjection(){return s.aH(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const n=this.projection?this.getProjection():void 0;this.projection=s.cl(this.projectionOptions);const c=this.getProjection(),d=!s.bx(n,c);return d&&this._calcMatrices(),this.mercatorFromTransition=!1,d}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=s.cl({name:"mercator"});const n=t!==this.projection.name;return n&&this._calcMatrices(),n}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return s.ce(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return s.bS(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const n=-t*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=s.cm(),s.cn(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const n=s.aA(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=s.an(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const n=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._setZoom(n),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,n=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!n||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const c=this._elevation;n||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&c.exaggeration()&&this._centerAltitudeValidForExaggeration!==c.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*c.exaggeration(),this._centerAltitudeValidForExaggeration=c.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=c.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;const t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,n=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],c=this.horizonLineFromTop();let d=0,p=0;for(let m=0;m<n.length;m++){const y=new s.P(n[m][0]*this.width,c+n[m][1]*(this.height-c)),x=t.pointCoordinate(y);if(!x)continue;const T=1/Math.hypot(x[0]-this._camera.position[0],x[1]-this._camera.position[1]);d+=x[3]*T,p+=T}return p===0?NaN:d/p}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,n=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),c=this.pixelsPerMeter/this.worldSize*n,d=this._mercatorZfromZoom(t),p=this._mercatorZfromZoom(this._maxZoom),m=Math.max(d-c,p);this._setZoom(this._zoomFromMercatorZ(m))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const n=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let c;c=t.z<this._camera.position[2]?[n.x,n.y,n.z]:[t.x,t.y,t.z];const d=s.ag(s.av([],this._camera.position,c));return s.aA(this._zoomFromMercatorZ(d),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let n=!1;if(t.orientation&&!s.co(t.orientation,this._camera.orientation)&&(n=this._setCameraOrientation(t.orientation)),t.position){const c=[t.position.x,t.position.y,t.position.z];s.cp(c,this._camera.position)||(this._setCameraPosition(c),n=!0)}n&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,n=new Ts;return n.position=new s.ae(t[0],t[1],t[2]),n.orientation=this._camera.orientation,n._elevation=this.elevation,n._renderWorldCopies=this.renderWorldCopies,n}_setCameraOrientation(t){if(!s.cq(t))return!1;s.cr(t,t);const n=s.cs([],[0,0,-1],t),c=s.cs([],[0,-1,0],t);if(c[2]<0)return!1;const d=Tf(n,c);return!!d&&(this._camera.orientation=d,!0)}_setCameraPosition(t){const n=this.zoomScale(this.minZoom)*this.tileSize,c=this.zoomScale(this.maxZoom)*this.tileSize,d=this.cameraToCenterDistance;t[2]=s.aA(t[2],d/c,d/n),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,n,c){this._unmodified=!1,this._edgeInsets.interpolate(t,n,c),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const n=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(t){const n=[new s.ct(0,t)];if(this.renderWorldCopies){const c=this.pointCoordinate(new s.P(0,0)),d=this.pointCoordinate(new s.P(this.width,0)),p=this.pointCoordinate(new s.P(this.width,this.height)),m=this.pointCoordinate(new s.P(0,this.height)),y=Math.floor(Math.min(c.x,d.x,p.x,m.x)),x=Math.floor(Math.max(c.x,d.x,p.x,m.x)),T=1;for(let S=y-T;S<=x+T;S++)S!==0&&n.push(new s.ct(S,t))}return n}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,n,c){let d=[];const p=c!=null,m=!p;if(m&&this.zoom<n||p&&c[0]===0&&c[1]===0)return d;const y=new Set,x=(S,M,E,C,R)=>{const z=s.cX(M,S,E,C,R);y.has(z)||(d.push(new s.aP(S,M,E,C,R)),y.add(z))};for(let S=0;S<t.length;S++){const M=t[S];if(m&&M.canonical.z!==n)continue;const E=M.canonical,C=M.overscaledZ,R=M.wrap,z=1<<E.z,N=E.x+1<z,k=E.x>0,U=E.y+1<z,$=E.y>0,G=M.wrap-(k?0:1),ee=M.wrap+(N?0:1),Z=k?E.x-1:z-1,ie=N?E.x+1:0;if(p)c[0]<0?(x(C,ee,E.z,ie,E.y),c[1]<0&&U&&(x(C,R,E.z,E.x,E.y+1),x(C,ee,E.z,ie,E.y+1)),c[1]>0&&$&&(x(C,R,E.z,E.x,E.y-1),x(C,ee,E.z,ie,E.y-1))):c[0]>0?(x(C,G,E.z,Z,E.y),c[1]<0&&U&&(x(C,R,E.z,E.x,E.y+1),x(C,G,E.z,Z,E.y+1)),c[1]>0&&$&&(x(C,R,E.z,E.x,E.y-1),x(C,G,E.z,Z,E.y-1))):c[1]<0&&U?x(C,R,E.z,E.x,E.y+1):$&&x(C,R,E.z,E.x,E.y-1);else{const Q=M.visibleQuadrants;1&Q&&(x(C,G,E.z,Z,E.y),$&&(x(C,R,E.z,E.x,E.y-1),x(C,G,E.z,Z,E.y-1))),2&Q&&(x(C,ee,E.z,ie,E.y),$&&(x(C,R,E.z,E.x,E.y-1),x(C,ee,E.z,ie,E.y-1))),4&Q&&(x(C,G,E.z,Z,E.y),U&&(x(C,R,E.z,E.x,E.y+1),x(C,G,E.z,Z,E.y+1))),8&Q&&(x(C,ee,E.z,ie,E.y),U&&(x(C,R,E.z,E.x,E.y+1),x(C,ee,E.z,ie,E.y+1)))}}const T=[];for(const S of d)d.some((M=>S.isChildOf(M)))||T.push(S);if(d=T.filter((S=>!t.some((M=>!!(S.overscaledZ<n&&M.isChildOf(S))||S.equals(M)||S.isChildOf(M))))),m){const S=1<<n,M=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),E=[S*M.x,S*M.y],C=4,R=C*C;d=d.filter((z=>{const N=z.canonical.x+.5-E[0],k=z.canonical.y+.5-E[1];return N*N+k*k<R}))}return d}extendTileCoverToNearPlane(t,n,c){const d=[],p=new Set;for(const U of t)p.add(U.key);const m=(U,$,G,ee,Z)=>{const ie=s.cX($,U,G,ee,Z);p.has(ie)||(d.push(new s.aP(U,$,G,ee,Z)),p.add(ie))},y=t.reduce(((U,$)=>Math.max(U,$.overscaledZ)),c),x=1<<c,T=[new s.P(0,0),new s.P(s.al,0),new s.P(s.al,s.al),new s.P(0,s.al)],S=new s.P(0,0),M=new s.P(0,0),E=(U,$)=>{const G=Math.floor(U[0]),ee=Math.floor(U[1]),Z=(U[0]-G)*s.al,ie=(U[1]-ee)*s.al,Q=Math.floor($[0]),Y=Math.floor($[1]),re=($[0]-Q)*s.al,_e=($[1]-Y)*s.al;for(let he=-1;he<=1;he++){const Ae=G+he;if(!(Ae<0||Ae>=x)){S.x=Z-he*s.al,M.x=re-(Ae-Q)*s.al;for(let ve=-1;ve<=1;ve++){const ze=ee+ve;S.y=ie-ve*s.al,M.y=_e-(ze-Y)*s.al,s.cY(S,M,T)&&m(y,0,c,Ae,ze)}}}},C=n.points,R=C[s.cu],z=C[s.cv],N=this._projectToGround(R,C[s.cw]),k=this._projectToGround(z,C[s.cx]);return E(R,N),E(z,k),d}_projectToGround(t,n){return s.cy(s.cz(),t,n,t[2]/(t[2]-n[2]))}coveringTiles(t){let n=this.coveringZoomLevel(t);const c=n,d=this.elevation&&this.elevation.exaggeration(),p=d&&!t.isTerrainDEM,m=this.projection.name==="mercator";if(t.minzoom!==void 0&&n<t.minzoom)return[];t.maxzoom!==void 0&&n>t.maxzoom&&(n=t.maxzoom);const y=this.locationCoordinate(this.center),x=this.center.lat,T=1<<n,S=[T*y.x,T*y.y,0],M=this.projection.name==="globe",E=!M,C=s.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,n,E),R=M?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),z=T*s.ce(1,this.center.lat),N=this._camera.position[2]/s.ce(1,this.center.lat),k=[T*R.x,T*R.y,N*(E?1:z)],U=M||d,$=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),G=this.isLODDisabled(!0)?n:0;let ee;if(this._elevation&&t.isTerrainDEM)ee=1e4*this._elevation.exaggeration();else if(this._elevation){const ce=this._elevation.getMinMaxForVisibleTiles();ee=ce?ce.max:this._centerAltitude}else ee=this._centerAltitude;const Z=t.isTerrainDEM?-ee:this._elevation?this._elevation.getMinElevationBelowMSL():0,ie=this.projection.isReprojectedInTileSpace?s.cB(this):1,Q=ce=>{const be=new s.ae(ce.x+25e-6,ce.y,ce.z),Ve=new s.ae(ce.x,ce.y+25e-6,ce.z),Qe=ce.toLngLat(),mt=be.toLngLat(),$e=Ve.toLngLat(),Ke=this.locationCoordinate(Qe),gt=this.locationCoordinate(mt),ht=this.locationCoordinate($e),ct=Math.hypot(gt.x-Ke.x,gt.y-Ke.y),dt=Math.hypot(ht.x-Ke.x,ht.y-Ke.y);return Math.sqrt(ct*dt)*ie/25e-6},Y=ce=>{const Le=ee,be=Z;return{aabb:s.cE(this,T,0,0,0,ce,be,Le,this.projection),zoom:0,x:0,y:0,minZ:be,maxZ:Le,wrap:ce,fullyVisible:!1}},re=[];let _e=[];const he=n,Ae=t.reparseOverscaled?c:n,ve=(N-this._centerAltitude)*z,ze=ce=>{if(!this._elevation||!ce.tileID||!m)return;const Le=this._elevation.getMinMaxForTile(ce.tileID),be=ce.aabb;Le?(be.min[2]=Le.min,be.max[2]=Le.max,be.center[2]=(be.min[2]+be.max[2])/2):(ce.shouldSplit=xe(ce),ce.shouldSplit||(be.min[2]=be.max[2]=be.center[2]=this._centerAltitude))},Xe=(ce,Le)=>{if(.707*Le<ce)return 1;const be=Le/ce;return be/(1.4144271570014144+(Math.pow(1.1,be-1.4144271570014144+1)-1)/(1.1-1)-1)},xe=ce=>{if(ce.zoom<G)return!0;if(ce.zoom===he)return!1;if(ce.shouldSplit!=null)return ce.shouldSplit;const Le=ce.aabb.distanceX(k),be=ce.aabb.distanceY(k);let Ve=ve,Qe=1;if(M){Ve=ce.aabb.distanceZ(k);const dt=Math.pow(2,ce.zoom),Pt=s.a_((ce.y+1)/dt),li=s.a_(ce.y/dt),pi=Math.min(Math.max(x,Pt),li),Yi=s.d0(pi)/s.d0(x);if(Qe=pi===x?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Yi/this._mercatorScaleRatio),this.zoom<=s.cZ&&ce.zoom===he-1&&Yi>=.9)return!0}else if(p&&(Ve=ce.aabb.distanceZ(k)*z),this.projection.isReprojectedInTileSpace&&c<=5){const dt=Math.pow(2,ce.zoom),Pt=Q(new s.ae((ce.x+.5)/dt,(ce.y+.5)/dt));Qe=Pt>.85?1:Pt}if(!m&&!M){const dt=Math.sqrt(Le*Le+be*be+Ve*Ve);let Pt=(1<<he-ce.zoom)*$*Qe;return Pt*=Xe(Math.max(Ve,ve),dt),dt<Pt}let mt=Number.MAX_VALUE,$e=0;const Ke=ce.aabb.getCorners(),gt=[];for(const dt of Ke){s.av(gt,dt,k),M||(p?gt[2]*=z:gt[2]=ve);const Pt=s.bI(gt,this._camera.forward());Pt<mt&&(mt=Pt,$e=Math.abs(gt[2]))}let ht=(1<<he-ce.zoom)*$*Qe;if(ht*=Xe(Math.max($e,ve),mt),mt<ht)return!0;const ct=ce.aabb.closestPoint(S);return ct[0]===S[0]&&ct[1]===S[1]};if(this.renderWorldCopies)for(let ce=1;ce<=3;ce++)re.push(Y(-ce)),re.push(Y(ce));for(re.push(Y(0));re.length>0;){const ce=re.pop(),Le=ce.x,be=ce.y;let Ve=ce.fullyVisible;const Qe=()=>this.projection.name==="globe"&&(ce.y===0||ce.y===(1<<ce.zoom)-1);if(!Ve){let mt=U?ce.aabb.intersects(C):ce.aabb.intersectsFlat(C);if(mt===0&&Qe()){const $e=new s.cC(ce.zoom,Le,be);mt=s.cD(this,T,$e,!0).intersects(C)}if(mt===0)continue;Ve=mt===2}if(ce.zoom!==he&&xe(ce))for(let mt=0;mt<4;mt++){const $e=(Le<<1)+mt%2,Ke=(be<<1)+(mt>>1),gt={aabb:m?ce.aabb.quadrant(mt):s.cE(this,T,ce.zoom+1,$e,Ke,ce.wrap,ce.minZ,ce.maxZ,this.projection),zoom:ce.zoom+1,x:$e,y:Ke,wrap:ce.wrap,fullyVisible:Ve,tileID:void 0,shouldSplit:void 0,minZ:ce.minZ,maxZ:ce.maxZ};p&&!M&&(gt.tileID=new s.aP(ce.zoom+1===he?Ae:ce.zoom+1,ce.wrap,ce.zoom+1,$e,Ke),ze(gt)),re.push(gt)}else{const mt=ce.zoom===he?Ae:ce.zoom;if(t.minzoom&&t.minzoom>mt)continue;let $e=0;if(!Ve){let ct=U?ce.aabb.intersectsPrecise(C):ce.aabb.intersectsPreciseFlat(C);if(ct===0&&Qe()){const dt=new s.cC(ce.zoom,Le,be);ct=s.cD(this,T,dt,!0).intersectsPrecise(C)}if(ct===0)continue;if(t.calculateQuadrantVisibility)if(C.containsPoint(ce.aabb.center))$e=15;else for(let dt=0;dt<4;dt++)ce.aabb.quadrant(dt).intersects(C)!==0&&($e|=1<<dt)}const Ke=S[0]-(.5+Le+(ce.wrap<<ce.zoom))*(1<<n-ce.zoom),gt=S[1]-.5-be,ht=ce.tileID?ce.tileID:new s.aP(mt,ce.wrap,ce.zoom,Le,be);t.calculateQuadrantVisibility&&(ht.visibleQuadrants=$e),_e.push({tileID:ht,distanceSq:Ke*Ke+gt*gt})}}if(this.fogCullDistSq){const ce=this.fogCullDistSq,Le=this.horizonLineFromTop();_e=_e.filter((be=>{const Ve=[0,0,0,1],Qe=[s.al,s.al,0,1],mt=this.calculateFogTileMatrix(be.tileID.toUnwrapped());s.aC(Ve,Ve,mt),s.aC(Qe,Qe,mt);const $e=s.cF([],Ve,Qe),Ke=s.cG([],Ve,Qe),gt=s.c_($e,Ke);if(gt===0)return!0;let ht=!1;const ct=this._elevation;if(ct&&gt>ce&&Le!==0){const dt=this.calculateProjMatrix(be.tileID.toUnwrapped());let Pt;t.isTerrainDEM||(Pt=ct.getMinMaxForTile(be.tileID)),Pt||(Pt={min:Z,max:ee});const li=s.cH(this.rotation),pi=[li[0]*s.al,li[1]*s.al,Pt.max];s.af(pi,pi,dt),ht=(1-pi[1])*this.height*.5<Le}return gt<ce||ht}))}return _e.sort(((ce,Le)=>ce.distanceSq-Le.distanceSq)).map((ce=>ce.tileID))}resize(t,n){this.width=t,this.height=n,this.pixelsToGLUnits=[2/t,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log2(t)}project(t){const n=s.aA(t.lat,-s.cI,s.cI),c=this.projection.project(t.lng,n);return new s.P(c.x*this.worldSize,c.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/s.ce(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,n){let c,d;const p=this.centerPoint;if(this.projection.name==="globe"){const y=this.worldSize;c=(n.x-p.x)/y,d=(n.y-p.y)/y}else{const y=this.pointCoordinate(n),x=this.pointCoordinate(p);c=y.x-x.x,d=y.y-x.y}const m=this.locationCoordinate(t);this.setLocation(new s.ae(m.x-c,m.y-d))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,n){return this.projection.locationPoint(this,t,n)}locationPoint3D(t,n){return this.projection.locationPoint(this,t,n,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,n){return this.coordinateLocation(this.pointCoordinate3D(t,n))}locationCoordinate(t,n){const c=n?s.ce(n,t.lat):void 0,d=this.projection.project(t.lng,t.lat);return new s.ae(d.x,d.y,c)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,n){const c=n!=null?n:this._centerAltitude,d=[t.x,t.y,0,1],p=[t.x,t.y,1,1];s.aC(d,d,this.pixelMatrixInverse),s.aC(p,p,this.pixelMatrixInverse);const m=p[3];s.cJ(d,d,1/d[3]),s.cJ(p,p,1/m);const y=d[2],x=p[2];return{p0:d,p1:p,t:y===x?0:(c-y)/(x-y)}}screenPointToMercatorRay(t){const n=[t.x,t.y,0,1],c=[t.x,t.y,1,1];return s.aC(n,n,this.pixelMatrixInverse),s.aC(c,c,this.pixelMatrixInverse),s.cJ(n,n,1/n[3]),s.cJ(c,c,1/c[3]),n[2]=s.ce(n[2],this._center.lat)*this.worldSize,c[2]=s.ce(c[2],this._center.lat)*this.worldSize,s.cJ(n,n,1/this.worldSize),s.cJ(c,c,1/this.worldSize),new s.ax([n[0],n[1],n[2]],s.aw([],s.av([],c,n)))}rayIntersectionCoordinate(t){const{p0:n,p1:c,t:d}=t,p=s.ce(n[2],this._center.lat),m=s.ce(c[2],this._center.lat);return new s.ae(s.ak(n[0],c[0],d)/this.worldSize,s.ak(n[1],c[1],d)/this.worldSize,s.ak(p,m,d))}pointCoordinate(t,n=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,n)}pointCoordinate3D(t,n){if(!this.elevation)return this.pointCoordinate(t,n);let c=this.projection.pointCoordinate3D(this,t.x,t.y);if(c)return new s.ae(c[0],c[1],c[2]);let d=0,p=this.horizonLineFromTop();if(t.y>p)return this.pointCoordinate(t,n);const m=.02*p,y=t.clone();for(let x=0;x<10&&p-d>m;x++){y.y=s.ak(d,p,.66);const T=this.projection.pointCoordinate3D(this,y.x,y.y);T?(p=y.y,c=T):d=y.y}return c?new s.ae(c[0],c[1],c[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=s.cK)return!this.isPointAboveHorizon(t);const n=this.pointCoordinate(t);return n.y>=0&&n.y<=1}_coordinatePoint(t,n){const c=n&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,d=[t.x*this.worldSize,t.y*this.worldSize,c+t.toAltitude(),1];return s.aC(d,d,this.pixelMatrix),d[3]>0?new s.P(d[0]/d[3],d[1]/d[3]):new s.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:n}=this._edgeInsets,c=this.height-this._edgeInsets.bottom,d=this.width-this._edgeInsets.right,p=this.pointLocation3D(new s.P(n,t)),m=this.pointLocation3D(new s.P(d,t)),y=this.pointLocation3D(new s.P(d,c)),x=this.pointLocation3D(new s.P(n,c));let T=Math.min(p.lng,m.lng,y.lng,x.lng),S=Math.max(p.lng,m.lng,y.lng,x.lng),M=Math.min(p.lat,m.lat,y.lat,x.lat),E=Math.max(p.lat,m.lat,y.lat,x.lat);const C=Math.pow(2,-this.zoom)/16*270,R=this.projection.name==="globe"?1:4,z=(N,k,U,$,G)=>{const ee=(N+U)/2,Z=(k+$)/2,ie=new s.P(ee,Z),{lng:Q,lat:Y}=this.pointLocation3D(ie),re=Math.max(0,T-Q,M-Y,Q-S,Y-E);T=Math.min(T,Q),S=Math.max(S,Q),M=Math.min(M,Y),E=Math.max(E,Y),(G<R||re>C)&&(z(N,k,ee,Z,G+1),z(ee,Z,U,$,G+1))};if(z(n,t,d,t,1),z(d,t,d,c,1),z(d,c,n,c,1),z(n,c,n,t,1),this.projection.name==="globe"){const[N,k]=s.cL(this);N?(E=90,S=180,T=-180):k&&(M=-90,S=180,T=-180)}return new s.aI(new s.aS(T,M),new s.aS(S,E))}_getBoundsRectangular(t,n){const{top:c,left:d}=this._edgeInsets,p=this.height-this._edgeInsets.bottom,m=this.width-this._edgeInsets.right,y=new s.P(d,c),x=new s.P(m,c),T=new s.P(m,p),S=new s.P(d,p);let M=this.pointCoordinate(y,t),E=this.pointCoordinate(x,t);const C=this.pointCoordinate(T,n),R=this.pointCoordinate(S,n),z=(N,k)=>(k.y-N.y)/(k.x-N.x);return M.y>1&&E.y>=0?M=new s.ae((1-R.y)/z(R,M)+R.x,1):M.y<0&&E.y<=1&&(M=new s.ae(-R.y/z(R,M)+R.x,0)),E.y>1&&M.y>=0?E=new s.ae((1-C.y)/z(C,E)+C.x,1):E.y<0&&M.y<=1&&(E=new s.ae(-C.y/z(C,E)+C.x,0)),new s.aI().extend(this.coordinateLocation(M)).extend(this.coordinateLocation(E)).extend(this.coordinateLocation(R)).extend(this.coordinateLocation(C))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const n=t.visibleDemTiles.reduce(((c,d)=>{if(d.dem){const p=d.dem.tree;c.min=Math.min(c.min,p.minimums[0]),c.max=Math.max(c.max,p.maximums[0])}return c}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(n.min*t.exaggeration(),n.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const n=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,c=this.height/2-n*(1-this._horizonShift);return t?Math.max(0,c):c}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-s.cI,this.maxLat=s.cI,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=s.aF(this.minLng)*this.tileSize,this.worldMaxX=s.aF(this.maxLng)*this.tileSize,this.worldMinY=s.aJ(this.maxLat)*this.tileSize,this.worldMaxY=s.aJ(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,n){return this.projection.createTileMatrix(this,n,t)}calculateDistanceTileData(t){const n=t.key,c=this._distanceTileDataCache;if(c[n])return c[n];const d=t.canonical,p=1/this.height,m=this.cameraWorldSize,y=m/this.zoomScale(d.z),x=(d.x+Math.pow(2,d.z)*t.wrap)*y,T=d.y*y,S=this.point;S.x*=m/this.worldSize,S.y*=m/this.worldSize;const M=this.angle,E=Math.sin(-M),C=-Math.cos(-M);return c[n]={bearing:[E,C],center:[(S.x-x)*p,(S.y-T)*p],scale:y/s.al*p},c[n]}calculateFogTileMatrix(t){const n=t.key,c=this._fogTileMatrixCache;if(c[n])return c[n];const d=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return s.aB(d,this.worldToFogMatrix,d),c[n]=new Float32Array(d),c[n]}calculateProjMatrix(t,n=!1,c=!1){const d=t.key;let p;if(p=c?this._expandedProjMatrixCache:n?this._alignedProjMatrixCache:this._projMatrixCache,p[d])return p[d];const m=this.calculatePosMatrix(t,this.worldSize);let y;return y=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:c?this.expandedFarZProjMatrix:n?this.alignedProjMatrix:this.projMatrix,s.aB(m,y,m),p[d]=new Float32Array(m),p[d]}calculatePixelsToTileUnitsMatrix(t){const n=t.tileID.key,c=this._pixelsToTileUnitsCache;if(c[n])return c[n];const d=s.cM(t,this);return c[n]=d,c[n]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,n=s.bp([],[t,t,t]);return s.aB(n,n,this.globeMatrix),n}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const n=s.ce(1,this._center.lat)*this.worldSize,c=this._computeCameraPosition(n),d=this._camera.forward(),p=s.ce(1,this._center.lat);c[2]/=p,d[2]/=p,s.aw(d,d);const m=t.raycast(c,d,t.exaggeration());if(m){const y=s.bG([],c,d,m),x=new s.ae(y[0],y[1],s.ce(y[2],s.a_(y[1]))),T=(x.z+s.ag([x.x-c[0],x.y-c[1],x.z-c[2]*p]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(T),this._centerAltitude=x.toAltitude(),this._center=this.coordinateLocation(x),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const n=this._elevation,c=s.ce(1,this._center.lat)*this.worldSize,d=this._computeCameraPosition(c),p=n.getAtPointOrZero(new s.ae(...d)),m=this.pixelsPerMeter/this.worldSize*p,y=this._minimumHeightOverTerrain(),x=d[2]-m;if(x<=y)if(x<0||t){const T=this.locationCoordinate(this._center,this._centerAltitude),S=[d[0],d[1],T.z-d[2]],M=s.ag(S);S[2]-=(y-x)/this._pixelsPerMercatorPixel;const E=s.ag(S);if(E===0)return;s.c4(S,S,M/E*this._pixelsPerMercatorPixel),this._camera.position=[d[0],d[1],T.z*this._pixelsPerMercatorPixel-S[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const E=this.center;return E.lat=s.aA(E.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(E.lng=s.aA(E.lng,this.minLng,this.maxLng)),this.center=E,void(this._constraining=!1)}const n=this._unmodified,{x:c,y:d}=this.point;let p=0,m=c,y=d;const x=this.width/2,T=this.height/2,S=this.worldMinY*this.scale,M=this.worldMaxY*this.scale;if(d-T<S&&(y=S+T),d+T>M&&(y=M-T),M-S<this.height&&(p=Math.max(p,this.height/(M-S)),y=(M+S)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const E=this.worldMinX*this.scale,C=this.worldMaxX*this.scale,R=this.worldSize/2-(E+C)/2;m=(c+R+this.worldSize)%this.worldSize-R,m-x<E&&(m=E+x),m+x>C&&(m=C-x),C-E<this.width&&(p=Math.max(p,this.width/(C-E)),m=(C+E)/2)}m===c&&y===d||this._allowWorldUnderZoom||(this.center=this.unproject(new s.P(m,y))),p&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(p)),this._constrainCamera(),this._unmodified=n,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,n=this.projection.name==="globe",c=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=s.ce(1,this.center.lat)/s.ce(1,s.d1));const d=s.cN(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,d),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const p=this.projection.zAxisUnit==="meters"?c:1,m=this._camera.getWorldToCamera(this.worldSize,p);let y;const x=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(x[8]=2*-t.x/this.width,x[9]=2*t.y/this.height,this.isOrthographic){let Y=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),re=Y*this.aspect,_e=-re,he=-Y;re-=t.x,_e-=t.x,Y+=t.y,he+=t.y,y=this._camera.getCameraToClipOrthographic(_e,re,he,Y,this._nearZ,this._farZ),((Ae,ve,ze,Xe)=>{for(let xe=0;xe<16;xe++)Ae[xe]=s.ak(ve[xe],ze[xe],Xe)})(y,y,x,s.c$(this.pitch>=ba?1:this.pitch/ba))}else y=x;const T=s.cO([],x,m);let S=s.cO([],y,m);if(this.projection.isReprojectedInTileSpace){const Y=this.locationCoordinate(this.center),re=s.bz([]);s.bq(re,re,[Y.x*this.worldSize,Y.y*this.worldSize,0]),s.aB(re,re,s.cP(this)),s.bq(re,re,[-Y.x*this.worldSize,-Y.y*this.worldSize,0]),s.aB(S,S,re),s.aB(T,T,re),this.inverseAdjustmentMatrix=s.cQ(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=s.cR([],S,[this.worldSize,this.worldSize,this.worldSize/p,1]),this.projMatrix=S,this.invProjMatrix=s.bk(new Float64Array(16),this.projMatrix),n){const Y=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);Y[8]=2*-t.x/this.width,Y[9]=2*t.y/this.height,this.expandedFarZProjMatrix=s.cO([],Y,m)}else this.expandedFarZProjMatrix=this.projMatrix;const M=s.bk([],y);this.frustumCorners=s.cS.fromInvProjectionMatrix(M,this.horizonLineFromTop(),this.height),this.cameraFrustum=s.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!n);const E=new Float32Array(16);s.bz(E),s.cR(E,E,[1,-1,1]),s.cT(E,E,this._pitch),s.bA(E,E,this.angle);const C=s.cc(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=s.by(C);const R=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;C[8]=2*-t.x/this.width,C[9]=2*(t.y+R)/this.height,this.skyboxMatrix=s.aB(E,C,E);const z=this.point,N=z.x,k=z.y,U=this.width%2/2,$=this.height%2/2,G=Math.cos(this.angle),ee=Math.sin(this.angle),Z=N-Math.round(N)+G*U+ee*$,ie=k-Math.round(k)+G*$+ee*U,Q=new Float64Array(S);if(s.bq(Q,Q,[Z>.5?Z-1:Z,ie>.5?ie-1:ie,0]),this.alignedProjMatrix=Q,S=s.bB(),s.cR(S,S,[this.width/2,-this.height/2,1]),s.bq(S,S,[1,-1,0]),this.labelPlaneMatrix=S,S=s.bB(),s.cR(S,S,[1,-1,1]),s.bq(S,S,[-1,-1,0]),s.cR(S,S,[2/this.width,2/this.height,1]),this.glCoordMatrix=S,this.pixelMatrix=s.aB(new Float64Array(16),this.labelPlaneMatrix,T),this._calcFogMatrices(),this._distanceTileDataCache={},S=s.bk(new Float64Array(16),this.pixelMatrix),!S)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=S,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=s.cU(this);const Y=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=s.af(Y,Y,m),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=S;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,n=this.cameraPixelsPerMeter,c=this._camera.position,d=1/this.height/this._pixelsPerMercatorPixel,p=[t,t,n];s.c4(p,p,d),s.c4(c,c,-1),s.cV(c,c,p);const m=s.bB();s.bq(m,m,c),s.cR(m,m,p),this.mercatorFogMatrix=m,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,n,d)}_computeCameraPosition(t){const n=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,c=this._camera.forward(),d=this.point,p=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*n-t/this.worldSize*this._centerAltitude;return[d.x/this.worldSize-c[0]*p,d.y/this.worldSize-c[1]*p,t/this.worldSize*this._centerAltitude-c[2]*p]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const n=this._maxCameraBoundsDistance()*Math.cos(this._pitch),c=this._camera.position[2],d=t[2];let p=1;this.projection.wrap&&(this.center=this.center.wrap()),d>0&&(p=Math.min((n-c)/d,1)),this._camera.position=s.bG([],this._camera.position,t,p),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,n=this._camera.forward(),{pitch:c,bearing:d}=this._camera.getPitchBearing(),p=s.ce(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,m=this._mercatorZfromZoom(this._maxZoom)*Math.cos(s.an(this._maxPitch)),y=Math.max((t[2]-p)/Math.cos(c),m),x=this._zoomFromMercatorZ(y);s.bG(t,t,n,y),this._pitch=s.aA(c,s.an(this.minPitch),s.an(this.maxPitch)),this.angle=s.bS(d,-Math.PI,Math.PI),this._setZoom(s.aA(x,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new s.ae(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let n=0,c=s.cK,d=0,p=1/0;for(;c-n>1e-6&&c>n;){const m=n+.5*(c-n),y=this.tileSize*Math.pow(2,m),x=this.getCameraToCenterDistance(this.projection,m,y),T=this.scaleZoom(x/(Math.max(0,t)*this.tileSize)),S=Math.abs(m-T);S<p&&(p=S,d=m),m<T?n=m:c=m}return d}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(s.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,n){const c=Math.min(t.x,n.x),d=Math.max(t.x,n.x),p=Math.min(t.y,n.y),m=Math.max(t.y,n.y);if(p<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const y=[new s.P(c,p),new s.P(d,m),new s.P(c,m),new s.P(d,p)],x=this.renderWorldCopies?-3:0,T=this.renderWorldCopies?4:1;for(const S of y){const M=this.pointRayIntersection(S);if(M.t<0)return!0;const E=this.rayIntersectionCoordinate(M);if(E.x<x||E.y<0||E.x>T||E.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+s.cW(this.fovAboveCenter)>88||this.anyCornerOffEdge(new s.P(0,0),new s.P(this.width,this.height))}zoomDeltaToMovement(t,n){const c=s.ag(s.av([],this._camera.position,t)),d=this._zoomFromMercatorZ(c)+n;return c-this._mercatorZfromZoom(d)}getCameraPoint(){if(this.projection.name==="globe"){const t=(function([n,c,d],p){const m=[n,c,d,1];s.aC(m,m,p);const y=m[3]=Math.max(m[3],1e-6);return m[0]/=y,m[1]/=y,m[2]/=y,m})([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new s.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,t))}}getCameraToCenterDistance(t,n=this.zoom,c=this.worldSize){const d=s.cN(t,n,this.width,this.height,1024),p=t.pixelSpaceConversion(this.center.lat,c,d);let m=.5/Math.tan(.5*this._fov)*this.height*p;return this.isOrthographic&&(m=s.ak(1,m,s.c$(this.pitch>=ba?1:this.pitch/ba))),m}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&s.aB(t,t,this.globeMatrix),t}getFrustum(t){return s.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}const Fs=(l,t)=>{if(t>0&&l.terrain&&s.w("Cutoff is currently disabled on terrain"),t<=0||l.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const n=l.transform,c=Math.max(Math.abs(n._zoom-(l.minCutoffZoom-1)),1),d=n.isLODDisabled(!1)?s.ah(60,45,n.pitch):s.ah(30,15,n.pitch),p=n._farZ-n._nearZ,m=t*n.height,y=((1-(x=d))*n.cameraToCenterDistance+x*(n._farZ+m))*c;var x;return{shouldRenderCutoff:d<1,uniformValues:{u_cutoff_params:[n._nearZ,n._farZ,(y-n._nearZ)/p,(y-m-n._nearZ)/p]}}},Dn={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class xm{constructor(t,n){this.aabb=t,this.lastCascade=n}}class vm{add(t,n){const c=this.receivers[t.key];c!==void 0?(c.aabb.min[0]=Math.min(c.aabb.min[0],n.min[0]),c.aabb.min[1]=Math.min(c.aabb.min[1],n.min[1]),c.aabb.min[2]=Math.min(c.aabb.min[2],n.min[2]),c.aabb.max[0]=Math.max(c.aabb.max[0],n.max[0]),c.aabb.max[1]=Math.max(c.aabb.max[1],n.max[1]),c.aabb.max[2]=Math.max(c.aabb.max[2],n.max[2])):this.receivers[t.key]=new xm(n,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,n,c){const d=s.d8.fromPoints(t.points);let p=0;for(const m in this.receivers){const y=this.receivers[m];if(!y||!d.intersectsAabb(y.aabb))continue;y.aabb.min=d.closestPoint(y.aabb.min),y.aabb.max=d.closestPoint(y.aabb.max);const x=y.aabb.getCorners();for(let T=0;T<c.length;T++){let S=!0;for(const M of x){const E=[M[0]*n,M[1]*n,M[2]];if(s.af(E,E,c[T].matrix),E[0]<-1||E[0]>1||E[1]<-1||E[1]>1){S=!1;break}}if(y.lastCascade=T,p=Math.max(p,T),S)break}}return p+1}}class Kl{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new vm,this._depthMode=new xt(t.context.gl.LEQUAL,xt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},(()=>{this.painter.style.map.triggerRepaint()})),t.tp.registerParameter(Dn,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(Dn,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(Dn,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,n){const c=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!n||!n.properties)return;const d=n.properties.get("shadow-intensity");if(!n.shadowsEnabled()||d<=0||(this._shadowLayerCount=c.style.order.reduce(((R,z)=>{const N=c.style._mergedLayers[z];return R+(N.hasShadowPass()&&!N.isHidden(t.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const p=c.context,m=Dn.shadowMapResolution,y=Dn.shadowMapResolution;if(this._cascades.length===0||Dn.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let R=0;R<Dn.cascadeCount;++R){const z=c._shadowMapDebug,N=p.gl,k=p.createFramebuffer(m,y,z,"texture"),U=new s.T(p,{width:m,height:y,data:null},N.DEPTH_COMPONENT16);if(k.depthAttachment.set(U.texture),z){const $=new s.T(p,{width:m,height:y,data:null},N.RGBA8);k.colorAttachment.set($.texture)}this._cascades.push({framebuffer:k,texture:U,matrix:[],far:0,boundingSphereRadius:0,frustum:new s.cA,scale:0})}}this.shadowDirection=Sf(n);let x=0;if(t.elevation){const R=t.elevation,z=[1e4,-1e4];R.visibleDemTiles.filter((N=>N.dem)).forEach((N=>{const k=N.dem.tree;z[0]=Math.min(z[0],k.minimums[0]),z[1]=Math.max(z[1],k.maximums[0])})),z[0]!==1e4&&(x=(z[1]-z[0])*R.exaggeration())}const T=1.5*t.cameraToCenterDistance,S=3*T,M=new Float64Array(16);for(let R=0;R<this._cascades.length;++R){const z=this._cascades[R];let N=t.height/50,k=1;Dn.cascadeCount===1?k=S:R===0?k=T:(N=T,k=S);const[U,$]=Ef(t,this.shadowDirection,N,k,Dn.shadowMapResolution,x);z.scale=t.scale,z.matrix=U,z.boundingSphereRadius=$,s.bk(M,z.matrix),z.frustum=s.cA.fromInvProjectionMatrix(M,1,0,!0),z.far=k}const E=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[E].far,this._cascades[E].far],this._uniformValues.u_shadow_intensity=d,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Dn.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Dn.shadowMapResolution,this._uniformValues.u_shadowmap_0=Rn.ShadowMap0,this._uniformValues.u_shadowmap_1=Rn.ShadowMap0+1,this._groundShadowTiles=c.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const C=c.transform.elevation;for(const R of this._groundShadowTiles){let z={min:0,max:0};if(C){const N=C.getMinMaxForTile(R);N&&(z=N)}this.addShadowReceiver(R.toUnwrapped(),z.min,z.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,n){if(!this.enabled)return;const c=this.painter,d=c.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(c.transform.getFrustum(0),c.transform.worldSize,this._cascades),d.viewport.set([0,0,Dn.shadowMapResolution,Dn.shadowMapResolution]);for(let p=0;p<this._numCascadesToRender;++p){c.currentShadowCascade=p,d.bindFramebuffer.set(this._cascades[p].framebuffer.framebuffer),d.clear({color:s.ao.white,depth:1});for(const m of t.order){const y=t._mergedLayers[m];if(!y.hasShadowPass()||y.isHidden(c.transform.zoom))continue;const x=t.getLayerSourceCache(y),T=x?n[x.id]:void 0;(y.type==="model"||T&&T.length)&&c.renderLayer(c,x,y,T)}}c.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const t=this.painter,n=t.style,c=t.context,d=c.gl,p=n.directionalLight,m=n.ambientLight;if(!p||!m)return;const y=[],x=Fs(t,t.longestCutoffRange);x.shouldRenderCutoff&&y.push("RENDER_CUTOFF"),y.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&y.push("NORMAL_OFFSET");const T=is(n,p,m),S=new xt(d.LEQUAL,xt.ReadOnly,t.depthRangeFor3D),M=new Gt({func:d.EQUAL,mask:255},0,255,d.KEEP,d.KEEP,d.KEEP);for(const E of this._groundShadowTiles){const C=E.toUnwrapped(),R=t.isTileAffectedByFog(E),z=t.getOrCreateProgram("groundShadow",{defines:y,overrideFog:R});this.setupShadows(C,z),t.uploadCommonUniforms(c,z,C,null,x);const N={u_matrix:t.transform.calculateProjMatrix(C),u_ground_shadow_factor:T};z.draw(t,d.TRIANGLES,S,M,ti.multiply,Bt.disabled,N,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ti.unblended:ti.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const n=this.painter.transform,c=n.calculatePosMatrix(t,n.worldSize);return s.aB(c,this._cascades[this.painter.currentShadowCascade].matrix,c),Float32Array.from(c)}calculateShadowPassMatrixFromMatrix(t){const n=s.by(t);return s.aB(n,this._cascades[this.painter.currentShadowCascade].matrix,t),n}setupShadows(t,n,c){if(!this.enabled)return;const d=this.painter.transform,p=this.painter.context,m=p.gl,y=this._uniformValues,x=new Float64Array(16),T=d.calculatePosMatrix(t,d.worldSize);for(let S=0;S<this._cascades.length;S++)s.aB(x,this._cascades[S].matrix,T),y[S===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(x),p.activeTexture.set(m.TEXTURE0+Rn.ShadowMap0+S),this._cascades[S].texture.bindExtraParam(m.LINEAR,m.LINEAR,m.CLAMP_TO_EDGE,m.CLAMP_TO_EDGE,m.GREATER);if(this.useNormalOffset=!!c,this.useNormalOffset){const S=s.d6(t.canonical),M=2/d.tileSize*s.al/Dn.shadowMapResolution,E=M*this._cascades[0].boundingSphereRadius,C=M*this._cascades[this._cascades.length-1].boundingSphereRadius,R=(c==="vector-tile"?1:3)*(function(z,N,k,U,$){const G=s.aA((z-22)/-22,0,1);return .125*(1-G)+4*G})(d.zoom);y.u_shadow_normal_offset=[S,E*R,C*R],y.u_shadow_bias=[1e-4,.0012,.012]}else y.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(p,y)}setupShadowsFromMatrix(t,n,c=!1){if(!this.enabled)return;const d=this.painter.context,p=d.gl,m=this._uniformValues,y=new Float64Array(16);for(let x=0;x<Dn.cascadeCount;x++)s.aB(y,this._cascades[x].matrix,t),m[x===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(y),d.activeTexture.set(p.TEXTURE0+Rn.ShadowMap0+x),this._cascades[x].texture.bindExtraParam(p.LINEAR,p.LINEAR,p.CLAMP_TO_EDGE,p.CLAMP_TO_EDGE,p.GREATER);if(this.useNormalOffset=c,c){const x=Dn.normalOffset;m.u_shadow_normal_offset=[1,x,x],m.u_shadow_bias=[6e-5,.0012,.012]}else m.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(d,m)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,n,c,d){if(d[2]>=0)return{};const p=(function(x,T,S){const M=S/(1<<x.canonical.z);return new s.d8([x.canonical.x*M+x.wrap*S,x.canonical.y*M+x.wrap*S,0],[(x.canonical.x+1)*M+x.wrap*S,(x.canonical.y+1)*M+x.wrap*S,T])})(t,n,c).getCorners(),m=n/-d[2];d[0]<0?(s.d7(p[0],p[0],[d[0]*m,0,0]),s.d7(p[3],p[3],[d[0]*m,0,0])):d[0]>0&&(s.d7(p[1],p[1],[d[0]*m,0,0]),s.d7(p[2],p[2],[d[0]*m,0,0])),d[1]<0?(s.d7(p[0],p[0],[0,d[1]*m,0]),s.d7(p[1],p[1],[0,d[1]*m,0])):d[1]>0&&(s.d7(p[2],p[2],[0,d[1]*m,0]),s.d7(p[3],p[3],[0,d[1]*m,0]));const y={};return y.vertices=p,y.planes=[Ks(p[1],p[0],p[4]),Ks(p[2],p[1],p[5]),Ks(p[3],p[2],p[6]),Ks(p[0],p[3],p[7])],y}addShadowReceiver(t,n,c){this._receivers.add(t,s.d8.fromTileIdAndHeight(t,n,c))}getMaxCascadeForTile(t){const n=this._receivers.get(t);return n&&n.lastCascade?n.lastCascade:0}}function Ks(l,t,n){const c=s.av([],n,t),d=s.av([],l,t),p=s.bH([],c,d),m=s.ag(p);return m===0?[0,0,1,0]:(s.c4(p,p,1/m),[p[0],p[1],p[2],-s.bI(p,t)])}function Sf(l){const t=l.properties.get("direction"),n=s.d3(t.x,t.y,t.z);n[2]=s.aA(n[2],0,75);const c=s.d5([n[0],n[1],n[2]]);return s.d4(c.x,c.y,c.z)}function is(l,t,n){const c=t.properties.get("color-use-theme")==="none",d=t.properties.get("color"),p=t.properties.get("intensity"),m=t.properties.get("direction"),y=[m.x,m.y,m.z],x=n.properties.get("color-use-theme")==="none",T=n.properties.get("color"),S=n.properties.get("intensity"),M=Math.max(s.bI([0,0,1],y),0),E=[0,0,0];s.c4(E,T.toPremultipliedRenderColor(x?null:l.getLut(t.scope)).toArray01Linear().slice(0,3),S);const C=[0,0,0];return s.c4(C,d.toPremultipliedRenderColor(c?null:l.getLut(n.scope)).toArray01Linear().slice(0,3),M*p),s.da([E[0]>0?E[0]/(E[0]+C[0]):0,E[1]>0?E[1]/(E[1]+C[1]):0,E[2]>0?E[2]/(E[2]+C[2]):0])}function Ef(l,t,n,c,d,p){const m=l.zoom,y=l.scale,x=l.worldSize,T=1/x,S=l.aspect,M=Math.sqrt(1+S*S)*Math.tan(.5*l.fovX),E=M*M,C=c-n,R=c+n;let z,N;E>C/R?(z=c,N=c*M):(z=.5*R*(1+E),N=.5*Math.sqrt(C*C+2*(c*c+n*n)*E+R*R*E*E));const k=l.projection.pixelsPerMeter(l.center.lat,x),U=l._camera.getCameraToWorldMercator(),$=[0,0,-z*T];s.af($,$,U);let G=N*T;const ee=l._edgeInsets;if(!(ee.left===0&&ee.top===0&&ee.right===0&&ee.bottom===0||ee.left===ee.right&&ee.top===ee.bottom)){const Ve=l._camera.getWorldToCamera(l.worldSize,l.projection.zAxisUnit==="meters"?k:1),Qe=l._camera.getCameraToClipPerspective(l._fov,l.width/l.height,n,c);Qe[8]=2*-l.centerOffset.x/l.width,Qe[9]=2*l.centerOffset.y/l.height;const mt=new Float64Array(16);s.cO(mt,Qe,Ve);const $e=new Float64Array(16);s.bk($e,mt);const Ke=s.cA.fromInvProjectionMatrix($e,x,m,!0);for(const gt of Ke.points){const ht=((Z=gt)[0]/=y,Z[1]/=y,Z[2]=s.ce(Z[2],l._center.lat),Z);G=Math.max(G,s.c5(s.d9([],$,ht)))}}var Z;G*=d/(d-1);const ie=Math.acos(t[2]),Q=Math.atan2(-t[0],-t[1]),Y=new Bc;Y.position=$,Y.setPitchBearing(ie,Q);const re=Y.getWorldToCamera(x,k),_e=G*x,he=Math.min(l._mercatorZfromZoom(17)*x*-2,-2*_e),Ae=Y.getCameraToClipOrthographic(-_e,_e,-_e,_e,he,(_e+p*k)/t[2]),ve=new Float64Array(16);s.aB(ve,Ae,re);const ze=s.d4(Math.floor(1e6*$[0])/1e6*x,Math.floor(1e6*$[1])/1e6*x,0),Xe=.5*d,xe=[0,0,0];s.af(xe,ze,ve),s.c4(xe,xe,Xe);const ce=[Math.floor(xe[0]),Math.floor(xe[1]),Math.floor(xe[2])],Le=[0,0,0];s.av(Le,xe,ce),s.c4(Le,Le,-1/Xe);const be=new Float64Array(16);return s.bz(be),s.bq(be,be,Le),s.aB(ve,be,ve),[ve,_e]}class Nc extends s.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,n){return s.db(this.requestManager.transformRequest(n,s.R.Model).url).then((c=>{if(!c)return;const d=s.dc(c),p=new s.dd(t,n,void 0,void 0,d);return p.computeBoundsAndApplyParent(),p})).catch((c=>{if(c&&c.status===404)return null;this.fire(new s.y(new Error("Could not load model ".concat(t," from ").concat(n,": ").concat(c.message))))}))}load(t,n,c={forceReload:!1}){this.models[n]||(this.models[n]={});const d=Object.keys(t),p=[],m=[];for(const y of d){const x=t[y];this.hasURLBeenRequested(x)&&!c.forceReload||(this.modelByURL[x]={modelId:y,scope:n},p.push(this.loadModel(y,x)),m.push(y)),this.models[n][y]||(this.models[n][y]={model:null,numReferences:1})}this.numModelsLoading[n]=(this.numModelsLoading[n]||0)+m.length,Promise.allSettled(p).then((y=>{for(let x=0;x<y.length;x++){const{status:T}=y[x];if(T==="rejected")continue;const{value:S}=y[x];this.models[n][m[x]]||(this.models[n][m[x]]={model:null,numReferences:1}),this.models[n][m[x]].model=S}this.numModelsLoading[n]-=m.length,this.fire(new s.z("data",{dataType:"style"}))})).catch((y=>{this.fire(new s.y(new Error("Could not load models: ".concat(y.message))))}))}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,n,c={exactIdMatch:!1}){return!!(c.exactIdMatch?this.getModel(t,n):this.getModelByURL(this.modelUris[n][t]))}getModel(t,n){return this.models[n]||(this.models[n]={}),this.models[n][t]?this.models[n][t].model:void 0}getModelByURL(t){if(!t)return null;const n=this.modelByURL[t];return n?this.models[n.scope][n.modelId].model:null}hasModelBeenAdded(t,n){return this.models[n]&&this.models[n][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,n,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={});const d=this.requestManager.normalizeModelURL(n);if((this.hasModel(t,c,{exactIdMatch:!0})||this.hasModelBeenAdded(t,c))&&this.modelUris[c][t]===d)this.models[c][t].numReferences++;else if(this.hasURLBeenRequested(d)){const{scope:p,modelId:m}=this.modelByURL[d];this.models[p][m].numReferences++}else this.modelUris[c][t]=d,this.load({[t]:this.modelUris[c][t]},c)}addModelURLs(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c=this.modelUris[n];for(const d in t)c[d]=this.requestManager.normalizeModelURL(t[d])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c={};for(const d of t)this.hasModel(d,n,{exactIdMatch:!0})||this.hasURLBeenRequested(d)?this.models[n][d].numReferences++:this.modelUris[n][d]&&!this.hasURLBeenRequested(d)?c[d]=this.modelUris[n][d]:!this.hasURLBeenRequested(d)&&s.de(d,!1)&&(this.modelUris[n][d]=this.requestManager.normalizeModelURL(d),c[d]=this.modelUris[n][d]);this.load(c,n)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,n,c=!1,d=!1){if(this.models[n]&&this.models[n][t]&&(this.models[n][t].numReferences--,this.models[n][t].numReferences===0||d)){const p=this.modelUris[n][t];c||delete this.modelUris[n][t],delete this.modelByURL[p];const m=this.models[n][t].model;if(!m)return;delete this.models[n][t],m.destroy()}}destroy(){for(const t of Object.keys(this.models))for(const n of Object.keys(this.models[t])){const c=this.models[t][n].model;delete this.models[t][n],c&&c.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,n){this.models[n]||(this.models[n]={});for(const c in this.models[n])this.models[n][c].model&&this.models[n][c].model.upload(t.context)}}const Jl=s.a6.colorTheme,Js=new s.a9({data:new s.aa(Jl.data)});function bm(l){if(!l.metadata||!l.metadata.content_area)return;const t=s.o.devicePixelRatio,{left:n,top:c,width:d,height:p}=l.metadata.content_area,m=n*t,y=c*t;return[m,y,m+d*t,y+p*t]}function If(l){if(l)return l.map((([t,n])=>[t*s.o.devicePixelRatio,n*s.o.devicePixelRatio]))}class wm{constructor(t,n,c){this.id=t,this.scope=n,this.sourceCache=c,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const t=new Map;if(!this.sourceCache.loaded())return t;const n=this.sourceCache.getVisibleCoordinates();if(n.length===0)return t;const c=this.sourceCache.getSource();if(!(c instanceof mn))return t;const d=n.map((m=>this.sourceCache.getTile(m))),p=c.getImages(d,Array.from(this.pendingRequests));for(const[m,y]of p)t.set(s.I.from({name:m,iconsetId:this.id}),y),this.pendingRequests.delete(m);for(const m of this.pendingRequests)this.missingRequests.add(m);return this.pendingRequests.clear(),t}}const Qs=(l,t)=>O(l,t&&t.filter((n=>n.identifier!=="source.canvas"))),Tm=s.aH(Fi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setLayerProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),gh=s.aH(Fi,["setCenter","setZoom","setBearing","setPitch"]),Vc=new Set(["background","sky","slot","custom"]),yh={version:8,layers:[],sources:{}},xh={duration:300,delay:0};class rs extends s.E{constructor(t,n={}){super(),this.map=t,this.scope=n.scope||"",this.globalId=null,this.fragments=[],this.importDepth=n.importDepth||0,this.importsCache=n.importsCache||new Map,this.resolvedImports=n.resolvedImports||new Set,this.transition=Object.assign({},xh),this._buildingIndex=new lh(this),this.crossTileSymbolIndex=new Os,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedIndoor={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._hasAppearances=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._importedAsBasemap=!1,this._changes=n.styleChanges||new In,this.dispatcher=n.dispatcher?n.dispatcher:new s.D(s.dg(),this),n.imageManager?this.imageManager=n.imageManager:(this.imageManager=new co(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=n.glyphManager?n.glyphManager:new s.dh(t._requestManager,n.localFontFamily?s.di.all:n.localIdeographFontFamily?s.di.ideographs:s.di.none,n.localFontFamily||n.localIdeographFontFamily),n.modelManager?this.modelManager=n.modelManager:(this.modelManager=new Nc(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=n.configOptions?n.configOptions:new Map,this._configDependentLayers=n.configDependentLayers?n.configDependentLayers:new Set,this._indoorDependentLayers=n.indoorDependentLayers?n.indoorDependentLayers:new Set,this._config=n.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:n.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=n.initialConfig,this.dispatcher.broadcast("setReferrer",s.dj());const c=this;this._rtlTextPluginCallback=rs.registerForPluginStateChange((d=>{c.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:d.pluginStatus,pluginURL:d.pluginURL},((p,m)=>{if(s.dk(p),m&&m.every((y=>y)))for(const y in c._sourceCaches){const x=c._sourceCaches[y],T=x.getSource().type;T!=="vector"&&T!=="geojson"||x.reload()}}))})),this.on("data",(d=>{if(d.dataType!=="source"||d.sourceDataType!=="metadata")return;const p=this.getOwnSource(d.sourceId);if(p&&p.vectorLayerIds)for(const m in this._layers){const y=this._layers[m];y.source===p.id&&this._validateLayer(y)}}))}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(s.h(t))return t;const n=s.dl(t);if(!n.startsWith("http"))try{return new URL(n,location.href).toString()}catch(c){return n}return n}return"json://".concat(s.dm(JSON.stringify(t)))}_diffStyle(t,n,c){this.globalId=this._getGlobalId(t);const d=(p,m)=>{try{m(null,this.setState(p,c))}catch(y){m(y,!1)}};if(typeof t=="string"){const p=this.map._requestManager.normalizeStyleURL(t),m=this.map._requestManager.transformRequest(p,s.R.Style);s.m(m,((y,x)=>{y?this.fire(new s.y(y)):x&&d(x,n)}))}else typeof t=="object"&&d(t,n)}loadURL(t,n={}){this.fire(new s.z("dataloading",{dataType:"style"}));const c=typeof n.validate=="boolean"?n.validate:!s.h(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,n.accessToken),this.resolvedImports.add(t);const d=this.importsCache.get(t);if(d)return this._load(d,c);const p=this.map._requestManager.transformRequest(t,s.R.Style);this._request=s.m(p,((m,y)=>{if(this._request=null,m)this.fire(new s.y(m));else if(y)return this.importsCache.set(t,y),this._load(y,c)}))}loadJSON(t,n={}){this.fire(new s.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=s.o.frame((()=>{this._request=null,this._load(t,n.validate!==!1)}))}loadEmpty(){this.fire(new s.z("dataloading",{dataType:"style"})),this._load(yh,!1)}_loadImports(t,n,c){if(this.importDepth>=4)return s.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const d=[];for(const p of t){const m=this._createFragmentStyle(p),y=new Promise((S=>{m.once("style.import.load",S),m.once("error",S)})).then((()=>this.mergeAll()));if(d.push(y),this.resolvedImports.has(p.url)){m.loadEmpty();continue}const x=p.data||this.importsCache.get(p.url);x?(m.loadJSON(x,{validate:n}),this._isInternalStyle(x)&&(m.globalId=null)):p.url?m.loadURL(p.url,{validate:n}):m.loadEmpty();const T={style:m,id:p.id,config:p.config};if(c){const S=this.fragments.findIndex((({id:M})=>M===c));this.fragments=this.fragments.slice(0,S).concat(T).concat(this.fragments.slice(S))}else this.fragments.push(T)}return Promise.allSettled(d)}getImportGlobalIds(t=this,n=new Set){for(const c of t.fragments)c.style.globalId&&n.add(c.style.globalId),this.getImportGlobalIds(c.style,n);return[...n.values()]}_createFragmentStyle(t){const n=this.scope?s.B(t.id,this.scope):t.id;let c;const d=this._initialConfig&&this._initialConfig[n];(t.config||d)&&(c=Object.assign({},t.config,d));const p=new rs(this.map,{scope:n,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:c,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers,indoorDependentLayers:this._indoorDependentLayers});return p.setEventedParent(this.map,{style:p}),p}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this._updateLayers(this._indoorDependentLayers),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,n){if(this._isInternalStyle(t)){const p=Object.assign({},yh,{imports:[{id:"basemap",data:t,url:""}]},t.center?{center:t.center}:{},t.bearing?{bearing:t.bearing}:{},t.pitch?{pitch:t.pitch}:{},t.zoom?{zoom:t.zoom}:{},t.light?{light:t.light}:{});return this._importedAsBasemap=!0,void this._load(p,n)}if(this.updateConfig(this._config,t.schema),n&&Qs(this,Kr(t)))return;this._loaded=!0,this.stylesheet=s.dn(t);const c=()=>{for(const x in t.sources)this.addSource(x,t.sources[x],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(const x in t.iconsets)this.addIconset(x,t.iconsets[x]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);const p=Na(this.stylesheet.layers);if(this._order=p.map((x=>x.id)),this.stylesheet.light&&s.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const x=this.stylesheet.lights[0];this.light=new ae(x.properties,x.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new ae(this.stylesheet.light)),this._layers={};for(const x of p){const T=s.dt(x,this.scope,this._styleColorTheme.lut,this.options);T.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(T.fqid),T.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(T.fqid),this._hasAppearances=this._hasAppearances||T.getAppearances().length!==0,T.setEventedParent(this,{layer:{id:T.id}}),this._layers[T.id]=T;const S=this.getOwnLayerSourceCache(T),M=!!this.directionalLight&&this.directionalLight.shadowsEnabled();S&&T.canCastShadows()&&M&&(S.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const m=this.stylesheet.terrain;m&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(m,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new s.z("data",{dataType:"style"}));const y=this.isRootStyle();t.imports?this._loadImports(t.imports,n).then((()=>{this._reloadImports(),this.fire(new s.z(y?"style.load":"style.import.load"))})).catch((x=>{this.fire(new s.y(new Error("Failed to load imports",x))),this.fire(new s.z(y?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new s.z(y?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const d=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(d){const p=this._evaluateColorThemeData(d);this._loadColorTheme(p).then((()=>{c()})).catch((m=>{s.w("Couldn't load color theme from the stylesheet: ".concat(m)),c()}))}else this._styleColorTheme.lut=null,c()}isRootStyle(){return this.importDepth===0}hasAppearances(){return this._hasAppearances}mergeAll(){let t,n,c,d,p,m,y,x,T,S;const M={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((E=>{if(E.stylesheet){if(E.light!=null&&(t=E.light),E.stylesheet.lights)for(const C of E.stylesheet.lights)C.type==="ambient"&&E.ambientLight!=null&&(n=E.ambientLight),C.type==="directional"&&E.directionalLight!=null&&(c=E.directionalLight);d=this._prioritizeTerrain(d,E.terrain,E.stylesheet.terrain),E.stylesheet.fog&&E.fog!=null&&(p=E.fog),E.stylesheet.snow&&E.snow!=null&&(m=E.snow),E.stylesheet.rain&&E.rain!=null&&(y=E.rain),E.stylesheet.camera!=null&&(S=E.stylesheet.camera),E.stylesheet.projection!=null&&(x=E.stylesheet.projection),E.stylesheet.transition!=null&&(T=E.stylesheet.transition),M[E.scope]=E._styleColorTheme}})),this.light=t,this.ambientLight=n,this.directionalLight=c,this.fog=p,this.snow=m,this.rain=y,this._styleColorThemeForScope=M,d===null?delete this.terrain:this.terrain=d,this.camera=S||{"camera-projection":"perspective"},this.projection=x||{name:"mercator"},this.transition=Object.assign({},xh,T),this.mergeSources(),this.mergeLayers(),this.mergeIndoor()}forEachFragmentStyle(t){const n=c=>{for(const d of c.fragments)n(d.style);t(c)};n(this)}_prioritizeTerrain(t,n,c){const d=t&&t.drapeRenderMode===0;return c===null?n&&n.drapeRenderMode===0?n:d?t:null:n!=null&&(!t||d||n&&n.drapeRenderMode===1)?n:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((n=>{t=this._prioritizeTerrain(t,n.terrain,n.stylesheet.terrain)})),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle((n=>{n.stylesheet.projection!=null&&(t=n.stylesheet.projection)})),this.projection=t||{name:"mercator"}}mergeSources(){const t={},n={},c={};this.forEachFragmentStyle((d=>{for(const p in d._sourceCaches){const m=s.B(p,d.scope);t[m]=d._sourceCaches[p]}for(const p in d._otherSourceCaches){const m=s.B(p,d.scope);n[m]=d._otherSourceCaches[p]}for(const p in d._symbolSourceCaches){const m=s.B(p,d.scope);c[m]=d._symbolSourceCaches[p]}})),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=n,this._mergedSymbolSourceCaches=c}mergeIndoor(){this.forEachFragmentStyle((t=>{if(t.stylesheet&&t.stylesheet.indoor)for(const n of Object.values(t.stylesheet.indoor)){const c=n,d=s.B(c.sourceId,t.scope);this._mergedIndoor[d]=new Set(c.sourceLayers||[])}}))}mergeLayers(){const t={},n=[],c={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((m=>{for(const y of m._order){const x=m._layers[y];if(x.type==="slot"){const T=s.dp(y);if(t[T])continue;t[T]=[]}x.slot&&t[x.slot]?t[x.slot].push(x):n.push(x)}})),this._mergedOrder=[];let d=-1;const p=(m=[])=>{for(const y of m)if(y.type==="slot"){const x=s.dp(y.id);t[x]&&p(t[x]),this._mergedSlots.push(x)}else{const x=s.B(y.id,y.scope);this._mergedOrder.push(x),c[x]=y,y.is3D(!!this.terrain)&&(this._has3DLayers=!0,d=this._mergedOrder.length-1),y.type==="circle"&&(this._hasCircleLayers=!0),y.type==="symbol"&&(this._hasSymbolLayers=!0),y.type==="clip"&&(this._clipLayerPresent=!0)}};if(p(n),this._has3DLayers){const m={};for(let y=0;y<this._mergedOrder.length;++y){const x=this._mergedOrder[y];m[x]=y===d?1:y<d?c[x].hasOcclusionOpacityProperties?2:0:4}this._mergedOrder.sort(((y,x)=>m[y]-m[x]))}this._mergedLayers=c,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=Object.assign({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?(function(n,c,d,p){const m=Object.assign({},c);for(const x of Object.keys(Jl))m[x]===void 0&&(m[x]=Jl[x].default);const y=new s.a8(Js,n,new Map(d));return y.setTransitionOrValue(m,d),y.untransitioned().possiblyEvaluate(new s.ac(0,{worldview:void 0}))})(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const n=this._styleColorTheme.lutLoadingCorrelationID;return new Promise(((c,d)=>{const p="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void c();let m=t;m.startsWith(p)||(m=p+m);const y=s.I.from("mapbox-reserved-lut"),x=new Image;x.src=m,x.onerror=()=>{this._styleColorTheme.lutLoading=!1,d(new Error("Failed to load image data"))},x.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==n)return void c();this._styleColorTheme.lutLoading=!1;const{width:T,height:S,data:M}=s.o.getImageData(x);if(S>32)return void d(new Error("The height of the image must be less than or equal to 32 pixels."));if(T!==S*S)return void d(new Error("The width of the image must be equal to the height squared."));this.getImage(y)&&this.removeImage(y),this.addImage(y,{data:new s.q({width:T,height:S},M),pixelRatio:1,sdf:!1,usvg:!1,version:0});const E=this.imageManager.getImage(y,this.scope);E?(this._styleColorTheme.lut={image:E.data,data:t},c()):d(new Error("Missing LUT image."))}}))}getLut(t){const n=this._styleColorThemeForScope[t];return n?n.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=(function(n,c,d){let p,m,y;const x=s.o.devicePixelRatio>1?"@2x":"";let T=s.m(c.transformRequest(c.normalizeSpriteURL(n,x,".json"),s.R.SpriteJSON),((E,C)=>{T=null,y||(y=E,p=C,M())})),S=s.n(c.transformRequest(c.normalizeSpriteURL(n,x,".png"),s.R.SpriteImage),((E,C)=>{S=null,y||(y=E,m=C,M())}));function M(){if(y)d(y);else if(p&&m){const E=s.o.getImageData(m),C={};for(const R in p){const{width:z,height:N,x:k,y:U,sdf:$,pixelRatio:G,stretchX:ee,stretchY:Z,content:ie}=p[R],Q=new s.q({width:z,height:N});s.q.copy(E,Q,{x:k,y:U},{x:0,y:0},{width:z,height:N},null),C[R]={data:Q,pixelRatio:G!==void 0?G:1,sdf:$!==void 0&&$,stretchX:ee,stretchY:Z,content:ie,usvg:!1,version:0}}d(null,C)}}return{cancel(){T&&(T.cancel(),T=null),S&&(S.cancel(),S=null)}}})(t,this.map._requestManager,((n,c)=>{if(this._spriteRequest=null,n)this.fire(new s.y(n));else if(c){const d=new Map;for(const p in c)d.set(s.I.from(p),c[p]);this.addImages(d)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.z("data",{dataType:"style"}))}))}addIconset(t,n){if(n.type==="sprite")return void this._loadSprite(n.url);const c=this.getOwnSourceCache(n.source);if(!c)return void this.fire(new s.y(new Error('Source "'.concat(n.source,'" as specified by iconset "').concat(t,'" does not exist and cannot be used as an iconset source'))));const d=c.getSource();if(d.type!=="raster-array")return void this.fire(new s.y(new Error('Source "'.concat(n.source,'" as specified by iconset "').concat(t,'" is not a "raster-array" source and cannot be used as an iconset source'))));d.partial=!1;const p=new wm(t,this.scope,c);this.imageManager.addImageProvider(p,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!s.h(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);const n=this.map._spriteFormat==="auto";var c,d;this._spriteRequest=(d=(p,m)=>{if(this._spriteRequest=null,p)n?this._loadSprite(t):this.fire(new s.y(p));else if(m){const y=new Map;for(const x in m)y.set(s.I.from(x),m[x]);this.addImages(y)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.z("data",{dataType:"style"}))},s.bt((c=this.map._requestManager).transformRequest(c.normalizeIconsetURL(t),s.R.Iconset),((p,m)=>{if(p)return void d(p);const y={},x=s.df(new s.bs(m));for(const T of x.icons){const S={version:1,pixelRatio:s.o.devicePixelRatio,content:bm(T),stretchX:T.metadata?If(T.metadata.stretch_x_areas):void 0,stretchY:T.metadata?If(T.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:T};y[T.name]=S}d(null,y)})))}_validateLayer(t){const n=this.getOwnSource(t.source);if(!n)return;const c=t.sourceLayer;c&&(n.type==="geojson"||n.vectorLayerIds&&n.vectorLayerIds.indexOf(c)===-1)&&this.fire(new s.y(new Error('Source layer "'.concat(c,'" does not exist on source "').concat(n.id,'" as specified by style layer "').concat(t.id,'"'))))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((t,n)=>{const c=this.fragments[n];return c&&c.style&&(t.data=c.style.serialize()),t}))}_serializeSources(){const t={};for(const n in this._sourceCaches){const c=this._sourceCaches[n].getSource();t[c.id]||(t[c.id]=c.serialize())}return t}_serializeLayers(t){const n=[];for(const c of t){const d=this._layers[c];d&&d.type!=="custom"&&n.push(d.serialize())}return n}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const n=this.getOwnLayer(t);if(n)return n;this.fire(new s.y(new Error("The layer '".concat(t,"' does not exist in the map's style."))))}_checkSource(t){const n=this.getOwnSource(t);if(n)return n;this.fire(new s.y(new Error("The source '".concat(t,"' does not exist in the map's style."))))}precompilePrograms(t,n){const c=this.map.painter;if(c)for(let d=t.minzoom||0;d<(t.maxzoom||25.5);d++){const p=t.getProgramIds();if(p)for(const m of p){const y=t.getDefaultProgramParams(m,n.zoom,this._styleColorTheme.lut);y&&(c.style=this,this.fog&&(c._fogVisible=!0,y.overrideFog=!0,c.getOrCreateProgram(m,y)),c._fogVisible=!1,y.overrideFog=!1,c.getOrCreateProgram(m,y),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(y.overrideRtt=!0,c.getOrCreateProgram(m,y)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const n=this.calculateLightsBrightness();t.brightness=n||0,n!==this._brightness&&(this._brightness=n,this.dispatcher.broadcast("setBrightness",n)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const c=this._changes.isDirty();let d=!1;if(this._changes.isDirty()){const y=this._changes.getLayerUpdatesByScope();for(const x in y){const{updatedIds:T,removedIds:S}=y[x];(T||S)&&(this._updateWorkerLayers(x,T,S),d=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const p={};for(const y in this._mergedSourceCaches){const x=this._mergedSourceCaches[y];p[y]=x.used,x.used=!1,x.tileCoverLift=0}for(const y of this._mergedOrder){const x=this._mergedLayers[y];if(x.recalculate(t,this._availableImages),!x.isHidden(t.zoom)){const T=this.getLayerSourceCache(x);T&&(T.used=!0,T.tileCoverLift=Math.max(T.tileCoverLift,x.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback((()=>{this.precompilePrograms(x,t)})):this.precompilePrograms(x,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&d&&this.mergeLayers();const m=this.imageManager.getPendingImageProviders();for(const y of m)y.sourceCache.used=!0;for(const y in p){const x=this._mergedSourceCaches[y];p[y]!==x.used&&x.getSource().fire(new s.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:x.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),c&&this.fire(new s.z("data",{dataType:"style"}))}updateImageProviders(){const t=this.imageManager.getPendingImageProviders();for(const n of t){const c=n.resolvePendingRequests(),d=this.getFragmentStyle(n.scope);d&&d.addImages(c)}}_updateTilesForChangedImages(){const t={};for(const n in this._mergedSourceCaches){const c=this._mergedSourceCaches[n].getSource().scope;t[c]=t[c]||this._changes.getUpdatedImages(c),t[c].length!==0&&this._mergedSourceCaches[n].reloadTilesForDependencies(["icons","patterns"],t[c])}for(const n in t)this._changes.resetUpdatedImages(n)}_updateWorkerLayers(t,n,c){const d=this.getFragmentStyle(t);d&&this.dispatcher.broadcast("updateLayers",{layers:n?d._serializeLayers(n):[],scope:t,removedIds:c||[],options:d.options})}setState(t,n){if(this._checkLoaded(),Qs(this,Kr(t)))return!1;(t=s.dn(t)).layers=Na(t.layers);const c=(function(m,y){if(!m)return[{command:Fi.setStyle,args:[y]}];let x=[];try{if(!s.bx(m.version,y.version))return[{command:Fi.setStyle,args:[y]}];if(s.bx(m.center,y.center)||x.push({command:Fi.setCenter,args:[y.center]}),s.bx(m.zoom,y.zoom)||x.push({command:Fi.setZoom,args:[y.zoom]}),s.bx(m.bearing,y.bearing)||x.push({command:Fi.setBearing,args:[y.bearing]}),s.bx(m.pitch,y.pitch)||x.push({command:Fi.setPitch,args:[y.pitch]}),s.bx(m.sprite,y.sprite)||x.push({command:Fi.setSprite,args:[y.sprite]}),s.bx(m.glyphs,y.glyphs)||x.push({command:Fi.setGlyphs,args:[y.glyphs]}),s.bx(m.imports,y.imports)||(function(C=[],R=[],z){R=R||[];const N=(C=C||[]).map(Nl),k=R.map(Nl),U=C.reduce(Vl,{}),$=R.reduce(Vl,{}),G=N.slice();let ee,Z,ie,Q;for(ee=0,Z=0;ee<N.length;ee++)ie=N[ee],$.hasOwnProperty(ie)?Z++:(z.push({command:Fi.removeImport,args:[ie]}),G.splice(G.indexOf(ie,Z),1));for(ee=0,Z=0;ee<k.length;ee++)ie=k[k.length-1-ee],G[G.length-1-ee]!==ie&&(U.hasOwnProperty(ie)?(z.push({command:Fi.removeImport,args:[ie]}),G.splice(G.lastIndexOf(ie,G.length-Z),1)):Z++,Q=G[G.length-ee],z.push({command:Fi.addImport,args:[$[ie],Q]}),G.splice(G.length-ee,0,ie));for(const Y of R){const re=U[Y.id];re&&(delete re.data,s.bx(re,Y)||z.push({command:Fi.updateImport,args:[Y.id,Y]}))}})(m.imports,y.imports,x),s.bx(m.transition,y.transition)||x.push({command:Fi.setTransition,args:[y.transition]}),s.bx(m.light,y.light)||x.push({command:Fi.setLight,args:[y.light]}),s.bx(m.fog,y.fog)||x.push({command:Fi.setFog,args:[y.fog]}),s.bx(m.snow,y.snow)||x.push({command:Fi.setSnow,args:[y.snow]}),s.bx(m.rain,y.rain)||x.push({command:Fi.setRain,args:[y.rain]}),s.bx(m.projection,y.projection)||x.push({command:Fi.setProjection,args:[y.projection]}),s.bx(m.lights,y.lights)||x.push({command:Fi.setLights,args:[y.lights]}),s.bx(m.camera,y.camera)||x.push({command:Fi.setCamera,args:[y.camera]}),s.bx(m.iconsets,y.iconsets)||(function(C,R,z){let N;for(N in R=R||{},C=C||{})C.hasOwnProperty(N)&&(R.hasOwnProperty(N)||z.push({command:Fi.removeIconset,args:[N]}));for(N in R){if(!R.hasOwnProperty(N))continue;const k=R[N];C.hasOwnProperty(N)?s.bx(C[N],k)||(z.push({command:Fi.removeIconset,args:[N]}),z.push({command:Fi.addIconset,args:[N,k]})):z.push({command:Fi.addIconset,args:[N,k]})}})(m.iconsets,y.iconsets,x),!s.bx(m["color-theme"],y["color-theme"]))return[{command:Fi.setStyle,args:[y]}];const T={},S=[];(function(C,R,z,N){let k;for(k in R=R||{},C=C||{})C.hasOwnProperty(k)&&(R.hasOwnProperty(k)||Fl(k,z,N));for(k in R){if(!R.hasOwnProperty(k))continue;const U=R[k];C.hasOwnProperty(k)?s.bx(C[k],U)||(C[k].type==="geojson"&&U.type==="geojson"&&uh(C,R,k)?z.push({command:Fi.setGeoJSONSourceData,args:[k,U.data]}):kl(k,R,z,N)):ch(k,R,z)}})(m.sources,y.sources,S,T);const M=[];m.layers&&m.layers.forEach((C=>{C.source&&T[C.source]?x.push({command:Fi.removeLayer,args:[C.id]}):M.push(C)}));let E=m.terrain;E&&T[E.source]&&(x.push({command:Fi.setTerrain,args:[void 0]}),E=void 0),x=x.concat(S),s.bx(E,y.terrain)||x.push({command:Fi.setTerrain,args:[y.terrain]}),(function(C,R,z){R=R||[];const N=(C=C||[]).map(Nl),k=R.map(Nl),U=C.reduce(Vl,{}),$=R.reduce(Vl,{}),G=N.slice(),ee=Object.create(null);let Z,ie,Q,Y,re,_e,he;for(Z=0,ie=0;Z<N.length;Z++)Q=N[Z],$.hasOwnProperty(Q)?ie++:(z.push({command:Fi.removeLayer,args:[Q]}),G.splice(G.indexOf(Q,ie),1));for(Z=0,ie=0;Z<k.length;Z++)Q=k[k.length-1-Z],G[G.length-1-Z]!==Q&&(U.hasOwnProperty(Q)?(z.push({command:Fi.removeLayer,args:[Q]}),G.splice(G.lastIndexOf(Q,G.length-ie),1)):ie++,_e=G[G.length-Z],z.push({command:Fi.addLayer,args:[$[Q],_e]}),G.splice(G.length-Z,0,Q),ee[Q]=!0);for(Z=0;Z<k.length;Z++)if(Q=k[Z],Y=U[Q],re=$[Q],!ee[Q]&&!s.bx(Y,re))if(s.bx(Y.source,re.source)&&s.bx(Y["source-layer"],re["source-layer"])&&s.bx(Y.type,re.type)){for(he in Bl(Y.layout,re.layout,z,Q,null,Fi.setLayoutProperty),Bl(Y.paint,re.paint,z,Q,null,Fi.setPaintProperty),s.bx(Y.slot,re.slot)||z.push({command:Fi.setSlot,args:[Q,re.slot]}),s.bx(Y.filter,re.filter)||z.push({command:Fi.setFilter,args:[Q,re.filter]}),s.bx(Y.minzoom,re.minzoom)&&s.bx(Y.maxzoom,re.maxzoom)||z.push({command:Fi.setLayerZoomRange,args:[Q,re.minzoom,re.maxzoom]}),Y)Y.hasOwnProperty(he)&&he!=="layout"&&he!=="paint"&&he!=="filter"&&he!=="metadata"&&he!=="minzoom"&&he!=="maxzoom"&&he!=="slot"&&(he.indexOf("paint.")===0?Bl(Y[he],re[he],z,Q,he.slice(6),Fi.setPaintProperty):s.bx(Y[he],re[he])||z.push({command:Fi.setLayerProperty,args:[Q,he,re[he]]}));for(he in re)re.hasOwnProperty(he)&&!Y.hasOwnProperty(he)&&he!=="layout"&&he!=="paint"&&he!=="filter"&&he!=="metadata"&&he!=="minzoom"&&he!=="maxzoom"&&he!=="slot"&&(he.indexOf("paint.")===0?Bl(Y[he],re[he],z,Q,he.slice(6),Fi.setPaintProperty):s.bx(Y[he],re[he])||z.push({command:Fi.setLayerProperty,args:[Q,he,re[he]]}))}else z.push({command:Fi.removeLayer,args:[Q]}),_e=G[G.lastIndexOf(Q)+1],z.push({command:Fi.addLayer,args:[re,_e]})})(M,y.layers,x)}catch(T){console.warn("Unable to compute style diff:",T),x=[{command:Fi.setStyle,args:[y]}]}return x})(this.serialize(),t).filter((m=>!(m.command in gh)));if(c.length===0)return!1;const d=c.filter((m=>!(m.command in Tm)));if(d.length>0)throw new Error("Unimplemented: ".concat(d.map((m=>m.command)).join(", "),"."));const p=[];return c.forEach((m=>{p.push(this[m.command](...m.args))})),n&&Promise.all(p).then(n).catch(n),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(t.size===0)return this;for(const[n,c]of t.entries()){if(this.getImage(n))return this.fire(new s.y(new Error('An image with the name "'.concat(n.name,'" already exists.'))));this.imageManager.addImage(n,this.scope,c),this._changes.updateImage(n,this.scope)}return this._updateWorkerImages(),this.fire(new s.z("data",{dataType:"style"})),this}addImage(t,n){return this.getImage(t)?this.fire(new s.y(new Error('An image with the name "'.concat(t.name,'" already exists.')))):(this.imageManager.addImage(t,this.scope,n),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new s.z("data",{dataType:"style"})),this)}updateImage(t,n,c=!1){this.imageManager.updateImage(t,this.scope,n),c&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new s.z("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new s.z("data",{dataType:"style"})),this):this.fire(new s.y(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new s.z("data",{dataType:"style"})),this}addModel(t,n,c={}){return this._checkLoaded(),this._validate(ds,"models.".concat(t),n,null,c)||(this.modelManager.addModel(t,n,this.scope),this.fire(new s.z("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope,!1,!0),this.fire(new s.z("data",{dataType:"style"})),this):this.fire(new s.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,n,c={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error('There is already a source with ID "'.concat(t,'".'));if(!n.type)throw new Error("The type property must be defined, but only the following properties were given: ".concat(Object.keys(n).join(", "),"."));if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(Un,"sources.".concat(t),n,null,c))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const d=io(t,n,this.dispatcher,this);d.scope=this.scope,d.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(d.id),source:d.serialize(),sourceId:d.id})));const p=m=>{const y=(m?"symbol:":"other:")+d.id,x=s.B(y,this.scope),T=this._sourceCaches[y]=new Qo(x,d,m);(m?this._symbolSourceCaches:this._otherSourceCaches)[d.id]=T,T.onAdd(this.map)};p(!1),n.type!=="vector"&&n.type!=="geojson"||p(!0),d.onAdd&&d.onAdd(this.map),c.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const n=this.getOwnSource(t);if(!n)throw new Error("There is no source with this ID");for(const d in this._layers)if(this._layers[d].source===t)return this.fire(new s.y(new Error('Source "'.concat(t,'" cannot be removed while layer "').concat(d,'" is using it.'))));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new s.y(new Error('Source "'.concat(t,'" cannot be removed while terrain is using it.'))));if(this.stylesheet.iconsets){const d=Object.entries(this.stylesheet.iconsets).find((([p,m])=>m.type==="source"&&m.source===t));if(d)return this.fire(new s.y(new Error('Source "'.concat(t,'" cannot be removed while iconset "').concat(d[0],'" is using it.'))))}const c=this.getOwnSourceCaches(t);for(const d of c){const p=s.dp(d.id);delete this._sourceCaches[p],this._changes.discardSourceCacheUpdate(d.id),d.fire(new s.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:d.getSource().id})),d.setEventedParent(null),d.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),n.setEventedParent(null),n.onRemove&&n.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,n){this._checkLoaded(),this.getOwnSource(t).setData(n),this._changes.setDirty()}getOwnSource(t){const n=this.getOwnSourceCache(t);return n&&n.getSource()}getOwnSources(){const t=[];for(const n in this._otherSourceCaches){const c=this.getOwnSourceCache(n);c&&t.push(c.getSource())}return t}areTilesLoaded(){const t=this._mergedSourceCaches;for(const n in t){const c=t[n]._tiles;for(const d in c){const p=c[d];if(p.state!=="loaded"&&p.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const n=this._getTransitionParameters();for(const p of t){if(this._validate(eo,"lights",p))return;switch(p.type){case"ambient":if(this.ambientLight){const m=this.ambientLight;m.set(p),m.updateTransitions(n)}else this.ambientLight=new Ur(p,Xi||(Xi=new s.a9({color:new s.aa(s.a6.properties_light_ambient.color),"color-use-theme":new s.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.aa(s.a6.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const m=this.directionalLight;m.set(p),m.updateTransitions(n)}else this.directionalLight=new Ur(p,Fr||(Fr=new s.a9({direction:new s.ap(s.a6.properties_light_directional.direction),color:new s.aa(s.a6.properties_light_directional.color),"color-use-theme":new s.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.aa(s.a6.properties_light_directional.intensity),"cast-shadows":new s.aa(s.a6.properties_light_directional["cast-shadows"]),"shadow-quality":new s.aa(s.a6.properties_light_directional["shadow-quality"]),"shadow-intensity":new s.aa(s.a6.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const c=Object.assign(n,{worldview:this.map.getWorldview()}),d=new s.ac(this.z||0,c);this.ambientLight&&this.ambientLight.recalculate(d),this.directionalLight&&this.directionalLight.recalculate(d),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,n=this.ambientLight;if(!t||!n)return;const c=E=>.2126*(E[0]<=.03928?E[0]/12.92:Math.pow((E[0]+.055)/1.055,2.4))+.7152*(E[1]<=.03928?E[1]/12.92:Math.pow((E[1]+.055)/1.055,2.4))+.0722*(E[2]<=.03928?E[2]/12.92:Math.pow((E[2]+.055)/1.055,2.4)),d=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),p=t.properties.get("intensity"),m=t.properties.get("direction"),y=1-s.d3(m.x,m.y,m.z)[2]/90,x=c(d)*p*y,T=n.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),S=n.properties.get("intensity"),M=c(T)*S;return Number(((x+M)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(s.dq(t)){const n=s.dr(t),c=this.fragments.find((({id:p})=>p===n));if(!c)return;const d=s.dp(t);return c.style.getFragmentStyle(d)}{const n=this.fragments.find((({id:c})=>c===t));return n?n.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const n={},c=(d,p="")=>"".concat(d,"::").concat(p);this._featuresetSelectors={};for(const d in t){const p=this._featuresetSelectors[d]=[];for(const m of t[d].selectors){if(m.featureNamespace){const x=this.getOwnLayer(m.layer);if(!x){s.w("Layer is undefined for selector: ".concat(m.layer));continue}const T=c(x.source,x.sourceLayer);if(T in n&&n[T]!==m.featureNamespace){s.w('"featureNamespace '.concat(m.featureNamespace," of featureset ").concat(d,"'s selector is not associated to the same source, skip this selector"));continue}n[T]=m.featureNamespace}let y;if(m.properties)for(const x in m.properties){const T=s.U(m.properties[x]);T.result==="success"&&(y=y||{},y[x]=T.value)}p.push({layerId:m.layer,namespace:m.featureNamespace,properties:y,uniqueFeatureID:m._uniqueFeatureID})}}}getFeaturesetDescriptors(t){const n=this.getFragmentStyle(t);if(!n||!n.stylesheet.featuresets)return[];const c=[];for(const d in n.stylesheet.featuresets)c.push({featuresetId:d,importId:n.scope?n.scope:void 0});return c}getFeaturesetLayers(t,n){const c=this.getFragmentStyle(n),d=c.stylesheet.featuresets;if(!d||!d[t])return this.fire(new s.y(new Error("The featureset '".concat(t,"' does not exist in the map's style and cannot be queried.")))),[];const p=[];for(const m of d[t].selectors){const y=c.getOwnLayer(m.layer);y&&p.push(y)}return p}getConfigProperty(t,n){const c=this.getFragmentStyle(t);if(!c)return null;const d=s.B(n,c.scope),p=c.options.get(d),m=p?p.value||p.default:null;return m?m.serialize():null}isIndoorEnabled(){return Object.keys(this._mergedIndoor).length>0}getIndoorSourceLayers(t,n){const c=s.B(t,n);return this._mergedIndoor[c]}setIndoorData(t,n){this.map.indoor.setIndoorData(n)}updateIndoorDependentLayers(){this._updateLayers(this._indoorDependentLayers),this.map._styleDirty=!0,this.map.triggerRepaint()}setConfigProperty(t,n,c){const d=this.getFragmentStyle(t);if(!d)return;const p=d.stylesheet.schema;if(!p||!p[n])return;const m=s.U(c);if(m.result!=="success")return void Qs(this,m.value);const y=m.value.expression,x=s.B(n,d.scope),T=d.options.get(x);if(!T)return;let S;const{minValue:M,maxValue:E,stepValue:C,type:R,values:z}=p[n],N=s.U(p[n].default);N.result==="success"&&(S=N.value.expression),S?(this.options.set(x,Object.assign({},T,{value:y,default:S,minValue:M,maxValue:E,stepValue:C,type:R,values:z})),this.updateConfigDependencies(n)):this.fire(new s.y(new Error('No schema defined for the config option "'.concat(n,'" in the "').concat(t,'" fragment.'))))}getConfig(t){const n=this.getFragmentStyle(t);if(!n)return null;const c=n.stylesheet.schema;if(!c)return null;const d={};for(const p in c){const m=s.B(p,n.scope),y=n.options.get(m),x=y?y.value||y.default:null;d[p]=x?x.serialize():null}return d}setConfig(t,n){const c=this.getFragmentStyle(t);c&&(c.updateConfig(n,c.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){const n=this.getFragmentStyle(t);return n?n.stylesheet.schema:null}setSchema(t,n){const c=this.getFragmentStyle(t);c&&(c.stylesheet.schema=n,c.updateConfig(c._config,n),this.updateConfigDependencies())}updateConfig(t,n){if(this._config=t,t||n)if(n)for(const c in n){let d,p;const m=s.U(n[c].default);if(m.result==="success"&&(d=m.value.expression),t&&t[c]!==void 0){const E=s.U(t[c]);E.result==="success"&&(p=E.value.expression)}const{minValue:y,maxValue:x,stepValue:T,type:S,values:M}=n[c];if(d){const E=s.B(c,this.scope);this.options.set(E,{default:d,value:p,minValue:y,maxValue:x,stepValue:T,type:S,values:M})}else this.fire(new s.y(new Error('No schema defined for config option "'.concat(c,'".'))))}else this.fire(new s.y(new Error("Attempting to set config for a style without schema.")))}_updateLayers(t,n=(()=>!0)){for(const c of t){const d=this.getLayer(c);d&&n(d)&&(d.possiblyEvaluateVisibility(),this._updateLayer(d),this._changes.setDirty())}}updateConfigDependencies(t){this._updateLayers(this._configDependentLayers,(n=>!t||n.expressionDependencies.configDependencies.has(t))),this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle((n=>{const c=n._styleColorTheme.colorThemeOverride?n._styleColorTheme.colorThemeOverride:n._styleColorTheme.colorTheme;if(c){const d=n._evaluateColorThemeData(c);(!n._styleColorTheme.lut&&d!==""||n._styleColorTheme.lut&&d!==n._styleColorTheme.lut.data)&&n.setColorTheme(c)}})),this._changes.setDirty()}addLayer(t,n,c={}){this._checkLoaded();const d=t.id;if(this._layers[d])return void this.fire(new s.y(new Error('Layer with id "'.concat(d,'" already exists on this map'))));let p;if(t.type==="custom"){if(Qs(this,s.ds(t)))return;p=s.dt(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(d,t.source),t=s.dn(t),t=Object.assign(t,{source:d})),this._validate(bo,"layers.".concat(d),t,{arrayIndex:-1},c))return;p=s.dt(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(p),p.setEventedParent(this,{layer:{id:d}})}const m=s.B(p.source,p.scope);p.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(m),p.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(m);let y=this._order.length;if(n){const M=this._order.indexOf(n);if(M===-1)return void this.fire(new s.y(new Error('Layer with id "'.concat(n,'" does not exist on this map.'))));p.slot===this._layers[n].slot?y=M:s.w('Layer with id "'.concat(n,'" has a different slot. Layers can only be rearranged within the same slot.'))}this._order.splice(y,0,d),this._layerOrderChanged=!0,this._layers[d]=p;const x=this.getOwnLayerSourceCache(p),T=!!this.directionalLight&&this.directionalLight.shadowsEnabled();x&&p.canCastShadows()&&T&&(x.castsShadows=!0);const S=this._changes.getRemovedLayer(p);if(S&&p.source&&x&&p.type!=="custom"){this._changes.discardLayerRemoval(p);const M=s.B(p.source,p.scope);S.type!==p.type?this._changes.updateSourceCache(M,"clear"):(this._changes.updateSourceCache(M,"reload"),x.pause())}this._updateLayer(p),p.onAdd&&p.onAdd(this.map),p.scope=this.scope,this.mergeLayers()}moveLayer(t,n){this._checkLoaded();const c=this._checkLayer(t);if(!c||t===n)return;const d=this._order.indexOf(t);this._order.splice(d,1);let p=this._order.length;if(n){const m=this._order.indexOf(n);if(m===-1)return void this.fire(new s.y(new Error('Layer with id "'.concat(n,'" does not exist on this map.'))));c.slot===this._layers[n].slot?p=m:s.w('Layer with id "'.concat(n,'" has a different slot. Layers can only be rearranged within the same slot.'))}this._order.splice(p,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const n=this._checkLayer(t);if(!n)return;n.setEventedParent(null);const c=this._order.indexOf(t);this._order.splice(c,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(n.fqid),this._indoorDependentLayers.delete(n.fqid),this._changes.removeLayer(n);const d=this.getOwnLayerSourceCache(n);if(d&&d.castsShadows){let p=!1;for(const m in this._layers)if(this._layers[m].source===n.source&&this._layers[m].canCastShadows()){p=!0;break}d.castsShadows=p}n.onRemove&&n.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const n in this._layers)if(this._layers[n].type===t)return!0;return!1}setLayerZoomRange(t,n,c){this._checkLoaded();const d=this._checkLayer(t);d&&(d.minzoom===n&&d.maxzoom===c||(n!=null&&(d.minzoom=n),c!=null&&(d.maxzoom=c),this._updateLayer(d)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,n){this._checkLoaded();const c=this._checkLayer(t);c&&c.slot!==n&&(c.slot=n,this._updateLayer(c))}setFilter(t,n,c={}){this._checkLoaded();const d=this._checkLayer(t);if(d&&!s.bx(d.filter,n))return n==null?(d.filter=void 0,void this._updateLayer(d)):void(this._validate(ii,"layers.".concat(d.id,".filter"),n,{layerType:d.type},c)||(d.filter=s.dn(n),this._updateLayer(d)))}getFilter(t){const n=this._checkLayer(t);if(n)return s.dn(n.filter)}setLayoutProperty(t,n,c,d={}){this._checkLoaded();const p=this._checkLayer(t);if(p&&!s.bx(p.getLayoutProperty(n),c)){if(c!=null&&(!d||d.validate!==!1)&&Qs(p,Ps.call(Kr,{key:"layers.".concat(t,".layout.").concat(n),layerType:p.type,objectKey:n,value:c,styleSpec:s.a6,style:{glyphs:!0,sprite:!0}})))return;p.setLayoutProperty(n,c),p.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),p.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(p.fqid),this._updateLayer(p)}}setLayerProperty(t,n,c,d={}){this._checkLoaded();const p=this._checkLayer(t);p&&(n==="appearances"?(p.setAppearances(c),this._changes.setDirty()):p.isPaintProperty(n)?this.setPaintProperty(t,n,c,d):this.setLayoutProperty(t,n,c,d))}getLayoutProperty(t,n){const c=this._checkLayer(t);if(c)return c.getLayoutProperty(n)}setPaintProperty(t,n,c,d={}){this._checkLoaded();const p=this._checkLayer(t);if(!p||s.bx(p.getPaintProperty(n),c)||c!=null&&(!d||d.validate!==!1)&&Qs(p,Jr.call(Kr,{key:"layers.".concat(t,".paint.").concat(n),layerType:p.type,objectKey:n,value:c,styleSpec:s.a6})))return;const m=p.setPaintProperty(n,c);p.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),p.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(p.fqid),m&&this._updateLayer(p),this._changes.updatePaintProperties(p)}getPaintProperty(t,n){const c=this._checkLayer(t);if(c)return c.getPaintProperty(n)}setFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:x,importId:T}=t.target,S=this.getFragmentStyle(T),M=S.getFeaturesetLayers(x);for(const{source:E,sourceLayer:C}of M)S.setFeatureState({id:t.id,source:E,sourceLayer:C},n)}else if("layerId"in t.target){const{layerId:x}=t.target,T=this.getLayer(x);this.setFeatureState({id:t.id,source:T.source,sourceLayer:T.sourceLayer},n)}return}const c=t.source,d=t.sourceLayer,p=this._checkSource(c);if(!p)return;const m=p.type;if(m==="geojson"&&d)return void this.fire(new s.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(m==="vector"&&!d)return void this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new s.y(new Error("The feature id parameter must be provided.")));const y=this.getOwnSourceCaches(c);for(const x of y)x.setFeatureState(d,t.id,n)}removeFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:x,importId:T}=t.target,S=this.getFragmentStyle(T),M=S.getFeaturesetLayers(x);for(const{source:E,sourceLayer:C}of M)S.removeFeatureState({id:t.id,source:E,sourceLayer:C},n)}else if("layerId"in t.target){const{layerId:x}=t.target,T=this.getLayer(x);this.removeFeatureState({id:t.id,source:T.source,sourceLayer:T.sourceLayer},n)}return}const c=t.source,d=this._checkSource(c);if(!d)return;const p=d.type,m=p==="vector"?t.sourceLayer:void 0;if(p==="vector"&&!m)return void this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(n&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new s.y(new Error("A feature id is required to remove its specific state property.")));const y=this.getOwnSourceCaches(c);for(const x of y)x.removeFeatureState(m,t.id,n)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let p;if("featuresetId"in t.target){const{featuresetId:m,importId:y}=t.target,x=this.getFragmentStyle(y),T=x.getFeaturesetLayers(m);for(const{source:S,sourceLayer:M}of T){const E=x.getFeatureState({id:t.id,source:S,sourceLayer:M});if(E&&!p)p=E;else if(!s.bx(p,E))return void this.fire(new s.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:m}=t.target,y=this.getLayer(m);p=this.getFeatureState({id:t.id,source:y.source,sourceLayer:y.sourceLayer})}return p}const n=t.source,c=t.sourceLayer,d=this._checkSource(n);if(d){if(d.type!=="vector"||c)return t.id===void 0&&this.fire(new s.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(n)[0].getFeatureState(c,t.id);this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=Object.assign({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return Object.assign({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),n=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return s.du({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:n,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(c=>c!==void 0))}_updateFilteredLayers(t){for(const n of Object.values(this._mergedLayers))t(n)&&this._updateLayer(n)}_updateLayer(t){this._changes.updateLayer(t);const n=this.getLayerSourceCache(t),c=s.B(t.source,t.scope),d=this._changes.getUpdatedSourceCaches();t.source&&!d[c]&&n&&n.getSource().type!=="raster"&&(this._changes.updateSourceCache(c,"reload"),n.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const n=y=>this._mergedLayers[y].is3D(!!this.terrain),c=this.order,d={},p=[];for(let y=c.length-1;y>=0;y--){const x=c[y];if(n(x)){d[x]=y;for(const T of t){const S=T[x];if(S)for(const M of S)p.push(M)}}}p.sort(((y,x)=>x.intersectionZ-y.intersectionZ));const m=[];for(let y=c.length-1;y>=0;y--){const x=c[y];if(n(x))for(let T=p.length-1;T>=0;T--){const S=p[T].feature;if(S.layer&&d[S.layer.id]<y)break;m.push(S),p.pop()}else for(const T of t){const S=T[x];if(S)for(const M of S)m.push(M.feature)}}return m}queryRasterValue(t,n,c){const d=this.getOwnSource(t);return d?d.type!=="raster-array"?(this.fire(new s.y(new Error('queryRasterValue support only "raster-array" sources.'))),Promise.resolve(null)):d.queryRasterArrayValue(n,c):(this.fire(new s.y(new Error('Source with id "'.concat(t,'" does not exist in the style.')))),Promise.resolve(null))}queryRenderedFeatures(t,n,c){let d;n&&!Array.isArray(n)&&n.filter&&(this._validate(ii,"queryRenderedFeatures.filter",n.filter,null,n),d=s.b5(n.filter));const p={},m=S=>{if(Vc.has(S.type))return;const M=this.getOwnLayerSourceCache(S),E=p[M.id]=p[M.id]||{sourceCache:M,layers:{},has3DLayers:!1};S.is3D(!!this.terrain)&&(E.has3DLayers=!0),E.layers[S.fqid]=E.layers[S.fqid]||{styleLayer:S,targets:[]},E.layers[S.fqid].targets.push({filter:d})};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new s.y(new Error("parameters.layers must be an Array."))),[];for(const S of n.layers){const M=this._layers[S];if(!M)return this.fire(new s.y(new Error("The layer '".concat(S,"' does not exist in the map's style and cannot be queried for features.")))),[];m(M)}}else for(const S in this._layers)m(this._layers[S]);const y=this._queryRenderedFeatures(t,p,c),x=this._flattenAndSortRenderedFeatures(y),T=[];for(const S of x)s.dv(S.layer.id)===this.scope&&T.push(S);return T}queryRenderedFeatureset(t,n,c){let d;n&&!Array.isArray(n)&&n.filter&&(this._validate(ii,"queryRenderedFeatures.filter",n.filter,null,n),d=s.b5(n.filter));const p="mock",m=[];if(n&&n.target)m.push(Object.assign({},n,{targetId:p,filter:d}));else{const S=this.getFeaturesetDescriptors();for(const M of S)m.push({targetId:p,filter:d,target:M});for(const{style:M}of this.fragments){const E=M.getFeaturesetDescriptors();for(const C of E)m.push({targetId:p,filter:d,target:C})}}const y=this.queryRenderedTargets(t,m,c),x=[],T=new Set;for(const S of y)for(const M of S.variants[p])wo(M,S,T)||x.push(new s.dw(S,M));return x}queryRenderedTargets(t,n,c){const d={},p=(y,x,T,S)=>{const M=d[x.id]=d[x.id]||{sourceCache:x,layers:{},has3DLayers:!1};if(M.layers[y.fqid]=M.layers[y.fqid]||{styleLayer:y,targets:[]},y.is3D(!!this.terrain)&&(M.has3DLayers=!0),!S)return T.uniqueFeatureID=!1,void M.layers[y.fqid].targets.push(T);M.layers[y.fqid].targets.push(Object.assign({},T,{namespace:S.namespace,properties:S.properties,uniqueFeatureID:S.uniqueFeatureID}))};for(const y of n)if("featuresetId"in y.target){const{featuresetId:x,importId:T}=y.target,S=this.getFragmentStyle(T);if(!S||!S._featuresetSelectors)continue;const M=S._featuresetSelectors[x];if(!M){this.fire(new s.y(new Error("The featureset '".concat(x,"' does not exist in the map's style and cannot be queried for features."))));continue}for(const E of M){const C=S.getOwnLayer(E.layerId);C&&!Vc.has(C.type)&&p(C,S.getOwnLayerSourceCache(C),y,E)}}else if("layerId"in y.target){const{layerId:x}=y.target,T=this.getLayer(x);if(!T||Vc.has(T.type))continue;p(T,this.getLayerSourceCache(T),y)}const m=this._queryRenderedFeatures(t,d,c);return this._flattenAndSortRenderedFeatures(m)}_queryRenderedFeatures(t,n,c){const d=[],p=!!this.map._showQueryGeometry,m=$i.createFromScreenPoints(t,c);for(const y in n){const x=To(m,n[y],this._availableImages,c,p);Object.keys(x).length&&d.push(x)}if(this.placement)for(const y in n){if(!n[y].sourceCache._onlySymbols)continue;const x=Pc(m.screenGeometry,n[y],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(x).length&&d.push(x)}return d}querySourceFeatures(t,n){const c=n&&n.filter;c&&this._validate(ii,"querySourceFeatures.filter",c,null,n);let d=[];const p=this.getOwnSourceCaches(t);for(const m of p)d=d.concat(Dl(m,n));return d}addSourceType(t,n,c){return rs.getSourceType(t)?c(new Error('A source type called "'.concat(t,'" already exists.'))):(rs.setSourceType(t,n),n.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:n.workerSourceURL},c):c(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,n,c={}){this._checkLoaded();const d=this.light.getLight();let p=!1;for(const y in t)if(!s.bx(t[y],d[y])){p=!0;break}if(!p)return;const m=this._getTransitionParameters();this.light.setLight(t,n,c),this.light.updateTransitions(m)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=s.o.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&s.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,n=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),n===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let c=t;const d=t.source==null;if(n===1){if(this.disableElevatedTerrain)return;if(typeof c.source=="object"){const y="terrain-dem-src";this.addSource(y,c.source),c=s.dn(c),c=Object.assign(c,{source:y})}const p=Object.assign({},c),m={};if(this.terrain&&d){p.source=this.terrain.get().source;const y=this.terrain?this.getFragmentStyle(this.terrain.scope):null;y&&(m.style=y.serialize())}if(this._validate(Cn,"terrain",p,m))return}if(!this.terrain||this.terrain.scope!==this.scope&&!d||this.terrain&&n!==this.terrain.drapeRenderMode){if(!c)return;this._createTerrain(c,n),this.fire(new s.z("data",{dataType:"style"}))}else{const p=this.terrain,m=p.get();for(const y of Object.keys(s.a6.terrain))!c.hasOwnProperty(y)&&s.a6.terrain[y].default&&(c[y]=s.a6.terrain[y].default);for(const y in t)if(!s.bx(t[y],m[y])){p.set(t,this.options),this.stylesheet.terrain=t;const x=this._getTransitionParameters({duration:0});p.updateTransitions(x),this.fire(new s.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const n=this.fog=new Mt(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createSnow(t){const n=this.snow=new tn(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createRain(t){const n=this.rain=new Hr(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask((()=>{for(const t of this.map._markers)t._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const n=this.fog;if(!s.bx(n.get(),t)){n.set(t,this.options),this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const n=this.snow;if(!s.bx(n.get(),t)){n.set(t,this.options),this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const n=this.rain;if(!s.bx(n.get(),t)){n.set(t,this.options),this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const d in this._layers)this._layers[d].lut=this._styleColorTheme.lut;for(const d in this._sourceCaches)this._sourceCaches[d].clearTiles()},n=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!n)return this._styleColorTheme.lut=null,void t();const c=this._evaluateColorThemeData(n);this._loadColorTheme(c).then((()=>{this.fire(new s.z("colorthemeset")),t()})).catch((d=>{s.w("Couldn't set color theme: ".concat(d))}))}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&s.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,n){const c=this.getFragmentStyle(t);c&&(c._styleColorTheme.colorThemeOverride=n,c._reloadColorTheme())}_getTransitionParameters(t){return{now:s.o.now(),transition:Object.assign(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],n=[];for(const c of this._mergedOrder)this.isLayerDraped(this._mergedLayers[c])?t.push(c):n.push(c);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...n)}_createTerrain(t,n){const c=this.terrain=new de(t,n,this.scope,this.options,this.map.getWorldview());n===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const d=this._getTransitionParameters({duration:0});c.updateTransitions(d)}_force3DLayerUpdate(){for(const t in this._layers){const n=this._layers[t];n.type==="fill-extrusion"&&this._updateLayer(n)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const n=this._layers[t];n.type==="symbol"&&this._updateLayer(n)}}_validate(t,n,c,d,p={}){if(p&&p.validate===!1)return!1;const m=Object.assign({},this.serialize());return Qs(this,t.call(Kr,Object.assign({key:n,style:m,value:c,styleSpec:s.a6},d)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),s.dx.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){const n=this.getSourceCaches(t);for(const c of n)c.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}clearLayers(){for(const t in this._mergedLayers){const n=this._mergedLayers[t];n._clear&&n._clear()}}reloadSource(t){const n=this.getSourceCaches(t);for(const c of n)c.resume(),c.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle((t=>{t.modelManager.reloadModels(t.scope)}))}updateSources(t){let n;this.directionalLight&&(n=Sf(this.directionalLight));const c=new Set;for(const d in this._mergedLayers){const p=this._mergedLayers[d];p.hasElevation()&&!c.has(p.source)&&c.add(p.source)}for(const d in this._mergedSourceCaches){const p=this._mergedSourceCaches[d],m=c.has(p._source.id);p.update(t,void 0,void 0,n,m)}}_generateCollisionBoxes(){for(const t in this._sourceCaches){const n=this._sourceCaches[t];n.resume(),n.reload()}}_updatePlacement(t,n,c,d,p,m,y=!1){let x=!1,T=!1;const S={},M={};for(const E of this._mergedOrder){const C=this._mergedLayers[E];if(C.type!=="symbol")continue;const R=s.B(C.source,C.scope);let z=S[R];if(!z){const k=this.getLayerSourceCache(C);if(!k)continue;const U=k.getRenderableIds(!0).map(($=>k.getTileByID($)));M[R]=U.slice(),z=S[R]=U.sort((($,G)=>G.tileID.overscaledZ-$.tileID.overscaledZ||($.tileID.isLessThan(G.tileID)?-1:1)))}const N=this.crossTileSymbolIndex.addLayer(C,z,n.center.lng,n.projection);x=x||N}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),y=y||this._layerOrderChanged||d===0,this._layerOrderChanged&&this.fire(new s.z("neworder")),(y||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(s.o.now(),n.zoom))&&(this.pauseablePlacement=new po(n,this._mergedOrder,y,c,d,p,this.placement,this.fog&&n.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,S,M,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(s.o.now()),T=!0),x&&this.pauseablePlacement.placement.setStale()),T||x){this._buildingIndex.onNewFrame(n.zoom);for(let E=0;E<this._mergedOrder.length;E++){const C=this._mergedLayers[this._mergedOrder[E]];if(C.type!=="symbol")continue;const R=this.isLayerClipped(C);this.placement.updateLayerOpacities(C,S[s.B(C.source,C.scope)],E,R?m:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(s.o.now())}}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,n){this._checkLoaded();const c=this.stylesheet.imports=this.stylesheet.imports||[];if(c.findIndex((({id:p})=>p===t.id))!==-1)return void this.fire(new s.y(new Error("Import with id '".concat(t.id,"' already exists in the map's style."))));if(!n)return c.push(t),this._loadImports([t],!0);const d=c.findIndex((({id:p})=>p===n));return d===-1&&this.fire(new s.y(new Error('Import with id "'.concat(n,'" does not exist on this map.')))),this.stylesheet.imports=c.slice(0,d).concat(t).concat(c.slice(d)),this._loadImports([t],!0,n)}updateImport(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);return d===-1?this:typeof n=="string"?(this.setImportUrl(t,n),this):(n.url&&n.url!==c[d].url&&this.setImportUrl(t,n.url),s.bx(n.config,c[d].config)||this.setImportConfig(t,n.config,n.data.schema),s.bx(n.data,c[d].data)||this.setImportData(t,n.data),this)}moveImport(t,n){this._checkLoaded();let c=this.stylesheet.imports||[];const d=this.getImportIndex(t);if(d===-1)return this;const p=this.getImportIndex(n);if(p===-1)return this;const m=c[d],y=this.fragments[d];return c=c.filter((({id:x})=>x!==t)),this.fragments=this.fragments.filter((({id:x})=>x!==t)),this.stylesheet.imports=c.slice(0,p).concat(m).concat(c.slice(p)),this.fragments=this.fragments.slice(0,p).concat(y).concat(this.fragments.slice(p)),this.mergeLayers(),this}setImportUrl(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);if(d===-1)return this;c[d].url=n;const p=this.fragments[d];return p.style=this._createFragmentStyle(c[d]),p.style.on("style.import.load",(()=>this.mergeAll())),p.style.loadURL(n),this}setImportData(t,n){this._checkLoaded();const c=this.getImportIndex(t),d=this.stylesheet.imports||[];return c===-1?this:n?(this.fragments[c].style.setState(n),this._reloadImports(),this):(delete d[c].data,this.setImportUrl(t,d[c].url))}setImportConfig(t,n,c){this._checkLoaded();const d=this.getImportIndex(t),p=this.stylesheet.imports||[];if(d===-1)return this;n?p[d].config=n:delete p[d].config;const m=this.fragments[d];c&&m.style.stylesheet&&(m.style.stylesheet.schema=c);const y=m.style.stylesheet&&m.style.stylesheet.schema;return m.config=n,m.style.updateConfig(n,y),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const n=this.stylesheet.imports||[],c=this.getImportIndex(t);c!==-1&&(n.splice(c,1),this.fragments[c].style._remove(),this.fragments.splice(c,1),this._reloadImports())}getImportIndex(t){const n=(this.stylesheet.imports||[]).findIndex((c=>c.id===t));return n===-1&&this.fire(new s.y(new Error("Import '".concat(t,"' does not exist in the map's style and cannot be updated.")))),n}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const n in this._mergedOtherSourceCaches){const c=this._mergedOtherSourceCaches[n];c&&t.push(c.getSource())}return t}getSource(t,n){const c=this.getSourceCache(t,n);return c&&c.getSource()}getLayerSource(t){const n=this.getLayerSourceCache(t);return n&&n.getSource()}getSourceCache(t,n){const c=s.B(t,n);return this._mergedOtherSourceCaches[c]}getLayerSourceCache(t){const n=s.B(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[n]:this._mergedOtherSourceCaches[n]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);const n=[];return this._mergedOtherSourceCaches[t]&&n.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&n.push(this._mergedSymbolSourceCaches[t]),n}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const n in t){const c=t[n];c==="reload"?this.reloadSource(n):c==="clear"&&this.clearSource(n)}}updateLayers(t){const n=this._changes.getUpdatedPaintProperties();for(const c of n){const d=this.getLayer(c);d&&d.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t)}getImages(t,n,c){this.imageManager.getImages(n.images,n.scope,c),this._updateTilesForChangedImages();const d=m=>{if(m){const y=n.images.map((x=>s.I.toString(x)));m.setDependencies(n.tileID.key,n.type,y)}},p=s.B(n.source,n.scope);d(this._mergedOtherSourceCaches[p]),d(this._mergedSymbolSourceCaches[p]),n.images.some((m=>m.iconsetId))&&this.fire(new s.z("data",{dataType:"style"}))}rasterizeImages(t,n,c){this.imageManager.rasterizeImages(n,c)}getGlyphs(t,n,c){this.glyphManager.getGlyphs(n.stacks,c)}getResource(t,n,c){return s.dy(n,c)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const n=[];return this._otherSourceCaches[t]&&n.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&n.push(this._symbolSourceCaches[t]),n}_isSourceCacheLoaded(t){const n=this.getOwnSourceCaches(t);return n.length===0?(this.fire(new s.y(new Error("There is no source with ID '".concat(t,"'")))),!1):n.every((c=>c.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,n){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;const c=t.type==="fill-extrusion"&&(t.sourceLayer==="building"||t.sourceLayer==="procedural_buildings"),d=t.type==="building";if(t.is3D(!!this.terrain)){if(c||d||n&&n.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((t=>{t.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}rs.getSourceType=function(l){return Jo[l]},rs.setSourceType=function(l,t){Jo[l]=t},rs.registerForPluginStateChange=s.dz;class wa extends s.E{constructor(t){super(),this._style=t,this._buildings={},this._activeFloors=new Set,this._activeFloorsVisible=!0,this._indoorState={selectedFloorId:null,lastActiveFloors:null,activeFloorsVisible:!0},s.aX(["_updateUI"],this)}destroy(){this._buildings={},this._activeFloors=new Set,this._indoorState=null}selectFloor(t){t===this._selectedFloorId&&this._activeFloorsVisible||(this._selectedFloorId=t,this._activeFloorsVisible=!0,this._updateActiveFloors())}setActiveFloorsVisibility(t){this._activeFloorsVisible=t,this._updateActiveFloors(),this._updateIndoorSelector()}setIndoorData(t){for(const[n,c]of Object.entries(t.buildings))if(this._buildings[n])for(const d of c.floorIds)this._buildings[n].floors[d]||(this._buildings[n].floors[d]=c.floors[d]);else this._buildings[n]=c;for(const n of t.activeFloors)this._activeFloors.add(n);this._updateIndoorSelector()}getIndoorTileOptions(t,n){const c=this._style.getIndoorSourceLayers(t,n);return c&&this._indoorState?{sourceLayers:c,indoorState:this._indoorState}:null}_updateUI(t,n,c){const d=(function(p,m,y,x){let T=null,S=Number.MAX_SAFE_INTEGER;if(x<16)return null;for(const[M,E]of Object.entries(p)){const C=E.center;if(C){const R=m.distanceTo(s.aS.convert(C));R<S&&y.contains(C)&&(S=R,T=M)}}return T})(this._buildings,n,c,t);d!==this._closestBuildingId&&(this._closestBuildingId=d,this._updateIndoorSelector())}_updateIndoorSelector(){const t=this._buildings,n=this._closestBuildingId,c=n&&t?t[n]:void 0;if(!c)return void this.fire(new s.z("selector-update",{selectedFloorId:null,activeFloorsVisible:this._activeFloorsVisible,floors:[]}));let d=null;for(const m of c.floorIds)if(this._activeFloors&&this._activeFloors.has(m)){d=m;break}const p=Array.from(c.floorIds).map((m=>({id:m,name:c.floors[m].name,zIndex:c.floors[m].zIndex}))).sort(((m,y)=>y.zIndex-m.zIndex));this.fire(new s.z("selector-update",{selectedFloorId:d,activeFloorsVisible:this._activeFloorsVisible,floors:p}))}_updateActiveFloors(){const t=this._activeFloors;this._activeFloors=new Set,this._indoorState={selectedFloorId:this._selectedFloorId,lastActiveFloors:t,activeFloorsVisible:this._activeFloorsVisible},this._style.updateIndoorDependentLayers()}}var Ql="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",vh="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb*col.a,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",bh="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}\n#ifndef HAS_SHADER_STORAGE_BLOCK_material_buffer\n#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_id) attrib\n#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_id) attrib\n#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_id) attrib\n#define DECLARE_MATERIAL_TABLE_INFO\n#endif",$a="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Za="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\nint NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\nhighp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif//DEPTH_OCCLUSION",wh="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",Uc="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",zo="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",jc="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",Je="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",Th="#ifdef RENDER_SHADOWS\nprecision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {\n#ifdef CLIP_ZERO_TO_ONE\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);\n#else\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);\n#endif\nreturn texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;\n#ifdef SHADOWS_SINGLE_CASCADE\nvec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);\n#else\nlight_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const Wa=[];ns(Ql,Wa),ns(bh,Wa),ns(vh,Wa);const Xa={"_prelude_fog.vertex.glsl":wh,"_prelude_terrain.vertex.glsl":Za,"_prelude_shadow.vertex.glsl":Je,"_prelude_material_table.vertex.glsl":"#ifdef HAS_SHADER_STORAGE_BLOCK_material_buffer\n#define MATERIAL_TABLE_DEBUG 0\nuniform int u_material_offset;uniform int u_vertex_offset;layout(std140,binding=0)readonly buffer material_buffer{uvec4 material_data[];};struct MaterialInfo{uint dataOffset;\n#if MATERIAL_TABLE_DEBUG\nvec4 colorDebug;\n#endif\n};uint read_buf_no_offset(uint iDword) {return material_data[iDword/4u][iDword % 4u];}uint read_buf(uint iDword) {iDword+=uint(u_material_offset/4);return read_buf_no_offset(iDword);}float read_buf_float(uint iDword){return uintBitsToFloat(read_buf(iDword));}uint read_buf_uint8(uint iDword,uint iUint8){uint dwordOffset=iDword+(iUint8/4u);uint byteOffset=iUint8 & 3u;uint bitOffset=8u*byteOffset;uint mask=0xffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint read_buf_uint16(uint iDword,uint iUint16){uint dwordOffset=iDword+(iUint16 >> 1u);uint bitOffset=(iUint16 & 1u)*16u;uint mask=0xffffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint nrDwordsForVertexIdEntries(uint nrMaterialLookupEntries) {return nrMaterialLookupEntries;}uint nrDwordsForMaterialIdEntries(uint nrMaterialLookupEntries) {return (nrMaterialLookupEntries*2u+3u)/4u;}uint findRangeBinarySearch(uint vertexId,uint numRanges,uint dwordOffset) {uint left=0u;uint right=numRanges-1u;for (uint i=0u; i < 16u; i++) { \nif (left > right) {break;}uint mid=(left+right)/2u;uint start=read_buf(dwordOffset+mid);uint nextStart=(mid+1u < numRanges) ? read_buf(dwordOffset+mid+1u) : 0xffffffffu;if (vertexId >=start && vertexId < nextStart) {return mid;} else if (vertexId < start) {if (mid==0u) {break;}right=mid-1u;} else {left=mid+1u;}}return 0u; \n}uint readVertexId(uint dwordOffset,uint iMaterialLookupEntry) {return read_buf(dwordOffset+iMaterialLookupEntry);}uint findRange(uint vertexId,uint numRanges,uint dwordOffset) {uint iRange;if(numRanges <=64u){uint vertexBegin;for(iRange=0u; iRange < numRanges;++iRange) {vertexBegin=readVertexId(dwordOffset,iRange);if(vertexBegin > vertexId) {break;}}iRange=iRange==0u? 0u : iRange-1u;} else { \niRange=findRangeBinarySearch(vertexId,numRanges,dwordOffset);}return iRange;}MaterialInfo read_material_info(uint vertex_id) {MaterialInfo info;\n#if MATERIAL_TABLE_DEBUG\nconst vec4 red=vec4(1.0,0.0,0.0,1.0);const vec4 orange=vec4(1.0,0.5,0.0,1.0);const vec4 yellow=vec4(1.0,1.0,0.0,1.0);const vec4 green=vec4(0.0,1.0,0.0,1.0);const vec4 indigo=vec4(0.294,0.0,0.510,1.0);const vec4 blue=vec4(0.0,0.0,1.0,1.0);const vec4 purple=vec4(0.5,0.0,0.5,1.0);const vec4 pink=vec4(1.0,0.0,1.0,1.0);info.colorDebug=green;\n#endif\nuint offset=0u;\n#if MATERIAL_TABLE_DEBUG\nbool keepFinding=true;uint magic=read_buf(offset);if(magic !=0xCAFEBABEu) {info.colorDebug=red;keepFinding=false;return info;}\n#endif\noffset++;\n#if MATERIAL_TABLE_DEBUG\nuint nrMaterials=read_buf(offset);uint nrVertices=read_buf(offset+1u);if(keepFinding && vertex_id >=nrVertices) {info.colorDebug=red;keepFinding=false;}\n#endif\noffset+=2u;uint nrMaterialLookupEntries=read_buf(offset++);uint perMaterialEntrySizeDwords=read_buf(offset++);\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding && perMaterialEntrySizeDwords !=1u) {info.colorDebug=red;keepFinding=false;}\n#endif\nuint iMaterialLookup=findRange(vertex_id,nrMaterialLookupEntries,offset);\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding)\n{uint vertexBeginCheck=readVertexId(offset,iMaterialLookup);if(vertexBeginCheck > vertex_id) {info.colorDebug=red;keepFinding=false;}if(iMaterialLookup < nrMaterialLookupEntries-1u) {uint vertexEndCheck=readVertexId(offset,iMaterialLookup+1u);if(vertexEndCheck <=vertex_id) {info.colorDebug=red;keepFinding=false;}}}\n#endif\noffset+=nrDwordsForVertexIdEntries(nrMaterialLookupEntries);uint materialId=iMaterialLookup;\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding) {if(materialId >=nrMaterialLookupEntries) {info.colorDebug=red;}}\n#endif\ninfo.dataOffset=offset+materialId*perMaterialEntrySizeDwords;return info;}uint get_data_location(const MaterialInfo matInfo,uint attribOffsetBytes)\n{uint attribFieldOffsetDwords=attribOffsetBytes/4u;return matInfo.dataOffset+attribFieldOffsetDwords;}vec4 read_material_vec4(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec4(read_buf_float(loc),read_buf_float(loc+1u),read_buf_float(loc+2u),read_buf_float(loc+3u));}vec2 read_material_vec2(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec2(read_buf_float(loc),read_buf_float(loc+1u));}float read_material_float(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return read_buf_float(loc);}\n#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_offset) read_material_float(matInfo,attrib_offset)\n#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_offset) read_material_vec4(matInfo,attrib_offset)\n#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_offset) read_material_vec2(matInfo,attrib_offset)\n#define DECLARE_MATERIAL_TABLE_INFO MaterialInfo materialInfo=read_material_info(uint(gl_VertexID));\n#define DECLARE_MATERIAL_TABLE_INFO_DEBUG(dbgColor) MaterialInfo materialInfo=read_material_info(uint(gl_VertexID)); dbgColor=materialInfo.colorDebug;\n#endif","_prelude_fog.fragment.glsl":Uc,"_prelude_shadow.fragment.glsl":Th,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":zo,"_prelude_raster_particle.glsl":jc},ec={};ui("",Za),ui(Uc,wh),ui(Th,Je),ui(zo,""),ui(jc,"");const tc=ui(vh,bh),Ss=Ql;var Gc={background:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),building:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nconst float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nin lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;\n#endif\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef FLOOD_LIGHT\nin highp float v_flood_radius;in float v_has_flood_light;\n#endif\nuniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;uniform vec3 u_flood_light_color;uniform float u_flood_light_intensity;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}\n#ifdef BUILDING_FAUX_FACADE\nfloat hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;\n#if 0\nif (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;\n#else\nif (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;\n#endif\nreturn out_color;}\n#endif\nvec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;\n#ifdef BUILDING_FAUX_FACADE\nif (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}\n#endif\nvec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;\n#ifdef RENDER_SHADOWS\nshadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nshadowed_lighting_factor=dot(normal,u_lighting_directional_dir);\n#endif\ncolor.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=linearTosRGB(color.rgb);\n#ifdef FLOOD_LIGHT\nfloat flood_radiance=(1.0-min(v_pos.z/v_flood_radius,1.0))*u_flood_light_intensity*v_has_flood_light;color.rgb=mix(color.rgb,u_flood_light_color,flood_radiance);\n#endif\ncolor.rgb=mix(color.rgb,linearTosRGB(base_color.rgb),emissive);\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));\n#endif\ncolor*=u_opacity;\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_pos.z);\n#endif\n#ifdef FEATURE_CUTOUT\ncolor=apply_feature_cutout(color,gl_FragCoord);\n#endif\nglFragColor=color; \n#ifdef DEBUG_SHOW_NORMALS\ncolor.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in float a_flood_light_wall_radius_1i16;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nout lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\n#ifdef FLOOD_LIGHT\nout highp float v_flood_radius;out float v_has_flood_light;\n#endif\nconst float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;const float FLOOD_LIGHT_MAX_RADIUS_METER=2048.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#ifdef BUILDING_FAUX_FACADE\nmat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}\n#endif\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive\nvoid main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive\n#ifdef FLOOD_LIGHT\nv_flood_radius=(a_flood_light_wall_radius_1i16/MAX_INT_16*FLOOD_LIGHT_MAX_RADIUS_METER);v_has_flood_light=step(0.0,v_flood_radius);\n#endif\nvec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;\n#ifdef BUILDING_FAUX_FACADE\nv_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}\n#endif\nv_pos=a_pos_3f;\n#ifdef RENDER_CUTOFF\nvec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shadow_pos=v_pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(v_pos);\n#endif\ngl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}'),buildingBloom:ui("in vec4 v_color_emissive;\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\nfloat saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;\n#ifdef HAS_ATTRIBUTE_a_bloom_attenuation\nfloat distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);\n#endif\nglFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}","in vec3 a_pos_3f;\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\nout vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\n#ifdef HAS_ATTRIBUTE_a_part_color_emissive\nvec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);\n#else\nv_color_emissive=vec4(1.0);\n#endif\ngl_Position=u_matrix*vec4(a_pos_3f,1.0);}"),buildingDepth:ui("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? \nsmoothstep(0.0,-antialiased_blur,1.0-extrude_length) : \nsmoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\n#ifdef ELEVATED_ROADS\nin float a_circle_z_offset;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\n#ifdef ELEVATED_ROADS\nworld_center.z+=a_circle_z_offset+ELEVATION_BIAS;\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:ui("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:ui('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:ui("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:ui("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;\n#endif\nout float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);\n#ifdef PROJECTION_GLOBE_VIEW\n#ifndef PROJECTED_POS_ON_VIEWPORT\nvec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);\n#endif\n#endif\nvec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:ui("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:ui("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),elevatedStructuresDepth:ui("void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=vec4(0.);\n#endif\n}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:ui("#ifdef DEPTH_RECONSTRUCTION\nin float v_height;\n#endif\nvoid main() {\n#ifdef DEPTH_RECONSTRUCTION\nif (v_height >=0.0)\ndiscard;\n#else\n#ifdef FEATURE_CUTOUT\napply_feature_cutout(vec4(0.0,0.0,0.0,1.0),gl_FragCoord);\n#endif\n#endif\nglFragColor=vec4(1.0,0.0,0.0,1.0);}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;\n#ifdef DEPTH_RECONSTRUCTION\nout float v_height;\n#endif\nvoid main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);\n#ifdef DEPTH_RECONSTRUCTION\nif (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;\n#endif\ngl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}"),elevatedStructures:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin vec3 v_normal;in float v_height;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)\n{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nvec3 color=structure_color.xyz;\n#ifdef LIGHTING_3D_MODE\nvec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);\n#ifdef RENDER_SHADOWS\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);\n#else\ncolor=apply_lighting(color,transformed_normal);\n#endif\ncolor=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}\n#endif\n#ifdef FOG\ncolor=fog_apply(color,v_fog_pos);\n#endif\nvec4 out_color=vec4(color,1.0);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_height);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nv_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fill:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nif (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef FLIP_Y\nv_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nuniform float u_emissive_strength;\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FLIP_Y\nv_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\n#ifdef FEATURE_CUTOUT\ncolor=apply_feature_cutout(color,gl_FragCoord);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);\n#ifdef CLIP_ZERO_TO_ONE\ncutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);\n#else\ncutoff=cutoff_opacity(u_cutoff_params,ground.z);\n#endif\nif (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:ui("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:ui('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:ui("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:ui("precision highp float;uniform highp sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec3 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec3 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nfloat left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\noffset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nhighp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);\n#else\nv_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef LINE_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nuniform float u_emissive_strength;\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\n#ifdef LINE_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec3 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),1.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:ui("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:ui("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:ui('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:ui('#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nin highp float v_z_offset;\n#endif\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef TERRAIN\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#else\nout_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#define APPEARANCE_ICON 1.0\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef ELEVATED_ROADS\nin vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nout highp float v_z_offset;\n#endif\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float a_size_max= floor(a_size[1]*0.5);float a_apperance_icon=a_size[1]-2.0*a_size_max;vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (a_apperance_icon==APPEARANCE_ICON) {size=a_size_max/128.0;} else if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size_max,u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\n#ifdef PROJECTED_POS_ON_VIEWPORT\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);\n#else\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    \n#endif\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;\n#else\nz+=u_pitch_with_map ? z_offset : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\n#ifdef Z_TEST_OCCLUSION\nout_fade_opacity*=occlusion_opacity;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\n#ifdef ELEVATED_ROADS\nvec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\npos=vec3(projected_pos.xy/projected_pos.w+offset,z);\n#endif\n#endif\ngl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#else\n#ifdef RENDER_SHADOWS\nv_z_offset=e;\n#endif\n#endif\n}'),terrainRaster:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:ui("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:ui('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',$a),skyboxGradient:ui('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',$a),skyboxCapture:ui("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nhighp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:ui('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_atmosphere_fog_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_atmosphere_fog_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_atmosphere_fog_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:ui('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef FLIP_Y\ncoord.y=1.0-coord.y;\n#endif\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;\n#ifdef FLIP_Y\nT=-T;B=-B;\n#endif\nhighp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));\n#ifdef FLIP_Y\nn=normalize(cross(fdx,fdy));\n#else\nn=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\n#ifdef FEATURE_CUTOUT\nfinalColor=apply_feature_cutout(finalColor,gl_FragCoord);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#ifdef CLIP_ZERO_TO_ONE\nv_depth=-1.0+2.0*v_depth; \n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:ui("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:ui("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:ui("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:ui("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:ui("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:ui("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function ns(l,t){const n=l.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let c of n)if(c=c.trim(),c[0]==="#"&&c.includes("if")&&!c.includes("endif")){c=c.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const d=c.split(" ");for(const p of d)t.includes(p)||t.push(p)}}function ui(l,t){const n=/#include\s+"([^"]+)"/g,c=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,d={},p=[],m=[];if(l=l.replace(n,((x,T)=>(m.push(T),""))),(t=t.replace(n,((x,T)=>(p.push(T),"")))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let y=[...Wa];ns(l,y),ns(t,y);for(const x of[...p,...m])Xa[x]||console.error("Undefined include: ".concat(x)),ec[x]||(ec[x]=[],ns(Xa[x],ec[x])),y=[...y,...ec[x]];return{fragmentSource:l=l.replace(c,((x,T,S,M,E)=>(d[E]=!0,T==="define"?"\n#ifndef HAS_UNIFORM_u_".concat(E,"\nin ").concat(S," ").concat(M," ").concat(E,";\n#else\nuniform ").concat(S," ").concat(M," u_").concat(E,";\n#endif\n"):T==="initialize"?"\n#ifdef HAS_UNIFORM_u_".concat(E,"\n    ").concat(S," ").concat(M," ").concat(E," = u_").concat(E,";\n#endif\n"):T==="define-attribute"?"\n#ifdef HAS_ATTRIBUTE_a_".concat(E,"\n    in ").concat(S," ").concat(M," ").concat(E,";\n#endif\n"):T==="initialize-attribute"?"":void 0))),vertexSource:t=t.replace(c,((x,T,S,M,E)=>{const C="MATERIAL_ATTRIBUTE_OFFSET_".concat(E),R=M==="float"?"vec2":M,z="GET_ATTRIBUTE_".concat(R,"(a_").concat(E,", materialInfo, ").concat(C,")"),N=E.match(/color/)?"color":R;return T==="define-attribute-vertex-shader-only"?"\n#ifdef HAS_ATTRIBUTE_a_".concat(E,"\nin ").concat(S," ").concat(M," a_").concat(E,";\n#endif\n"):d[E]?T==="define"?"\n#ifndef HAS_UNIFORM_u_".concat(E,"\nuniform lowp float u_").concat(E,"_t;\n    #if !defined(").concat(C,")\n        in ").concat(S," ").concat(R," a_").concat(E,";\n    #endif\nout ").concat(S," ").concat(M," ").concat(E,";\n#else\nuniform ").concat(S," ").concat(M," u_").concat(E,";\n#endif\n"):T==="initialize"?N==="vec4"?"\n#ifndef HAS_UNIFORM_u_".concat(E,"\n    ").concat(E," = a_").concat(E,";\n#else\n    ").concat(S," ").concat(M," ").concat(E," = u_").concat(E,";\n#endif\n"):"\n#if !defined(HAS_UNIFORM_u_".concat(E,") \n    #ifdef ").concat(C,"\n        ").concat(E," = unpack_mix_").concat(N,"(").concat(z,", u_").concat(E,"_t);\n    #else\n        ").concat(E," = unpack_mix_").concat(N,"(a_").concat(E,", u_").concat(E,"_t);\n    #endif\n#else\n    ").concat(S," ").concat(M," ").concat(E," = u_").concat(E,";\n#endif\n"):T==="define-attribute"?"\n#ifdef HAS_ATTRIBUTE_a_".concat(E,"\n    in ").concat(S," ").concat(M," a_").concat(E,";\n    out ").concat(S," ").concat(M," ").concat(E,";\n#endif\n"):T==="initialize-attribute"?"\n#ifdef HAS_ATTRIBUTE_a_".concat(E,"\n    ").concat(E," = a_").concat(E,";\n#endif\n"):void 0:T==="define"?"\n#ifndef HAS_UNIFORM_u_".concat(E,"\nuniform lowp float u_").concat(E,"_t;\n    #if !defined(").concat(C,")\n        in ").concat(S," ").concat(R," a_").concat(E,";\n    #endif  \n#else\nuniform ").concat(S," ").concat(M," u_").concat(E,";\n#endif\n"):T==="define-instanced"?N==="mat4"?"\n#ifdef INSTANCED_ARRAYS\nin vec4 a_".concat(E,"0;\nin vec4 a_").concat(E,"1;\nin vec4 a_").concat(E,"2;\nin vec4 a_").concat(E,"3;\n#else\nuniform ").concat(S," ").concat(M," u_").concat(E,";\n#endif\n"):"\n#ifdef INSTANCED_ARRAYS\nin ".concat(S," ").concat(R," a_").concat(E,";\n#else\nuniform ").concat(S," ").concat(M," u_").concat(E,";\n#endif\n"):T==="initialize-attribute-custom"?"\n#ifdef HAS_ATTRIBUTE_a_".concat(E,"\n    ").concat(S," ").concat(M," ").concat(E," = a_").concat(E,";\n#endif\n"):N==="vec4"?"\n#ifndef HAS_UNIFORM_u_".concat(E,"\n    #ifdef ").concat(C,"\n        ").concat(S," ").concat(M," ").concat(E," = ").concat(z,";\n    #else\n        ").concat(S," ").concat(M," ").concat(E," = a_").concat(E,";\n    #endif\n#else\n    ").concat(S," ").concat(M," ").concat(E," = u_").concat(E,";\n#endif\n"):"\n#ifndef HAS_UNIFORM_u_".concat(E,"\n    #ifdef ").concat(C,"\n        ").concat(S," ").concat(M," ").concat(E," = unpack_mix_").concat(N,"(").concat(z,", u_").concat(E,"_t);\n    #else\n        ").concat(S," ").concat(M," ").concat(E," = unpack_mix_").concat(N,"(a_").concat(E,", u_").concat(E,"_t);\n    #endif\n#else\n    ").concat(S," ").concat(M," ").concat(E," = u_").concat(E,";\n#endif\n")})),usedDefines:y,vertexIncludes:p,fragmentIncludes:m}}class Ya{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,n,c,d,p,m,y,x){this.context=t;let T=this.boundPaintVertexBuffers.length!==d.length;for(let M=0;!T&&M<d.length;M++)this.boundPaintVertexBuffers[M]!==d[M]&&(T=!0);let S=this.boundDynamicVertexBuffers.length!==y.length;for(let M=0;!S&&M<y.length;M++)this.boundDynamicVertexBuffers[M]!==y[M]&&(S=!0);if(!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==c||T||S||this.boundIndexBuffer!==p||this.boundVertexOffset!==m)this.freshBind(n,c,d,p,m,y,x);else{t.bindVertexArrayOES.set(this.vao);for(const M of y)M&&(M.bind(),x&&M.instanceCount&&M.setVertexAttribDivisor(t.gl,n,x));p&&p.dynamicDraw&&p.bind()}}freshBind(t,n,c,d,p,m,y){const x=this.context,T=x.gl;this.vao&&this.destroy(),this.vao=x.gl.createVertexArray(),x.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=c,this.boundIndexBuffer=d,this.boundVertexOffset=p,this.boundDynamicVertexBuffers=m,n.enableAttributes(T,t),n.bind(),n.setVertexAttribPointers(T,t,p);for(const S of c)S.enableAttributes(T,t),S.bind(),S.setVertexAttribPointers(T,t,p);for(const S of m)S&&(S.enableAttributes(T,t),S.bind(),S.setVertexAttribPointers(T,t,p),y&&S.instanceCount&&S.setVertexAttribDivisor(T,t,y));d&&d.bind()}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Sm(l,t){const n=Math.pow(2,t.canonical.z),c=t.canonical.y;return[new s.ae(0,c/n).toLngLat().lat,new s.ae(0,(c+1)/n).toLngLat().lat]}function Em(l,t,n,c,d,p,m){const y=l.context,x=y.gl,T=n.hillshadeFBO;if(!T)return;l.prepareDrawTile();const S=l.isTileAffectedByFog(t),M=l.getOrCreateProgram("hillshade",{overrideFog:S});y.activeTexture.set(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,T.colorAttachment.get());const E=((N,k,U,$)=>{const G=U.paint.get("hillshade-shadow-color"),ee=U.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",Z=U.paint.get("hillshade-highlight-color"),ie=U.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",Q=U.paint.get("hillshade-accent-color"),Y=U.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",re=U.paint.get("hillshade-emissive-strength");let _e=s.an(U.paint.get("hillshade-illumination-direction"));if(U.paint.get("hillshade-illumination-anchor")==="viewport")_e-=N.transform.angle;else if(N.style&&N.style.enable3dLights()&&N.style.directionalLight){const Ae=N.style.directionalLight.properties.get("direction"),ve=s.d3(Ae.x,Ae.y,Ae.z);_e=s.an(ve[1])}const he=!N.options.moving;return{u_matrix:$||N.transform.calculateProjMatrix(k.tileID.toUnwrapped(),he),u_image:0,u_latrange:Sm(0,k.tileID),u_light:[U.paint.get("hillshade-exaggeration"),_e],u_shadow:G.toPremultipliedRenderColor(ee?null:U.lut),u_highlight:Z.toPremultipliedRenderColor(ie?null:U.lut),u_emissive_strength:re,u_accent:Q.toPremultipliedRenderColor(Y?null:U.lut)}})(l,n,c,l.terrain?t.projMatrix:null);l.uploadCommonUniforms(y,M,t.toUnwrapped());const{tileBoundsBuffer:C,tileBoundsIndexBuffer:R,tileBoundsSegments:z}=l.getTileBoundsBuffers(n);M.draw(l,x.TRIANGLES,d,p,m,Bt.disabled,E,c.id,C,R,z)}function Hc(l,t,n){if(!t.needsDEMTextureUpload)return;const c=l.context,d=c.gl;c.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||l.getTileTexture(n.stride);const p=n.getPixels();t.demTexture?t.demTexture.update(p,{premultiply:!1}):t.demTexture=new s.T(c,p,d.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function Im(l,t,n){const c=l.context,d=c.gl;if(!t.dem)return;const p=t.dem;if(c.activeTexture.set(d.TEXTURE1),Hc(l,t,p),!t.demTexture)return;t.demTexture.bind(d.NEAREST,d.CLAMP_TO_EDGE);const m=p.dim;c.activeTexture.set(d.TEXTURE0);let y=t.hillshadeFBO;if(!y){const E=new s.T(c,{width:m,height:m,data:null},d.RGBA8);E.bind(d.LINEAR,d.CLAMP_TO_EDGE),y=t.hillshadeFBO=c.createFramebuffer(m,m,!0,"renderbuffer"),y.colorAttachment.set(E.texture)}c.bindFramebuffer.set(y.framebuffer),c.viewport.set([0,0,m,m]);const{tileBoundsBuffer:x,tileBoundsIndexBuffer:T,tileBoundsSegments:S}=l.getMercatorTileBoundsBuffers(),M=[];l.linearFloatFilteringSupported()&&M.push("TERRAIN_DEM_FLOAT_FORMAT"),l.getOrCreateProgram("hillshadePrepare",{defines:M}).draw(l,d.TRIANGLES,xt.disabled,Gt.disabled,ti.unblended,Bt.disabled,((E,C)=>{const R=C.stride,z=s.bB();return s.cd(z,0,s.al,-s.al,0,0,1),s.bq(z,z,[0,-s.al,0]),{u_matrix:z,u_image:1,u_dimension:[R,R],u_zoom:E.overscaledZ}})(t.tileID,p),n.id,x,T,S),t.needsHillshadePrepare=!1}class Ir{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Af extends Ir{getDefault(){return s.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Sh extends Ir{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Am extends Ir{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Mm extends Ir{getDefault(){return[!0,!0,!0,!0]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Cm extends Ir{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Pm extends Ir{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class Mf extends Ir{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const n=this.current;(t.func!==n.func||t.ref!==n.ref||t.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class Rm extends Ir{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class qc extends Ir{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=t,this.dirty=!1}}class Dm extends Ir{getDefault(){return[0,1]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Cf extends Ir{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=t,this.dirty=!1}}class Eh extends Ir{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class $c extends Ir{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.BLEND):n.disable(n.BLEND),this.current=t,this.dirty=!1}}class Ih extends Ir{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Ta extends Ir{getDefault(){return s.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Ka extends Ir{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class ic extends Ir{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=t,this.dirty=!1}}class Ja extends Ir{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Pf extends Ir{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Ah=class extends Ir{getDefault(){return null}set(l){(l!==this.current||this.dirty)&&(this.gl.useProgram(l),this.current=l,this.dirty=!1)}};class Rf extends Ir{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class Qa extends Ir{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Zc extends Ir{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Wc extends Ir{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Mh extends Ir{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class Xc extends Ir{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class rc extends Ir{getDefault(){return null}set(t){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Df extends Ir{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class zf extends Ir{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class Lf extends Ir{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class el extends Ir{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Yc extends Ir{constructor(t,n){super(t),this.context=t,this.parent=n}getDefault(){return null}}class zm extends Yc{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Of extends Yc{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,this.attachment(),n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Lm extends Yc{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,this.attachment(),n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Ch extends Of{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Ph=(l,t,n)=>({u_matrix:l,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:n}),Kc=(l,t,n,c,d,p,m,y,x,T,S,M,E,C,R,z)=>({u_proj_matrix:Float32Array.from(l),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(c),u_merc_matrix:n,u_zoom_transition:d,u_merc_center:p,u_image0:0,u_frustum_tl:m,u_frustum_tr:y,u_frustum_br:x,u_frustum_bl:T,u_globe_pos:S,u_globe_radius:M,u_viewport:E,u_grid_matrix:z?Float32Array.from(z):new Float32Array(9),u_skirt_height:C,u_far_z_cutoff:R});function Jc(l,t){return l!=null&&t!=null&&!(!l.hasData()||!t.hasData())&&l.demTexture!=null&&t.demTexture!=null&&l.tileID.key!==t.tileID.key}const Sa=new class{constructor(){this.operations={}}newMorphing(l,t,n,c,d){if(l in this.operations){const p=this.operations[l];p.to.tileID.key!==n.tileID.key&&(p.queued=n)}else this.operations[l]={startTime:c,phase:0,duration:d,from:t,to:n,queued:null}}getMorphValuesForProxy(l){if(!(l in this.operations))return null;const t=this.operations[l];return{from:t.from,to:t.to,phase:t.phase}}update(l){for(const t in this.operations){const n=this.operations[t];for(n.phase=(l-n.startTime)/n.duration;n.phase>=1||!this._validOp(n);)if(!this._nextOp(n,l)){delete this.operations[t];break}}}_nextOp(l,t){return!!l.queued&&(l.from=l.to,l.to=l.queued,l.queued=null,l.phase=0,l.startTime=t,!0)}_validOp(l){return l.from.hasData()&&l.to.hasData()}},Rh={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Ff(l,t,n){if(t===0)return 0;const c=t<1&&n===514?.25/t:1;return 6*Math.pow(1.5,22-l)*Math.max(t,1)*c}function nc(l,t){const n=1<<l.z;return!t&&(l.x===0||l.x===n-1)||l.y===0||l.y===n-1}const Ea=l=>({u_matrix:l});function Qc(l,t,n,c,d){if(d>0){const p=s.o.now(),m=(p-l.timeAdded)/d,y=t?(p-t.timeAdded)/d:-1,x=n.getSource(),T=c.coveringZoomLevel({tileSize:x.tileSize,roundZoom:x.roundZoom}),S=!t||Math.abs(t.tileID.overscaledZ-T)>Math.abs(l.tileID.overscaledZ-T),M=S&&l.refreshedUponExpiration?1:s.aA(S?m:1-y,0,1);return t?{opacity:1,mix:1-M,isFading:m<1}:{opacity:M,mix:0,isFading:m<1}}return{opacity:1,mix:0,isFading:!1}}class Lo extends Qo{constructor(t){const n=io("mock-dem",{type:"raster-dem",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("mock-dem",n,!1),n.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,n){t.state="loaded",n(null)}}class Dh extends Qo{constructor(t){const n=io("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("proxy",n,!1),n.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,n,c){if(t.freezeTileCoverage)return;this.transform=t;const d=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((p,m)=>{if(p[m.key]="",!this._tiles[m.key]){const y=new bs(m,this._source.tileSize*m.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);y.state="loaded",this._tiles[m.key]=y}return p}),{});for(const p in this._tiles)p in d||(this.freeFBO(p),this._tiles[p].unloadVectorData(),delete this._tiles[p])}freeFBO(t){const n=this.proxyCachedFBO[t];if(n!==void 0){const c=Object.values(n);this.renderCachePool.push(...c),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach((t=>t.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class oc extends s.aP{constructor(t,n,c){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=n,this.projMatrix=c}}class sc extends s.bU{constructor(t,n){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},(()=>{this._style.map.triggerRepaint()})),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},(()=>{this._style.map.triggerRepaint()})),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",(()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()})),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[c,d,p]=(function(x){const T=new s.bc,S=new s.b0,M=131;T.reserve(17161),S.reserve(33800);const E=s.al/128,C=s.al+E/2,R=C+E;for(let N=-E;N<R;N+=E)for(let k=-E;k<R;k+=E){const U=k<0||k>C||N<0||N>C?24575:0,$=s.aA(Math.round(k),0,s.al),G=s.aA(Math.round(N),0,s.al);T.emplaceBack($+U,G)}const z=(N,k)=>{const U=k*M+N;S.emplaceBack(U+1,U,U+M),S.emplaceBack(U+M,U+M+1,U+1)};for(let N=1;N<129;N++)for(let k=1;k<129;k++)z(k,N);return[0,129].forEach((N=>{for(let k=0;k<130;k++)z(k,N),z(N,k)})),[T,S,32768]})(),m=t.context;this.gridBuffer=m.createVertexBuffer(c,s.be.members),this.gridIndexBuffer=m.createIndexBuffer(d),this.gridSegments=s.bf.simpleSegment(0,0,c.length,d.length),this.gridNoSkirtSegments=s.bf.simpleSegment(0,0,c.length,p),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Dh(n.map),this.orthoMatrix=s.bB(),s.cd(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,s.al,0,s.al,0,1);const y=m.gl;this._overlapStencilMode=new Gt({func:y.GEQUAL,mask:255},0,255,y.KEEP,y.KEEP,y.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=n,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Lo(n.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(t,n,c){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const d=t.terrain.properties,p=t.terrain.drapeRenderMode===0,m=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=s.o.now();const y=t.terrain&&t.terrain.scope,x=d.get("source"),T=p?this._mockSourceCache:t.getSourceCache(x,y);if(!T)return void s.w("Couldn't find terrain source \"".concat(x,'".'));if(this.sourceCache=T,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=m?this.calculateExaggeration(n):d.get("exaggeration"),!n.projection.requiresDraping&&m&&this._exaggeration===0)return void this._disable();this.enabled=!0;const S=()=>{this.sourceCache.used&&s.w("Raster DEM source '".concat(this.sourceCache.id,"' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source."));const M=this.getScaledDemTileSize();this.sourceCache.update(n,M,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,S(),this._initializing=!0),S(),n.updateElevation(!0,c),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(n),this._emptyDEMTextureDirty=!0,this._previousZoom=n.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const n=this._previousCameraAltitude,c=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=c;const d=n!=null?c-n:Number.MAX_VALUE;if(Math.abs(d)<2)return this._exaggeration;const p=t.zoom,m=this._style.terrain;if(!this._previousUpdateTimestamp)return m.getExaggeration(p);let y=p-this._previousZoom;const x=this._previousUpdateTimestamp;let T=p;this._evaluationZoom!=null&&(T=this._evaluationZoom,Math.abs(p-T)>.5&&(y=.5*(p-T+y)),y*d<0&&(T+=y)),this._evaluationZoom=T;const S=m.getExaggeration(T),M=S===m.getExaggeration(Math.max(0,T-.1));if(M&&Math.abs(S-this._exaggeration)<.01)return S;let E=Math.min(.1,.00375*(this._updateTimestamp-x));return(M||S<.1||Math.abs(y)<1e-4)&&(E=Math.min(.2,4*E)),s.ak(this._exaggeration,S,E)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.dataType==="source"&&t.coord?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach((t=>t.fb.destroy())),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const n=this.proxySourceCache,c=this.painter.transform;this._initializing&&(this._initializing=c._centerAltitude===0&&this.getAtPointOrZero(s.ae.fromLngLat(c.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const d=this.proxyCoords=n.getIds().map((x=>{const T=n.getTileByID(x).tileID;return T.projMatrix=c.calculateProjMatrix(T.toUnwrapped()),T}));(function(x,T){const S=T.transform.pointCoordinate(T.transform.getCameraPoint()),M=new s.P(S.x,S.y);x.sort(((E,C)=>{if(C.overscaledZ-E.overscaledZ)return C.overscaledZ-E.overscaledZ;const R=new s.P(E.canonical.x+(1<<E.canonical.z)*E.wrap,E.canonical.y),z=new s.P(C.canonical.x+(1<<C.canonical.z)*C.wrap,C.canonical.y),N=M.mult(1<<E.canonical.z);return N.x-=.5,N.y-=.5,N.distSqr(R)-N.distSqr(z)}))})(d,this.painter);const p=this.proxyToSource||{};this.proxyToSource={},d.forEach((x=>{this.proxyToSource[x.key]={}})),this.terrainTileForTile={};const m=this._style._mergedSourceCaches;for(const x in m){const T=m[x];if(!T.used||(T!==this.sourceCache&&this.resetTileLookupCache(T.id),this._setupProxiedCoordsForOrtho(T,t[x],p),T.usedForTerrain))continue;const S=t[x];T.getSource().reparseOverscaled&&this._assignTerrainTiles(S)}this.proxiedCoords[n.id]=d.map((x=>new oc(x,x.key,this.orthoMatrix))),this._assignTerrainTiles(d),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(p),this.renderingToTexture=!1;const y={};this._visibleDemTiles=[];for(const x of this.proxyCoords){const T=this.terrainTileForTile[x.key];if(!T)continue;const S=T.tileID.key;S in y||(this._visibleDemTiles.push(T),y[S]=S)}}_assignTerrainTiles(t){this._initializing||t.forEach((n=>{if(this.terrainTileForTile[n.key])return;const c=this._findTileCoveringTileID(n,this.sourceCache);c&&(this.terrainTileForTile[n.key]=c)}))}_prepareDEMTextures(){const t=this.painter.context,n=t.gl;for(const c in this.terrainTileForTile){const d=this.terrainTileForTile[c],p=d.dem;!p||d.demTexture&&!d.needsDEMTextureUpload||(t.activeTexture.set(n.TEXTURE1),Hc(this.painter,d,p))}}_prepareDemTileUniforms(t,n,c,d){if(!n||n.demTexture==null)return!1;const p=t.tileID.canonical,m=Math.pow(2,n.tileID.canonical.z-p.z),y=d||"";return c["u_dem_tl".concat(y)]=[p.x*m%1,p.y*m%1],c["u_dem_scale".concat(y)]=m,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0;const n=this._visibleDemTiles.reduce(((c,d)=>{if(!d.dem)return c;const p=d.dem.tree.minimums[0];return p>0&&t++,c+p}),0);return t?n/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,n=t.gl;t.activeTexture.set(n.TEXTURE2);const c=this._getLoadedAreaMinimum(),d=new s.dK({width:1,height:1},new Float32Array([c]));this._emptyDEMTextureDirty=!1;let p=this._emptyDEMTexture;return p?p.update(d,{premultiply:!1}):p=this._emptyDEMTexture=new s.T(t,d,n.R32F,{premultiply:!1}),p}setupElevationDraw(t,n,c){const d=this.painter.context,p=d.gl,m={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};m.u_exaggeration=this.exaggeration();let y=null,x=null,T=1;if(c&&c.morphing&&this._useVertexMorphing){const C=c.morphing.srcDemTile,R=c.morphing.dstDemTile;T=c.morphing.phase,C&&R&&(this._prepareDemTileUniforms(t,C,m,"_prev")&&(x=C),this._prepareDemTileUniforms(t,R,m)&&(y=R))}const S=C=>C&&C.demTexture&&this.painter.linearFloatFilteringSupported()?p.LINEAR:p.NEAREST;let M=null;var E;if(this.enabled?x&&y?(M=y.demTexture,d.activeTexture.set(p.TEXTURE4),x.demTexture.bind(S(x),p.CLAMP_TO_EDGE),m.u_dem_lerp=T):(y=this.terrainTileForTile[t.tileID.key],M=this._prepareDemTileUniforms(t,y,m)?y.demTexture:this.emptyDEMTexture):M=this.emptyDEMTexture,d.activeTexture.set(p.TEXTURE2),M&&(m.u_dem_size=(E=M).size[0]===1?1:E.size[0]-2,M.bind(S(y),p.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(c&&c.useDepthForOcclusion,n,m),c&&c.useMeterToDem&&y){const C=(1<<y.tileID.canonical.z)*s.ce(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;m.u_meter_to_dem=C}if(c&&c.labelPlaneMatrixInv&&(m.u_label_plane_matrix_inv=c.labelPlaneMatrixInv),n.setTerrainUniformValues(d,m),this.painter.transform.projection.name==="globe"){const C=this.globeUniformValues(this.painter.transform,t.tileID.canonical,c&&c.useDenormalizedUpVectorScale);n.setGlobeUniformValues(d,C)}}globeUniformValues(t,n,c){const d=t.projection;return{u_tile_tl_up:d.upVector(n,0,0),u_tile_tr_up:d.upVector(n,s.al,0),u_tile_br_up:d.upVector(n,s.al,s.al),u_tile_bl_up:d.upVector(n,0,s.al),u_tile_up_scale:c?s.dL(1):d.upVectorScale(n,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const n=this.painter,c=this.painter.context;t.length!==0&&(c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),n.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,(function(d,p,m,y,x){if(d.transform.projection.name==="globe")(function(T,S,M,E,C){const R=T.context,z=R.gl;let N,k;const U=T.transform,$=s.dD(T,R,U),G=(Ae,ve)=>{if(k===ve)return;const ze=[Rh[ve],"PROJECTION_GLOBE_VIEW"];$&&ze.push("CUSTOM_ANTIALIASING");const Xe=T.isTileAffectedByFog(Ae);N=T.getOrCreateProgram("globeRaster",{defines:ze,overrideFog:Xe}),k=ve},ee=T.colorModeForRenderPass(),Z=new xt(z.LEQUAL,xt.ReadWrite,T.depthRangeFor3D);Sa.update(C);const ie=s.dE(U),Q=[s.aF(U.center.lng),s.aJ(U.center.lat)],Y=T.globeSharedBuffers,re=[U.width*s.o.devicePixelRatio,U.height*s.o.devicePixelRatio],_e=Float32Array.from(U.globeMatrix),he={useDenormalizedUpVectorScale:!0};{const Ae=T.transform,ve=Ff(Ae.zoom,S.exaggeration(),S.sourceCache._source.tileSize);k=-1;const ze=z.TRIANGLES;for(const Xe of E){const xe=M.getTile(Xe),ce=Gt.disabled,Le=S.prevTerrainTileForTile[Xe.key],be=S.terrainTileForTile[Xe.key];Jc(Le,be)&&Sa.newMorphing(Xe.key,Le,be,C,250),R.activeTexture.set(z.TEXTURE0),xe.texture&&xe.texture.bind(z.LINEAR,z.CLAMP_TO_EDGE);const Ve=Sa.getMorphValuesForProxy(Xe.key),Qe=Ve?1:0;Ve&&Object.assign(he,{morphing:{srcDemTile:Ve.from,dstDemTile:Ve.to,phase:s.dC(Ve.phase)}});const mt=s.dF(Xe.canonical),$e=s.dG(mt.getCenter().lat),Ke=s.dH(Xe.canonical,mt,$e,Ae.worldSize/Ae._pixelsPerMercatorPixel),gt=s.bj(s.dI(Xe.canonical)),ht=Kc(Ae.expandedFarZProjMatrix,_e,ie,gt,s.aj(Ae.zoom),Q,Ae.frustumCorners.TL,Ae.frustumCorners.TR,Ae.frustumCorners.BR,Ae.frustumCorners.BL,Ae.globeCenterInViewSpace,Ae.globeRadius,re,ve,Ae._farZ,Ke);if(G(Xe,Qe),N&&(S.setupElevationDraw(xe,N,he),T.uploadCommonUniforms(R,N,Xe.toUnwrapped()),Y)){const[ct,dt,Pt]=Y.getGridBuffers($e,ve!==0);N.draw(T,ze,Z,ce,ee,Bt.backCCW,ht,"globe_raster",ct,dt,Pt)}}}if(Y&&(T.renderDefaultNorthPole||T.renderDefaultSouthPole)){const Ae=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];$&&Ae.push("CUSTOM_ANTIALIASING"),N=T.getOrCreateProgram("globeRaster",{defines:Ae});for(const ve of E){const{x:ze,y:Xe,z:xe}=ve.canonical,ce=Xe===0,Le=Xe===(1<<xe)-1,[be,Ve,Qe,mt]=Y.getPoleBuffers(xe,!1);if(mt&&(ce||Le)){const $e=M.getTile(ve);R.activeTexture.set(z.TEXTURE0),$e.texture&&$e.texture.bind(z.LINEAR,z.CLAMP_TO_EDGE);let Ke=s.dJ(xe,ze,U);const gt=s.bj(s.dI(ve.canonical)),ht=(ct,dt)=>ct.draw(T,z.TRIANGLES,Z,Gt.disabled,ee,Bt.disabled,Kc(U.expandedFarZProjMatrix,Ke,Ke,gt,0,Q,U.frustumCorners.TL,U.frustumCorners.TR,U.frustumCorners.BR,U.frustumCorners.BL,U.globeCenterInViewSpace,U.globeRadius,re,0,U._farZ),"globe_pole_raster",dt,Qe,mt);S.setupElevationDraw($e,N,he),T.uploadCommonUniforms(R,N,ve.toUnwrapped()),ce&&T.renderDefaultNorthPole&&ht(N,be),Le&&T.renderDefaultSouthPole&&(Ke=s.cR(s.bB(),Ke,[1,-1,1]),ht(N,Ve))}}}})(d,p,m,y,x);else{const T=d.context,S=T.gl;let M,E;const C=d.shadowRenderer,R=Fs(d,d.longestCutoffRange),z=ee=>{if(E===ee)return;const Z=[];Z.push(Rh[ee]),R.shouldRenderCutoff&&Z.push("RENDER_CUTOFF"),C&&(Z.push("RENDER_SHADOWS","DEPTH_TEXTURE"),C.useNormalOffset&&Z.push("NORMAL_OFFSET")),M=d.getOrCreateProgram("terrainRaster",{defines:Z}),E=ee},N=d.colorModeForRenderPass(),k=new xt(S.LEQUAL,xt.ReadWrite,d.depthRangeFor3D);Sa.update(x);const U=d.transform,$=Ff(U.zoom,p.exaggeration(),p.sourceCache._source.tileSize);let G=[0,0,0];if(C){const ee=d.style.directionalLight,Z=d.style.ambientLight;ee&&Z&&(G=is(d.style,ee,Z))}{E=-1;const ee=S.TRIANGLES,[Z,ie]=[p.gridIndexBuffer,p.gridSegments];for(const Q of y){const Y=m.getTile(Q),re=Gt.disabled,_e=p.prevTerrainTileForTile[Q.key],he=p.terrainTileForTile[Q.key];Jc(_e,he)&&Sa.newMorphing(Q.key,_e,he,x,250),T.activeTexture.set(S.TEXTURE0),Y.texture&&Y.texture.bind(S.LINEAR,S.CLAMP_TO_EDGE);const Ae=Sa.getMorphValuesForProxy(Q.key),ve=Ae?1:0;let ze;Ae&&(ze={morphing:{srcDemTile:Ae.from,dstDemTile:Ae.to,phase:s.dC(Ae.phase)}});const Xe=Ph(Q.projMatrix,nc(Q.canonical,U.renderWorldCopies)?$/10:$,G);if(z(ve),!M)continue;p.setupElevationDraw(Y,M,ze);const xe=Q.toUnwrapped();C&&C.setupShadows(xe,M),d.uploadCommonUniforms(T,M,xe,null,R),M.draw(d,ee,k,re,N,Bt.backCCW,Xe,"terrain_raster",p.gridBuffer,Z,ie)}}}})(n,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,n.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const n=this.painter,c=this.painter.context,d=this.proxySourceCache,p=this.proxiedCoords[d.id],m=this._drapedRenderBatches.shift(),y=n.style.order,x=[];let T=0;for(const S of p){const M=d.getTileByID(S.proxyTileKey),E=d.proxyCachedFBO[S.key]?d.proxyCachedFBO[S.key][t]:void 0,C=E!==void 0?d.renderCache[E]:this.pool[T++],R=E!==void 0;if(M.texture=C.tex,R&&!C.dirty){x.push(M.tileID);continue}let z;c.bindFramebuffer.set(C.fb.framebuffer),this.renderedToTile=!1,C.dirty&&(c.clear({color:s.ao.transparent,stencil:0}),C.dirty=!1);for(let N=m.start;N<=m.end;++N){const k=n.style._mergedLayers[y[N]];if(k.isHidden(n.transform.zoom))continue;const U=n.style.getLayerSourceCache(k),$=U?this.proxyToSource[S.key][U.id]:[S];if(!$)continue;const G=$;c.viewport.set([0,0,C.fb.width,C.fb.height]),z!==(U?U.id:null)&&(this._setupStencil(C,$,k,U),z=U?U.id:null),n.renderLayer(n,U,k,G)}if(this._drapedRenderBatches.length===0)for(const N of this._pendingGroundEffectLayers){const k=n.style._mergedLayers[y[N]];if(k.isHidden(n.transform.zoom))continue;const U=n.style.getLayerSourceCache(k),$=U?this.proxyToSource[S.key][U.id]:[S];if(!$)continue;const G=$;c.viewport.set([0,0,C.fb.width,C.fb.height]),z!==(U?U.id:null)&&(this._setupStencil(C,$,k,U),z=U?U.id:null),n.renderLayer(n,U,k,G)}this.renderedToTile?(C.dirty=!0,x.push(M.tileID)):R||--T,T===5&&(T=0,this.renderToBackBuffer(x))}return this.renderToBackBuffer(x),this.renderingToTexture=!1,c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),m.end+1}postRender(){}isLayerOrderingCorrect(t){const n=t.order.length;let c=-1,d=n;for(let p=0;p<n;++p)this._style.isLayerDraped(t._mergedLayers[t.order[p]])?c=Math.max(c,p):d=Math.min(d,p);return d>c}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter((n=>n.dem)).forEach((n=>{t=Math.min(t,n.dem.tree.minimums[0])})),t===0?t:(t-30)*this._exaggeration}raycast(t,n,c){if(!this._visibleDemTiles)return null;const d=this._visibleDemTiles.filter((p=>p.dem)).map((p=>{const m=p.tileID,y=1<<m.overscaledZ,{x,y:T}=m.canonical,S=x/y,M=(x+1)/y,E=T/y,C=(T+1)/y;return{minx:S,miny:E,maxx:M,maxy:C,t:p.dem.tree.raycastRoot(S,E,M,C,t,n,c),tile:p}}));d.sort(((p,m)=>(p.t!==null?p.t:Number.MAX_VALUE)-(m.t!==null?m.t:Number.MAX_VALUE)));for(const p of d){if(p.t==null)return null;const m=p.tile.dem.tree.raycast(p.minx,p.miny,p.maxx,p.maxy,t,n,c);if(m!=null)return m}return null}_createFBO(){const t=this.painter.context,n=t.gl,c=this.drapeBufferSize;t.activeTexture.set(n.TEXTURE0);const d=new s.T(t,{width:c[0],height:c[1],data:null},n.RGBA8);d.bind(n.LINEAR,n.CLAMP_TO_EDGE);const p=t.createFramebuffer(c[0],c[1],!0,null);return p.colorAttachment.set(d.texture),p.depthAttachment=new Ch(t,p.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,c[0],c[1]),this._stencilRef=0,p.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):p.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&n.texParameterf(n.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:p,tex:d,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some((t=>{const n=this._style._mergedLayers[t],c=n.isHidden(this.painter.transform.zoom);return n.type==="hillshade"||n.type==="custom"?!c&&n.shouldRedrape():!c&&n.hasTransition()}))}_clearLineLayersFromRenderCache(){let t=!1;for(const c of this._style.getSources())if(c instanceof Xn){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(p&&!n[p.id]&&!d.isHidden(this.painter.transform.zoom)&&d.type==="line"&&d.widthExpression()instanceof s.ad){n[p.id]=!0;for(const m of this.proxyCoords){const y=this.proxyToSource[m.key][p.id];if(y)for(const x of y)this._clearRenderCacheForTile(p.id,x)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const c in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[c]._source instanceof Ko){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(!p||n[p.id]||d.isHidden(this.painter.transform.zoom)||d.type!=="raster")continue;const m=d.paint.get("raster-fade-duration");for(const y of this.proxyCoords){const x=this.proxyToSource[y.key][p.id];if(x)for(const T of x){const S=Qc(p.getTile(T),p.findLoadedParent(T,0),p,this.painter.transform,m);(S.opacity!==1||S.mix!==0)&&this._clearRenderCacheForTile(p.id,T)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,n=t.length;if(n===0)return;const c=[];this._pendingGroundEffectLayers=[];let d,p=0,m=this._style._mergedLayers[t[p]];for(;!this._style.isLayerDraped(m)&&m.isHidden(this.painter.transform.zoom)&&++p<n;)m=this._style._mergedLayers[t[p]];for(;p<n;++p){const y=this._style._mergedLayers[t[p]];y.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(y)?d===void 0&&(d=p):(y.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(p),d!==void 0&&(c.push({start:d,end:p-1}),d=void 0)))}if(d!==void 0&&c.push({start:d,end:p-1}),c.length!==0){const y=c[c.length-1];this._pendingGroundEffectLayers.every((x=>x>y.end))||s.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=c}_setupRenderCache(t){const n=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,n.renderCache.length>n.renderCachePool.length){const m=Object.values(n.proxyCachedFBO);n.proxyCachedFBO={};for(let y=0;y<m.length;++y){const x=Object.values(m[y]);n.renderCachePool.push(...x)}}return}this._clearRasterLayersFromRenderCache();const c=this.proxyCoords,d=this._tilesDirty;for(let m=c.length-1;m>=0;m--){const y=c[m];if(n.getTileByID(y.key),n.proxyCachedFBO[y.key]!==void 0){const x=t[y.key],T=this.proxyToSource[y.key];let S=0;for(const M in T){const E=T[M],C=x[M];if(!C||C.length!==E.length||E.some(((R,z)=>R!==C[z]||d[M]&&d[M].hasOwnProperty(R.key)))){S=-1;break}++S}for(const M in n.proxyCachedFBO[y.key])n.renderCache[n.proxyCachedFBO[y.key][M]].dirty=S<0||S!==Object.values(x).length}}const p=[...this._drapedRenderBatches];p.sort(((m,y)=>y.end-y.start-(m.end-m.start)));for(const m of p)for(const y of c){if(n.proxyCachedFBO[y.key])continue;let x=n.renderCachePool.pop();x===void 0&&n.renderCache.length<50&&(x=n.renderCache.length,n.renderCache.push(this._createFBO())),x!==void 0&&(n.proxyCachedFBO[y.key]={},n.proxyCachedFBO[y.key][m.start]=x,n.renderCache[x].dirty=!0)}this._tilesDirty={}}_setupStencil(t,n,c,d){if(!d||!this._sourceTilesOverlap[d.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const p=this.painter.context,m=p.gl;if(n.length<=1)return void(this._overlapStencilType=!1);let y;if(c.isTileClipped())y=n.length,this._overlapStencilMode.test={func:m.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(n[0].overscaledZ>n[n.length-1].overscaledZ))return void(this._overlapStencilType=!1);y=1,this._overlapStencilMode.test={func:m.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+y>255&&(p.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=y,this._overlapStencilMode.ref=this._stencilRef,c.isTileClipped()&&this._renderTileClippingMasks(n,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Gt.disabled}_renderTileClippingMasks(t,n){const c=this.painter,d=this.painter.context,p=d.gl;c._tileClippingMaskIDs={},d.setColorMode(ti.disabled),d.setDepthMode(xt.disabled);const m=c.getOrCreateProgram("clippingMask");for(const y of t){const x=c._tileClippingMaskIDs[y.key]=--n;m.draw(c,p.TRIANGLES,xt.disabled,new Gt({func:p.ALWAYS,mask:0},x,255,p.KEEP,p.KEEP,p.REPLACE),ti.disabled,Bt.disabled,Ea(y.projMatrix),"$clipping",c.tileExtentBuffer,c.quadTriangleIndexBuffer,c.tileExtentSegments)}}pointCoordinate(t){const n=this.painter.transform;if(t.x<0||t.x>n.width||t.y<0||t.y>n.height)return null;const c=[t.x,t.y,1,1];s.aC(c,c,n.pixelMatrixInverse),s.cJ(c,c,1/c[3]),c[0]/=n.worldSize,c[1]/=n.worldSize;const d=n._camera.position,p=s.ce(1,n.center.lat),m=[d[0],d[1],d[2]/p,0],y=s.d9([],c.slice(0,3),m);s.aw(y,y);const x=this.raycast(m,y,this._exaggeration);return x!==null&&x?(s.bG(m,m,y,x),m[3]=m[2],m[2]*=p,m):null}_setupProxiedCoordsForOrtho(t,n,c){if(t.getSource()instanceof s.aT)return this._setupProxiedCoordsForImageSource(t,n,c);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const d=this.proxiedCoords[t.id]=[],p=this.proxyCoords;for(let x=0;x<p.length;x++){const T=p[x],S=this._findTileCoveringTileID(T,t);if(S){const M=this._createProxiedId(T,S,c[T.key]&&c[T.key][t.id]);d.push(M),this.proxyToSource[T.key][t.id]=[M]}}let m=!1;const y=new Set;for(let x=0;x<n.length;x++){const T=t.getTile(n[x]);if(!T||!T.hasData())continue;const S=this._findTileCoveringTileID(T.tileID,this.proxySourceCache);if(S&&S.tileID.canonical.z!==T.tileID.canonical.z){const M=this.proxyToSource[S.tileID.key][t.id],E=this._createProxiedId(S.tileID,T,c[S.tileID.key]&&c[S.tileID.key][t.id]);M?M.splice(M.length-1,0,E):this.proxyToSource[S.tileID.key][t.id]=[E];const C=this.proxyToSource[S.tileID.key][t.id];y.has(C)||y.add(C),d.push(E),m=!0}}if(this._sourceTilesOverlap[t.id]=m,m&&this._debugParams.sortTilesHiZFirst)for(const x of y)x.sort(((T,S)=>S.overscaledZ-T.overscaledZ))}_setupProxiedCoordsForImageSource(t,n,c){if(!t.getSource().loaded())return;const d=this.proxiedCoords[t.id]=[],p=this.proxyCoords,m=t.getSource(),y=m.tileID;if(!y)return;const x=new s.P(y.x,y.y)._div(1<<y.z),T=m.coordinates.map(s.ae.fromLngLat).reduce(((M,E)=>(M.min.x=Math.min(M.min.x,E.x-x.x),M.min.y=Math.min(M.min.y,E.y-x.y),M.max.x=Math.max(M.max.x,E.x-x.x),M.max.y=Math.max(M.max.y,E.y-x.y),M)),{min:new s.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new s.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),S=(M,E)=>{const C=M.wrap+M.canonical.x/(1<<M.canonical.z),R=M.canonical.y/(1<<M.canonical.z),z=s.al/(1<<M.canonical.z),N=E.wrap+E.canonical.x/(1<<E.canonical.z),k=E.canonical.y/(1<<E.canonical.z);return C+z<N+T.min.x||C>N+T.max.x||R+z<k+T.min.y||R>k+T.max.y};for(let M=0;M<p.length;M++){const E=p[M];for(let C=0;C<n.length;C++){const R=t.getTile(n[C]);if(!R||!R.hasData()||S(E,R.tileID))continue;const z=this._createProxiedId(E,R,c[E.key]&&c[E.key][t.id]),N=this.proxyToSource[E.key][t.id];N?N.push(z):this.proxyToSource[E.key][t.id]=[z],d.push(z)}}}_createProxiedId(t,n,c){let d=this.orthoMatrix;if(c){const p=c.find((m=>m.key===n.tileID.key));if(p)return p}if(n.tileID.key!==t.key){const p=t.canonical.z-n.tileID.canonical.z;let m,y,x;d=s.bB();const T=n.tileID.wrap-t.wrap<<t.overscaledZ;p>0?(m=s.al>>p,y=m*((n.tileID.canonical.x<<p)-t.canonical.x+T),x=m*((n.tileID.canonical.y<<p)-t.canonical.y)):(m=s.al<<-p,y=s.al*(n.tileID.canonical.x-(t.canonical.x+T<<-p)),x=s.al*(n.tileID.canonical.y-(t.canonical.y<<-p))),s.cd(d,0,m,0,m,0,1),s.bq(d,d,[y,x,0])}return new oc(n.tileID,t.key,d)}_findTileCoveringTileID(t,n){let c=n.getTile(t);if(c&&c.hasData())return c;const d=this._findCoveringTileCache[n.id],p=d[t.key];if(c=p?n.getTileByID(p):null,c&&c.hasData()||p===null)return c;let m=c?c.tileID:t,y=m.overscaledZ;const x=n.getSource().minzoom,T=[];if(!p){const M=n.getSource().maxzoom;if(t.canonical.z>=M){const E=t.canonical.z-M;n.getSource().reparseOverscaled?(y=Math.max(t.canonical.z+2,n.transform.tileZoom),m=new s.aP(y,t.wrap,M,t.canonical.x>>E,t.canonical.y>>E)):E!==0&&(y=M,m=new s.aP(y,t.wrap,M,t.canonical.x>>E,t.canonical.y>>E))}m.key!==t.key&&(T.push(m.key),c=n.getTile(m))}const S=M=>{T.forEach((E=>{d[E]=M})),T.length=0};for(y-=1;y>=x&&(!c||!c.hasData());y--){c&&S(c.tileID.key);const M=m.calculateScaledKey(y);if(c=n.getTileByID(M),c&&c.hasData())break;const E=d[M];if(E===null)break;E===void 0?T.push(M):c=n.getTileByID(E)}return S(c?c.tileID.key:null),c&&c.hasData()?c:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,n){let c=this._tilesDirty[t];c||(c=this._tilesDirty[t]={}),c[n.key]=!0}}function zh(l,t,n){const c=(function(y,x,T){const S=s.bI(x,y),M=s.bI(T,[.2126,.7152,.0722]),E=(R,z,N)=>(1-N)*R+N*z,C=E(1-.3*Math.min(M,1),1,Math.min(S+1,1));return E(.92,1,Math.asin(s.aA(x[2],-1,1))/Math.PI+.5)*C})(l,[0,0,1],t),d=[0,0,0];s.c4(d,n.slice(0,3),c);const p=[0,0,0];s.c4(p,t.slice(0,3),l[2]);const m=[0,0,0];return s.d7(m,d,p),s.da(m)}const Lh=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Oh=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class ac{static cacheKey(t,n,c,d){let p="".concat(n).concat(d?d.cacheKey:"");for(const m of c)t.usedDefines.includes(m)&&(p+="/".concat(m));return p}constructor(t,n,c,d,p,m){const y=t.gl;this.program=y.createProgram(),this.configuration=d,this.name=n,this.fixedDefines=[...m];let x=d?d.defines():[];x=x.concat(m.map((R=>"#define ".concat(R))));const T="#version 300 es\n";let S=T+x.concat("precision mediump float;",Ss,tc.fragmentSource).join("\n");for(const R of c.fragmentIncludes)S+="\n".concat(Xa[R]);S+="\n".concat(c.fragmentSource);let M=T+x.concat("precision highp float;",Ss,tc.vertexSource).join("\n");for(const R of c.vertexIncludes)M+="\n".concat(Xa[R]);this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&c.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(M+="\nuniform int u_instanceID;\n"),M+="\n".concat(c.vertexSource),this.forceManualRenderingForInstanceIDShaders&&(M=M.replaceAll("gl_InstanceID","u_instanceID"));const E=y.createShader(y.FRAGMENT_SHADER);if(y.isContextLost())return void(this.failedToCreate=!0);y.shaderSource(E,S),y.compileShader(E),y.attachShader(this.program,E);const C=y.createShader(y.VERTEX_SHADER);y.isContextLost()?this.failedToCreate=!0:(y.shaderSource(C,M),y.compileShader(C),y.attachShader(this.program,C),this.attributes={},y.linkProgram(this.program),y.deleteShader(C),y.deleteShader(E),this.fixedUniforms=p(t),this.binderUniforms=d?d.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(R=>({u_instanceID:new s.cg(R)}))(t)),(m.includes("TERRAIN")||n.indexOf("symbol")!==-1||n.indexOf("circle")!==-1)&&(this.terrainUniforms=(R=>({u_dem:new s.cg(R),u_dem_prev:new s.cg(R),u_dem_tl:new s.cj(R),u_dem_scale:new s.ci(R),u_dem_tl_prev:new s.cj(R),u_dem_scale_prev:new s.ci(R),u_dem_size:new s.ci(R),u_dem_lerp:new s.ci(R),u_exaggeration:new s.ci(R),u_depth:new s.cg(R),u_depth_size_inv:new s.cj(R),u_depth_range_unpack:new s.cj(R),u_occluder_half_size:new s.ci(R),u_occlusion_depth_offset:new s.ci(R),u_meter_to_dem:new s.ci(R),u_label_plane_matrix_inv:new s.ck(R)}))(t)),m.includes("GLOBE")&&(this.globeUniforms=(R=>({u_tile_tl_up:new s.ch(R),u_tile_tr_up:new s.ch(R),u_tile_br_up:new s.ch(R),u_tile_bl_up:new s.ch(R),u_tile_up_scale:new s.ci(R)}))(t)),m.includes("FOG")&&(this.fogUniforms=(R=>({u_fog_matrix:new s.ck(R),u_fog_range:new s.cj(R),u_fog_color:new s.d2(R),u_fog_horizon_blend:new s.ci(R),u_fog_vertical_limit:new s.cj(R),u_fog_temporal_offset:new s.ci(R),u_frustum_tl:new s.ch(R),u_frustum_tr:new s.ch(R),u_frustum_br:new s.ch(R),u_frustum_bl:new s.ch(R),u_globe_pos:new s.ch(R),u_globe_radius:new s.ci(R),u_globe_transition:new s.ci(R),u_is_globe:new s.cg(R),u_viewport:new s.cj(R)}))(t)),m.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(R=>({u_cutoff_params:new s.d2(R)}))(t)),m.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(R=>({u_lighting_ambient_color:new s.ch(R),u_lighting_directional_dir:new s.ch(R),u_lighting_directional_color:new s.ch(R),u_ground_radiance:new s.ch(R)}))(t)),m.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(R=>({u_light_matrix_0:new s.ck(R),u_light_matrix_1:new s.ck(R),u_fade_range:new s.cj(R),u_shadow_normal_offset:new s.ch(R),u_shadow_intensity:new s.ci(R),u_shadow_texel_size:new s.ci(R),u_shadow_map_resolution:new s.ci(R),u_shadow_direction:new s.ch(R),u_shadow_bias:new s.ch(R),u_shadowmap_0:new s.cg(R),u_shadowmap_1:new s.cg(R)}))(t)))}getAttributeLocation(t,n){let c=this.attributes[n];return c===void 0&&(c=this.attributes[n]=t.getAttribLocation(this.program,n)),c}setTerrainUniformValues(t,n){if(!this.terrainUniforms)return;const c=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d]&&c[d].set(this.program,d,n[d])}}setGlobeUniformValues(t,n){if(!this.globeUniforms)return;const c=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d]&&c[d].set(this.program,d,n[d])}}setFogUniformValues(t,n){if(!this.fogUniforms)return;const c=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setCutoffUniformValues(t,n){if(!this.cutoffUniforms)return;const c=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setLightsUniformValues(t,n){if(!this.lightsUniforms)return;const c=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setShadowUniformValues(t,n){if(this.failedToCreate||!this.shadowUniforms)return;const c=this.shadowUniforms;t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}_drawDebugWireframe(t,n,c,d,p,m,y,x,T,S){const M=t.options.wireframe;if(M.terrain===!1&&M.layers2D===!1&&M.layers3D===!1)return;const E=t.context;if(!(!(!M.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!M.layers2D||t._terrain&&t._terrain.renderingToTexture||!Lh.includes(this.name))||!(!M.layers3D||!Oh.includes(this.name))))return;const C=E.gl,R=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,p,E);if(!R)return;const z=[...this.fixedDefines];z.push("DEBUG_WIREFRAME");const N=t.getOrCreateProgram(this.name,{config:this.configuration,defines:z});E.program.set(N.program);const k=(G,ee,Z)=>{if(ee[G]&&Z[G])for(const ie in ee[G])Z[G][ie]&&Z[G][ie].set(Z.program,ie,ee[G][ie].current)};T&&T.setUniforms(N.program,E,N.binderUniforms,y,{zoom:x}),k("fixedUniforms",this,N),k("terrainUniforms",this,N),k("globeUniforms",this,N),k("fogUniforms",this,N),k("lightsUniforms",this,N),k("shadowUniforms",this,N),R.bind(),E.setColorMode(new ti([C.ONE,C.ONE_MINUS_SRC_ALPHA,C.ZERO,C.ONE],s.ao.transparent,[!0,!0,!0,!1])),E.setDepthMode(new xt(n.func===C.LESS?C.LEQUAL:n.func,xt.ReadOnly,n.range)),E.setStencilMode(Gt.disabled);const U=3*m.primitiveLength*2,$=3*m.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const G=S||1;for(let ee=0;ee<G;++ee)N.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ee),C.drawElements(C.LINES,U,C.UNSIGNED_SHORT,$)}else S&&S>1?C.drawElementsInstanced(C.LINES,U,C.UNSIGNED_SHORT,$,S):C.drawElements(C.LINES,U,C.UNSIGNED_SHORT,$);p.bind(),E.program.set(this.program),E.setDepthMode(n),E.setStencilMode(c),E.setColorMode(d)}checkUniforms(t,n,c){if(this.fixedDefines.includes(n)){for(const d of Object.keys(c))if(!c[d].initialized)throw new Error("Program '".concat(this.name,"', from draw '").concat(t,"': uniform ").concat(d," not set but required by ").concat(n," being defined"))}}draw(t,n,c,d,p,m,y,x,T,S,M,E,C,R,z,N){const k=t.context,U=k.gl;if(this.failedToCreate)return;k.program.set(this.program),k.setDepthMode(c),k.setStencilMode(d),k.setColorMode(p),k.setCullFace(m);for(const ee of Object.keys(this.fixedUniforms))this.fixedUniforms[ee].set(this.program,ee,y[ee]);R&&R.setUniforms(this.program,k,this.binderUniforms,E,{zoom:C});const $={[U.POINTS]:1,[U.LINES]:2,[U.TRIANGLES]:3,[U.LINE_STRIP]:1}[n];this.checkUniforms(x,"RENDER_SHADOWS",this.shadowUniforms);const G=N&&N>0?1:void 0;for(const ee of M.get()){const Z=ee.vaos||(ee.vaos={});if((Z[x]||(Z[x]=new Ya)).bind(k,this,T,R?R.getPaintVertexBuffers():[],S,ee.vertexOffset,z||[],G),this.forceManualRenderingForInstanceIDShaders){const ie=N||1;for(let Q=0;Q<ie;++Q)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Q),S?U.drawElements(n,ee.primitiveLength*$,U.UNSIGNED_SHORT,ee.primitiveOffset*$*2):U.drawArrays(n,ee.vertexOffset,ee.vertexLength)}else N&&N>1?U.drawElementsInstanced(n,ee.primitiveLength*$,U.UNSIGNED_SHORT,ee.primitiveOffset*$*2,N):S?U.drawElements(n,ee.primitiveLength*$,U.UNSIGNED_SHORT,ee.primitiveOffset*$*2):U.drawArrays(n,ee.vertexOffset,ee.vertexLength);n===U.TRIANGLES&&S&&this._drawDebugWireframe(t,c,d,p,S,ee,E,C,R,N)}}}function eu(l,t,n=0){const c=Math.pow(2,t.tileID.overscaledZ),d=t.tileSize*Math.pow(2,l.transform.tileZoom)/c,p=d*(t.tileID.canonical.x+t.tileID.wrap*c),m=d*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/s.ay(t,1,l.transform.tileZoom),u_pixel_coord_upper:[p>>16,m>>16],u_pixel_coord_lower:[65535&p,65535&m],u_pattern_transition:n}}const tl={terrain:0,flat:1},tu=s.bB(),iu=(l,t,n,c,d,p,m,y,x,T,S,M,E,C,R,z,N,k)=>{const U=t.style.light,$=U.properties.get("position"),G=[$.x,$.y,$.z],ee=s.dN();U.properties.get("anchor")==="viewport"&&(s.dO(ee,-t.transform.angle),s.dP(G,G,ee));const Z=U.properties.get("color").toPremultipliedRenderColor(null),ie=t.transform,Q={u_matrix:l,u_lightpos:G,u_lightintensity:U.properties.get("intensity"),u_lightcolor:[Z.r,Z.g,Z.b],u_vertical_gradient:+n,u_opacity:c,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:tu,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:tl[T],u_base_type:tl[S],u_ao:d,u_edge_radius:p,u_width_scale:m,u_flood_light_color:R,u_vertical_scale:z,u_flood_light_intensity:N,u_ground_shadow_factor:k};return ie.projection.name==="globe"&&(Q.u_tile_id=[y.canonical.x,y.canonical.y,1<<y.canonical.z],Q.u_zoom_transition=M,Q.u_inv_rot_matrix=C,Q.u_merc_center=E,Q.u_up_dir=ie.projection.upVector(new s.cC(0,0,0),E[0]*s.al,E[1]*s.al),Q.u_height_lift=x),Q},kf=(l,t,n,c,d,p)=>({u_matrix:l,u_edge_radius:t,u_width_scale:n,u_vertical_scale:c,u_height_type:tl[d],u_base_type:tl[p]}),Bf=(l,t,n,c,d,p,m,y,x,T,S,M,E,C,R,z,N,k)=>{const U=iu(l,t,n,c,d,p,m,y,T,S,M,E,C,R,z,N,1,[0,0,0]),$={u_height_factor:-Math.pow(2,y.overscaledZ)/x.tileSize/8};return Object.assign(U,eu(t,x,k),$)},il=(l,t,n,c,d,p,m,y,x,T,S)=>({u_matrix:t,u_opacity:n,u_ao_pass:c?1:0,u_meter_to_tile:d,u_ao:p,u_flood_light_intensity:m,u_flood_light_color:y,u_attenuation:x,u_edge_radius:T,u_fb:0,u_fb_size:S,u_dynamic_offset:1}),Nf=(l,t,n)=>({u_matrix:l,u_emissive_strength:t,u_ground_shadow_factor:n}),Vf=(l,t,n,c,d,p=0)=>Object.assign(Nf(l,t,d),eu(n,c,p)),Om=(l,t,n,c)=>({u_matrix:l,u_world:n,u_emissive_strength:t,u_ground_shadow_factor:c}),Fm=(l,t,n,c,d,p,m=0)=>Object.assign(Vf(l,t,n,c,p,m),{u_world:d}),km=(l,t)=>({u_matrix:l,u_ground_shadow_factor:t}),ru=(l,t,n,c,d)=>({u_matrix:l,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:n,u_height_scale:c,u_reset_depth:d}),Fh=(l,t,n,c,d,p,m,y,x)=>({u_matrix:l,u_normal_matrix:t,u_opacity:n,u_faux_facade_ao_intensity:c,u_camera_pos:d,u_tile_to_meter:p,u_facade_emissive_chance:m,u_flood_light_color:y,u_flood_light_intensity:x}),kh=l=>({u_matrix:l}),Uf=l=>({u_matrix:l}),rl=(l,t,n,c,d,p,m,y)=>{const x=s.al/p.tileSize;return{u_matrix:l,u_inv_rot_matrix:t,u_camera_to_center_distance:n.getCameraToCenterDistance(y),u_extrude_scale:[n.pixelsToGLUnits[0]/x,n.pixelsToGLUnits[1]/x],u_zoom_transition:c,u_tile_id:m,u_merc_center:d}},Bh=(l,t,n=1)=>({u_matrix:l,u_color:t,u_overlay:0,u_overlay_scale:n}),jf=s.bB(),Gf=(l,t,n,c,d,p,m)=>{const y=l.transform,x=y.projection.name==="globe",T=x?s.dQ(y.zoom,t.canonical)*y._pixelsPerMercatorPixel:s.ay(n,1,p),S={u_matrix:t.projMatrix,u_extrude_scale:T,u_intensity:m,u_inv_rot_matrix:jf,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(x){S.u_inv_rot_matrix=c,S.u_merc_center=d,S.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],S.u_zoom_transition=s.aj(y.zoom);const M=d[0]*s.al,E=d[1]*s.al;S.u_up_dir=y.projection.upVector(new s.cC(0,0,0),M,E)}return S};function nu(l,[t,n,c,d],[p,m]){if(p===m)return[0,0,0,0];const y=255*(l-1)/(l*(m-p));return[t*y,n*y,c*y,d*y]}function ks(l,t,[n,c]){return n===c?0:.5/l+(t-n)*(l-1)/(l*(c-n))}const lc=(l,t,n,c,d,p,m,y,x,T,S,M,E,C,R,z,N,k,U,$,G)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:T,u_fade_t:S.mix,u_opacity:S.opacity*M.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:M.paint.get("raster-brightness-min"),u_brightness_high:M.paint.get("raster-brightness-max"),u_saturation_factor:s.dS(M.paint.get("raster-saturation")),u_contrast_factor:s.dR(M.paint.get("raster-contrast")),u_spin_weights:ou(M.paint.get("raster-hue-rotate")),u_perspective_transform:E,u_raster_elevation:C,u_zoom_transition:m,u_merc_center:y,u_cutoff_params:x,u_colorization_mix:nu(s.dT,z,k),u_colorization_offset:ks(s.dT,N,k),u_color_ramp:R,u_texture_offset:[$/(U+2*$),U/(U+2*$)],u_texture_res:[U+2*$,U+2*$],u_emissive_strength:G});function ou(l){l*=Math.PI/180;const t=Math.sin(l),n=Math.cos(l);return[(2*n+1)/3,(-Math.sqrt(3)*t-n+1)/3,(Math.sqrt(3)*t-n+1)/3]}const Ia=.05,ea=(l,t,n,c,d,p,m,y,x,T,S,M)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:T,u_fade_t:S.mix,u_opacity:S.opacity,u_image0:0,u_image1:1,u_raster_elevation:M,u_zoom_transition:m,u_merc_center:y,u_cutoff_params:x}),Nh=(l,t,n,c,d,p,m,y,x,T)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_tile_offset:n,u_velocity:c,u_color_ramp:p,u_velocity_res:d,u_max_speed:m,u_uv_offset:y,u_data_scale:[255*x[0],255*x[1]],u_data_offset:T,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ia,Ia]}),su=(l,t,n,c,d,p,m,y,x,T)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_velocity:n,u_velocity_res:c,u_max_speed:d,u_speed_factor:p,u_reset_rate:m,u_rand_seed:Math.random(),u_uv_offset:y,u_data_scale:[255*x[0],255*x[1]],u_data_offset:T,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ia,Ia]}),Vh=s.bB(),Uh=(l,t,n,c,d,p,m,y,x,T,S,M,E,C,R,z,N,k,U,$,G,ee,Z,ie)=>{const Q=d.transform,Y={u_is_size_zoom_constant:+(l==="constant"||l==="source"),u_is_size_feature_constant:+(l==="constant"||l==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:Q.getCameraToCenterDistance(U),u_rotate_symbol:+n,u_aspect_ratio:Q.width/Q.height,u_fade_change:d.options.fadeDuration?d.symbolFadeChange:1,u_matrix:p,u_label_plane_matrix:m,u_coord_matrix:y,u_is_text:+T,u_elevation_from_sea:x?1:0,u_pitch_with_map:+c,u_texsize:S,u_texsize_icon:M,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Vh,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Vh,u_up_vector:[0,-1,0],u_color_adj_mat:ee,u_icon_transition:Z||0,u_gamma_scale:c?d.transform.getCameraToCenterDistance(U)*Math.cos(d.terrain?0:d.transform._pitch):1,u_device_pixel_ratio:s.o.devicePixelRatio,u_is_halo:1,u_scale_factor:ie||1,u_ground_shadow_factor:$,u_inv_matrix:s.bk(s.bB(),m),u_normal_scale:G,u_lutTexture:Rn.LUT};return U.name==="globe"&&(Y.u_tile_id=[C.canonical.x,C.canonical.y,1<<C.canonical.z],Y.u_zoom_transition=R,Y.u_inv_rot_matrix=N,Y.u_merc_center=z,Y.u_camera_forward=Q._camera.forward(),Y.u_ecef_origin=s.dU(Q.globeMatrix,C.toUnwrapped()),Y.u_tile_matrix=Float32Array.from(Q.globeMatrix),Y.u_up_vector=k),Y},au=(l,t,n,c)=>({u_matrix:l,u_emissive_strength:t,u_opacity:n,u_color:c}),lu=(l,t,n,c,d,p,m,y,x)=>Object.assign((function(T,S,M,E,C,R){const{width:z,height:N}=E.imageManager.getPixelSize(S),k=Math.pow(2,R.tileID.overscaledZ),U=R.tileSize*Math.pow(2,E.transform.tileZoom)/k,$=U*(R.tileID.canonical.x+R.tileID.wrap*k),G=U*R.tileID.canonical.y;return{u_image:0,u_pattern_tl:M.tl,u_pattern_br:M.br,u_texsize:[z,N],u_pattern_size:M.displaySize,u_pattern_units_to_pixels:C?[E.transform.width,-1*E.transform.height]:[1/s.ay(R,1,E.transform.tileZoom),1/s.ay(R,1,E.transform.tileZoom)],u_pixel_coord_upper:[$>>16,G>>16],u_pixel_coord_lower:[65535&$,65535&G]}})(0,p,m,c,y,x),{u_matrix:l,u_emissive_strength:t,u_opacity:n}),jh=new Float32Array(s.bz([])),cu=(l,t,n,c,d,p,m,y,x,T,S,M,E,C=[0,0,0],R,z,N)=>{const k=d.style.light,U=k.properties.get("position"),$=[-U.x,-U.y,U.z],G=s.dN();k.properties.get("anchor")==="viewport"&&(s.dO(G,-d.transform.angle),s.dP($,$,G));const ee=S.alphaMode==="MASK",Z=k.properties.get("color").toNonPremultipliedRenderColor(null),ie=E.paint.get("model-ambient-occlusion-intensity"),Q=E.paint.get("model-color").constantOr(s.ao.white).toNonPremultipliedRenderColor(null);return Q.a=E.paint.get("model-color-mix-intensity").constantOr(0),N&&(Q.r=N[0],Q.g=N[1],Q.b=N[2],Q.a=N[3]),z&&(Q.r=z.color.r,Q.g=z.color.g,Q.b=z.color.b,Q.a=z.colorMix,M=z.emissionStrength,p=z.opacity),{u_matrix:l,u_lighting_matrix:t,u_normal_matrix:n,u_node_matrix:c||jh,u_lightpos:$,u_lightintensity:k.properties.get("intensity"),u_lightcolor:[Z.r,Z.g,Z.b],u_camera_pos:C,u_opacity:p,u_baseTextureIsAlpha:0,u_alphaMask:+ee,u_alphaCutoff:S.alphaCutoff,u_baseColorFactor:m.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:y.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:x,u_roughnessFactor:T,u_baseColorTexture:Rn.BaseColor,u_metallicRoughnessTexture:Rn.MetallicRoughness,u_normalTexture:Rn.Normal,u_occlusionTexture:Rn.Occlusion,u_emissionTexture:Rn.Emission,u_lutTexture:Rn.LUT,u_color_mix:Q.toArray01(),u_aoIntensity:ie,u_emissive_strength:M,u_occlusionTextureTransform:R||[0,0,0,0]}},nl=(l,t=jh,n=jh)=>({u_matrix:l,u_instance:t,u_node_matrix:n}),Bm={fillExtrusion:l=>({u_matrix:new s.ck(l),u_lightpos:new s.ch(l),u_lightintensity:new s.ci(l),u_lightcolor:new s.ch(l),u_vertical_gradient:new s.ci(l),u_opacity:new s.ci(l),u_edge_radius:new s.ci(l),u_width_scale:new s.ci(l),u_ao:new s.cj(l),u_height_type:new s.cg(l),u_base_type:new s.cg(l),u_tile_id:new s.ch(l),u_zoom_transition:new s.ci(l),u_inv_rot_matrix:new s.ck(l),u_merc_center:new s.cj(l),u_up_dir:new s.ch(l),u_height_lift:new s.ci(l),u_flood_light_color:new s.ch(l),u_vertical_scale:new s.ci(l),u_flood_light_intensity:new s.ci(l),u_ground_shadow_factor:new s.ch(l)}),fillExtrusionDepth:l=>({u_matrix:new s.ck(l),u_edge_radius:new s.ci(l),u_width_scale:new s.ci(l),u_vertical_scale:new s.ci(l),u_height_type:new s.cg(l),u_base_type:new s.cg(l)}),fillExtrusionPattern:l=>({u_matrix:new s.ck(l),u_lightpos:new s.ch(l),u_lightintensity:new s.ci(l),u_lightcolor:new s.ch(l),u_vertical_gradient:new s.ci(l),u_height_factor:new s.ci(l),u_edge_radius:new s.ci(l),u_width_scale:new s.ci(l),u_ao:new s.cj(l),u_height_type:new s.cg(l),u_base_type:new s.cg(l),u_tile_id:new s.ch(l),u_zoom_transition:new s.ci(l),u_inv_rot_matrix:new s.ck(l),u_merc_center:new s.cj(l),u_up_dir:new s.ch(l),u_height_lift:new s.ci(l),u_image:new s.cg(l),u_texsize:new s.cj(l),u_pixel_coord_upper:new s.cj(l),u_pixel_coord_lower:new s.cj(l),u_tile_units_to_pixels:new s.ci(l),u_opacity:new s.ci(l),u_pattern_transition:new s.ci(l)}),fillExtrusionGroundEffect:l=>({u_matrix:new s.ck(l),u_opacity:new s.ci(l),u_ao_pass:new s.ci(l),u_meter_to_tile:new s.ci(l),u_ao:new s.cj(l),u_flood_light_intensity:new s.ci(l),u_flood_light_color:new s.ch(l),u_attenuation:new s.ci(l),u_edge_radius:new s.ci(l),u_fb:new s.cg(l),u_fb_size:new s.ci(l),u_dynamic_offset:new s.ci(l)}),fill:l=>({u_matrix:new s.ck(l),u_emissive_strength:new s.ci(l),u_ground_shadow_factor:new s.ch(l)}),fillPattern:l=>({u_matrix:new s.ck(l),u_emissive_strength:new s.ci(l),u_image:new s.cg(l),u_texsize:new s.cj(l),u_pixel_coord_upper:new s.cj(l),u_pixel_coord_lower:new s.cj(l),u_tile_units_to_pixels:new s.ci(l),u_ground_shadow_factor:new s.ch(l),u_pattern_transition:new s.ci(l)}),fillOutline:l=>({u_matrix:new s.ck(l),u_emissive_strength:new s.ci(l),u_world:new s.cj(l),u_ground_shadow_factor:new s.ch(l)}),fillOutlinePattern:l=>({u_matrix:new s.ck(l),u_emissive_strength:new s.ci(l),u_world:new s.cj(l),u_image:new s.cg(l),u_texsize:new s.cj(l),u_pixel_coord_upper:new s.cj(l),u_pixel_coord_lower:new s.cj(l),u_tile_units_to_pixels:new s.ci(l),u_ground_shadow_factor:new s.ch(l),u_pattern_transition:new s.ci(l)}),building:l=>({u_matrix:new s.ck(l),u_normal_matrix:new s.ck(l),u_opacity:new s.ci(l),u_faux_facade_ao_intensity:new s.ci(l),u_camera_pos:new s.ch(l),u_tile_to_meter:new s.ci(l),u_facade_emissive_chance:new s.ci(l),u_flood_light_color:new s.ch(l),u_flood_light_intensity:new s.ci(l)}),buildingBloom:l=>({u_matrix:new s.ck(l)}),buildingDepth:l=>({u_matrix:new s.ck(l)}),elevatedStructuresDepth:l=>({u_matrix:new s.ck(l),u_depth_bias:new s.ci(l)}),elevatedStructures:l=>({u_matrix:new s.ck(l),u_ground_shadow_factor:new s.ch(l)}),elevatedStructuresDepthReconstruct:l=>({u_matrix:new s.ck(l),u_camera_pos:new s.ch(l),u_depth_bias:new s.ci(l),u_height_scale:new s.ci(l),u_reset_depth:new s.ci(l)}),circle:s.dX,collisionBox:l=>({u_matrix:new s.ck(l),u_inv_rot_matrix:new s.ck(l),u_camera_to_center_distance:new s.ci(l),u_extrude_scale:new s.cj(l),u_zoom_transition:new s.ci(l),u_merc_center:new s.cj(l),u_tile_id:new s.ch(l)}),collisionCircle:l=>({u_matrix:new s.ck(l),u_inv_matrix:new s.ck(l),u_camera_to_center_distance:new s.ci(l),u_viewport_size:new s.cj(l)}),debug:l=>({u_color:new s.dA(l),u_matrix:new s.ck(l),u_overlay:new s.cg(l),u_overlay_scale:new s.ci(l)}),clippingMask:l=>({u_matrix:new s.ck(l)}),heatmap:l=>({u_extrude_scale:new s.ci(l),u_intensity:new s.ci(l),u_matrix:new s.ck(l),u_inv_rot_matrix:new s.ck(l),u_merc_center:new s.cj(l),u_tile_id:new s.ch(l),u_zoom_transition:new s.ci(l),u_up_dir:new s.ch(l)}),heatmapTexture:l=>({u_image:new s.cg(l),u_color_ramp:new s.cg(l),u_opacity:new s.ci(l)}),hillshade:l=>({u_matrix:new s.ck(l),u_image:new s.cg(l),u_latrange:new s.cj(l),u_light:new s.cj(l),u_shadow:new s.dA(l),u_highlight:new s.dA(l),u_emissive_strength:new s.ci(l),u_accent:new s.dA(l)}),hillshadePrepare:l=>({u_matrix:new s.ck(l),u_image:new s.cg(l),u_dimension:new s.cj(l),u_zoom:new s.ci(l)}),line:s.dW,linePattern:s.dV,raster:l=>({u_matrix:new s.ck(l),u_normalize_matrix:new s.ck(l),u_globe_matrix:new s.ck(l),u_merc_matrix:new s.ck(l),u_grid_matrix:new s.dB(l),u_tl_parent:new s.cj(l),u_scale_parent:new s.ci(l),u_fade_t:new s.ci(l),u_opacity:new s.ci(l),u_image0:new s.cg(l),u_image1:new s.cg(l),u_brightness_low:new s.ci(l),u_brightness_high:new s.ci(l),u_saturation_factor:new s.ci(l),u_contrast_factor:new s.ci(l),u_spin_weights:new s.ch(l),u_perspective_transform:new s.cj(l),u_raster_elevation:new s.ci(l),u_zoom_transition:new s.ci(l),u_merc_center:new s.cj(l),u_cutoff_params:new s.d2(l),u_colorization_mix:new s.d2(l),u_colorization_offset:new s.ci(l),u_color_ramp:new s.cg(l),u_texture_offset:new s.cj(l),u_texture_res:new s.cj(l),u_emissive_strength:new s.ci(l)}),rasterParticle:l=>({u_matrix:new s.ck(l),u_normalize_matrix:new s.ck(l),u_globe_matrix:new s.ck(l),u_merc_matrix:new s.ck(l),u_grid_matrix:new s.dB(l),u_tl_parent:new s.cj(l),u_scale_parent:new s.ci(l),u_fade_t:new s.ci(l),u_opacity:new s.ci(l),u_image0:new s.cg(l),u_image1:new s.cg(l),u_raster_elevation:new s.ci(l),u_zoom_transition:new s.ci(l),u_merc_center:new s.cj(l),u_cutoff_params:new s.d2(l)}),rasterParticleTexture:l=>({u_texture:new s.cg(l),u_opacity:new s.ci(l)}),rasterParticleDraw:l=>({u_particle_texture:new s.cg(l),u_particle_texture_side_len:new s.ci(l),u_tile_offset:new s.cj(l),u_velocity:new s.cg(l),u_color_ramp:new s.cg(l),u_velocity_res:new s.cj(l),u_max_speed:new s.ci(l),u_uv_offset:new s.cj(l),u_data_scale:new s.cj(l),u_data_offset:new s.ci(l),u_particle_pos_scale:new s.ci(l),u_particle_pos_offset:new s.cj(l)}),rasterParticleUpdate:l=>({u_particle_texture:new s.cg(l),u_particle_texture_side_len:new s.ci(l),u_velocity:new s.cg(l),u_velocity_res:new s.cj(l),u_max_speed:new s.ci(l),u_speed_factor:new s.ci(l),u_reset_rate:new s.ci(l),u_rand_seed:new s.ci(l),u_uv_offset:new s.cj(l),u_data_scale:new s.cj(l),u_data_offset:new s.ci(l),u_particle_pos_scale:new s.ci(l),u_particle_pos_offset:new s.cj(l)}),symbol:l=>({u_is_size_zoom_constant:new s.cg(l),u_is_size_feature_constant:new s.cg(l),u_size_t:new s.ci(l),u_size:new s.ci(l),u_camera_to_center_distance:new s.ci(l),u_rotate_symbol:new s.cg(l),u_aspect_ratio:new s.ci(l),u_fade_change:new s.ci(l),u_matrix:new s.ck(l),u_label_plane_matrix:new s.ck(l),u_coord_matrix:new s.ck(l),u_is_text:new s.cg(l),u_elevation_from_sea:new s.cg(l),u_pitch_with_map:new s.cg(l),u_texsize:new s.cj(l),u_texsize_icon:new s.cj(l),u_texture:new s.cg(l),u_texture_icon:new s.cg(l),u_gamma_scale:new s.ci(l),u_device_pixel_ratio:new s.ci(l),u_tile_id:new s.ch(l),u_zoom_transition:new s.ci(l),u_inv_rot_matrix:new s.ck(l),u_merc_center:new s.cj(l),u_camera_forward:new s.ch(l),u_tile_matrix:new s.ck(l),u_up_vector:new s.ch(l),u_ecef_origin:new s.ch(l),u_is_halo:new s.cg(l),u_icon_transition:new s.ci(l),u_color_adj_mat:new s.ck(l),u_scale_factor:new s.ci(l),u_ground_shadow_factor:new s.ch(l),u_inv_matrix:new s.ck(l),u_normal_scale:new s.ci(l),u_lutTexture:new s.cg(l)}),background:l=>({u_matrix:new s.ck(l),u_emissive_strength:new s.ci(l),u_opacity:new s.ci(l),u_color:new s.dA(l)}),backgroundPattern:l=>({u_matrix:new s.ck(l),u_emissive_strength:new s.ci(l),u_opacity:new s.ci(l),u_image:new s.cg(l),u_pattern_tl:new s.cj(l),u_pattern_br:new s.cj(l),u_texsize:new s.cj(l),u_pattern_size:new s.cj(l),u_pixel_coord_upper:new s.cj(l),u_pixel_coord_lower:new s.cj(l),u_pattern_units_to_pixels:new s.cj(l)}),terrainRaster:l=>({u_matrix:new s.ck(l),u_image0:new s.cg(l),u_skirt_height:new s.ci(l),u_ground_shadow_factor:new s.ch(l)}),skybox:l=>({u_matrix:new s.ck(l),u_sun_direction:new s.ch(l),u_cubemap:new s.cg(l),u_opacity:new s.ci(l),u_temporal_offset:new s.ci(l)}),skyboxGradient:l=>({u_matrix:new s.ck(l),u_color_ramp:new s.cg(l),u_center_direction:new s.ch(l),u_radius:new s.ci(l),u_opacity:new s.ci(l),u_temporal_offset:new s.ci(l)}),skyboxCapture:l=>({u_matrix_3f:new s.dB(l),u_sun_direction:new s.ch(l),u_sun_intensity:new s.ci(l),u_color_tint_r:new s.d2(l),u_color_tint_m:new s.d2(l),u_luminance:new s.ci(l)}),globeRaster:l=>({u_proj_matrix:new s.ck(l),u_globe_matrix:new s.ck(l),u_normalize_matrix:new s.ck(l),u_merc_matrix:new s.ck(l),u_zoom_transition:new s.ci(l),u_merc_center:new s.cj(l),u_image0:new s.cg(l),u_grid_matrix:new s.dB(l),u_skirt_height:new s.ci(l),u_far_z_cutoff:new s.ci(l),u_frustum_tl:new s.ch(l),u_frustum_tr:new s.ch(l),u_frustum_br:new s.ch(l),u_frustum_bl:new s.ch(l),u_globe_pos:new s.ch(l),u_globe_radius:new s.ci(l),u_viewport:new s.cj(l)}),globeAtmosphere:l=>({u_frustum_tl:new s.ch(l),u_frustum_tr:new s.ch(l),u_frustum_br:new s.ch(l),u_frustum_bl:new s.ch(l),u_horizon:new s.ci(l),u_transition:new s.ci(l),u_fadeout_range:new s.ci(l),u_atmosphere_fog_color:new s.d2(l),u_high_color:new s.d2(l),u_space_color:new s.d2(l),u_temporal_offset:new s.ci(l),u_horizon_angle:new s.ci(l)}),model:l=>({u_matrix:new s.ck(l),u_lighting_matrix:new s.ck(l),u_normal_matrix:new s.ck(l),u_node_matrix:new s.ck(l),u_lightpos:new s.ch(l),u_lightintensity:new s.ci(l),u_lightcolor:new s.ch(l),u_camera_pos:new s.ch(l),u_opacity:new s.ci(l),u_baseColorFactor:new s.d2(l),u_emissiveFactor:new s.d2(l),u_metallicFactor:new s.ci(l),u_roughnessFactor:new s.ci(l),u_baseTextureIsAlpha:new s.cg(l),u_alphaMask:new s.cg(l),u_alphaCutoff:new s.ci(l),u_baseColorTexture:new s.cg(l),u_metallicRoughnessTexture:new s.cg(l),u_normalTexture:new s.cg(l),u_occlusionTexture:new s.cg(l),u_emissionTexture:new s.cg(l),u_lutTexture:new s.cg(l),u_color_mix:new s.d2(l),u_aoIntensity:new s.ci(l),u_emissive_strength:new s.ci(l),u_occlusionTextureTransform:new s.d2(l)}),modelDepth:l=>({u_matrix:new s.ck(l),u_instance:new s.ck(l),u_node_matrix:new s.ck(l)}),groundShadow:l=>({u_matrix:new s.ck(l),u_ground_shadow_factor:new s.ch(l)}),stars:l=>({u_matrix:new s.ck(l),u_up:new s.ch(l),u_right:new s.ch(l),u_intensity_multiplier:new s.ci(l)}),snowParticle:l=>({u_modelview:new s.ck(l),u_projection:new s.ck(l),u_time:new s.ci(l),u_cam_pos:new s.ch(l),u_velocityConeAperture:new s.ci(l),u_velocity:new s.ci(l),u_horizontalOscillationRadius:new s.ci(l),u_horizontalOscillationRate:new s.ci(l),u_boxSize:new s.ci(l),u_billboardSize:new s.ci(l),u_simpleShapeParameters:new s.cj(l),u_screenSize:new s.cj(l),u_thinningCenterPos:new s.cj(l),u_thinningShape:new s.ch(l),u_thinningAffectedRatio:new s.ci(l),u_thinningParticleOffset:new s.ci(l),u_particleColor:new s.d2(l),u_direction:new s.ch(l)}),rainParticle:l=>({u_modelview:new s.ck(l),u_projection:new s.ck(l),u_time:new s.ci(l),u_cam_pos:new s.ch(l),u_texScreen:new s.cg(l),u_velocityConeAperture:new s.ci(l),u_velocity:new s.ci(l),u_boxSize:new s.ci(l),u_rainDropletSize:new s.cj(l),u_distortionStrength:new s.ci(l),u_rainDirection:new s.ch(l),u_color:new s.d2(l),u_screenSize:new s.cj(l),u_thinningCenterPos:new s.cj(l),u_thinningShape:new s.ch(l),u_thinningAffectedRatio:new s.ci(l),u_thinningParticleOffset:new s.ci(l),u_shapeDirectionalPower:new s.ci(l),u_shapeNormalPower:new s.ci(l),u_mode:new s.ci(l)}),vignette:l=>({u_vignetteShape:new s.ch(l),u_vignetteColor:new s.d2(l)}),occlusion:l=>({u_matrix:new s.ck(l),u_anchorPos:new s.ch(l),u_screenSizePx:new s.cj(l),u_occluderSizePx:new s.cj(l),u_color:new s.d2(l)})};class ta{constructor(t,n,c,d){this.id=ta.uniqueIdxCounter,ta.uniqueIdxCounter++,this.context=t;const p=t.gl;this.buffer=p.createBuffer(),this.dynamicDraw=!!c,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),p.bufferData(p.ELEMENT_ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?p.DYNAMIC_DRAW:p.STATIC_DRAW),this.dynamicDraw||d||n.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=ta.uniqueIdxCounter,ta.uniqueIdxCounter++;const n=this.context.gl;this.context.unbindVAO(),this.bind(),n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}ta.uniqueIdxCounter=0;const Hf={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Nm{constructor(t,n,c,d,p,m){this.length=n.length,this.attributes=c,this.itemSize=n.bytesPerElement,this.dynamicDraw=d,this.instanceCount=m,this.context=t;const y=t.gl;this.buffer=y.createBuffer(),t.bindVertexBuffer.set(this.buffer),y.bufferData(y.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?y.DYNAMIC_DRAW:y.STATIC_DRAW),this.dynamicDraw||p||n.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,n){for(let c=0;c<this.attributes.length;c++){const d=n.getAttributeLocation(t,this.attributes[c].name);d!==-1&&t.enableVertexAttribArray(d)}}setVertexAttribPointers(t,n,c){for(let d=0;d<this.attributes.length;d++){const p=this.attributes[d],m=n.getAttributeLocation(t,p.name);m!==-1&&t.vertexAttribPointer(m,p.components,t[Hf[p.type]],!1,this.itemSize,p.offset+this.itemSize*(c||0))}}setVertexAttribDivisor(t,n,c){for(let d=0;d<this.attributes.length;d++){const p=n.getAttributeLocation(t,this.attributes[d].name);p!==-1&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(p,c)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class uu{constructor(t,n,c,d,p){this.context=t,this.width=n,this.height=c;const m=this.framebuffer=t.gl.createFramebuffer();d&&(this.colorAttachment=new zm(t,m)),p&&(this.depthAttachmentType=p,this.depthAttachment=p==="renderbuffer"?new Of(t,m):new Lm(t,m))}destroy(){const t=this.context.gl;if(this.colorAttachment){const n=this.colorAttachment.get();n&&t.deleteTexture(n)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const n=this.depthAttachment.get();n&&t.deleteRenderbuffer(n)}else{const n=this.depthAttachment.get();n&&t.deleteTexture(n)}t.deleteFramebuffer(this.framebuffer)}}class hu{constructor(t,n){this.gl=t,this.clearColor=new Af(this),this.clearDepth=new Sh(this),this.clearStencil=new Am(this),this.colorMask=new Mm(this),this.depthMask=new Cm(this),this.stencilMask=new Pm(this),this.stencilFunc=new Mf(this),this.stencilOp=new Rm(this),this.stencilTest=new qc(this),this.depthRange=new Dm(this),this.depthTest=new Cf(this),this.depthFunc=new Eh(this),this.blend=new $c(this),this.blendFunc=new Ih(this),this.blendColor=new Ta(this),this.blendEquation=new Ka(this),this.cullFace=new ic(this),this.cullFaceSide=new Ja(this),this.frontFace=new Pf(this),this.program=new Ah(this),this.activeTexture=new Rf(this),this.viewport=new Qa(this),this.bindFramebuffer=new Zc(this),this.bindRenderbuffer=new Wc(this),this.bindTexture=new Mh(this),this.bindVertexBuffer=new Xc(this),this.bindElementBuffer=new rc(this),this.bindVertexArrayOES=new Df(this),this.pixelStoreUnpack=new zf(this),this.pixelStoreUnpackPremultiplyAlpha=new Lf(this),this.pixelStoreUnpackFlipY=new el(this),this.options=n?Object.assign({},n):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=n&&!!n.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,n,c){return new ta(this,t,n,c)}createVertexBuffer(t,n,c,d,p){return new Nm(this,t,n,c,d,p)}createRenderbuffer(t,n,c){const d=this.gl,p=d.createRenderbuffer();return this.bindRenderbuffer.set(p),d.renderbufferStorage(d.RENDERBUFFER,t,n,c),this.bindRenderbuffer.set(null),p}createFramebuffer(t,n,c,d){return new uu(this,t,n,c,d)}clear({color:t,depth:n,stencil:c,colorMask:d}){const p=this.gl;let m=0;t&&(m|=p.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(d||[!0,!0,!0,!0])),n!==void 0&&(m|=p.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),c!==void 0&&(m|=p.STENCIL_BUFFER_BIT,this.clearStencil.set(c),this.stencilMask.set(255)),p.clear(m)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){s.bx(t.blendFunction,ti.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Es;function cc(l,t,n,c,d,p,m){const y=l.context,x=y.gl,T=l.transform,S=[s.aF(T.center.lng),s.aJ(T.center.lat)],M=n.layout.get("symbol-placement"),E=n.layout.get("text-variable-anchor"),C=n.layout.get("icon-rotation-alignment")==="map",R=n.layout.get("text-rotation-alignment")==="map",z=M!=="point",N=[];let k=0,U=0;for(let Y=0;Y<c.length;Y++){const re=c[Y],_e=t.getTile(re),he=_e.getBucket(n);if(!he)continue;const Ae=he.getProjection().createInversionMatrix(T,re.canonical),ve=[],ze=vf(re,he,T),Xe=!m&&C&&z,xe=m&&R&&z,ce=E&&he.hasTextData(),Le=he.hasIconTextFit()&&ce&&he.hasIconData(),be=Xe||xe||m&&ce||Le,Ve=he.projection.name==="globe",Qe=Ve?s.aj(T.zoom):0;Ve&&(ve.push("PROJECTION_GLOBE_VIEW"),be&&ve.push("PROJECTED_POS_ON_VIEWPORT"));const mt=l.getOrCreateProgram("collisionBox",{defines:ve});let $e=ze;d[0]===0&&d[1]===0||($e=l.translatePosMatrix(ze,_e,d,p));const Ke=m?he.textCollisionBox:he.iconCollisionBox,gt=he.collisionCircleArray;if(gt.length>0){const ct=s.bB(),dt=$e;s.cO(ct,he.placementInvProjMatrix,T.glCoordMatrix),s.cO(ct,ct,he.placementViewportMatrix),N.push({circleArray:gt,circleOffset:U,transform:dt,invTransform:ct,projection:he.getProjection()}),k+=gt.length/4,U=k}if(!Ke)continue;l.terrain&&l.terrain.setupElevationDraw(_e,mt);const ht=Ve?[re.canonical.x,re.canonical.y,1<<re.canonical.z]:[0,0,0];mt.draw(l,x.LINES,xt.disabled,Gt.disabled,l.colorModeForRenderPass(),Bt.disabled,rl($e,Ae,T,Qe,S,_e,ht,he.getProjection()),n.id,Ke.layoutVertexBuffer,Ke.indexBuffer,Ke.segments,null,T.zoom,null,[Ke.collisionVertexBuffer,Ke.collisionVertexBufferExt])}if(!m||!N.length)return;const $=l.getOrCreateProgram("collisionCircle"),G=new s.dY;G.resize(4*k),G._trim();let ee=0;for(const Y of N)for(let re=0;re<Y.circleArray.length/4;re++){const _e=4*re,he=Y.circleArray[_e+0],Ae=Y.circleArray[_e+1],ve=Y.circleArray[_e+2],ze=Y.circleArray[_e+3];G.emplace(ee++,he,Ae,ve,ze,0),G.emplace(ee++,he,Ae,ve,ze,1),G.emplace(ee++,he,Ae,ve,ze,2),G.emplace(ee++,he,Ae,ve,ze,3)}(!Es||Es.length<2*k)&&(Es=(function(Y){const re=2*Y,_e=new s.b0;_e.resize(re),_e._trim();for(let he=0;he<re;he++){const Ae=6*he;_e.uint16[Ae+0]=4*he+0,_e.uint16[Ae+1]=4*he+1,_e.uint16[Ae+2]=4*he+2,_e.uint16[Ae+3]=4*he+2,_e.uint16[Ae+4]=4*he+3,_e.uint16[Ae+5]=4*he+0}return _e})(k));const Z=y.createIndexBuffer(Es,!0),ie=y.createVertexBuffer(G,s.dZ.members,!0);for(const Y of N){const re={u_matrix:Y.transform,u_inv_matrix:Y.invTransform,u_camera_to_center_distance:(Q=T).getCameraToCenterDistance(Y.projection),u_viewport_size:[Q.width,Q.height]};$.draw(l,x.TRIANGLES,xt.disabled,Gt.disabled,l.colorModeForRenderPass(),Bt.disabled,re,n.id,ie,Z,s.bf.simpleSegment(0,2*Y.circleOffset,Y.circleArray.length,Y.circleArray.length/2),null,T.zoom)}var Q;ie.destroy(),Z.destroy()}const ia=s.bB();function Gh(l){const t=l._camera.getWorldToCamera(l.worldSize,1),n=s.aB([],t,l.globeMatrix);s.bk(n,n);const c=[0,0,0],d=[0,1,0,0];return s.aC(d,d,n),c[0]=d[0],c[1]=d[1],c[2]=d[2],s.aw(c,c),c}function du({width:l,height:t,anchor:n,textOffset:c,textScale:d},p){const{horizontalAlign:m,verticalAlign:y}=s.c0(n),x=-(m-.5)*l,T=-(y-.5)*t,S=s.c1(n,c);return new s.P((x/d+S[0])*p,(T/d+S[1])*p)}function fu(l,t,n,c,d,p,m,y,x,T){const S=l.text.placedSymbolArray,M=l.text.dynamicLayoutVertexArray,E=l.icon.dynamicLayoutVertexArray,C={},R=l.getProjection(),z=zc(m,R,d),N=d.elevation,k=R.upVectorScale(m.canonical,d.center.lat,d.worldSize).metersToTile;M.clear();for(let U=0;U<S.length;U++){const $=S.get(U),{tileAnchorX:G,tileAnchorY:ee,numGlyphs:Z}=$,ie=$.hidden||!$.crossTileID||l.allowVerticalPlacement&&!$.placedOrientation?null:c[$.crossTileID];if(ie){let Q=0,Y=0,re=0;const _e=l.elevationType==="road";if(N||_e){const be=_e?l.getElevationFeatureForText(U):null,Ve=s.bU.getAtTileOffset(m,new s.P(G,ee),N,be),[Qe,mt,$e]=R.upVector(m.canonical,G,ee);Q=Ve*Qe*k,Y=Ve*mt*k,re=Ve*$e*k}let[he,Ae,ve,ze]=hn($.projectedAnchorX+Q,$.projectedAnchorY+Y,$.projectedAnchorZ+re,n?z:p);const Xe=hh(d.getCameraToCenterDistance(R),ze);let xe=s.bL(l.textSizeData,x,$)*Xe/s.bX;n&&(xe*=l.tilePixelRatio/y);const ce=du(ie,xe);n?({x:he,y:Ae,z:ve}=R.projectTilePoint(G+ce.x,ee+ce.y,m.canonical),[he,Ae,ve]=hn(he+Q,Ae+Y,ve+re,p)):(t&&ce._rotate(-d.angle),he+=ce.x,Ae+=ce.y,ve=0);const Le=l.allowVerticalPlacement&&$.placedOrientation===s.bK.vertical?Math.PI/2:0;for(let be=0;be<Z;be++)s.bN(M,he,Ae,ve,Le);T&&$.associatedIconIndex>=0&&(C[$.associatedIconIndex]={x:he,y:Ae,z:ve,angle:Le})}else zs(Z,M)}if(T){E.clear();const U=l.icon.placedSymbolArray;for(let $=0;$<U.length;$++){const G=U.get($),{numGlyphs:ee}=G,Z=C[$];if(G.hidden||!Z)zs(ee,E);else{const{x:ie,y:Q,z:Y,angle:re}=Z;for(let _e=0;_e<ee;_e++)s.bN(E,ie,Q,Y,re)}}l.icon.dynamicLayoutVertexBuffer.updateData(E)}l.text.dynamicLayoutVertexBuffer.updateData(M)}function uc(l,t,n,c,d,p,m={}){const y=n.paint.get("icon-translate"),x=n.paint.get("text-translate"),T=n.paint.get("icon-translate-anchor"),S=n.paint.get("text-translate-anchor"),M=n.layout.get("icon-rotation-alignment"),E=n.layout.get("text-rotation-alignment"),C=n.layout.get("icon-pitch-alignment"),R=n.layout.get("text-pitch-alignment"),z=n.layout.get("icon-keep-upright"),N=n.layout.get("text-keep-upright"),k=n.paint.get("icon-color-saturation"),U=n.paint.get("icon-color-contrast"),$=n.paint.get("icon-color-brightness-min"),G=n.paint.get("icon-color-brightness-max"),ee=n.layout.get("symbol-elevation-reference")==="sea",Z=n.layout.get("icon-image-use-theme")==="none",ie=l.context,Q=ie.gl,Y=l.transform,re=M==="map",_e=E==="map",he=C==="map",Ae=R==="map",ve=n.layout.get("symbol-sort-key").constantOr(1)!==void 0;let ze=!1;const Xe=l.depthModeForSublayer(0,xt.ReadOnly),xe=new xt(l.context.gl.LEQUAL,xt.ReadOnly,l.depthRangeFor3D),ce=[s.aF(Y.center.lng),s.aJ(Y.center.lat)],Le=n.layout.get("text-variable-anchor"),be=Y.projection.name==="globe",Ve=[],Qe=[0,-1,0];for(const mt of c){const $e=t.getTile(mt),Ke=$e.getBucket(n);if(!Ke||Ke.projection.name==="mercator"&&be||Ke.fullyClipped)continue;const gt=Ke.projection.name==="globe",ht=gt?s.aj(Y.zoom):0,ct=zc(mt,Ke.getProjection(),Y),dt=Y.calculatePixelsToTileUnitsMatrix($e),Pt=Le&&Ke.hasTextData(),li=Ke.hasIconTextFit()&&Pt&&Ke.hasIconData(),pi=Ke.getProjection().createInversionMatrix(Y,mt.canonical),Yi=(1<<$e.tileID.canonical.z)*s.al/l.transform.worldSize,Nt=Ni=>{let Ut=[0,0,0];if(Ni){const gi=l.style.directionalLight,wr=l.style.ambientLight;gi&&wr&&(Ut=is(l.style,gi,wr))}return Ut},fi=Ni=>{Y.depthOcclusionForSymbolsAndCircles&&(n.hasOcclusionOpacityProperties||l.terrain)&&(Ni.push("DEPTH_D24"),Ni.push("DEPTH_OCCLUSION"))},Kt=Ni=>{n.lut&&!Z&&(n.lut.texture||(n.lut.texture=new s.d_(l.context,n.lut.image,[n.lut.image.height,n.lut.image.height,n.lut.image.height],ie.gl.RGBA8)),ie.activeTexture.set(ie.gl.TEXTURE0+Rn.LUT),n.lut.texture&&n.lut.texture.bind(ie.gl.LINEAR,ie.gl.CLAMP_TO_EDGE),Ni.push("APPLY_LUT_ON_GPU"))},qi=()=>{const Ni=re&&n.layout.get("symbol-placement")!=="point",Ut=[];fi(Ut),Kt(Ut);const gi=Ni||li,wr=Ke.elevationType==="road",jr=l.shadowRenderer,Mr=wr&&he&&!!jr&&jr.enabled,Br=Nt(Mr),go=wr&&he&&!l.terrain?xe:Xe,oo=n.paint.get("icon-image-cross-fade");l.terrainRenderModeElevated()&&he&&Ut.push("PITCH_WITH_MAP_TERRAIN"),gt&&(Ut.push("PROJECTION_GLOBE_VIEW"),gi&&Ut.push("PROJECTED_POS_ON_VIEWPORT")),oo>0&&Ke.hasAnySecondaryIcon&&Ut.push("ICON_TRANSITION"),!Ke.icon.zOffsetVertexBuffer||wr&&l.terrain||Ut.push("Z_OFFSET"),k===0&&U===0&&$===0&&G===1||Ut.push("COLOR_ADJUSTMENT"),Ke.sdfIcons&&Ut.push("RENDER_SDF"),Mr&&Ut.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),wr&&he&&!l.terrain&&Ke.icon.orientationVertexBuffer&&Ut.push("ELEVATED_ROADS");const Nn=Ke.icon.programConfigurations.get(n.id),Gn=l.getOrCreateProgram("symbol",{config:Nn,defines:Ut}),ko=$e.imageAtlasTexture?$e.imageAtlasTexture.size:[0,0],Vn=Ke.iconSizeData,Bo=s.bJ(Vn,Y.zoom),ls=he||!Y.isOrthographic,wn=Va(ct,$e.tileID.canonical,he,re,Y,Ke.getProjection(),dt),Dr=Ds(ct,$e.tileID.canonical,he,re,Y,Ke.getProjection(),dt),Gr=l.translatePosMatrix(Dr,$e,y,T,!0),er=l.translatePosMatrix(ct,$e,y,T),$r=gi?ia:wn,Tn=re&&!he&&!Ni;let zr=Qe;!be&&!Y.mercatorFromTransition||re||(zr=Gh(Y));const No=gt?zr:Qe,xl=n.getColorAdjustmentMatrix(k,U,$,G),Gs=Uh(Vn.kind,Bo,Tn,he,l,er,$r,Gr,ee,!1,ko,[0,0],0,mt,ht,ce,pi,No,Ke.getProjection(),Br,Yi,xl,oo,null),vl=$e.imageAtlasTexture?$e.imageAtlasTexture:null,bl=n.layout.get("icon-size").constantOr(0)!==1||Ke.iconsNeedLinear,Vo=Ke.sdfIcons||l.options.rotating||l.options.zooming||bl||ls?Q.LINEAR:Q.NEAREST,As=Ke.sdfIcons&&n.paint.get("icon-halo-width").constantOr(1)!==0,gn=l.terrain&&he&&Ni?s.bk(s.bB(),wn):ia;if(Ni&&Ke.icon){const Uo=s.bU.getAtTileOffsetFunc(mt,Y.center.lat,Y.worldSize,Ke.getProjection()),za=Gl(ct,$e.tileID.canonical,he,re,Y,Ke.getProjection(),dt),pp=n.layout.get("icon-size-scale-range"),Lu=s.aA(l.scaleFactor,pp[0],pp[1]);fh(Ke,ct,l,!1,za,Dr,he,z,Uo,mt,Lu)}return{program:Gn,buffers:Ke.icon,uniformValues:Gs,atlasTexture:vl,atlasTextureIcon:null,atlasInterpolation:Vo,atlasInterpolationIcon:null,isSDF:Ke.sdfIcons,hasHalo:As,depthMode:go,tile:$e,renderWithShadows:Mr,labelPlaneMatrixInv:gn}},mi=()=>{const Ni=_e&&n.layout.get("symbol-placement")!=="point",Ut=[],gi=Ni||Le||li,wr=Ke.elevationType==="road",jr=l.shadowRenderer,Mr=wr&&Ae&&!!jr&&jr.enabled,Br=Nt(Mr),go=wr&&Ae&&!l.terrain?xe:Xe;l.terrainRenderModeElevated()&&Ae&&Ut.push("PITCH_WITH_MAP_TERRAIN"),gt&&(Ut.push("PROJECTION_GLOBE_VIEW"),gi&&Ut.push("PROJECTED_POS_ON_VIEWPORT")),!Ke.text.zOffsetVertexBuffer||wr&&l.terrain||Ut.push("Z_OFFSET"),Ke.iconsInText&&Ut.push("RENDER_TEXT_AND_SYMBOL"),Ut.push("RENDER_SDF"),Mr&&Ut.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),wr&&Ae&&!l.terrain&&Ke.text.orientationVertexBuffer&&Ut.push("ELEVATED_ROADS"),fi(Ut);const oo=Ke.text.programConfigurations.get(n.id),Nn=l.getOrCreateProgram("symbol",{config:oo,defines:Ut});let Gn,ko=[0,0],Vn=null;const Bo=Ke.textSizeData;Ke.iconsInText&&(ko=$e.imageAtlasTexture?$e.imageAtlasTexture.size:[0,0],Vn=$e.imageAtlasTexture?$e.imageAtlasTexture:null,Gn=Ae||!Y.isOrthographic||l.options.rotating||l.options.zooming||Bo.kind==="composite"||Bo.kind==="camera"?Q.LINEAR:Q.NEAREST);const ls=$e.glyphAtlasTexture?$e.glyphAtlasTexture.size:[0,0],wn=n.layout.get("text-size-scale-range"),Dr=s.aA(l.scaleFactor,wn[0],wn[1]),Gr=s.bJ(Bo,Y.zoom,Dr),er=Va(ct,$e.tileID.canonical,Ae,_e,Y,Ke.getProjection(),dt),$r=Ds(ct,$e.tileID.canonical,Ae,_e,Y,Ke.getProjection(),dt),Tn=l.translatePosMatrix($r,$e,x,S,!0),zr=l.translatePosMatrix(ct,$e,x,S),No=gi?ia:er,xl=_e&&!Ae&&!Ni;let Gs=Qe;!be&&!Y.mercatorFromTransition||_e||(Gs=Gh(Y));const vl=Uh(Bo.kind,Gr,xl,Ae,l,zr,No,Tn,ee,!0,ls,ko,0,mt,ht,ce,pi,gt?Gs:Qe,Ke.getProjection(),Br,Yi,null,null,Dr),bl=$e.glyphAtlasTexture?$e.glyphAtlasTexture:null,Vo=Q.LINEAR,As=n.paint.get("text-halo-width").constantOr(1)!==0,gn=l.terrain&&Ae&&Ni?s.bk(s.bB(),er):ia;if(Ni&&Ke.text){const Uo=s.bU.getAtTileOffsetFunc(mt,Y.center.lat,Y.worldSize,Ke.getProjection()),za=Gl(ct,$e.tileID.canonical,Ae,_e,Y,Ke.getProjection(),dt);fh(Ke,ct,l,!0,za,$r,Ae,N,Uo,mt,Dr)}return{program:Nn,buffers:Ke.text,uniformValues:vl,atlasTexture:bl,atlasTextureIcon:Vn,atlasInterpolation:Vo,atlasInterpolationIcon:Gn,isSDF:!0,hasHalo:As,depthMode:go,tile:$e,renderWithShadows:Mr,labelPlaneMatrixInv:gn}},ir=Ke.icon.segments.get().length,Ii=Ke.text.segments.get().length,Qt=ir&&!m.onlyText?qi():null,ki=Ii&&!m.onlyIcons?mi():null,ri=n.paint.get("icon-opacity").constantOr(1),ur=n.paint.get("text-opacity").constantOr(1);if(ve&&Ke.canOverlap){ze=!0;const Ni=ri&&!m.onlyText?Ke.icon.segments.get():[],Ut=ur&&!m.onlyIcons?Ke.text.segments.get():[];for(const gi of Ni)Ve.push({segments:new s.bf([gi]),sortKey:gi.sortKey,state:Qt});for(const gi of Ut)Ve.push({segments:new s.bf([gi]),sortKey:gi.sortKey,state:ki})}else m.onlyText||Ve.push({segments:ri?Ke.icon.segments:new s.bf([]),sortKey:0,state:Qt}),m.onlyIcons||Ve.push({segments:ur?Ke.text.segments:new s.bf([]),sortKey:0,state:ki})}ze&&Ve.sort(((mt,$e)=>mt.sortKey-$e.sortKey));for(const mt of Ve){const $e=mt.state;if($e)if(l.terrain?l.terrain.setupElevationDraw($e.tile,$e.program,{useDepthForOcclusion:Y.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:$e.labelPlaneMatrixInv}):l.setupDepthForOcclusion(Y.depthOcclusionForSymbolsAndCircles,$e.program),ie.activeTexture.set(Q.TEXTURE0),$e.atlasTexture&&$e.atlasTexture.bind($e.atlasInterpolation,Q.CLAMP_TO_EDGE,!0),$e.atlasTextureIcon&&(ie.activeTexture.set(Q.TEXTURE1),$e.atlasTextureIcon&&$e.atlasTextureIcon.bind($e.atlasInterpolationIcon,Q.CLAMP_TO_EDGE,!0)),$e.renderWithShadows&&l.shadowRenderer.setupShadows($e.tile.tileID.toUnwrapped(),$e.program,"vector-tile"),l.uploadCommonLightUniforms(l.context,$e.program),$e.hasHalo){const Ke=$e.uniformValues;Ke.u_is_halo=1,pu($e.buffers,mt.segments,n,l,$e.program,$e.depthMode,d,p,Ke,2),Ke.u_is_halo=0}else{if($e.isSDF){const Ke=$e.uniformValues;$e.hasHalo&&(Ke.u_is_halo=1,pu($e.buffers,mt.segments,n,l,$e.program,$e.depthMode,d,p,Ke,1)),Ke.u_is_halo=0}pu($e.buffers,mt.segments,n,l,$e.program,$e.depthMode,d,p,$e.uniformValues,1)}}}function pu(l,t,n,c,d,p,m,y,x,T){const S=[l.dynamicLayoutVertexBuffer,l.opacityVertexBuffer,l.iconTransitioningVertexBuffer,l.globeExtVertexBuffer,l.zOffsetVertexBuffer,l.orientationVertexBuffer];d.draw(c,c.context.gl.TRIANGLES,p,m,y,Bt.disabled,x,n.id,l.layoutVertexBuffer,l.indexBuffer,t,n.paint,c.transform.zoom,l.programConfigurations.get(n.id),S,T)}function qf(l,t){const n=1<<l.canonical.z,c=(t.x*n-l.canonical.x-l.wrap*n)*s.al,d=(t.y*n-l.canonical.y)*s.al,p=s.e7(t.z,t.y);return s.d4(c,d,p)}function Aa(l,t,n,c,d){if(!n.layout||n.layout.get("fill-elevation-reference")==="none"||n.paint.get("fill-opacity").constantOr(1)===0)return;const p=l.context.gl,m=new xt(l.context.gl.LEQUAL,xt.ReadWrite,l.depthRangeFor3D),y=new xt(l.context.gl.GREATER,xt.ReadWrite,l.depthRangeFor3D),x=(function(C){let R=.01;return C.isOrthographic&&(R=s.ak(1e-4,R,s.c$(C.pitch>=ba?1:C.pitch/ba))),2*R})(l.transform),T=l.transform.getFreeCameraOptions().position,S="elevatedStructuresDepthReconstruct",M=l.getOrCreateProgram(S,{defines:["DEPTH_RECONSTRUCTION"]}),E=l.getOrCreateProgram(S);for(const C of c){const R=t.getTile(C),z=R.getBucket(n);if(!z)continue;const N=z.elevatedStructures;if(!N)continue;const k=z.elevationBufferData.heightRange,U=qf(C.toUnwrapped(),T),$=l.translatePosMatrix(C.projMatrix,R,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));let G,ee,Z,ie;if(d==="initialize"){if(!k||k.min>=1||N.depthSegments.segments[0].primitiveLength===0)continue;G=ru($,U,x,1,0),ee=m,Z=N.depthSegments,ie=M}else if(d==="reset"){if(!k||k.min>=0||N.maskSegments.segments[0].primitiveLength===0)continue;G=ru($,U,0,0,1),ee=y,Z=N.maskSegments,ie=M}else if(d==="geometry"){if(N.depthSegments.segments[0].primitiveLength===0)continue;G=ru($,U,x,1,0),ee=m,Z=N.depthSegments,ie=E}ie.draw(l,p.TRIANGLES,ee,Gt.disabled,ti.disabled,Bt.disabled,G,n.id,N.vertexBuffer,N.indexBuffer,Z,n.paint,l.transform.zoom)}}function ol(l,t,n){const{painter:c,sourceCache:d,layer:p,coords:m,colorMode:y,elevationType:x,terrainEnabled:T,pass:S}=l,M=c.context.gl,E=p.paint.get("fill-pattern"),C=p.paint.get("fill-pattern-cross-fade"),R=E.constantOr(null);let z=x;x!=="road"||t&&!T||(z="none");const N=z==="road",k=l.painter.shadowRenderer,U=N&&!!k&&k.enabled,$=new xt(c.context.gl.LEQUAL,xt.ReadOnly,c.depthRangeFor3D);let G=[0,0,0];if(U){const ie=c.style.directionalLight,Q=c.style.ambientLight;ie&&Q&&(G=is(c.style,ie,Q))}const ee=E&&E.constantOr(1),Z=(ie,Q)=>{let Y,re,_e,he,Ae;Q?(Y=ee&&!p.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",_e=M.LINES):(Y=ee?"fillPattern":"fill",_e=M.TRIANGLES);for(const ve of m){const ze=d.getTile(ve);if(ee&&!ze.patternsLoaded())continue;const Xe=ze.getBucket(p);if(!Xe)continue;const xe=t?Xe.elevationBufferData:Xe.bufferData;if(xe.isEmpty())continue;c.prepareDrawTile();const ce=xe.programConfigurations.get(p.id),Le=c.isTileAffectedByFog(ve),be=[],Ve=[];N&&(be.push("ELEVATED_ROADS"),Ve.push(xe.elevatedLayoutVertexBuffer)),U&&be.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),ee&&(c.context.activeTexture.set(M.TEXTURE0),ze.imageAtlasTexture&&ze.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),ce.updatePaintBuffers());let Qe=!1;if(R&&ze.imageAtlas){const ht=ze.imageAtlas,ct=s.e2.from(R),dt=ct.getPrimary().scaleSelf(s.o.devicePixelRatio).toString(),Pt=ct.getSecondary(),li=ht.patternPositions.get(dt),pi=Pt?ht.patternPositions.get(Pt.scaleSelf(s.o.devicePixelRatio).toString()):null;Qe=!!li&&!!pi,li&&ce.setConstantPatternPositions(li,pi)}C>0&&(Qe||ce.getPatternTransitionVertexBuffer("fill-pattern"))&&be.push("FILL_PATTERN_TRANSITION");const mt=c.getOrCreateProgram(Y,{config:ce,overrideFog:Le,defines:be}),$e=c.translatePosMatrix(ve.projMatrix,ze,p.paint.get("fill-translate"),p.paint.get("fill-translate-anchor"));U&&k.setupShadows(ze.tileID.toUnwrapped(),mt,"vector-tile");const Ke=p.paint.get("fill-emissive-strength");if(Q){he=xe.lineIndexBuffer,Ae=xe.lineSegments;const ht=c.terrain&&c.terrain.renderingToTexture?c.terrain.drapeBufferSize:[M.drawingBufferWidth,M.drawingBufferHeight];re=Y==="fillOutlinePattern"&&ee?Fm($e,Ke,c,ze,ht,G,C):Om($e,Ke,ht,G)}else he=xe.indexBuffer,Ae=xe.triangleSegments,re=ee?Vf($e,Ke,c,ze,G,C):Nf($e,Ke,G);c.uploadCommonUniforms(c.context,mt,ve.toUnwrapped());let gt=ie;(x==="road"&&!T||x==="offset")&&(gt=$),mt.draw(c,_e,gt,n||c.stencilModeForClipping(ve),y,Bt.disabled,re,p.id,xe.layoutVertexBuffer,he,Ae,p.paint,c.transform.zoom,ce,Ve)}};c.renderPass===S&&Z(c.depthModeForSublayer(1,c.renderPass==="opaque"?xt.ReadWrite:xt.ReadOnly),!1),z==="none"&&c.renderPass==="translucent"&&p.paint.get("fill-antialias")&&Z(c.depthModeForSublayer(p.getPaintProperty("fill-outline-color")?2:0,xt.ReadOnly),!0)}function pt(l,t,n,c,d,p,m,y){n.resetLayerRenderingStats(l);const x=l.context,T=x.gl,S=l.transform,M=n.paint.get("fill-extrusion-pattern"),E=n.paint.get("fill-extrusion-pattern-cross-fade"),C=M.constantOr(null),R=M.constantOr(1),z=n.paint.get("fill-extrusion-opacity"),N=l.style.enable3dLights(),k=n.paint.get(N&&!R?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),U=[n.paint.get("fill-extrusion-ambient-occlusion-intensity"),k],$=n.layout.get("fill-extrusion-edge-radius"),G=$>0&&!n.paint.get("fill-extrusion-rounded-roof"),ee=G?0:$,Z=S.projection.name==="globe"?s.ea():0,ie=S.projection.name==="globe",Q=ie?s.aj(S.zoom):0,Y=[s.aF(S.center.lng),s.aJ(S.center.lat)],re=n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",_e=n.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(re?null:n.lut).toArray01().slice(0,3),he=n.paint.get("fill-extrusion-flood-light-intensity"),Ae=n.paint.get("fill-extrusion-vertical-scale"),ve=n.paint.get("fill-extrusion-line-width").constantOr(1)!==0,ze=n.paint.get("fill-extrusion-height-alignment"),Xe=n.paint.get("fill-extrusion-base-alignment"),xe=Fs(l,n.paint.get("fill-extrusion-cutoff-fade-range")),ce=[];let Le;ie&&ce.push("PROJECTION_GLOBE_VIEW"),U[0]>0&&ce.push("FAUX_AO"),G&&ce.push("ZERO_ROOF_RADIUS"),y&&ce.push("HAS_CENTROID"),he>0&&ce.push("FLOOD_LIGHT"),xe.shouldRenderCutoff&&ce.push("RENDER_CUTOFF"),ve&&ce.push("RENDER_WALL_MODE");const be=l.renderPass==="shadow",Ve=l.shadowRenderer,Qe=be&&!!Ve,mt=be?Bt.disabled:Bt.backCCW;l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0);let $e=[0,0,0];if(Ve){const ht=l.style.directionalLight,ct=l.style.ambientLight;ht&&ct&&($e=is(l.style,ht,ct)),be||(ce.push("RENDER_SHADOWS","DEPTH_TEXTURE"),Ve.useNormalOffset&&ce.push("NORMAL_OFFSET")),Le=ce.concat(["SHADOWS_SINGLE_CASCADE"])}const Ke=Qe?"fillExtrusionDepth":R?"fillExtrusionPattern":"fillExtrusion",gt=n.getLayerRenderingStats();for(const ht of c){const ct=t.getTile(ht),dt=ct.getBucket(n);if(!dt||dt.projection.name!==S.projection.name)continue;let Pt=!1;Ve&&(Pt=Ve.getMaxCascadeForTile(ht.toUnwrapped())===0);const li=l.isTileAffectedByFog(ht),pi=dt.programConfigurations.get(n.id);let Yi=!1;if(C&&ct.imageAtlas){const Ii=ct.imageAtlas,Qt=s.e2.from(C),ki=Qt.getPrimary().scaleSelf(s.o.devicePixelRatio).toString(),ri=Qt.getSecondary(),ur=Ii.patternPositions.get(ki),Ni=ri?Ii.patternPositions.get(ri.scaleSelf(s.o.devicePixelRatio).toString()):null;Yi=!!ur&&!!Ni,ur&&pi.setConstantPatternPositions(ur,Ni)}E>0&&(Yi||pi.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&ce.push("FILL_EXTRUSION_PATTERN_TRANSITION");const Nt=l.getOrCreateProgram(Ke,{config:pi,defines:Pt?Le:ce,overrideFog:li});if(l.terrain&&l.terrain.setupElevationDraw(ct,Nt,{useMeterToDem:!0}),!dt.centroidVertexBuffer){const Ii=Nt.getAttributeLocation(T,"a_centroid_pos");Ii!==-1&&T.vertexAttrib2f(Ii,0,0)}!be&&Ve&&Ve.setupShadows(ct.tileID.toUnwrapped(),Nt,"vector-tile"),R&&(l.context.activeTexture.set(T.TEXTURE0),ct.imageAtlasTexture&&ct.imageAtlasTexture.bind(T.LINEAR,T.CLAMP_TO_EDGE),pi.updatePaintBuffers());const fi=n.paint.get("fill-extrusion-vertical-gradient"),Kt=1/dt.tileToMeter;let qi;if(be&&Ve){if($f(ct.tileID,dt.maxHeight,l))continue;const Ii=Ve.calculateShadowPassMatrixFromTile(ct.tileID.toUnwrapped());qi=kf(Ii,ee,Kt,Ae,ze,Xe)}else{const Ii=l.translatePosMatrix(ht.expandedProjMatrix,ct,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),Qt=S.projection.createInversionMatrix(S,ht.canonical);qi=R?Bf(Ii,l,fi,z,U,ee,Kt,ht,ct,Z,ze,Xe,Q,Y,Qt,_e,Ae,E):iu(Ii,l,fi,z,U,ee,Kt,ht,Z,ze,Xe,Q,Y,Qt,_e,Ae,he,$e)}l.uploadCommonUniforms(x,Nt,ht.toUnwrapped(),null,xe);let mi=dt.segments;if(S.projection.name==="mercator"&&!be&&(mi=dt.getVisibleSegments(ct.tileID,l.terrain,l.transform.getFrustum(0)),!mi.get().length))continue;if(gt)if(be)for(const Ii of mi.get())gt.numRenderedVerticesInShadowPass+=Ii.primitiveLength;else for(const Ii of mi.get())gt.numRenderedVerticesInTransparentPass+=Ii.primitiveLength;const ir=[];(l.terrain||y)&&ir.push(dt.centroidVertexBuffer),ie&&ir.push(dt.layoutVertexExtBuffer),ve&&ir.push(dt.wallVertexBuffer),Nt.draw(l,x.gl.TRIANGLES,d,p,m,mt,qi,n.id,dt.layoutVertexBuffer,dt.indexBuffer,mi,n.paint,l.transform.zoom,pi,ir)}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1)}class Hh{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function Bs(l,t,n,c,d,p,m,y,x,T,S,M,E,C,R,z,N,k,U,$){const G=t.context,ee=G.gl,Z=t.transform,ie=t.transform.zoom,Q=[],Y=l.translate,re=l.translateAnchor,_e=l.edgeRadius,he=Fs(t,l.cutoffFadeRange);S==="clear"?(Q.push("CLEAR_SUBPASS"),$&&(Q.push("CLEAR_FROM_TEXTURE"),G.activeTexture.set(ee.TEXTURE0),$.bind(ee.LINEAR,ee.CLAMP_TO_EDGE))):S==="sdf"&&Q.push("SDF_SUBPASS"),k&&Q.push("HAS_CENTROID"),he.shouldRenderCutoff&&Q.push("RENDER_CUTOFF");const Ae=(ve,ze,Xe,xe,ce)=>{let Le=Q;ze.groundRadiusBuffer!=null&&(Le=Q.concat("HAS_ATTRIBUTE_a_flood_light_ground_radius"));const be=ze.programConfigurations.get(c.id),Ve=t.isTileAffectedByFog(ve),Qe=t.getOrCreateProgram("fillExtrusionGroundEffect",{config:be,defines:Le,overrideFog:Ve}),mt=il(t,xe,M,T,ce,[E,C*ce],R,z,N,ie>=17?0:_e*ce,$?$.size[0]:0),$e=[];k&&$e.push(ze.hiddenByLandmarkVertexBuffer),ze.groundRadiusBuffer!=null&&$e.push(ze.groundRadiusBuffer),t.uploadCommonUniforms(G,Qe,ve.toUnwrapped(),null,he),Qe.draw(t,G.gl.TRIANGLES,p,m,y,x,mt,c.id,ze.vertexBuffer,ze.indexBuffer,Xe,c.paint,ie,be,$e)};for(const ve of d){const ze=n.getTile(ve),Xe=ze.getBucket(c);if(!Xe||Xe.projection.name!==Z.projection.name||!Xe.groundEffect||Xe.groundEffect&&!Xe.groundEffect.hasData())continue;const xe=Xe.groundEffect,ce=1/Xe.tileToMeter;{const Le=t.translatePosMatrix(ve.projMatrix,ze,Y,re),be=xe.getDefaultSegment();Ae(ve,xe,be,Le,ce)}if(U)for(let Le=0;Le<4;Le++){const be=s.e8[Le](ve),Ve=n.getTile(be);if(!Ve)continue;const Qe=Ve.getBucket(c);if(!Qe||Qe.projection.name!==Z.projection.name||!Qe.groundEffect||Qe.groundEffect&&!Qe.groundEffect.hasData())continue;const mt=Qe.groundEffect;let $e,Ke;Le===0?($e=[-s.al,0,0],Ke=1):Le===1?($e=[s.al,0,0],Ke=0):Le===2?($e=[0,-s.al,0],Ke=3):($e=[0,s.al,0],Ke=2);const gt=mt.regionSegments[Ke];if(!gt)continue;const ht=new Float32Array(16);s.bq(ht,ve.projMatrix,$e),Ae(ve,mt,gt,t.translatePosMatrix(ht,ze,Y,re),ce)}}}function ra(l,t,n,c,d,p,m){c.centroidVertexArray.length===0&&c.createCentroidsBuffer();const y=p?p.findDEMTileFor(n):null;if(!(y&&y.dem||m))return;p&&y&&y.dem&&c.selfDEMTileTimestamp!==y.dem._timestamp&&(c.borderDoneWithNeighborZ=[-1,-1,-1,-1],c.selfDEMTileTimestamp=y.dem._timestamp);const x=k=>new s.P(Math.ceil((k+s.ec)*s.ed),0),T=k=>{const U=t.getSource().minzoom,$=ee=>{const Z=t.getTileByID(ee);if(Z&&Z.hasData())return Z.getBucket(d)},G=[0,-1,1];for(const ee of G){if(k.overscaledZ+ee<U)continue;const Z=$(k.calculateScaledKey(k.overscaledZ+ee));if(Z)return Z}},S=[0,0,0],M=(k,U)=>(S[0]=Math.min(k.min.y,U.min.y),S[1]=Math.max(k.max.y,U.max.y),S[2]=s.al-U.min.x>k.max.x?U.min.x-s.al:k.max.x,S),E=(k,U)=>(S[0]=Math.min(k.min.x,U.min.x),S[1]=Math.max(k.max.x,U.max.x),S[2]=s.al-U.min.y>k.max.y?U.min.y-s.al:k.max.y,S),C=[(k,U)=>M(k,U),(k,U)=>M(U,k),(k,U)=>E(k,U),(k,U)=>E(U,k)],R=(k,U,$,G,ee,Z,ie)=>{if(!p)return 0;const Q=[[Z?$:k,Z?k:$,0],[Z?$:U,Z?U:$,0]],Y=ie<0?s.al+ie:ie,re=[Z?Y:(k+U)/2,Z?(k+U)/2:Y,0];return $===0&&ie<0||$!==0&&ie>0?p.getForTilePoints(ee,[re],!0,G):Q.push(re),p.getForTilePoints(n,Q,!0,y),Math.max(Q[0][2],Q[1][2],re[2])/p.exaggeration()};for(let k=0;k<4;k++){const U=c.borderFeatureIndices[k];if(U.length===0)continue;const $=s.e8[k](n),G=T($);if(!(G&&G instanceof s.e9))continue;const ee=p?p.findDEMTileFor($):null;if(!(ee&&ee.dem||m)||(p&&ee&&ee.dem&&c.borderDEMTileTimestamp[k]!==ee.dem._timestamp&&(c.borderDoneWithNeighborZ[k]=-1,c.borderDEMTileTimestamp[k]=ee.dem._timestamp),c.borderDoneWithNeighborZ[k]===G.canonical.z))continue;G.centroidVertexArray.length===0&&G.createCentroidsBuffer();const Z=(k<2?1:5)-k,ie=G.borderDoneWithNeighborZ[Z]!==c.canonical.z,Q=G.borderFeatureIndices[Z];let Y=0;if(c.canonical.z!==G.canonical.z){for(const re of U)c.showCentroid(c.featuresOnBorder[re]);if(ie)for(const re of Q)G.showCentroid(G.featuresOnBorder[re]);c.borderDoneWithNeighborZ[k]=G.canonical.z,G.borderDoneWithNeighborZ[Z]=c.canonical.z}for(const re of U){const _e=c.featuresOnBorder[re],he=c.centroidData[_e.centroidDataIndex],Ae=_e.borders[k];let ve;for(;Y<Q.length;){ve=G.featuresOnBorder[Q[Y]];const ze=ve.borders[Z];if(ze[1]>Ae[0]+3||ze[0]>Ae[0]-3)break;G.showCentroid(ve),Y++}if(ve&&Y<Q.length){const ze=Y;let Xe=0;for(;!(ve.borders[Z][0]>Ae[1]-3)&&(Xe++,++Y!==Q.length);)ve=G.featuresOnBorder[Q[Y]];ve=G.featuresOnBorder[Q[ze]];let xe=!1;if(Xe>=1){const be=ve.borders[Z];Math.abs(Ae[0]-be[0])<3&&Math.abs(Ae[1]-be[1])<3&&(Xe=1,xe=!0,Y=ze+1)}else if(Xe===0){c.showCentroid(_e);continue}const ce=G.centroidData[ve.centroidDataIndex];m&&xe&&(((z=he).flags|(N=ce).flags)&s.eb?(z.flags|=s.eb,N.flags|=s.eb):(z.flags&=~s.eb,N.flags&=~s.eb));const Le=_e.intersectsCount()>1||ve.intersectsCount()>1;if(Xe>1)Y=ze,he.centroidXY=ce.centroidXY=new s.P(0,0);else if(ee&&ee.dem&&!Le){const be=C[k](he,ce),Ve=k%2?s.al-1:0,Qe=R(be[0],Math.min(s.al-1,be[1]),Ve,ee,$,k<2,be[2]);he.centroidXY=ce.centroidXY=x(Qe)}else Le?he.centroidXY=ce.centroidXY=new s.P(0,0):(he.centroidXY=c.encodeBorderCentroid(_e),ce.centroidXY=G.encodeBorderCentroid(ve));c.writeCentroidToBuffer(he),G.writeCentroidToBuffer(ce)}else c.showCentroid(_e)}c.borderDoneWithNeighborZ[k]=G.canonical.z,G.borderDoneWithNeighborZ[Z]=c.canonical.z}var z,N;(c.needsCentroidUpdate||!c.centroidVertexBuffer&&c.centroidVertexArray.length!==0)&&c.uploadCentroid(l)}const na=[1,0,0],Ct=[0,1,0],qh=[0,0,1];function $f(l,t,n){const c=n.transform,d=n.shadowRenderer;if(!d)return!0;const p=l.toUnwrapped(),m=c.tileSize*d._cascades[n.currentShadowCascade].scale;let y=t;if(c.elevation){const z=c.elevation.getMinMaxForTile(l);z&&(y+=z.max)}const x=[...d.shadowDirection];x[2]=-x[2];const T=d.computeSimplifiedTileShadowVolume(p,y,m,x);if(!T)return!1;const S=[na,Ct,qh,x,[x[0],0,x[2]],[0,x[1],x[2]]],M=c.projection.name==="globe",E=c.scaleZoom(m),C=s.cA.fromInvProjectionMatrix(c.invProjMatrix,c.worldSize,E,!M),R=d.getCurrentCascadeFrustum();return C.intersectsPrecise(T.vertices,T.planes,S)===0||R.intersectsPrecise(T.vertices,T.planes,S)===0}function mu(l){const{painter:t,source:n,layer:c,coords:d}=l;let p=l.defines;const m=t.context,y=t.renderPass==="shadow",x=t.renderPass==="light-beam",T=t.shadowRenderer,S=s.ee(t.transform.center.lat,t.transform.zoom),M=Fs(t,c.paint.get("building-cutoff-fade-range"));M.shouldRenderCutoff&&(p=p.concat("RENDER_CUTOFF")),l.floodLightIntensity>0&&(p=p.concat("FLOOD_LIGHT"));for(const E of d){const C=n.getTile(E),R=C.getBucket(c);if(!R)continue;T&&T.getMaxCascadeForTile(E.toUnwrapped())===0&&(p=p.concat("SHADOWS_SINGLE_CASCADE"));const z=R.programConfigurations.get(c.id);let N,k,U,$=t.translatePosMatrix(E.expandedProjMatrix,C,[0,0],"map");if($=s.cR(s.bB(),$,[1,1,l.verticalScale]),y&&T){if($f(C.tileID,R.maxHeight*S,t))continue;let ee=T.calculateShadowPassMatrixFromTile(C.tileID.toUnwrapped());ee=s.cR(s.bB(),ee,[1,1,l.verticalScale]),U=Uf(ee),N=k=t.getOrCreateProgram("buildingDepth",{config:z,defines:p,overrideFog:!1})}else if(x)N=k=t.getOrCreateProgram("buildingBloom",{config:z,defines:p,overrideFog:!1}),U=kh($);else{const ee=t.transform.calculatePosMatrix(E.toUnwrapped(),t.transform.worldSize);s.cR(ee,ee,[1,1,l.verticalScale]);const Z=s.bB();s.cR(Z,ee,[1,-1,1/S]),s.bk(Z,Z),s.ef(Z,Z);const ie=t.transform.getFreeCameraOptions().position,Q=1<<E.canonical.z;if(U=Fh($,Z,l.opacity,l.facadeAOIntensity,[((ie.x-E.wrap)*Q-E.canonical.x)*s.al,(ie.y*Q-E.canonical.y)*s.al,ie.z*Q*s.al],R.tileToMeter,l.facadeEmissiveChance,l.floodLightColor,l.floodLightIntensity),k=t.getOrCreateProgram("building",{config:z,defines:p,overrideFog:!1}),l.depthOnly===!0)N=k;else{const Y=p.concat(["BUILDING_FAUX_FACADE","HAS_ATTRIBUTE_a_faux_facade_color_emissive"]);N=t.getOrCreateProgram("building",{config:z,defines:Y,overrideFog:!1})}T&&(T.setupShadowsFromMatrix(ee,k,!0),N!==k&&T.setupShadowsFromMatrix(ee,N,!0))}const G=(ee,Z)=>{if(x){const ie=ee.entranceBloom;Z.draw(t,m.gl.TRIANGLES,l.depthMode,Gt.disabled,l.blendMode,Bt.disabled,U,c.id,ie.layoutVertexBuffer,ie.indexBuffer,ie.segmentsBucket,c.paint,t.transform.zoom,z,[ie.layoutAttenuationBuffer,ie.layoutColorBuffer])}else{const ie=ee.segmentsBucket;let Q=[ee.layoutNormalBuffer,ee.layoutCentroidBuffer,ee.layoutColorBuffer,ee.layoutFloodLightDataBuffer];ee.layoutFacadePaintBuffer&&(Q=Q.concat([ee.layoutFacadeDataBuffer,ee.layoutFacadeVerticalRangeBuffer,ee.layoutFacadePaintBuffer])),Z.draw(t,m.gl.TRIANGLES,l.depthMode,Gt.disabled,l.blendMode,y?Bt.disabled:Bt.backCW,U,c.id,ee.layoutVertexBuffer,ee.indexBuffer,ie,c.paint,t.transform.zoom,z,Q)}};t.uploadCommonUniforms(m,k,E.toUnwrapped(),null,M),R.buildingWithoutFacade&&G(R.buildingWithoutFacade,k),R.buildingWithFacade&&(N!==k&&t.uploadCommonUniforms(m,N,E.toUnwrapped(),null,M),G(R.buildingWithFacade,N))}}function _u(l,t,n,c,d,p,m,y,x,T,S,M,E){const C=l.context.gl,R=l.depthModeForSublayer(1,xt.ReadOnly,C.LEQUAL,!0),z=.1*(1-(N=S))+3*N;var N;const k=l._showOverdrawInspector,U=M,$=new Hh;k||Bs($,l,t,n,c,R,new Gt({func:C.ALWAYS,mask:255},255,255,C.KEEP,C.KEEP,C.REPLACE),new ti([C.ONE,C.ONE,C.ONE,C.ONE],s.ao.transparent,[!1,!1,!1,!0],C.MIN),Bt.disabled,d,"sdf",p,m,y,x,T,z,U,!1);{const G=k?Gt.disabled:new Gt({func:C.EQUAL,mask:255},255,255,C.KEEP,C.DECR,C.DECR),ee=k?l.colorModeForRenderPass():new ti([C.ONE_MINUS_DST_ALPHA,C.DST_ALPHA,C.ONE,C.ONE],s.ao.transparent,[!0,!0,!0,!0]);Bs($,l,t,n,c,R,G,ee,Bt.disabled,d,"color",p,m,y,x,T,z,U,!1)}}function $h(l){return[l[0]*s.eg,l[1]*s.eg,l[2]*s.eg,0]}function Zh(l,t,n,c,d,p,m,y,x){const T=c.getSource(),S=n.globeSharedBuffers;if(!S)return;let M,E,C;if(t&&(M=c.getTile(t)),T instanceof s.aT?(E=T.texture,C=s.dJ(0,0,n.transform)):M&&t&&(E=M.texture,C=s.dJ(t.canonical.z,t.canonical.x,n.transform)),!E||!C)return;l||(C=s.cR(s.bB(),C,[1,-1,1]));const R=n.context,z=R.gl,N=d.paint.get("raster-resampling")==="nearest"?z.NEAREST:z.LINEAR,k=n.colorModeForDrapableLayerRenderPass(p),U=m.defines;U.push("GLOBE_POLES");const $=new xt(z.LEQUAL,xt.ReadWrite,n.depthRangeFor3D),G=Float32Array.from(n.transform.expandedFarZProjMatrix),ee=Float32Array.from(s.bj(s.dI(new s.cC(0,0,0))));n.terrain&&n.terrain.prepareDrawTile(),R.activeTexture.set(z.TEXTURE0),E.bind(N,z.CLAMP_TO_EDGE),R.activeTexture.set(z.TEXTURE1),E.bind(N,z.CLAMP_TO_EDGE),"useMipmap"in E&&R.extTextureFilterAnisotropic&&n.transform.pitch>20&&z.texParameterf(z.TEXTURE_2D,R.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,R.extTextureFilterAnisotropicMax);const[Z,ie,Q,Y]=t?S.getPoleBuffers(t.canonical.z,!1):S.getPoleBuffers(0,!0),re=d.paint.get("raster-elevation");let _e;l?(_e=Z,n.renderDefaultNorthPole=re!==0):(_e=ie,n.renderDefaultSouthPole=re!==0);const he=$h(m.mix),Ae=((ze,Xe,xe,ce,Le,be,Ve,Qe,mt,$e,Ke,gt,ht)=>lc(ze,Xe,xe,new Float32Array(16),new Float32Array(9),[0,0],ce,[0,0],[0,0,0,0],1,{opacity:1,mix:0},be,[0,0],Qe,2,$e,Ke,gt,1,0,ht))(G,ee,C,s.aj(n.transform.zoom),0,d,0,re,0,he,m.offset,m.range,p),ve=n.getOrCreateProgram("raster",{defines:U});n.uploadCommonUniforms(R,ve,null),ve.draw(n,z.TRIANGLES,$,x,k,y,Ae,d.id,_e,Q,Y)}function Zf(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,d=.2*l.height,p=t+d;return[t,n,(p-d-t)/c,(p-t)/c]}function Vm(l,t,n,c){if(l)return t instanceof mn&&l instanceof Ys?t.getTextureDescriptor(l,n,!0):{texture:l.texture,mix:$h(c.mix),offset:c.offset,buffer:0,tileSize:1}}var Um=s.eh([{name:"a_index",type:"Int16",components:1}]);class Eo{constructor(t,n,c,d){const p={width:c[0],height:c[1],data:null},m=t.gl;this.targetColorTexture=new s.T(t,p,m.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new s.T(t,p,m.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(n,d),this.lastInvalidatedAt=0}updateParticleTexture(t,n){if(this.particleTextureDimension===n.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const c=this.context.gl,d=n.width*n.height;this.particleTexture0=new s.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new s.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1});const p=new s.ei;p.reserve(d);for(let m=0;m<d;m++)p.emplaceBack(m);this.particleIndexBuffer=this.context.createVertexBuffer(p,Um.members,!0),this.particleSegment=s.bf.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=n.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=s.o.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Wh(l,t,n){if(!l)return null;const c=t.getTextureDescriptor(l,n,!0);if(!c)return null;let{texture:d,mix:p,offset:m,tileSize:y,buffer:x,format:T}=c;if(!d||!T)return null;let S=!1;return T==="uint32"&&(S=!0,p[3]=0,p=nu(s.ej,p,[0,n.paint.get("raster-particle-max-speed")]),m=ks(s.ej,m,[0,n.paint.get("raster-particle-max-speed")])),{texture:d,textureOffset:[x/(y+2*x),y/(y+2*x)],tileSize:y,scalarData:S,scale:p,offset:m,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[T]]}}function no(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,d=.2*l.height,p=t+d;return[t,n,(p-d-t)/c,(p-t)/c]}const oa=new s.ao(1,0,0,1),Wf=new s.ao(0,1,0,1),Xh=new s.ao(0,0,1,1),Yh=new s.ao(1,0,1,1),Kh=new s.ao(0,1,1,1);function Jh(l,t,n,c,d,p){for(let m=0;m<n.length;m++)if(d){const T=new s.ao(c.r*.8,c.g*.8,c.b*.8,1);Io(l,t,n[m],c,-1,-1,p),Io(l,t,n[m],c,-1,1,p),Io(l,t,n[m],c,1,1,p),Io(l,t,n[m],c,1,-1,p),Io(l,t,n[m],T,0,0,p)}else Io(l,t,n[m],c,0,0,p)}function Io(l,t,n,c,d,p,m){const y=l.context,x=l.transform,T=y.gl,S=x.projection.name==="globe",M=S?["PROJECTION_GLOBE_VIEW"]:[];let E=s.by(n.projMatrix);if(S&&s.aj(x.zoom)>0){const he=s.bi(n.canonical,x),Ae=s.ek(he);E=s.aB(new Float32Array(16),x.globeMatrix,Ae),s.aB(E,x.projMatrix,E)}const C=s.bB();C[12]+=2*d/(s.o.devicePixelRatio*x.width),C[13]+=2*p/(s.o.devicePixelRatio*x.height),s.aB(E,C,E);const R=l.getOrCreateProgram("debug",{defines:M}),z=t.getTileByID(n.key);l.terrain&&l.terrain.setupElevationDraw(z,R);const N=xt.disabled,k=Gt.disabled,U=l.colorModeForRenderPass(),$="$debug";y.activeTexture.set(T.TEXTURE0),l.emptyTexture.bind(T.LINEAR,T.CLAMP_TO_EDGE),S?z._makeGlobeTileDebugBuffers(l.context,x):z._makeDebugTileBoundsBuffers(l.context,x.projection);const G=z._tileDebugBuffer||l.debugBuffer,ee=z._tileDebugIndexBuffer||l.debugIndexBuffer,Z=z._tileDebugSegments||l.debugSegments;if(R.draw(l,T.LINE_STRIP,N,k,U,Bt.disabled,Bh(E,c.toPremultipliedRenderColor(null)),$,G,ee,Z,null,null,null,[z._globeTileDebugBorderBuffer]),m){const he=z.latestRawTileData,Ae=Math.floor((he&&he.byteLength||0)/1024);let ve=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(ve+=" => ".concat(n.overscaledZ)),ve+=" ".concat(z.state),ve+=" ".concat(Ae,"kb"),(function(ze,Xe){ze.initDebugOverlayCanvas();const xe=ze.debugOverlayCanvas,ce=ze.context.gl,Le=ze.debugOverlayCanvas.getContext("2d");Le.clearRect(0,0,xe.width,xe.height),Le.shadowColor="white",Le.shadowBlur=2,Le.lineWidth=1.5,Le.strokeStyle="white",Le.textBaseline="top",Le.font="bold 36px Open Sans, sans-serif",Le.fillText(Xe,5,5),Le.strokeText(Xe,5,5),ze.debugOverlayTexture.update(xe),ze.debugOverlayTexture.bind(ce.LINEAR,ce.CLAMP_TO_EDGE)})(l,ve)}const ie=t.getTile(n).tileSize,Q=512/Math.min(ie,512)*(n.overscaledZ/x.zoom)*.5,Y=z._tileDebugTextBuffer||l.debugBuffer,re=z._tileDebugTextIndexBuffer||l.quadTriangleIndexBuffer,_e=z._tileDebugTextSegments||l.debugSegments;R.draw(l,T.TRIANGLES,N,k,ti.alphaBlended,Bt.disabled,Bh(E,s.ao.transparent.toPremultipliedRenderColor(null),Q),$,Y,re,_e,null,null,null,[z._globeTileDebugTextBuffer])}function lr(l,t,n,c){sl(l,0,t+n/2,l.transform.width,n,c)}function hc(l,t,n,c){sl(l,t-n/2,0,n,l.transform.height,c)}function sl(l,t,n,c,d,p){const m=l.context,y=m.gl;y.enable(y.SCISSOR_TEST),y.scissor(t*s.o.devicePixelRatio,n*s.o.devicePixelRatio,c*s.o.devicePixelRatio,d*s.o.devicePixelRatio),m.clear({color:p}),y.disable(y.SCISSOR_TEST)}const Xf=s.eh([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Yf}=Xf;function Ns(l,t,n,c){l.emplaceBack(t,n,c)}class Qh{constructor(t){this.vertexArray=new s.el,this.indices=new s.b0,Ns(this.vertexArray,-1,-1,1),Ns(this.vertexArray,1,-1,1),Ns(this.vertexArray,-1,1,1),Ns(this.vertexArray,1,1,1),Ns(this.vertexArray,-1,-1,-1),Ns(this.vertexArray,1,-1,-1),Ns(this.vertexArray,-1,1,-1),Ns(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,Yf),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=s.bf.simpleSegment(0,0,36,12)}}function os(l,t,n,c,d,p){const m=l.context.gl,y=t.paint.get("sky-atmosphere-color"),x=t.paint.get("sky-atmosphere-halo-color"),T=t.paint.get("sky-atmosphere-sun-intensity"),S=((M,E,C,R,z)=>({u_matrix_3f:M,u_sun_direction:E,u_sun_intensity:C,u_color_tint_r:[R.r,R.g,R.b,R.a],u_color_tint_m:[z.r,z.g,z.b,z.a],u_luminance:5e-5}))(s.en(s.dN(),c),d,T,y.toPremultipliedRenderColor(null),x.toPremultipliedRenderColor(null));m.framebufferTexture2D(m.FRAMEBUFFER,m.COLOR_ATTACHMENT0,m.TEXTURE_CUBE_MAP_POSITIVE_X+p,t.skyboxTexture,0),n.draw(l,m.TRIANGLES,xt.disabled,Gt.disabled,ti.unblended,Bt.frontCW,S,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const Ma=s.eh([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class qe{constructor(t){const n=new s.eo;n.emplaceBack(-1,1,1,0,0),n.emplaceBack(1,1,1,1,0),n.emplaceBack(1,-1,1,1,1),n.emplaceBack(-1,-1,1,0,1);const c=new s.b0;c.emplaceBack(0,1,2),c.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(n,Ma.members),this.indexBuffer=t.createIndexBuffer(c),this.segments=s.bf.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const lt=s.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class al{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class kr{constructor(t){this.colorModeAlphaBlendedWriteRGB=new ti([1,qr,1,qr],s.ao.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ti([1,0,1,0],s.ao.transparent,[!1,!1,!1,!0]),this.params=new al,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},(()=>{this.updateNeeded=!0})),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0})),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0}))}update(t){const n=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new qe(n);const c=this.params.sizeRange,d=this.params.intensityRange,p=(function(S){const M=s.eq(30),E=[];for(let C=0;C<S;++C){const R=2*Math.PI*M(),z=Math.acos(1-2*M())-.5*Math.PI;E.push(s.d4(Math.cos(z)*Math.cos(R),Math.cos(z)*Math.sin(R),Math.sin(z)))}return E})(this.params.starsCount),m=s.eq(300),y=new s.ep,x=new s.b0;let T=0;for(let S=0;S<p.length;++S){const M=s.c4([],p[S],200),E=Math.max(0,1+.01*c*(1*m()-.5)),C=Math.max(0,1+.01*d*(1*m()-.5));y.emplaceBack(M[0],M[1],M[2],-1,-1,E,C),y.emplaceBack(M[0],M[1],M[2],1,-1,E,C),y.emplaceBack(M[0],M[1],M[2],1,1,E,C),y.emplaceBack(M[0],M[1],M[2],-1,1,E,C),x.emplaceBack(T+0,T+1,T+2),x.emplaceBack(T+0,T+2,T+3),T+=4}this.starsVx=n.createVertexBuffer(y,lt.members),this.starsIdx=n.createIndexBuffer(x),this.starsSegments=s.bf.simpleSegment(0,0,y.length,x.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,n){const c=t.context,d=c.gl,p=t.transform,m=new xt(d.LEQUAL,xt.ReadOnly,[0,1]),y=s.aj(p.zoom),x=t.style.getLut(n.scope),T=n.properties.get("color-use-theme")==="none",S=n.properties.get("color").toNonPremultipliedRenderColor(T?null:x),M=n.properties.get("high-color-use-theme")==="none",E=n.properties.get("high-color").toNonPremultipliedRenderColor(M?null:x),C=n.properties.get("space-color-use-theme")==="none",R=n.properties.get("space-color").toNonPremultipliedRenderColor(C?null:x),z=5e-4,N=s.er(n.properties.get("horizon-blend"),0,1,z,.25),k=s.dD(t,c,p)&&N===z?p.worldSize/(2*Math.PI*1.025)-1:p.globeRadius,U=t.frameCounter/1e3%1,$=s.ag(p.globeCenterInViewSpace),G=Math.sqrt(Math.pow($,2)-Math.pow(k,2)),ee=Math.acos(G/$),Z=ie=>{const Q=p.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];ie&&Q.push("ALPHA_PASS");const Y=t.getOrCreateProgram("globeAtmosphere",{defines:Q}),re=((he,Ae,ve,ze,Xe,xe,ce,Le,be,Ve,Qe,mt)=>({u_frustum_tl:he,u_frustum_tr:Ae,u_frustum_br:ve,u_frustum_bl:ze,u_horizon:Xe,u_transition:xe,u_fadeout_range:ce,u_atmosphere_fog_color:Le.toArray01(),u_high_color:be.toArray01(),u_space_color:Ve.toArray01(),u_temporal_offset:Qe,u_horizon_angle:mt}))(p.frustumCorners.TL,p.frustumCorners.TR,p.frustumCorners.BR,p.frustumCorners.BL,p.frustumCorners.horizon,y,N,S,E,R,U,ee);t.uploadCommonUniforms(c,Y);const _e=this.atmosphereBuffer;_e&&Y.draw(t,d.TRIANGLES,m,Gt.disabled,ie?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Bt.backCW,re,ie?"atmosphere_glow_alpha":"atmosphere_glow",_e.vertexBuffer,_e.indexBuffer,_e.segments)};Z(!1),Z(!0)}drawStars(t,n){const c=s.aA(n.properties.get("star-intensity"),0,1);if(c===0)return;const d=t.context,p=d.gl,m=t.transform,y=t.getOrCreateProgram("stars"),x=s.c6([]);s.c8(x,x,-m._pitch),s.c7(x,x,-m.angle),s.c8(x,x,s.an(m._center.lat)),s.es(x,x,-s.an(m._center.lng));const T=s.cb(new Float32Array(16),x),S=s.aB([],m.starsProjMatrix,T),M=s.en([],T),E=s.et([],M),C=[0,1,0];s.dP(C,C,E),s.c4(C,C,this.params.sizeMultiplier);const R=[1,0,0];s.dP(R,R,E),s.c4(R,R,this.params.sizeMultiplier);const z=(N=C,k=R,U=c,{u_matrix:Float32Array.from(S),u_up:N,u_right:k,u_intensity_multiplier:U});var N,k,U;t.uploadCommonUniforms(d,y),this.starsVx&&this.starsIdx&&y.draw(t,p.TRIANGLES,xt.disabled,Gt.disabled,this.colorModeAlphaBlendedWriteRGB,Bt.disabled,z,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class ge{constructor(){this.visibleTiles=[]}updateBorders(t,n){const c=[],d=[],p=t._getRenderableCoordinates(!1,!0);for(const x of p){const T=t.getTile(x);if(!T.hasData())continue;const S=T.getBucket(n);S&&(S.isEmpty()||(c.push(x.key),d.push({bucket:S,tileID:x.canonical})))}let m=c.length!==this.visibleTiles.length;if(!m){c.sort();for(let x=0;x<c.length;x++)if(c[x]!==this.visibleTiles[x]){m=!0;break}}if(!m)return;const y=new Set;this.visibleTiles=c,d.sort(((x,T)=>x.tileID.z-T.tileID.z||x.tileID.x-T.tileID.x||x.tileID.y-T.tileID.y));for(const x of d){const T=new Array,S=new Array,M=x.bucket;for(const E of M.featuresOnBorder)y.has(E.featureId)?S.push(E.footprintIndex):(y.add(E.featureId),T.push(E.footprintIndex));M.updateFootprintHiddenFlags(T,s.eu,!1),M.updateFootprintHiddenFlags(S,s.eu,!0)}}}function ed(l,t){const n=[...l],c=t.cameraWorldSizeForFog/t.worldSize,d=s.bz([]);return s.cR(d,d,[c,c,1]),s.aB(n,d,n),s.aB(n,t.worldToFogMatrix,n),n}function ll(l,t,n,c,d){const p=n.material,m=c.context,{baseColorTexture:y,metallicRoughnessTexture:x}=p.pbrMetallicRoughness,{normalTexture:T,occlusionTexture:S,emissionTexture:M}=p;function E(R,z,N){if(R&&(l.push(z),m.activeTexture.set(m.gl.TEXTURE0+N),R.gfxTexture)){const{minFilter:k,magFilter:U,wrapS:$,wrapT:G}=R.sampler;R.gfxTexture.bindExtraParam(k,U,$,G)}}E(y,"HAS_TEXTURE_u_baseColorTexture",Rn.BaseColor),E(x,"HAS_TEXTURE_u_metallicRoughnessTexture",Rn.MetallicRoughness),E(T,"HAS_TEXTURE_u_normalTexture",Rn.Normal),E(S,"HAS_TEXTURE_u_occlusionTexture",Rn.Occlusion),E(M,"HAS_TEXTURE_u_emissionTexture",Rn.Emission),d&&(d.texture||(d.texture=new s.d_(c.context,d.image,[d.image.height,d.image.height,d.image.height],m.gl.RGBA8)),m.activeTexture.set(m.gl.TEXTURE0+Rn.LUT),d.texture&&d.texture.bind(m.gl.LINEAR,m.gl.CLAMP_TO_EDGE),l.push("APPLY_LUT_ON_GPU")),n.texcoordBuffer&&(l.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(n.texcoordBuffer)),n.colorBuffer&&(l.push(n.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(n.colorBuffer)),n.normalBuffer&&(l.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(n.normalBuffer)),n.pbrBuffer&&(l.push("HAS_ATTRIBUTE_a_pbr"),l.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(n.pbrBuffer)),p.alphaMode!=="OPAQUE"&&p.alphaMode!=="MASK"||l.push("UNPREMULT_TEXTURE_IN_SHADER"),p.defined||l.push("DIFFUSE_SHADED");const C=c.shadowRenderer;C&&(l.push("RENDER_SHADOWS","DEPTH_TEXTURE"),C.useNormalOffset&&l.push("NORMAL_OFFSET"))}function cl(l,t,n,c,d,p){const m=n.paint.get("model-opacity").constantOr(1),y=t.context,x=new xt(t.context.gl.LEQUAL,l.isLightMesh?xt.ReadOnly:xt.ReadWrite,t.depthRangeFor3D),T=t.transform,S=l.mesh,M=S.material,E=M.pbrMetallicRoughness,C=t.style.fog;let R;R=t.transform.projection.zAxisUnit==="pixels"?[...l.nodeModelMatrix]:s.aB([],c.zScaleMatrix,l.nodeModelMatrix),s.aB(R,c.negCameraPosMatrix,R);const z=s.bk([],R);s.ef(z,z);const N=n.paint.get("model-color-use-theme").constantOr("default")==="none",k=n.paint.get("model-emissive-strength").constantOr(0),U=cu(new Float32Array(l.worldViewProjection),new Float32Array(R),new Float32Array(z),null,t,m,E.baseColorFactor,M.emissiveFactor,E.metallicFactor,E.roughnessFactor,M,k,n,void 0,void 0,l.materialOverride,l.modelColor),$={defines:[]},G=[],ee=t.shadowRenderer;ee&&(ee.useNormalOffset=!1),ll($.defines,G,S,t,N?null:n.lut);let Z=null;if(C){const Y=ed(l.nodeModelMatrix,t.transform);if(Z=new Float32Array(Y),T.projection.name!=="globe"){const re=S.aabb.min,_e=S.aabb.max,[he,Ae]=C.getOpacityForBounds(Y,re[0],re[1],_e[0],_e[1]);$.overrideFog=he>=Te||Ae>=Te}}const ie=Fs(t,n.paint.get("model-cutoff-fade-range"));ie.shouldRenderCutoff&&$.defines.push("RENDER_CUTOFF");const Q=t.getOrCreateProgram("model",$);t.uploadCommonUniforms(y,Q,null,Z,ie),t.renderPass!=="shadow"&&ee&&ee.setupShadowsFromMatrix(l.nodeModelMatrix,Q),Q.draw(t,y.gl.TRIANGLES,x,d,p,S.material.doubleSided?Bt.disabled:Bt.backCCW,U,n.id,S.vertexBuffer,S.indexBuffer,S.segments,n.paint,t.transform.zoom,void 0,G)}function gu(l,t,n){return l.type==="vector"?t.scope:n?"basemap":""}function yu(l,t,n,c,d,p,m,y,x){const T=l.transform,S=!!t.isGeometryBloom&&t.isGeometryBloom;if(S&&l.renderPass==="shadow")return;const M=T.projection.name==="globe"?s.eC(n,T):[...n];s.aB(M,M,t.globalMatrix);const E=s.aB([],c,M);if(t.meshes)for(const C of t.meshes){const R=y.get(C.material.name);if(R&&R.opacity<=0)continue;if(C.material.alphaMode!=="BLEND"){m.push({mesh:C,depth:0,modelIndex:d,worldViewProjection:E,nodeModelMatrix:M,isLightMesh:S,materialOverride:R,modelColor:x});continue}const z=s.af([],C.centroid,E);!T.isOrthographic&&z[2]<=0||p.push({mesh:C,depth:z[2],modelIndex:d,worldViewProjection:E,nodeModelMatrix:M,isLightMesh:S,materialOverride:R,modelColor:x})}if(t.children)for(const C of t.children)yu(l,C,n,c,d,p,m,y,x)}function ul(l,t,n,c){const d=n.shadowRenderer;if(!d)return;const p=d.getShadowPassDepthMode(),m=d.getShadowPassColorMode(),y=d.calculateShadowPassMatrixFromMatrix(t),x=nl(y);n.getOrCreateProgram("modelDepth",{defines:n._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(n,n.context.gl.TRIANGLES,p,Gt.disabled,m,Bt.disabled,x,c.id,l.vertexBuffer,l.indexBuffer,l.segments,c.paint,n.transform.zoom,void 0,void 0)}function hl(l,t,n,c,d,p){for(const m of d){const y=Object.assign({},c);y.part=m;const x={type:"Unknown",id:t,properties:y},T={orientation:l.paint.get("model-rotation").evaluate(x,n)};p.set(m,T)}}function jm(l,t,n,c,d,p){for(const m of d){const y=Object.assign({},c);y.part=m;const x={type:"Unknown",id:t,properties:y},T={color:l.paint.get("model-color").evaluate(x,n),colorMix:l.paint.get("model-color-mix-intensity").evaluate(x,n),opacity:l.paint.get("model-opacity").evaluate(x,n),emissionStrength:l.paint.get("model-emissive-strength").evaluate(x,n)};p.set(m,T)}}function Kf(l,t,n,c,d,p){if(n===1)for(const y of d)cl(y,l,t,p[y.modelIndex],Gt.disabled,l.colorModeForRenderPass());else{for(const y of d)cl(y,l,t,p[y.modelIndex],Gt.disabled,ti.disabled);for(const y of d)cl(y,l,t,p[y.modelIndex],l.stencilModeFor3D(),l.colorModeForRenderPass());l.resetStencilClippingMasks()}const m=ti.additive;for(const y of c)cl(y,l,t,p[y.modelIndex],Gt.disabled,y.isLightMesh?m:l.colorModeForRenderPass())}function Jf(l,t,n){const c=t.updateZoomBasedPaintProperties(),d=(function(p,m,y){let x,T,S,M=p.terrain?p.terrain.exaggeration():0;if(p.terrain&&M>0){const E=p.terrain,C=E.findDEMTileFor(y);C&&C.dem?x=s.eE.create(E,y,C):M=0}if(M===0&&(m.terrainElevationMin=0,m.terrainElevationMax=0),M===m.validForExaggeration&&(M===0||x&&x._demTile&&x._demTile.tileID===m.validForDEMTile.id&&x._dem._timestamp===m.validForDEMTile.timestamp))return!1;for(const E in m.instancesPerModel){const C=m.instancesPerModel[E];for(let R=0;R<C.instancedDataArray.length;++R){const z=(x?M*x.getElevationAt(0|C.instancedDataArray.float32[16*R],0|C.instancedDataArray.float32[16*R+1],!0,!0):0)+C.instancesEvaluatedElevation[R];C.instancedDataArray.float32[16*R+6]=z,T=T?Math.min(m.terrainElevationMin,z):z,S=S?Math.max(m.terrainElevationMax,z):z}}return m.terrainElevationMin=T||0,m.terrainElevationMax=S||0,m.validForExaggeration=M,m.validForDEMTile=x&&x._demTile?{id:x._demTile.tileID,timestamp:x._dem._timestamp}:{id:void 0,timestamp:0},!0})(l,t,n);(c||d)&&(t.uploaded=!1,t.upload(l.context))}const Oo={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new s.d8([0,0,0],[s.al,s.al,0])};function td(l,t){const n=1<<l.canonical.z,c=t.getFreeCameraOptions().position,d=t.elevation,p=l.canonical.x/n,m=(l.canonical.x+1)/n,y=l.canonical.y/n,x=(l.canonical.y+1)/n;let T=t._centerAltitude;if(d){const C=d.getMinMaxForTile(l);C&&C.max>T&&(T=C.max)}const S=s.aA(c.x,p,m)-c.x,M=s.aA(c.y,y,x)-c.y,E=s.ce(T,t.center.lat)-c.z;return t._zoomFromMercatorZ(Math.sqrt(S*S+M*M+E*E))}function id(l,t,n,c,d,p,m){const y=l.context,x=l.renderPass==="shadow",T=l.shadowRenderer,S=x&&T?T.getShadowPassDepthMode():new xt(y.gl.LEQUAL,xt.ReadWrite,l.depthRangeFor3D),M=l.isTileAffectedByFog(p),E=l.transform.projection.name==="globe";if(n.meshes)for(const C of n.meshes){const R=E?[]:["MODEL_POSITION_ON_GPU"],z=[];let N,k,U;const $=!E&&c.instancedDataArray.length>20;$&&R.push("INSTANCED_ARRAYS");const G=Fs(l,t.paint.get("model-cutoff-fade-range"));if(G.shouldRenderCutoff&&R.push("RENDER_CUTOFF"),x&&T)N=l.getOrCreateProgram("modelDepth",{defines:R}),k=nl(m.shadowTileMatrix,m.shadowTileMatrix,Float32Array.from(n.globalMatrix)),U=T.getShadowPassColorMode();else{ll(R,z,C,l,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),N=l.getOrCreateProgram("model",{defines:R,overrideFog:M});const Z=C.material,ie=Z.pbrMetallicRoughness,Q=t.paint.get("model-opacity").constantOr(1),Y=t.paint.get("model-emissive-strength").constantOr(0);k=cu(p.expandedProjMatrix,Float32Array.from(n.globalMatrix),new Float32Array(16),null,l,Q,ie.baseColorFactor,Z.emissiveFactor,ie.metallicFactor,ie.roughnessFactor,Z,Y,t,d),T&&(m.shadowUniformsInitialized?N.setShadowUniformValues(y,T.getShadowUniformValues()):(T.setupShadows(p.toUnwrapped(),N,"model-tile"),m.shadowUniformsInitialized=!0)),U=G.shouldRenderCutoff||Q<1||Z.alphaMode!=="OPAQUE"?ti.alphaBlended:ti.unblended}l.uploadCommonUniforms(y,N,p.toUnwrapped(),null,G);const ee=C.material.doubleSided?Bt.disabled:Bt.backCCW;if($)z.push(c.instancedDataBuffer),N.draw(l,y.gl.TRIANGLES,S,Gt.disabled,U,ee,k,t.id,C.vertexBuffer,C.indexBuffer,C.segments,t.paint,l.transform.zoom,void 0,z,c.instancedDataArray.length);else{const Z=x?"u_instance":"u_normal_matrix";for(let ie=0;ie<c.instancedDataArray.length;++ie)k[Z]=new Float32Array(c.instancedDataArray.arrayBuffer,64*ie,16),N.draw(l,y.gl.TRIANGLES,S,Gt.disabled,U,ee,k,t.id,C.vertexBuffer,C.indexBuffer,C.segments,t.paint,l.transform.zoom,void 0,z)}}if(n.children)for(const C of n.children)id(l,t,C,c,d,p,m)}const Qf=[1,-1,1];function xu(l,t,n,c){if(!n.modelManager)return!0;const d=n.modelManager;if(!n.shadowRenderer)return!0;const p=n.shadowRenderer,m=t.aabb;let y=!0,x=l.maxHeight;if(x===0){let S=0;for(const M in l.instancesPerModel){const E=d.getModel(M,c);E?S=Math.max(S,Math.max(Math.max(E.aabb.max[0],E.aabb.max[1]),E.aabb.max[2])):y=!1}x=l.maxScale*S*1.41+l.maxVerticalOffset,y&&(l.maxHeight=x)}m.max[2]=x,m.min[2]+=l.terrainElevationMin,m.max[2]+=l.terrainElevationMax,s.af(m.min,m.min,t.tileMatrix),s.af(m.max,m.max,t.tileMatrix);const T=m.intersects(p.getCurrentCascadeFrustum());return n.currentShadowCascade===0&&(l.isInsideFirstShadowMapFrustum=T===2),T===0}function dc(l,t){const n=l.uniformValues.u_cutoff_params[0],c=l.uniformValues.u_cutoff_params[1],d=l.uniformValues.u_cutoff_params[2],p=l.uniformValues.u_cutoff_params[3];return c===n||p===d?1:s.aA(((t-n)/(c-n)-d)/(p-d),0,1)}function Ca(l,t,n,c){if(t.pitch<20)return 1;const d=t.getWorldToCameraMatrix();s.aB(d,d,l);const p=s.bT(n.min[0],n.min[1],n.min[2],1);let m=s.aC(s.eF(),p,d),y=m,x=m;p[1]=n.max[1],m=s.aC(s.eF(),p,d),y=m[1]<y[1]?m:y,x=m[1]>x[1]?m:x,p[0]=n.max[0],m=s.aC(s.eF(),p,d),y=m[1]<y[1]?m:y,x=m[1]>x[1]?m:x,p[1]=n.min[1],m=s.aC(s.eF(),p,d),y=m[1]<y[1]?m:y,x=m[1]>x[1]?m:x;const T=s.aA(c[0],0,1),S=100*t.pixelsPerMeter*s.aA(c[1],0,1),M=s.aA(c[2],0,1),E=s.eG(s.eF(),y,x,T),C=Math.tan(.5*t.fovX),R=-E[2]*C;if(S===0)return E[1]<-Math.abs(R)?M:1;const z=(-Math.abs(R)-E[1])/S,N=(U,$,G)=>(1-G)*U+G*$,k=s.aA(N(1,M,z),M,1);return N(1,k,s.aA((t.pitch-20)/20,0,1))}class ep{}class tp{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,n,c){{const M=this._storage.get(n.id);if(M)return M.lastUsedFrameIdx=t,M.buf}const d=c.gl,p=d.getBufferParameter(d.ELEMENT_ARRAY_BUFFER,d.BUFFER_SIZE),m=new ArrayBuffer(p),y=new Int16Array(m);d.getBufferSubData(d.ELEMENT_ARRAY_BUFFER,0,new Int16Array(m));const x=new s.eI;for(let M=0;M<p/2;M+=3){const E=y[M],C=y[M+1],R=y[M+2];x.emplaceBack(E,C),x.emplaceBack(C,R),x.emplaceBack(R,E)}const T=c.bindVertexArrayOES.current,S=new ep;return S.buf=new ta(c,x),S.lastUsedFrameIdx=t,this._storage.set(n.id,S),c.bindVertexArrayOES.set(T),S.buf}update(t){for(const[n,c]of this._storage)t-c.lastUsedFrameIdx>30&&(c.buf.destroy(),this._storage.delete(n))}destroy(){for(const[t,n]of this._storage)n.buf.destroy(),this._storage.delete(t)}}class Gm{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const ip=s.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Hm{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Kn{constructor(t,n){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...n,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...n,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const qm=s.eh([{type:"Float32",name:"a_pos_2f",components:2}]);class fc{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,n){const c=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const m=new s.eJ,y=new s.b0;m.emplaceBack(-1,-1),m.emplaceBack(1,-1),m.emplaceBack(1,1),m.emplaceBack(-1,1),y.emplaceBack(0,1,2),y.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(m,qm.members),this.vignetteIdx=t.context.createIndexBuffer(y)}const d=s.bf.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,c);const m={u_vignetteShape:(p={vignetteShape:[n.start,n.range,Math.pow(10,n.fadePower)],vignetteColor:[n.color.r,n.color.g,n.color.b,n.color.a*n.strength]}).vignetteShape,u_vignetteColor:p.vignetteColor};c.draw(t,t.context.gl.TRIANGLES,xt.disabled,Gt.disabled,ti.alphaBlended,Bt.disabled,m,"vignette",this.vignetteVx,this.vignetteIdx,d)}var p}}class pr{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,n){const c=t.getFreeCameraOptions().position,d=c.toAltitude(),p=c.toLngLat(),m=s.an(p.lng),y=s.an(p.lat),x=t.pixelsPerMeter/n,T=m*s.eL,S=s.eL*Math.log(Math.tan(Math.PI/4+y/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const M=-this._offsetYPrev+S,E=-this._elevationPrev+d;this._accumulatedOffsetX+=(-this._offsetXPrev+T)*x,this._accumulatedOffsetY+=M*x,this._accumulatedElevation+=E*x,this._offsetXPrev=T,this._offsetYPrev=S,this._elevationPrev=d}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function ai(l,t){return[-(l[0]-Math.floor(l[0]/t)*t),-(l[1]-Math.floor(l[1]/t)*t),-(l[2]-Math.floor(l[2]/t)*t)]}function rd(l){const t=s.eq(1323123451230),n=[];for(let c=0;c<l;++c){const d=2*t()-1,p=2*t()-1,m=2*t()-1;n.push(s.d4(d,p,m))}return n}function mo(l,t,n,c,d){const p=s.aA((d-n)/(c-n),0,1);return(1-p)*l+p*t}class Pa{constructor(t){this._movement=new pr,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new fc,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,n){const c=t.transform;this._movement.update(c,this._ppmScaleFactor);const d=c.starsProjMatrix,p=s.c6([]);s.c8(p,p,s.an(90)-c._pitch),s.c7(p,p,-c.angle);const m=s.cb(new Float32Array(16),p),y=s.eK(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),x=s.ef([],y),T=s.aB([],x,m),S=Date.now()/1e3;return this._accumulatedTimeFromStart+=(S-this._prevTime)*n,this._prevTime=S,{projectionMatrix:d,modelviewMatrix:T}}}class dl extends Pa{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Kn(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=rd(this.particlesCount),d=new s.eM,p=new s.b0;let m=0;const y=s.eq(1323123451230);for(let x=0;x<c.length;++x){const T=c[x],S=[2*y()-1,y(),y(),y()];d.emplaceBack(T[0],T[1],T[2],-1,-1,...S),d.emplaceBack(T[0],T[1],T[2],1,-1,...S),d.emplaceBack(T[0],T[1],T[2],1,1,...S),d.emplaceBack(T[0],T[1],T[2],-1,1,...S),p.emplaceBack(m+0,m+1,m+2),p.emplaceBack(m+0,m+2,m+3),m+=4}this.particlesVx=n.createVertexBuffer(d,ip.members),this.particlesIdx=n.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const n=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},c=t.transform.zoom;if(n.revealStart>c)return;const d=mo(0,1,n.revealStart,n.revealStart+n.revealRange,c);if(!this.particlesVx||!this.particlesIdx)return;const p=structuredClone(this._params);let m=[-p.direction.x,p.direction.y,-100];s.aw(m,m);const y=structuredClone(this._vignetteParams);y.strength*=d,p.overrideStyleParameters||(p.intensity=t.style.rain.state.density,p.timeFactor=t.style.rain.state.intensity,p.color=structuredClone(t.style.rain.state.color),m=structuredClone(t.style.rain.state.direction),p.screenThinning.intensity=t.style.rain.state.centerThinning,p.dropletSizeX=t.style.rain.state.dropletSize[0],p.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],p.distortionStrength=100*t.style.rain.state.distortionStrength,y.strength=1,y.color=structuredClone(t.style.rain.state.vignetteColor));const x=this.updateOnRender(t,p.timeFactor),T=t.context,S=T.gl,M=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new s.T(T,{width:t.width,height:t.height,data:null},S.RGBA8)),p.distortionStrength>0&&(T.activeTexture.set(S.TEXTURE0),this.screenTexture.bind(S.LINEAR,S.CLAMP_TO_EDGE),S.copyTexSubImage2D(S.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const E=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(T,E),T.activeTexture.set(S.TEXTURE0),this.screenTexture.bind(S.LINEAR,S.CLAMP_TO_EDGE);const C=[p.color.r,p.color.g,p.color.b,p.color.a],R=(z,N)=>{const k=ai(this._movement.getPosition(),z),U=p.dropletSizeX,$=p.dropletSizeX*p.dropletSizeYScale,G=t.width/2,ee=t.height/2,Z=mo(0,p.screenThinning.start,0,1,p.screenThinning.intensity),ie=mo(.001,p.screenThinning.range,0,1,p.screenThinning.intensity),Q=mo(0,p.screenThinning.particleOffset,0,1,p.screenThinning.intensity),Y=(re={modelview:x.modelviewMatrix,projection:x.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:k,velocityConeAperture:p.velocityConeAperture,velocity:p.velocity,boxSize:z,rainDropletSize:[U,$],distortionStrength:p.distortionStrength,rainDirection:m,color:C,screenSize:[M.width,M.height],thinningCenterPos:[G,ee],thinningShape:[Z,ie,Math.pow(10,p.screenThinning.fadePower)],thinningAffectedRatio:p.screenThinning.affectedRatio,thinningParticleOffset:Q,shapeDirectionalPower:p.shapeDirPower,shapeNormalPower:p.shapeNormalPower,mode:N?0:1},{u_modelview:Float32Array.from(re.modelview),u_projection:Float32Array.from(re.projection),u_time:re.time,u_cam_pos:re.camPos,u_texScreen:0,u_velocityConeAperture:re.velocityConeAperture,u_velocity:re.velocity,u_boxSize:re.boxSize,u_rainDropletSize:re.rainDropletSize,u_distortionStrength:re.distortionStrength,u_rainDirection:re.rainDirection,u_color:re.color,u_screenSize:re.screenSize,u_thinningCenterPos:re.thinningCenterPos,u_thinningShape:re.thinningShape,u_thinningAffectedRatio:re.thinningAffectedRatio,u_thinningParticleOffset:re.thinningParticleOffset,u_shapeDirectionalPower:re.shapeDirectionalPower,u_shapeNormalPower:re.shapeNormalPower,u_mode:re.mode});var re;const _e=Math.round(p.intensity*this.particlesCount),he=s.bf.simpleSegment(0,0,4*_e,2*_e);E.draw(t,S.TRIANGLES,xt.disabled,Gt.disabled,ti.alphaBlended,Bt.disabled,Y,"rain_particles",this.particlesVx,this.particlesIdx,he)};p.distortionStrength>0&&R(p.boxSize,!0),R(p.boxSize,!1),this._vignette.draw(t,y)}}const Vs=s.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class nd extends Pa{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Kn(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=rd(this.particlesCount),d=new s.eN,p=new s.b0;let m=0;const y=s.eq(1323123451230);for(let x=0;x<c.length;++x){const T=c[x],S=y(),M=y(),E=y(),C=[x/c.length,S,M,E],R=[y(),y()];d.emplaceBack(T[0],T[1],T[2],-1,-1,...C,...R),d.emplaceBack(T[0],T[1],T[2],1,-1,...C,...R),d.emplaceBack(T[0],T[1],T[2],1,1,...C,...R),d.emplaceBack(T[0],T[1],T[2],-1,1,...C,...R),p.emplaceBack(m+0,m+1,m+2),p.emplaceBack(m+0,m+2,m+3),m+=4}this.particlesVx=n.createVertexBuffer(d,Vs.members),this.particlesIdx=n.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const n=structuredClone(this._params);let c=[-n.direction.x,n.direction.y,-100];s.aw(c,c);const d=structuredClone(this._vignetteParams),p=n.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},m=t.transform.zoom;if(p.revealStart>m)return;const y=mo(0,1,p.revealStart,p.revealStart+p.revealRange,m);d.strength*=y,n.overrideStyleParameters||(n.intensity=t.style.snow.state.density,n.timeFactor=t.style.snow.state.intensity,n.color=structuredClone(t.style.snow.state.color),c=structuredClone(t.style.snow.state.direction),n.screenThinning.intensity=t.style.snow.state.centerThinning,n.billboardSize=2.79*t.style.snow.state.flakeSize,d.strength=1,d.color=structuredClone(t.style.snow.state.vignetteColor));const x=this.updateOnRender(t,n.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const T=t.context,S=T.gl,M=t.transform,E=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(T,E),((C,R,z)=>{const N=ai(this._movement.getPosition(),C),k=M.width/2,U=M.height/2,$=mo(0,z.screenThinning.start,0,1,z.screenThinning.intensity),G=mo(.001,z.screenThinning.range,0,1,z.screenThinning.intensity),ee=mo(0,z.screenThinning.particleOffset,0,1,z.screenThinning.intensity),Z=(ie={modelview:x.modelviewMatrix,projection:x.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:N,velocityConeAperture:z.velocityConeAperture,velocity:z.velocity,horizontalOscillationRadius:z.horizontalOscillationRadius,horizontalOscillationRate:z.horizontalOscillationRate,boxSize:C,billboardSize:1*z.billboardSize,simpleShapeParameters:[z.shapeFadeStart,z.shapeFadePower],screenSize:[M.width,M.height],thinningCenterPos:[k,U],thinningShape:[$,G,Math.pow(10,z.screenThinning.fadePower)],thinningAffectedRatio:z.screenThinning.affectedRatio,thinningParticleOffset:ee,color:[z.color.r,z.color.g,z.color.b,z.color.a],direction:c},{u_modelview:Float32Array.from(ie.modelview),u_projection:Float32Array.from(ie.projection),u_time:ie.time,u_cam_pos:ie.camPos,u_velocityConeAperture:ie.velocityConeAperture,u_velocity:ie.velocity,u_horizontalOscillationRadius:ie.horizontalOscillationRadius,u_horizontalOscillationRate:ie.horizontalOscillationRate,u_boxSize:ie.boxSize,u_billboardSize:ie.billboardSize,u_simpleShapeParameters:ie.simpleShapeParameters,u_screenSize:ie.screenSize,u_thinningCenterPos:ie.thinningCenterPos,u_thinningShape:ie.thinningShape,u_thinningAffectedRatio:ie.thinningAffectedRatio,u_thinningParticleOffset:ie.thinningParticleOffset,u_particleColor:ie.color,u_direction:ie.direction});var ie;const Q=Math.round(z.intensity*this.particlesCount),Y=s.bf.simpleSegment(0,0,4*Q,2*Q);this.particlesVx&&this.particlesIdx&&E.draw(t,S.TRIANGLES,xt.disabled,Gt.disabled,ti.alphaBlended,Bt.disabled,Z,"snow_particles",this.particlesVx,this.particlesIdx,Y)})(n.boxSize,0,n),this._vignette.draw(t,d)}}const od={symbol:function(l,t,n,c,d){if(l.renderPass!=="translucent")return;const p=Gt.disabled,m=l.colorModeForRenderPass(),y=n.layout.get("text-variable-anchor"),x=n.layout.get("text-size-scale-range"),T=s.aA(l.scaleFactor,x[0],x[1]);y&&(function(E,C,R,z,N,k,U,$){const G=C.transform,ee=N==="map",Z=k==="map";for(const ie of E){const Q=z.getTile(ie),Y=Q.getBucket(R);if(!Y||!Y.text||!Y.text.segments.get().length)continue;const re=s.bJ(Y.textSizeData,G.zoom,$),_e=zc(ie,Y.getProjection(),G),he=G.calculatePixelsToTileUnitsMatrix(Q),Ae=Va(_e,Q.tileID.canonical,Z,ee,G,Y.getProjection(),he),ve=Y.hasIconTextFit()&&Y.hasIconData();re&&fu(Y,ee,Z,U,G,Ae,ie,Math.pow(2,G.zoom-Q.tileID.overscaledZ),re,ve)}})(c,l,n,t,n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),d,T);const S=n.paint.get("icon-opacity").constantOr(1)!==0,M=n.paint.get("text-opacity").constantOr(1)!==0;n.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(S||M)?uc(l,t,n,c,p,m):(S&&uc(l,t,n,c,p,m,{onlyIcons:!0}),M&&uc(l,t,n,c,p,m,{onlyText:!0})),t.map.showCollisionBoxes&&(cc(l,t,n,c,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),!0),cc(l,t,n,c,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),!1))},circle:function(l,t,n,c){if(l.renderPass!=="translucent")return;const d=n.paint.get("circle-opacity"),p=n.paint.get("circle-stroke-width"),m=n.paint.get("circle-stroke-opacity"),y=n.layout.get("circle-sort-key").constantOr(1)!==void 0,x=n.paint.get("circle-emissive-strength");if(d.constantOr(1)===0&&(p.constantOr(1)===0||m.constantOr(1)===0))return;const T=l.context,S=T.gl,M=l.transform,E=!(!l.terrain||!l.terrain.enabled),C=n.layout.get("circle-elevation-reference"),R=l.depthModeForSublayer(0,xt.ReadOnly),z=new xt(l.context.gl.LEQUAL,xt.ReadOnly,l.depthRangeFor3D),N=C==="none"||E?R:z,k=Gt.disabled,U=l.colorModeForDrapableLayerRenderPass(x),$=M.projection.name==="globe",G=[s.aF(M.center.lng),s.aJ(M.center.lat)],ee=[];for(let ie=0;ie<c.length;ie++){const Q=c[ie],Y=t.getTile(Q),re=Y.getBucket(n);if(!re||re.projection.name!==M.projection.name)continue;const _e=re.programConfigurations.get(n.id),he=re.layoutVertexBuffer,Ae=re.globeExtVertexBuffer,ve=re.indexBuffer,ze=s.d$(n),Xe=[Ae],xe=l.isTileAffectedByFog(Q);$&&ze.push("PROJECTION_GLOBE_VIEW"),ze.push("DEPTH_D24"),l.terrain&&M.depthOcclusionForSymbolsAndCircles&&ze.push("DEPTH_OCCLUSION"),re.hasElevation&&!l.terrain&&(ze.push("ELEVATED_ROADS"),Xe.push(re.elevatedLayoutVertexBuffer));const ce=l.getOrCreateProgram("circle",{config:_e,defines:ze,overrideFog:xe}),Le=M.projection.createInversionMatrix(M,Q.canonical),be={programConfiguration:_e,program:ce,layoutVertexBuffer:he,dynamicBuffers:Xe,indexBuffer:ve,uniformValues:s.e0(l,Q,Y,Le,G,n),tile:Y};if(y){const Ve=re.segments.get();for(const Qe of Ve)ee.push({segments:new s.bf([Qe]),sortKey:Qe.sortKey,state:be})}else ee.push({segments:re.segments,sortKey:0,state:be})}y&&ee.sort(((ie,Q)=>ie.sortKey-Q.sortKey));const Z={useDepthForOcclusion:M.depthOcclusionForSymbolsAndCircles};for(const ie of ee){const{programConfiguration:Q,program:Y,layoutVertexBuffer:re,dynamicBuffers:_e,indexBuffer:he,uniformValues:Ae,tile:ve}=ie.state,ze=ie.segments;l.terrain&&l.terrain.setupElevationDraw(ve,Y,Z),l.uploadCommonUniforms(T,Y,ve.tileID.toUnwrapped()),Y.draw(l,S.TRIANGLES,N,k,U,Bt.disabled,Ae,n.id,re,he,ze,n.paint,M.zoom,Q,_e)}},heatmap:function(l,t,n,c){if(n.paint.get("heatmap-opacity")!==0)if(l.renderPass==="offscreen"){const d=l.context,p=d.gl,m=Gt.disabled,y=new ti([p.ONE,p.ONE,p.ONE,p.ONE],s.ao.transparent,[!0,!0,!0,!0]);(function(C,R,z,N){const k=C.gl,U=R.width*N,$=R.height*N;C.activeTexture.set(k.TEXTURE1),C.viewport.set([0,0,U,$]);let G=z.heatmapFbo;if(!G||G&&(G.width!==U||G.height!==$)){G&&G.destroy();const ee=k.createTexture();k.bindTexture(k.TEXTURE_2D,ee),k.texParameteri(k.TEXTURE_2D,k.TEXTURE_WRAP_S,k.CLAMP_TO_EDGE),k.texParameteri(k.TEXTURE_2D,k.TEXTURE_WRAP_T,k.CLAMP_TO_EDGE),k.texParameteri(k.TEXTURE_2D,k.TEXTURE_MIN_FILTER,k.LINEAR),k.texParameteri(k.TEXTURE_2D,k.TEXTURE_MAG_FILTER,k.LINEAR),G=z.heatmapFbo=C.createFramebuffer(U,$,!0,null),(function(Z,ie,Q,Y,re,_e){const he=Z.gl;he.texImage2D(he.TEXTURE_2D,0,Z.extRenderToTextureHalfFloat?he.RGBA16F:he.RGBA,re,_e,0,he.RGBA,Z.extRenderToTextureHalfFloat?he.HALF_FLOAT:he.UNSIGNED_BYTE,null),Y.colorAttachment.set(Q)})(C,0,ee,G,U,$)}else k.bindTexture(k.TEXTURE_2D,G.colorAttachment.get()),C.bindFramebuffer.set(G.framebuffer)})(d,l,n,l.transform.projection.name==="globe"?.5:.25),d.clear({color:s.ao.transparent});const x=l.transform,T=x.projection.name==="globe",S=T?["PROJECTION_GLOBE_VIEW"]:[],M=T?Bt.frontCCW:Bt.disabled,E=[s.aF(x.center.lng),s.aJ(x.center.lat)];for(let C=0;C<c.length;C++){const R=c[C];if(t.hasRenderableParent(R))continue;const z=t.getTile(R),N=z.getBucket(n);if(!N||N.projection.name!==x.projection.name)continue;const k=l.isTileAffectedByFog(R),U=N.programConfigurations.get(n.id),$=l.getOrCreateProgram("heatmap",{config:U,defines:S,overrideFog:k}),{zoom:G}=l.transform;l.terrain&&l.terrain.setupElevationDraw(z,$),l.uploadCommonUniforms(d,$,R.toUnwrapped());const ee=x.projection.createInversionMatrix(x,R.canonical);$.draw(l,p.TRIANGLES,xt.disabled,m,y,M,Gf(l,R,z,ee,E,G,n.paint.get("heatmap-intensity")),n.id,N.layoutVertexBuffer,N.indexBuffer,N.segments,n.paint,l.transform.zoom,U,T?[N.globeExtVertexBuffer]:null)}d.viewport.set([0,0,l.width,l.height])}else l.renderPass==="translucent"&&(l.context.setColorMode(l.colorModeForRenderPass()),(function(d,p){const m=d.context,y=m.gl,x=p.heatmapFbo;if(!x)return;m.activeTexture.set(y.TEXTURE0),y.bindTexture(y.TEXTURE_2D,x.colorAttachment.get()),m.activeTexture.set(y.TEXTURE1);let T=p.colorRampTexture;T||(T=p.colorRampTexture=new s.T(m,p.colorRamp,y.RGBA8)),T.bind(y.LINEAR,y.CLAMP_TO_EDGE),d.getOrCreateProgram("heatmapTexture").draw(d,y.TRIANGLES,xt.disabled,Gt.disabled,d.colorModeForRenderPass(),Bt.disabled,((S,M,E,C)=>({u_image:0,u_color_ramp:1,u_opacity:M.paint.get("heatmap-opacity")}))(0,p),p.id,d.viewportBuffer,d.quadTriangleIndexBuffer,d.viewportSegments,p.paint,d.transform.zoom)})(l,n))},line:function(l,t,n,c){if(l.renderPass!=="translucent")return;const d=n.paint.get("line-opacity"),p=n.paint.get("line-width");if(d.constantOr(1)===0||p.constantOr(1)===0)return;const m=n.paint.get("line-emissive-strength"),y=n.paint.get("line-occlusion-opacity"),x=n.layout.get("line-elevation-reference"),T=n.layout.get("line-width-unit")==="meters",S=x==="sea",M=!(!l.terrain||!l.terrain.enabled),E=l.context,C=E.gl;if(n.hasElevatedBuckets&&l.transform.projection.name==="globe")return;const R=n.layout.get("line-cross-slope"),z=R!==void 0,N=R<1,k=l.colorModeForDrapableLayerRenderPass(m),U=l.terrain&&l.terrain.renderingToTexture,$=U?1:s.o.devicePixelRatio,G=n.paint.get("line-dasharray"),ee=G.constantOr(1),Z=n.layout.get("line-cap"),ie=G.constantOr(null),Q=Z.constantOr(null),Y=n.paint.get("line-pattern"),re=Y.constantOr(1),_e=n.paint.get("line-pattern-cross-fade"),he=Y.constantOr(null),Ae=n.paint.get("line-opacity").constantOr(1);let ve=!re&&Ae!==1||l.depthOcclusion&&y>0&&y<1;const ze=n.paint.get("line-gradient"),Xe=re?"linePattern":"line",xe=s.e1(n);let ce;if(U&&l.terrain&&l.terrain.clipOrMaskOverlapStencilType()&&(ve=!1),y!==0&&l.depthOcclusion){const Qe=n.paint._values["line-opacity"];Qe&&Qe.value&&Qe.value.kind==="constant"?ce=Qe.value:s.w("Occlusion opacity for layer ".concat(n.id," is supported only when line-opacity isn't data-driven."))}p.value.kind!=="constant"&&p.value.isLineProgressConstant===!1&&xe.push("VARIABLE_LINE_WIDTH");const Le=(Qe,mt,$e,Ke,gt,ht)=>{for(const ct of Qe){const dt=t.getTile(ct);if(re&&!dt.patternsLoaded())continue;const Pt=dt.getBucket(n);if(!Pt||Pt.elevationType!=="none"&&!gt||Pt.elevationType==="none"&&gt)continue;l.prepareDrawTile();const li=[...mt],pi=l.shadowRenderer,Yi=Pt.elevationType==="road"&&!!pi&&pi.enabled;let Nt=[0,0,0];if(Yi){const Ut=l.style.directionalLight,gi=l.style.ambientLight;Ut&&gi&&(Nt=is(l.style,Ut,gi)),li.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const fi=Pt.programConfigurations.get(n.id);let Kt=!1;if(he&&dt.imageAtlas){const Ut=s.e2.from(he),gi=Ut.getPrimary().scaleSelf($).toString(),wr=dt.imageAtlas.patternPositions.get(gi),jr=Ut.getSecondary(),Mr=jr?dt.imageAtlas.patternPositions.get(jr.scaleSelf($).toString()):null;Kt=!!wr&&!!Mr,wr&&fi.setConstantPatternPositions(wr,Mr)}_e>0&&(Kt||fi.getPatternTransitionVertexBuffer("line-pattern"))&&li.push("LINE_PATTERN_TRANSITION");const qi=l.isTileAffectedByFog(ct),mi=l.getOrCreateProgram(Xe,{config:fi,defines:li,overrideFog:qi});if(!re&&ie&&Q&&dt.lineAtlas){const Ut=dt.lineAtlas.getDash(ie,Q);Ut&&fi.setConstantPatternPositions(Ut)}Yi&&pi.setupShadows(dt.tileID.toUnwrapped(),mi,"vector-tile");let[ir,Ii]=n.paint.get("line-trim-offset");(Q==="round"||Q==="square")&&ir!==Ii&&(ir===0&&(ir-=1),Ii===1&&(Ii+=1));const Qt=U?ct.projMatrix:null,ki=T?1/Pt.tileToMeter/s.ay(dt,1,l.transform.zoom):1,ri=T?1/Pt.tileToMeter/s.ay(dt,1,Math.floor(l.transform.zoom)):1,ur=re?s.e3(l,dt,n,Qt,$,ki,ri,[ir,Ii],Nt,_e):s.e4(l,dt,n,Qt,Pt.lineClipsArray.length,$,ki,ri,[ir,Ii],Nt);if(ze){const Ut=Pt.gradients[n.id];let gi=Ut.texture;if(n.gradientVersion!==Ut.version){let wr=256;if(n.stepInterpolant){const jr=t.getSource().maxzoom,Mr=ct.canonical.z===jr?Math.ceil(1<<l.transform.maxZoom-ct.canonical.z):1;wr=s.aA(s.e5(Pt.maxLineLength/s.al*1024*Mr),256,E.maxTextureSize)}Ut.gradient=s.e6({expression:n.gradientExpression(),evaluationKey:"lineProgress",resolution:wr,image:Ut.gradient||void 0,clips:Pt.lineClipsArray}),Ut.texture?Ut.texture.update(Ut.gradient):Ut.texture=new s.T(E,Ut.gradient,C.RGBA8),Ut.version=n.gradientVersion,gi=Ut.texture}E.activeTexture.set(C.TEXTURE1),gi.bind(n.stepInterpolant?C.NEAREST:C.LINEAR,C.CLAMP_TO_EDGE)}ee&&(E.activeTexture.set(C.TEXTURE0),dt.lineAtlasTexture&&dt.lineAtlasTexture.bind(C.LINEAR,C.REPEAT),fi.updatePaintBuffers()),re&&(E.activeTexture.set(C.TEXTURE0),dt.imageAtlasTexture&&dt.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),fi.updatePaintBuffers()),gt&&!S&&l.terrain.setupElevationDraw(dt,mi),l.uploadCommonUniforms(E,mi,ct.toUnwrapped());const Ni=Ut=>{ce!=null&&(ce.value=Ae*y),mi.draw(l,C.TRIANGLES,$e,Ut,k,Bt.disabled,ur,n.id,Pt.layoutVertexBuffer,Pt.indexBuffer,Pt.segments,n.paint,l.transform.zoom,fi,[Pt.layoutVertexBuffer2,Pt.patternVertexBuffer,Pt.zOffsetVertexBuffer]),ce!=null&&(ce.value=Ae)};if(ve&&!gt){const Ut=l.stencilModeForClipping(ct).ref;Ut===0&&U&&E.clear({stencil:0});const gi={func:C.EQUAL,mask:255};ur.u_alpha_discard_threshold=.8,Ni(new Gt(gi,Ut,255,C.KEEP,C.KEEP,C.INVERT)),ur.u_alpha_discard_threshold=0,Ni(new Gt(gi,Ut,255,C.KEEP,C.KEEP,C.KEEP))}else ur.u_alpha_discard_threshold=ve&&gt&&ht?.8:0,Ni(gt?Ke:l.stencilModeForClipping(ct))}};let be=l.depthModeForSublayer(0,xt.ReadOnly);const Ve=new xt(l.depthOcclusion?C.GREATER:C.LEQUAL,xt.ReadOnly,l.depthRangeFor3D);if(n.hasNonElevatedBuckets){const Qe=!U&&l.terrain;y!==0&&Qe?s.w("Occlusion opacity for layer ".concat(n.id," is supported on terrain only if the layer has line-z-offset enabled.")):Qe?s.w("Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ".concat(n.id,".")):Le(c,xe,be,Gt.disabled,!1,!0)}if(n.hasElevatedBuckets){x==="hd-road-markup"?M||(be=Ve,xe.push("ELEVATED_ROADS")):(xe.push("ELEVATED"),be=Ve,z&&xe.push(N?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),S&&xe.push("ELEVATION_REFERENCE_SEA"));const Qe=ve?l.stencilModeFor3D():Gt.disabled;l.forceTerrainMode=!0,Le(c,xe,be,Qe,!0,!0),ve&&Le(c,xe,be,Qe,!0,!1),l.forceTerrainMode=!1}ve&&(l.resetStencilClippingMasks(),U&&E.clear({stencil:0})),y===0||l.depthOcclusion||U||l.layersWithOcclusionOpacity.push(l.currentLayer)},fill:function(l,t,n,c){const d=n.paint.get("fill-color"),p=n.paint.get("fill-opacity");if(p.constantOr(1)===0)return;const m=n.paint.get("fill-emissive-strength"),y=l.colorModeForDrapableLayerRenderPass(m),x=n.paint.get("fill-pattern"),T=l.opaquePassEnabledForLayer()&&!x.constantOr(1)&&d.constantOr(s.ao.transparent).a===1&&p.constantOr(0)===1?"opaque":"translucent";let S="none";n.layout.get("fill-elevation-reference")!=="none"?S="road":n.paint.get("fill-z-offset").constantOr(1)!==0&&(S="offset");const M=!(!l.terrain||!l.terrain.enabled),E={painter:l,sourceCache:t,layer:n,coords:c,colorMode:y,elevationType:S,terrainEnabled:M,pass:T};if(l.renderPass!=="shadow")if(S!=="offset"){if(ol(E,!1),S==="road"){const C=!M&&l.renderPass==="translucent";C&&Aa(l,t,n,c,"geometry"),ol(E,!0,Gt.disabled),C&&(function(R){const{painter:z,sourceCache:N,layer:k,coords:U,colorMode:$}=R,G=z.context.gl,ee=R.painter.shadowRenderer,Z=!!ee&&ee.enabled,ie=new xt(z.context.gl.LEQUAL,xt.ReadOnly,z.depthRangeFor3D);let Q=[0,0,0];if(Z){const re=z.style.directionalLight,_e=z.style.ambientLight;re&&_e&&(Q=is(z.style,re,_e))}const Y=re=>{for(const _e of U){const he=N.getTile(_e),Ae=he.getBucket(k);if(!Ae)continue;const ve=Ae.elevatedStructures;if(!ve)continue;let ze,Xe;if(re?(ze=ve.renderableBridgeSegments,Xe=ve.bridgeProgramConfigurations.get(k.id)):(ze=ve.renderableTunnelSegments,Xe=ve.tunnelProgramConfigurations.get(k.id)),!ze||ze.segments[0].primitiveLength===0)continue;Xe.updatePaintBuffers(),z.prepareDrawTile();const xe=z.isTileAffectedByFog(_e),ce=[];Z&&ce.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const Le=z.getOrCreateProgram("elevatedStructures",{config:Xe,overrideFog:xe,defines:ce}),be=z.translatePosMatrix(_e.projMatrix,he,k.paint.get("fill-translate"),k.paint.get("fill-translate-anchor"));Z&&ee.setupShadows(he.tileID.toUnwrapped(),Le,"vector-tile");const Ve=km(be,Q);z.uploadCommonUniforms(z.context,Le,_e.toUnwrapped()),Le.draw(z,G.TRIANGLES,ie,Gt.disabled,$,Bt.backCCW,Ve,k.id,ve.vertexBuffer,ve.indexBuffer,ze,k.paint,z.transform.zoom,Xe,[ve.vertexBufferNormal])}};Y(!0),Y(!1)})(E)}}else ol(E,!1,l.stencilModeFor3D());else l.shadowRenderer&&S==="road"&&!M&&(function(C){const{painter:R,sourceCache:z,layer:N,coords:k}=C,U=R.context.gl,$=C.painter.shadowRenderer;for(const G of k){const ee=z.getTile(G),Z=ee.getBucket(N);if(!Z)continue;const ie=Z.elevatedStructures;if(!ie||!ie.shadowCasterSegments||ie.shadowCasterSegments.segments[0].primitiveLength===0)continue;R.prepareDrawTile();const Q=Z.bufferData.programConfigurations.get(N.id),Y=R.isTileAffectedByFog(G),re=R.getOrCreateProgram("elevatedStructuresDepth",{config:Q,overrideFog:Y}),_e=$.calculateShadowPassMatrixFromTile(ee.tileID.toUnwrapped());R.uploadCommonUniforms(R.context,re,G.toUnwrapped());const he={u_matrix:_e,u_depth_bias:0};re.draw(R,U.TRIANGLES,$.getShadowPassDepthMode(),Gt.disabled,$.getShadowPassColorMode(),Bt.disabled,he,N.id,ie.vertexBuffer,ie.indexBuffer,ie.shadowCasterSegments,N.paint,R.transform.zoom,Q)}})(E)},"fill-extrusion":function(l,t,n,c){const d=n.paint.get("fill-extrusion-opacity"),p=l.context,m=p.gl,y=l.terrain,x=y&&y.renderingToTexture;if(d===0)return;const T=l.conflationActive&&l.style.isLayerClipped(n,t.getSource()),S=l.style.order.indexOf(n.fqid);if(T&&(function(M,E,C,R,z){for(const N of R){const k=E.getTile(N).getBucket(C);k&&(k.updateReplacement(N,M.replacementSource,z),k.uploadCentroid(M.context))}})(l,t,n,c,S),y||T)for(const M of c){const E=t.getTile(M).getBucket(n);E&&ra(l.context,t,M,E,n,y,T)}if(l.renderPass==="shadow"&&l.shadowRenderer){const M=l.shadowRenderer;if(y&&d<.65&&n._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof s.ad)return;const E=M.getShadowPassDepthMode(),C=M.getShadowPassColorMode();pt(l,t,n,c,E,Gt.disabled,C,T)}else if(l.renderPass==="translucent"){const M=!n.paint.get("fill-extrusion-pattern").constantOr(1),E=n.paint.get("fill-extrusion-color").constantOr(s.ao.white);if(!x&&E.a!==0){const C=new xt(l.context.gl.LEQUAL,xt.ReadWrite,l.depthRangeFor3D);d===1&&M?pt(l,t,n,c,C,Gt.disabled,ti.unblended,T):(pt(l,t,n,c,C,Gt.disabled,ti.disabled,T),pt(l,t,n,c,C,l.stencilModeFor3D(),l.colorModeForRenderPass(),T),l.resetStencilClippingMasks())}if(l.style.enable3dLights()&&M&&(!y&&l.transform.projection.name!=="globe"||x)){const C=n.paint.get("fill-extrusion-opacity"),R=n.paint.get("fill-extrusion-ambient-occlusion-intensity"),z=n.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),N=n.paint.get("fill-extrusion-flood-light-intensity"),k=n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",U=n.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(k?null:n.lut).toArray01().slice(0,3),$=R>0&&z>0,G=N>0,ee=(Q,Y,re)=>(1-re)*Q+re*Y,Z=new Hh;Z.translate=n.paint.get("fill-extrusion-translate"),Z.translateAnchor=n.paint.get("fill-extrusion-translate-anchor"),Z.edgeRadius=n.layout.get("fill-extrusion-edge-radius"),Z.cutoffFadeRange=n.paint.get("fill-extrusion-cutoff-fade-range");const ie=Q=>{const Y=l.depthModeForSublayer(1,xt.ReadOnly,m.LEQUAL,!0),re=n.paint.get(Q?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),_e=ee(.1,3,re),he=l._showOverdrawInspector;if(!he){const Ae=new Gt({func:m.ALWAYS,mask:255},255,255,m.KEEP,m.KEEP,m.REPLACE),ve=new ti([m.ONE,m.ONE,m.ONE,m.ONE],s.ao.transparent,[!1,!1,!1,!0],m.MIN);Bs(Z,l,t,n,c,Y,Ae,ve,Bt.disabled,Q,"sdf",C,R,z,N,U,_e,T,!1)}{const Ae=he?Gt.disabled:new Gt({func:m.EQUAL,mask:255},255,255,m.KEEP,m.DECR,m.DECR),ve=he?l.colorModeForRenderPass():new ti([m.ONE_MINUS_DST_ALPHA,m.DST_ALPHA,m.ONE,m.ONE],s.ao.transparent,[!0,!0,!0,!0]);Bs(Z,l,t,n,c,Y,Ae,ve,Bt.disabled,Q,"color",C,R,z,N,U,_e,T,!1)}};if(x){const Q=(Y,re,_e)=>{const he=l.depthModeForSublayer(1,xt.ReadOnly,m.LEQUAL,!1),Ae=n.paint.get(Y?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ve=ee(.1,3,Ae);{const ze=new ti([m.ONE,m.ONE,m.ONE,m.ONE],s.ao.transparent,[!1,!1,!1,!0]);Bs(Z,l,t,n,c,he,Gt.disabled,ze,Bt.disabled,Y,"clear",C,R,z,N,U,ve,T,re)}{const ze=new Gt({func:m.ALWAYS,mask:255},255,255,m.KEEP,m.KEEP,m.REPLACE),Xe=new ti([m.ONE,m.ONE,m.ONE,m.ONE],s.ao.transparent,[!1,!1,!1,!0],m.MIN);Bs(Z,l,t,n,c,he,ze,Xe,Bt.disabled,Y,"sdf",C,R,z,N,U,ve,T,re)}{const ze=Y?m.ZERO:m.ONE_MINUS_DST_ALPHA,Xe=new Gt({func:m.EQUAL,mask:255},255,255,m.KEEP,m.DECR,m.DECR),xe=new ti([ze,m.DST_ALPHA,m.ONE_MINUS_DST_ALPHA,m.ZERO],s.ao.transparent,[!0,!0,!0,!0]);Bs(Z,l,t,n,c,he,Xe,xe,Bt.disabled,Y,"color",C,R,z,N,U,ve,T,re)}{const ze=new ti([m.ONE,m.ONE,m.ONE,Y?m.ZERO:m.ONE],s.ao.transparent,[!1,!1,!1,!0],Y?m.FUNC_ADD:m.MAX);Bs(Z,l,t,n,c,he,Gt.disabled,ze,Bt.disabled,Y,"clear",C,R,z,N,U,ve,T,re,_e)}};if($||G){let Y;if(l.prepareDrawTile(),y){const re=y.drapeBufferSize[0],_e=y.drapeBufferSize[1];Y=y.framebufferCopyTexture,Y&&(!Y||Y.size[0]===re&&Y.size[1]===_e)||(Y&&Y.destroy(),Y=y.framebufferCopyTexture=new s.T(p,new s.q({width:re,height:_e}),m.RGBA8)),Y.bind(m.LINEAR,m.CLAMP_TO_EDGE),m.copyTexSubImage2D(m.TEXTURE_2D,0,0,0,0,0,re,_e)}$&&Q(!0,!1,Y),G&&Q(!1,!0,Y)}}else $&&ie(!0),G&&ie(!1),($||G)&&l.resetStencilClippingMasks()}}},building:function(l,t,n,c){l.currentLayer<l.firstLightBeamLayer&&(l.firstLightBeamLayer=l.currentLayer);const d=n.paint.get("building-ambient-occlusion-ground-intensity"),p=n.paint.get("building-ambient-occlusion-ground-radius"),m=n.paint.get("building-ambient-occlusion-ground-attenuation"),y=n.paint.get("building-opacity");if(y<=0)return;let x=d>0&&p>0,T=!0;const S=n.paint.get("building-vertical-scale");if(S<=0)return;(!l.shadowRenderer||S<1)&&(T=!1);const M=l.conflationActive&&l.style.isLayerClipped(n,t.getSource()),E=l.style.order.indexOf(n.fqid);if((function(C,R,z,N,k,U){for(const $ of U){const G=R.getTile($).getBucket(z);G&&(k&&G.updateReplacement($,C.replacementSource,N),G.uploadUpdatedIndexBuffer(C.context))}})(l,t,n,E,M,c),(function(C,R,z,N){for(const k of N){const U=R.getTile(k).getBucket(z);U&&U.needsEvaluation()&&U.uploadUpdatedColorBuffer(C.context)}})(l,t,n,c),n.resetLayerRenderingStats(l),l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0),l.renderPass==="shadow"&&l.shadowRenderer){const C=l.shadowRenderer,R=[],z=C.getShadowPassDepthMode();mu({painter:l,source:t,layer:n,coords:c,defines:R,blendMode:C.getShadowPassColorMode(),depthMode:z,opacity:y,verticalScale:S,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}else if(l.renderPass==="translucent"){let C=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];T&&(C=C.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),l.shadowRenderer&&l.shadowRenderer.useNormalOffset&&(C=C.concat("NORMAL_OFFSET"));const R=n.paint.get("building-facade-emissive-chance"),z=n.paint.get("building-ambient-occlusion-intensity"),N=n.paint.get("building-flood-light-intensity"),k=n.paint.get("building-flood-light-color-use-theme").constantOr("default")==="none",U=n.paint.get("building-flood-light-color").toNonPremultipliedRenderColor(k?null:n.lut).toArray01().slice(0,3),$=n.paint.get("building-flood-light-ground-attenuation"),G=N>0,ee=new xt(l.context.gl.LEQUAL,xt.ReadWrite,l.depthRangeFor3D);y<1&&mu({painter:l,source:t,layer:n,coords:c,defines:C,blendMode:ti.disabled,depthMode:ee,opacity:y,verticalScale:S,facadeEmissiveChance:R,facadeAOIntensity:z,floodLightIntensity:N,floodLightColor:U,depthOnly:!0});const Z=l.colorModeForRenderPass();mu({painter:l,source:t,layer:n,coords:c,defines:C,blendMode:Z,depthMode:ee,opacity:y,verticalScale:S,facadeEmissiveChance:R,facadeAOIntensity:z,floodLightIntensity:N,floodLightColor:U}),x&&_u(l,t,n,c,!0,y,d,p,N,U,m,M),G&&_u(l,t,n,c,!1,y,d,p,N,U,$,M)}else if(l.renderPass==="light-beam"){const C=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],R=new xt(l.context.gl.LEQUAL,xt.ReadOnly,l.depthRangeFor3D);mu({painter:l,source:t,layer:n,coords:c,defines:C,blendMode:ti.alphaBlended,depthMode:R,opacity:y,verticalScale:S,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1),l.resetStencilClippingMasks()},hillshade:function(l,t,n,c){if(l.renderPass!=="offscreen"&&l.renderPass!=="translucent"||l.style.disableElevatedTerrain)return;const d=l.context,p=l.terrain&&l.terrain.renderingToTexture,[m,y]=l.renderPass!=="translucent"||p?[{},c]:l.stencilConfigForOverlap(c);for(const x of y){const T=t.getTile(x);if(T.needsHillshadePrepare&&l.renderPass==="offscreen")Im(l,T,n);else if(l.renderPass==="translucent"){const S=l.depthModeForSublayer(0,xt.ReadOnly),M=n.paint.get("hillshade-emissive-strength"),E=l.colorModeForDrapableLayerRenderPass(M),C=p&&l.terrain?l.terrain.stencilModeForRTTOverlap(x):m[x.overscaledZ];Em(l,x,T,n,S,C,E)}}d.viewport.set([0,0,l.width,l.height]),l.resetStencilClippingMasks()},raster:function(l,t,n,c,d,p){if(l.renderPass!=="translucent"||n.paint.get("raster-opacity")===0)return;const m=l.transform.projection.name==="globe",y=n.paint.get("raster-elevation")!==0,x=y&&m;if(l.renderElevatedRasterBackface&&!x)return;const T=l.context,S=T.gl,M=t.getSource(),E=(function(Z,ie,Q,Y){const re=ie.paint.get("raster-color"),_e=Z.type==="raster-array",he=[],Ae=ie.paint.get("raster-resampling"),ve=ie.paint.get("raster-color-mix");let ze=ie.paint.get("raster-color-range");const Xe=[ve[0],ve[1],ve[2],0],xe=ve[3];let ce=Ae==="nearest"?Y.NEAREST:Y.LINEAR;if(_e&&(he.push("RASTER_ARRAY"),re||he.push("RASTER_COLOR"),Ae==="linear"&&he.push("RASTER_ARRAY_LINEAR"),ce=Y.NEAREST,!ze&&Z.rasterLayers)){const Le=Z.rasterLayers.find((({id:be})=>be===ie.sourceLayer));Le&&Le.fields&&Le.fields.range&&(ze=Le.fields.range)}if(ze=ze||[0,1],re){he.push("RASTER_COLOR"),Q.activeTexture.set(Y.TEXTURE2),ie.updateColorRamp(ze);let Le=ie.colorRampTexture;Le||(Le=ie.colorRampTexture=new s.T(Q,ie.colorRamp,Y.RGBA8)),Le.bind(Y.LINEAR,Y.CLAMP_TO_EDGE)}return{mix:Xe,range:ze,offset:xe,defines:he,resampling:ce}})(M,n,T,S);if(M instanceof s.aT&&!c.length&&!m)return;const C=n.paint.get("raster-emissive-strength"),R=l.colorModeForDrapableLayerRenderPass(C),z=l.terrain&&l.terrain.renderingToTexture,N=!l.options.moving,k=n.paint.get("raster-resampling")==="nearest"?S.NEAREST:S.LINEAR;if(M instanceof s.aT&&!c.length&&(M.onNorthPole||M.onSouthPole)){const Z=y?l.stencilModeFor3D():Gt.disabled;return void Zh(!!M.onNorthPole,null,l,t,n,C,E,Bt.disabled,Z)}if(!c.length)return;const[U,$]=M instanceof s.aT||z?[{},c]:l.stencilConfigForOverlap(c),G=$[$.length-1].overscaledZ;x&&E.defines.push("PROJECTION_GLOBE_VIEW"),y&&E.defines.push("RENDER_CUTOFF");const ee=(Z,ie,Q)=>{for(const Y of Z){const re=Y.toUnwrapped(),_e=t.getTile(Y);if(z&&(!_e||!_e.hasData()))continue;T.activeTexture.set(S.TEXTURE0);const he=Vm(_e,M,n,E);if(!he||!he.texture)continue;const{texture:Ae,mix:ve,offset:ze,tileSize:Xe,buffer:xe}=he;let ce,Le;z?(ce=xt.disabled,Le=Y.projMatrix):y?(ce=new xt(S.LEQUAL,xt.ReadWrite,l.depthRangeFor3D),Le=m?Float32Array.from(l.transform.expandedFarZProjMatrix):l.transform.calculateProjMatrix(re,N)):(ce=l.depthModeForSublayer(Y.overscaledZ-G,n.paint.get("raster-opacity")===1?xt.ReadWrite:xt.ReadOnly,S.LESS),Le=l.transform.calculateProjMatrix(re,N));const be=l.terrain&&z?l.terrain.stencilModeForRTTOverlap(Y):U[Y.overscaledZ],Ve=p?0:n.paint.get("raster-fade-duration");_e.registerFadeDuration(Ve);const Qe=t.findLoadedParent(Y,0),mt=Qc(_e,Qe,t,l.transform,Ve);let $e,Ke;!mt.isFading&&_e.refreshedUponExpiration&&(_e.refreshedUponExpiration=!1),l.terrain&&l.terrain.prepareDrawTile(),T.activeTexture.set(S.TEXTURE0),Ae.bind(k,S.CLAMP_TO_EDGE),T.activeTexture.set(S.TEXTURE1),Qe?(Qe.texture&&Qe.texture.bind(k,S.CLAMP_TO_EDGE),$e=Math.pow(2,Qe.tileID.overscaledZ-_e.tileID.overscaledZ),Ke=[_e.tileID.canonical.x*$e%1,_e.tileID.canonical.y*$e%1]):Ae.bind(k,S.CLAMP_TO_EDGE),"useMipmap"in Ae&&T.extTextureFilterAnisotropic&&l.transform.pitch>20&&S.texParameterf(S.TEXTURE_2D,T.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,T.extTextureFilterAnisotropicMax);const gt=l.transform;let ht;const ct=y?Zf(gt):[0,0,0,0];let dt,Pt,li,pi,Yi,Nt=0;if(x&&M instanceof s.aT&&M.coordinates.length>3)dt=Float32Array.from(s.bj(s.dI(new s.cC(0,0,0)))),Pt=Float32Array.from(gt.globeMatrix),li=Float32Array.from(s.dE(gt)),pi=[s.aF(gt.center.lng),s.aJ(gt.center.lat)],ht=M.elevatedGlobePerspectiveTransform,Yi=M.elevatedGlobeGridMatrix||new Float32Array(9);else if(x){const mi=s.dF(Y.canonical);Nt=s.dG(mi.getCenter().lat),dt=Float32Array.from(s.bj(s.dI(Y.canonical))),Pt=Float32Array.from(gt.globeMatrix),li=Float32Array.from(s.dE(gt)),pi=[s.aF(gt.center.lng),s.aJ(gt.center.lat)],ht=[0,0],Yi=Float32Array.from(s.dH(Y.canonical,mi,Nt,gt.worldSize/gt._pixelsPerMercatorPixel))}else ht=M instanceof s.aT?M.perspectiveTransform:[0,0],dt=new Float32Array(16),Pt=new Float32Array(9),li=new Float32Array(16),pi=[0,0],Yi=new Float32Array(9);const fi=lc(Le,dt,Pt,li,Yi,Ke||[0,0],s.aj(l.transform.zoom),pi,ct,$e||1,mt,n,ht,y?n.paint.get("raster-elevation"):0,2,ve,ze,E.range,Xe,xe,C),Kt=l.isTileAffectedByFog(Y),qi=l.getOrCreateProgram("raster",{defines:E.defines,overrideFog:Kt});if(l.uploadCommonUniforms(T,qi,re),M instanceof s.aT){const mi=M.elevatedGlobeVertexBuffer,ir=M.elevatedGlobeIndexBuffer;if(z||!m)M.boundsBuffer&&M.boundsSegments&&qi.draw(l,S.TRIANGLES,ce,Gt.disabled,R,Bt.disabled,fi,n.id,M.boundsBuffer,l.quadTriangleIndexBuffer,M.boundsSegments);else if(mi&&ir){const Ii=gt.zoom<=s.cZ?M.elevatedGlobeSegments:M.getSegmentsForLongitude(gt.center.lng);Ii&&qi.draw(l,S.TRIANGLES,ce,Gt.disabled,R,ie,fi,n.id,mi,ir,Ii)}}else if(x){ce=new xt(S.LEQUAL,xt.ReadOnly,l.depthRangeFor3D);const mi=l.globeSharedBuffers;if(mi){const[ir,Ii,Qt]=mi.getGridBuffers(Nt,!1);qi.draw(l,S.TRIANGLES,ce,Q||be,l.colorModeForRenderPass(),ie,fi,n.id,ir,Ii,Qt)}}else{const{tileBoundsBuffer:mi,tileBoundsIndexBuffer:ir,tileBoundsSegments:Ii}=l.getTileBoundsBuffers(_e);qi.draw(l,S.TRIANGLES,ce,be,R,Bt.disabled,fi,n.id,mi,ir,Ii)}}if(!(M instanceof s.aT)&&x)for(const Y of Z){const re=Y.canonical.y===(1<<Y.canonical.z)-1;Y.canonical.y===0&&Zh(!0,Y,l,t,n,C,E,ie,Q||Gt.disabled),re&&Zh(!1,Y,l,t,n,C,E,ie===Bt.frontCW?Bt.backCW:Bt.frontCW,Q||Gt.disabled)}};x?ee($,l.renderElevatedRasterBackface?Bt.backCW:Bt.frontCW,l.stencilModeFor3D()):ee($,Bt.disabled,void 0),l.resetStencilClippingMasks()},"raster-particle":function(l,t,n,c,d,p){l.renderPass==="offscreen"&&(function(m,y,x,T){if(!T.length)return;const S=m.context,M=S.gl,E=y.getSource();if(!(E instanceof mn))return;const C=Math.ceil(Math.sqrt(x.paint.get("raster-particle-count")));let R=x.particlePositionRGBAImage;if(!R||R.width!==C){const $=(function(G){const ee=G*G,Z=new Uint8Array(4*ee),ie=function(Y){return Y|=0,Y=Math.imul(2747636419^Y,2654435769),Y=Math.imul(Y^Y>>>16,2654435769),((Y=Math.imul(Y^Y>>>16,2654435769))>>>0)/4294967296},Q=1/1.1;for(let Y=0;Y<ee;Y++){const re=Q*(ie(2*Y+0)+Ia),_e=Q*(ie(2*Y+1)+Ia),he=255*re%1,Ae=255*_e%1,ve=he,ze=_e-Ae/255,Xe=Ae;Z[4*Y+0]=255*(re-he/255),Z[4*Y+1]=255*ve,Z[4*Y+2]=255*ze,Z[4*Y+3]=255*Xe}return Z})(C);R=x.particlePositionRGBAImage=new s.q({width:C,height:C},$)}let z=x.particleFramebuffer;z?z.width!==C&&(z.destroy(),z=x.particleFramebuffer=S.createFramebuffer(C,C,!0,null)):z=x.particleFramebuffer=S.createFramebuffer(C,C,!0,null);const N=[];for(const $ of T){const G=y.getTile($);if(!(G instanceof Ys))continue;const ee=Wh(G,E,x);if(!ee)continue;const Z=[G.tileSize,G.tileSize];let ie=x.tileFramebuffer;ie||(ie=x.tileFramebuffer=S.createFramebuffer(Z[0],Z[1],!0,null));let Q=G.rasterParticleState;Q||(Q=G.rasterParticleState=new Eo(S,$,Z,R));const Y=Q.update(x.lastInvalidatedAt);Q.particleTextureDimension!==C&&Q.updateParticleTexture($,R);const re=Q.targetColorTexture;Q.targetColorTexture=Q.backgroundColorTexture,Q.backgroundColorTexture=re;const _e=Q.particleTexture0;Q.particleTexture0=Q.particleTexture1,Q.particleTexture1=_e,N.push([$,ee,Q,Y])}if(N.length===0)return;const k=s.o.now(),U=x.previousDrawTimestamp?.001*(k-x.previousDrawTimestamp):.0167;if(x.previousDrawTimestamp=k,x.hasColorMap()){S.activeTexture.set(M.TEXTURE0+2);let $=x.colorRampTexture;$||($=x.colorRampTexture=new s.T(S,x.colorRamp,M.RGBA8)),$.bind(M.LINEAR,M.CLAMP_TO_EDGE)}S.bindFramebuffer.set(x.tileFramebuffer.framebuffer),(function($,G,ee){const Z=$.context,ie=Z.gl,Q=G.tileFramebuffer;Z.activeTexture.set(ie.TEXTURE0);const Y={u_texture:0,u_opacity:1.05*(_e=G.paint.get("raster-particle-fade-opacity-factor"))/(_e+.05)},re=$.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var _e;for(const he of ee){const[,,Ae,ve]=he;Q.colorAttachment.set(Ae.targetColorTexture.texture),Z.viewport.set([0,0,Q.width,Q.height]),Z.clear({color:s.ao.transparent}),ve&&(Ae.backgroundColorTexture.bind(ie.NEAREST,ie.CLAMP_TO_EDGE),re.draw($,ie.TRIANGLES,xt.disabled,Gt.disabled,ti.alphaBlended,Bt.disabled,Y,G.id,$.viewportBuffer,$.quadTriangleIndexBuffer,$.viewportSegments))}})(m,x,N),(function($,G,ee,Z){const ie=$.context,Q=ie.gl,Y=ee.tileFramebuffer,re=$.transform.projection.name==="globe",_e=ee.paint.get("raster-particle-max-speed");for(const he of Z){const[Ae,ve,ze]=he;ie.activeTexture.set(Q.TEXTURE0+0),ve.texture.bind(Q.LINEAR,Q.CLAMP_TO_EDGE),Y.colorAttachment.set(ze.targetColorTexture.texture);const Xe=$.getOrCreateProgram("rasterParticleDraw",{defines:ve.defines,overrideFog:!1});ie.activeTexture.set(Q.TEXTURE0+1);const xe=ve.scalarData?[]:[0,1,2,3].map((be=>s.e8[be](Ae)));xe.push(Ae);const ce=Ae.canonical.x,Le=Ae.canonical.y;for(const be of xe){const Ve=G.getTile(re?be.wrapped():be);if(!Ve)continue;const Qe=Ve.rasterParticleState;if(!Qe)continue;const mt=be.canonical.x+(1<<be.canonical.z)*(be.wrap-Ae.wrap),$e=be.canonical.y;Qe.particleTexture0.bind(Q.NEAREST,Q.CLAMP_TO_EDGE);const Ke=Nh(1,Qe.particleTexture0.size[0],[mt-ce,$e-Le],0,ve.texture.size,2,_e,ve.textureOffset,ve.scale,ve.offset);Xe.draw($,Q.POINTS,xt.disabled,Gt.disabled,ti.alphaBlended,Bt.disabled,Ke,ee.id,Qe.particleIndexBuffer,void 0,Qe.particleSegment)}}})(m,y,x,N),S.bindFramebuffer.set(x.particleFramebuffer.framebuffer),(function($,G,ee,Z){const ie=$.context,Q=ie.gl,Y=G.paint.get("raster-particle-max-speed"),re=Z*G.paint.get("raster-particle-speed-factor")*.15,_e=(function(Ae){return Math.pow(Ae,6)})(.01+1*G.paint.get("raster-particle-reset-rate-factor")),he=G.particleFramebuffer;ie.viewport.set([0,0,he.width,he.height]);for(const Ae of ee){const[,ve,ze]=Ae;ie.activeTexture.set(Q.TEXTURE0+0),ve.texture.bind(Q.LINEAR,Q.CLAMP_TO_EDGE),ie.activeTexture.set(Q.TEXTURE0+1);const Xe=ze.particleTexture0;Xe.bind(Q.NEAREST,Q.CLAMP_TO_EDGE);const xe=su(1,Xe.size[0],0,ve.texture.size,Y,re,_e,ve.textureOffset,ve.scale,ve.offset);he.colorAttachment.set(ze.particleTexture1.texture),ie.clear({color:s.ao.transparent}),$.getOrCreateProgram("rasterParticleUpdate",{defines:ve.defines}).draw($,Q.TRIANGLES,xt.disabled,Gt.disabled,ti.unblended,Bt.disabled,xe,G.id,$.viewportBuffer,$.quadTriangleIndexBuffer,$.viewportSegments)}})(m,x,N,U)})(l,t,n,c),l.renderPass==="translucent"&&((function(m,y,x,T,S){const M=m.context,E=M.gl,C=y.getSource().tileSize,R=5*(1-s.ah(s.cK,s.cK+1,m.transform.zoom))*C+x.paint.get("raster-particle-elevation"),z=!m.options.moving,N=m.transform.projection.name==="globe";if(!T.length)return;const[k,U]=m.stencilConfigForOverlap(T),$=[];N&&$.push("PROJECTION_GLOBE_VIEW");const G=m.stencilModeFor3D();for(const ee of U){const Z=ee.toUnwrapped(),ie=y.getTile(ee);if(!ie.rasterParticleState)continue;const Q=ie.rasterParticleState,Y=100;ie.registerFadeDuration(Y);const re=y.findLoadedParent(ee,0),_e=Qc(ie,re,y,m.transform,Y);let he,Ae;m.terrain&&m.terrain.prepareDrawTile(),M.activeTexture.set(E.TEXTURE0),Q.targetColorTexture.bind(E.LINEAR,E.CLAMP_TO_EDGE),M.activeTexture.set(E.TEXTURE1),re&&re.rasterParticleState?(re.rasterParticleState.targetColorTexture.bind(E.LINEAR,E.CLAMP_TO_EDGE),he=Math.pow(2,re.tileID.overscaledZ-ie.tileID.overscaledZ),Ae=[ie.tileID.canonical.x*he%1,ie.tileID.canonical.y*he%1]):Q.targetColorTexture.bind(E.LINEAR,E.CLAMP_TO_EDGE);const ve=N?Float32Array.from(m.transform.expandedFarZProjMatrix):m.transform.calculateProjMatrix(Z,z),ze=m.transform,Xe=no(ze),xe=s.dF(ee.canonical),ce=s.dG(xe.getCenter().lat);let Le,be,Ve,Qe,mt;N?(Le=Float32Array.from(s.bj(s.dI(ee.canonical))),be=Float32Array.from(ze.globeMatrix),Ve=Float32Array.from(s.dE(ze)),Qe=[s.aF(ze.center.lng),s.aJ(ze.center.lat)],mt=Float32Array.from(s.dH(ee.canonical,xe,ce,ze.worldSize/ze._pixelsPerMercatorPixel))):(Le=new Float32Array(16),be=new Float32Array(9),Ve=new Float32Array(16),Qe=[0,0],mt=new Float32Array(9));const $e=ea(ve,Le,be,Ve,mt,Ae||[0,0],s.aj(m.transform.zoom),Qe,Xe,he||1,_e,R),Ke=m.isTileAffectedByFog(ee),gt=m.getOrCreateProgram("rasterParticle",{defines:$,overrideFog:Ke});if(m.uploadCommonUniforms(M,gt,Z),N){const ht=new xt(E.LEQUAL,xt.ReadOnly,m.depthRangeFor3D),ct=0,dt=m.globeSharedBuffers;if(dt){const[Pt,li,pi]=dt.getGridBuffers(ce,ct!==0);gt.draw(m,E.TRIANGLES,ht,G,ti.alphaBlended,m.renderElevatedRasterBackface?Bt.frontCCW:Bt.backCCW,$e,x.id,Pt,li,pi)}}else{const ht=m.depthModeForSublayer(0,xt.ReadOnly),ct=k[ee.overscaledZ],{tileBoundsBuffer:dt,tileBoundsIndexBuffer:Pt,tileBoundsSegments:li}=m.getTileBoundsBuffers(ie);gt.draw(m,E.TRIANGLES,ht,ct,ti.alphaBlended,Bt.disabled,$e,x.id,dt,Pt,li)}}m.resetStencilClippingMasks()})(l,t,n,c),l.style.map.triggerRepaint())},background:function(l,t,n,c){const d=n.paint.get("background-color"),p=n.paint.get("background-color-use-theme").constantOr("default")==="none",m=n.paint.get("background-opacity"),y=n.paint.get("background-emissive-strength"),x=n.paint.get("background-pitch-alignment")==="viewport";if(m===0)return;const T=l.context,S=T.gl,M=l.transform,E=M.tileSize,C=n.paint.get("background-pattern");let R;if(C!==void 0&&(C===null||(R=l.imageManager.getPattern(s.I.from(C.toString()),n.scope,l.style.getLut(n.scope)),!R)))return;const z=!C&&d.a===1&&m===1&&l.opaquePassEnabledForLayer()?"opaque":"translucent";if(l.renderPass!==z)return;const N=Gt.disabled,k=l.depthModeForSublayer(0,z==="opaque"?xt.ReadWrite:xt.ReadOnly),U=l.colorModeForDrapableLayerRenderPass(y),$=C?"backgroundPattern":"background";let G,ee=c;if(ee||(G=l.getBackgroundTiles(),ee=Object.values(G).map((Z=>Z.tileID))),C&&(T.activeTexture.set(S.TEXTURE0),l.imageManager.bind(l.context,n.scope)),x){const Z=l.getOrCreateProgram($,{overrideFog:!1,overrideRtt:!0}),ie=new Float32Array(s.bz([])),Q=new s.aP(0,0,0,0,0),Y=C?lu(ie,y,m,l,0,n.scope,R,x,{tileID:Q,tileSize:E}):au(ie,y,m,d.toPremultipliedRenderColor(p?null:n.lut));Z.draw(l,S.TRIANGLES,k,N,U,Bt.disabled,Y,n.id,l.viewportBuffer,l.quadTriangleIndexBuffer,l.viewportSegments)}else for(const Z of ee){const ie=l.isTileAffectedByFog(Z),Q=l.getOrCreateProgram($,{overrideFog:ie}),Y=Z.toUnwrapped(),re=c?Z.projMatrix:l.transform.calculateProjMatrix(Y);l.prepareDrawTile();const _e=t?t.getTile(Z):G?G[Z.key]:new bs(Z,E,M.zoom,l),he=C?lu(re,y,m,l,0,n.scope,R,x,{tileID:Z,tileSize:E}):au(re,y,m,d.toPremultipliedRenderColor(p?null:n.lut));l.uploadCommonUniforms(T,Q,Y);const{tileBoundsBuffer:Ae,tileBoundsIndexBuffer:ve,tileBoundsSegments:ze}=l.getTileBoundsBuffers(_e);Q.draw(l,S.TRIANGLES,k,N,U,Bt.disabled,he,n.id,Ae,ve,ze)}},sky:function(l,t,n){const c=l._atmosphere?s.aj(l.transform.zoom):1,d=n.paint.get("sky-opacity")*c;if(d===0)return;const p=l.context,m=n.paint.get("sky-type"),y=new xt(p.gl.LEQUAL,xt.ReadOnly,[0,1]),x=l.frameCounter/1e3%1;m==="atmosphere"?l.renderPass==="offscreen"?n.needsSkyboxCapture(l)&&((function(T,S,M,E){const C=T.context,R=C.gl;let z=S.skyboxFbo;if(!z){z=S.skyboxFbo=C.createFramebuffer(32,32,!0,null),S.skyboxGeometry=new Qh(C),S.skyboxTexture=C.gl.createTexture(),R.bindTexture(R.TEXTURE_CUBE_MAP,S.skyboxTexture),R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_WRAP_S,R.CLAMP_TO_EDGE),R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_WRAP_T,R.CLAMP_TO_EDGE),R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_MIN_FILTER,R.LINEAR),R.texParameteri(R.TEXTURE_CUBE_MAP,R.TEXTURE_MAG_FILTER,R.LINEAR);for(let $=0;$<6;++$)R.texImage2D(R.TEXTURE_CUBE_MAP_POSITIVE_X+$,0,R.RGBA,32,32,0,R.RGBA,R.UNSIGNED_BYTE,null)}C.bindFramebuffer.set(z.framebuffer),C.viewport.set([0,0,32,32]);const N=S.getCenter(T,!0),k=T.getOrCreateProgram("skyboxCapture"),U=new Float64Array(16);s.bz(U),s.em(U,U,.5*-Math.PI),os(T,S,k,U,N,0),s.bz(U),s.em(U,U,.5*Math.PI),os(T,S,k,U,N,1),s.bz(U),s.cT(U,U,.5*-Math.PI),os(T,S,k,U,N,2),s.bz(U),s.cT(U,U,.5*Math.PI),os(T,S,k,U,N,3),s.bz(U),os(T,S,k,U,N,4),s.bz(U),s.em(U,U,Math.PI),os(T,S,k,U,N,5),C.viewport.set([0,0,T.width,T.height])})(l,n),n.markSkyboxValid(l)):l.renderPass==="sky"&&(function(T,S,M,E,C){const R=T.context,z=R.gl,N=T.transform,k=T.getOrCreateProgram("skybox");R.activeTexture.set(z.TEXTURE0),z.bindTexture(z.TEXTURE_CUBE_MAP,S.skyboxTexture);const U=(($,G,ee,Z,ie)=>({u_matrix:$,u_sun_direction:G,u_cubemap:0,u_opacity:Z,u_temporal_offset:ie}))(N.skyboxMatrix,S.getCenter(T,!1),0,E,C);T.uploadCommonUniforms(R,k),k.draw(T,z.TRIANGLES,M,Gt.disabled,T.colorModeForRenderPass(),Bt.backCW,U,"skybox",S.skyboxGeometry.vertexBuffer,S.skyboxGeometry.indexBuffer,S.skyboxGeometry.segment)})(l,n,y,d,x):m==="gradient"&&l.renderPass==="sky"&&(function(T,S,M,E,C){const R=T.context,z=R.gl,N=T.transform,k=T.getOrCreateProgram("skyboxGradient");S.skyboxGeometry||(S.skyboxGeometry=new Qh(R)),R.activeTexture.set(z.TEXTURE0);let U=S.colorRampTexture;U||(U=S.colorRampTexture=new s.T(R,S.colorRamp,z.RGBA8)),U.bind(z.LINEAR,z.CLAMP_TO_EDGE);const $=((G,ee,Z,ie,Q)=>({u_matrix:G,u_color_ramp:0,u_center_direction:ee,u_radius:s.an(Z),u_opacity:ie,u_temporal_offset:Q}))(N.skyboxMatrix,S.getCenter(T,!1),S.paint.get("sky-gradient-radius"),E,C);T.uploadCommonUniforms(R,k),k.draw(T,z.TRIANGLES,M,Gt.disabled,T.colorModeForRenderPass(),Bt.backCW,$,"skyboxGradient",S.skyboxGeometry.vertexBuffer,S.skyboxGeometry.indexBuffer,S.skyboxGeometry.segment)})(l,n,y,d,x)},custom:function(l,t,n,c){const d=l.context,p=n.implementation;if(!l.transform.projection.unsupportedLayers||!l.transform.projection.unsupportedLayers.includes("custom")||l.terrain&&(l.terrain.renderingToTexture||l.renderPass==="offscreen")&&n.isDraped(t)){if(l.renderPass==="offscreen"){const m=p.prerender;if(m){if(l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),l.transform.projection.name==="globe"){const y=l.transform.pointMerc;m.call(p,d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),s.aj(l.transform.zoom),[y.x,y.y],l.transform.pixelsPerMeterRatio)}else m.call(p,d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState()}}else if(l.renderPass==="translucent"){if(l.terrain&&l.terrain.renderingToTexture){const y=p.renderToTile;if(y){const x=c[0].canonical,T={x:x.x+c[0].wrap*(p.wrapTileId?0:1<<x.z),y:x.y,z:x.z};d.setDepthMode(xt.disabled),d.setStencilMode(Gt.disabled),d.setColorMode(l.colorModeForRenderPass()),l.setCustomLayerDefaults(),y.call(p,d.gl,T),d.setDirty(),l.setBaseState()}return}l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),d.setStencilMode(Gt.disabled);const m=p.renderingMode==="3d"?new xt(l.context.gl.LEQUAL,xt.ReadWrite,l.depthRangeFor3D):l.depthModeForSublayer(0,xt.ReadOnly);if(d.setDepthMode(m),l.transform.projection.name==="globe"){const y=l.transform.pointMerc;p.render(d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),s.aj(l.transform.zoom),[y.x,y.y],l.transform.pixelsPerMeterRatio)}else p.render(d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState(),d.bindFramebuffer.set(null)}}else s.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(l,t,n,c){if(l.renderPass==="opaque")return;const d=n.paint.get("model-opacity").constantOr(1),p=n.paint.get("model-elevation-reference"),m=p==="ground",y=p==="ground";if(d===0)return;const x=n.paint.get("model-cast-shadows");if(l.renderPass==="shadow"&&(!x||l.terrain&&d<.65&&n._transitionablePaint._values["model-opacity"].value.expression instanceof s.ad))return;const T=l.shadowRenderer,S=n.paint.get("model-receive-shadows");T&&(T.useNormalOffset=!0,S||(T.enabled=!1));const M=()=>{T&&(T.useNormalOffset=!0,S||(T.enabled=!0))},E=t.getSource();if(l.renderPass==="light-beam"&&E.type!=="batched-model")return;if(E.type==="vector"||E.type==="geojson")return(function(G,ee,Z,ie,Q){const Y=G.transform,re=Y.projection.name==="globe",_e=Y.getFreeCameraOptions().position;if(!G.modelManager)return;const he=G.modelManager;Z.modelManager=he;const Ae=G.shadowRenderer;if(!Z._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const ve=Z._unevaluatedLayout._values["model-id"],ze=Object.assign({},Z.layout.get("model-id").parameters),Xe=G.style.order.indexOf(Z.fqid);for(const xe of ie){const ce=ee.getTile(xe).getBucket(Z);if(!ce||ce.projection.name!==Y.projection.name)continue;const Le=ce.getModelUris();if(Le&&!ce.modelsRequested&&(he.addModelsFromBucket(Le,Q),ce.modelsRequested=!0),re)ze.zoom=xe.overscaledZ;else{const ht=td(xe,Y);ze.zoom=ht}const be=ve.possiblyEvaluate(ze);if(Jf(G,ce,xe),Oo.shadowUniformsInitialized=!1,Oo.useSingleShadowCascade=!!Ae&&Ae.getMaxCascadeForTile(xe.toUnwrapped())===0,G.renderPass==="shadow"&&Ae){if(G.currentShadowCascade===1&&ce.isInsideFirstShadowMapFrustum)continue;const ht=Y.calculatePosMatrix(xe.toUnwrapped(),Y.worldSize);if(Oo.tileMatrix.set(ht),Oo.shadowTileMatrix=Float32Array.from(Ae.calculateShadowPassMatrixFromMatrix(ht)),Oo.aabb.min=[0,0,0],Oo.aabb.max[0]=Oo.aabb.max[1]=s.al,Oo.aabb.max[2]=0,xu(ce,Oo,G,Z.scope))continue}const Ve=1<<xe.canonical.z,Qe=[((_e.x-xe.wrap)*Ve-xe.canonical.x)*s.al,(_e.y*Ve-xe.canonical.y)*s.al,_e.z*Ve*s.al];G.conflationActive&&Object.keys(ce.instancesPerModel).length>0&&G.style.isLayerClipped(Z,ee.getSource())&&ce.updateReplacement(xe,G.replacementSource,Xe,Q)&&(ce.uploaded=!1,ce.upload(G.context));let mt=0;const $e=new Array,Ke=new Array,gt=new Array;for(let ht in ce.instancesPerModel){const ct=ce.instancesPerModel[ht];ct.features.length>0&&!re&&(ht=be.evaluate(ct.features[0].feature,{}));const dt=he.getModel(ht,Q);if(dt||he.hasURLBeenRequested(ht)||ce.modelUris.includes(ht)||(ce.modelUris.push(ht),ce.modelsRequested=!1),dt&&dt.uploaded)if(re){const Pt=s.c4([],[_e.x,_e.y,_e.z],G.transform.worldSize);s.ev(Pt,Pt);for(let li=0;li<ct.instancedDataArray.length;++li){const pi=[0,0,0],Yi=[1,1,1],Nt=s.ew(),fi=ct.tileCoordinatesForInstance(li),Kt=ct.transformForInstance(li);s.ex(Yi,Kt),s.ey(Nt,Kt),s.ez(pi,Nt);const qi=ct.translationForInstance(li),mi=new s.aS(0,0);s.eA(ce.canonical,mi,fi.x,fi.y);const ir=s.bB();s.eB(ir,dt,G.transform,mi,pi,Yi,qi,!0,!1,!1);const Ii=ct.colorForInstance(li),Qt=s.bz([]),ki=s.ee(mi.lat,G.transform.zoom),ri=s.bp([],[1,1,1/ki]);s.bq(Qt,Qt,Pt),gt.push({zScaleMatrix:ri,negCameraPosMatrix:Qt});for(const ur of dt.nodes)yu(G,ur,ir,G.transform.expandedFarZProjMatrix,mt,$e,Ke,dt.materialOverrides,Ii);++mt}}else for(const Pt of dt.nodes)id(G,Z,Pt,ct,Qe,xe,Oo)}if(re)if(G.renderPass==="shadow"){for(const ht of Ke)ul(ht.mesh,ht.nodeModelMatrix,G,Z);for(const ht of $e)ul(ht.mesh,ht.nodeModelMatrix,G,Z)}else Kf(G,Z,1,$e,Ke,gt)}})(l,t,n,c,gu(E,n,l.style._importedAsBasemap)),void M();if(!E.loaded())return;if(E.type==="batched-model")return(function(G,ee,Z,ie){Z.resetLayerRenderingStats(G);const Q=G.context,Y=G.transform,re=G.style.fog,_e=G.shadowRenderer;if(Y.projection.name!=="mercator")return void s.w("Drawing 3D landmark models for ".concat(Y.projection.name," projection is not yet implemented"));const he=G.transform.getFreeCameraOptions().position,Ae=s.c4([],[he.x,he.y,he.z],G.transform.worldSize),ve=s.ev([],Ae),ze=s.bz([]),Xe=s.ee(Y.center.lat,Y.zoom),xe=s.bp([],[1,1,1/Xe]);s.bq(ze,ze,ve);const ce=Z.paint.get("model-opacity").constantOr(1),Le=new xt(Q.gl.LEQUAL,xt.ReadWrite,G.depthRangeFor3D),be=new xt(Q.gl.LEQUAL,xt.ReadOnly,G.depthRangeFor3D),Ve=new s.d8([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Qe=G.renderPass==="shadow",mt=Qe&&_e?_e.getCurrentCascadeFrustum():Y.getFrustum(Y.scaleZoom(Y.worldSize)),$e=Z.paint.get("model-front-cutoff"),Ke=$e[2]<1,gt=Fs(G,Z.paint.get("model-cutoff-fade-range")),ht=Z.getLayerRenderingStats();(function(ct,dt,Pt,li){const pi=ct.terrain?ct.terrain.exaggeration():0,Yi=ct.transform.zoom;for(const Nt of li){const fi=dt.getTile(Nt).getBucket(Pt);fi&&(fi.setFilter(Pt.filter),ct.conflationActive&&fi.updateReplacement(Nt,ct.replacementSource),fi.evaluateTransform(ct,Pt),ct.terrain&&pi>0&&fi.elevationUpdate(ct.terrain,pi,Nt,Pt.source),fi.needsReEvaluation(ct,Yi,Pt)&&fi.evaluate(Pt))}})(G,ee,Z,ie),(function(){let ct,dt,Pt;Ke?(ct=ie.length-1,dt=-1,Pt=-1):(ct=0,dt=ie.length,Pt=1);const li=new Float64Array(16),pi=s.cz(),Yi=new s.P(0,0);for(let Nt=ct;Nt!==dt;Nt+=Pt){const fi=ie[Nt],Kt=ee.getTile(fi).getBucket(Z);if(!Kt||!Kt.uploaded)continue;let qi=!1;_e&&(qi=_e.getMaxCascadeForTile(fi.toUnwrapped())===0);const mi=Y.calculatePosMatrix(fi.toUnwrapped(),Y.worldSize),ir=Kt.modelTraits;!Qe&&Ke&&(s.bk(li,mi),s.af(pi,Ae,li),Yi.x=pi[0],Yi.y=pi[1]);const Ii=[];Kt.setFilter(Z.filter);for(const Qt of Kt.getNodesInfo()){if(Qt.hiddenByReplacement||!Qt.node.meshes)continue;const ki=Qt.node;let ri=0;G.terrain&&ki.elevation&&(ri=ki.elevation*G.terrain.exaggeration());const ur=(()=>{const Gn=Qt.aabb;return Ve.min=[...Gn.min],Ve.max=[...Gn.max],Ve.min[2]+=ri,Ve.max[2]+=ri,s.af(Ve.min,Ve.min,mi),s.af(Ve.max,Ve.max,mi),Ve})(),Ni=Qt.evaluatedScale;if(Ni[0]<=1&&Ni[1]<=1&&Ni[2]<=1&&ur.intersects(mt)===0)continue;if(!Qe&&Ke){const Gn=.16666666666666666;Qt.cameraCollisionOpacity=Ae[0]>ur.min[0]&&Ae[0]<ur.max[0]&&Ae[1]>ur.min[1]&&Ae[1]<ur.max[1]&&Ae[2]*Xe<ur.max[2]&&ki.footprint&&s.b$(Yi,ki.footprint)?Math.max(Qt.cameraCollisionOpacity-Gn,0):Math.min(1,Qt.cameraCollisionOpacity+Gn)}const Ut=[...mi],gi=1/s.d6(fi.canonical),wr=ki.anchor?ki.anchor[0]:0,jr=ki.anchor?ki.anchor[1]:0;s.bq(Ut,Ut,[wr*(Ni[0]-1)+Qt.evaluatedTranslation[0]*gi,jr*(Ni[1]-1)+Qt.evaluatedTranslation[1]*gi,ri+Qt.evaluatedTranslation[2]]),s.cp(Ni,s.eD)||s.cR(Ut,Ut,Ni);const Mr=s.aB([],Ut,ki.globalMatrix),Br=s.aB([],Y.expandedFarZProjMatrix,Mr),go=s.aB([],Y.expandedFarZProjMatrix,Ut),oo=s.aC([],[wr,jr,ri,1],Br)[2];ki.hidden=!1;let Nn=ce;Qe||(Ke&&(Nn*=Qt.cameraCollisionOpacity,Nn*=Ca(Ut,Y,Qt.aabb,$e)),Nn*=dc(gt,oo)),Nn!==0?Ii.push({nodeInfo:Qt,depth:oo,opacity:Nn,wvpForNode:Br,wvpForTile:go,nodeModelMatrix:Mr,tileModelMatrix:Ut}):ki.hidden=!0}Qe||Ii.sort(((Qt,ki)=>!Ke||Qt.opacity===1&&ki.opacity===1?Qt.depth<ki.depth?-1:1:Qt.opacity===1?-1:ki.opacity===1?1:Qt.depth>ki.depth?-1:1));for(const Qt of Ii){const ki=Qt.nodeInfo,ri=ki.node;let ur=s.aB([],xe,Qt.tileModelMatrix);s.aB(ur,ze,ur);const Ni=s.bk([],ur);s.ef(Ni,Ni),s.cR(Ni,Ni,Qf),ur=s.aB(ur,ur,ri.globalMatrix);const Ut=G.renderPass==="light-beam",gi=Z.paint.get("model-color-use-theme").constantOr("default")==="none",wr=ir&s.eH.HasMapboxMeshFeatures,jr=wr?0:ki.evaluatedRMEA[0][2];for(let Mr=0;Mr<ri.meshes.length;++Mr){const Br=ri.meshes[Mr],go=Mr===ri.lightMeshIndex;let oo=Qt.wvpForNode;if(go){if(!Ut&&!G.terrain&&G.shadowRenderer){G.currentLayer<G.firstLightBeamLayer&&(G.firstLightBeamLayer=G.currentLayer);continue}oo=Qt.wvpForTile}else if(Ut)continue;const Nn={defines:[]},Gn=[];if(!Qe&&_e&&(_e.useNormalOffset=!!Br.normalBuffer),ll(Nn.defines,Gn,Br,G,gi?null:Z.lut),wr||Nn.defines.push("DIFFUSE_SHADED"),qi&&Nn.defines.push("SHADOWS_SINGLE_CASCADE"),ht&&(Qe?ht.numRenderedVerticesInShadowPass+=Br.vertexArray.length:ht.numRenderedVerticesInTransparentPass+=Br.vertexArray.length),Qe){ul(Br,Qt.nodeModelMatrix,G,Z);continue}let ko=null;if(re){const Gr=ed(Qt.nodeModelMatrix,G.transform);if(ko=new Float32Array(Gr),Y.projection.name!=="globe"){const er=Br.aabb.min,$r=Br.aabb.max,[Tn,zr]=re.getOpacityForBounds(Gr,er[0],er[1],$r[0],$r[1]);Nn.overrideFog=Tn>=Te||zr>=Te}}const Vn=Br.material;let Bo;Vn.occlusionTexture&&Vn.occlusionTexture.offsetScale&&(Bo=Vn.occlusionTexture.offsetScale,Nn.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const ls=G.getOrCreateProgram("model",Nn);!Qe&&_e&&_e.setupShadowsFromMatrix(Qt.tileModelMatrix,ls,_e.useNormalOffset),G.uploadCommonUniforms(Q,ls,null,ko);const wn=Vn.pbrMetallicRoughness;wn.metallicFactor=.9,wn.roughnessFactor=.5;const Dr=cu(new Float32Array(oo),new Float32Array(ur),new Float32Array(Ni),new Float32Array(ri.globalMatrix),G,Qt.opacity,wn.baseColorFactor,Vn.emissiveFactor,wn.metallicFactor,wn.roughnessFactor,Vn,jr,Z,[0,0,0],Bo);!go&&(ki.hasTranslucentParts||Qt.opacity<1)&&ls.draw(G,Q.gl.TRIANGLES,Le,Gt.disabled,ti.disabled,Bt.backCCW,Dr,Z.id,Br.vertexBuffer,Br.indexBuffer,Br.segments,Z.paint,G.transform.zoom,void 0,Gn),ls.draw(G,Q.gl.TRIANGLES,go?be:Le,Gt.disabled,go||Qt.opacity<1||ki.hasTranslucentParts?ti.alphaBlended:ti.unblended,Bt.backCCW,Dr,Z.id,Br.vertexBuffer,Br.indexBuffer,Br.segments,Z.paint,G.transform.zoom,void 0,Gn)}}}})()})(l,t,n,c),void M();if(E.type!=="model")return;const C=E.getModels(),R=[],z=l.transform.getFreeCameraOptions().position,N=s.c4([],[z.x,z.y,z.z],l.transform.worldSize);s.ev(N,N);const k=[],U=[];let $=0;for(const G of C){const ee=t.getFeatureState("",G.id),Z={type:"Unknown",id:G.id,properties:G.featureProperties},ie=n.paint.get("model-rotation").evaluate(Z,ee),Q=n.paint.get("model-scale").evaluate(Z,ee),Y=n.paint.get("model-translation").evaluate(Z,ee);hl(n,G.id,ee,G.featureProperties,G.nodeOverrideNames,G.nodeOverrides),jm(n,G.id,ee,G.featureProperties,G.materialOverrideNames,G.materialOverrides),G.nodeOverrides.size>0&&G.computeBoundsAndApplyParent(),G.computeModelMatrix(l,ie,Q,Y,y,m,!1);const re=s.bz([]),_e=s.ee(G.position.lat,l.transform.zoom),he=s.bp([],[1,1,1/_e]);s.bq(re,re,N),R.push({zScaleMatrix:he,negCameraPosMatrix:re});for(const Ae of G.nodes)yu(l,Ae,G.matrix,l.transform.expandedFarZProjMatrix,$,k,U,G.materialOverrides);$++}if(k.sort(((G,ee)=>ee.depth-G.depth)),l.renderPass!=="shadow")Kf(l,n,d,k,U,R),M();else{for(const G of U)ul(G.mesh,G.nodeModelMatrix,l,n);for(const G of k)ul(G.mesh,G.nodeModelMatrix,l,n);M()}}},vu={line:function(l,t,n){if(l.hasElevatedBuckets=!1,l.hasNonElevatedBuckets=!1,l._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||l._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){const c=t.getVisibleCoordinates();for(const d of c){const p=t.getTile(d).getBucket(l);if(p&&(p.elevationType!=="none"?l.hasElevatedBuckets=!0:l.hasNonElevatedBuckets=!0,l.hasElevatedBuckets&&l.hasNonElevatedBuckets))break}}}else l.hasNonElevatedBuckets=!0},model:function(l,t,n){const c=t.getSource();if(!c.loaded())return;if(c.type==="vector"||c.type==="geojson"){const p=gu(c,l,n.style._importedAsBasemap);return void(n.modelManager&&n.modelManager.upload(n,p))}if(c.type==="batched-model"||c.type!=="model")return;const d=c.getModels();for(const p of d)p.upload(n.context)},raster:function(l,t,n){const c=t.getSource();if(!(c instanceof mn&&c.loaded()))return;const d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const p=l.paint.get("raster-array-band")||c.getInitialBand(d);if(p==null)return;const m=t.getIds().map((y=>t.getTileByID(y)));for(const y of m)y.updateNeeded(l.id,p)&&c.prepareTile(y,d,l.id,p)},"raster-particle":function(l,t,n){const c=t.getSource();if(!(c instanceof mn&&c.loaded()))return;const d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const p=l.paint.get("raster-particle-array-band")||c.getInitialBand(d);if(p==null)return;const m=t.getIds().map((y=>t.getTileByID(y)));for(const y of m)y.updateNeeded(l.id,p)&&c.prepareTile(y,d,l.id,p)}},bu={fill:Aa},Fo={fill:function(l,t,n,c){if(!n.layout||n.layout.get("fill-elevation-reference")==="none"||n.paint.get("fill-opacity").constantOr(1)===0)return;const d=l.context.gl,p=new xt(d.LEQUAL,xt.ReadOnly,l.depthRangeFor3D),m=new Gt({func:d.ALWAYS,mask:255},255,255,d.KEEP,d.KEEP,d.REPLACE),y=l.transform.getFreeCameraOptions().position,x=l.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const T of c){const S=t.getTile(T),M=S.getBucket(n);if(!M)continue;const E=M.elevatedStructures;if(!E||E.depthSegments.segments[0].primitiveLength===0)continue;const C=qf(T.toUnwrapped(),y),R=l.translatePosMatrix(T.projMatrix,S,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor")),z=ru(R,C,0,1,0);x.draw(l,d.TRIANGLES,p,m,ti.disabled,Bt.disabled,z,n.id,E.vertexBuffer,E.indexBuffer,E.depthSegments,n.paint,l.transform.zoom)}}};class sa{constructor(t,n,c,d,p,m){this.context=new hu(t,n),this.transform=c,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=p,this._timeStamp=s.o.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const y=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const T of y)this._debugParams.enabledLayers[T]=!0;p.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},(()=>{this.style.map.triggerRepaint()})),p.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),p.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),p.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),p.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),p.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const T of y)p.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],T);this.occlusionParams=new Gm(p),this.setup(),this.numSublayers=Qo.maxUnderzooming+Qo.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new s.eO,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new Kl(this),this._wireframeDebugCache=new tp,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const x=new s.q({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new s.T(this.context,x,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=d,this.worldview=m}updateTerrain(t,n){const c=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(c||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new sc(this,t));const d=this._terrain;this.transform.elevation=c?d:null,d.update(t,this.transform,n),this.transform.elevation&&!d.enabled&&(this.transform.elevation=null)}_updateFog(t){const n=t.fog;if(!n||this.transform.projection.name==="globe"||n.getOpacity(this.transform.pitch)<1||n.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[c,d]=n.getFovAdjustedRange(this.transform._fov);if(c>d)return void(this.transform.fogCullDistSq=null);const p=c+.78*(d-c);this.transform.fogCullDistSq=p*p}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new sc(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,n){if(this.width=t*s.o.devicePixelRatio,this.height=n*s.o.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const c of this.style.order)this.style._mergedLayers[c].resize()}setup(){const t=this.context,n=new s.bc;n.emplaceBack(0,0),n.emplaceBack(s.al,0),n.emplaceBack(0,s.al),n.emplaceBack(s.al,s.al),this.tileExtentBuffer=t.createVertexBuffer(n,s.be.members),this.tileExtentSegments=s.bf.simpleSegment(0,0,4,2);const c=new s.bc;c.emplaceBack(0,0),c.emplaceBack(s.al,0),c.emplaceBack(0,s.al),c.emplaceBack(s.al,s.al),this.debugBuffer=t.createVertexBuffer(c,s.be.members),this.debugSegments=s.bf.simpleSegment(0,0,4,5);const d=new s.bc;d.emplaceBack(-1,-1),d.emplaceBack(1,-1),d.emplaceBack(-1,1),d.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(d,s.be.members),this.viewportSegments=s.bf.simpleSegment(0,0,4,2);const p=new s.a$;p.emplaceBack(0,0,0,0),p.emplaceBack(s.al,0,s.al,0),p.emplaceBack(0,s.al,0,s.al),p.emplaceBack(s.al,s.al,s.al,s.al),this.mercatorBoundsBuffer=t.createVertexBuffer(p,s.bh.members),this.mercatorBoundsSegments=s.bf.simpleSegment(0,0,4,2);const m=new s.b0;m.emplaceBack(0,1,2),m.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(m);const y=new s.bd;for(const T of[0,1,3,2,0])y.emplaceBack(T);this.debugIndexBuffer=t.createIndexBuffer(y),this.emptyTexture=new s.T(t,new s.q({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=s.bB();const x=this.context.gl;this.stencilClearMode=new Gt({func:x.ALWAYS,mask:0},0,255,x.ZERO,x.ZERO,x.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,xt.disabled,this.stencilClearMode,ti.disabled,Bt.disabled,Ea(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,n,c){if(!n||this.currentStencilSource===n.id||!t.isTileClipped()||!c||c.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let y=!1;for(const x of c)if(this._tileClippingMaskIDs[x.key]===void 0){y=!0;break}if(!y)return}this.currentStencilSource=n.id;const d=this.context,p=d.gl;this.nextStencilID+c.length>256&&this.clearStencil(),d.setColorMode(ti.disabled),d.setDepthMode(xt.disabled);const m=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const y of c){const x=n.getTile(y),T=this._tileClippingMaskIDs[y.key]=this.nextStencilID++,{tileBoundsBuffer:S,tileBoundsIndexBuffer:M,tileBoundsSegments:E}=this.getTileBoundsBuffers(x);m.draw(this,p.TRIANGLES,xt.disabled,new Gt({func:p.ALWAYS,mask:0},T,255,p.KEEP,p.KEEP,p.REPLACE),ti.disabled,Bt.disabled,Ea(y.projMatrix),"$clipping",S,M,E)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,n=this.context.gl;return new Gt({func:n.NOTEQUAL,mask:255},t,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const n=this.context.gl;return new Gt({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(t){const n=this.context.gl,c=t.sort(((m,y)=>y.overscaledZ-m.overscaledZ)),d=c[c.length-1].overscaledZ,p=c[0].overscaledZ-d+1;if(p>1){this.currentStencilSource=void 0,this.nextStencilID+p>256&&this.clearStencil();const m={};for(let y=0;y<p;y++)m[y+d]=new Gt({func:n.GEQUAL,mask:255},y+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=p,[m,c]}return[{[d]:Gt.disabled},c]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new ti([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new s.ao(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?ti.unblended:ti.alphaBlended}colorModeForDrapableLayerRenderPass(t){const n=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new ti([n.ONE,n.ONE_MINUS_SRC_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_SRC_ALPHA],new s.ao(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,n,c,d=!1){if(this.depthOcclusion)return new xt(this.context.gl.GREATER,xt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!d)return xt.disabled;const p=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new xt(c||this.context.gl.LEQUAL,n,[p,p])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,n=Math.ceil(this.width),c=Math.ceil(this.height),d=this.context.bindFramebuffer.get(),p=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===n&&this.depthFBO.height===c||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),n!==0&&c!==0&&(this.depthFBO=new uu(this.context,n,c,!1,"texture"),this.depthTexture=new s.T(this.context,{width:n,height:c,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(d),t.bindTexture(t.TEXTURE_2D,p),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,n,c,0,0,n,c,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((t,n)=>t+n/this._fpsHistory.length),0))}render(t,n){const c=s.o.now();this._dt=c-this._timeStamp,this._timeStamp=c,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=n;const d=this.style._mergedLayers,p=!(!this.terrain||!this.terrain.enabled),m=()=>this.style._getOrder(p).filter((xe=>{const ce=d[xe];return!(ce.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[ce.type]}));let y=m(),x=!1,T=!1,S=null;for(const xe of y){const ce=d[xe];ce.type==="circle"?x=!0:ce.type==="building"?S=ce:ce.type==="symbol"&&(ce.hasOcclusionOpacityProperties?T=!0:x=!0)}let M=y.map((xe=>d[xe]));const E=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(s.o.now()),this.imageManager.beginFrame();let C=0,R=!1;for(const xe in E){const ce=E[xe];ce.used&&(ce.prepare(this.context),ce.getSource().usedInConflation&&++C)}let z=!1;for(const xe of M)xe.isHidden(this.transform.zoom)||(xe.type==="clip"&&(z=!0),this.prepareLayer(xe));const N={},k={},U={},$={},G={};for(const xe in E){const ce=E[xe];N[xe]=ce.getVisibleCoordinates(),k[xe]=N[xe].slice().reverse(),U[xe]=ce.getVisibleCoordinates(!0).reverse(),$[xe]=ce.getShadowCasterCoordinates(),G[xe]=ce.sortCoordinatesByDistance(N[xe])}const ee=xe=>{const ce=this.style.getLayerSourceCache(xe);return ce&&ce.used?ce.getSource():null};if(C||z||this._clippingActiveLastFrame){const xe=[],ce=[];let Le=0;for(const be of M)this.isSourceForClippingOrConflation(be,ee(be))&&(xe.push(be),ce.push(Le)),Le++;if(xe&&(z||xe.length>1)||this._clippingActiveLastFrame){z=!1;const be=[];for(let Ve=0;Ve<xe.length;Ve++){const Qe=xe[Ve],mt=ce[Ve],$e=this.style.getLayerSourceCache(Qe);if(!$e||!$e.used||!$e.getSource().usedInConflation&&Qe.type!=="clip"&&Qe.type!=="building")continue;let Ke=s.eP,gt=s.bZ.None;const ht=[];let ct=!0;if(Qe.type==="building")Ke=s.eR;else if(Qe.type==="clip"){Ke=mt;for(const dt of Qe.layout.get("clip-layer-types"))gt|=dt==="model"?s.bZ.Model:dt==="symbol"?s.bZ.Symbol:s.bZ.FillExtrusion;for(const dt of Qe.layout.get("clip-layer-scope"))ht.push(dt);Qe.isHidden(this.transform.zoom)?ct=!1:z=!0}ct&&be.push({layer:Qe.fqid,cache:$e,order:Ke,clipMask:gt,clipScope:ht})}this.replacementSource.setSources(be),R=!0}}this._clippingActiveLastFrame=z,R||this.replacementSource.clear(),this.conflationActive=R,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let xe=0;xe<M.length;xe++){const ce=M[xe],Le=ce.cutoffRange();if(this.longestCutoffRange=Math.max(Le,this.longestCutoffRange),Le>0){const be=ee(ce);be&&(this.minCutoffZoom=Math.max(be.minzoom,this.minCutoffZoom)),ce.minzoom&&(this.minCutoffZoom=Math.max(ce.minzoom,this.minCutoffZoom))}ce.is3D(p)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=xe),this._lastOcclusionLayer=xe)}const Z=this.style&&this.style.fog;Z?(this._fogVisible=Z.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=Z.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(U),this.opaquePassCutoff=0,y=m(),M=y.map((xe=>d[xe])));const ie=this._shadowRenderer;if(ie){ie.updateShadowParameters(this.transform,this.style.directionalLight);for(const xe in E)for(const ce of N[xe]){let Le={min:0,max:0};this.terrain&&(Le=this.terrain.getMinMaxForTile(ce)||Le),ie.addShadowReceiver(ce.toUnwrapped(),Le.min,Le.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new s.eQ(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new kr(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const Q=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),Y=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(Q&&!this._snow&&(this._snow=new nd(this)),!Q&&this._snow&&(this._snow.destroy(),delete this._snow),Y&&!this._rain&&(this._rain=new dl(this)),!Y&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),S){this.buildingTileBorderManager||(this.buildingTileBorderManager=new ge);const xe=this.style.getLayerSourceCache(S);this.buildingTileBorderManager.updateBorders(xe,S)}if(!nr.has(this.context.gl))return;this.renderPass="offscreen";for(const xe of M){const ce=t.getLayerSourceCache(xe);if(!xe.hasOffscreenPass()||xe.isHidden(this.transform.zoom))continue;const Le=ce?k[ce.id]:void 0;(xe.type==="custom"||xe.type==="raster"||xe.type==="raster-particle"||xe.isSky()||Le&&Le.length)&&this.renderLayer(this,ce,xe,Le)}this.depthRangeFor3D=[0,1-(M.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,$)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const re=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),_e=(()=>{if(n.showOverdrawInspector)return s.ao.black;const xe=this.style.fog;if(xe&&this.transform.projection.supportsFog){const ce=this.style.getLut(xe.scope);if(!re){const Le=xe.properties.get("color-use-theme")==="none",be=xe.properties.get("color").toNonPremultipliedRenderColor(Le?null:ce).toArray01();return new s.ao(...be)}if(re){const Le=xe.properties.get("space-color-use-theme")==="none",be=xe.properties.get("space-color").toNonPremultipliedRenderColor(Le?null:ce).toArray01();return new s.ao(...be)}}return s.ao.transparent})();if(this.context.clear({color:_e,depth:1}),this.clearStencil(),this._showOverdrawInspector=n.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&re&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=y.length-1;this.currentLayer>=0;this.currentLayer--){const xe=M[this.currentLayer],ce=t.getLayerSourceCache(xe);if(xe.isSky())continue;const Le=ce?(xe.is3D(p)?G:k)[ce.id]:void 0;this._renderTileClippingMasks(xe,ce,Le),this.renderLayer(this,ce,xe,Le)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&re&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||s.aj(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<y.length;this.currentLayer++){const xe=M[this.currentLayer],ce=t.getLayerSourceCache(xe);xe.isSky()&&this.renderLayer(this,ce,xe,ce?k[ce.id]:void 0)}function he(xe,ce){let Le;return ce&&(Le=(xe.type==="symbol"?U:xe.is3D(p)?G:k)[ce.id]),Le}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<y.length;){const xe=M[this.currentLayer];if(xe.type==="raster"||xe.type==="raster-particle"){const ce=t.getLayerSourceCache(xe);this.renderLayer(this,ce,xe,he(xe,ce))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ae=0;ie&&(Ae=ie.getShadowCastingLayerCount());let ve=!1,ze=-1;for(let xe=0;xe<y.length;++xe){const ce=M[xe];ce.isHidden(this.transform.zoom)||ce.is3D(p)&&(ze=xe)}T&&ze===-1&&(x=!0);let Xe=!1;for(;this.currentLayer<y.length;){const xe=M[this.currentLayer],ce=t.getLayerSourceCache(xe);if(xe.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(xe)){if(xe.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!Xe&&xe.is3D(p)&&!p){const Le=this.currentLayer,be=Ve=>{for(this.currentLayer=0;this.currentLayer<M.length;this.currentLayer++){const Qe=M[this.currentLayer];if(bu[Qe.type]){const mt=this.style.getLayerSourceCache(Qe);bu[Qe.type](this,mt,Qe,he(Qe,mt),Ve)}}};be("initialize"),be("reset"),this.currentLayer=Le,Xe=!0}if(x&&!ve&&this.terrain&&!this.transform.isOrthographic&&(ve=!0,this.blitDepth()),T&&ze!==-1&&this.currentLayer===ze+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(xe,ce,ce?N[ce.id]:void 0),this.renderLayer(this,ce,xe,he(xe,ce)),!this.terrain&&ie&&Ae>0&&xe.hasShadowPass()&&--Ae==0){{this.clearStencil(),this.resetStencilClippingMasks();const Le=this.currentLayer;for(this.currentLayer=0;this.currentLayer<M.length;this.currentLayer++){const be=M[this.currentLayer];if(Fo[be.type]){const Ve=this.style.getLayerSourceCache(be);Fo[be.type](this,Ve,be,he(be,Ve))}}this.currentLayer=Le}if(ie.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const Le=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Le;this.currentLayer++){const be=M[this.currentLayer];if(!be.hasLightBeamPass())continue;const Ve=t.getLayerSourceCache(be);this.renderLayer(this,Ve,be,Ve?k[Ve.id]:void 0)}this.currentLayer=Le,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const Le=this.currentLayer;this.depthOcclusion=!0;for(const be of this.layersWithOcclusionOpacity){this.currentLayer=be;const Ve=M[this.currentLayer],Qe=t.getLayerSourceCache(Ve),mt=Qe?k[Qe.id]:void 0;this.terrain||this._renderTileClippingMasks(Ve,Qe,Qe?N[Qe.id]:void 0),this.renderLayer(this,Qe,Ve,mt)}this.depthOcclusion=!1,this.currentLayer=Le,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let xe=null;M.forEach((ce=>{const Le=t.getLayerSourceCache(ce);Le&&!ce.isHidden(this.transform.zoom)&&Le.getVisibleCoordinates().length&&(!xe||xe.getSource().maxzoom<Le.getSource().maxzoom)&&(xe=Le)})),xe&&this.options.showTileBoundaries&&Jh(this,xe,xe.getVisibleCoordinates(),s.ao.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Jh(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new s.ao(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&(function(xe){const ce=xe.transform.padding;lr(xe,xe.transform.height-(ce.top||0),3,oa),lr(xe,ce.bottom||0,3,Wf),hc(xe,ce.left||0,3,Xh),hc(xe,xe.transform.width-(ce.right||0),3,Yh);const Le=xe.transform.centerPoint;(function(be,Ve,Qe,mt){sl(be,Ve-1,Qe-10,2,20,mt),sl(be,Ve-10,Qe-1,20,2,mt)})(xe,Le.x,xe.transform.height-Le.y,Kh)})(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),R||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);const{unsupportedLayers:n}=this.transform.projection,c=!n||!n.includes(t.type);if(vu[t.type]&&(c||this.terrain&&t.type==="custom")){const d=this.style.getLayerSourceCache(t);vu[t.type](t,d,this)}this.gpuTimingEnd()}renderLayer(t,n,c,d){c.isHidden(this.transform.zoom)||(c.type==="background"||c.type==="sky"||c.type==="custom"||c.type==="model"||c.type==="raster"||c.type==="raster-particle"||d&&d.length)&&(this.id=c.id,this.gpuTimingStart(c),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(c.type)&&(!t.terrain||c.type!=="custom")||c.type==="clip"||od[c.type](t,n,c,d,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const n=this.context.extTimerQuery,c=this.context.gl;let d=this.gpuTimers[t.id];d||(d=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:c.createQuery()}),d.calls++,c.beginQuery(n.TIME_ELAPSED_EXT,d.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,n=this.context.gl,c=n.createQuery();this.deferredRenderGpuTimeQueries.push(c),n.beginQuery(t.TIME_ELAPSED_EXT,c)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const n={};for(const c in t){const d=t[c],p=this.context.extTimerQuery,m=p.getQueryParameter(d.query,this.context.gl.QUERY_RESULT)/1e6;p.deleteQueryEXT(d.query),n[c]=m}return n}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const n=this.context.gl;let c=0;for(const d of t)c+=n.getQueryParameter(d,n.QUERY_RESULT)/1e6,n.deleteQuery(d);return c}translatePosMatrix(t,n,c,d,p){if(!c[0]&&!c[1])return t;const m=p?d==="map"?this.transform.angle:0:d==="viewport"?-this.transform.angle:0;if(m){const T=Math.sin(m),S=Math.cos(m);c=[c[0]*S-c[1]*T,c[0]*T+c[1]*S]}const y=[p?c[0]:s.ay(n,c[0],this.transform.zoom),p?c[1]:s.ay(n,c[1],this.transform.zoom),0],x=new Float32Array(16);return s.bq(x,t,y),x}saveTileTexture(t){if(t.context!==this.context)return;const n=t.size[0],c=this._tileTextures[n];c?c.push(t):this._tileTextures[n]=[t]}getTileTexture(t){const n=this._tileTextures[t];return n&&n.length>0?n.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,n,c){const d=c===void 0?this.terrain&&this.terrain.renderingToTexture:c,p=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(p.push("LIGHTING_3D_MODE"),p.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):d||p.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||p.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(p.push("TERRAIN"),this.linearFloatFilteringSupported()&&p.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&p.push("GLOBE"),!this._fogVisible||d||n!==void 0&&!n||p.push("FOG","FOG_DITHERING"),d&&p.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&p.push("OVERDRAW_INSPECTOR"),p}getOrCreateProgram(t,n){this.cache=this.cache||{};const c=n&&n.defines||[],d=n&&n.config,p=this.currentGlobalDefines(t,n&&n.overrideFog,n&&n.overrideRtt).concat(c),m=ac.cacheKey(Gc[t],t,p,d);return this.cache[m]||(this.cache[m]=new ac(this.context,t,Gc[t],d,Bm[t],p)),this.cache[m]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new s.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,n){if(this.style.enable3dLights()){const c=this.style.directionalLight,d=this.style.ambientLight;if(c&&d){const p=((m,y,x)=>{const T=m.properties.get("direction"),S=m.properties.get("color-use-theme")==="none",M=m.properties.get("color").toNonPremultipliedRenderColor(S?null:x.getLut(m.scope)).toArray01(),E=m.properties.get("intensity"),C=y.properties.get("color-use-theme")==="none",R=y.properties.get("color").toNonPremultipliedRenderColor(C?null:x.getLut(y.scope)).toArray01(),z=y.properties.get("intensity"),N=[T.x,T.y,T.z],k=s.dM(R,z),U=s.dM(M,E);return{u_lighting_ambient_color:k,u_lighting_directional_dir:N,u_lighting_directional_color:U,u_ground_radiance:zh(N,U,k)}})(c,d,this.style);n.setLightsUniformValues(t,p)}}}uploadCommonUniforms(t,n,c,d,p){if(this.uploadCommonLightUniforms(t,n),this.terrain&&this.terrain.renderingToTexture)return;const m=this.style.fog;if(m){const y=m.getOpacity(this.transform.pitch),x=((T,S,M,E,C,R,z,N,k,U,$,G)=>{const ee=T.transform,Z=S.properties.get("color-use-theme")==="none",ie=S.properties.get("color").toNonPremultipliedRenderColor(Z?null:T.style.getLut(S.scope)).toArray01();ie[3]=E;const Q=T.frameCounter/1e3%1,[Y,re]=S.properties.get("vertical-range");return{u_fog_matrix:M?ee.calculateFogTileMatrix(M):G||T.identityMat,u_fog_range:S.getFovAdjustedRange(ee._fov),u_fog_color:ie,u_fog_horizon_blend:S.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(Y,re),re],u_fog_temporal_offset:Q,u_frustum_tl:C,u_frustum_tr:R,u_frustum_br:z,u_frustum_bl:N,u_globe_pos:k,u_globe_radius:U,u_viewport:$,u_globe_transition:s.aj(ee.zoom),u_is_globe:+(ee.projection.name==="globe")}})(this,m,c,y,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*s.o.devicePixelRatio,this.transform.height*s.o.devicePixelRatio],d);n.setFogUniformValues(t,x)}p&&n.setCutoffUniformValues(t,p.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),n}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,n=this._backgroundTiles={},c=this.transform.coveringTiles({tileSize:512});for(const d of c)n[d.key]=t[d.key]||new bs(d,512,this.transform.tileZoom,this,void 0,this.worldview);return n}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,n){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&t.type!=="building"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building"&&t.sourceLayer!=="procedural_buildings")&&(!n||n.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let n=this._cachedTileFogOpacities[t.key];return n||(this._cachedTileFogOpacities[t.key]=n=this.style.fog.getOpacityForTile(t)),n[0]>=Te||n[1]>=Te}setupDepthForOcclusion(t,n,c){const d=this.context,p=d.gl,m=!!c;var y;c||(c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),d.activeTexture.set(p.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),c.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],c.u_depth_range_unpack=[2/((y=this.depthRangeFor3D)[1]-y[0]),-1-2*y[0]/(y[1]-y[0])],c.u_occluder_half_size=.5*this.occlusionParams.occluderSize,c.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),d.activeTexture.set(p.TEXTURE0),m||n.setTerrainUniformValues(d,c)}}function Ra(l,t){let n=!1,c=null;const d=()=>{c=null,n&&(l(),c=setTimeout(d,t),n=!1)};return()=>(n=!0,c||d(),c)}class wu{constructor(t){this._hashName=t&&encodeURIComponent(t),s.aX(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Ra(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const n=Tu(t);if(this._hashName){const c=this._hashName;let d=!1;const p=location.hash.slice(1).split("&").map((m=>{const y=m.split("=")[0];return y===c?(d=!0,"".concat(y,"=").concat(n)):m})).filter((m=>m));return d||p.push("".concat(c,"=").concat(n)),"#".concat(p.join("&"))}return"#".concat(n)}_getCurrentHash(){const t=location.hash.replace("#","");if(this._hashName){let n;return t.split("&").map((c=>c.split("="))).forEach((c=>{c[0]===this._hashName&&(n=c)})),(n&&n[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const n=this._getCurrentHash();if(n.length>=3&&!n.some((c=>isNaN(Number(c))))){const c=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(n[3]||0):t.getBearing();return t.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:c,pitch:+(n[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Tu(l,t){const n=l.getCenter(),c=Math.round(100*l.getZoom())/100,d=Math.ceil((c*Math.LN2+Math.log(512/360/.5))/Math.LN10),p=Math.pow(10,d),m=Math.round(n.lng*p)/p,y=Math.round(n.lat*p)/p,x=l.getBearing(),T=l.getPitch();let S=t?"/".concat(m,"/").concat(y,"/").concat(c):"".concat(c,"/").concat(y,"/").concat(m);return(x||T)&&(S+="/"+Math.round(10*x)/10),T&&(S+="/".concat(Math.round(T))),S}const fl={linearity:.3,easing:s.eS(0,0,.3,1)},aa=Object.assign({deceleration:2500,maxSpeed:1400},fl),sd=Object.assign({deceleration:20,maxSpeed:1400},fl),ss=Object.assign({deceleration:1e3,maxSpeed:360},fl),ad=Object.assign({deceleration:1e3,maxSpeed:90},fl);class Su{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:s.o.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,n=s.o.now();for(;t.length>0&&n-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const n={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:p}of this._inertiaBuffer)n.zoom+=p.zoomDelta||0,n.bearing+=p.bearingDelta||0,n.pitch+=p.pitchDelta||0,p.panDelta&&n.pan._add(p.panDelta),p.around&&(n.around=p.around),p.pinchAround&&(n.pinchAround=p.pinchAround);const c=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,d={};if(n.pan.mag()){const p=ml(n.pan.mag(),c,Object.assign({},aa,t||{}));d.offset=n.pan.mult(p.amount/n.pan.mag()),d.center=this._map.transform.center,pl(d,p)}if(n.zoom){const p=ml(n.zoom,c,sd);d.zoom=this._map.transform.zoom+p.amount,pl(d,p)}if(n.bearing){const p=ml(n.bearing,c,ss);d.bearing=this._map.transform.bearing+s.aA(p.amount,-179,179),pl(d,p)}if(n.pitch){const p=ml(n.pitch,c,ad);d.pitch=this._map.transform.pitch+p.amount,pl(d,p)}if(d.zoom||d.bearing){const p=n.pinchAround===void 0?n.around:n.pinchAround;d.around=p?this._map.unproject(p):this._map.getCenter()}return this.clear(),d.noMoveStart=!0,d}}function pl(l,t){(!l.duration||l.duration<t.duration)&&(l.duration=t.duration,l.easing=t.easing)}function ml(l,t,n){const{maxSpeed:c,linearity:d,deceleration:p}=n,m=s.aA(l*d/(t/1e3),-c,c),y=Math.abs(m)/(p*d);return{easing:n.easing,duration:1e3*y,amount:m*(y/2)}}class vr extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c,d={}){const p=Si(n.getCanvasContainer(),c),m=n.unproject(p);super(t,Object.assign({point:p,lngLat:m,originalEvent:c},d)),this._defaultPrevented=!1,this.target=n}}class _l extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c){const d=t==="touchend"?c.changedTouches:c.touches,p=hr(n.getCanvasContainer(),d),m=p.map((x=>n.unproject(x))),y=p.reduce(((x,T,S,M)=>x.add(T.div(M.length))),new s.P(0,0));super(t,{points:p,point:y,lngLats:m,lngLat:n.unproject(y),originalEvent:c}),this._defaultPrevented=!1}}class ld extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n){super("wheel",{originalEvent:n}),this._defaultPrevented=!1}}class cd{constructor(t,n){this._map=t,this._clickTolerance=n.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new ld(this._map,t))}mousedown(t,n){return this._mousedownPos=n,this._firePreventable(new vr(t.type,this._map,t))}mouseup(t){this._map.fire(new vr(t.type,this._map,t))}preclick(t){const n=new MouseEvent("preclick",t);this._map.fire(new vr(n.type,this._map,n))}click(t,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||(this.preclick(t),this._map.fire(new vr(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new vr(t.type,this._map,t))}mouseover(t){this._map.fire(new vr(t.type,this._map,t))}mouseout(t){this._map.fire(new vr(t.type,this._map,t))}touchstart(t){return this._firePreventable(new _l(t.type,this._map,t))}touchmove(t){this._map.fire(new _l(t.type,this._map,t))}touchend(t){this._map.fire(new _l(t.type,this._map,t))}touchcancel(t){this._map.fire(new _l(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Da{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new vr(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new vr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new vr(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ud{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,n){this.isEnabled()&&t.shiftKey&&t.button===0&&(Ci(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(t,n){if(!this._active)return;const c=n,d=this._startPos,p=this._lastPos;if(!d||!p||p.equals(c)||!this._box&&c.dist(d)<this._clickTolerance)return;this._lastPos=c,this._box||(this._box=Tt("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const m=Math.min(d.x,c.x),y=Math.max(d.x,c.x),x=Math.min(d.y,c.y),T=Math.max(d.y,c.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform="translate(".concat(m,"px,").concat(x,"px)"),this._box.style.width=y-m+"px",this._box.style.height=T-x+"px")}))}mouseupWindow(t,n){if(!this._active)return;const c=this._startPos,d=n;if(c&&t.button===0){if(this.reset(),Ti(),c.x!==d.x||c.y!==d.y)return this._map.fire(new s.z("boxzoomend",{originalEvent:t})),{cameraAnimation:p=>p.fitScreenCoordinates(c,d,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),tr(),delete this._startPos,delete this._lastPos}_fireEvent(t,n){return this._map.fire(new s.z(t,{originalEvent:n}))}}function pc(l,t){const n={};for(let c=0;c<l.length;c++)n[l[c].identifier]=t[c];return n}class hd{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,n,c){(this.centroid||c.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),c.length===this.numTouches&&(this.centroid=(function(d){const p=new s.P(0,0);for(const m of d)p._add(m);return p.div(d.length)})(n),this.touches=pc(c,n)))}touchmove(t,n,c){if(this.aborted||!this.centroid)return;const d=pc(c,n);for(const p in this.touches){const m=d[p];(!m||m.dist(this.touches[p])>30)&&(this.aborted=!0)}}touchend(t,n,c){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),c.length===0){const d=!this.aborted&&this.centroid;if(this.reset(),d)return d}}}class la{constructor(t){this.singleTap=new hd(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,n,c){this.singleTap.touchstart(t,n,c)}touchmove(t,n,c){this.singleTap.touchmove(t,n,c)}touchend(t,n,c){const d=this.singleTap.touchend(t,n,c);if(d){const p=t.timeStamp-this.lastTime<500,m=!this.lastTap||this.lastTap.dist(d)<30;if(p&&m||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=d,this.count===this.numTaps)return this.reset(),d}}}class dd{constructor(){this._zoomIn=new la({numTouches:1,numTaps:2}),this._zoomOut=new la({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,n,c){this._zoomIn.touchstart(t,n,c),this._zoomOut.touchstart(t,n,c)}touchmove(t,n,c){this._zoomIn.touchmove(t,n,c),this._zoomOut.touchmove(t,n,c)}touchend(t,n,c){const d=this._zoomIn.touchend(t,n,c),p=this._zoomOut.touchend(t,n,c);return d?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:m=>m.easeTo({duration:300,zoom:m.getZoom()+1,around:m.unproject(d)},{originalEvent:t})}):p?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:m=>m.easeTo({duration:300,zoom:m.getZoom()-1,around:m.unproject(p)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Eu={0:1,2:2},Iu={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class gl{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,n){return!1}_move(t,n){return{}}mousedown(t,n){if(this._lastPoint)return;const c=Sr(t);this._correctButton(t,c)&&(this._lastPoint=n,this._eventButton=c)}mousemoveWindow(t,n){const c=this._lastPoint;if(c){if(t.preventDefault(),this._eventButton!=null&&(function(d,p){const m=Eu[p];return d.buttons===void 0||(d.buttons&m)!==m})(t,this._eventButton))this.reset();else if(this._moved||!(n.dist(c)<this._clickTolerance))return this._moved=!0,this._lastPoint=n,this._move(c,n)}}mouseupWindow(t){this._lastPoint&&Sr(t)===this._eventButton&&(this._moved&&Ti(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class fd extends gl{mousedown(t,n){super.mousedown(t,n),this._lastPoint&&(this._active=!0)}_correctButton(t,n){return n===0&&!t.ctrlKey}_move(t,n){return{around:n,panDelta:n.sub(t)}}}class Au extends gl{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?Iu[t.pitchRotateKey]:void 0}_correctButton(t,n){return this._pitchRotateKey?n===0&&t[this._pitchRotateKey]:n===0&&t.ctrlKey||n===2}_move(t,n){const c=.8*(n.x-t.x);if(c)return this._active=!0,{bearingDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class pd extends gl{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?Iu[t.pitchRotateKey]:void 0}_correctButton(t,n){return this._pitchRotateKey?n===0&&t[this._pitchRotateKey]:n===0&&t.ctrlKey||n===2}_move(t,n){const c=-.5*(n.y-t.y);if(c)return this._active=!0,{pitchDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class rp{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=n.clickTolerance||1,this.reset(),s.aX(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}touchstart(t,n,c){return this._calculateTransform(t,n,c)}touchmove(t,n,c){if(this._active&&!(c.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(c.length===1&&!s.eT())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,n,c)}}touchend(t,n,c){this._calculateTransform(t,n,c),this._active&&c.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,n,c){c.length>0&&(this._active=!0);const d=pc(c,n),p=new s.P(0,0),m=new s.P(0,0);let y=0;for(const T in d){const S=d[T],M=this._touches[T];M&&(p._add(S),m._add(S.sub(M)),y++,d[T]=S)}if(this._touches=d,y<this._minTouches||!m.mag())return;const x=m.div(y);return this._sum._add(x),this._sum.mag()<this._clickTolerance?void 0:{around:p.div(y),panDelta:x}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Tt("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize="".concat(Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth))),"px"))}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class Mu{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,n,c){return{}}touchstart(t,n,c){this._firstTwoTouches||c.length<2||(this._firstTwoTouches=[c[0].identifier,c[1].identifier],this._start([n[0],n[1]]))}touchmove(t,n,c){const d=this._firstTwoTouches;if(!d)return;t.preventDefault();const[p,m]=d,y=mc(c,n,p),x=mc(c,n,m);if(!y||!x)return;const T=this._aroundCenter?null:y.add(x).div(2);return this._move([y,x],T,t)}touchend(t,n,c){if(!this._firstTwoTouches)return;const[d,p]=this._firstTwoTouches,m=mc(c,n,d),y=mc(c,n,p);m&&y||(this._active&&Ti(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function mc(l,t,n){for(let c=0;c<l.length;c++)if(l[c].identifier===n)return t[c]}function md(l,t){return Math.log2(l/t)}class np extends Mu{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,n){const c=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(md(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:md(this._distance,c),pinchAround:n}}}function _d(l,t){return 180*l.angleWith(t)/Math.PI}class op extends Mu{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,n){const c=this._vector;if(this._vector=t[0].sub(t[1]),c&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:_d(this._vector,c),pinchAround:n}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const n=25/(Math.PI*this._minDiameter)*360,c=this._startVector;if(!c)return!1;const d=_d(t,c);return Math.abs(d)<n}}function Cu(l){return Math.abs(l.y)>Math.abs(l.x)}class sp extends Mu{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,Cu(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,n,c){const d=this._lastPoints;if(!d)return;const p=t[0].sub(d[0]),m=t[1].sub(d[1]);return this._map._cooperativeGestures&&!s.eT()&&c.touches.length<3||(this._valid=this.gestureBeginsVertically(p,m,c.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(p.y+m.y)/2*-.5})}gestureBeginsVertically(t,n,c){if(this._valid!==void 0)return this._valid;const d=t.mag()>=2,p=n.mag()>=2;if(!d&&!p)return;if(!d||!p)return this._firstMove==null&&(this._firstMove=c),c-this._firstMove<100&&void 0;const m=t.y>0==n.y>0;return Cu(t)&&Cu(n)&&m}}const ap={panStep:100,bearingStep:15,pitchStep:10};class lp{constructor(){const t=ap;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let n=0,c=0,d=0,p=0,m=0;switch(t.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:t.shiftKey?c=-1:(t.preventDefault(),p=-1);break;case 39:t.shiftKey?c=1:(t.preventDefault(),p=1);break;case 38:t.shiftKey?d=1:(t.preventDefault(),m=-1);break;case 40:t.shiftKey?d=-1:(t.preventDefault(),m=1);break;default:return}return this._rotationDisabled&&(c=0,d=0),{cameraAnimation:y=>{const x=y.getZoom();y.easeTo({duration:300,easeId:"keyboardHandler",easing:cp,zoom:n?Math.round(x)+n*(t.shiftKey?2:1):x,bearing:y.getBearing()+c*this._bearingStep,pitch:y.getPitch()+d*this._pitchStep,offset:[-p*this._panStep,-m*this._panStep],center:y.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function cp(l){return l*(2-l)}const up=4.000244140625,$m=1/450;class Zm{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._handler=n,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=$m,s.aX(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||s.eT()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let n=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const c=s.o.now(),d=c-(this._lastWheelEventTime||0);this._lastWheelEventTime=c,n!==0&&n%up==0?this._type="wheel":n!==0&&Math.abs(n)<4?this._type="trackpad":d>400?(this._type=null,this._lastValue=n,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(d*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),t.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=t,this._delta-=n,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=Si(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:n,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const n=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const T=this._type==="wheel"&&Math.abs(this._delta)>up?this._wheelZoomRate:this._defaultZoomRate;let S=2/(1+Math.exp(-Math.abs(this._delta*T)));this._delta<0&&S!==0&&(S=1/S);const M=n(),E=Math.pow(2,M),C=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):E;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(C*S))),this._type==="wheel"&&(this._startZoom=M,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const c=typeof this._targetZoom=="number"?this._targetZoom:n(),d=this._startZoom,p=this._easing;let m,y=!1;if(this._type==="wheel"&&d&&p){const T=Math.min((s.o.now()-this._lastWheelEventTime)/200,1),S=p(T);m=s.ak(d,c,S),T<1?this._frameId||(this._frameId=!0):y=!0}else m=c,y=!0;this._active=!0,y&&(this._active=!1,this._finishTimeout=window.setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let x=m-n();return x*this._lastDelta<0&&(x=0),{noInertia:!0,needsRenderFrame:!y,zoomDelta:x,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let n=s.eU;if(this._prevEase){const c=this._prevEase,d=(s.o.now()-c.start)/c.duration,p=c.easing(d+.01)-c.easing(d),m=.27/Math.sqrt(p*p+1e-4)*.01,y=Math.sqrt(.0729-m*m);n=s.eS(m,y,.25,1)}return this._prevEase={start:s.o.now(),duration:t,easing:n},n}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Tt("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize="".concat(Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth))),"px"))}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class Ar{constructor(t,n){this._clickZoom=t,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class hp{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,n){return t.preventDefault(),{cameraAnimation:c=>{c.easeTo({duration:300,zoom:c.getZoom()+(t.shiftKey?-1:1),around:c.unproject(n)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Wm{constructor(){this._tap=new la({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,n,c){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?c.length>0&&(this._swipePoint=n[0],this._swipeTouch=c[0].identifier):this._tap.touchstart(t,n,c))}touchmove(t,n,c){if(this._tapTime){if(this._swipePoint){if(c[0].identifier!==this._swipeTouch)return;const d=n[0],p=d.y-this._swipePoint.y;return this._swipePoint=d,t.preventDefault(),this._active=!0,{zoomDelta:p/128}}}else this._tap.touchmove(t,n,c)}touchend(t,n,c){this._tapTime?this._swipePoint&&c.length===0&&this.reset():this._tap.touchend(t,n,c)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Xm{constructor(t,n,c){this._el=t,this._mousePan=n,this._touchPan=c}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Ym{constructor(t,n,c){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=n,this._mousePitch=c}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class _c{constructor(t,n,c,d){this._el=t,this._touchZoom=n,this._touchRotate=c,this._tapDragZoom=d,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const gc=l=>l.zoom||l.drag||l.pitch||l.rotate;class gd extends s.z{}class Pu{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,n){const c=s.av([],n,t);this.radius=s.ag(c[2]<0?s.eW([],c,this.constants):[c[0],c[1],0])}projectRay(t){s.eW(t,t,this.constants),s.aw(t,t),s.eX(t,t,this.constants);const n=s.c4([],t,this.radius);if(n[2]>0){const c=s.c4([],[0,0,1],s.bI(n,[0,0,1])),d=s.c4([],s.aw([],[n[0],n[1],0]),this.radius),p=s.d7([],n,s.c4([],s.av([],s.d7([],d,c),n),2));n[0]=p[0],n[1]=p[1]}return n}}function as(l){return l.panDelta&&l.panDelta.mag()||l.zoomDelta||l.bearingDelta||l.pitchDelta}class Ru{constructor(t,n){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Su(t),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Pu,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(n),s.aX(["handleEvent","handleWindowEvent"],this);const c=this._el;this._listeners=[[c,"touchstart",{passive:!0}],[c,"touchmove",{passive:!1}],[c,"touchend",void 0],[c,"touchcancel",void 0],[c,"mousedown",void 0],[c,"mousemove",void 0],[c,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[c,"mouseover",void 0],[c,"mouseout",void 0],[c,"dblclick",void 0],[c,"click",void 0],[c,"keydown",{capture:!1}],[c,"keyup",void 0],[c,"wheel",{passive:!1}],[c,"contextmenu",void 0],[window,"blur",void 0]];for(const[d,p,m]of this._listeners){const y=d===document?this.handleWindowEvent:this.handleEvent;d.addEventListener(p,y,m)}}destroy(){for(const[t,n,c]of this._listeners){const d=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(n,d,c)}}_addDefaultHandlers(t){const n=this._map,c=n.getCanvasContainer();this._add("mapEvent",new cd(n,t));const d=n.boxZoom=new ud(n,t);this._add("boxZoom",d);const p=new dd,m=new hp;n.doubleClickZoom=new Ar(m,p),this._add("tapZoom",p),this._add("clickZoom",m);const y=new Wm;this._add("tapDragZoom",y);const x=n.touchPitch=new sp(n);this._add("touchPitch",x);const T=new Au(t),S=new pd(t);n.dragRotate=new Ym(t,T,S),this._add("mouseRotate",T,["mousePitch"]),this._add("mousePitch",S,["mouseRotate"]);const M=new fd(t),E=new rp(n,t);n.dragPan=new Xm(c,M,E),this._add("mousePan",M),this._add("touchPan",E,["touchZoom","touchRotate"]);const C=new op,R=new np;n.touchZoomRotate=new _c(c,R,C,y),this._add("touchRotate",C,["touchPan","touchZoom"]),this._add("touchZoom",R,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Da(n));const z=n.scrollZoom=new Zm(n,this);this._add("scrollZoom",z,["mousePan"]);const N=n.keyboard=new lp;this._add("keyboard",N);for(const k of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[k]&&n[k].enable(t[k])}_add(t,n,c){this._handlers.push({handlerName:t,handler:n,allowed:c}),this._handlersById[t]=n}stop(t){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!gc(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,n,c){for(const d in t)if(d!==c&&(!n||n.indexOf(d)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,"".concat(t.type,"Window"))}_getMapTouches(t){const n=[];for(const c of t)this._el.contains(c.target)&&n.push(c);return n}handleEvent(t,n){this._updatingCamera=!0;const c=t.type==="renderFrame",d=c?void 0:t,p={needsRenderFrame:!1},m={},y={},x=t.touches?this._getMapTouches(t.touches):void 0,T=x?hr(this._el,x):c?void 0:Si(this._el,t);for(const{handlerName:E,handler:C,allowed:R}of this._handlers){if(!C.isEnabled())continue;let z;this._blockedByActive(y,R,E)?C.reset():C[n||t.type]&&(z=C[n||t.type](t,T,x),this.mergeHandlerResult(p,m,z,E,d),z&&z.needsRenderFrame&&this._triggerRenderFrame()),(z||C.isActive())&&(y[E]=C)}const S={};for(const E in this._previousActiveHandlers)y[E]||(S[E]=d);this._previousActiveHandlers=y,(Object.keys(S).length||as(p))&&(this._changes.push([p,m,S]),this._triggerRenderFrame()),(Object.keys(y).length||as(p))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:M}=p;M&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],M(this._map))}mergeHandlerResult(t,n,c,d,p){if(!c)return;Object.assign(t,c);const m={handlerName:d,originalEvent:c.originalEvent||p};c.zoomDelta!==void 0&&(n.zoom=m),c.panDelta!==void 0&&(n.drag=m),c.pitchDelta!==void 0&&(n.pitch=m),c.bearingDelta!==void 0&&(n.rotate=m)}_applyChanges(){const t={},n={},c={};for(const[d,p,m]of this._changes)d.panDelta&&(t.panDelta=(t.panDelta||new s.P(0,0))._add(d.panDelta)),d.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+d.zoomDelta),d.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+d.bearingDelta),d.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+d.pitchDelta),d.around!==void 0&&(t.around=d.around),d.aroundCoord!==void 0&&(t.aroundCoord=d.aroundCoord),d.pinchAround!==void 0&&(t.pinchAround=d.pinchAround),d.noInertia&&(t.noInertia=d.noInertia),Object.assign(n,p),Object.assign(c,m);this._updateMapTransform(t,n,c),this._changes=[]}_updateMapTransform(t,n,c){const d=this._map,p=d.transform,m=U=>[U.x,U.y,U.z];if((U=>{const $=this._eventsInProgress.drag;return $&&!this._handlersById[$.handlerName].isActive()})()&&!as(t)){const U=p.zoom;p.cameraElevationReference="sea",this._originalZoom!=null&&p._orthographicProjectionAtLowPitch&&p.projection.name!=="globe"&&p.pitch===0?(p.cameraElevationReference="ground",p.zoom=this._originalZoom):(p.recenterOnTerrain(),p.cameraElevationReference="ground"),U!==p.zoom&&this._map._update(!0)}if(p._isCameraConstrained&&d._stop(!0),!as(t))return void this._fireEvents(n,c,!0);let{panDelta:y,zoomDelta:x,bearingDelta:T,pitchDelta:S,around:M,aroundCoord:E,pinchAround:C}=t;p._isCameraConstrained&&(x>0&&(x=0),p._isCameraConstrained=!1),C!==void 0&&(M=C),(x||(U=>n[U]&&!this._eventsInProgress[U])("drag"))&&M&&(this._dragOrigin=m(p.pointCoordinate3D(M)),this._originalZoom=p.zoom,this._trackingEllipsoid.setup(p._camera.position,this._dragOrigin)),p.cameraElevationReference="sea",d._stop(!0),M=M||d.transform.centerPoint,T&&(p.bearing+=T),S&&(p.pitch+=S),p._updateCameraState();const R=[0,0,0];if(y)if(p.projection.name==="mercator"){const U=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(M).dir),$=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(M.sub(y)).dir);R[0]=$[0]-U[0],R[1]=$[1]-U[1]}else{const U=p.pointCoordinate(M);if(p.projection.name==="globe"){y=y.rotate(-p.angle);const $=p._pixelsPerMercatorPixel/p.worldSize;R[0]=-y.x*s.eV(s.a_(U.y))*$,R[1]=-y.y*s.eV(p.center.lat)*$}else{const $=p.pointCoordinate(M.sub(y));U&&$&&(R[0]=$.x-U.x,R[1]=$.y-U.y)}}const z=p.zoom,N=[0,0,0];if(x){const U=m(E||p.pointCoordinate3D(M)),$={dir:s.aw([],s.av([],U,p._camera.position))};if($.dir[2]<0){const G=p.zoomDeltaToMovement(U,x);s.c4(N,$.dir,G)}}const k=s.d7(R,R,N);p._translateCameraConstrained(k),x&&Math.abs(p.zoom-z)>1e-4&&p.recenterOnTerrain(),p.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(n,c,!0)}_fireEvents(t,n,c){const d=gc(this._eventsInProgress),p=gc(t),m={};for(const S in t){const{originalEvent:M}=t[S];this._eventsInProgress[S]||(m["".concat(S,"start")]=M),this._eventsInProgress[S]=t[S]}!d&&p&&this._fireEvent("movestart",p.originalEvent);for(const S in m)this._fireEvent(S,m[S]);p&&this._fireEvent("move",p.originalEvent);for(const S in t){const{originalEvent:M}=t[S];this._fireEvent(S,M)}const y={};let x;for(const S in this._eventsInProgress){const{handlerName:M,originalEvent:E}=this._eventsInProgress[S];this._handlersById[M].isActive()||(delete this._eventsInProgress[S],x=n[M]||E,y["".concat(S,"end")]=x)}for(const S in y)this._fireEvent(S,y[S]);const T=gc(this._eventsInProgress);if(c&&(d||p)&&!T){this._updatingCamera=!0;const S=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),M=E=>E!==0&&-this._bearingSnap<E&&E<this._bearingSnap;S?(M(S.bearing||this._map.getBearing())&&(S.bearing=0),this._map.easeTo(S,{originalEvent:x})):(this._map.fire(new s.z("moveend",{originalEvent:x})),M(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,n){this._map.fire(new s.z(t,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((t=>{this._frameId=void 0,this.handleEvent(new gd("renderFrame",{timeStamp:t})),this._applyChanges()}))}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const Qr="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Is extends s.E{constructor(t,n){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=n.bearingSnap,this._respectPrefersReducedMotion=n.respectPrefersReducedMotion!==!1,s.aX(["_renderFrameCallback"],this)}getCenter(){return new s.aS(this.transform.center.lng,this.transform.center.lat)}setCenter(t,n){return this.jumpTo({center:t},n)}panBy(t,n,c){return t=s.P.convert(t).mult(-1),this.panTo(this.transform.center,Object.assign({offset:t},n),c)}panTo(t,n,c){return this.easeTo(Object.assign({center:t},n),c)}getZoom(){return this.transform.zoom}setZoom(t,n){return this.jumpTo({zoom:t},n),this}zoomTo(t,n,c){return this.easeTo(Object.assign({zoom:t},n),c)}zoomIn(t,n){return this.zoomTo(this.getZoom()+1,t,n),this}zoomOut(t,n){return this.zoomTo(this.getZoom()-1,t,n),this}getBearing(){return this.transform.bearing}setBearing(t,n){return this.jumpTo({bearing:t},n),this}getPadding(){return this.transform.padding}setPadding(t,n){return this.jumpTo({padding:t},n),this}rotateTo(t,n,c){return this.easeTo(Object.assign({bearing:t},n),c)}resetNorth(t,n){return this.rotateTo(0,Object.assign({duration:1e3},t),n),this}resetNorthPitch(t,n){return this.easeTo(Object.assign({bearing:0,pitch:0,duration:1e3},t),n),this}snapToNorth(t,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,n):this}getPitch(){return this.transform.pitch}setPitch(t,n){return this.jumpTo({pitch:t},n),this}cameraForBounds(t,n){t=s.aI.convert(t);const c=n&&n.bearing||0,d=n&&n.pitch||0,p=t.getNorthWest(),m=t.getSouthEast();return this._cameraForBounds(this.transform,p,m,c,d,n)}_extendPadding(t){const n={top:0,right:0,bottom:0,left:0};return t==null?Object.assign({},n,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:Object.assign({},n,t)}_extendCameraOptions(t){return(t=Object.assign({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,n){const c=n.max[0]-n.min[0],d=n.max[1]-n.min[1];return c/d>t.aspect?c/(2*Math.tan(.5*t.fovX)*t.aspect):d/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,n,c,d,p,m){const y=t.clone(),x=this._extendCameraOptions(m);y.bearing=d,y.pitch=p;const T=s.aS.convert(n),S=s.aS.convert(c),M=.5*(T.lat+S.lat),E=.5*(T.lng+S.lng),C=s.eY(M,E),R=s.aw([],C),z=s.aw([],s.bH([],R,[0,1,0])),N=s.bH([],z,R),k=[z[0],z[1],z[2],0,N[0],N[1],N[2],0,R[0],R[1],R[2],0,0,0,0,1],U=[C,s.eY(T.lat,T.lng),s.eY(S.lat,T.lng),s.eY(S.lat,S.lng),s.eY(T.lat,S.lng),s.eY(M,T.lng),s.eY(M,S.lng),s.eY(T.lat,E),s.eY(S.lat,E)];let $=s.d8.fromPoints(U.map((be=>[s.bI(z,be),s.bI(N,be),s.bI(R,be)])));const G=s.af([],$.center,k);s.eZ(G)===0&&s.e_(G,0,0,1),s.aw(G,G),s.c4(G,G,s.aD),y.center=s.e$(G);const ee=y.getWorldToCameraMatrix(),Z=s.bk(new Float64Array(16),ee);$=s.d8.applyTransform($,s.aB([],ee,k));const ie=this._extendAABB($,y,x,d);if(!ie)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");$=ie,s.af(G,G,ee);const Q=.5*($.max[2]-$.min[2]),Y=this._minimumAABBFrustumDistance(y,$),re=s.c4([],[0,0,1],Q),_e=s.d7(re,G,re),he=Y+(y.pitch===0?0:s.bF(G,_e)),Ae=y.globeCenterInViewSpace,ve=s.av([],G,[Ae[0],Ae[1],Ae[2]]);s.aw(ve,ve),s.c4(ve,ve,he);const ze=s.d7([],G,ve);s.af(ze,ze,Z);const Xe=s.eL/s.aD,xe=s.ag(ze),ce=s.ce(Math.max(xe*Xe-s.eL,Number.EPSILON),0),Le=Math.min(y.zoomFromMercatorZAdjusted(ce),x.maxZoom);return Le>.5*(s.cZ+s.cK)?(y.setProjection({name:"mercator"}),y.zoom=Le,this._cameraForBounds(y,n,c,d,p,m)):{center:y.center,zoom:Le,bearing:d,pitch:p}}_extendAABB(t,n,c,d){const p=.5*((c.padding.left||0)+(c.padding.right||0)),m=.5*((c.padding.top||0)+(c.padding.bottom||0)),y=m,x=p,T=p,S=m,M=n.width-(x+T),E=n.height-(y+S),C=s.av([],t.max,t.min),R=Math.min(M/C[0],E/C[1]),z=Math.min(n.scaleZoom(n.scale*R),c.maxZoom);if(isNaN(z))return null;const N=n.scale/n.zoomScale(z),k=new s.d8([t.min[0]-x*N,t.min[1]-S*N,t.min[2]],[t.max[0]+T*N,t.max[1]+y*N,t.max[2]]),U=(typeof c.offset.x=="number"&&typeof c.offset.y=="number"?new s.P(c.offset.x,c.offset.y):s.P.convert(c.offset)).rotate(-s.an(d));return k.center[0]-=U.x*N,k.center[1]+=U.y*N,k}queryTerrainElevation(t,n){const c=this.transform.elevation;return c?(n=Object.assign({},{exaggerated:!0},n),c.getAtPoint(s.ae.fromLngLat(t),null,n.exaggerated)):null}_cameraForBounds(t,n,c,d,p,m){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,n,c,d,p,m);const y=t.clone(),x=this._extendCameraOptions(m);y.bearing=d,y.pitch=p;const T=s.aS.convert(n),S=s.aS.convert(c),M=new s.aS(T.lng,S.lat),E=new s.aS(S.lng,T.lat),C=y.project(T),R=y.project(S),z=this.queryTerrainElevation(T),N=this.queryTerrainElevation(S),k=this.queryTerrainElevation(M),U=this.queryTerrainElevation(E),$=[[C.x,C.y,Math.min(z||0,N||0,k||0,U||0)],[R.x,R.y,Math.max(z||0,N||0,k||0,U||0)]];let G=s.d8.fromPoints($);const ee=y.getWorldToCameraMatrix(),Z=s.bk(new Float64Array(16),ee);G=s.d8.applyTransform(G,ee);const ie=this._extendAABB(G,y,x,d);if(!ie)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");G=ie;const Q=.5*s.av([],G.max,G.min)[2],Y=this._minimumAABBFrustumDistance(y,G),re=[0,0,1,0];s.aC(re,re,ee),s.f0(re,re);const _e=s.c4([],re,Y+Q),he=s.d7([],G.center,_e);s.af(G.center,G.center,Z),s.af(he,he,Z);const Ae=y.unproject(new s.P(G.center[0],G.center[1])),ve=s.f1(y.projection,Ae),ze=Math.pow(2,ve),Xe=Math.min(y._zoomFromMercatorZ(he[2]*y.pixelsPerMeter*ze/y.worldSize),x.maxZoom);return y.mercatorFromTransition&&Xe<.5*(s.cZ+s.cK)?(y.setProjection({name:"globe"}),y.zoom=Xe,this._cameraForBounds(y,n,c,d,p,m)):{center:Ae,zoom:Xe,bearing:d,pitch:p}}fitBounds(t,n,c){const d=this.cameraForBounds(t,n);return this._fitInternal(d,n,c)}fitScreenCoordinates(t,n,c,d,p){const m=s.P.convert(t),y=s.P.convert(n),x=new s.P(Math.min(m.x,y.x),Math.min(m.y,y.y)),T=new s.P(Math.max(m.x,y.x),Math.max(m.y,y.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(m,y))return this;const S=this.transform.pointLocation3D(x),M=this.transform.pointLocation3D(T),E=this.transform.pointLocation3D(new s.P(x.x,T.y)),C=this.transform.pointLocation3D(new s.P(T.x,x.y)),R=[Math.min(S.lng,M.lng,E.lng,C.lng),Math.min(S.lat,M.lat,E.lat,C.lat)],z=[Math.max(S.lng,M.lng,E.lng,C.lng),Math.max(S.lat,M.lat,E.lat,C.lat)],N=d&&d.pitch?d.pitch:this.getPitch(),k=this._cameraForBounds(this.transform,R,z,c,N,d);return this._fitInternal(k,d,p)}_fitInternal(t,n,c){return t?(n=Object.assign(t,n)).linear?this.easeTo(n,c):this.flyTo(n,c):this}jumpTo(t,n){this.stop();const c=t.preloadOnly?this.transform.clone():this.transform;let d=!1,p=!1,m=!1;"zoom"in t&&c.zoom!==+t.zoom&&(d=!0,c.zoom=+t.zoom),t.center!==void 0&&(c.center=s.aS.convert(t.center)),"bearing"in t&&c.bearing!==+t.bearing&&(p=!0,c.bearing=+t.bearing),"pitch"in t&&c.pitch!==+t.pitch&&(m=!0,c.pitch=+t.pitch);const y=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!c.isPaddingEqual(y))if(t.retainPadding===!1){const x=c.clone();x.padding=y,c.setLocationAtPoint(c.center,x.centerPoint)}else c.padding=y;return t.preloadOnly?(this._preloadTiles(c),this):(this.fire(new s.z("movestart",n)).fire(new s.z("move",n)),d&&this.fire(new s.z("zoomstart",n)).fire(new s.z("zoom",n)).fire(new s.z("zoomend",n)),p&&this.fire(new s.z("rotatestart",n)).fire(new s.z("rotate",n)).fire(new s.z("rotateend",n)),m&&this.fire(new s.z("pitchstart",n)).fire(new s.z("pitch",n)).fire(new s.z("pitchend",n)),this.fire(new s.z("moveend",n)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||s.w(Qr),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,n){const c=this.transform;if(!c.projection.supportsFreeCamera)return s.w(Qr),this;this.stop();const d=c.zoom,p=c.pitch,m=c.bearing;c.setFreeCameraOptions(t);const y=d!==c.zoom,x=p!==c.pitch,T=m!==c.bearing;return this.fire(new s.z("movestart",n)).fire(new s.z("move",n)),y&&this.fire(new s.z("zoomstart",n)).fire(new s.z("zoom",n)).fire(new s.z("zoomend",n)),T&&this.fire(new s.z("rotatestart",n)).fire(new s.z("rotate",n)).fire(new s.z("rotateend",n)),x&&this.fire(new s.z("pitchstart",n)).fire(new s.z("pitch",n)).fire(new s.z("pitchend",n)),this.fire(new s.z("moveend",n)),this}easeTo(t,n){this._stop(!1,t.easeId),((t=Object.assign({offset:[0,0],duration:500,easing:s.eU},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const c=this.transform,d=this.getZoom(),p=this.getBearing(),m=this.getPitch(),y=this.getPadding(),x="zoom"in t?+t.zoom:d,T="bearing"in t?this._normalizeBearing(t.bearing,p):p,S="pitch"in t?+t.pitch:m,M=this._extendPadding(t.padding),E=s.P.convert(t.offset);let C,R,z;if(c.projection.name==="globe"){const re=s.ae.fromLngLat(c.center),_e=E.rotate(-c.angle);re.x+=_e.x/c.worldSize,re.y+=_e.y/c.worldSize;const he=re.toLngLat(),Ae=s.aS.convert(t.center||he);this._normalizeCenter(Ae),C=c.centerPoint.add(_e),R=new s.P(re.x,re.y).mult(c.worldSize),z=new s.P(s.aF(Ae.lng),s.aJ(Ae.lat)).mult(c.worldSize).sub(R)}else{C=c.centerPoint.add(E);const re=c.pointLocation(C),_e=s.aS.convert(t.center||re);this._normalizeCenter(_e),R=c.project(re),z=c.project(_e).sub(R)}const N=c.zoomScale(x-d);let k,U;t.around&&(k=s.aS.convert(t.around),U=c.locationPoint(k));const $=this._zooming||x!==d,G=this._rotating||p!==T,ee=this._pitching||S!==m,Z=!c.isPaddingEqual(M),ie=t.retainPadding===!1?c.clone():c,Q=re=>_e=>{if($&&(re.zoom=s.ak(d,x,_e)),G&&(re.bearing=s.ak(p,T,_e)),ee&&(re.pitch=s.ak(m,S,_e)),Z&&(ie.interpolatePadding(y,M,_e),C=ie.centerPoint.add(E)),k)re.setLocationAtPoint(k,U);else{const he=re.zoomScale(re.zoom-d),Ae=x>d?Math.min(2,N):Math.max(.5,N),ve=Math.pow(Ae,1-_e),ze=re.unproject(R.add(z.mult(_e*ve)).mult(he));re.setLocationAtPoint(re.renderWorldCopies?ze.wrap():ze,C)}return t.preloadOnly||this._fireMoveEvents(n),re};if(t.preloadOnly){const re=this._emulate(Q,t.duration,c);return this._preloadTiles(re),this}const Y={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=$,this._rotating=G,this._pitching=ee,this._padding=Z,this._easeId=t.easeId,this._prepareEase(n,t.noMoveStart,Y),this._ease(Q(c),(re=>{c.cameraElevationReference==="sea"&&c.recenterOnTerrain(),this._afterEase(n,re)}),t),this}_prepareEase(t,n,c={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),n||c.moving||this.fire(new s.z("movestart",t)),this._zooming&&!c.zooming&&this.fire(new s.z("zoomstart",t)),this._rotating&&!c.rotating&&this.fire(new s.z("rotatestart",t)),this._pitching&&!c.pitching&&this.fire(new s.z("pitchstart",t))}_fireMoveEvents(t){this.fire(new s.z("move",t)),this._zooming&&this.fire(new s.z("zoom",t)),this._rotating&&this.fire(new s.z("rotate",t)),this._pitching&&this.fire(new s.z("pitch",t))}_afterEase(t,n){if(this._easeId&&n&&this._easeId===n)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const c=this._zooming,d=this._rotating,p=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,c&&this.fire(new s.z("zoomend",t)),d&&this.fire(new s.z("rotateend",t)),p&&this.fire(new s.z("pitchend",t)),this.fire(new s.z("moveend",t))}flyTo(t,n){if(this._prefersReducedMotion(t)){const be=s.aH(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(be,n)}this.stop(),t=Object.assign({offset:[0,0],speed:1.2,curve:1.42,easing:s.eU},t);const c=this.transform,d=this.getZoom(),p=this.getBearing(),m=this.getPitch(),y=this.getPadding(),x="zoom"in t?s.aA(+t.zoom,c.minZoom,c.maxZoom):d,T="bearing"in t?this._normalizeBearing(t.bearing,p):p,S="pitch"in t?+t.pitch:m,M=this._extendPadding(t.padding),E=c.zoomScale(x-d),C=s.P.convert(t.offset);let R=c.centerPoint.add(C);const z=c.pointLocation(R),N=s.aS.convert(t.center||z);this._normalizeCenter(N);const k=c.project(z),U=c.project(N).sub(k);let $=t.curve;const G=Math.max(c.width,c.height),ee=G/E,Z=U.mag();if("minZoom"in t){const be=s.aA(Math.min(t.minZoom,d,x),c.minZoom,c.maxZoom),Ve=G/c.zoomScale(be-d);$=Math.sqrt(Ve/Z*2)}const ie=$*$;function Q(be){const Ve=(ee*ee-G*G+(be?-1:1)*ie*ie*Z*Z)/(2*(be?ee:G)*ie*Z);return Math.log(Math.sqrt(Ve*Ve+1)-Ve)}function Y(be){return(Math.exp(be)-Math.exp(-be))/2}function re(be){return(Math.exp(be)+Math.exp(-be))/2}const _e=Q(0);let he=function(be){return re(_e)/re(_e+$*be)},Ae=function(be){return G*((re(_e)*(Y(Ve=_e+$*be)/re(Ve))-Y(_e))/ie)/Z;var Ve},ve=(Q(1)-_e)/$;if(Math.abs(Z)<1e-6||!isFinite(ve)){if(Math.abs(G-ee)<1e-6)return this.easeTo(t,n);const be=ee<G?-1:1;ve=Math.abs(Math.log(ee/G))/$,Ae=function(){return 0},he=function(Ve){return Math.exp(be*$*Ve)}}t.duration="duration"in t?+t.duration:1e3*ve/("screenSpeed"in t?+t.screenSpeed/$:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const ze=p!==T,Xe=S!==m,xe=!c.isPaddingEqual(M),ce=t.retainPadding===!1?c.clone():c,Le=be=>Ve=>{const Qe=Ve*ve,mt=1/he(Qe);be.zoom=Ve===1?x:d+be.scaleZoom(mt),ze&&(be.bearing=s.ak(p,T,Ve)),Xe&&(be.pitch=s.ak(m,S,Ve)),xe&&(ce.interpolatePadding(y,M,Ve),R=ce.centerPoint.add(C));const $e=Ve===1?N:be.unproject(k.add(U.mult(Ae(Qe))).mult(mt));return be.setLocationAtPoint(be.renderWorldCopies?$e.wrap():$e,R),be._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(n),be};if(t.preloadOnly){const be=this._emulate(Le,t.duration,c);return this._preloadTiles(be),this}return this._zooming=!0,this._rotating=ze,this._pitching=Xe,this._padding=xe,this._prepareEase(n,!1),this._ease(Le(c),(()=>this._afterEase(n)),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,n){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const c=this._onEaseEnd;this._onEaseEnd=void 0,c.call(this,n)}if(!t){const c=this.handlers;c&&c.stop(!1)}return this}_ease(t,n,c){c.animate===!1||c.duration===0?(t(1),n()):(this._easeStart=s.o.now(),this._easeOptions=c,this._onEaseFrame=t,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((s.o.now()-this._easeStart)/this._easeOptions.duration,1),n=this._onEaseFrame;n&&n(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,n){t=s.bS(t,-180,180);const c=Math.abs(t-n);return Math.abs(t-360-n)<c&&(t-=360),Math.abs(t+360-n)<c&&(t+=360),t}_normalizeCenter(t){const n=this.transform;if(n.maxBounds||n.projection.name!=="globe"&&!n.renderWorldCopies)return;const c=t.lng-n.center.lng;t.lng+=c>180?-360:c<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&s.o.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,n,c){const d=Math.ceil(15*n/1e3),p=[],m=t(c.clone());for(let y=0;y<=d;y++){const x=m(y/d);p.push(x.clone())}return p}_preloadTiles(t,n){}}class yl{constructor(t={}){this.options=t,s.aX(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const n=this.options&&this.options.compact,c=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=Tt("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=Tt("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",c);const d=Tt("span","mapboxgl-ctrl-icon",this._compactButton);return d.setAttribute("aria-hidden","true"),d.setAttribute("title",c),this._innerContainer=Tt("div","mapboxgl-ctrl-attrib-inner",this._container),n&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),n===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const n=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||s.e.ACCESS_TOKEN}];if(t){const c=n.reduce(((d,p,m)=>(p.value&&(d+="".concat(p.key,"=").concat(p.value).concat(m<n.length-1?"&":"")),d)),"?");t.href="".concat(s.e.FEEDBACK_URL,"/").concat(c,"#").concat(Tu(this._map,!0)),t.rel="noopener nofollow"}}_updateData(t){!t||(t.dataType!=="source"||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility")&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const d=this._map.style.stylesheet;this.styleOwner=d.owner,this.styleId=d.id}const n=this._map.style._mergedSourceCaches;for(const d in n){const p=n[d];if(p.used){const m=p.getSource();m.attribution&&t.indexOf(m.attribution)<0&&t.push(m.attribution)}}t.sort(((d,p)=>d.length-p.length)),t=t.filter(((d,p)=>{for(let m=p+1;m<t.length;m++)if(t[m].indexOf(d)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const c=t.join(" | ");c!==this._attribHTML&&(this._attribHTML=c,t.length?(this._innerContainer.innerHTML=c,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class yc{constructor(){s.aX(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=Tt("div","mapboxgl-ctrl");const n=Tt("a","mapboxgl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://www.mapbox.com/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const n in t){const c=t[n].getSource();if(c.hasOwnProperty("mapbox_logo")&&!c.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const n=t[0];this._map.getCanvasContainer().offsetWidth<250?n.classList.add("mapboxgl-compact"):n.classList.remove("mapboxgl-compact")}}}class yd{constructor(){s.aX(["_onIndoorUpdate"],this)}onAdd(t){return this._map=t,this._container=Tt("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("selector-update",(n=>this._onIndoorUpdate(n))),this._container}_createButton(t,n){const c=Tt("button",t,this._container);return c.type="button",c.addEventListener("click",n),c}_createSeparator(){return Tt("div","mapboxgl-ctrl-separator",this._container)}_setButtonTitle(t,n){this._map&&(t.setAttribute("aria-label",n),t.textContent=n)}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("selector-update",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(t){if(!t||!t.floors)return this._model=t,void(this._container.style.display="none");const n=this._model;this._model=t,this._container.style.display="inline-block",this._container.style.borderRadius="8px",n&&Array.from(this._container.children).forEach((c=>c.remove())),t.floors.length>0&&(this.addBuildingsToggleButton(),this.addCurrentFloors(t.floors,t.activeFloorsVisible),this._updateBuildingsButtonState())}addBuildingsToggleButton(){const t=this._createButton("mapboxgl-ctrl-buildings-toggle",(()=>{const n=this._map;this._model&&n&&n._setIndoorActiveFloorsVisibility(!this._model.activeFloorsVisible)}));Tt("span","mapboxgl-ctrl-icon",t).setAttribute("aria-hidden","true"),t.classList.add("mapboxgl-ctrl-level-button","mapboxgl-ctrl-buildings-toggle"),this._model&&!this._model.activeFloorsVisible&&t.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(t),this._createSeparator()}_updateBuildingsButtonState(){const t=this._container.querySelector(".mapboxgl-ctrl-buildings-toggle");t&&this._model&&(this._model.activeFloorsVisible?t.classList.remove("mapboxgl-ctrl-level-button-selected"):t.classList.add("mapboxgl-ctrl-level-button-selected"))}addCurrentFloors(t,n){for(let c=0;c<t.length;c++){const d=t[c],p=this._createButton("mapboxgl-ctrl-level-button",(()=>{this._map._selectIndoorFloor(d.id)}));this._setButtonTitle(p,d.zIndex.toString()),this._model&&d.id===this._model.selectedFloorId&&n&&p.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(p),c<t.length-1&&this._createSeparator()}}}class dp{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const n=++this._id;return this._queue.push({callback:t,id:n,cancelled:!1}),n}remove(t){const n=this._currentlyRunning,c=n?this._queue.concat(n):this._queue;for(const d of c)if(d.id===t)return void(d.cancelled=!0)}run(t=0){const n=this._currentlyRunning=this._queue;this._queue=[];for(const c of n)if(!c.cancelled&&(c.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class xc{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const n=s.dC((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-n)+this._end*n}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,n,c){this._start=this.getValue(n),this._end=t,this._startTime=n,this._endTime=n+c}}const Km={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class fp extends s.z{constructor(t,n,c,d){const{point:p,lngLat:m,originalEvent:y,target:x}=t;super(t.type,{point:p,lngLat:m,originalEvent:y,target:x}),this.preventDefault=()=>{t.preventDefault()},this.id=n,this.interaction=c,this.feature=d}}class xd{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,n){if(this.typeById.has(t))throw new Error('Interaction id "'.concat(t,'" already exists.'));const c=n.filter;let d=n.type;c&&this.filters.set(t,s.b5(c)),d==="mouseover"&&(d="mouseenter"),d==="mouseout"&&(d="mouseleave");const p=this.interactionsByType.get(d)||new Map;d==="mouseenter"||d==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,n)):p.size===0&&this.map.on(d,this.handleType),p.size===0&&this.interactionsByType.set(d,p),p.set(t,n),this.typeById.set(t,d)}get(t){const n=this.typeById.get(t);if(!n)return;const c=this.interactionsByType.get(n);return c?c.get(t):void 0}remove(t){const n=this.typeById.get(t);if(!n)return;this.typeById.delete(t),this.filters.delete(t);const c=this.interactionsByType.get(n);c&&(c.delete(t),n==="mouseenter"||n==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):c.size===0&&this.map.off(n,this.handleType))}queryTargets(t,n){const c=[];for(const[d,p]of n)p.target&&c.push({targetId:d,target:p.target,filter:this.filters.get(d)});return this.map.style.queryRenderedTargets(t,c,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const n=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());n.length&&(t.type="mouseenter",this.handleType(t,n));const c=new Map;for(const[d,{feature:p}]of this.prevHoveredFeatures)this.hoveredFeatures.has(d)||c.set(p.id,p);c.size&&(t.type="mouseleave",this.handleType(t,Array.from(c.values())))}handleOut(t){const n=Array.from(this.hoveredFeatures.values()).map((({feature:c})=>c));n.length&&(t.type="mouseleave",this.handleType(t,n)),this.hoveredFeatures.clear()}handleType(t,n){const c=t.type==="mouseenter";if(c&&!this.interactionsByType.has(t.type))return void s.w("mouseenter interaction required for mouseleave to work.");const d=Array.from(this.interactionsByType.get(t.type)).reverse(),p=!!n;n=n||this.queryTargets(t.point,d);let m=!1;const y=new Set;for(const x of n){for(const[T,S]of d){if(!S.target)continue;const M=x.variants?x.variants[T]:null;if(M){for(const E of M){if(wo(E,x,y,T))continue;const C=new s.dw(x,E),R=fs(E,x,T);p&&C.id!==void 0&&(C.state=this.map.getFeatureState(C));const z=c?this.prevHoveredFeatures.get(R):null,N=new fp(t,T,S,C),k=z?z.stop:S.handler(N);if(c&&this.hoveredFeatures.set(R,{feature:x,stop:k}),k!==!1){m=!0;break}}if(m)break}}if(m)break}if(!m)for(const[x,T]of d){const{handler:S,target:M}=T;if(!M&&S(new fp(t,x,T,null))!==!1)break}}}function vd(l,t){if(Array.isArray(l)&&Array.isArray(t)){const n=new Set(l),c=new Set(t);return n.size===c.size&&l.every((d=>c.has(d)))}return s.bx(l,t)}const Du={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},zu={showCompass:!0,showZoom:!0,visualizePitch:!1};class vc{constructor(t,n,c=!1){this._clickTolerance=10,this.element=n,this.mouseRotate=new Au({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,c&&(this.mousePitch=new pd({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),s.aX(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),n.addEventListener("mousedown",this.mousedown),n.addEventListener("touchstart",this.touchstart,{passive:!1}),n.addEventListener("touchmove",this.touchmove),n.addEventListener("touchend",this.touchend),n.addEventListener("touchcancel",this.reset)}down(t,n){this.mouseRotate.mousedown(t,n),this.mousePitch&&this.mousePitch.mousedown(t,n),Ci()}move(t,n){const c=this.map,d=this.mouseRotate.mousemoveWindow(t,n),p=d&&d.bearingDelta;if(p&&c.setBearing(c.getBearing()+p),this.mousePitch){const m=this.mousePitch.mousemoveWindow(t,n),y=m&&m.pitchDelta;y&&c.setPitch(c.getPitch()+y)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){tr(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(Object.assign({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),Si(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,Si(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=hr(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=hr(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Us(l,t,n){if(l=new s.aS(l.lng,l.lat),t){const c=new s.aS(l.lng-360,l.lat),d=new s.aS(l.lng+360,l.lat),p=360*Math.ceil(Math.abs(l.lng-n.center.lng)/360),m=n.locationPoint3D(l).distSqr(t),y=t.x<0||t.y<0||t.x>n.width||t.y>n.height;n.locationPoint3D(c).distSqr(t)<m&&(y||Math.abs(c.lng-n.center.lng)<p)?l=c:n.locationPoint3D(d).distSqr(t)<m&&(y||Math.abs(d.lng-n.center.lng)<p)&&(l=d)}for(;Math.abs(l.lng-n.center.lng)>180;){const c=n.locationPoint3D(l);if(c.x>=0&&c.y>=0&&c.x<=n.width&&c.y<=n.height)break;l.lng>n.center.lng?l.lng-=360:l.lng+=360}return l}const ms={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},jn={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class js extends s.E{constructor(t,n){super(),(t instanceof HTMLElement||n)&&(t=Object.assign({element:t},n)),s.aX(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:c="center",color:d="#3FB1CE",scale:p=1,draggable:m=!1,clickTolerance:y=0,rotation:x=jn.rotation,rotationAlignment:T=jn.rotationAlignment,pitchAlignment:S=jn.pitchAlignment,occludedOpacity:M=jn.occludedOpacity,altitude:E=jn.altitude}=t||{};this._anchor=c,this._color=d,this._scale=p,this._draggable=m,this._clickTolerance=y,this._rotation=x,this._rotationAlignment=T,this._pitchAlignment=S,this._occludedOpacity=M,this._altitude=E,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=s.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=s.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(z=>{z.preventDefault()})),this._element.addEventListener("mousedown",(z=>{z.preventDefault()}));const C=this._element.classList;for(const z in ms)C.remove("mapboxgl-marker-anchor-".concat(z));C.add("mapboxgl-marker-anchor-".concat(this._anchor));const R=t&&t.className?t.className.trim().split(/\s+/):[];C.add(...R),this._popup=null}_createDefaultMarker(){const t=Tt("div"),n=Dt("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){const c=Dt("radialGradient",{id:"shadowGradient"},Dt("defs",{},n));Dt("stop",{offset:"10%","stop-opacity":.4},c),Dt("stop",{offset:"100%","stop-opacity":.05},c),Dt("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},n)}return Dt("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},n),Dt("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},n),Dt("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},n),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=s.aS.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||jn.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const d=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[d,-1*(38.1-13.5+d)],"bottom-right":[-d,-1*(38.1-13.5+d)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const n=t.code,c=t.charCode||t.keyCode;n!=="Space"&&n!=="Enter"&&c!==32&&c!==13||this.togglePopup()}_onMapClick(t){const n=t.originalEvent.target,c=this._element;this._popup&&(n===c||c.contains(n))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,n=this._pos;if(!t||!n)return!1;const c=t.unproject(n,this._altitude),d=t.getFreeCameraOptions();if(!d.position)return!1;const p=d.position.toLngLat();return p.distanceTo(c)<.9*p.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const n=this._pos;if(!n||n.x<0||n.x>t.transform.width||n.y<0||n.y>t.transform.height)return void this._clearFadeTimer();const c=t.unproject(n,this._altitude);let d;t._showingGlobe()&&s.f4(t.transform,this._lngLat)?d=0:(d=1-t._queryFogOpacity(c),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(d*=this._occludedOpacity)),this._element.style.opacity="".concat(d),this._element.style.pointerEvents=d>0?"auto":"none",this._popup&&this._popup._setOpacity(d),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const n=this._offset.mult(this._scale);this._element.style.transform="\n            translate(".concat(t.x,"px,").concat(t.y,"px)\n            ").concat(ms[this._anchor],"\n            ").concat(this._calculateXYTransform()," ").concat(this._calculateZTransform(),"\n            translate(").concat(n.x,"px,").concat(n.y,"px)\n        ")}_calculateXYTransform(){const t=this._pos,n=this._map,c=this.getPitchAlignment();if(!n||!t||c!=="map")return"";if(!n._showingGlobe()){const x=n.getPitch();return x?"rotateX(".concat(x,"deg)"):""}const d=s.cW(s.f5(n.transform,this._lngLat)),p=t.sub(s.f6(n.transform)),m=Math.abs(p.x)+Math.abs(p.y);if(m===0)return"";const y=d/m;return"rotateX(".concat(-p.y*y,"deg) rotateY(").concat(p.x*y,"deg)")}_calculateZTransform(){const t=this._pos,n=this._map;if(!n||!t)return"";let c=0;const d=this.getRotationAlignment();if(d==="map")if(n._showingGlobe()){const p=n.project(new s.aS(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),m=n.project(new s.aS(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(p);c=s.cW(Math.atan2(m.y,m.x))-90}else c=-n.getBearing();else if(d==="horizon"){const p=s.ah(4,6,n.getZoom()),m=s.f6(n.transform);m.y+=p*n.transform.height;const y=t.sub(m),x=s.cW(Math.atan2(y.y,y.x));c=(x>90?x-270:x+90)*(1-p)}return c+=this._rotation,c?"rotateZ(".concat(c,"deg)"):""}_update(t){cancelAnimationFrame(this._updateFrameId);const n=this._map;n&&(n.transform.renderWorldCopies&&(this._lngLat=Us(this._lngLat,this._pos,n.transform)),this._pos=n.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),n._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(n._showingGlobe()||n.getTerrain()||n.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(t){return this._offset=s.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const n=this._map;if(!n)return;const c=this._pointerdownPos,d=this._positionDelta;if(c&&d){if(!this._isDragging){const p=this._clickTolerance||n._clickTolerance;if(t.point.dist(c)<p)return;this._isDragging=!0}this._pos=t.point.sub(d),this._lngLat=n.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.z("dragstart"))),this.fire(new s.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new s.z("dragend")),this._state="inactive"}_addDragHandler(t){const n=this._map,c=this._pos;n&&c&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(c),this._pointerdownPos=t.point,this._state="pending",n.on("mousemove",this._onMove),n.on("touchmove",this._onMove),n.once("mouseup",this._onUp),n.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const n=this._map;return n&&(t?(n.on("mousedown",this._addDragHandler),n.on("touchstart",this._addDragHandler)):(n.off("mousedown",this._addDragHandler),n.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||jn.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||jn.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||jn.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||jn.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const _s={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Jm={maxWidth:100,unit:"metric"},Qm={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},e_={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},t_=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function bd(l=new s.P(0,0),t="bottom"){if(typeof l=="number"){const n=Math.round(Math.sqrt(.5*Math.pow(l,2)));switch(t){case"top":return new s.P(0,l);case"top-left":return new s.P(n,n);case"top-right":return new s.P(-n,n);case"bottom":return new s.P(0,-l);case"bottom-left":return new s.P(n,-n);case"bottom-right":return new s.P(-n,-n);case"left":return new s.P(l,0);case"right":return new s.P(-l,0)}return new s.P(0,0)}return l instanceof s.P||Array.isArray(l)?s.P.convert(l):s.P.convert(l[t]||[0,0])}return{version:et,supported:Vi.supported,setRTLTextPlugin:s.fa,getRTLTextPluginStatus:s.f9,Map:class extends Is{constructor(l){It.mark(nt.create);const t=l;if((l=Object.assign({},Du,l)).minZoom!=null&&l.maxZoom!=null&&l.minZoom>l.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(l.minPitch!=null&&l.maxPitch!=null&&l.minPitch>l.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(l.minPitch!=null&&l.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(l.maxPitch!=null&&l.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(l.antialias&&s.f2(window)&&(l.antialias=!1,s.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new qa(l.minZoom,l.maxZoom,l.minPitch,l.maxPitch,l.renderWorldCopies,null,null),l),this._repaint=!!l.repaint,this._interactive=l.interactive,this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._failIfMajorPerformanceCaveat=l.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=l.preserveDrawingBuffer,this._antialias=l.antialias,this._trackResize=l.trackResize,this._bearingSnap=l.bearingSnap,this._refreshExpiredTiles=l.refreshExpiredTiles,this._fadeDuration=l.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=l.crossSourceCollisions,this._collectResourceTiming=l.collectResourceTiming,this._language=this._parseLanguage(l.language),this._worldview=l.worldview,this._renderTaskQueue=new dp,this._domRenderTaskQueue=new dp,this._controls=[],this._markers=[],this._popups=[],this._mapId=s.b1(),this._locale=Object.assign({},Km,l.locale),this._clickTolerance=l.clickTolerance,this._cooperativeGestures=l.cooperativeGestures,this._performanceMetricsCollection=l.performanceMetricsCollection,this._tessellationStep=l.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=l.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new xc(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=l.scaleFactor,this._requestManager=new On(l.transformRequest,l.accessToken,l.testMode),this._silenceAuthErrors=!!l.testMode,this._contextCreateOptions=l.contextCreateOptions?Object.assign({},l.contextCreateOptions):{},typeof l.container=="string"){const n=document.getElementById(l.container);if(!n)throw new Error("Container '".concat(l.container.toString(),"' not found."));this._container=n}else{if(!(l.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=l.container}if(this._container.childNodes.length>0&&s.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),l.maxBounds&&this.setMaxBounds(l.maxBounds),this._spriteFormat=l.spriteFormat,s.aX(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Hm),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},(()=>{this._update()})),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},(()=>{this.setScaleFactor(this._scaleFactor)})),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Ru(this,l),this._localFontFamily=l.localFontFamily,this._localIdeographFontFamily=l.localIdeographFontFamily,(l.style||!l.testMode)&&this.setStyle(l.style||s.e.DEFAULT_STYLE,{config:l.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),l.projection&&this.setProjection(l.projection),l.hash&&(this._hash=new wu(typeof l.hash=="string"&&l.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:l.center,zoom:l.zoom,bearing:l.bearing,pitch:l.pitch});const n=l.bounds;n&&(this.resize(),this.fitBounds(n,Object.assign({},l.fitBoundsOptions,{duration:0})))}this.resize(),l.attributionControl&&this.addControl(new yl({customAttribution:l.customAttribution})),this._logoControl=new yc,this.addControl(this._logoControl,l.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent(),this._postStyleWithAppearanceEvent(),this._setupIndoor()})),this.on("data",(n=>{this._update(n.dataType==="style"),this.fire(new s.z("".concat(n.dataType,"data"),n))})),this.on("dataloading",(n=>{this.fire(new s.z("".concat(n.dataType,"dataloading"),n))})),this._interactions=new xd(this)}_getMapId(){return this._mapId}addControl(l,t){if(t===void 0&&(t=l.getDefaultPosition?l.getDefaultPosition():"top-right"),!l||!l.onAdd)return this.fire(new s.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=l.onAdd(this);this._controls.push(l);const c=this._controlPositions[t];return t.indexOf("bottom")!==-1?c.insertBefore(n,c.firstChild):c.appendChild(n),this}removeControl(l){if(!l||!l.onRemove)return this.fire(new s.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(l);return t>-1&&this._controls.splice(t,1),l.onRemove(this),this}hasControl(l){return this._controls.indexOf(l)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(l){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new s.z("movestart",l)).fire(new s.z("move",l)),this.fire(new s.z("resize",l)),t&&this.fire(new s.z("moveend",l)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(l){return this.transform.setMaxBounds(s.aI.convert(l)),this._update()}setMinZoom(l){if((l=l!=null?l:-2)>=-2&&l<=this.transform.maxZoom)return this.transform.minZoom=l,this._update(),this.getZoom()<l?this.setZoom(l):this.fire(new s.z("zoomstart")).fire(new s.z("zoom")).fire(new s.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(l){if((l=l!=null?l:22)>=this.transform.minZoom)return this.transform.maxZoom=l,this._update(),this.getZoom()>l?this.setZoom(l):this.fire(new s.z("zoomstart")).fire(new s.z("zoom")).fire(new s.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(l){if((l=l!=null?l:0)<0)throw new Error("minPitch must be greater than or equal to 0");if(l>=0&&l<=this.transform.maxPitch)return this.transform.minPitch=l,this._update(),this.getPitch()<l?this.setPitch(l):this.fire(new s.z("pitchstart")).fire(new s.z("pitch")).fire(new s.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(l){if((l=l!=null?l:85)>85)throw new Error("maxPitch must be less than or equal to 85");if(l>=this.transform.minPitch)return this.transform.maxPitch=l,this._update(),this.getPitch()>l?this.setPitch(l):this.fire(new s.z("pitchstart")).fire(new s.z("pitch")).fire(new s.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(l){return this._scaleFactor=l,this.painter.scaleFactor=l,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers((t=>t.type==="symbol")),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(l){return this.transform.renderWorldCopies=l,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(l){return l==="auto"?navigator.language:Array.isArray(l)?l.length===0?void 0:l.map((t=>t==="auto"?navigator.language:t)):l}setLanguage(l){const t=this._parseLanguage(l);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const n of this._controls)n._setLanguage&&n._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(l){return this.style&&l!==this._worldview?(this._worldview=l,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(l){return this._lazyInitEmptyStyle(),l?typeof l=="string"&&(l={name:l}):l=null,this._useExplicitProjection=!!l,this._prioritizeAndUpdateProjection(l,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const l=this.transform,t=l.projection.name;let n;t==="globe"&&l.zoom>=s.cK?(l.setMercatorFromTransition(),n=!0):t==="mercator"&&l.zoom<s.cK&&(l.setProjection({name:"globe"}),n=!0),n&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(l,t){return this._updateProjection(l||t||{name:"mercator"})}_updateProjection(l){let t;const n=this.transform.mercatorFromTransition;t=l.name==="globe"&&this.transform.zoom>=s.cK?this.transform.setMercatorFromTransition():this.transform.setProjection(l),this.style.applyProjectionUpdate();const c=this.transform.getProjection().name==="mercator"&&n!==this.transform.mercatorFromTransition;return(t||c)&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(l,t){return this.transform.locationPoint3D(s.aS.convert(l),t)}unproject(l,t){return this.transform.pointLocation3D(s.P.convert(l),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(l,t,n){const c=d=>{let p=[];if(Array.isArray(t)){const m=t.filter((y=>this.getLayer(y)));p=m.length?this.queryRenderedFeatures(d,{layers:m}):[]}else p=this.queryRenderedFeatures(d,{target:t});return p};if(l==="mouseenter"||l==="mouseover"){let d=!1;return{listener:n,targets:t,delegates:{mousemove:m=>{const y=c(m.point);y.length?d||(d=!0,n.call(this,new vr(l,this,m.originalEvent,{features:y}))):d=!1},mouseout:()=>{d=!1}}}}if(l==="mouseleave"||l==="mouseout"){let d=!1;return{listener:n,targets:t,delegates:{mousemove:y=>{c(y.point).length?d=!0:d&&(d=!1,n.call(this,new vr(l,this,y.originalEvent)))},mouseout:y=>{d&&(d=!1,n.call(this,new vr(l,this,y.originalEvent)))}}}}{const d=p=>{const m=c(p.point);m.length&&(p.features=m,n.call(this,p),delete p.features)};return{listener:n,targets:t,delegates:{[l]:d}}}}on(l,t,n){if(typeof t=="function"||n===void 0)return super.on(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[l]=this._delegatedListeners[l]||[],this._delegatedListeners[l].push(c);for(const d in c.delegates)this.on(d,c.delegates[d]);return this}once(l,t,n){if(typeof t=="function"||n===void 0)return super.once(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);for(const d in c.delegates)this.once(d,c.delegates[d]);return this}off(l,t,n){if(typeof t=="function"||n===void 0)return super.off(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._delegatedListeners?this._delegatedListeners[l]:void 0;return c&&(d=>{for(let p=0;p<d.length;p++){const m=d[p];if(m.listener===n&&vd(m.targets,t)){for(const y in m.delegates)this.off(y,m.delegates[y]);return d.splice(p,1),this}}})(c),this}queryRenderedFeatures(l,t){if(!this.style)return[];if(l===void 0||l instanceof s.P||Array.isArray(l)||t!==void 0||(t=l,l=void 0),l=l||[[0,0],[this.transform.width,this.transform.height]],!t){const p=this.style.queryRenderedFeatures(l,void 0,this.transform),m=this.style.queryRenderedFeatureset(l,void 0,this.transform);return p.concat(m)}let n=!0;if(t.target&&(n=this._isTargetValid(t.target),n&&!t.layers))return this.style.queryRenderedFeatureset(l,t,this.transform);let c=!0;if(t.layers&&Array.isArray(t.layers)){for(const p of t.layers)if(!this._isValidId(p)){c=!1;break}if(c&&!t.target)return this.style.queryRenderedFeatures(l,t,this.transform)}let d=[];return c&&(d=d.concat(this.style.queryRenderedFeatures(l,t,this.transform))),n&&(d=d.concat(this.style.queryRenderedFeatureset(l,t,this.transform))),d}querySourceFeatures(l,t){return!l||typeof l=="string"&&!this._isValidId(l)?[]:this.style.querySourceFeatures(l,t)}queryRasterValue(l,t,n){return this._isValidId(l)?this.style.queryRasterValue(l,t,n):Promise.resolve(null)}isPointOnSurface(l){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&s.w("".concat(t," projection does not support isPointOnSurface, this API may behave unexpectedly.")),this.transform.isPointOnSurface(s.P.convert(l))}addInteraction(l,t){return this._interactions.add(l,t),this}removeInteraction(l){return this._interactions.remove(l),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(l){return this._cooperativeGestures=l,this}setStyle(l,t){return t=Object.assign({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&l&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(l,((n,c)=>{if(n){const d=typeof n=="string"?n:n instanceof Error?n.message:n.error;s.w("Unable to perform style diff: ".concat(d,". Rebuilding the style from scratch.")),this._updateStyle(l,t)}else c&&this._update(!0)}),(()=>this._postStyleLoadEvent())),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(l,t))}_getUIString(l){const t=this._locale[l];if(t==null)throw new Error("Missing UI string '".concat(l,"'"));return t}_updateStyle(l,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),l){const n=Object.assign({},t);t&&t.config&&(n.initialConfig=t.config,delete n.config),this.style=new rs(this,n).load(l),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new rs(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(s.w("There is no style added to the map."),!1)}_isValidId(l){return l==null?(this.fire(new s.y(new Error("IDs can't be empty."))),!1):!s.dq(l)||(this.fire(new s.y(new Error("IDs can't contain special symbols: \"".concat(l,'".')))),!1)}_isTargetValid(l){return"featuresetId"in l?this._isValidId("importId"in l?l.importId:l.featuresetId):"layerId"in l&&this._isValidId(l.layerId)}_areTargetsValid(l){if(Array.isArray(l)){for(const t of l)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(l)}addSource(l,t){return this._isValidId(l)?(this._lazyInitEmptyStyle(),this.style.addSource(l,t),this._update(!0)):this}isSourceLoaded(l){return!!this._isValidId(l)&&!!this.style&&this.style._isSourceCacheLoaded(l)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(l,t,n){this._lazyInitEmptyStyle(),this.style.addSourceType(l,t,n)}removeSource(l){return this._isValidId(l)?(this.style.removeSource(l),this._updateTerrain(),this._update(!0)):this}getSource(l){return this._isValidId(l)?this.style.getOwnSource(l):null}addImage(l,t,{pixelRatio:n=1,sdf:c=!1,stretchX:d,stretchY:p,content:m}={}){this._lazyInitEmptyStyle();const y=s.I.from(l);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){const{width:x,height:T,data:S}=s.o.getImageData(t);this.style.addImage(y,{data:new s.q({width:x,height:T},S),pixelRatio:n,stretchX:d,stretchY:p,content:m,sdf:c,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new s.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:x,height:T}=t,S=t;this.style.addImage(y,{data:new s.q({width:x,height:T},new Uint8Array(S.data)),pixelRatio:n,stretchX:d,stretchY:p,content:m,sdf:c,usvg:!1,version:0,userImage:S}),S.onAdd&&S.onAdd(this,l)}}updateImage(l,t){this._lazyInitEmptyStyle();const n=s.I.from(l),c=this.style.getImage(n);if(!c)return void this.fire(new s.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const d=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?s.o.getImageData(t):t,{width:p,height:m,data:y}=d;if(p===void 0||m===void 0)return void this.fire(new s.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(p!==(c.usvg?c.icon.usvg_tree.width:c.data.width)||m!==(c.usvg?c.icon.usvg_tree.height:c.data.height))return void this.fire(new s.y(new Error("The width and height of the updated image (".concat(p,", ").concat(m,")\n                must be that same as the previous version of the image\n                (").concat(c.data.width,", ").concat(c.data.height,")"))));const x=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap);let T=!1;c.usvg?(c.data=new s.q({width:p,height:m},new Uint8Array(y)),c.usvg=!1,c.icon=void 0,T=!0):c.data.replace(y,x),this.style.updateImage(n,c,T)}hasImage(l){return l?!!this.style&&!!this.style.getImage(s.I.from(l)):(this.fire(new s.y(new Error("Missing required image id"))),!1)}removeImage(l){this.style.removeImage(s.I.from(l))}loadImage(l,t){s.n(this._requestManager.transformRequest(l,s.R.Image),((n,c)=>{t(n,c instanceof HTMLImageElement?s.o.getImageData(c):c)}))}listImages(){return this.style.listImages().map((l=>l.name))}addModel(l,t){this._lazyInitEmptyStyle(),this.style.addModel(l,t)}hasModel(l){return l?this.style.hasModel(l):(this.fire(new s.y(new Error("Missing required model id"))),!1)}removeModel(l){this.style.removeModel(l)}listModels(){return this.style.listModels()}addLayer(l,t){return this._isValidId(l.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(l,t),this._update(!0)):this}getSlot(l){const t=this.getLayer(l);return t&&t.slot||null}setSlot(l,t){return this.style.setSlot(l,t),this.style.mergeLayers(),this._update(!0)}addImport(l,t){return this.style.addImport(l,t).catch((n=>this.fire(new s.y(new Error("Failed to add import",n))))),this}updateImport(l,t){return typeof t!="string"&&t.id!==l?(this.removeImport(l),this.addImport(t)):(this.style.updateImport(l,t),this._update(!0))}removeImport(l){return this.style.removeImport(l),this}moveImport(l,t){return this.style.moveImport(l,t),this._update(!0)}moveLayer(l,t){return this._isValidId(l)?(this.style.moveLayer(l,t),this._update(!0)):this}removeLayer(l){return this._isValidId(l)?(this.style.removeLayer(l),this._update(!0)):this}getLayer(l){if(!this._isValidId(l))return null;const t=this.style.getOwnLayer(l);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(l,t,n){return this._isValidId(l)?(this.style.setLayerZoomRange(l,t,n),this._update(!0)):this}setFilter(l,t,n={}){return this._isValidId(l)?(this.style.setFilter(l,t,n),this._update(!0)):this}getFilter(l){return this._isValidId(l)?this.style.getFilter(l):null}setPaintProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setPaintProperty(l,t,n,c),this._update(!0)):this}getPaintProperty(l,t){return this._isValidId(l)?this.style.getPaintProperty(l,t):null}setLayoutProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setLayoutProperty(l,t,n,c),this._update(!0)):this}getLayoutProperty(l,t){return this._isValidId(l)?this.style.getLayoutProperty(l,t):null}setLayerProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setLayerProperty(l,t,n,c),this._update(!0)):this}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(l){return this.style.setGlyphsUrl(l),this._update(!0)}getSchema(l){return this.style.getSchema(l)}setSchema(l,t){return this.style.setSchema(l,t),this._update(!0)}getConfig(l){return this.style.getConfig(l)}setConfig(l,t){return this.style.setConfig(l,t),this._update(!0)}getConfigProperty(l,t){return this.style.getConfigProperty(l,t)}setConfigProperty(l,t,n){return this.style.setConfigProperty(l,t,n),this._update(!0)}getFeaturesetDescriptors(l){return this.style.getFeaturesetDescriptors(l)}setLights(l){if(this._lazyInitEmptyStyle(),l&&l.length===1&&l[0].type==="flat"){const t=l[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(l),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const l=this.style.getLights()||[];return l.length===0&&l.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),l}setLight(l,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:l}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(l){return this._lazyInitEmptyStyle(),!l&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(l),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(l){return this._lazyInitEmptyStyle(),this.style.setFog(l),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(l){return this._lazyInitEmptyStyle(),this.style.setSnow(l),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(l){return this._lazyInitEmptyStyle(),this.style.setRain(l),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(l){return this._lazyInitEmptyStyle(),this.style.setColorTheme(l),this._update(!0)}setImportColorTheme(l,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(l,t),this._update(!0)}setCamera(l){return this.style.setCamera(l),this._triggerCameraUpdate(l)}_triggerCameraUpdate(l){return this._update(this.transform.setOrthographicProjectionAtLowPitch(l["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(l){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(s.aS.convert(l),this.transform):0}setFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.setFeatureState(l,t),this._update())}removeFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.removeFeatureState(l,t),this._update())}getFeatureState(l){return l.source&&!this._isValidId(l.source)?null:this.style.getFeatureState(l)}_selectIndoorFloor(l){this.indoor.selectFloor(l)}_setIndoorActiveFloorsVisibility(l){this.indoor.setActiveFloorsVisibility(l)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new yd),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;const l=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let n,c,d,p=this._container;for(;p&&(!c||!d);){const m=window.getComputedStyle(p).transform;m&&m!=="none"&&(n=m.match(/matrix.*\((.+)\)/)[1].split(", "),n[0]&&n[0]!=="0"&&n[0]!=="1"&&(c=n[0]),n[3]&&n[3]!=="0"&&n[3]!=="1"&&(d=n[3])),p=p.parentElement}this._containerWidth=c?Math.abs(l/c):l,this._containerHeight=d?Math.abs(t/d):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&s.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupIndoor(){this.style.isIndoorEnabled()&&(this.indoor=new wa(this.style),this.on("load",(()=>{this._addIndoorControl(),this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds()),this.on("move",(()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())})),this.on("idle",(()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())}))})))}_setupContainer(){const l=this._container;l.classList.add("mapboxgl-map"),(this._missingCSSCanary=Tt("div","mapboxgl-canary",l)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=Tt("div","mapboxgl-canvas-container",l);this._canvas=Tt("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const n=this._controlContainer=Tt("div","mapboxgl-control-container",l),c=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach((d=>{c[d]=Tt("div","mapboxgl-ctrl-".concat(d),n)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(l,t){const n=s.o.devicePixelRatio||1;this._canvas.width=n*Math.ceil(l),this._canvas.height=n*Math.ceil(t),this._canvas.style.width="".concat(l,"px"),this._canvas.style.height="".concat(t,"px")}_addMarker(l){this._markers.push(l)}_removeMarker(l){const t=this._markers.indexOf(l);t!==-1&&this._markers.splice(t,1)}_addPopup(l){this._popups.push(l)}_removePopup(l){const t=this._popups.indexOf(l);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const l=Object.assign({},Vi.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",l);t?(kn(t,!0),this.painter=new sa(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",(n=>{n.dataType==="source"&&this.painter.setTileLoadedFlag(!0)})),s.k.testSupport(t)):this.fire(new s.y(new Error("Failed to initialize WebGL")))}_contextLost(l){l.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new s.z("webglcontextlost",{originalEvent:l}))}_contextRestored(l){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new s.z("webglcontextrestored",{originalEvent:l}))}_onMapScroll(l){if(l.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(l){return this.style?(this._styleDirty=this._styleDirty||l,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(l){return this._update(),this._renderTaskQueue.add(l)}_cancelRenderFrame(l){this._renderTaskQueue.remove(l)}_requestDomTask(l){!this.loaded()||this.loaded()&&!this.isMoving()?l():this._domRenderTaskQueue.add(l)}_render(l){let t;this.fire(new s.z("renderstart")),++this._frameId;const n=this.painter.context.extTimerQuery,c=s.o.now(),d=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=d.createQuery(),d.beginQuery(n.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(l),this._domRenderTaskQueue.run(l),this._removed)return;this._updateProjectionTransition();const p=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const T=this.transform.zoom,S=this.transform.pitch,M=s.o.now(),E=new s.ac(T,{now:M,fadeDuration:p,pitch:S,transition:this.style.transition,worldview:this._worldview});this.style.update(E)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let m=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),m=this._updateAverageElevation(c),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):m=this._updateAverageElevation(c);const y=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,p,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),y&&(this._placementDirty=y.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:p,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new s.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,It.mark(nt.load),this.fire(new s.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const T=s.o.now()-c;d.endQuery(n.TIME_ELAPSED_EXT),setTimeout((()=>{const S=d.getQueryParameter(t,d.QUERY_RESULT)/1e6;d.deleteQuery(t),this.fire(new s.z("gpu-timing-frame",{cpuTime:T,gpuTime:S}))}),50)}if(this.listens("gpu-timing-layer")){const T=this.painter.collectGpuTimers();setTimeout((()=>{const S=this.painter.queryGpuTimers(T);this.fire(new s.z("gpu-timing-layer",{layerTimes:S}))}),50)}if(this.listens("gpu-timing-deferred-render")){const T=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const S=this.painter.queryGpuTimeDeferredRender(T);this.fire(new s.z("gpu-timing-deferred-render",{gpuTime:S}))}),50)}const x=this._sourcesDirty||this._styleDirty||this._placementDirty||m;if(x||this._repaint)this.triggerRepaint();else{const T=this.idle();if(T&&(m=this._updateAverageElevation(c,!0)),m)this.triggerRepaint();else if(this._triggerFrame(!1),T&&(this.fire(new s.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const S=this._calculateSpeedIndex();this.fire(new s.z("speedindexcompleted",{speedIndex:S})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||x||(this._fullyLoaded=!0,It.mark(nt.fullLoad),this._performanceMetricsCollection&&Gi(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(l){for(const t of this._markers)l&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!l||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(l,t=!1){const n=d=>(this.transform.averageElevation=d,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&n(0);const c=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(c||(t||l-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(l)){const d=this.transform.averageElevation;let p=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(p)?p=0:this._averageElevationLastSampledAt=l;const m=Math.abs(d-p);if(m>1){if(this._isInitialLoad||c)return this._averageElevation.jumpTo(p),n(p);this._averageElevation.easeTo(p,l,300)}else if(m>1e-4)return this._averageElevation.jumpTo(p),n(p)}return!!this._averageElevation.isEasing(l)&&n(this._averageElevation.getValue(l))}_authenticate(){fn(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(l=>{if(l&&(l.message===Jt||l.status===401)){const t=this.painter.context.gl;kn(t,!1),this._logoControl instanceof yc&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new s.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),Fn(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&En(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_postStyleWithAppearanceEvent(){this.style.globalId&&this.style.hasAppearances()&&Qn(this._requestManager._customAccessToken)}_updateTerrain(){const l=this._isDragging();this.painter.updateTerrain(this.style,l)}_calculateSpeedIndex(){const l=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const n=this.painter.context.gl,c=n.createFramebuffer();function d(p){n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,p,0);const m=new Uint8Array(n.drawingBufferWidth*n.drawingBufferHeight*4);return n.readPixels(0,0,n.drawingBufferWidth,n.drawingBufferHeight,n.RGBA,n.UNSIGNED_BYTE,m),m}return n.bindFramebuffer(n.FRAMEBUFFER,c),this._canvasPixelComparison(d(l),t.canvasCopies.map(d),t.timeStamps)}_canvasPixelComparison(l,t,n){let c=n[1]-n[0];const d=l.length/4;for(let p=0;p<t.length;p++){const m=t[p];let y=0;for(let x=0;x<m.length;x+=4)m[x]===l[x]&&m[x+1]===l[x+1]&&m[x+2]===l[x+2]&&m[x+3]===l[x+3]&&(y+=1);c+=(n[p+2]-n[p+1])*(1-y/d)}return c}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor&&this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const l=this.painter.context.gl.getExtension("WEBGL_lose_context");l&&l.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),nr.delete(this.painter.context.gl),Cr.remove(),Wi.remove(),this._removed=!0,this.fire(new s.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(l){this._renderNextFrame=this._renderNextFrame||l,this.style&&!this._frame&&(this._frame=s.o.frame((t=>{const n=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,n&&this._render(t)})))}_preloadTiles(l){const t=this.style?this.style.getSourceCaches():[];return s.bv(t,((n,c)=>n._preloadTiles(l,c)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(l){this._trackResize&&this.resize({originalEvent:l})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(l){this._showTileBoundaries!==l&&(this._showTileBoundaries=l,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(l){this._showParseStatus!==l&&(this._showParseStatus=l,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(l){this._showTerrainWireframe!==l&&(this._showTerrainWireframe=l,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(l){this._showLayers2DWireframe!==l&&(this._showLayers2DWireframe=l,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(l){this._showLayers3DWireframe!==l&&(this._showLayers3DWireframe=l,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(l){this._speedIndexTiming!==l&&(this._speedIndexTiming=l,this._update())}get showPadding(){return!!this._showPadding}set showPadding(l){this._showPadding!==l&&(this._showPadding=l,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(l){this._showCollisionBoxes!==l&&(this._showCollisionBoxes=l,this._tp.refreshUI(),l?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(l){this._showOverdrawInspector!==l&&(this._showOverdrawInspector=l,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(l){this._repaint!==l&&(this._repaint=l,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(l){this._vertices=l,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(l){this._showTileAABBs!==l&&(this._showTileAABBs=l,this._tp.refreshUI(),l&&this._update())}_setCacheLimits(l,t){s.f3(l,t)}get version(){return et}},NavigationControl:class{constructor(l={}){this.options=Object.assign({},zu,l),this._container=Tt("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this.options.showZoom&&(s.aX(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(t=>{this._map&&this._map.zoomIn({},{originalEvent:t})})),Tt("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(t=>{this._map&&this._map.zoomOut({},{originalEvent:t})})),Tt("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(s.aX(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(t=>{const n=this._map;n&&(this.options.visualizePitch?n.resetNorthPitch({},{originalEvent:t}):n.resetNorth({},{originalEvent:t}))})),this._compassIcon=Tt("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const l=this._map;if(!l)return;const t=l.getZoom(),n=t===l.getMaxZoom(),c=t===l.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=c,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",c.toString())}_rotateCompassArrow(){const l=this._map;if(!l)return;const t=this.options.visualizePitch?"scale(".concat(1/Math.pow(Math.cos(l.transform.pitch*(Math.PI/180)),.5),") rotateX(").concat(l.transform.pitch,"deg) rotateZ(").concat(l.transform.angle*(180/Math.PI),"deg)"):"rotate(".concat(l.transform.angle*(180/Math.PI),"deg)");l._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=t)}))}onAdd(l){return this._map=l,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),l.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&l.on("pitch",this._rotateCompassArrow),l.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new vc(l,this._compass,this.options.visualizePitch)),this._container}onRemove(){const l=this._map;l&&(this._container.remove(),this.options.showZoom&&l.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&l.off("pitch",this._rotateCompassArrow),l.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(l,t){const n=Tt("button",l,this._container);return n.type="button",n.addEventListener("click",t),n}_setButtonTitle(l,t){if(!this._map)return;const n=this._map._getUIString("NavigationControl.".concat(t));l.setAttribute("aria-label",n),l.firstElementChild&&l.firstElementChild.setAttribute("title",n)}},GeolocateControl:class extends s.E{constructor(l={}){super();const t=navigator.geolocation;this.options=Object.assign({geolocation:t},_s,l),s.aX(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Ra(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(l){return this._map=l,this._container=Tt("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(l){const t=(n=!!this.options.geolocation)=>{this._supportsGeolocation=n,l(n)};this._supportsGeolocation!==void 0?l(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then((n=>t(n.state!=="denied"))).catch((()=>t())):t()}_isOutOfMapMaxBounds(l){const t=this._map.getMaxBounds(),n=l.coords;return!!t&&(n.longitude<t.getWest()||n.longitude>t.getEast()||n.latitude<t.getSouth()||n.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(l){if(this._map){if(this._isOutOfMapMaxBounds(l))return this._setErrorState(),this.fire(new s.z("outofmaxbounds",l)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=l,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(l),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(l),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.z("geolocate",Object.assign({coords:l.coords,timestamp:l.timestamp},l.toJSON?{toJSON:l.toJSON.bind(l)}:{}))),this._finish()}}_updateCamera(l){const t=new s.aS(l.coords.longitude,l.coords.latitude),n=l.coords.accuracy,c=this._map.getBearing(),d=Object.assign({bearing:c},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(n),d,{geolocateSource:!0})}_updateMarker(l){if(l){const t=new s.aS(l.coords.longitude,l.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=l.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const l=this._map.transform,t=s.ce(1,l._center.lat)*l.worldSize,n=Math.ceil(2*this._accuracy*t);this._circleElement.style.width="".concat(n,"px"),this._circleElement.style.height="".concat(n,"px")}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(l){if(this._map){if(this.options.trackUserLocation)if(l.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(l.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.z("error",l)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(l){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this._geolocateButton=Tt("button","mapboxgl-ctrl-geolocate",this._container),Tt("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",l===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Tt("div","mapboxgl-user-location"),this._dotElement.appendChild(Tt("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(Tt("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new js({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=Tt("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new js({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new s.z("trackuserlocationend")))}))}}_onDeviceOrientation(l){this._userLocationDotMarker&&(l.webkitCompassHeading?this._heading=l.webkitCompassHeading:l.absolute===!0&&(this._heading=-1*l.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new s.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let l;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(l={maximumAge:6e5,timeout:0},this._noTimeout=!0):(l=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,l),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const l=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then((t=>{t==="granted"&&l()})).catch(console.error):l()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:yl,ScaleControl:class{constructor(l={}){this.options=Object.assign({},Jm,l),this._isNumberFormatSupported=(function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(t){return!1}})(),s.aX(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const l=this.options.maxWidth||100,t=this._map,n=t._containerHeight/2,c=t._containerWidth/2-l/2,d=t.unproject([c,n]),p=t.unproject([c+l,n]),m=d.distanceTo(p);if(this.options.unit==="imperial"){const y=3.2808*m;y>5280?this._setScale(l,y/5280,"mile"):this._setScale(l,y,"foot")}else this.options.unit==="nautical"?this._setScale(l,m/1852,"nautical-mile"):m>=1e3?this._setScale(l,m/1e3,"kilometer"):this._setScale(l,m,"meter")}_setScale(l,t,n){this._map._requestDomTask((()=>{const c=(function(p){const m=Math.pow(10,"".concat(Math.floor(p)).length-1);let y=p/m;return y=y>=10?10:y>=5?5:y>=3?3:y>=2?2:y>=1?1:(function(x){const T=Math.pow(10,Math.ceil(-Math.log(x)/Math.LN10));return Math.round(x*T)/T})(y),m*y})(t),d=c/t;this._container.innerHTML=this._isNumberFormatSupported&&n!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:n}).format(c):"".concat(c,"&nbsp;").concat(Qm[n]),this._container.style.width=l*d+"px"}))}onAdd(l){return this._map=l,this._language=l.getLanguage(),this._container=Tt("div","mapboxgl-ctrl mapboxgl-ctrl-scale",l.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(l){this._language=l,this._update()}setUnit(l){this.options.unit=l,this._update()}},FullscreenControl:class{constructor(l={}){this._fullscreen=!1,l&&l.container&&(l.container instanceof HTMLElement?this._container=l.container:s.w("Full screen control 'container' must be a DOM element.")),s.aX(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(l){return this._map=l,this._container||(this._container=this._map.getContainer()),this._controlContainer=Tt("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",s.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const l=this._fullscreenButton=Tt("button","mapboxgl-ctrl-fullscreen",this._controlContainer);Tt("span","mapboxgl-ctrl-icon",l).setAttribute("aria-hidden","true"),l.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const l=this._getTitle();this._fullscreenButton.setAttribute("aria-label",l),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",l)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:yd,Popup:class extends s.E{constructor(l){super(),this.options=Object.assign(Object.create(e_),l),this._altitude=this.options.altitude,s.aX(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(l&&l.className?l.className.trim().split(/\s+/):[])}addTo(l){return this._map&&this.remove(),this._map=l,this.options.closeOnClick&&l.on("preclick",this._onClose),this.options.closeOnMove&&l.on("move",this._onClose),l.on("remove",this.remove),this._update(),l._addPopup(this),this._focusFirstElement(),this._trackPointer?(l.on("mousemove",this._onMouseEvent),l.on("mouseup",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")):l.on("move",this._update),this.fire(new s.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const l=this._map;return l&&(l.off("move",this._update),l.off("move",this._onClose),l.off("preclick",this._onClose),l.off("click",this._onClose),l.off("remove",this.remove),l.off("mousemove",this._onMouseEvent),l.off("mouseup",this._onMouseEvent),l.off("drag",this._onMouseEvent),l._canvasContainer&&l._canvasContainer.classList.remove("mapboxgl-track-pointer"),l._removePopup(this),this._map=void 0),this.fire(new s.z("close")),this}getLngLat(){return this._lngLat}setLngLat(l){this._lngLat=s.aS.convert(l),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(l){return this._altitude=l,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const l=this._map;return l&&(l.off("move",this._update),l.on("mousemove",this._onMouseEvent),l.on("drag",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(l){return this.setDOMContent(document.createTextNode(l))}setHTML(l){const t=document.createDocumentFragment(),n=document.createElement("body");let c;for(n.innerHTML=l;c=n.firstChild,c;)t.appendChild(c);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(l){return this.options.maxWidth=l,this._update(),this}setDOMContent(l){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=Tt("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(l),this.options.closeButton){const n=this._closeButton=Tt("button","mapboxgl-popup-close-button",t);n.type="button",n.setAttribute("aria-label","Close popup"),n.innerHTML='<span aria-hidden="true">&#215;</span>',n.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(l){return this._classList.add(l),this._updateClassList(),this}removeClassName(l){return this._classList.delete(l),this._updateClassList(),this}setOffset(l){return this.options.offset=l,this._update(),this}toggleClassName(l){let t;return this._classList.delete(l)?t=!1:(this._classList.add(l),t=!0),this._updateClassList(),t}_onMouseEvent(l){this._update(l.point)}_getAnchor(l){if(this.options.anchor)return this.options.anchor;const t=this._map,n=this._container,c=this._pos;if(!t||!n||!c)return"bottom";const d=n.offsetWidth,p=n.offsetHeight,m=c.x<d/2,y=c.x>t.transform.width-d/2;if(c.y+l<p)return m?"top-left":y?"top-right":"top";if(c.y>t.transform.height-p){if(m)return"bottom-left";if(y)return"bottom-right"}return m?"left":y?"right":"bottom"}_updateClassList(){const l=this._container;if(!l)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push("mapboxgl-popup-anchor-".concat(this._anchor)),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),l.className=t.join(" ")}_update(l){const t=this._map,n=this._content;if(!t||!this._lngLat&&!this._trackPointer||!n)return;let c=this._container;if(c||(c=this._container=Tt("div","mapboxgl-popup",t.getContainer()),this._tip=Tt("div","mapboxgl-popup-tip",c),c.appendChild(n)),this.options.maxWidth&&c.style.maxWidth!==this.options.maxWidth&&(c.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Us(this._lngLat,this._pos,t.transform)),!this._trackPointer||l){const d=this._pos=this._trackPointer&&l instanceof s.P?l:t.project(this._lngLat,this._altitude),p=bd(this.options.offset),m=this._anchor=this._getAnchor(p.y),y=bd(this.options.offset,m),x=d.add(y).round();t._requestDomTask((()=>{this._container&&m&&(this._container.style.transform="".concat(ms[m]," translate(").concat(x.x,"px,").concat(x.y,"px)"))}))}if(!this._marker&&t._showingGlobe()){const d=s.f4(t.transform,this._lngLat)?0:1;this._setOpacity(d)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const l=this._container.querySelector(t_);l&&l.focus()}_onClose(){this.remove()}_setOpacity(l){this._container&&(this._container.style.opacity="".concat(l)),this._content&&(this._content.style.pointerEvents=l?"auto":"none")}},Marker:js,Style:rs,LngLat:s.aS,LngLatBounds:s.aI,Point:s.P,MercatorCoordinate:s.ae,FreeCameraOptions:Ts,Evented:s.E,config:s.e,prewarm:s.f8,clearPrewarmedResources:s.f7,get accessToken(){return s.e.ACCESS_TOKEN},set accessToken(l){s.e.ACCESS_TOKEN=l},get baseApiUrl(){return s.e.API_URL},set baseApiUrl(l){s.e.API_URL=l},get workerCount(){return s.fh.workerCount},set workerCount(l){s.fh.workerCount=l},get maxParallelImageRequests(){return s.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(l){s.e.MAX_PARALLEL_IMAGE_REQUESTS=l},clearStorage(l){s.fg(l)},get workerUrl(){return s.ff.workerUrl},set workerUrl(l){s.ff.workerUrl=l},get workerClass(){return s.ff.workerClass},set workerClass(l){s.ff.workerClass=l},get workerParams(){return s.ff.workerParams},set workerParams(l){s.ff.workerParams=l},get dracoUrl(){return s.fe()},set dracoUrl(l){s.fd(l)},get meshoptUrl(){return s.fc()},set meshoptUrl(l){s.fb(l)},setNow:s.o.setNow,restoreNow:s.o.restoreNow}}));var rt=Pe;return rt}))})(hm)),hm.exports}B2();const _m=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function nh(F){const q=Object.prototype.toString.call(F);return q==="[object Window]"||q==="[object global]"}function Og(F){return"nodeType"in F}function cs(F){var q,ne;return F?nh(F)?F:Og(F)&&(q=(ne=F.ownerDocument)==null?void 0:ne.defaultView)!=null?q:window:window}function Fg(F){const{Document:q}=cs(F);return F instanceof q}function _f(F){return nh(F)?!1:F instanceof cs(F).HTMLElement}function hb(F){return F instanceof cs(F).SVGElement}function oh(F){return F?nh(F)?F.document:Og(F)?Fg(F)?F:_f(F)||hb(F)?F.ownerDocument:document:document:document}const Rl=_m?tt.useLayoutEffect:tt.useEffect;function kg(F){const q=tt.useRef(F);return Rl(()=>{q.current=F}),tt.useCallback(function(){for(var ne=arguments.length,me=new Array(ne),Pe=0;Pe<ne;Pe++)me[Pe]=arguments[Pe];return q.current==null?void 0:q.current(...me)},[])}function N2(){const F=tt.useRef(null),q=tt.useCallback((me,Pe)=>{F.current=setInterval(me,Pe)},[]),ne=tt.useCallback(()=>{F.current!==null&&(clearInterval(F.current),F.current=null)},[]);return[q,ne]}function Bg(F,q){q===void 0&&(q=[F]);const ne=tt.useRef(F);return Rl(()=>{ne.current!==F&&(ne.current=F)},q),ne}function gf(F,q){const ne=tt.useRef();return tt.useMemo(()=>{const me=F(ne.current);return ne.current=me,me},[...q])}function Ag(F){const q=kg(F),ne=tt.useRef(null),me=tt.useCallback(Pe=>{Pe!==ne.current&&(q==null||q(Pe,ne.current)),ne.current=Pe},[]);return[ne,me]}function Mg(F){const q=tt.useRef();return tt.useEffect(()=>{q.current=F},[F]),q.current}let Tg={};function Ng(F,q){return tt.useMemo(()=>{if(q)return q;const ne=Tg[F]==null?0:Tg[F]+1;return Tg[F]=ne,F+"-"+ne},[F,q])}function db(F){return function(q){for(var ne=arguments.length,me=new Array(ne>1?ne-1:0),Pe=1;Pe<ne;Pe++)me[Pe-1]=arguments[Pe];return me.reduce((we,rt)=>{const s=Object.entries(rt);for(const[et,nt]of s){const It=we[et];It!=null&&(we[et]=It+F*nt)}return we},yr({},q))}}const rh=db(1),fm=db(-1);function V2(F){return"clientX"in F&&"clientY"in F}function fb(F){if(!F)return!1;const{KeyboardEvent:q}=cs(F.target);return q&&F instanceof q}function U2(F){if(!F)return!1;const{TouchEvent:q}=cs(F.target);return q&&F instanceof q}function Cg(F){if(U2(F)){if(F.touches&&F.touches.length){const{clientX:q,clientY:ne}=F.touches[0];return{x:q,y:ne}}else if(F.changedTouches&&F.changedTouches.length){const{clientX:q,clientY:ne}=F.changedTouches[0];return{x:q,y:ne}}}return V2(F)?{x:F.clientX,y:F.clientY}:null}const X0="a,frame,iframe,input:not([type=hidden]):not(:disabled),select:not(:disabled),textarea:not(:disabled),button:not(:disabled),*[tabindex]";function j2(F){return F.matches(X0)?F:F.querySelector(X0)}const G2={display:"none"};function H2(F){let{id:q,value:ne}=F;return Zo.createElement("div",{id:q,style:G2},ne)}function q2(F){let{id:q,announcement:ne,ariaLiveType:me="assertive"}=F;const Pe={position:"fixed",top:0,left:0,width:1,height:1,margin:-1,border:0,padding:0,overflow:"hidden",clip:"rect(0 0 0 0)",clipPath:"inset(100%)",whiteSpace:"nowrap"};return Zo.createElement("div",{id:q,style:Pe,role:"status","aria-live":me,"aria-atomic":!0},ne)}function $2(){const[F,q]=tt.useState("");return{announce:tt.useCallback(me=>{me!=null&&q(me)},[]),announcement:F}}const pb=tt.createContext(null);function Z2(F){const q=tt.useContext(pb);tt.useEffect(()=>{if(!q)throw new Error("useDndMonitor must be used within a children of <DndContext>");return q(F)},[F,q])}function W2(){const[F]=tt.useState(()=>new Set),q=tt.useCallback(me=>(F.add(me),()=>F.delete(me)),[F]);return[tt.useCallback(me=>{let{type:Pe,event:we}=me;F.forEach(rt=>{var s;return(s=rt[Pe])==null?void 0:s.call(rt,we)})},[F]),q]}const X2={draggable:"\n    To pick up a draggable item, press the space bar.\n    While dragging, use the arrow keys to move the item.\n    Press space again to drop the item in its new position, or press escape to cancel.\n  "},Y2={onDragStart(F){let{active:q}=F;return"Picked up draggable item "+q.id+"."},onDragOver(F){let{active:q,over:ne}=F;return ne?"Draggable item "+q.id+" was moved over droppable area "+ne.id+".":"Draggable item "+q.id+" is no longer over a droppable area."},onDragEnd(F){let{active:q,over:ne}=F;return ne?"Draggable item "+q.id+" was dropped over droppable area "+ne.id:"Draggable item "+q.id+" was dropped."},onDragCancel(F){let{active:q}=F;return"Dragging was cancelled. Draggable item "+q.id+" was dropped."}};function K2(F){let{announcements:q=Y2,container:ne,hiddenTextDescribedById:me,screenReaderInstructions:Pe=X2}=F;const{announce:we,announcement:rt}=$2(),s=Ng("DndLiveRegion"),[et,nt]=tt.useState(!1);if(tt.useEffect(()=>{nt(!0)},[]),Z2(tt.useMemo(()=>({onDragStart(At){let{active:Xt}=At;we(q.onDragStart({active:Xt}))},onDragMove(At){let{active:Xt,over:ei}=At;q.onDragMove&&we(q.onDragMove({active:Xt,over:ei}))},onDragOver(At){let{active:Xt,over:ei}=At;we(q.onDragOver({active:Xt,over:ei}))},onDragEnd(At){let{active:Xt,over:ei}=At;we(q.onDragEnd({active:Xt,over:ei}))},onDragCancel(At){let{active:Xt,over:ei}=At;we(q.onDragCancel({active:Xt,over:ei}))}}),[we,q])),!et)return null;const It=Zo.createElement(Zo.Fragment,null,Zo.createElement(H2,{id:me,value:Pe.draggable}),Zo.createElement(q2,{id:s,announcement:rt}));return ne?uf.createPortal(It,ne):It}var Co;(function(F){F.DragStart="dragStart",F.DragMove="dragMove",F.DragEnd="dragEnd",F.DragCancel="dragCancel",F.DragOver="dragOver",F.RegisterDroppable="registerDroppable",F.SetDroppableDisabled="setDroppableDisabled",F.UnregisterDroppable="unregisterDroppable"})(Co||(Co={}));function pm(){}function J2(F,q){return tt.useMemo(()=>({sensor:F,options:q!=null?q:{}}),[F,q])}function Q2(){for(var F=arguments.length,q=new Array(F),ne=0;ne<F;ne++)q[ne]=arguments[ne];return tt.useMemo(()=>[...q].filter(me=>me!=null),[...q])}const Xs=Object.freeze({x:0,y:0});function eS(F,q){let{data:{value:ne}}=F,{data:{value:me}}=q;return me-ne}function tS(F,q){if(!F||F.length===0)return null;const[ne]=F;return ne[q]}function iS(F,q){const ne=Math.max(q.top,F.top),me=Math.max(q.left,F.left),Pe=Math.min(q.left+q.width,F.left+F.width),we=Math.min(q.top+q.height,F.top+F.height),rt=Pe-me,s=we-ne;if(me<Pe&&ne<we){const et=q.width*q.height,nt=F.width*F.height,It=rt*s,At=It/(et+nt-It);return Number(At.toFixed(4))}return 0}const rS=F=>{let{collisionRect:q,droppableRects:ne,droppableContainers:me}=F;const Pe=[];for(const we of me){const{id:rt}=we,s=ne.get(rt);if(s){const et=iS(s,q);et>0&&Pe.push({id:rt,data:{droppableContainer:we,value:et}})}}return Pe.sort(eS)};function nS(F,q,ne){return on(yr({},F),{scaleX:q&&ne?q.width/ne.width:1,scaleY:q&&ne?q.height/ne.height:1})}function mb(F,q){return F&&q?{x:F.left-q.left,y:F.top-q.top}:Xs}function oS(F){return function(ne){for(var me=arguments.length,Pe=new Array(me>1?me-1:0),we=1;we<me;we++)Pe[we-1]=arguments[we];return Pe.reduce((rt,s)=>on(yr({},rt),{top:rt.top+F*s.y,bottom:rt.bottom+F*s.y,left:rt.left+F*s.x,right:rt.right+F*s.x}),yr({},ne))}}const sS=oS(1);function aS(F){if(F.startsWith("matrix3d(")){const q=F.slice(9,-1).split(/, /);return{x:+q[12],y:+q[13],scaleX:+q[0],scaleY:+q[5]}}else if(F.startsWith("matrix(")){const q=F.slice(7,-1).split(/, /);return{x:+q[4],y:+q[5],scaleX:+q[0],scaleY:+q[3]}}return null}function lS(F,q,ne){const me=aS(q);if(!me)return F;const{scaleX:Pe,scaleY:we,x:rt,y:s}=me,et=F.left-rt-(1-Pe)*parseFloat(ne),nt=F.top-s-(1-we)*parseFloat(ne.slice(ne.indexOf(" ")+1)),It=Pe?F.width/Pe:F.width,At=we?F.height/we:F.height;return{width:It,height:At,top:nt,right:et+It,bottom:nt+At,left:et}}const cS={ignoreTransform:!1};function yf(F,q){q===void 0&&(q=cS);let ne=F.getBoundingClientRect();if(q.ignoreTransform){const{transform:nt,transformOrigin:It}=cs(F).getComputedStyle(F);nt&&(ne=lS(ne,nt,It))}const{top:me,left:Pe,width:we,height:rt,bottom:s,right:et}=ne;return{top:me,left:Pe,width:we,height:rt,bottom:s,right:et}}function Y0(F){return yf(F,{ignoreTransform:!0})}function uS(F){const q=F.innerWidth,ne=F.innerHeight;return{top:0,left:0,right:q,bottom:ne,width:q,height:ne}}function hS(F,q){return q===void 0&&(q=cs(F).getComputedStyle(F)),q.position==="fixed"}function dS(F,q){q===void 0&&(q=cs(F).getComputedStyle(F));const ne=/(auto|scroll|overlay)/;return["overflow","overflowX","overflowY"].some(Pe=>{const we=q[Pe];return typeof we=="string"?ne.test(we):!1})}function Vg(F,q){const ne=[];function me(Pe){if(q!=null&&ne.length>=q||!Pe)return ne;if(Fg(Pe)&&Pe.scrollingElement!=null&&!ne.includes(Pe.scrollingElement))return ne.push(Pe.scrollingElement),ne;if(!_f(Pe)||hb(Pe)||ne.includes(Pe))return ne;const we=cs(F).getComputedStyle(Pe);return Pe!==F&&dS(Pe,we)&&ne.push(Pe),hS(Pe,we)?ne:me(Pe.parentNode)}return F?me(F):ne}function _b(F){const[q]=Vg(F,1);return q!=null?q:null}function Sg(F){return!_m||!F?null:nh(F)?F:Og(F)?Fg(F)||F===oh(F).scrollingElement?window:_f(F)?F:null:null}function gb(F){return nh(F)?F.scrollX:F.scrollLeft}function yb(F){return nh(F)?F.scrollY:F.scrollTop}function Pg(F){return{x:gb(F),y:yb(F)}}var ao;(function(F){F[F.Forward=1]="Forward",F[F.Backward=-1]="Backward"})(ao||(ao={}));function xb(F){return!_m||!F?!1:F===document.scrollingElement}function vb(F){const q={x:0,y:0},ne=xb(F)?{height:window.innerHeight,width:window.innerWidth}:{height:F.clientHeight,width:F.clientWidth},me={x:F.scrollWidth-ne.width,y:F.scrollHeight-ne.height},Pe=F.scrollTop<=q.y,we=F.scrollLeft<=q.x,rt=F.scrollTop>=me.y,s=F.scrollLeft>=me.x;return{isTop:Pe,isLeft:we,isBottom:rt,isRight:s,maxScroll:me,minScroll:q}}const fS={x:.2,y:.2};function pS(F,q,ne,me,Pe){let{top:we,left:rt,right:s,bottom:et}=ne;me===void 0&&(me=10),Pe===void 0&&(Pe=fS);const{isTop:nt,isBottom:It,isLeft:At,isRight:Xt}=vb(F),ei={x:0,y:0},Vi={x:0,y:0},Tt={height:q.height*Pe.y,width:q.width*Pe.x};return!nt&&we<=q.top+Tt.height?(ei.y=ao.Backward,Vi.y=me*Math.abs((q.top+Tt.height-we)/Tt.height)):!It&&et>=q.bottom-Tt.height&&(ei.y=ao.Forward,Vi.y=me*Math.abs((q.bottom-Tt.height-et)/Tt.height)),!Xt&&s>=q.right-Tt.width?(ei.x=ao.Forward,Vi.x=me*Math.abs((q.right-Tt.width-s)/Tt.width)):!At&&rt<=q.left+Tt.width&&(ei.x=ao.Backward,Vi.x=me*Math.abs((q.left+Tt.width-rt)/Tt.width)),{direction:ei,speed:Vi}}function mS(F){if(F===document.scrollingElement){const{innerWidth:we,innerHeight:rt}=window;return{top:0,left:0,right:we,bottom:rt,width:we,height:rt}}const{top:q,left:ne,right:me,bottom:Pe}=F.getBoundingClientRect();return{top:q,left:ne,right:me,bottom:Pe,width:F.clientWidth,height:F.clientHeight}}function bb(F){return F.reduce((q,ne)=>rh(q,Pg(ne)),Xs)}function _S(F){return F.reduce((q,ne)=>q+gb(ne),0)}function gS(F){return F.reduce((q,ne)=>q+yb(ne),0)}function yS(F,q){if(q===void 0&&(q=yf),!F)return;const{top:ne,left:me,bottom:Pe,right:we}=q(F);_b(F)&&(Pe<=0||we<=0||ne>=window.innerHeight||me>=window.innerWidth)&&F.scrollIntoView({block:"center",inline:"center"})}const xS=[["x",["left","right"],_S],["y",["top","bottom"],gS]];class Ug{constructor(q,ne){this.rect=void 0,this.width=void 0,this.height=void 0,this.top=void 0,this.bottom=void 0,this.right=void 0,this.left=void 0;const me=Vg(ne),Pe=bb(me);this.rect=yr({},q),this.width=q.width,this.height=q.height;for(const[we,rt,s]of xS)for(const et of rt)Object.defineProperty(this,et,{get:()=>{const nt=s(me),It=Pe[we]-nt;return this.rect[et]+It},enumerable:!0});Object.defineProperty(this,"rect",{enumerable:!1})}}class hf{constructor(q){this.target=void 0,this.listeners=[],this.removeAll=()=>{this.listeners.forEach(ne=>{var me;return(me=this.target)==null?void 0:me.removeEventListener(...ne)})},this.target=q}add(q,ne,me){var Pe;(Pe=this.target)==null||Pe.addEventListener(q,ne,me),this.listeners.push([q,ne,me])}}function vS(F){const{EventTarget:q}=cs(F);return F instanceof q?F:oh(F)}function Eg(F,q){const ne=Math.abs(F.x),me=Math.abs(F.y);return typeof q=="number"?Math.sqrt(ne**2+me**2)>q:"x"in q&&"y"in q?ne>q.x&&me>q.y:"x"in q?ne>q.x:"y"in q?me>q.y:!1}var Cs;(function(F){F.Click="click",F.DragStart="dragstart",F.Keydown="keydown",F.ContextMenu="contextmenu",F.Resize="resize",F.SelectionChange="selectionchange",F.VisibilityChange="visibilitychange"})(Cs||(Cs={}));function K0(F){F.preventDefault()}function bS(F){F.stopPropagation()}var sn;(function(F){F.Space="Space",F.Down="ArrowDown",F.Right="ArrowRight",F.Left="ArrowLeft",F.Up="ArrowUp",F.Esc="Escape",F.Enter="Enter",F.Tab="Tab"})(sn||(sn={}));const wb={start:[sn.Space,sn.Enter],cancel:[sn.Esc],end:[sn.Space,sn.Enter,sn.Tab]},wS=(F,q)=>{let{currentCoordinates:ne}=q;switch(F.code){case sn.Right:return on(yr({},ne),{x:ne.x+25});case sn.Left:return on(yr({},ne),{x:ne.x-25});case sn.Down:return on(yr({},ne),{y:ne.y+25});case sn.Up:return on(yr({},ne),{y:ne.y-25})}};class Tb{constructor(q){this.props=void 0,this.autoScrollEnabled=!1,this.referenceCoordinates=void 0,this.listeners=void 0,this.windowListeners=void 0,this.props=q;const{event:{target:ne}}=q;this.props=q,this.listeners=new hf(oh(ne)),this.windowListeners=new hf(cs(ne)),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleCancel=this.handleCancel.bind(this),this.attach()}attach(){this.handleStart(),this.windowListeners.add(Cs.Resize,this.handleCancel),this.windowListeners.add(Cs.VisibilityChange,this.handleCancel),setTimeout(()=>this.listeners.add(Cs.Keydown,this.handleKeyDown))}handleStart(){const{activeNode:q,onStart:ne}=this.props,me=q.node.current;me&&yS(me),ne(Xs)}handleKeyDown(q){if(fb(q)){const{active:ne,context:me,options:Pe}=this.props,{keyboardCodes:we=wb,coordinateGetter:rt=wS,scrollBehavior:s="smooth"}=Pe,{code:et}=q;if(we.end.includes(et)){this.handleEnd(q);return}if(we.cancel.includes(et)){this.handleCancel(q);return}const{collisionRect:nt}=me.current,It=nt?{x:nt.left,y:nt.top}:Xs;this.referenceCoordinates||(this.referenceCoordinates=It);const At=rt(q,{active:ne,context:me.current,currentCoordinates:It});if(At){const Xt=fm(At,It),ei={x:0,y:0},{scrollableAncestors:Vi}=me.current;for(const Tt of Vi){const Dt=q.code,{isTop:Mi,isRight:Yt,isLeft:wi,isBottom:Ci,maxScroll:tr,minScroll:vi}=vb(Tt),Ti=mS(Tt),Si={x:Math.min(Dt===sn.Right?Ti.right-Ti.width/2:Ti.right,Math.max(Dt===sn.Right?Ti.left:Ti.left+Ti.width/2,At.x)),y:Math.min(Dt===sn.Down?Ti.bottom-Ti.height/2:Ti.bottom,Math.max(Dt===sn.Down?Ti.top:Ti.top+Ti.height/2,At.y))},hr=Dt===sn.Right&&!Yt||Dt===sn.Left&&!wi,Sr=Dt===sn.Down&&!Ci||Dt===sn.Up&&!Mi;if(hr&&Si.x!==At.x){const br=Tt.scrollLeft+Xt.x,Or=Dt===sn.Right&&br<=tr.x||Dt===sn.Left&&br>=vi.x;if(Or&&!Xt.y){Tt.scrollTo({left:br,behavior:s});return}Or?ei.x=Tt.scrollLeft-br:ei.x=Dt===sn.Right?Tt.scrollLeft-tr.x:Tt.scrollLeft-vi.x,ei.x&&Tt.scrollBy({left:-ei.x,behavior:s});break}else if(Sr&&Si.y!==At.y){const br=Tt.scrollTop+Xt.y,Or=Dt===sn.Down&&br<=tr.y||Dt===sn.Up&&br>=vi.y;if(Or&&!Xt.x){Tt.scrollTo({top:br,behavior:s});return}Or?ei.y=Tt.scrollTop-br:ei.y=Dt===sn.Down?Tt.scrollTop-tr.y:Tt.scrollTop-vi.y,ei.y&&Tt.scrollBy({top:-ei.y,behavior:s});break}}this.handleMove(q,rh(fm(At,this.referenceCoordinates),ei))}}}handleMove(q,ne){const{onMove:me}=this.props;q.preventDefault(),me(ne)}handleEnd(q){const{onEnd:ne}=this.props;q.preventDefault(),this.detach(),ne()}handleCancel(q){const{onCancel:ne}=this.props;q.preventDefault(),this.detach(),ne()}detach(){this.listeners.removeAll(),this.windowListeners.removeAll()}}Tb.activators=[{eventName:"onKeyDown",handler:(F,q,ne)=>{let{keyboardCodes:me=wb,onActivation:Pe}=q,{active:we}=ne;const{code:rt}=F.nativeEvent;if(me.start.includes(rt)){const s=we.activatorNode.current;return s&&F.target!==s?!1:(F.preventDefault(),Pe==null||Pe({event:F.nativeEvent}),!0)}return!1}}];function J0(F){return!!(F&&"distance"in F)}function Q0(F){return!!(F&&"delay"in F)}class jg{constructor(q,ne,me){var Pe;me===void 0&&(me=vS(q.event.target)),this.props=void 0,this.events=void 0,this.autoScrollEnabled=!0,this.document=void 0,this.activated=!1,this.initialCoordinates=void 0,this.timeoutId=null,this.listeners=void 0,this.documentListeners=void 0,this.windowListeners=void 0,this.props=q,this.events=ne;const{event:we}=q,{target:rt}=we;this.props=q,this.events=ne,this.document=oh(rt),this.documentListeners=new hf(this.document),this.listeners=new hf(me),this.windowListeners=new hf(cs(rt)),this.initialCoordinates=(Pe=Cg(we))!=null?Pe:Xs,this.handleStart=this.handleStart.bind(this),this.handleMove=this.handleMove.bind(this),this.handleEnd=this.handleEnd.bind(this),this.handleCancel=this.handleCancel.bind(this),this.handleKeydown=this.handleKeydown.bind(this),this.removeTextSelection=this.removeTextSelection.bind(this),this.attach()}attach(){const{events:q,props:{options:{activationConstraint:ne,bypassActivationConstraint:me}}}=this;if(this.listeners.add(q.move.name,this.handleMove,{passive:!1}),this.listeners.add(q.end.name,this.handleEnd),q.cancel&&this.listeners.add(q.cancel.name,this.handleCancel),this.windowListeners.add(Cs.Resize,this.handleCancel),this.windowListeners.add(Cs.DragStart,K0),this.windowListeners.add(Cs.VisibilityChange,this.handleCancel),this.windowListeners.add(Cs.ContextMenu,K0),this.documentListeners.add(Cs.Keydown,this.handleKeydown),ne){if(me!=null&&me({event:this.props.event,activeNode:this.props.activeNode,options:this.props.options}))return this.handleStart();if(Q0(ne)){this.timeoutId=setTimeout(this.handleStart,ne.delay),this.handlePending(ne);return}if(J0(ne)){this.handlePending(ne);return}}this.handleStart()}detach(){this.listeners.removeAll(),this.windowListeners.removeAll(),setTimeout(this.documentListeners.removeAll,50),this.timeoutId!==null&&(clearTimeout(this.timeoutId),this.timeoutId=null)}handlePending(q,ne){const{active:me,onPending:Pe}=this.props;Pe(me,q,this.initialCoordinates,ne)}handleStart(){const{initialCoordinates:q}=this,{onStart:ne}=this.props;q&&(this.activated=!0,this.documentListeners.add(Cs.Click,bS,{capture:!0}),this.removeTextSelection(),this.documentListeners.add(Cs.SelectionChange,this.removeTextSelection),ne(q))}handleMove(q){var ne;const{activated:me,initialCoordinates:Pe,props:we}=this,{onMove:rt,options:{activationConstraint:s}}=we;if(!Pe)return;const et=(ne=Cg(q))!=null?ne:Xs,nt=fm(Pe,et);if(!me&&s){if(J0(s)){if(s.tolerance!=null&&Eg(nt,s.tolerance))return this.handleCancel();if(Eg(nt,s.distance))return this.handleStart()}if(Q0(s)&&Eg(nt,s.tolerance))return this.handleCancel();this.handlePending(s,nt);return}q.cancelable&&q.preventDefault(),rt(et)}handleEnd(){const{onAbort:q,onEnd:ne}=this.props;this.detach(),this.activated||q(this.props.active),ne()}handleCancel(){const{onAbort:q,onCancel:ne}=this.props;this.detach(),this.activated||q(this.props.active),ne()}handleKeydown(q){q.code===sn.Esc&&this.handleCancel()}removeTextSelection(){var q;(q=this.document.getSelection())==null||q.removeAllRanges()}}const TS={cancel:{name:"pointercancel"},move:{name:"pointermove"},end:{name:"pointerup"}};class Gg extends jg{constructor(q){const{event:ne}=q,me=oh(ne.target);super(q,TS,me)}}Gg.activators=[{eventName:"onPointerDown",handler:(F,q)=>{let{nativeEvent:ne}=F,{onActivation:me}=q;return!ne.isPrimary||ne.button!==0?!1:(me==null||me({event:ne}),!0)}}];const SS={move:{name:"mousemove"},end:{name:"mouseup"}};var Rg;(function(F){F[F.RightClick=2]="RightClick"})(Rg||(Rg={}));class ES extends jg{constructor(q){super(q,SS,oh(q.event.target))}}ES.activators=[{eventName:"onMouseDown",handler:(F,q)=>{let{nativeEvent:ne}=F,{onActivation:me}=q;return ne.button===Rg.RightClick?!1:(me==null||me({event:ne}),!0)}}];const Ig={cancel:{name:"touchcancel"},move:{name:"touchmove"},end:{name:"touchend"}};class IS extends jg{constructor(q){super(q,Ig)}static setup(){return window.addEventListener(Ig.move.name,q,{capture:!1,passive:!1}),function(){window.removeEventListener(Ig.move.name,q)};function q(){}}}IS.activators=[{eventName:"onTouchStart",handler:(F,q)=>{let{nativeEvent:ne}=F,{onActivation:me}=q;const{touches:Pe}=ne;return Pe.length>1?!1:(me==null||me({event:ne}),!0)}}];var df;(function(F){F[F.Pointer=0]="Pointer",F[F.DraggableRect=1]="DraggableRect"})(df||(df={}));var mm;(function(F){F[F.TreeOrder=0]="TreeOrder",F[F.ReversedTreeOrder=1]="ReversedTreeOrder"})(mm||(mm={}));function AS(F){let{acceleration:q,activator:ne=df.Pointer,canScroll:me,draggingRect:Pe,enabled:we,interval:rt=5,order:s=mm.TreeOrder,pointerCoordinates:et,scrollableAncestors:nt,scrollableAncestorRects:It,delta:At,threshold:Xt}=F;const ei=CS({delta:At,disabled:!we}),[Vi,Tt]=N2(),Dt=tt.useRef({x:0,y:0}),Mi=tt.useRef({x:0,y:0}),Yt=tt.useMemo(()=>{switch(ne){case df.Pointer:return et?{top:et.y,bottom:et.y,left:et.x,right:et.x}:null;case df.DraggableRect:return Pe}},[ne,Pe,et]),wi=tt.useRef(null),Ci=tt.useCallback(()=>{const vi=wi.current;if(!vi)return;const Ti=Dt.current.x*Mi.current.x,Si=Dt.current.y*Mi.current.y;vi.scrollBy(Ti,Si)},[]),tr=tt.useMemo(()=>s===mm.TreeOrder?[...nt].reverse():nt,[s,nt]);tt.useEffect(()=>{if(!we||!nt.length||!Yt){Tt();return}for(const vi of tr){if((me==null?void 0:me(vi))===!1)continue;const Ti=nt.indexOf(vi),Si=It[Ti];if(!Si)continue;const{direction:hr,speed:Sr}=pS(vi,Si,Yt,q,Xt);for(const br of["x","y"])ei[br][hr[br]]||(Sr[br]=0,hr[br]=0);if(Sr.x>0||Sr.y>0){Tt(),wi.current=vi,Vi(Ci,rt),Dt.current=Sr,Mi.current=hr;return}}Dt.current={x:0,y:0},Mi.current={x:0,y:0},Tt()},[q,Ci,me,Tt,we,rt,JSON.stringify(Yt),JSON.stringify(ei),Vi,nt,tr,It,JSON.stringify(Xt)])}const MS={x:{[ao.Backward]:!1,[ao.Forward]:!1},y:{[ao.Backward]:!1,[ao.Forward]:!1}};function CS(F){let{delta:q,disabled:ne}=F;const me=Mg(q);return gf(Pe=>{if(ne||!me||!Pe)return MS;const we={x:Math.sign(q.x-me.x),y:Math.sign(q.y-me.y)};return{x:{[ao.Backward]:Pe.x[ao.Backward]||we.x===-1,[ao.Forward]:Pe.x[ao.Forward]||we.x===1},y:{[ao.Backward]:Pe.y[ao.Backward]||we.y===-1,[ao.Forward]:Pe.y[ao.Forward]||we.y===1}}},[ne,q,me])}function PS(F,q){const ne=q!=null?F.get(q):void 0,me=ne?ne.node.current:null;return gf(Pe=>{var we;return q==null?null:(we=me!=null?me:Pe)!=null?we:null},[me,q])}function RS(F,q){return tt.useMemo(()=>F.reduce((ne,me)=>{const{sensor:Pe}=me,we=Pe.activators.map(rt=>({eventName:rt.eventName,handler:q(rt.handler,me)}));return[...ne,...we]},[]),[F,q])}var mf;(function(F){F[F.Always=0]="Always",F[F.BeforeDragging=1]="BeforeDragging",F[F.WhileDragging=2]="WhileDragging"})(mf||(mf={}));var Dg;(function(F){F.Optimized="optimized"})(Dg||(Dg={}));const eb=new Map;function DS(F,q){let{dragging:ne,dependencies:me,config:Pe}=q;const[we,rt]=tt.useState(null),{frequency:s,measure:et,strategy:nt}=Pe,It=tt.useRef(F),At=Dt(),Xt=Bg(At),ei=tt.useCallback(function(Mi){Mi===void 0&&(Mi=[]),!Xt.current&&rt(Yt=>Yt===null?Mi:Yt.concat(Mi.filter(wi=>!Yt.includes(wi))))},[Xt]),Vi=tt.useRef(null),Tt=gf(Mi=>{if(At&&!ne)return eb;if(!Mi||Mi===eb||It.current!==F||we!=null){const Yt=new Map;for(let wi of F){if(!wi)continue;if(we&&we.length>0&&!we.includes(wi.id)&&wi.rect.current){Yt.set(wi.id,wi.rect.current);continue}const Ci=wi.node.current,tr=Ci?new Ug(et(Ci),Ci):null;wi.rect.current=tr,tr&&Yt.set(wi.id,tr)}return Yt}return Mi},[F,we,ne,At,et]);return tt.useEffect(()=>{It.current=F},[F]),tt.useEffect(()=>{At||ei()},[ne,At]),tt.useEffect(()=>{we&&we.length>0&&rt(null)},[JSON.stringify(we)]),tt.useEffect(()=>{At||typeof s!="number"||Vi.current!==null||(Vi.current=setTimeout(()=>{ei(),Vi.current=null},s))},[s,At,ei,...me]),{droppableRects:Tt,measureDroppableContainers:ei,measuringScheduled:we!=null};function Dt(){switch(nt){case mf.Always:return!1;case mf.BeforeDragging:return ne;default:return!ne}}}function Sb(F,q){return gf(ne=>F?ne||(typeof q=="function"?q(F):F):null,[q,F])}function zS(F,q){return Sb(F,q)}function LS(F){let{callback:q,disabled:ne}=F;const me=kg(q),Pe=tt.useMemo(()=>{if(ne||typeof window>"u"||typeof window.MutationObserver>"u")return;const{MutationObserver:we}=window;return new we(me)},[me,ne]);return tt.useEffect(()=>()=>Pe==null?void 0:Pe.disconnect(),[Pe]),Pe}function Hg(F){let{callback:q,disabled:ne}=F;const me=kg(q),Pe=tt.useMemo(()=>{if(ne||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:we}=window;return new we(me)},[ne]);return tt.useEffect(()=>()=>Pe==null?void 0:Pe.disconnect(),[Pe]),Pe}function OS(F){return new Ug(yf(F),F)}function tb(F,q,ne){q===void 0&&(q=OS);const[me,Pe]=tt.useState(null);function we(){Pe(et=>{if(!F)return null;if(F.isConnected===!1){var nt;return(nt=et!=null?et:ne)!=null?nt:null}const It=q(F);return JSON.stringify(et)===JSON.stringify(It)?et:It})}const rt=LS({callback(et){if(F)for(const nt of et){const{type:It,target:At}=nt;if(It==="childList"&&At instanceof HTMLElement&&At.contains(F)){we();break}}}}),s=Hg({callback:we});return Rl(()=>{we(),F?(s==null||s.observe(F),rt==null||rt.observe(document.body,{childList:!0,subtree:!0})):(s==null||s.disconnect(),rt==null||rt.disconnect())},[F]),me}function FS(F){const q=Sb(F);return mb(F,q)}const ib=[];function kS(F){const q=tt.useRef(F),ne=gf(me=>F?me&&me!==ib&&F&&q.current&&F.parentNode===q.current.parentNode?me:Vg(F):ib,[F]);return tt.useEffect(()=>{q.current=F},[F]),ne}function BS(F){const[q,ne]=tt.useState(null),me=tt.useRef(F),Pe=tt.useCallback(we=>{const rt=Sg(we.target);rt&&ne(s=>s?(s.set(rt,Pg(rt)),new Map(s)):null)},[]);return tt.useEffect(()=>{const we=me.current;if(F!==we){rt(we);const s=F.map(et=>{const nt=Sg(et);return nt?(nt.addEventListener("scroll",Pe,{passive:!0}),[nt,Pg(nt)]):null}).filter(et=>et!=null);ne(s.length?new Map(s):null),me.current=F}return()=>{rt(F),rt(we)};function rt(s){s.forEach(et=>{const nt=Sg(et);nt==null||nt.removeEventListener("scroll",Pe)})}},[Pe,F]),tt.useMemo(()=>F.length?q?Array.from(q.values()).reduce((we,rt)=>rh(we,rt),Xs):bb(F):Xs,[F,q])}function rb(F,q){q===void 0&&(q=[]);const ne=tt.useRef(null);return tt.useEffect(()=>{ne.current=null},q),tt.useEffect(()=>{const me=F!==Xs;me&&!ne.current&&(ne.current=F),!me&&ne.current&&(ne.current=null)},[F]),ne.current?fm(F,ne.current):Xs}function NS(F){tt.useEffect(()=>{if(!_m)return;const q=F.map(ne=>{let{sensor:me}=ne;return me.setup==null?void 0:me.setup()});return()=>{for(const ne of q)ne==null||ne()}},F.map(q=>{let{sensor:ne}=q;return ne}))}function VS(F,q){return tt.useMemo(()=>F.reduce((ne,me)=>{let{eventName:Pe,handler:we}=me;return ne[Pe]=rt=>{we(rt,q)},ne},{}),[F,q])}function Eb(F){return tt.useMemo(()=>F?uS(F):null,[F])}const nb=[];function US(F,q){q===void 0&&(q=yf);const[ne]=F,me=Eb(ne?cs(ne):null),[Pe,we]=tt.useState(nb);function rt(){we(()=>F.length?F.map(et=>xb(et)?me:new Ug(q(et),et)):nb)}const s=Hg({callback:rt});return Rl(()=>{s==null||s.disconnect(),rt(),F.forEach(et=>s==null?void 0:s.observe(et))},[F]),Pe}function jS(F){if(!F)return null;if(F.children.length>1)return F;const q=F.children[0];return _f(q)?q:F}function GS(F){let{measure:q}=F;const[ne,me]=tt.useState(null),Pe=tt.useCallback(nt=>{for(const{target:It}of nt)if(_f(It)){me(At=>{const Xt=q(It);return At?on(yr({},At),{width:Xt.width,height:Xt.height}):Xt});break}},[q]),we=Hg({callback:Pe}),rt=tt.useCallback(nt=>{const It=jS(nt);we==null||we.disconnect(),It&&(we==null||we.observe(It)),me(It?q(It):null)},[q,we]),[s,et]=Ag(rt);return tt.useMemo(()=>({nodeRef:s,rect:ne,setRef:et}),[ne,s,et])}const HS=[{sensor:Gg,options:{}},{sensor:Tb,options:{}}],qS={current:{}},dm={draggable:{measure:Y0},droppable:{measure:Y0,strategy:mf.WhileDragging,frequency:Dg.Optimized},dragOverlay:{measure:yf}};class ff extends Map{get(q){var ne;return q!=null&&(ne=super.get(q))!=null?ne:void 0}toArray(){return Array.from(this.values())}getEnabled(){return this.toArray().filter(q=>{let{disabled:ne}=q;return!ne})}getNodeFor(q){var ne,me;return(ne=(me=this.get(q))==null?void 0:me.node.current)!=null?ne:void 0}}const $S={activatorEvent:null,active:null,activeNode:null,activeNodeRect:null,collisions:null,containerNodeRect:null,draggableNodes:new Map,droppableRects:new Map,droppableContainers:new ff,over:null,dragOverlay:{nodeRef:{current:null},rect:null,setRef:pm},scrollableAncestors:[],scrollableAncestorRects:[],measuringConfiguration:dm,measureDroppableContainers:pm,windowRect:null,measuringScheduled:!1},ZS={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:pm,draggableNodes:new Map,over:null,measureDroppableContainers:pm},qg=tt.createContext(ZS),WS=tt.createContext($S);function XS(){return{draggable:{active:null,initialCoordinates:{x:0,y:0},nodes:new Map,translate:{x:0,y:0}},droppable:{containers:new ff}}}function YS(F,q){switch(q.type){case Co.DragStart:return on(yr({},F),{draggable:on(yr({},F.draggable),{initialCoordinates:q.initialCoordinates,active:q.active})});case Co.DragMove:return F.draggable.active==null?F:on(yr({},F),{draggable:on(yr({},F.draggable),{translate:{x:q.coordinates.x-F.draggable.initialCoordinates.x,y:q.coordinates.y-F.draggable.initialCoordinates.y}})});case Co.DragEnd:case Co.DragCancel:return on(yr({},F),{draggable:on(yr({},F.draggable),{active:null,initialCoordinates:{x:0,y:0},translate:{x:0,y:0}})});case Co.RegisterDroppable:{const{element:ne}=q,{id:me}=ne,Pe=new ff(F.droppable.containers);return Pe.set(me,ne),on(yr({},F),{droppable:on(yr({},F.droppable),{containers:Pe})})}case Co.SetDroppableDisabled:{const{id:ne,key:me,disabled:Pe}=q,we=F.droppable.containers.get(ne);if(!we||me!==we.key)return F;const rt=new ff(F.droppable.containers);return rt.set(ne,on(yr({},we),{disabled:Pe})),on(yr({},F),{droppable:on(yr({},F.droppable),{containers:rt})})}case Co.UnregisterDroppable:{const{id:ne,key:me}=q,Pe=F.droppable.containers.get(ne);if(!Pe||me!==Pe.key)return F;const we=new ff(F.droppable.containers);return we.delete(ne),on(yr({},F),{droppable:on(yr({},F.droppable),{containers:we})})}default:return F}}function KS(F){let{disabled:q}=F;const{active:ne,activatorEvent:me,draggableNodes:Pe}=tt.useContext(qg),we=Mg(me),rt=Mg(ne==null?void 0:ne.id);return tt.useEffect(()=>{if(!q&&!me&&we&&rt!=null){if(!fb(we)||document.activeElement===we.target)return;const s=Pe.get(rt);if(!s)return;const{activatorNode:et,node:nt}=s;if(!et.current&&!nt.current)return;requestAnimationFrame(()=>{for(const It of[et.current,nt.current]){if(!It)continue;const At=j2(It);if(At){At.focus();break}}})}},[me,q,Pe,rt,we]),null}function JS(F,q){let Pe=q,{transform:ne}=Pe,me=cf(Pe,["transform"]);return F!=null&&F.length?F.reduce((we,rt)=>rt(yr({transform:we},me)),ne):ne}function QS(F){return tt.useMemo(()=>({draggable:yr(yr({},dm.draggable),F==null?void 0:F.draggable),droppable:yr(yr({},dm.droppable),F==null?void 0:F.droppable),dragOverlay:yr(yr({},dm.dragOverlay),F==null?void 0:F.dragOverlay)}),[F==null?void 0:F.draggable,F==null?void 0:F.droppable,F==null?void 0:F.dragOverlay])}function eE(F){let{activeNode:q,measure:ne,initialRect:me,config:Pe=!0}=F;const we=tt.useRef(!1),{x:rt,y:s}=typeof Pe=="boolean"?{x:Pe,y:Pe}:Pe;Rl(()=>{if(!rt&&!s||!q){we.current=!1;return}if(we.current||!me)return;const nt=q==null?void 0:q.node.current;if(!nt||nt.isConnected===!1)return;const It=ne(nt),At=mb(It,me);if(rt||(At.x=0),s||(At.y=0),we.current=!0,Math.abs(At.x)>0||Math.abs(At.y)>0){const Xt=_b(nt);Xt&&Xt.scrollBy({top:At.y,left:At.x})}},[q,rt,s,me,ne])}const Ib=tt.createContext(on(yr({},Xs),{scaleX:1,scaleY:1}));var Pl;(function(F){F[F.Uninitialized=0]="Uninitialized",F[F.Initializing=1]="Initializing",F[F.Initialized=2]="Initialized"})(Pl||(Pl={}));const tE=tt.memo(function(q){var ne,me,Pe,we;let ho=q,{id:rt,accessibility:s,autoScroll:et=!0,children:nt,sensors:It=HS,collisionDetection:At=rS,measuring:Xt,modifiers:ei}=ho,Vi=cf(ho,["id","accessibility","autoScroll","children","sensors","collisionDetection","measuring","modifiers"]);const Tt=tt.useReducer(YS,void 0,XS),[Dt,Mi]=Tt,[Yt,wi]=W2(),[Ci,tr]=tt.useState(Pl.Uninitialized),vi=Ci===Pl.Initialized,{draggable:{active:Ti,nodes:Si,translate:hr},droppable:{containers:Sr}}=Dt,br=Ti!=null?Si.get(Ti):null,Or=tt.useRef({initial:null,translated:null}),Jt=tt.useMemo(()=>{var Yr;return Ti!=null?{id:Ti,data:(Yr=br==null?void 0:br.data)!=null?Yr:qS,rect:Or}:null},[Ti,br]),On=tt.useRef(null),[yn,rr]=tt.useState(null),[Li,Er]=tt.useState(null),en=Bg(Vi,Object.values(Vi)),Zn=Ng("DndDescribedBy",rt),lo=tt.useMemo(()=>Sr.getEnabled(),[Sr]),xn=QS(Xt),{droppableRects:Wi,measureDroppableContainers:Fn,measuringScheduled:Wo}=DS(lo,{dragging:vi,dependencies:[hr.x,hr.y],config:xn.droppable}),En=PS(Si,Ti),us=tt.useMemo(()=>Li?Cg(Li):null,[Li]),Qn=Xr(),Oi=zS(En,xn.draggable.measure);eE({activeNode:Ti!=null?Si.get(Ti):null,config:Qn.layoutShiftCompensation,initialRect:Oi,measure:xn.draggable.measure});const Gi=tb(En,xn.draggable.measure,Oi),Cr=tb(En?En.parentElement:null),fn=tt.useRef({activatorEvent:null,active:null,activeNode:En,collisionRect:null,collisions:null,droppableRects:Wi,draggableNodes:Si,draggingNode:null,draggingNodeRect:null,droppableContainers:Sr,over:null,scrollableAncestors:[],scrollAdjustedTranslate:null}),nr=Sr.getNodeFor((ne=fn.current.over)==null?void 0:ne.id),kn=GS({measure:xn.dragOverlay.measure}),In=(me=kn.nodeRef.current)!=null?me:En,An=vi?(Pe=kn.rect)!=null?Pe:Gi:null,co=!!(kn.nodeRef.current&&kn.rect),Pr=FS(co?null:Gi),hs=Eb(In?cs(In):null),Bn=kS(vi?nr!=null?nr:En:null),vn=US(Bn),uo=JS(ei,{transform:{x:hr.x-Pr.x,y:hr.y-Pr.y,scaleX:1,scaleY:1},activatorEvent:Li,active:Jt,activeNodeRect:Gi,containerNodeRect:Cr,draggingNodeRect:An,over:fn.current.over,overlayNodeRect:kn.rect,scrollableAncestors:Bn,scrollableAncestorRects:vn,windowRect:hs}),vs=us?rh(us,hr):null,pn=BS(Bn),Po=rb(pn),Rt=rb(pn,[Gi]),qt=rh(uo,Po),bi=An?sS(An,uo):null,ci=Jt&&bi?At({active:Jt,collisionRect:bi,droppableRects:Wi,droppableContainers:lo,pointerCoordinates:vs}):null,xr=tS(ci,"id"),[ar,hi]=tt.useState(null),Xo=co?uo:rh(uo,Rt),Nr=nS(Xo,(we=ar==null?void 0:ar.rect)!=null?we:null,Gi),yo=tt.useRef(null),Yo=tt.useCallback((Yr,Kr)=>{let{sensor:Un,options:vo}=Kr;if(On.current==null)return;const eo=Si.get(On.current);if(!eo)return;const Cn=Yr.nativeEvent,Be=new Un({active:On.current,activeNode:eo,event:Cn,options:vo,context:fn,onAbort(cn){if(!Si.get(cn))return;const{onDragAbort:ii}=en.current,Jr={id:cn};ii==null||ii(Jr),Yt({type:"onDragAbort",event:Jr})},onPending(cn,bo,ii,Jr){if(!Si.get(cn))return;const{onDragPending:ds}=en.current,fe={id:cn,constraint:bo,initialCoordinates:ii,offset:Jr};ds==null||ds(fe),Yt({type:"onDragPending",event:fe})},onStart(cn){const bo=On.current;if(bo==null)return;const ii=Si.get(bo);if(!ii)return;const{onDragStart:Jr}=en.current,Ps={activatorEvent:Cn,active:{id:bo,data:ii.data,rect:Or}};uf.unstable_batchedUpdates(()=>{Jr==null||Jr(Ps),tr(Pl.Initializing),Mi({type:Co.DragStart,initialCoordinates:cn,active:bo}),Yt({type:"onDragStart",event:Ps}),rr(yo.current),Er(Cn)})},onMove(cn){Mi({type:Co.DragMove,coordinates:cn})},onEnd:to(Co.DragEnd),onCancel:to(Co.DragCancel)});yo.current=Be;function to(cn){return async function(){const{active:ii,collisions:Jr,over:Ps,scrollAdjustedTranslate:ds}=fn.current;let fe=null;if(ii&&ds){const{cancelDrop:O}=en.current;fe={activatorEvent:Cn,active:ii,collisions:Jr,delta:ds,over:Ps},cn===Co.DragEnd&&typeof O=="function"&&await Promise.resolve(O(fe))&&(cn=Co.DragCancel)}On.current=null,uf.unstable_batchedUpdates(()=>{Mi({type:cn}),tr(Pl.Uninitialized),hi(null),rr(null),Er(null),yo.current=null;const O=cn===Co.DragEnd?"onDragEnd":"onDragCancel";if(fe){const B=en.current[O];B==null||B(fe),Yt({type:O,event:fe})}})}}},[Si]),xo=tt.useCallback((Yr,Kr)=>(Un,vo)=>{const eo=Un.nativeEvent,Cn=Si.get(vo);if(On.current!==null||!Cn||eo.dndKit||eo.defaultPrevented)return;const Be={active:Cn};Yr(Un,Kr.options,Be)===!0&&(eo.dndKit={capturedBy:Kr.sensor},On.current=vo,Yo(Un,Kr))},[Si,Yo]),Wn=RS(It,xo);NS(It),Rl(()=>{Gi&&Ci===Pl.Initializing&&tr(Pl.Initialized)},[Gi,Ci]),tt.useEffect(()=>{const{onDragMove:Yr}=en.current,{active:Kr,activatorEvent:Un,collisions:vo,over:eo}=fn.current;if(!Kr||!Un)return;const Cn={active:Kr,activatorEvent:Un,collisions:vo,delta:{x:qt.x,y:qt.y},over:eo};uf.unstable_batchedUpdates(()=>{Yr==null||Yr(Cn),Yt({type:"onDragMove",event:Cn})})},[qt.x,qt.y]),tt.useEffect(()=>{const{active:Yr,activatorEvent:Kr,collisions:Un,droppableContainers:vo,scrollAdjustedTranslate:eo}=fn.current;if(!Yr||On.current==null||!Kr||!eo)return;const{onDragOver:Cn}=en.current,Be=vo.get(xr),to=Be&&Be.rect.current?{id:Be.id,rect:Be.rect.current,data:Be.data,disabled:Be.disabled}:null,cn={active:Yr,activatorEvent:Kr,collisions:Un,delta:{x:eo.x,y:eo.y},over:to};uf.unstable_batchedUpdates(()=>{hi(to),Cn==null||Cn(cn),Yt({type:"onDragOver",event:cn})})},[xr]),Rl(()=>{fn.current={activatorEvent:Li,active:Jt,activeNode:En,collisionRect:bi,collisions:ci,droppableRects:Wi,draggableNodes:Si,draggingNode:In,draggingNodeRect:An,droppableContainers:Sr,over:ar,scrollableAncestors:Bn,scrollAdjustedTranslate:qt},Or.current={initial:An,translated:bi}},[Jt,En,ci,bi,Si,In,An,Wi,Sr,ar,Bn,qt]),AS(on(yr({},Qn),{delta:hr,draggingRect:bi,pointerCoordinates:vs,scrollableAncestors:Bn,scrollableAncestorRects:vn}));const Mn=tt.useMemo(()=>({active:Jt,activeNode:En,activeNodeRect:Gi,activatorEvent:Li,collisions:ci,containerNodeRect:Cr,dragOverlay:kn,draggableNodes:Si,droppableContainers:Sr,droppableRects:Wi,over:ar,measureDroppableContainers:Fn,scrollableAncestors:Bn,scrollableAncestorRects:vn,measuringConfiguration:xn,measuringScheduled:Wo,windowRect:hs}),[Jt,En,Gi,Li,ci,Cr,kn,Si,Sr,Wi,ar,Fn,Bn,vn,xn,Wo,hs]),cr=tt.useMemo(()=>({activatorEvent:Li,activators:Wn,active:Jt,activeNodeRect:Gi,ariaDescribedById:{draggable:Zn},dispatch:Mi,draggableNodes:Si,over:ar,measureDroppableContainers:Fn}),[Li,Wn,Jt,Gi,Mi,Zn,Si,ar,Fn]);return Zo.createElement(pb.Provider,{value:wi},Zo.createElement(qg.Provider,{value:cr},Zo.createElement(WS.Provider,{value:Mn},Zo.createElement(Ib.Provider,{value:Nr},nt)),Zo.createElement(KS,{disabled:(s==null?void 0:s.restoreFocus)===!1})),Zo.createElement(K2,on(yr({},s),{hiddenTextDescribedById:Zn})));function Xr(){const Yr=(yn==null?void 0:yn.autoScrollEnabled)===!1,Kr=typeof et=="object"?et.enabled===!1:et===!1,Un=vi&&!Yr&&!Kr;return typeof et=="object"?on(yr({},et),{enabled:Un}):{enabled:Un}}}),iE=tt.createContext(null),ob="button",rE="Draggable";function nE(F){let{id:q,data:ne,disabled:me=!1,attributes:Pe}=F;const we=Ng(rE),{activators:rt,activatorEvent:s,active:et,activeNodeRect:nt,ariaDescribedById:It,draggableNodes:At,over:Xt}=tt.useContext(qg),{role:ei=ob,roleDescription:Vi="draggable",tabIndex:Tt=0}=Pe!=null?Pe:{},Dt=(et==null?void 0:et.id)===q,Mi=tt.useContext(Dt?Ib:iE),[Yt,wi]=Ag(),[Ci,tr]=Ag(),vi=VS(rt,q),Ti=Bg(ne);Rl(()=>(At.set(q,{id:q,key:we,node:Yt,activatorNode:Ci,data:Ti}),()=>{const hr=At.get(q);hr&&hr.key===we&&At.delete(q)}),[At,q]);const Si=tt.useMemo(()=>({role:ei,tabIndex:Tt,"aria-disabled":me,"aria-pressed":Dt&&ei===ob?!0:void 0,"aria-roledescription":Vi,"aria-describedby":It.draggable}),[me,ei,Tt,Dt,Vi,It.draggable]);return{active:et,activatorEvent:s,activeNodeRect:nt,attributes:Si,isDragging:Dt,listeners:me?void 0:vi,node:Yt,over:Xt,setNodeRef:wi,setActivatorNodeRef:tr,transform:Mi}}const oE=40,sb=20;function sE({setNotesHeight:F,notesHeight:q,minHeight:ne=80}){const me=Q2(J2(Gg,{activationConstraint:{distance:2}})),Pe=Zo.useRef(q),we=Zo.useRef(q),rt=()=>{we.current=Pe.current},s=({delta:et})=>{if(typeof(et==null?void 0:et.y)!="number")return;if(we.current===0){if(-et.y>=sb){const At=Math.max(ne,sb);F(At),Pe.current=At}return}const nt=we.current-et.y;if(nt<oE){F(0),Pe.current=0;return}const It=Math.max(ne,nt);F(It),Pe.current=It};return Wr.jsx(tE,{sensors:me,onDragStart:rt,onDragMove:s,children:Wr.jsx(aE,{notesHeight:q})})}function aE({notesHeight:F}){const{attributes:q,listeners:ne,setNodeRef:me}=nE({id:"speaker-notes-resize-handle"});return Wr.jsx(m2,{label:Wr.jsx(zg,{id:"eTM8rh",defaultMessage:"Drag up to open speaker notes"}),side:"top",disabled:F!==0,children:Wr.jsx("div",on(yr(yr({ref:me},ne),q),{className:"mx-auto h-2 w-9 cursor-row-resize select-none",children:Wr.jsx("div",{className:"h-[3px] w-full rounded bg-gray-300"})}))})}const lE=({slide:F})=>{const q=tt.useMemo(()=>{var me;return(me=F.notesSlide)==null?void 0:me.elements.map(Pe=>Pe.paragraphs.map(we=>we.runs.map(rt=>rt.text).join("")).join("\n")).join("\n").trim()},[F]),ne=tt.useMemo(()=>q&&q.length>0,[q]);return Wr.jsx("div",{className:"bg-token-bg-primary h-full w-full overflow-y-auto rounded-md p-4 text-sm",children:ne?Wr.jsx("div",{className:"text-token-text-secondary",children:q}):Wr.jsx("div",{className:"text-token-text-tertiary",children:Wr.jsx(zg,{id:"walnut.speaker-notes",defaultMessage:"There are no speaker notes for this slide."})})})};function cE(F,q,ne,me){tt.useEffect(()=>{if(!F)return;const Pe=we=>{if(we.key!=="ArrowUp"&&we.key!=="ArrowDown")return;const rt=F.slides,s=q?rt.indexOf(q):-1;if(s===-1)return;let et=s;if(we.key==="ArrowUp"&&s>0&&(et=s-1),we.key==="ArrowDown"&&s<rt.length-1&&(et=s+1),et!==s){ne(et);const nt=me.current[et];nt==null||nt.scrollIntoView({block:"nearest"}),nt==null||nt.focus()}we.preventDefault()};return window.addEventListener("keydown",Pe),()=>window.removeEventListener("keydown",Pe)},[F,q,ne,me])}const uE=100;function SE({presentation:F,selectedSlideIdx:q,setSelectedSlideIdx:ne,isEditing:me,setIsEditing:Pe}){var pn,Po;const we=F.slides[q],rt=p2,[s,et]=tt.useState(()=>new Array(F.slides.length).fill(null));tt.useEffect(()=>{et(new Array(F.slides.length).fill(null))},[F]);const[nt,It]=tt.useState(null),[At,Xt]=tt.useState(null),[ei,Vi]=tt.useState(null),Tt=tt.useRef([]),Dt=tt.useRef(null),Mi=tt.useRef(null),Yt=tt.useRef(null),wi=tt.useRef(null),Ci=tt.useRef(null),tr=tt.useRef(null),[vi,Ti]=tt.useState([]),[Si,hr]=tt.useState(null),[Sr,br]=tt.useState(null),[{ctx:Or,version:Jt},On]=tt.useState({ctx:null,version:0}),[yn,rr]=tt.useState({width:0,height:0}),[Li,Er]=tt.useState(null),[{ctx:en,version:Zn},lo]=tt.useState({ctx:null,version:0}),[xn,Wi]=tt.useState({width:0,height:0}),[Fn,Wo]=tt.useState(null),En=tt.useRef(1);tt.useCallback(Rt=>{On(qt=>qt.ctx===Rt?Rt===null?qt:{ctx:Rt,version:qt.version+1}:{ctx:Rt,version:qt.version+1})},[]),tt.useCallback(Rt=>{lo(qt=>qt.ctx===Rt?qt:{ctx:Rt,version:qt.version+1})},[]);const us=tt.useCallback(Rt=>{const qt=En.current;if(!Number.isFinite(qt)||qt<=0)return;const bi=Math.max(0,Math.round(Rt.plotDims.width*qt)),ci=Math.max(0,Math.round(Rt.plotDims.height*qt)),xr=Math.round(Rt.plotDims.x*qt),ar=Math.round(Rt.plotDims.y*qt);if(bi===0||ci===0){Er(hi=>hi===null?hi:null),rr(hi=>hi.width===0&&hi.height===0?hi:{width:0,height:0});return}Er(hi=>hi&&hi.left===xr&&hi.top===ar&&hi.width===bi&&hi.height===ci?hi:{left:xr,top:ar,width:bi,height:ci}),rr(hi=>hi.width===bi&&hi.height===ci?hi:{width:bi,height:ci})},[]),Qn=tt.useCallback(Rt=>{const qt=En.current;if(!Number.isFinite(qt)||qt<=0)return;const bi=Math.max(0,Math.round(Rt.plotDims.width*qt)),ci=Math.max(0,Math.round(Rt.plotDims.height*qt)),xr=Math.round(Rt.plotDims.x*qt),ar=Math.round(Rt.plotDims.y*qt);if(bi===0||ci===0){Wo(hi=>hi!=null?hi:null),Wi(hi=>hi.width===0&&hi.height===0?hi:{width:0,height:0});return}Wo(hi=>hi&&hi.left===xr&&hi.top===ar&&hi.width===bi&&hi.height===ci?hi:{left:xr,top:ar,width:bi,height:ci}),Wi(hi=>hi.width===bi&&hi.height===ci?hi:{width:bi,height:ci})},[]),Oi=tt.useMemo(()=>we?we.elements.some(Rt=>{var ci;if(Rt.type!==Z0.ELEMENT_TYPE_CHART_REFERENCE)return!1;const qt=(ci=Rt.chartReference)==null?void 0:ci.id;if(!qt)return!1;const bi=F.charts.find(xr=>xr.id===qt);return(bi==null?void 0:bi.type)===vg.CHART_TYPE_BAR_3D||(bi==null?void 0:bi.type)===vg.CHART_TYPE_PIE_3D}):!1,[we,F]),Gi=tt.useMemo(()=>we?we.elements.some(Rt=>{var ci;if(Rt.type!==Z0.ELEMENT_TYPE_CHART_REFERENCE)return!1;const qt=(ci=Rt.chartReference)==null?void 0:ci.id;if(!qt)return!1;const bi=F.charts.find(xr=>xr.id===qt);return(bi==null?void 0:bi.type)===vg.CHART_TYPE_MAP}):!1,[we,F]),{width:Cr,height:fn}=D2(Yt,100),nr=tt.useCallback(async Rt=>{if(s[Rt]==null)try{const qt=F.slides[Rt];if(!qt)return;const bi=await T2(qt,F);et(ci=>{if(ci.length!==F.slides.length||ci[Rt]===bi)return ci;const xr=[...ci];return xr[Rt]=bi,xr})}catch(qt){_2.addError(qt)}},[F,s]),kn=tt.useCallback(Rt=>{const qt=Rt+1;qt<F.slides.length&&nr(qt)},[F.slides.length,nr]);tt.useEffect(()=>(tr.current&&tr.current.disconnect(),tr.current=new IntersectionObserver(Rt=>{Rt.forEach(qt=>{var ar;const bi=qt.target,ci=bi.getAttribute("data-index");if(!ci)return;const xr=Number(ci);qt.isIntersecting&&(nr(xr).then(()=>{kn(xr)}),(ar=tr.current)==null||ar.unobserve(bi))})},{root:Ci.current,rootMargin:"200px 0px",threshold:.05}),Tt.current.forEach(Rt=>{var qt;Rt&&((qt=tr.current)==null||qt.observe(Rt))}),()=>{var Rt;return(Rt=tr.current)==null?void 0:Rt.disconnect()}),[F,nr,kn]),tt.useEffect(()=>{hr(null),br(null)},[Cr,fn]),tt.useEffect(()=>{const Rt=()=>{hr(null),br(null)};return window.addEventListener("click",Rt),()=>window.removeEventListener("click",Rt)},[]),tt.useEffect(()=>{const Rt=Dt.current;if(!Rt||!we||Cr===0||fn===0||!Yt.current)return;const qt=we.widthEmu*Jn,bi=we.heightEmu*Jn,ci=Yt.current.clientWidth,xr=Yt.current.clientHeight,ar=Math.min(ci/qt,xr/bi),hi=Math.round(window.devicePixelRatio)||1,Xo=Math.round(qt*ar),Nr=Math.round(bi*ar),yo=Math.round(Xo*hi),Yo=Math.round(Nr*hi);Rt.width!==yo&&(Rt.width=yo),Rt.height!==Yo&&(Rt.height=Yo);const xo=Rt.getBoundingClientRect(),Wn=Math.min(xo.width/qt,xo.height/bi);En.current=Number.isFinite(Wn)?Wn:ar;const Mn=Rt.getContext("2d");if(!Mn)return;Oi||rr(Xr=>Xr.width===Xo&&Xr.height===Nr?Xr:{width:Xo,height:Nr}),Mn.resetTransform(),Mn.scale(hi*ar,hi*ar);let cr=!1;return(async()=>{const Xr=[],ho=Oi&&Li&&Or?Or:null,Yr=Gi&&Fn&&en&&rt?en:null;ho&&(ho.renderer.setScissorTest(!1),ho.clear()),await v2(we,F,Mn,Xr,ho,Oi?us:void 0,Yr,Gi&&rt?Qn:void 0),!cr&&(Ti(Xr),me&&E2(Mn,F,nt,At,ei!=null,we))})(),()=>{cr=!0}},[we,F,nt,At,ei,Cr,fn,me,Or,Jt,Oi,Li,us,en,Zn,Gi,Fn,Qn,rt]),cE(F,we!=null?we:null,ne,Tt);const In=z2(F,we,Mi,Dt,hr,vi,ne),An=O2(F,we,Dt,ei,Vi,At,It,vi),co=()=>{ei||It(null)},Pr=L2(F,we,Mi,Dt,me,At,Xt,It,Vi),hs=()=>Vi(null);tt.useEffect(()=>{Xt(null),It(null)},[we]),F2(Mi,we,F);const[Bn,vn]=tt.useState(uE),uo=Cr>0&&fn>0;tt.useEffect(()=>{if(!Oi){Er(Rt=>Rt===null?Rt:null),rr(Rt=>Rt.width===0&&Rt.height===0?Rt:{width:0,height:0});return}Er(Rt=>Rt===null?Rt:null),rr(Rt=>Rt.width===0&&Rt.height===0?Rt:{width:0,height:0})},[Oi,q,Cr,fn]),tt.useEffect(()=>{(!Gi||Cr===0||fn===0)&&(Wo(Rt=>Rt===null?Rt:null),Wi(Rt=>Rt.width===0&&Rt.height===0?Rt:{width:0,height:0}))},[Gi,Cr,fn]),tt.useEffect(()=>{!Gi||!en||en.clear()},[Gi,en,q]),g2(()=>{if(!Si||!wi.current||!Mi.current)return;const{x:Rt,y:qt,placement:bi}=Si,ci=wi.current.getBoundingClientRect(),xr=Mi.current.getBoundingClientRect();let ar=Rt+(bi==="right"?0:-ci.width),hi=qt-ci.height;ar=Math.max(0,Math.min(ar,xr.width-ci.width)),hi=Math.max(0,Math.min(hi,xr.height-ci.height)),br({left:ar,top:hi})},[Si]);const vs=(we==null?void 0:we.widthEmu)*Jn/((we==null?void 0:we.heightEmu)*Jn);return Wr.jsx("div",{className:"flex h-full flex-col gap-4 overflow-hidden",children:Wr.jsxs("div",{className:"flex h-full flex-1 flex-row",children:[Wr.jsx("div",{ref:Ci,className:"border-token-border-light flex h-full w-full shrink-0 flex-col gap-4 overflow-y-auto border-e p-2 sm:w-[240px]",children:F.slides.map((Rt,qt)=>{const bi=F.slides[qt]===we,ci=s[qt];return Wr.jsxs("button",{ref:xr=>{Tt.current[qt]=xr,xr&&tr.current&&ci==null&&tr.current.observe(xr)},"data-index":qt,type:"button",onClick:()=>ne(qt),className:"flex w-full gap-3 rounded-md p-2 ".concat(bi?"ring-2 ring-blue-500/60":""),children:[Wr.jsx("div",{className:"text-token-text-primary text-sm font-semibold",children:qt+1}),Wr.jsx("div",{className:"bg-token-bg-secondary border-token-border-light relative w-full overflow-hidden rounded-md border",children:ci?Wr.jsx("img",{src:ci,alt:"",className:"block w-full",draggable:!1}):Wr.jsx("div",{className:"w-full animate-pulse bg-gray-200",style:{aspectRatio:vs}})})]},qt)})}),Wr.jsxs("div",{className:"bg-token-bg-secondary/20 hidden flex-1 flex-col items-center justify-center overflow-hidden sm:flex",children:[we?Wr.jsx("div",{className:"flex w-full flex-1 flex-col items-center justify-center overflow-hidden p-6",ref:Yt,children:Wr.jsxs("div",{ref:Mi,className:"border-token-border-light relative flex items-center justify-center overflow-hidden rounded-md border shadow-md ".concat(uo?"visible":"invisible"),children:[Wr.jsx("canvas",{ref:Dt,onMouseMove:An,onMouseLeave:co,onMouseDown:Pr,onMouseUp:hs,onClick:In,className:"max-h-full max-w-full select-none"}),!1,!1,Wr.jsx(y2,{children:Si&&Wr.jsx(x2.div,{ref:wi,initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.15,ease:"easeOut"},className:"absolute z-50 max-w-[300px] px-1 py-2 text-xs",style:{left:(pn=Sr==null?void 0:Sr.left)!=null?pn:0,top:(Po=Sr==null?void 0:Sr.top)!=null?Po:0},onClick:()=>{hr(null),br(null)},children:Wr.jsx("div",{className:"bg-token-bg-primary text-token-text-primary truncate rounded-md px-1 py-2 shadow-md",children:Si.url})})})]})}):Wr.jsx("span",{className:"text-gray-400",children:Wr.jsx(zg,{id:"load-deck-to-begin",defaultMessage:"Load a slide to begin"})}),Wr.jsx(sE,{setNotesHeight:vn,notesHeight:Bn}),Wr.jsx("div",{className:"text-token-text-primary w-full px-6 pt-3 pb-6 text-sm",style:{height:"".concat(Bn,"px")},children:Wr.jsx(lE,{slide:we})}),!1]})]})})}export{SE as CanvasRenderer};
//# sourceMappingURL=ko2jg964wqp2o92l.js.map

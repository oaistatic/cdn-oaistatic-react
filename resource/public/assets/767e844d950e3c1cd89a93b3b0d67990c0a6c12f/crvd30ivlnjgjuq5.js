const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jtua2sy614gg6469.js","assets/mw35uwhq4g8r9eam.js","assets/g2euln7v5pbm31qa.js","assets/d0xa318sl7ywi0za.js","assets/root-kavs8piy.css","assets/conversation-small-lq38g8zw.css","assets/ii6qhpkhs6vyylw8.js","assets/eder15khh2fy5wd2.js","assets/kl0a548ohmz3fby2.js","assets/obpubb7ugisfu36u.js","assets/ojmli062couj7r3v.js","assets/lv7ytt0l14b17ows.js","assets/gl4f6lge29au0ljx.js","assets/iio0zgk2sqlxbcjy.js","assets/ek39x165c6r9yjtf.js"])))=>i.map(i=>d[i]);
var it=Object.freeze,ct=Object.defineProperty,Ot=Object.defineProperties;var zt=Object.getOwnPropertyDescriptors;var rt=Object.getOwnPropertySymbols;var Vt=Object.prototype.hasOwnProperty,Ht=Object.prototype.propertyIsEnumerable;var ot=(e,t,n)=>t in e?ct(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Ie=(e,t)=>{for(var n in t||(t={}))Vt.call(t,n)&&ot(e,n,t[n]);if(rt)for(var n of rt(t))Ht.call(t,n)&&ot(e,n,t[n]);return e},lt=(e,t)=>Ot(e,zt(t));var dt=(e,t)=>it(ct(e,"raw",{value:it(t||e.slice())}));import{j as s,r as i,h as re,d as Lt,u as wt,k as qt,M as se,c as Wt,_ as Kt}from"./mw35uwhq4g8r9eam.js";import{cF as X,xu as fe,_ as bt,xv as $t,P as Ne,V as ue,ay as Qt,e5 as ce,aA as be,dv as Yt,es as Jt,au as ut,lr as gt,xw as Xt,n5 as mt,kq as Zt,ls as ft,u as pe,e7 as en,ak as tn,J as Me,ek as nn,cB as an,e1 as sn,O as Mt,fr as rn,fs as on,ft as cn,aV as ln,D as ke,M as dn,iO as un,R as he,k as je,ab as gn,p as kt,py as ht,g as mn,d as xt,jZ as fn,ti as hn,bj as xn,bq as pn,be as _n}from"./d0xa318sl7ywi0za.js";import{I as Se,D as jt,u as vn}from"./mn6hno74yixdlr64.js";import{xJ as C,bn as In,gk as Sn,jE as yn,jF as wn,xK as bn,eT as Mn,eZ as J,eV as kn,dE as jn,em as En,xL as Cn,xM as Rn,xN as Nn,cf as Et,e_ as Te,xO as Tn,xP as Gn,nt as Ee,nQ as Ct,xQ as Un,xR as pt,xS as An,xT as Pn}from"./g2euln7v5pbm31qa.js";import{C as Rt}from"./ddina39kz3r81pp7.js";import{D as Dn}from"./jybdx70geuzrnoab.js";import{C as Bn}from"./mdh3gu2zvzp3cu8r.js";import"./e5bg4yzr7nht9sxr.js";import"./mpb8yfob3hqr4zw5.js";import"./iue4s7sqsxkz98qq.js";function Fn({title:e,description:t,shimmer:n}){return!e&&!t?null:s.jsxs("div",{className:"border-token-border-default my-2 max-w-[480px] min-w-72 rounded-2xl border p-6",children:[!!e&&s.jsx("p",{className:X("text-lg font-medium",n&&"loading-shimmer-pure-text-inverted",!!t&&"mb-1"),children:e}),!!t&&s.jsx("p",{children:t})]})}const On={handleRenderPercentUpdate:()=>{}},ie=new Map,zn=600*1e3,Vn=60*1e3;let _t=0;function Hn({clientThreadId:e,toolCallMessage:t,imageMessages:n}){var g,b,_,x,k,w;if(!e)return{containsUserUploadedContent:void 0,userUploadedContentCount:void 0};const a=Ne(e),r=(b=t==null?void 0:t.id)!=null?b:(g=n[0])==null?void 0:g.id;if(!a||!r)return{containsUserUploadedContent:void 0,userUploadedContentCount:void 0};const c=ue.getTree(a).getBranchFromLeaf(ue.getCurrentLeafId(a)).map(I=>I.message),o=c.findIndex(I=>I.id===r);if(o===-1)return{containsUserUploadedContent:void 0,userUploadedContentCount:void 0};const p=(_=c[o].metadata)==null?void 0:_.turn_exchange_id;if(!p)return{containsUserUploadedContent:void 0,userUploadedContentCount:void 0};const d=c.map((I,M)=>({message:I,idx:M})).filter(({message:I,idx:M})=>{var S;return M<o&&((S=I.metadata)==null?void 0:S.turn_exchange_id)===p}).map(({message:I})=>I).reverse().find(I=>I.author.role===Qt.User);if(!d)return{containsUserUploadedContent:void 0,userUploadedContentCount:void 0};const u=(w=(k=(x=d.metadata)==null?void 0:x.attachments)==null?void 0:k.filter(I=>I.height!=null&&I.width!=null).length)!=null?w:0;return{containsUserUploadedContent:u>0?!!u:void 0,userUploadedContentCount:u>0?u:void 0}}function Ln({toolCallMessage:e,imageMessages:t,conversationId:n,clientThreadId:a,imageGenerationState:r}){"use no forget";const l=i.useMemo(()=>t.map(g=>g.id),[t]),c=i.useMemo(()=>l.join(","),[l]),o=i.useMemo(()=>qn({toolCallMessage:e,imageMessages:t,conversationId:n,imageMessageIds:l,messageIdsKey:c,clientThreadId:a}),[e,t,n,l,c,a]),p=i.useRef(o);p.current=o,i.useEffect(()=>{o!=null&&o.key&&Ce(o)},[o]);const f=i.useCallback(({messageId:g,renderCompletePercent:b})=>{var S,E;const _=p.current;if(!(_!=null&&_.key)||!g||b==null||!Number.isFinite(b))return;const x=Ce(_);if(!x)return;const k=Xn(b);if(k<=0)return;const w=Math.min(100,Math.max(1,Math.round(k*100))),I=(S=x.lastLoggedPercent.get(g))!=null?S:0;if(w<=I)return;x.lastLoggedPercent.set(g,w),x.firstTokenLogged.has(g)||(x.firstTokenLogged.add(g),xe(x,{stageType:fe.CHATGPT_IMAGE_GEN_CLIENT_STAGE_TYPE_FIRST_TOKEN_RENDERED,messageId:g}));const M=((E=x.segmentIndexByMessage.get(g))!=null?E:0)+1;if(x.segmentIndexByMessage.set(g,M),xe(x,{stageType:fe.CHATGPT_IMAGE_GEN_CLIENT_STAGE_TYPE_SEGMENT_RENDERED,messageId:g,segmentPercent:w,segmentIndex:M}),w>=100){x.completedMessageIds.add(g),xe(x,{stageType:fe.CHATGPT_IMAGE_GEN_CLIENT_STAGE_TYPE_GENERATION_COMPLETED,messageId:g});return}},[]),d=i.useMemo(()=>({handleRenderPercentUpdate:f}),[f]),u=Jn(r);return i.useEffect(()=>{u&&Qn(p.current)},[u]),i.useEffect(()=>{r!==C.Complete&&r!==C.Errored&&r!==C.Empty||Yn(p.current)},[r,c]),o!=null&&o.key?d:On}function qn({toolCallMessage:e,imageMessages:t,conversationId:n,imageMessageIds:a,messageIdsKey:r,clientThreadId:l}){var g,b,_,x,k;const c=Wn(t,e),o=(b=c!=null?c:e==null?void 0:e.id)!=null?b:(g=t[0])==null?void 0:g.id;if(!o)return null;const p=Kn(e,t),f=t[0],{containsUserUploadedContent:d,userUploadedContentCount:u}=Hn({clientThreadId:l,toolCallMessage:e,imageMessages:t});return{key:o,promptStartMs:p,metadata:{conversationId:n,toolInvocationMessageId:e==null?void 0:e.id,modelSlug:(k=(_=e==null?void 0:e.metadata)==null?void 0:_.model_slug)!=null?k:(x=f==null?void 0:f.metadata)==null?void 0:x.model_slug,containsUserUploadedContent:d,userUploadedContentCount:u,defaultMessageId:f==null?void 0:f.id,imageGenGroupId:c},messageIds:a,messageIdsKey:r}}function Wn(e,t){var n,a;for(const r of e){const l=(n=r.metadata)==null?void 0:n.image_gen_group_id;if(l)return l}return(a=t==null?void 0:t.metadata)==null?void 0:a.image_gen_group_id}function Kn(e,t){const n=[];if(typeof(e==null?void 0:e.create_time)=="number"&&n.push(e.create_time),t==null||t.forEach(r=>{typeof r.create_time=="number"&&n.push(r.create_time)}),n.length===0)return Date.now();const a=Math.min(...n);return Math.floor(a*1e3)}function Ce(e){var a,r,l,c,o,p,f,d,u,g,b,_,x,k;if(!(e!=null&&e.key))return null;const t=Date.now();let n=ie.get(e.key);return n?(e.messageIds.forEach(w=>n==null?void 0:n.messageIds.add(w)),e.promptStartMs<n.promptStartMs&&(n.promptStartMs=e.promptStartMs),(r=(a=n.metadata).modelSlug)!=null||(a.modelSlug=e.metadata.modelSlug),(c=(l=n.metadata).containsUserUploadedContent)!=null||(l.containsUserUploadedContent=e.metadata.containsUserUploadedContent),(p=(o=n.metadata).userUploadedContentCount)!=null||(o.userUploadedContentCount=e.metadata.userUploadedContentCount),(d=(f=n.metadata).toolInvocationMessageId)!=null||(f.toolInvocationMessageId=e.metadata.toolInvocationMessageId),(g=(u=n.metadata).conversationId)!=null||(u.conversationId=e.metadata.conversationId),(_=(b=n.metadata).defaultMessageId)!=null||(b.defaultMessageId=e.metadata.defaultMessageId),(k=(x=n.metadata).imageGenGroupId)!=null||(x.imageGenGroupId=e.metadata.imageGenGroupId),n.lastUpdatedMs=t):(n={promptStartMs:e.promptStartMs,placeholderLogged:!1,firstTokenLogged:new Set,completedMessageIds:new Set,lastLoggedPercent:new Map,segmentIndexByMessage:new Map,metadata:Ie({},e.metadata),messageIds:new Set(e.messageIds),lastUpdatedMs:t},ie.set(e.key,n)),$n(t),n}function $n(e){if(!(e-_t<Vn)){_t=e;for(const[t,n]of ie.entries())e-n.lastUpdatedMs>zn&&ie.delete(t)}}function xe(e,{stageType:t,messageId:n,segmentPercent:a,segmentIndex:r}){e.lastUpdatedMs=Date.now(),bt.logStructuredEvent($t,{conversationId:e.metadata.conversationId,messageId:n,toolInvocationMessageId:e.metadata.toolInvocationMessageId,imageGenGroupId:e.metadata.imageGenGroupId,stageType:t,elapsedTimeSincePromptMs:Math.max(e.lastUpdatedMs-e.promptStartMs,0),segmentMetadata:a!==void 0?lt(Ie({},r!==void 0?{segmentIndex:r}:{}),{renderCompletePercent:a}):void 0,containsUserUploadedContent:e.metadata.containsUserUploadedContent,userUploadedContentCount:e.metadata.userUploadedContentCount,modelSlug:e.metadata.modelSlug})}function Qn(e){const t=Ce(e);!t||t.placeholderLogged||(t.placeholderLogged=!0,xe(t,{stageType:fe.CHATGPT_IMAGE_GEN_CLIENT_STAGE_TYPE_PLACEHOLDER_RENDERED,messageId:t.metadata.defaultMessageId}))}function Yn(e){if(!(e!=null&&e.key))return;const t=ie.get(e.key);if(!t)return;if(e.messageIds.length===0){ie.delete(e.key);return}e.messageIds.every(a=>t.completedMessageIds.has(a))&&ie.delete(e.key)}function Jn(e){return e===C.Thinking||e===C.Generating||e===C.AsyncGenerating||e===C.AsyncHanging}function Xn(e){return!Number.isFinite(e)||e<0?0:e>1?1:e}const Nt=({children:e,isDimensionsUnknown:t})=>s.jsxs(ce.div,{className:X(["relative max-w-[480px] rounded-2xl",t&&"aspect-square overflow-hidden"]),children:[s.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),s.jsx("div",{className:"relative h-full",children:e})]}),Zn=({children:e,isDimensionsUnknown:t,width:n,height:a})=>s.jsxs(ce.div,{layout:!0,transition:{duration:.3,ease:"easeInOut"},exit:{opacity:0,transition:{duration:.1,ease:"easeInOut"}},className:X(["relative max-w-[480px] overflow-hidden rounded-2xl",t&&"aspect-square"]),style:{width:n!=null?n:"auto",height:a!=null?a:"auto"},children:[s.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),s.jsx("div",{className:"relative h-full",children:e})]}),ea=()=>{const e=re(),t=Lt();return s.jsxs("div",{className:"absolute start-0 bottom-0 flex w-full items-center justify-between bg-white/10 p-4",children:[s.jsxs("div",{className:"flex min-w-0 flex-col",children:[s.jsx("span",{className:"text-sm font-medium text-white",children:e.formatMessage({id:"PlfJ+x",defaultMessage:"Creation might take a moment"})}),s.jsx("span",{className:"text-sm font-normal text-white/80",children:e.formatMessage({id:"4JG8yC",defaultMessage:"Upgrade to create faster"})})]}),s.jsx(be,{size:"medium",color:"primary-inverse",onClick:()=>In(t,"Image Gen Latency Upsell"),children:e.formatMessage(Yt.getPlus)})]})};function ta(e){const[t,n]=Jt(ut.ImageGenProgressUpsellV2,null,o=>o!=null&&typeof o=="object"&&(typeof o.lastSeenUpsellAt=="number"||o.lastSeenUpsellAt==null)&&(typeof o.lastUsedImageGen=="number"||o.lastUsedImageGen==null)&&(typeof o.lastMessageId=="string"||o.lastMessageId==null)&&(typeof o.lastCanBeSeen=="boolean"||o.lastCanBeSeen==null)),a=t&&t.lastSeenUpsellAt?gt(t.lastSeenUpsellAt):null,r=t&&t.lastUsedImageGen?gt(t.lastUsedImageGen):null,l=e?t&&t.lastMessageId===e?t.lastCanBeSeen:(a==null||Xt(a,mt(new Date,3)))&&r!=null&&Zt(r,mt(new Date,1)):!1;return{canBeSeen:l,markImageGenUsed:()=>{var o;if(e){const p={lastSeenUpsellAt:l?ft(new Date):(o=t==null?void 0:t.lastSeenUpsellAt)!=null?o:null,lastUsedImageGen:ft(new Date),lastMessageId:e!=null?e:null,lastCanBeSeen:l};n(p),localStorage.setItem(ut.ImageGenProgressUpsellV2,JSON.stringify(p))}}}}function na(){const[t,n]=i.useState(new Date);i.useEffect(()=>{n(new Date)},[]);const a=yn(+t,12e4);return s.jsx(wn,{percentage:a,sizeOverride:30,thickness:1/15,className:"text-white",backgroundStrokeClassName:"stroke-white/20",transitionDuration:"".concat((100-a)/100*.2,"s"),transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})}const Tt=({isGettingStarted:e,messageId:t})=>{var d;const n=pe(),a=en(),r=(d=a==null?void 0:a.isFree())!=null?d:!1,{canBeSeen:l,markImageGenUsed:c}=ta(t),o=r&&l&&tn(n,"1997515563").get("should_show_image_gen_latency_upsell",!1);Sn(()=>{c()});const p=Me(n,"3018147683"),f=i.useMemo(()=>e?s.jsx(Rt,{size:30,arcPercentage:.2,strokeWidth:2}):s.jsx(na,{}),[e]);return s.jsxs("div",{className:X("absolute inset-0 flex justify-between px-6 py-6",o?"items-start":"items-end"),children:[s.jsx(nn,{mode:"popLayout",children:!p&&s.jsx("div",{className:"flex flex-1 items-center justify-end",children:f})}),o&&s.jsx(ea,{})]})};var yt;const vt=an.div(yt||(yt=dt(["invisible absolute top-3 flex gap-1 group-hover/paragen-image:visible z-2\n  ","\n  ",""])),({$rightAlign:e})=>e?"end-3":"start-3",({$alwaysVisible:e})=>e?"visible":""),aa=({imageUrl:e})=>{const[t,n]=i.useState(void 0),a=re(),r=bn(),l=i.useCallback(()=>{const c=new Date,o=a.formatDate(c,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});return"".concat(o,".png")},[a]);return s.jsxs("div",{className:"group/paragen-image absolute inset-0 z-3",children:[s.jsxs(vt,{$alwaysVisible:!0,children:[t!==!1&&s.jsx(Se,{icon:Mn,selected:t===!0,variant:"large",onClick:c=>{c.stopPropagation(),J.paragenImageRated({liked:!0,analyticsContext:r}),n(!0)}}),t!==!0&&s.jsx(Se,{icon:kn,selected:t===!1,variant:"large",onClick:c=>{c.stopPropagation(),J.paragenImageRated({liked:!1,analyticsContext:r}),n(!1)}})]}),s.jsx(vt,{$alwaysVisible:!0,$rightAlign:!0,children:s.jsx(Se,{icon:jn,variant:"large",onClick:c=>{c.stopPropagation(),J.paragenDownload({analyticsContext:r}),En({url:e,fileName:l()})}})})]})};function Gt({withLottie:e}){const n=re().formatMessage({id:"imagegen.progressIndicator.ariaLabel",defaultMessage:"Generating image..."});return s.jsx("div",{className:"absolute start-0 top-0 flex h-full w-full items-center justify-center rounded-full","aria-label":n,children:s.jsx(Rt,{size:40,arcPercentage:.2,children:s.jsx(Dn,{animate:e,matchTextColor:!0,className:"h-6 w-6"})})})}const Ut=300,sa=1.3,It=.05,ia=/blur\(([\d.]+)px\)/,ra={duration:Ut/1e3,ease:"linear"};function ye(e,t,n){var c,o,p,f,d;e.sort((u,g)=>u.lastSrcReceivedTime-g.lastSrcReceivedTime);const a=new Array(e.length).fill(0);for(let u=0;u<=e.length;u+=1){const g=u-1,b=u,_=(o=(c=e[g])==null?void 0:c.availablePercentComplete)!=null?o:0,x=(f=(p=e[b])==null?void 0:p.availablePercentComplete)!=null?f:1;if(t>=_&&t<=x&&_!==x){const k=(t-_)/(x-_);a[g]=1-k,a[b]=k}}const r=a[a.length-1],l=a[a.length-2];return r===1&&l===0&&(a[a.length-2]=.01),n&&t<=((d=e[0])==null?void 0:d.availablePercentComplete)&&(a[0]=1),a}const oa=({alt:e,src:t,availablePercentComplete:n,onAnimationUpdate:a,ignoreFirstChunk:r=!1,isTransparent:l=!1,dimensions:c,onError:o,unconstrainedWidth:p=!1,progressLoaderProps:f})=>{const d=sn(),u=i.useMemo(()=>"url(".concat(d?Cn:Rn,")"),[d]),[g,b]=i.useState(!1),[_,x]=i.useState(1e3),[k,w]=i.useState(n!=null?n:0),[I,M]=i.useState(n===1?1:0),S=i.useRef(performance.now()),E=i.useRef(0),m=i.useRef([]),[A,z]=i.useState([0]),[ne,D]=i.useState(n===1),P=i.useRef(!1),O=i.useRef(null),H=k===1,R=n===1&&ne,U=c?c.width/c.height:1;i.useEffect(()=>{!g&&n&&(b(!0),E.current=performance.now())},[g,n]),i.useEffect(()=>{var j;const y=(j=m.current[m.current.length-1])==null?void 0:j.src;if(t&&t!==y){const G=m.current.findIndex(N=>N.availablePercentComplete===n);G!==-1?m.current[G]={src:t,availablePercentComplete:n!=null?n:0,lastSrcReceivedTime:performance.now()}:m.current.push({src:t,availablePercentComplete:n!=null?n:0,lastSrcReceivedTime:performance.now()}),z(ye(m.current,k,r))}},[t,k,r,n]);const Z=i.useCallback(()=>{O.current&&n&&(x(R?Ut:(performance.now()-S.current)*sa),(!r||P.current||n>=It)&&n!==1&&M(n),P.current=!0,S.current=performance.now(),f==null||f.setHasImageReady(!0))},[n,R,r,f]),ee=i.useCallback(y=>{const j=parseFloat(y.height)/100;a==null||a(j),w(j),z(ye(m.current,parseFloat(y.height)/100,r))},[a,r]),ae=i.useCallback(y=>{var L,W;const j=(W=(L=y.filter.toString().match(ia))==null?void 0:L[1])!=null?W:"0",N=(16-parseFloat(j))/16,K=1-I,Q=I+K*N;a==null||a(Q),w(Q),z(ye(m.current,Q,r))},[r,I,a]);if(!g)return s.jsx(Nt,{isDimensionsUnknown:!0,children:s.jsx(Gt,{withLottie:!0})});const v={duration:_/1e3,ease:"linear"},h=n!==1||!l;return s.jsxs("div",{className:X("relative z-0 cursor-pointer overflow-hidden",U<1?"max-w-[400px]":"max-w-[480px]",!H&&"pointer-events-none",!P.current&&"bg-token-main-surface-secondary",p&&"max-w-full"),"aria-label":e,style:{aspectRatio:U},children:[!(f!=null&&f.shouldHideDiagonalShimmer)&&n&&n<It&&s.jsx("div",{className:"absolute inset-0 z-3 w-full overflow-hidden",children:s.jsx("div",{className:"absolute start-[-150%] top-[-150%] h-[400%] w-[400%]",children:s.jsx("div",{className:"diagonal-sweep-gradient h-full w-full"})})}),s.jsxs(ce.div,{className:"absolute start-0 end-0 top-0 z-2 w-full overflow-hidden transition-[mask] ease-linear",initial:R?!1:{height:"0%"},animate:H?{height:"100%"}:{height:"".concat(I*100,"%")},onUpdate:R?void 0:ee,transition:R?{duration:0,ease:"linear"}:v,style:H?void 0:{mask:"linear-gradient(rgb(0,0,0) 0%, rgb(0,0,0) calc(100% - 24px), rgba(0,0,0,0) 100%)"},children:[t&&s.jsx("img",{ref:O,src:t,onLoad:Z,onError:o,alt:e,className:"absolute top-0 z-1 w-full",style:{aspectRatio:U}}),l&&s.jsx("div",{className:"absolute inset-0 z-0 w-full overflow-hidden opacity-0 transition-opacity duration-300 group-hover/imagegen-image:opacity-100 group-focus/imagegen-image:opacity-100",children:s.jsx("div",{className:"absolute inset-0 bg-repeat",style:{backgroundImage:u,backgroundSize:"auto"}})})]}),s.jsx(ce.div,{className:"relative z-1 w-full overflow-hidden",initial:{filter:"blur(16px)"},animate:R?{filter:"blur(0px)"}:void 0,transition:R?ra:void 0,onUpdate:R?ae:void 0,style:{aspectRatio:U},children:m.current.map((y,j)=>{const G=A[j],N=y.availablePercentComplete===1;return G!==0||N?s.jsx("img",{src:y.src,alt:e,style:{opacity:G,willChange:"opacity",aspectRatio:U},className:!R&&(f!=null&&f.shouldShowPulseAnimation)?"bg-scale-pulse":"",onLoad:N?()=>D(!0):void 0},y.src):null})}),s.jsx(ce.div,{className:"absolute inset-0 z-0 scale-110 overflow-hidden blur-2xl",style:{aspectRatio:U},children:h&&m.current.filter((y,j)=>A[j]!==0).map(y=>s.jsx("img",{src:y.src,alt:e,className:"absolute top-0 w-full"},y.src))})]})},ca=({imageAssetPointer:e,serverThreadId:t})=>{var f;const[n,a]=i.useState(void 0),r=pe(),l=Nn(r),c=(f=e.metadata)==null?void 0:f.watermarked_asset_pointer,o=i.useRef(!1),p=!Mt(r);return i.useEffect(()=>{if(l&&c&&!o.current){o.current=!0;const d=rn(c);on(d,void 0,p,t,!1).then(u=>{u.status===cn.Success&&a(u.download_url)}).catch(u=>{u instanceof ln||ke.addError(new Error("Could not fetch watermarked image with ID ".concat(c," from file service"),{cause:u}))})}},[l,c,p,t]),n},St=2,ge=({pointer:e,altLabel:t,isEditorAvailable:n,onPercentageRendered:a,messageId:r,imageIndex:l,clientThreadId:c,serverThreadId:o,onEditorClick:p,compact:f,progressLoaderProps:d,checkpointLogger:u})=>{var N,K,Q,L,W,oe,me;const g=pe(),b=wt(),[_,x]=i.useState(void 0),k=i.useRef(void 0),w=(K=(N=e.metadata)==null?void 0:N.generation)==null?void 0:K.gen_id,I=(W=(L=(Q=e.metadata)==null?void 0:Q.generation)==null?void 0:L.height)!=null?W:void 0,M=e.height,S=(I!=null?I:0)/M,E=i.useRef({}),[m]=qt(),A=!Mt(g),[z,ne]=i.useState(!1),D=i.useContext(jt),P=e.width/e.height,O=ca({imageAssetPointer:e,serverThreadId:o}),H=i.useRef(0),R=i.useCallback((F=!1)=>{!F&&k.current===e.asset_pointer||(k.current=e.asset_pointer,Et.fetch(b,{asset:e,conversationId:o,force:F,isUnauthenticated:A}).then(q=>{x(q)}).finally(()=>{k.current=void 0}))},[e,b,o,A]);i.useEffect(()=>{const F=e.asset_pointer!==(_==null?void 0:_.asset_pointer);(!_||F)&&R()},[_,e.asset_pointer,R]);const U=i.useMemo(()=>Te({pointer:_,conversationId:o,messageId:r,source:D?"paragen":"chat",imageIndex:l.toString()}),[_,o,r,D,l]),Z=i.useRef(S);i.useEffect(()=>{S===1&&Z.current<1&&J.renderingComplete({analyticsContext:U})},[S,U]);const ee=i.useCallback(()=>{_&&(p==null||p({image:_,messageId:r,analyticsContext:U}))},[_,r,p,U]),ae=i.useMemo(()=>({width:e.width,height:e.height}),[e]),$=i.useCallback(()=>{var q;const F=((q=E.current[e.asset_pointer])!=null?q:0)+1;if(E.current[e.asset_pointer]=F,E.current[e.asset_pointer]>St)return ke.addAction("image-gen-asset-error",{name:"retries-exhausted",conversation_id:o,asset_pointer:e.asset_pointer,max_retries:St});ke.addAction("image-gen-asset-retry",{name:"retry-attempted",conversation_id:o,asset_pointer:e.asset_pointer,current_retry:F}),E.current[e.asset_pointer]=F,R(!0)},[e.asset_pointer,R,o]),v=i.useCallback(F=>{F===1&&ne(!0),a==null||a(F)},[a]),h=i.useRef(null),y=i.useRef(null);i.useEffect(()=>{if(h.current&&(d!=null&&d.setContainerSize)){const F=h.current.getBoundingClientRect(),q={width:F.width,height:F.height},te=y.current;(!te||te.width!==q.width||te.height!==q.height)&&(y.current=q,d.setContainerSize(q))}},[d]),i.useEffect(()=>{H.current=0},[r,e.asset_pointer]),i.useEffect(()=>{u&&Number.isFinite(S)&&(S<=H.current||(H.current=S,u.handleRenderPercentUpdate({messageId:r,renderCompletePercent:S})))},[S,u,r]);const j=_==null?void 0:_.url,G=O!=null?O:j;return s.jsx(Tn.Provider,{value:U,children:s.jsxs("div",{ref:h,className:X("group/imagegen-image relative w-full overflow-hidden",P<1?"max-w-[400px]":"max-w-[480px]",f?"rounded-lg":"rounded-2xl",D&&"max-w-full",r===m.get("image")&&"[view-transition-name:var(--vt-active-image)]"),id:"image-".concat(r),style:{aspectRatio:P},onClick:n?ee:void 0,tabIndex:0,children:[O&&s.jsx("img",{alt:t,className:"absolute inset-0 z-1 opacity-0",src:O}),s.jsx(oa,{alt:t,src:j,availablePercentComplete:S,onAnimationUpdate:v,isEditorAvailable:n,ignoreFirstChunk:!0,isTransparent:(me=(oe=e.metadata)==null?void 0:oe.generation)==null?void 0:me.transparent_background,dimensions:ae,onError:$,unconstrainedWidth:D,progressLoaderProps:d},w),(d==null?void 0:d.state)&&(d==null?void 0:d.state)!==C.Complete&&!z&&(d==null?void 0:d.hasImageReady)&&s.jsx(Tt,{isGettingStarted:!1,messageId:r}),z&&!f&&(D?s.jsx(aa,{imageUrl:j!=null?j:""}):s.jsx(Gn,{imageAssetPointer:j,imageUrl:G,messageId:r,clientThreadId:c,serverThreadId:o,shouldShowOverflow:O!==void 0}))]},w)})},la=({pointersToRender:e,altLabel:t,isEditorAvailable:n,updatePercentageRendered:a,toolCallMessage:r,toolOutputMessageIds:l,clientThreadId:c,serverThreadId:o,handleEditorClick:p,checkpointLogger:f})=>{const d=Ee.useStore(),u=Ee.useSelectedIndex();i.useEffect(()=>{d.setSelectedIndex(Math.max(l.findIndex(M=>{var S;return M===((S=r==null?void 0:r.metadata)==null?void 0:S.selected_image_message_id)}),0))},[]);const g=i.useRef({}),b=i.useCallback(M=>S=>{g.current[M]=S;const E=Object.keys(g.current).length,m=Object.values(g.current).reduce((A,z)=>A+z,0);a==null||a(m/E)},[a]),[_,x]=i.useState(null),k=dn(c,ue.getRequestId),w=un(k);i.useEffect(()=>{!w&&_!=null&&r!=null&&o!=null&&(Re(r.id,l[_],c,o),x(null))},[w]);const I=i.useCallback(M=>{d.setSelectedIndex(M);const S=Object.values(g.current);bt.logEventWithStatsig("chatgpt_image_switched","chatgpt_image_switched",{conversationId:o,messageId:l[M],imageIndex:M.toString(),isLoading:(S.length===0||S.some(A=>A<1)).toString()});const E=ue.getConversationLastTurn(Ne(c)),m=(E==null?void 0:E.messages.find(A=>A.id===(r==null?void 0:r.id)))!=null;r!=null&&o!=null&&(m&&w?x(M):Re(r.id,l[M],c,o))},[r,l,c,o,d,w,x]);return s.jsxs("div",{className:"flex gap-2",children:[s.jsx(ge,{pointer:e[u],altLabel:t,isEditorAvailable:n,messageId:l[u],imageIndex:u,clientThreadId:c,serverThreadId:o,onEditorClick:p,checkpointLogger:f},l[u]),s.jsx("div",{className:"flex flex-col gap-2",children:e.map((M,S)=>{var E,m;return s.jsx(da,{pointer:M,altLabel:t,isSelected:S===u,onClick:()=>I(S),onPercentageRendered:(m=(E=M.metadata)==null?void 0:E.generation)!=null&&m.gen_id?b(M.metadata.generation.gen_id):void 0,messageId:l[S],imageIndex:S,clientThreadId:c,serverThreadId:o,checkpointLogger:f},l[S])})})]})},da=({pointer:e,altLabel:t,isSelected:n,onClick:a,onPercentageRendered:r,messageId:l,imageIndex:c,clientThreadId:o,serverThreadId:p,checkpointLogger:f})=>s.jsxs("button",{type:"button",onClick:a,className:"relative w-14 rounded-lg p-1",children:[s.jsx("div",{className:X(n&&"opacity-70"),children:s.jsx(ge,{pointer:e,altLabel:t,isEditorAvailable:!1,onPercentageRendered:r,messageId:l,imageIndex:c,clientThreadId:o,serverThreadId:p,compact:!0,checkpointLogger:f})}),n&&s.jsx("div",{className:"border-token-border-default pointer-events-none absolute inset-0 rounded-xl border-2"})]});async function Re(e,t,n,a){const r=await he.safePost("/image-gen/message-select",{requestBody:{message_id:e,selected_image_message_id:t,conversation_id:a}}),l=r.id;l!=null&&je(n,c=>{gn.updateTree(c,o=>{o.updateNodeMessage(l,r)})})}const ua=({clientThreadId:e,serverThreadId:t,toolCallMessageId:n,pointers:a,messageIds:r,isEditorAvailable:l,onEditorClick:c,onComplete:o,onPercentageRendered:p,checkpointLogger:f})=>{"use no forget";const d=re(),u=kt(),g=i.useMemo(()=>a.length>0&&r.length===a.length&&a.every(v=>typeof v.width=="number"&&v.width>0&&typeof v.height=="number"&&v.height>0),[r.length,a]),[b,_]=i.useState(()=>a.map(()=>!1)),[x,k]=i.useState(!1),[w,I]=i.useState(null),[M,S]=i.useState(!1),E=i.useRef(null),m=i.useRef(null),A=i.useRef(!1),z=Ct.useStore();i.useEffect(()=>{g&&_(v=>v.length===a.length?v:a.map(()=>!1))},[g,a]),i.useEffect(()=>{E.current=Math.floor(Date.now()/1e3),m.current=null},[a,r]),i.useEffect(()=>{b.every(Boolean)&&m.current==null&&(m.current=Math.floor(Date.now()/1e3))},[b]);const D=b.length===a.length&&b.every(Boolean)&&!M;i.useEffect(()=>(z.setIsMultigenParagenVotingActive(D),()=>{z.setIsMultigenParagenVotingActive(!1)}),[z,D]);const P=i.useMemo(()=>{if(a.length<2)return!1;const[v,...h]=a,y=v.width,j=v.height;if(!y||!j)return!1;const G=y/j;return h.every(N=>{if(!N.width||!N.height)return!1;const K=N.width/N.height;return Math.abs(K-G)<.001})},[a]),O=i.useMemo(()=>a.map(v=>{const h=v.width,y=v.height;return!h||!y?1:h/y}),[a]),H=i.useMemo(()=>O.map(v=>"".concat(Number.isFinite(v)&&v>0?v:1,"fr")).join(" "),[O]),R=i.useMemo(()=>a.map((v,h)=>r[h]).filter(v=>typeof v=="string"),[a,r]);i.useEffect(()=>{var G,N;if(A.current||!t||!b.every(Boolean)||R.length!==a.length)return;A.current=!0;const v=(G=E.current)!=null?G:Math.floor(Date.now()/1e3),h=(N=m.current)!=null?N:v,y=Math.floor(Date.now()/1e3),j=P?"horizontal_buttons":"vertical_buttons";he.safePost("/image-gen/image-paragen-display",{requestBody:{conversation_id:t,displayed_message_ids:R,count:a.length,render_format:j,load_start_ts_utc:v,load_end_ts_utc:h,event_ts_utc:y}}).catch(()=>{})},[b,t,P,R,a.length]);const U=i.useMemo(()=>r.length!==a.length?[]:a.map((v,h)=>Te({pointer:v,conversationId:t,messageId:r[h],source:"paragen",imageIndex:h.toString()})),[r,a,t]),Z=i.useCallback(v=>h=>{p==null||p(h),!(h<1)&&_(y=>{if(y[v])return y;const j=[...y];return j[v]=!0,j})},[p]),ee=i.useCallback(async v=>{var y,j;if(!t){u.danger(d.formatMessage({id:"imageParagen.multigen.missingConversationError",defaultMessage:"We couldn’t submit your choice because the conversation isn’t saved yet."})),S(!0),o();return}const h=r[v];if(!h){u.danger(d.formatMessage({id:"imageParagen.multigen.missingMessageError",defaultMessage:"We couldn’t submit your choice. Please try again."})),S(!0),o();return}k(!0),I(v);try{const G=(y=E.current)!=null?y:Math.floor(Date.now()/1e3),N=(j=m.current)!=null?j:G,K=Math.floor(Date.now()/1e3),Q=P?"horizontal_buttons":"vertical_buttons";await he.safePost("/image-gen/image-paragen-submit",{requestBody:{conversation_id:t,selected_message_id:h,count:a.length,render_format:Q,load_start_ts_utc:G,load_end_ts_utc:N,event_ts_utc:K}});const L=U[v];if(L&&J.paragenImageRated({liked:!0,analyticsContext:L}),U.forEach((W,oe)=>{!W||oe===v||J.paragenImageRated({liked:!1,analyticsContext:W})}),n&&t)try{await Re(n,h,e,t)}catch(W){}k(!1),I(null),S(!0),o()}catch(G){k(!1),I(null),u.danger(d.formatMessage({id:"imageParagen.multigen.submitError",defaultMessage:"We couldn’t submit your choice. Please try again."}))}},[U,e,d,r,o,a.length,t,u,n,P]),ae=i.useCallback(async()=>{var v,h;if(!t){u.danger(d.formatMessage({id:"imageParagen.multigen.missingConversationError",defaultMessage:"We couldn’t submit your choice because the conversation isn’t saved yet."})),S(!0),o();return}k(!0);try{const y=(v=E.current)!=null?v:Math.floor(Date.now()/1e3),j=(h=m.current)!=null?h:y,G=Math.floor(Date.now()/1e3),N=P?"horizontal_buttons":"vertical_buttons";await he.safePost("/image-gen/image-paragen-dismiss",{requestBody:{conversation_id:t,dismissed_message_ids:R,count:a.length,render_format:N,load_start_ts_utc:y,load_end_ts_utc:j,event_ts_utc:G}}),S(!0),o()}catch(y){u.danger(d.formatMessage({id:"imageParagen.multigen.dismissError",defaultMessage:"We couldn’t skip the image comparison. Please try again."}))}finally{k(!1)}},[t,u,d,o,R,a.length,P]),$=i.useMemo(()=>a.map((v,h)=>d.formatMessage({id:"imageParagen.multigen.imageAlt",defaultMessage:"Generated image {index}"},{index:h+1})),[d,a]);return g?s.jsxs("div",{"data-testid":"image-paragen-multigen",children:[D&&s.jsxs("div",{className:"flex flex-wrap items-start gap-2 pb-4 md:flex-nowrap md:justify-between",children:[s.jsx("div",{className:"flex flex-col gap-1 md:max-w-[70%]",children:s.jsx("p",{className:"text-token-text-primary text-base",children:s.jsx(se,{id:"imageParagen.multigen.prompt",defaultMessage:"Which image do you like more?"})})}),s.jsx("button",{type:"button",onClick:ae,disabled:x,className:X("text-token-text-tertiary hover:text-token-text-primary ms-auto whitespace-nowrap",x&&"pointer-events-none opacity-60"),children:s.jsx("span",{className:"underline decoration-dotted",children:s.jsx(se,{id:"imageParagen.multigen.skip",defaultMessage:"Skip"})})})]}),s.jsx("div",{className:X("grid [grid-template-columns:var(--paragen-cols)] gap-3",P?"md:gap-2":"md:gap-3"),style:{"--paragen-cols":H},children:a.map((v,h)=>{var y,j,G;return s.jsxs("div",{className:"flex flex-col gap-3",children:[s.jsxs("div",{className:"relative",children:[s.jsx(ge,{pointer:v,altLabel:(y=$[h])!=null?y:"Generated image",isEditorAvailable:l,onEditorClick:c,onPercentageRendered:Z(h),messageId:(j=r[h])!=null?j:String(h),imageIndex:h,clientThreadId:e,serverThreadId:t,compact:!0,checkpointLogger:f}),D&&s.jsx("div",{className:"absolute start-0 bottom-0 flex h-6 w-6 items-center justify-center rounded-md bg-black px-1 text-center text-sm font-semibold text-white dark:bg-white dark:text-black",children:s.jsx(se,{id:"imageParagen.multigen.imageLabel",defaultMessage:"{index, number}",values:{index:h+1}})})]}),P&&D&&s.jsxs(be,{fullWidth:!0,size:"large",color:"secondary",className:"justify-start gap-2 text-start",disabled:x,loading:w===h&&x,onClick:()=>ee(h),children:[s.jsx(ht,{"aria-hidden":"true",className:"text-token-text-primary me-2"}),s.jsx("span",{className:"sm:hidden",children:s.jsx(se,{id:"imageParagen.multigen.choiceShort",defaultMessage:"Image {index}",values:{index:h+1}})}),s.jsx("span",{className:"hidden sm:inline",children:s.jsx(se,{id:"imageParagen.multigen.choice",defaultMessage:"Image {index} is better",values:{index:h+1}})})]})]},(G=r[h])!=null?G:h)})}),!P&&D&&s.jsx("div",{className:"mt-4 flex flex-col gap-2 md:items-start",children:a.map((v,h)=>s.jsxs(be,{fullWidth:!0,size:"large",color:"secondary",className:"justify-start gap-2 text-start md:w-1/2",disabled:x,loading:w===h&&x,onClick:()=>ee(h),children:[s.jsx(ht,{"aria-hidden":"true",className:"text-token-text-primary me-2"}),s.jsx("span",{className:"sm:hidden",children:s.jsx(se,{id:"imageParagen.multigen.choiceShort",defaultMessage:"Image {index}",values:{index:h+1}})}),s.jsx("span",{className:"hidden sm:inline",children:s.jsx(se,{id:"imageParagen.multigen.choice",defaultMessage:"Image {index} is better",values:{index:h+1}})})]},"choice-".concat(h)))}),s.jsx("div",{className:"mt-2"})]}):null},ga=({imageGenerationState:e,isInterrupted:t,asyncMessage:n,imageAssetPointer:a,altLabel:r,clientThreadId:l,serverThreadId:c,onEditorClick:o,isEditorAvailable:p,setAnimationPercentage:f,messageId:d,checkpointLogger:u})=>{var M;const[g,b]=i.useState(null),_=g==null,[x,k]=i.useState(!0),w=e===C.Thinking||e===C.AsyncGenerating&&!((M=n==null?void 0:n.metadata)!=null&&M.is_visually_hidden_from_conversation),I=e===C.Generating||e===C.Complete;return i.useEffect(()=>{w&&k(!1)},[w]),t?null:s.jsxs("div",{className:I?"relative pb-2":"relative",children:[(w||!x)&&s.jsx(Zn,{isDimensionsUnknown:_,width:g==null?void 0:g.width,height:g==null?void 0:g.height,children:_&&s.jsx(Tt,{isGettingStarted:!0,messageId:d})}),I&&s.jsx(ce.div,{className:x?"relative":"absolute inset-0 w-full",variants:{hidden:{opacity:0},visible:{opacity:1}},initial:"hidden",animate:x?"visible":"hidden",exit:"hidden",children:a&&s.jsx(ge,{pointer:a,altLabel:r,isEditorAvailable:p,onPercentageRendered:f,messageId:d,clientThreadId:l,serverThreadId:c,imageIndex:0,onEditorClick:o,checkpointLogger:u,progressLoaderProps:{state:e,setContainerSize:b,hasImageReady:x,setHasImageReady:k,shouldHideDiagonalShimmer:!0,shouldShowPulseAnimation:!0}})})]})},we=e=>{"use forget";const t=Wt.c(11),{conversation:n,cotMessages:a,visualPercentComplete:r,isInterrupted:l,state:c,showTitle:o,title:p,isTitleClickable:f,onRedirectClick:d}=e,u=l===void 0?!1:l,g=o===void 0?!1:o,b=f===void 0?!1:f,_=re();let x;t[0]!==_?(x=_.formatMessage({id:"imagegen.thinkingHeader.interrupted",defaultMessage:"Stopped creating image"}),t[0]=_,t[1]=x):x=t[1];const k=x,w=c===C.Complete||r===1;let I;e:{if(u){I=k;break e}else if(!a){I=void 0;break e}if(w){I=a.complete;break e}if(r){const E=Object.keys(a.generating);for(let m=0;m<E.length;m=m+1,m){const A=parseFloat(E[m]);if(r<A){I=a.generating[E[m]];break e}}}else{I=a.thinking;break e}I=a.complete}const M=I;let S;return t[2]!==n||t[3]!==M||t[4]!==u||t[5]!==b||t[6]!==d||t[7]!==g||t[8]!==p||t[9]!==w?(S=M&&s.jsx(Bn,{conversation:n,latestHeadline:M,isComplete:w||u,showChunkIcon:!1,isExpandDisabled:!0,showTitle:g,title:p,isTitleClickable:b,onTitleClick:d}),t[2]=n,t[3]=M,t[4]=u,t[5]=b,t[6]=d,t[7]=g,t[8]=p,t[9]=w,t[10]=S):S=t[10],S};function ma(e){const t=e.find(c=>c.author.role==="tool"&&c.author.name===Un&&c.content.content_type==="text"),[n,...a]=(t==null?void 0:t.content.content_type)==="text"?t.content.parts:[],r=a.pop(),l=a.length;return n&&r&&a.length>0?{thinking:n,complete:r,generating:a.reduce((c,o,p)=>{const f=(p+1)/l;return c[f.toFixed(2)]=o,c},{})}:void 0}const fa=e=>{const t=re(),{size:n="image",count:a=1}=e||{};return a>1?{thinking:t.formatMessage({id:"RyNwg3",defaultMessage:"Creating images"}),generating:{"0.33":t.formatMessage({id:"P/XIfT",defaultMessage:"Creating images"}),"0.67":t.formatMessage({id:"j2g/KZ",defaultMessage:"Creating images"}),"1.00":t.formatMessage({id:"hIsQxN",defaultMessage:"Creating images"})},complete:t.formatMessage({id:"XQ81dl",defaultMessage:"Images created"})}:n==="xlimage"?{thinking:t.formatMessage({id:"PHKRzn",defaultMessage:"Creating image"}),generating:{"0.33":t.formatMessage({id:"7eNFXa",defaultMessage:"Creating image"}),"0.67":t.formatMessage({id:"md5juI",defaultMessage:"Creating image"}),"1.00":t.formatMessage({id:"g7GPZq",defaultMessage:"Creating image"})},complete:t.formatMessage({id:"QsnnBN",defaultMessage:"Image created"})}:{thinking:t.formatMessage({id:"Sdy/Av",defaultMessage:"Creating image"}),generating:{"0.33":t.formatMessage({id:"DP6/8y",defaultMessage:"Creating image"}),"0.67":t.formatMessage({id:"k9y1TT",defaultMessage:"Creating image"}),"1.00":t.formatMessage({id:"GpR7v3",defaultMessage:"Creating image"})},complete:t.formatMessage({id:"l2Izz4",defaultMessage:"Image created"})}},ha=_n(()=>Kt(()=>import("./jtua2sy614gg6469.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14])).then(e=>e.ImageGenConversationLightboxNew)),xa=[C.Empty,C.Errored],pa=e=>e!=null&&typeof e=="object"&&"image_gen_paragen_metadata"in e,Na=({messages:e,clientThreadId:t,isLastTurnInConversation:n,isParagen:a=!1})=>{"use no forget";var Ue,Ae,Pe,De,Be,Fe,Oe,ze,Ve,He,Le;const r=pe(),l=mn(r,t),c=xt(l.serverId$),o=re(),p=o.formatMessage({id:"imagegen.message.altLabel",defaultMessage:"Generated image"}),{imageMessages:f,messageIds:d,imageAssetPointers:u}=i.useMemo(()=>pt(e),[e]),g=e.find(An),b=Ee.useSelectedIndex(),_=(Pe=(Ae=(Ue=u==null?void 0:u[b])==null?void 0:Ue.metadata)==null?void 0:Ae.generation)==null?void 0:Pe.gen_size,x=fa({size:_!=null?_:"image",count:(De=u==null?void 0:u.length)!=null?De:1}),k=i.useMemo(()=>{var T;return(T=ma(e))!=null?T:x},[e,x]),w=e.find(T=>{var V;return(V=T.metadata)==null?void 0:V.image_gen_async}),I=i.useMemo(()=>f.find(T=>{var Y;const V=(Y=T.metadata)==null?void 0:Y.response_message_id;return typeof V=="string"&&V!==T.id}),[f]),M=(Be=I==null?void 0:I.metadata)==null?void 0:Be.response_message_id,S=!!M,E=(Oe=(Fe=e.find(T=>{var V;return(V=T.metadata)==null?void 0:V.async_task_title}))==null?void 0:Fe.metadata)==null?void 0:Oe.async_task_title,m=i.useMemo(()=>Pn(e,n),[e,n]),A=Ln({toolCallMessage:g,imageMessages:f,conversationId:c,clientThreadId:t,imageGenerationState:m}),z=kt(),ne=fn(),D=i.useRef(!1),P=i.useRef(!1),O=i.useRef(null),H=i.useMemo(()=>Te({pointer:u[b],conversationId:c,messageId:d[b],source:a?"paragen":"chat",imageIndex:b.toString()}),[u,d,b,c,a]);i.useEffect(()=>{if(!D.current&&(m===C.Thinking||m===C.Generating))D.current=!0,O.current=performance.now();else if(D.current&&!P.current)if(m===C.Complete){const T=O.current?performance.now()-O.current:void 0;J.generationSuccess({analyticsContext:H,durationMs:T}),P.current=!0}else m===C.Errored&&(J.generationFailure({analyticsContext:H,errorReason:"assistant_error"}),P.current=!0)},[m,H]);const R=e[e.length-1],U=i.useMemo(()=>R&&hn(R),[R]),Z=xt(()=>xn(l).id),ee=Me(r,"1971465707"),ae=Me(r,"3175281277")===!1,$=vn({clientThreadId:l.id})&&m===C.Complete,[v,h]=i.useState(0),y=i.useMemo(()=>d.join(","),[d]),[j,G]=i.useState(null),N=f,K=i.useMemo(()=>u.length!==2||d.length!==2||N.length!==2?!1:N.every(T=>{const V=T.metadata;if(!pa(V))return!1;const Y=V.image_gen_paragen_metadata;return typeof Y=="object"&&(Y==null?void 0:Y.voted)!==!0}),[u.length,N,d.length]),L=ae&&K&&n&&!(j===y),W=Ct.useIsMultigenParagenVotingActive(),oe=a||L,me=L&&W,F=i.useCallback(()=>{G(y)},[y]),q=wt(),te=i.useCallback(async({image:T,messageId:V,analyticsContext:Y})=>{var Ye,Je,Xe;if(ne)return z.warning(o.formatMessage({id:"imagegen.message.editorClick.integratedVoiceMode",defaultMessage:"Exit voice mode to view / edit the image"}));const qe=Ne(l.id),Dt=(qe?ue.getConversationTurns(qe).flatMap(B=>B.messages):e).filter(B=>{var de;const le=(de=B.metadata)==null?void 0:de.response_message_id;return typeof le!="string"||le===B.id}),{imageAssetPointers:Bt,messageIds:We}=pt(Dt,{skipSort:!0}),Ke=await Promise.all(Bt.map(B=>B.asset_pointer===T.asset_pointer?Promise.resolve(T):Et.fetch(q,{asset:B,conversationId:c}))),ve=(Ke.length>0?Ke:[T]).map((B,le)=>{var Ze,et,tt,nt,at,st;const de=We[le]!=null?We[le]:V;return{id:(tt=(et=(Ze=B.metadata)==null?void 0:Ze.generation)==null?void 0:et.gen_id)!=null?tt:de,archived:!1,transformationId:(st=(at=(nt=B.metadata)==null?void 0:nt.generation)==null?void 0:at.gen_id)!=null?st:null,url:B.url,assetPointer:B.asset_pointer,thumbnail:null,width:B.width,height:B.height,title:null,conversationId:c,messageId:de}});J.editorClick({sourceOperation:(Xe=(Je=(Ye=T.metadata)==null?void 0:Ye.dalle)==null?void 0:Je.edit_op)!=null?Xe:"none",analyticsContext:Y});const $e=ve.findIndex(B=>B.assetPointer===T.asset_pointer),Ft=ve.findIndex(B=>B.messageId===V),Qe=$e!==-1?$e:Ft;pn(r,ha,{images:ve,initialIndex:Qe===-1?0:Qe,conversation:l,currentModelId:Z})},[ne,l,e,r,z,o,q,c,Z]),[Ge,At]=i.useState(!1);i.useEffect(()=>{(m===C.Generating||m===C.Thinking)&&!n&&At(!0)},[m,n,Ge]);const _e=Ge||S,Pt=i.useCallback(()=>{M&&(je(l.id,T=>{T.scrollToMessageId=M,T.scrollToMessageIsAssistant=!0}),requestAnimationFrame(()=>{je(l.id,T=>{T.scrollToMessageId=void 0,T.scrollToMessageIsAssistant=void 0})}))},[l.id,M]);return xa.includes(m)?null:s.jsx(jt.Provider,{value:oe,children:s.jsxs("div",{className:"flex flex-col",children:[m!==C.Unavailable&&m!==C.AsyncGenerating&&m!==C.AsyncHanging&&!((ze=R==null?void 0:R.metadata)!=null&&ze.async_completion_id)&&!me&&!_e&&s.jsx("div",{className:"pb-2",children:s.jsx(we,{conversation:l,cotMessages:k,visualPercentComplete:v,isInterrupted:U,state:m,showTitle:!0,title:E,isTitleClickable:!1})}),m===C.Thinking&&!U&&n&&s.jsx(Nt,{isDimensionsUnknown:!0,children:s.jsx(Gt,{withLottie:!0})}),m===C.Thinking&&_e&&s.jsx("div",{className:"pb-2",children:s.jsx(we,{conversation:l,cotMessages:k,visualPercentComplete:v,isInterrupted:U,state:m,showTitle:!0,title:E,isTitleClickable:!1})}),m===C.AsyncGenerating&&!((Ve=w==null?void 0:w.metadata)!=null&&Ve.is_visually_hidden_from_conversation)&&s.jsx(Fn,{shimmer:!0,title:(He=w==null?void 0:w.metadata)==null?void 0:He.ui_card_title,description:(Le=w==null?void 0:w.metadata)==null?void 0:Le.ui_card_description}),(m===C.Generating||m===C.Complete)&&!U&&s.jsx("div",{className:"pb-2",children:_e?s.jsx(we,{conversation:l,cotMessages:k,visualPercentComplete:v,isInterrupted:U,state:m,showTitle:!0,title:E,isTitleClickable:m===C.Complete,onRedirectClick:M?Pt:void 0}):L?s.jsx(ua,{clientThreadId:l.id,serverThreadId:c,toolCallMessageId:g==null?void 0:g.id,pointers:u,messageIds:d,isEditorAvailable:$,onEditorClick:te,onComplete:F,onPercentageRendered:h,checkpointLogger:A},y):u.length>1?s.jsx(la,{pointersToRender:u,altLabel:p,isEditorAvailable:$,updatePercentageRendered:h,toolCallMessage:g,toolOutputMessageIds:d,clientThreadId:l.id,serverThreadId:c,handleEditorClick:te,checkpointLogger:A}):ee?s.jsx(ga,{imageGenerationState:m,isInterrupted:U,asyncMessage:w,imageAssetPointer:u[0],messageId:d[0],altLabel:p,clientThreadId:l.id,serverThreadId:c,onEditorClick:te,setAnimationPercentage:h,isEditorAvailable:$,checkpointLogger:A}):s.jsx(ge,{pointer:u[0],altLabel:p,isEditorAvailable:$,onPercentageRendered:h,messageId:d[0],imageIndex:0,clientThreadId:l.id,serverThreadId:c,onEditorClick:te,checkpointLogger:A})})]})})};export{Na as ImageGenMessage};
//# sourceMappingURL=crvd30ivlnjgjuq5.js.map

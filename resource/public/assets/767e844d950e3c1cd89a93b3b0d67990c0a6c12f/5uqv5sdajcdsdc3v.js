const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/meg2e6l315h292o7.js","assets/mw35uwhq4g8r9eam.js","assets/d0xa318sl7ywi0za.js","assets/root-kavs8piy.css","assets/g2euln7v5pbm31qa.js","assets/conversation-small-lq38g8zw.css","assets/cvtbni005816i9ea.js","assets/nea9sowk1s9pzcpg.js","assets/ey0kaiz1v4k0znjj.js","assets/d3ia29s4ey7jfka4.js","assets/dk0xd8ku5yovoyxl.js","assets/glvtvsqozo9e3cjo.js","assets/pgiy1j9b3s5zyv35.js","assets/hm4fjbwskle6huld.js","assets/kzv3lmwfjxg7fbwd.js","assets/pe4e1ebqw6qlpge9.js","assets/e237h6ukoc2vt16i.js","assets/idtxxq2b89y0p07a.js","assets/mfq2eda4qxrcz3ws.js","assets/m9dg467qzmmahw21.js"])))=>i.map(i=>d[i]);
var Nn=Object.freeze,Bn=Object.defineProperty,ii=Object.defineProperties;var ri=Object.getOwnPropertyDescriptors;var As=Object.getOwnPropertySymbols;var On=Object.prototype.hasOwnProperty,Un=Object.prototype.propertyIsEnumerable;var Dn=(a,e,n)=>e in a?Bn(a,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[e]=n,Q=(a,e)=>{for(var n in e||(e={}))On.call(e,n)&&Dn(a,n,e[n]);if(As)for(var n of As(e))Un.call(e,n)&&Dn(a,n,e[n]);return a},Ie=(a,e)=>ii(a,ri(e));var Gn=(a,e)=>{var n={};for(var t in a)On.call(a,t)&&e.indexOf(t)<0&&(n[t]=a[t]);if(a!=null&&As)for(var t of As(a))e.indexOf(t)<0&&Un.call(a,t)&&(n[t]=a[t]);return n};var et=(a,e)=>Nn(Bn(a,"raw",{value:Nn(e||a.slice())}));import{r as g,j as s,M as we,e as li,_ as ss,c as ls,u as ya,h as qe,R as Ta,k as di,d as ut,n as ci}from"./mw35uwhq4g8r9eam.js";import{nm as ui,nn as rt,bE as gi,no as Vn,np as mi,nq as Ln,nr as hi,dZ as rs,cl as gt,ns as pi,nt as fi,eS as xi,eT as vi,eU as bi,eV as Ii,nu as _i,ad as Si,U as Ma,nv as wa,nw as ja,nx as Ci,ny as yi,nz as Ti,nA as Mi,dR as wi,aZ as ji,bu as ki,en as Pi,nB as Ri,nC as Ei,nD as ka,d7 as Ai,d8 as Fi,d9 as Ni,nE as Di,hQ as Bi,bs as Oi,jG as Ui,dp as Pa,nF as Gi,nG as Vi,db as Li,nH as Hi,nI as qi,hU as zi,nJ as Hn,j3 as Wi,nK as $i,e1 as lt,nL as Ki,mI as Qi,nM as Xi,iH as Yi,nN as Ji,nO as Zi,nP as er,nQ as sr,nR as tr,nS as qn,nT as nr,dW as zn,nU as ar,nV as or,nW as ir,n1 as rr,nX as lr,nY as dr,cL as cr,nZ as ur,n_ as gr,n$ as mr,o0 as hr,o1 as pr,o2 as fr,o3 as xr,ak as vr,o4 as br,al as Ra,o5 as Ir,o6 as _r,o7 as Sr,o8 as Cr,o9 as Wn,oa as yr,ob as Tr,oc as Mr,od as wr,oe as $n,of as jr,og as kr,oh as Pr,oi as Rr,oj as Er,ok as Ar,ol as Fr,om as Nr,on as Dr,oo as Br,op as Or,am as Ur,oq as Gr,or as Vr,os as Lr,ot as Hr,ac as qr,eP as zr,eY as Wr,em as $r,X as Ve,eQ as Kr,eR as Qr,eW as Xr,dE as Yr,be as Ea,hb as Jr,eG as Zr,bx as el,by as sl,bz as tl,el as nl,jU as al,kZ as ol,ou as il,ov as rl,jX as ll,ow as dl,ox as cl,oy as ul,oz as gl,oA as ml,oB as hl,oC as pl,oD as fl,hW as xl,ga as Kn,oE as vl,oF as bl,oG as Il,oH as _l,oI as Sl,oJ as Cl,oK as yl,oL as Tl}from"./g2euln7v5pbm31qa.js";import{P as _s,fj as L,iO as Aa,V as $,ay as se,cF as _e,be as ze,th as Fa,e1 as Ml,or as wl,M as Ee,k as He,ab as mt,Q as es,kv as jl,aA as Na,cB as Da,jg as Ba,R as ht,A as kl,ao as Oa,bk as Qn,D as Ds,u as ts,p as Ss,sP as Pl,x as Ua,y as Bs,O as pt,jZ as Ga,b8 as Rl,cy as El,gk as Al,w as Va,d as ce,ax as dt,ti as Xn,ak as La,J as Le,bq as Ha,o6 as Fl,fY as Nl,cd as Dl,j3 as Bl,er as Ol,_ as De,a7 as Ul,dz as Gl,bo as Vl,fQ as Ll,dh as Yn,di as Jn,gb as Zn,iS as Hl,ja as ql,j8 as st,a9 as zl,a6 as vs,eL as Wl,lp as $l,H as Kl,i as tt,bj as ft,os as Ql,oq as Xl,cD as qa,b as Yl,a2 as bs,aw as Ns,aP as Is,cu as Jl,tj as Zl,eo as za,lF as ed,bb as sd,aa as nt,oB as td,tk as ea,eX as nd,tl as ad,av as sa,tm as od,bK as id,bL as rd,e8 as ld,dy as ta,d8 as Fs,gR as dd,bw as cd,kZ as ud,ek as gd,U as md,qC as hd,nY as pd,fF as na,tn as fd,dp as at,h5 as xd,jl as Wa,fK as vd,f7 as bd,fJ as Id,pQ as aa,pR as _d,g as Sd,c8 as oa,bD as ia,cc as Cd,df as yd,de as ra,c7 as Td,mC as Md,e5 as wd,aJ as jd,fE as kd,gi as Pd,jb as Rd,n6 as la}from"./d0xa318sl7ywi0za.js";import{C as ct}from"./kc32gem4l2t3hnxt.js";import"./kne35xckmmfq3xx6.js";import{a as Ed,b as Ad}from"./c340ncgh31fwqkpk.js";import{I as Fd}from"./kl0a548ohmz3fby2.js";const da=ze(()=>ss(()=>import("./meg2e6l315h292o7.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(a=>a.MemoryActionResult));function ca(a,e,n){He(a,t=>{mt.updateTree(t,r=>{r.updateNodeMetadata(e,{inlineComparisonRating:n})})})}const ua=({messages:a})=>{for(const{metadata:e}of a){const{paragen_display_label:n}=e!=null?e:{};if(n)return n;const{augmented_paragen_prompt_label:t}=e!=null?e:{};if(t)return t}};function ga({displayedMessages:a,message:e,conversationTurnMountTime:n,visibilityState:t}){var l,m;const r={},i=((l=e.clientMetadata)==null?void 0:l.variantsInStreamInfo)==null&&((m=e.metadata)==null?void 0:m.paragen_variants_info)!=null;return a.forEach((c,b)=>{const f=i?{load_first_token_time:n,load_end_time:n}:{load_first_token_time:c.loadFirstTokenTime,load_end_time:c.loadEndTime},u=b===0?{rendered_height:t.left_rendered_height}:{rendered_height:t.right_rendered_height};r[c.messageId]=Q(Q({},f),u)}),r}function Nd(a){const e=g.useRef({left_visibility_initial:null,left_visibility_max:null,right_visibility_initial:null,right_visibility_max:null,left_rendered_height:null,right_rendered_height:null}),n=g.useRef({left:null,right:null});return a.variantIds.length<2?s.jsx($a,Q({setPreferredFeedback:()=>{},leftVariantId:"left-placeholder",rightVariantId:"right-placeholder",leftTurn:null,rightTurn:null,originalTurn:null,hasActiveRequest:!0,visibilityStateRef:e,firstVisibleTokenTimestampsRef:n},a)):s.jsx(Dd,Ie(Q({},a),{visibilityStateRef:e,firstVisibleTokenTimestampsRef:n}))}function Dd(a){const{conversation:e,variantIds:n,turnIndex:t,firstVisibleTokenTimestampsRef:r}=a;if(n.length!==2)throw new Error("ConversationTurnSideBySideFeedback requires exactly two variant IDs");const i=Fa(),l=Ml(),[m,c]=n,b=g.useMemo(()=>wl(m+c)()>=.5,[m,c]),[f,u]=b?[c,m]:[m,c],[T,p,y]=Ee(e.id,D=>{var h,E,N,V,d,G,z,w,de,X,te,Se,W,j,K,Y,M,ue,ge,J;const F=Qn(D).tree.getLeafFromNode(f).id,U=Qn(D).tree.getLeafFromNode(u).id,R=$.getConversationTurns(D,F),S=$.getConversationTurns(D,U),P=t<R.length?R[t]:null,k=t<S.length?S[t]:null;return P||Ds.addError("Paragen Left turn index ".concat(t," out of bounds"),{turnIndex:t,turnCount:R.length,lastTurnRole:(h=L(R))==null?void 0:h.role,lastMessageAuthor:(N=L((E=L(R))==null?void 0:E.messages))==null?void 0:N.author,lastMessageContentType:(d=L((V=L(R))==null?void 0:V.messages))==null?void 0:d.content.content_type,lastMessageMetadata:(z=L((G=L(R))==null?void 0:G.messages))==null?void 0:z.metadata,altTurnCount:S.length,altLastTurnRole:(w=L(S))==null?void 0:w.role,altLastMessageRole:(X=L((de=L(S))==null?void 0:de.messages))==null?void 0:X.author.role}),k||Ds.addError("Paragen Right turn index ".concat(t," out of bounds"),{turnIndex:t,turnCount:S.length,lastTurnRole:(te=L(S))==null?void 0:te.role,lastMessageAuthor:(W=L((Se=L(S))==null?void 0:Se.messages))==null?void 0:W.author,lastMessageContentType:(K=L((j=L(S))==null?void 0:j.messages))==null?void 0:K.content.content_type,lastMessageMetadata:(M=L((Y=L(S))==null?void 0:Y.messages))==null?void 0:M.metadata,altTurnCount:R.length,altLastTurnRole:(ue=L(R))==null?void 0:ue.role,altLastMessageRole:(J=L((ge=L(R))==null?void 0:ge.messages))==null?void 0:J.author.role}),[F,P,k]}),[x,_]=b?[y,p]:[p,y],C="skippable_parallel_2_in_stream:a:1.5";g.useEffect(()=>(Ln.setState({displayingSideBySideFeedback:!0}),()=>{Ln.setState({displayingSideBySideFeedback:!1})}),[]);const I=g.useRef({left_visibility_initial:null,left_visibility_max:null,right_visibility_initial:null,right_visibility_max:null,left_rendered_height:null,right_rendered_height:null}),H=g.useCallback((D,{shouldSubmitParagenFeedback:F=!0}={})=>{if(!p||!y||!x||!_)throw new Error("Expected both turns to exist");He(e.id,N=>{mt.setCurrentBranch(N,D)});const U=D===f,R=D===m;x.messages.length>0&&ca(e.id,x.messages[x.messages.length-1].id,R?"original":"new"),_.messages.length>0&&ca(e.id,_.messages[_.messages.length-1].id,R?"original":"new");const S=es(e.id),P=[p,y].map((N,V)=>{var d,G,z;return{messageId:N.messages[N.messages.length-1].id,loadFirstTokenTime:V===0?r.current.left:r.current.right,loadEndTime:(z=(G=(d=L(N.messages))==null?void 0:d.clientMetadata)==null?void 0:G.completionSampleFinishTime)!=null?z:null}}),k=U?P[0].messageId:P[1].messageId,h=$.getParentPromptNode(_s(e.id),T);if(!h)throw new Error("Expected prompt for side by side feedback");const E=ga({displayedMessages:P,message:h.message,conversationTurnMountTime:a.conversationTurnMountTime,visibilityState:I.current});F&&xa({params:{conversation_id:S,displayed_message_ids:P.map(N=>N.messageId),message_metadatas:E,rating:"selected",selected_message_id:k,source_timestamp:Date.now(),ui_variant:1,user_prompt_message_id:h.message.id}})},[e.id,f,m,x,_,p,y,T,r,a.conversationTurnMountTime,I]);return g.useEffect(()=>jl(Oa,{requestCompletion:D=>{const F=es(e.id),U=$.getParentPromptNode(_s(e.id),T);if(!U)throw new Error("Expected prompt for side by side feedback");if(!p||!y)throw new Error("Expected both turns to exist");const R=[p,y].map((k,h)=>{var E,N,V;return{messageId:k.messages[k.messages.length-1].id,loadFirstTokenTime:h===0?r.current.left:r.current.right,loadEndTime:(V=(N=(E=L(k.messages))==null?void 0:E.clientMetadata)==null?void 0:N.completionSampleFinishTime)!=null?V:null}}),S=ga({displayedMessages:R,message:U.message,conversationTurnMountTime:a.conversationTurnMountTime,visibilityState:I.current}),P=D.isForSkippingParagen;xa({params:{conversation_id:F,displayed_message_ids:R.map(k=>k.messageId),message_metadatas:S,rating:P?"explicit_skipped":"skipped",selected_message_id:null,source_timestamp:Date.now(),ui_variant:P?3:1,user_prompt_message_id:U.message.id}}),P&&H(f,{shouldSubmitParagenFeedback:!1})}}),[p,y,T,e.id,a.conversationTurnMountTime,C,x==null?void 0:x.messages,_==null?void 0:_.messages,l,r,H,f,I]),s.jsx($a,Ie(Q({},a),{setPreferredFeedback:H,leftVariantId:f,rightVariantId:u,leftTurn:p,rightTurn:y,hasActiveRequest:i,originalTurn:x,visibilityStateRef:I}))}function $a(b){var f=b,{setPreferredFeedback:a,leftVariantId:e,rightVariantId:n,leftTurn:t,rightTurn:r,hasActiveRequest:i,originalTurn:l,visibilityStateRef:m}=f,c=Gn(f,["setPreferredFeedback","leftVariantId","rightVariantId","leftTurn","rightTurn","hasActiveRequest","originalTurn","visibilityStateRef"]);var te,Se,W;const u=(te=t&&ua(t))!=null?te:null,T=(Se=r&&ua(r))!=null?Se:null,p=g.useMemo(()=>{var j;return(j=t==null?void 0:t.messages)!=null?j:[]},[t==null?void 0:t.messages]),y=g.useMemo(()=>{var j;return(j=r==null?void 0:r.messages)!=null?j:[]},[r==null?void 0:r.messages]),{avatarClassName:x,firstVisibleTokenTimestampsRef:_}=c,C=g.useMemo(()=>{var j;return(j=t==null?void 0:t.messageGroups)!=null?j:[]},[t==null?void 0:t.messageGroups]),I=g.useMemo(()=>{var j;return(j=r==null?void 0:r.messageGroups)!=null?j:[]},[r==null?void 0:r.messageGroups]),H=ui(),D=_s(c.conversation.id),F=L(t==null?void 0:t.messages),U=L(r==null?void 0:r.messages),R=Aa($.getRequestId(D,(W=F==null?void 0:F.id)!=null?W:U==null?void 0:U.id)),S=R&&!(F!=null&&F.end_turn),P=R&&!(U!=null&&U.end_turn),k=F!=null&&rt(F),h=U!=null&&rt(U),E=k!=null?k:h,N=(t==null?void 0:t.role)===se.User,V=(r==null?void 0:r.role)===se.User,d=g.useRef(null),G=g.useRef(null),z=g.useRef(null),w=t!=null,de=r!=null;!w&&_.current.left==null&&(_.current.left=Date.now()),!de&&_.current.right==null&&(_.current.right=Date.now()),g.useEffect(()=>{if(d.current&&G.current&&z.current){const j=Array(11).fill(0).map((Y,M)=>M/10),K=new IntersectionObserver(Y=>Y.forEach(M=>{var ue,ge,J,We,Ce,Ae;M.target===G.current?((ge=(ue=m.current).left_visibility_initial)!=null||(ue.left_visibility_initial=M.intersectionRatio),m.current.left_visibility_max=Math.max((J=m.current.left_visibility_max)!=null?J:0,M.intersectionRatio)):M.target===z.current&&((Ce=(We=m.current).right_visibility_initial)!=null||(We.right_visibility_initial=M.intersectionRatio),m.current.right_visibility_max=Math.max((Ae=m.current.right_visibility_max)!=null?Ae:0,M.intersectionRatio))}),{root:d.current,threshold:j});return K.observe(G.current),K.observe(z.current),()=>K.disconnect()}},[m]),g.useEffect(()=>{const j=G.current,K=z.current;if(!j||!K)return;let Y=null;const M=()=>{Y!=null&&cancelAnimationFrame(Y),Y=requestAnimationFrame(()=>{if(j.isConnected){const ge=Math.round(j.getBoundingClientRect().height);m.current.left_rendered_height=ge}if(K.isConnected){const ge=Math.round(K.getBoundingClientRect().height);m.current.right_rendered_height=ge}})},ue=new ResizeObserver(M);return ue.observe(j),ue.observe(K),M(),()=>{Y!=null&&cancelAnimationFrame(Y),ue.disconnect()}},[m]);const{data:X}=gi(void 0,!1,H);return s.jsxs("div",{className:"relative flex flex-col",children:[s.jsx("div",{className:"bg-token-main-surface-primary sticky top-[-1px] z-1 px-(--thread-content-margin) text-center text-lg text-pretty md:static","data-testid":"paragen-feedback-title",children:s.jsx(we,{id:"KKeSJV",defaultMessage:"You're giving feedback on a new version of ChatGPT."})}),s.jsx("div",{className:"text-token-text-secondary px-(--thread-content-margin) pt-1 pb-5 text-center text-sm text-pretty",children:s.jsx(we,{id:"TK934w",defaultMessage:"Which response do you prefer? Responses may take a moment to load."})}),s.jsx("div",{className:_e(mi(),"horzScrollShadows relative -mb-2 snap-x snap-mandatory overflow-x-auto overflow-y-clip pb-4"),ref:d,children:s.jsxs("div",{className:_e("mx-auto box-content max-w-[calc(2*var(--thread-content-max-width))] min-w-min px-(--thread-content-margin)","flex items-start gap-4 sm:gap-6"),children:[s.jsxs(ma,{rootElementRef:G,onClick:()=>{a(e)},hasActiveRequest:i,isImageGenInProgress:E,children:[s.jsxs(pa,{children:[s.jsx(Vn,{messages:p,isUserTurn:N,avatarClassName:x}),s.jsx(ha,{children:s.jsx(we,Ie(Q({},va.responseNumber),{values:{responseIndex:1,display_label:u?" ".concat(u):""}}))})]}),s.jsxs(s.Fragment,{children:[X!=null&&!N&&s.jsx(da,{clientThreadId:c.conversation.id,messages:p,isParagen:!0}),s.jsx(ct,Ie(Q({},c),{allMessages:p,groupedMessagesToRender:C,allGroupedMessages:C,isUserTurn:N,isFinalUserTurn:!1,isFinalAssistantTurn:!1,isCompletionRequestInProgress:S,hasActiveRequest:i,shouldGrowContainer:!1,isParagen:!0})),s.jsx(fa,{clientThreadId:c.conversation.id,conversationTurnMountTime:c.conversationTurnMountTime,turn:t,originalTurn:l})]})]}),s.jsxs(ma,{rootElementRef:z,onClick:()=>{a(n)},hasActiveRequest:i,isImageGenInProgress:E,children:[s.jsxs(pa,{children:[s.jsx(Vn,{messages:y,isUserTurn:V,avatarClassName:x}),s.jsx(ha,{children:s.jsx(we,Ie(Q({},va.responseNumber),{values:{responseIndex:2,display_label:T?" ".concat(T):""}}))})]}),s.jsxs(s.Fragment,{children:[X!=null&&!V&&s.jsx(da,{clientThreadId:c.conversation.id,messages:y,isParagen:!0}),s.jsx(ct,Ie(Q({},c),{allMessages:y,groupedMessagesToRender:I,allGroupedMessages:I,isFinalUserTurn:!1,isFinalAssistantTurn:!1,isUserTurn:V,isCompletionRequestInProgress:P,hasActiveRequest:i,shouldGrowContainer:!1,isParagen:!0})),s.jsx(fa,{clientThreadId:c.conversation.id,conversationTurnMountTime:c.conversationTurnMountTime,turn:r,originalTurn:l})]})]})]})})]})}function ma({rootElementRef:a,onClick:e,children:n,hasActiveRequest:t,isImageGenInProgress:r}){const i=g.useRef(null),l=g.useRef(null),m=g.useRef(null);return s.jsx("div",{"data-paragen-root":!0,className:"border-token-border-tertiary @container relative flex min-w-[min(450px,80cqw,80vw)] flex-1 snap-center flex-col gap-1 rounded-xl border text-start shadow-lg shadow-black/3",ref:a,children:s.jsxs("div",{className:_e(hi,"px-(--thread-content-margin) py-4"),children:[s.jsx("div",{className:_e("absolute top-48 right-0! left-0! h-px","invisible"),ref:i}),s.jsx("div",{className:_e("absolute top-48 right-0! bottom-0 left-0!","invisible"),ref:l}),s.jsx("div",{className:_e("absolute right-0! bottom-0 left-0! h-px","invisible"),ref:m}),n,t||r?null:s.jsx(Na,{className:"mt-4 self-start",onClick:e,"data-testid":"paragen-prefer-response-button",children:s.jsx(we,{id:"U2EAH6",defaultMessage:"I prefer this response"})})]})})}var Sa;const ha=Da.div(Sa||(Sa=et(["text-sm text-token-text-secondary font-semibold"])));var Ca;const pa=Da.div(Ca||(Ca=et(["flex gap-4 items-center mb-1"])));function fa({clientThreadId:a,conversationTurnMountTime:e,turn:n,originalTurn:t}){var u,T,p,y,x,_;const r=Ba();if(!r.showParagenMetadata||!r.showDebugConversationTurns&&!r.forceParagen||n==null)return null;let i=n===t?"ORIGINAL":"NEW";const l=n.messages[n.messages.length-1],m=(u=l==null?void 0:l.metadata)==null?void 0:u.__internal,c=(T=l==null?void 0:l.metadata)==null?void 0:T.paragen_display_label;if(m){const{model_id:C,model_definition_slug:I,model_definition_virtual_model_id:H,alternative_model_selection_rule:D,augmented_paragen_prompt_group_id:F,augmented_paragen_prompt_id:U,augmented_paragen_prompt:R}=m;C&&(i+="\nModel ID: ".concat(C)),I&&(i+="\nModel Slug: ".concat(I)),H&&(i+="\nVirtual Model ID: ".concat(H)),D&&(i+="\nAlternative Model Rule: ".concat(D)),F&&(i+="\nPrompt Group ID: ".concat(F)),U&&(i+="\nPrompt ID: ".concat(U)),R&&(i+="\nPrompt: ".concat(R)),c&&(i+="\nDisplay Label: ".concat(c))}i+="\nMessage ID: ".concat(l.id);const b=$.getParentPromptNode(_s(a),n.messages[0].id);if(!b)throw new Error("Expected prompt for side by side feedback");const f=((p=b.message.clientMetadata)==null?void 0:p.variantsInStreamInfo)==null&&((y=b.message.metadata)==null?void 0:y.paragen_variants_info)!=null;return i+="\nUser prompt message ID: ".concat(b.message.id),i+="\nIs Persisted Paragen? ".concat(f),i+="\nCompletion Sample Finish Time: ".concat(f?"".concat(e," (persisted)"):(_=(x=L(n.messages))==null?void 0:x.clientMetadata)==null?void 0:_.completionSampleFinishTime),s.jsx("div",{className:"text-sm whitespace-pre-wrap text-red-500",children:i})}async function xa({params:a}){await ht.safePost("/paragen_submission",{requestBody:a,authOption:kl.SendIfAvailable})}const va=li({responseNumber:{id:"ConversationTurnTwoUpFeedback.responseNumber",defaultMessage:"Response {responseIndex, number}{display_label}"}});function Ka({ctx:a,clientThreadId:e,messageId:n,isSharedConversation:t,isAuthoredByCurrentUser:r,serverThreadId:i}){const l=i!=null?i:es(e),m=n!=null?n:null;return{canReportMessage:!!(m&&l)&&Le(a,"3376455464")&&!r&&!t,handleReportMessage:()=>{m&&Ha(a,Bd,{clientThreadId:e,serverThreadId:l!=null?l:void 0,messageId:m})}}}const Bd=ze(()=>ss(()=>import("./d3ia29s4ey7jfka4.js"),__vite__mapDeps([9,1,2,3,4,5])).then(a=>a.ThreadReportMessageModal)),Od=ze(async()=>()=>null),Ud=a=>{"use forget";const e=ls.c(19),{alwaysShow:n,isUserTurn:t,children:r}=a,i=g.useRef(null);let l,m;e[0]!==n?(l=()=>{const C=i.current;C&&(n?requestAnimationFrame(()=>{C&&(C.style.maskPosition=n?"0% 0%":"")}):C.style.maskPosition="")},m=[n],e[0]=n,e[1]=l,e[2]=m):(l=e[1],m=e[2]),g.useEffect(l,m);const c=!n&&"absolute start-0 end-0 flex",b=t?"justify-end":"min-h-[46px] justify-start";let f;e[3]!==c||e[4]!==b?(f=_e("z-0 flex",c,b),e[3]=c,e[4]=b,e[5]=f):f=e[5];const u=!t&&"touch:w-[calc(100%+--spacing(3.5))] -mt-1 w-[calc(100%+--spacing(2.5))]",T=n&&!t&&"duration-[1.5s]",p=!(n||t)&&"duration-500 group-hover/turn-messages:delay-300";let y;if(e[6]!==t||e[7]!==u||e[8]!==T||e[9]!==p){let C;e[11]!==t?(C=t&&["touch:pointer-events-auto touch:opacity-100","duration-300 group-hover/turn-messages:delay-300","pointer-events-none opacity-0 motion-safe:transition-opacity","group-hover/turn-messages:pointer-events-auto group-hover/turn-messages:opacity-100","group-focus-within/turn-messages:pointer-events-auto group-focus-within/turn-messages:opacity-100","has-data-[state=open]:pointer-events-auto has-data-[state=open]:opacity-100"],e[11]=t,e[12]=C):C=e[12],y=_e("touch:-me-2 touch:-ms-3.5 -ms-2.5 -me-1 flex flex-wrap items-center gap-y-4 p-1 select-none",u,T,"focus-within:transition-none hover:transition-none",p,!t&&["touch:pointer-events-auto","pointer-events-none [mask-image:linear-gradient(to_right,black_33%,transparent_66%)] [mask-size:300%_100%] [mask-position:100%_0%] motion-safe:transition-[mask-position]","group-hover/turn-messages:pointer-events-auto group-hover/turn-messages:[mask-position:0_0]","group-focus-within/turn-messages:pointer-events-auto group-focus-within/turn-messages:[mask-position:0_0]","has-data-[state=open]:pointer-events-auto has-data-[state=open]:[mask-position:0_0]"],C),e[6]=t,e[7]=u,e[8]=T,e[9]=p,e[10]=y}else y=e[10];let x;e[13]!==r||e[14]!==y?(x=s.jsx("div",{ref:i,className:y,children:r}),e[13]=r,e[14]=y,e[15]=x):x=e[15];let _;return e[16]!==x||e[17]!==f?(_=s.jsx("div",{className:f,children:x}),e[16]=x,e[17]=f,e[18]=_):_=e[18],_},Gd=a=>{"use forget";var Ms,hs,as,ve,Qe,Xe;const e=ls.c(108),{activeVariantIndex:n,clientThreadId:t,conversationMode:r,lastMessage:i,messages:l,numVariants:m,onChangeIndex:c,onRate:b,showCanvasButton:f,showCopyButton:u,showPagination:T,showPlayButton:p,showRatingButtons:y,showRegenerateButton:x,turn:_,turnIndex:C,parentPrompt:I,isAgentTurn:H,isKAUR1BR5:D,reportableMessageId:F,isSharedConversation:U,serverThreadIdForReporting:R,projectId:S,projectConversationId:P}=a,k=U===void 0?!1:U,h=ts(),E=qe(),N=Ss(),V=ya(),d=Ua(Bs);let G;e[0]!==h?(G=pt(h),e[0]=h,e[1]=G):G=e[1];const z=G;let w;e[2]!==h?(w=!1,e[2]=h,e[3]=w):w=e[3];const de=w,X=Ga(),te=(Ms=i==null?void 0:i.clientMetadata)==null?void 0:Ms.rating,Se=(hs=i==null?void 0:i.clientMetadata)==null?void 0:hs.requestId;let W,j;e[4]!==t||e[5]!==h||e[6]!==k||e[7]!==(i==null?void 0:i.id)||e[8]!==F||e[9]!==R?(W=es(t),j=Ka({ctx:h,clientThreadId:t,messageId:(as=F!=null?F:i==null?void 0:i.id)!=null?as:null,isSharedConversation:k,isAuthoredByCurrentUser:!1,serverThreadId:(ve=R!=null?R:W)!=null?ve:null}),e[4]=t,e[5]=h,e[6]=k,e[7]=i==null?void 0:i.id,e[8]=F,e[9]=R,e[10]=W,e[11]=j):(W=e[10],j=e[11]);const{canReportMessage:K,handleReportMessage:Y}=j,{imageGenMessages:M,enableImageGenPostSharing:ue,enableMessageSliceSharing:ge,hasErrorInTurn:J,isIncomplete:We}=pi(l),Ce=fi.useSelectedIndex();let Ae;e[12]!==l?(Ae=l.filter(Rl).filter(Wd),e[12]=l,e[13]=Ae):Ae=e[13];const Fe=Ae.length>0,ie=M.length>0,Cs=El(),ys=Al(),Ts=Va();let q;e[14]!==h?(q=()=>Fl(Nl(h)),e[14]=h,e[15]=q):q=e[15];const ds=ce(q);let me;e[16]!==i?(me=i!=null&&dt.getAudioAssetPointers(i).length>0,e[16]=i,e[17]=me):me=e[17];const he=me;let pe;e[18]!==(i==null?void 0:i.id)?(pe=oe=>Si(oe,i==null?void 0:i.id),e[18]=i==null?void 0:i.id,e[19]=pe):pe=e[19];const cs=Ee(t,pe);let ns;e[20]!==ie||e[21]!==Fe||e[22]!==M?(ns=ie&&!Fe&&M.some(Xn),e[20]=ie,e[21]=Fe,e[22]=M,e[23]=ns):ns=e[23];const us=ns,gs=W!=null&&!J&&!We&&!H&&z&&!ys&&!d&&!ds&&!X,ms=W!=null&&!J&&!We&&!H&&z&&!ys&&!d&&!cs&&!Ts&&!X;let je=null;if(gs){if(ue||ge){const oe=(Qe=M[Ce])==null?void 0:Qe.id,ae=I==null?void 0:I.id;let O;e[24]!==t||e[25]!==l||e[26]!==oe||e[27]!==ae?(O=s.jsx(Hd,{clientThreadId:t,imageGenMessageId:oe,messages:l,parentPromptId:ae}),e[24]=t,e[25]=l,e[26]=oe,e[27]=ae,e[28]=O):O=e[28],je=O}else if(Cs&&La(h,"1547743984").get("show_share_button_inline",!1)){let oe;e[29]!==W?(oe=()=>{W&&Dl.openSharingModal(W)},e[29]=W,e[30]=oe):oe=e[30];let ae;e[31]!==E?(ae=E.formatMessage({id:"ConversationTurn.shareButtonTooltip",defaultMessage:"Share conversation"}),e[31]=E,e[32]=ae):ae=e[32];let O;e[33]!==oe||e[34]!==ae?(O=s.jsx(rs,{onClick:oe,label:ae,className:"sm:hidden",icon:Ma}),e[33]=oe,e[34]=ae,e[35]=O):O=e[35],je=O}}if(i&&rt(i)&&!Xn(i))return null;const fe=d?"small":"med",$e=!!(p&&i&&W&&(he||!Ts));let ne;e[36]!==n||e[37]!==m||e[38]!==c||e[39]!==T?(ne=T&&s.jsx(wa,{currentPage:n,onChangeIndex:c,length:m}),e[36]=n,e[37]=m,e[38]=c,e[39]=T,e[40]=ne):ne=e[40];let Be;e[41]!==fe||e[42]!==t||e[43]!==h||e[44]!==us||e[45]!==V||e[46]!==u||e[47]!==N||e[48]!==C?(Be=u&&!us&&s.jsx(Qa,{size:fe,onClick:oe=>{ja(h,t,C,N,oe,"mouse",V)}}),e[41]=fe,e[42]=t,e[43]=h,e[44]=us,e[45]=V,e[46]=u,e[47]=N,e[48]=C,e[49]=Be):Be=e[49];let Oe;e[50]!==fe||e[51]!==te||e[52]!==ie||e[53]!==E||e[54]!==b||e[55]!==y?(Oe=y&&!ie&&s.jsxs(s.Fragment,{children:[te!=="thumbsDown"&&s.jsx(rs,{size:fe,onClick:()=>b("thumbsUp"),selected:te==="thumbsUp",icon:te==="thumbsUp"?xi:vi,label:E.formatMessage({id:"ConversationTurn.goodResponseTooltip",defaultMessage:"Good response"}),testId:"good-response-turn-action-button"}),te!=="thumbsUp"&&s.jsx(rs,{size:fe,onClick:()=>b("thumbsDown"),selected:te==="thumbsDown",icon:te==="thumbsDown"?bi:Ii,label:E.formatMessage({id:"ConversationTurn.badResponseTooltip",defaultMessage:"Bad response"}),testId:"bad-response-turn-action-button"})]}),e[50]=fe,e[51]=te,e[52]=ie,e[53]=E,e[54]=b,e[55]=y,e[56]=Oe):Oe=e[56];let Ne;e[57]!==i||e[58]!==P||e[59]!==S?(Ne=s.jsx(Ci,{lastMessage:i,projectConversationId:P,projectId:S}),e[57]=i,e[58]=P,e[59]=S,e[60]=Ne):Ne=e[60];let ke;e[61]!==t||e[62]!==de||e[63]!==C?(ke=!1,e[61]=t,e[62]=de,e[63]=C,e[64]=ke):ke=e[64];let Ue;e[65]!==fe||e[66]!==t||e[67]!==r||e[68]!==ie||e[69]!==i||e[70]!==l||e[71]!==I||e[72]!==x?(Ue=x&&i&&s.jsx(Ld,{clientThreadId:t,conversationMode:r,lastMessage:i,messages:l,hasImageGenMessage:ie,parentPrompt:I,size:fe}),e[65]=fe,e[66]=t,e[67]=r,e[68]=ie,e[69]=i,e[70]=l,e[71]=I,e[72]=x,e[73]=Ue):Ue=e[73];let xe;e[74]!==K||e[75]!==ms||e[76]!==t||e[77]!==h||e[78]!==Y||e[79]!==ie||e[80]!==Fe||e[81]!==M||e[82]!==X||e[83]!==d||e[84]!==D||e[85]!==he||e[86]!==i||e[87]!==l||e[88]!==(I==null?void 0:I.id)||e[89]!==Se||e[90]!==Ce||e[91]!==f||e[92]!==p||e[93]!==_||e[94]!==C?(xe=!d&&s.jsx(_i,{showPlayButton:!!(p&&i&&(Fe||he)),showCanvasButton:!ie&&f,showBranchButton:ms&&Le(h,"3550297692"),canShowScheduleButton:!D&&!X,turnIndex:C,clientThreadId:t,messages:l,imageGenMessageId:(Xe=M[Ce])==null?void 0:Xe.id,lastMessage:i,turn:_,requestId:Se,parentPromptId:I==null?void 0:I.id,showReportMessageButton:K,onReportMessage:Y}),e[74]=K,e[75]=ms,e[76]=t,e[77]=h,e[78]=Y,e[79]=ie,e[80]=Fe,e[81]=M,e[82]=X,e[83]=d,e[84]=D,e[85]=he,e[86]=i,e[87]=l,e[88]=I==null?void 0:I.id,e[89]=Se,e[90]=Ce,e[91]=f,e[92]=p,e[93]=_,e[94]=C,e[95]=xe):xe=e[95];let Ke;return e[96]!==i||e[97]!==W||e[98]!==je||e[99]!==$e||e[100]!==ne||e[101]!==Be||e[102]!==Oe||e[103]!==Ne||e[104]!==ke||e[105]!==Ue||e[106]!==xe?(Ke=s.jsxs(yi,{enable:$e,lastMessage:i,serverThreadId:W,children:[ne,Be,Oe,Ne,je,ke,Ue,xe]}),e[96]=i,e[97]=W,e[98]=je,e[99]=$e,e[100]=ne,e[101]=Be,e[102]=Oe,e[103]=Ne,e[104]=ke,e[105]=Ue,e[106]=xe,e[107]=Ke):Ke=e[107],Ke},Vd=a=>{"use forget";const e=ls.c(35),{activeVariantIndex:n,clientThreadId:t,numVariants:r,onAnticipateEdit:i,onChangeIndex:l,onEnterEdit:m,showCopyButton:c,showEditMessageButton:b,showPagination:f,turnIndex:u,reportableMessageId:T,reportableMessageAuthoredByCurrentUser:p,isSharedConversation:y,serverThreadIdForReporting:x}=a,_=y===void 0?!1:y,C=ts(),I=Ss(),H=ya(),D=qe(),F=p!=null?p:!1,U=x!=null?x:null;let R;e[0]!==t||e[1]!==C||e[2]!==_||e[3]!==T||e[4]!==F||e[5]!==U?(R=Ka({ctx:C,clientThreadId:t,messageId:T,isSharedConversation:_,isAuthoredByCurrentUser:F,serverThreadId:U}),e[0]=t,e[1]=C,e[2]=_,e[3]=T,e[4]=F,e[5]=U,e[6]=R):R=e[6];const{canReportMessage:S,handleReportMessage:P}=R;let k;e[7]!==C?(k=Pl(C),e[7]=C,e[8]=k):k=e[8];const h=k;let E;e[9]!==t||e[10]!==C||e[11]!==H||e[12]!==c||e[13]!==h||e[14]!==I||e[15]!==u?(E=c&&s.jsxs(s.Fragment,{children:[h&&!1,s.jsx(Qa,{onClick:z=>{ja(C,t,u,I,z,"mouse",H)}})]}),e[9]=t,e[10]=C,e[11]=H,e[12]=c,e[13]=h,e[14]=I,e[15]=u,e[16]=E):E=e[16];let N;e[17]!==S||e[18]!==P||e[19]!==D?(N=S&&s.jsx(rs,{icon:gt,onClick:z=>{z.stopPropagation(),P()},label:D.formatMessage({id:"ConversationTurn.reportMessageTooltip",defaultMessage:"Report message"}),testId:"report-message-turn-action-button"}),e[17]=S,e[18]=P,e[19]=D,e[20]=N):N=e[20];let V;e[21]!==i||e[22]!==m||e[23]!==b?(V=b&&s.jsx(Ti,{onAnticipateEdit:i,onEnterEdit:m}),e[21]=i,e[22]=m,e[23]=b,e[24]=V):V=e[24];let d;e[25]!==n||e[26]!==r||e[27]!==l||e[28]!==f?(d=f&&s.jsx(wa,{currentPage:n,onChangeIndex:l,length:r}),e[25]=n,e[26]=r,e[27]=l,e[28]=f,e[29]=d):d=e[29];let G;return e[30]!==E||e[31]!==N||e[32]!==V||e[33]!==d?(G=s.jsxs(s.Fragment,{children:[E,N,V,d]}),e[30]=E,e[31]=N,e[32]=V,e[33]=d,e[34]=G):G=e[34],G},Ld=a=>{"use forget";const e=ls.c(15),{clientThreadId:n,conversationMode:t,messages:r,hasImageGenMessage:i,lastMessage:l,parentPrompt:m,size:c}=a,b=c===void 0?"med":c;let f;e[0]!==n||e[1]!==t?(f={clientThreadId:n,conversationMode:t},e[0]=n,e[1]=t,e[2]=f):f=e[2];const u=Bl(f),T=Mi(n,l);let p;e[3]!==l||e[4]!==u?(p=_=>{const{sourceEvent:C,requestedModelId:I,appendMessages:H,extraStreamParams:D}=_;l&&u({sourceEvent:C,nodeId:l.id,requestedModelId:I,appendMessages:H,extraStreamParams:D})},e[3]=l,e[4]=u,e[5]=p):p=e[5];const y=p;let x;return e[6]!==T||e[7]!==n||e[8]!==i||e[9]!==l||e[10]!==r||e[11]!==y||e[12]!==m||e[13]!==b?(x=i?s.jsx(Od,{messages:r,onModelSelect:y}):s.jsx(Ei,{className:"text-token-text-secondary hover:bg-token-bg-secondary touch:px-2.5 h-[30px] rounded-md px-1.5",clientThreadId:n,message:l,onModelSelect:y,canRegenerateResponse:T,parentPrompt:m,size:b}),e[6]=T,e[7]=n,e[8]=i,e[9]=l,e[10]=r,e[11]=y,e[12]=m,e[13]=b,e[14]=x):x=e[14],x},Qa=a=>{"use forget";const e=ls.c(10),{onClick:n,size:t}=a,r=t===void 0?"med":t,[i,l]=g.useState(!1),m=wi(),c=qe();let b;e[0]!==m||e[1]!==n?(b=y=>{y.stopPropagation(),De.logEvent("ChatGPT Turn Action Copy Clicked"),n(y),l(!0),setTimeout(()=>{m()&&l(!1)},2e3),Ul.logEvent("chatgpt_turn_action_copy")},e[0]=m,e[1]=n,e[2]=b):b=e[2];const f=b,u=i?ji:ki;let T;e[3]!==c?(T=c.formatMessage({id:"CopyButton.copyTooltip",defaultMessage:"Copy"}),e[3]=c,e[4]=T):T=e[4];let p;return e[5]!==f||e[6]!==r||e[7]!==u||e[8]!==T?(p=s.jsx(rs,{icon:u,onClick:f,label:T,testId:"copy-turn-action-button",size:r}),e[5]=f,e[6]=r,e[7]=u,e[8]=T,e[9]=p):p=e[9],p};function Hd(a){"use forget";var F;const e=ls.c(21),{clientThreadId:n,imageGenMessageId:t,messages:r,parentPromptId:i}=a,[l,m]=g.useState(!1),c=qe();let b;e:{if(t){b="media_generation";break e}b="message_slice"}const f=b;let u;e[0]!==r?(u=(F=r==null?void 0:r.map(zd))!=null?F:void 0,e[0]=r,e[1]=u):u=e[1];const T=u;let p;e[2]!==n||e[3]!==t||e[4]!==T||e[5]!==i?(p={clientThreadId:n,imageGenMessageId:t,messageSliceIds:T,parentPromptId:i},e[2]=n,e[3]=t,e[4]=T,e[5]=i,e[6]=p):p=e[6];const y=Pi(p);let x,_;e[7]!==f?(x=()=>{De.logEvent("Share Post: Share Button Shown",{source:"turn_action",attachment_type:f})},_=[f],e[7]=f,e[8]=x,e[9]=_):(x=e[8],_=e[9]),g.useEffect(x,_);let C;e[10]!==f||e[11]!==t||e[12]!==y?(C=()=>{m(!0),Ri(async()=>{await y()},qd,()=>{m(!1)}),De.logEventWithStatsig("Share Post: Share Button Clicked","chatgpt_post_share_button_clicked",Q({source:"turn_action",attachment_type:f},t?{message_id:t}:{}))},e[10]=f,e[11]=t,e[12]=y,e[13]=C):C=e[13];let I;e[14]!==c?(I=c.formatMessage({id:"ConversationTurn.sharePostButtonTooltip",defaultMessage:"Share"}),e[14]=c,e[15]=I):I=e[15];const H=l?Ol:Ma;let D;return e[16]!==l||e[17]!==C||e[18]!==I||e[19]!==H?(D=s.jsx(rs,{onClick:C,label:I,icon:H,disabled:l}),e[16]=l,e[17]=C,e[18]=I,e[19]=H,e[20]=D):D=e[20],D}function qd(){}function zd(a){return a.id}function Wd(a){return a.recipient==="all"}const $d=ze(()=>ss(()=>import("./meg2e6l315h292o7.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(a=>a.MemoryActionResult)),Kd=ze(()=>ss(()=>import("./dk0xd8ku5yovoyxl.js"),__vite__mapDeps([10,1,2,3,11,4,5])).then(a=>a.AutomationSourceHeader)),ba=ze(()=>ss(()=>import("./pgiy1j9b3s5zyv35.js"),__vite__mapDeps([12,1,2,3,13,4,5])).then(a=>a.TextMessageEditor)),Qd=ze(()=>ss(()=>import("./kzv3lmwfjxg7fbwd.js"),__vite__mapDeps([14,1,2,3,4,5,15,16,17,18,19])).then(a=>a.ChatScreenRetrievalResultsFlyoutContent)),Ia=80,ot=16;function it(){return{minHeight:"calc(100dvh - ".concat(Hr,"px - 120px)")}}function Xd(a){"use no forget";var Lt,Ht,qt,zt,Wt,$t,Kt,Qt,Xt,Yt,Jt,Zt,en,sn,tn,nn,an,on,rn,ln,dn,cn,un,gn,mn,hn,pn,fn,xn,vn,bn,In,_n,Sn,Cn,yn,Tn,Mn,wn;const{turnIndex:e,isFinalTurn:n,conversation:t,onRequestCompletion:r,currentModelId:i,scrollToMessageId:l,scrollToMessageIsAssistant:m,dateHeaderType:c,hideUserActions:b,disableHorizontalPadding:f}=a,u=ts(),T=ka(u),p=Gl(),y=Ga(),x=Ua(o=>Bs(o)),_=Vl(u),C=!!p&&Ll(p),I=Yn(Jn.isBusinessWorkspace),H=Ai(),D=Fi(u)||H,F=Ni(u),U=Di(u),{eligible:R}=Bi(Oi.hasSeenAudioParagenPrompt),[S,P,k]=Ee(t.id,o=>{const v=$.getConversationTurnAtIndex(o,e),A=e>0?$.getConversationTurnAtIndex(o,e-1):null,B=(A==null?void 0:A.role)===se.User&&A.messages.some(re=>{var Z;return(Z=re.metadata)==null?void 0:Z.visually_hide_response_from_conversation});return[v,B,A]},{disablePerfDetector:n}),{messages:h,messageGroups:E}=S,N=Ui(o=>o.size===0?-1:E.findIndex(v=>v.type===st?v.groups.some(A=>A.messages.some(B=>o.has(B==null?void 0:B.id))):v.messages.some(A=>o.has(A==null?void 0:A.id)))),V=h[0],d=L(h),G=g.useMemo(()=>Zn(h,o=>Hl(o).length>0),[h]),z=g.useMemo(()=>E.some(o=>o.type===ql.SearchGPTQuery),[E]),w=g.useMemo(()=>h.some(o=>{var v;return(v=o.metadata)==null?void 0:v.n7jupd_message}),[h]),de=g.useMemo(()=>{var o,v;return(v=(o=L(h))==null?void 0:o.metadata)==null?void 0:v.chatgpt_sdk_suppressed_response},[h]),X=g.useMemo(()=>w?Zn(h,o=>o.author.name==="n7jupd.metadata"):null,[h,w]),te=!!((Lt=X==null?void 0:X.metadata)!=null&&Lt.kaur1br5_mode),Se=Ee(t.id,o=>!!(o!=null&&o.pulseCardId)),W=ce(()=>Pa(u).isFeedbackViewOpen$()||Se&&e===1),{messages:j,visibleMessages:K,messageGroups:Y,lastMessageToRender:M}=g.useMemo(()=>{const o=N!==-1&&N+1<E.length,v=o?E.slice(0,N+1):E,A=o?v.flatMap(B=>B.type===st?B.groups.flatMap(re=>re.messages):B.messages):h;return{messages:A,visibleMessages:A.filter(zl),messageGroups:v,lastMessageToRender:L(A)}},[h,E,N]),ue=N!==-1,ge=Le(u,"1887864177"),J=Ee(t.id,o=>$.getLastMessageSystemHints(o)),We=Ee(t.id,o=>{var v;return(v=o==null?void 0:o.hasIKConvo)!=null?v:!1}),Ce=(J==null?void 0:J.includes(vs.Tatertot))&&Le(u,"28816792")&&Wl(u),{capabilitySuggestionsEnabled:Ae}=Gi(Ce),Os=g.useMemo(()=>({clientThreadId:t.id,turnIndex:e,messageId:d==null?void 0:d.id}),[t.id,e,d==null?void 0:d.id]),[Fe,ie]=g.useState(!1),[Cs,ys]=g.useState(!1),Ts=g.useContext(Vi)!=null,q=S.role===se.User,ds=Va(),me=$l(t.id),he=(Ht=S.gizmoId)!=null?Ht:me,pe=Kl(he).data,cs=he&&!tt(he)?pe:void 0,ns=he&&tt(he)?he:null,us=cs&&S.gizmoId!=null&&S.gizmoId!==me&&Le(u,"1418300125"),gs=ce(()=>ft(t)),ms=Ql(t.id),je=Li(gs),fe=Hi(gs,ms),$e=Xl(u),[ne,Be,Oe,Ne,ke,Ue,xe,Ke,Ms,hs,as,ve,Qe,Xe,oe,ae,O,Ya]=Ee(t.id,o=>{var jn,kn,Pn,Rn,En;const v=$.getParentPromptNode(o,V.id),A=(Rn=(jn=v==null?void 0:v.message.clientMetadata)==null?void 0:jn.variantsInStreamInfo)!=null?Rn:(kn=v==null?void 0:v.message.metadata)!=null&&kn.paragen_variant_choice||(Pn=v==null?void 0:v.message.metadata)==null?void 0:Pn.paragen_variants_info,B=$.getVariantIds(o,V.id),re=$.getCurrentVariantId(o,V.id),Z=re?B.indexOf(re):0,ee=A&&(o==null?void 0:o.tree)!=null&&B.some(Me=>{var Fn;const{errType:An}=(Fn=o.tree.getLeafFromNode(Me).message.clientMetadata)!=null?Fn:{};return An!=null&&An!=="info"}),le=$.getConversationTurns(o),Re=le.findIndex(Me=>Me.role===se.Assistant),Zs=na(le,Me=>Me.role===se.Assistant),oi=le.slice(Re,e+1).every(Me=>Me.role===se.Assistant);return[v,d!=null&&!fd(d.id)&&$.isMessageTurnEnded(o,d.id),ee,qr(o==null?void 0:o.mode,pe==null?void 0:pe.gizmo.id),le.findIndex(Me=>Me.role===se.User)===e,na(le,Me=>Me.role===se.User)===e,Re===e,Zs===e,oi,$.getRequestId(o,d==null?void 0:d.id),A,B,Z,!!(o!=null&&o.continuingFromSharedPostId),o==null?void 0:o.currentLeafId,$.getSuperWidgetMessages(o,e)[0],$.lastUserMessage(o),(En=o==null?void 0:o.continuingFromSharedProjectConversationId)!=null?En:null]},{disablePerfDetector:n}),Ye=qa(),ws=ce(()=>{const o=Yl(t);return(o==null?void 0:o.value)===bs.STREAMING||(o==null?void 0:o.value)===bs.REALTIME||(o==null?void 0:o.value)===bs.REALTIME_BUSY}),Ja=j.some(o=>o.content.content_type===Ns.MultimodalText),Za=La(u,"3119715334").get("should-enable-skip",!1),xt=!pt(u),vt=S.messages.map(o=>o.id),ye=g.useRef(null);Yd({clientThreadId:t.id,turn:S,turnIndex:e,conversationTurnWrapperRef:ye});const Us=!T&&((qt=l==null?void 0:l.length)!=null?qt:0)>2&&l!=="finalAgentTurn"&&n,be=q?L(K):void 0,Gs=be==null?void 0:be.id,eo=g.useCallback(()=>{Gs&&(De.logEvent("Edit Prompt",{id:Gs,threadId:es(t.id)}),Is(u,"chatgpt_edit_prompt"),ie(!0))},[u,Gs,t.id]),so=g.useCallback(()=>{ie(!1)},[]),{onChangeRating:to}=qi({clientThreadId:t.id,currentModelConfig:gs}),no=o=>{var re;if(!d)return;const v=(re=d.clientMetadata)==null?void 0:re.rating,B=(v==="thumbs_up"?"thumbsUp":v==="thumbs_down"?"thumbsDown":v)===o?null:o;if(to({nodeId:d.id,messageId:d.id,rating:B}),B){const Z=md(()=>hd(u)),ee=Z&&E.some(le=>{var Re;return le.type!==st&&((Re=le.messages)==null?void 0:Re.some(pd))});De.logEventWithStatsig(B==="thumbsDown"?"Message Feedback Thumbs Down Clicked":"Message Feedback Thumbs Up Clicked","chatgpt_thumb_feedback",Q(Q({id:d.id,threadId:es(t.id),model:i,rating:B},Z?{isCATriggered:ee}:{}),x?{isSidebar:!0}:{}))}ys(B==="thumbsDown")},[ao]=g.useState(()=>Date.now()),Pe=Jl(t.id),oo=Pe!=null?Pe:null,bt=(Wt=Pe!=null?Pe:Ya)!=null?Wt:Ye&&(zt=t.sharedConversationId)!=null?zt:null,It=($t=zi(t.id))==null?void 0:$t.value,_t=It===bs.STREAMING,io=It===bs.REALTIME,ro=hs!=null,lo=Aa(hs),co=Hn.useState(o=>Hn.isReplayInProgress(o,oe)),Te=!Be&&lo||ue||_t||io||co&&n||h.some(o=>Wi(o)),St=Fa(),Vs=g.useRef(!1),Ct=g.useRef(void 0),uo=Zl({clientThreadId:t.id}),go=$i(t.id,d)&&!uo&&!!Pe,[,mo]=di(),{isOpen:js}=lt(),yt=za(),os=L(k==null?void 0:k.messages.filter(ed)),Tt=ce(()=>sd(u)),Ls=Ki({conversation:t,threadContent:(Kt=ae==null?void 0:ae.content)!=null?Kt:null,query:os?nt(os):null,triggeredSearch:z,messageGroups:Y,allMessages:h,isAdultSearchEnabled:Tt}),{isClassifiedAdult:Mt,isSafeSearchOff:ho}=Ls,[po,Hs]=ce(()=>[td(u)&&xe&&(!J||J.length===0||J.includes(vs.Search))&&!Mt,_&&S.role===se.Assistant&&Mt&&ho&&Tt]),Je=(po||Hs)&&Ls.showNavlinksWidget,qs=j.filter(ea),fo=Je&&qs.length===0&&!w,wt=((Qt=O==null?void 0:O.author.metadata)==null?void 0:Qt.real_author)==="onboarding";g.useEffect(()=>{const v=new URLSearchParams(window.location.search).get("message");!(v!=null&&vt.includes(v))||!ye.current||(ye.current.scrollIntoView({behavior:"instant"}),mo(B=>(B.delete("message"),B),{replace:!0,preventScrollReset:!0}))},[]),g.useEffect(()=>{l!==Ct.current&&(Vs.current=!1,Ct.current=l)},[l]),g.useEffect(()=>{if(T)return;const A=new URLSearchParams(window.location.search).get("message")!=null;if(Vs.current||A||l===void 0||!ye.current||yt||wt||_&&xe){l==="finalAgentTurn"&&n&&He(t.id,B=>{B.scrollToMessageId=void 0});return}(vt.includes(l)||l==="finalAgentTurn"&&n)&&(Vs.current=!0,requestAnimationFrame(()=>{requestAnimationFrame(()=>{var B,re;if(ye.current)if(l==="finalAgentTurn"&&n){const Z=_s(t.id),ee=(B=Z==null?void 0:Z.tree.getNodeIfExists(Z.currentLeafId))==null?void 0:B.message,Re=!!((ee==null?void 0:ee.channel)=="final"&&((re=ee.metadata)!=null&&re.mercury_message))?"start":"end";ye.current.scrollIntoView({behavior:"instant",block:Re}),He(t.id,Zs=>{Zs.scrollToMessageId=void 0})}else{const Z=ye.current.offsetHeight;let ee=0;js?ee=-8:_?ee=-1*ot:m?ee=-8:Z>Ia&&(ee=Ia-Z);const le=Qi(t).pinnedWidgetHeight$();le!=null&&(ee+=le+ot),ye.current.style.scrollMarginTop="".concat(ee+ot,"px"),ye.current.scrollIntoView({behavior:"smooth"})}})}))},[l,m,ye.current,js,yt,wt,_,xe]);const{showDebugConversationTurns:xo}=Ba(),vo=!Ye&&!Xe&&!ds&&!q,bo=(M==null?void 0:M.author.role)===se.Assistant?M:null,Io=(Yt=(Xt=M==null?void 0:M.metadata)==null?void 0:Xt.system_hints)==null?void 0:Yt.includes(vs.Research),_o=(Zt=(Jt=M==null?void 0:M.metadata)==null?void 0:Jt.system_hints)==null?void 0:Zt.includes(vs.Agent);Xi({isCompletionRequestInProgress:Te,isUserTurn:q,message:bo});const{isOpen:So}=lt(),Co=Yi(u),ks=Ji(Ne),yo=nd(o=>o.voiceFeedbackThread),jt=Pe===yo,To=(en=d==null?void 0:d.metadata)==null?void 0:en.async_source,Ps=n&&ro,Ge=ws||Te||_t,Mo=K.length===0&&j.some(ad),wo=((sn=Zi(K))==null?void 0:sn.author.name)===sa.A8KM123&&er(K,o=>o.author.name===sa.A8KM123||o.channel==="commentary"||o.author.role===se.Developer),jo=sr.useIsMultigenParagenVotingActive(),zs=!Fe&&!j.every(od)&&!Ye&&!Xe&&!ks&&!So&&S.role!==se.Developer&&!(S.role===se.User&&b)&&!(n&&jt&&Ge)&&!(Ps&&Ge)&&!(n&&ws&&To)&&!(Ge&&w)&&!(wo&&!n)&&!((tn=d==null?void 0:d.metadata)!=null&&tn.is_auto_proceed_message)&&!((nn=d==null?void 0:d.metadata)!=null&&nn.is_takeover_ended_message)&&!((an=d==null?void 0:d.metadata)!=null&&an.disable_turn_actions)&&!fo&&!S.userContinuationSuccessorTurnId&&!de&&!jo,ko=!zs&&!(Ps&&Ge)&&(Ye||Xe)&&!x,Po=j.some(o=>id(o)===rd.l1239dk1),Ws=Ee(t.id,o=>{var B,re;const v=new Set,A=$.getParentPromptNode(o,V.id);return(re=(B=A==null?void 0:A.message.metadata)==null?void 0:B.attachments)==null||re.forEach(Z=>{var ee,le,Re;(ee=Z.mime_type)!=null&&ee.startsWith("image/")||v.add((Re=(le=Z.context_connector_info)==null?void 0:le.context_connector)!=null?Re:"file")}),v}),$s=ld(),Ks=ta(u,"110789670");let Ze;$s.isLoading?Ze=void 0:$s.canUpgradeGDrive&&Ws.has(Fs.GDRIVE)&&Ks.get("enabled",!1)?Ze=Fs.GDRIVE:$s.canUpgradeSharepoint&&Ws.has(Fs.O365_BUSINESS)&&Ks.get("enabled",!1)?Ze=Fs.O365_BUSINESS:Ws.has("file")&&Ks.get("enabled",!1)&&(Ze="general");const Ro=(M==null?void 0:M.author.role)===se.Assistant&&((ln=(rn=(on=M==null?void 0:M.metadata)==null?void 0:on.content_references)==null?void 0:rn.length)!=null?ln:0)>0||We,Eo=Ps&&!Te&&!x&&!Ye&&!Xe&&!Po&&(ge||tr(u)||Ae||Ce||!!Ze),ps=d!=null&&(!I||fe||C||$e)&&!ks&&!xt&&!ds&&!((dn=d.metadata)!=null&&dn.b1de6e2_s),kt=ws||Te,[Ao,Fo]=g.useState(!1),No=!!((cn=O==null?void 0:O.metadata)!=null&&cn.dictation&&((un=O==null?void 0:O.metadata)!=null&&un.dictation_asset_pointer)&&!((gn=O==null?void 0:O.metadata)!=null&&gn.dictation_edited)),Do=!!(!R||Ao||(mn=O==null?void 0:O.metadata)!=null&&mn.audio_paragen_result||qn(O==null?void 0:O.id)),Pt=No&&!Do,Rt=Pt&&(!I||$e)&&ps&&!kt&&!x&&!js&&O!=null&&xe&&Le(u,"51772912"),Bo=nr(O==null?void 0:O.id,Rt),Et=Rt&&Bo,fs=!ks&&vo&&n&&(as==null?void 0:as.num_variants_in_stream)===2&&ve.length<=2&&!((hn=d==null?void 0:d.clientMetadata)!=null&&hn.inlineComparisonRating)&&!Oe&&!Pt&&!qn(O==null?void 0:O.id),At=!Et&&(!I||$e)&&ps&&(Ps||n&&jt)&&!kt&&!x&&!js&&!w&&!de,Ft=!((Te||ws)&&n)&&ve.length>1&&!fs,Nt=q&&j.some(o=>{var v;return(v=zn(o))==null?void 0:v.shouldHideContent}),Oo=q&&be!=null&&!((pn=be==null?void 0:be.metadata)!=null&&pn.async_task_id)&&Pe!=null&&!ks&&!Ja&&!Nt&&!xt&&!Io&&!_o&&!x,Uo=d!=null&&dt.getAudioAssetPointers(d).length>0,Go=d!=null&&((xn=(fn=d.clientMetadata)==null?void 0:fn.disclaimers)!=null?xn:[]).length===0&&!x&&(!ds||Uo)&&!y,Dt=g.useCallback(o=>{var v;He(t.id,A=>{mt.setCurrentBranch(A,ve[o])}),De.logEvent("Change Active Node",{intent:"toggle_between"}),Le(u,"4126691920")&&ar({parent_prompt_id:(v=ne==null?void 0:ne.id)!=null?v:"",prev_branch_id:ve[Qe],next_branch_id:ve[o]},es(t.id))},[t.id,ve,Qe,ne==null?void 0:ne.id,u]),Vo=Yn(Jn.accountUserId),Rs=Ee(t.id,o=>o==null?void 0:o.sharedProjectConversationOwner),Lo=!dd(u,he)||(Rs==null?void 0:Rs.id)!=null&&Rs.id===Vo,Bt=or(S,j,xo),Ot=w&&ir(j,n),Es=d==null?void 0:d.id,Qs=g.useCallback(()=>{Es&&rr(t,{type:"retrievalResults",turnIndex:e,messageId:Es})},[t,Es,e]),is=j.some(o=>{var v,A,B;return((v=o==null?void 0:o.metadata)==null?void 0:v.api_tool_type)==="glaux"||cd({id:(B=(A=o==null?void 0:o.metadata)==null?void 0:A.model_slug)!=null?B:""},u)}),Xs=g.useMemo(()=>lr(S,je,!!me),[S,je,me]),Ho=g.useMemo(()=>Xs&&!is,[Xs,is]),qo=g.useMemo(()=>dr(S,!!me,F),[F,me,S]),Ut=Le(u,"2137702454"),zo=g.useMemo(()=>S.role!==se.User&&je&&Ut&&!is,[S,je,Ut,is]),Wo=ud()&&CSS.supports("content-visibility: auto")&&!q&&ta(u,"1011775750").get("enabled",!1)&&(l==null||l==="finalAgentTurn")&&!cr(j),$o=g.useMemo(()=>j.some(o=>{var v;return((v=zn(o))==null?void 0:v.canRetry)===!1}),[j]),Ko=(vn=d==null?void 0:d.metadata)==null?void 0:vn.n7jupd_button_type,Qo=w&&d!=null&&d.id!=null&&!Ko,Xo=w&&n&&Ge,Yo=w&&n;if(!Bt&&!fs&&!Je)return Us?s.jsx("div",{style:it()}):null;if(Ot||P)return null;const Jo=(bn=M==null?void 0:M.metadata)!=null&&bn.followup_prompts?M.metadata.followup_prompts.map(o=>({text:o,type:ur.Reply})):[],Zo=(In=M==null?void 0:M.metadata)==null?void 0:In.category_suggestions,ei=(_n=M==null?void 0:M.metadata)==null?void 0:_n.action_suggestions,si=!j.some(o=>dt.getAudioAssetPointers(o).length>0)&&(!me||tt(me))&&!$o&&!y&&!W&&!!Pe,ti=!Te&&j.some(o=>{var v,A;return o.author.role===se.Assistant&&((A=(v=o.metadata)==null?void 0:v.onboarding)==null?void 0:A.main_usages)});ne==null||ne.message.id;const Ys=j.find(o=>{var v,A;return!!((A=(v=o.metadata)==null?void 0:v.onboarding)!=null&&A.examples)}),Js=(Cn=(Sn=Ys==null?void 0:Ys.metadata)==null?void 0:Sn.onboarding)==null?void 0:Cn.examples,Gt=!Nt&&(!n||!Te);if(!n&&qs.length===0&&!w&&!Je)return null;let xs="none";q&&ke&&(xs="first");const ni=k==null?void 0:k.messages.some(ea);if(q&&!ke&&(ni?xs="large":xs="none"),n&&(xs="last"),!Bt&&!fs&&!Je)return Us?s.jsx("div",{style:it()}):null;if(Ot||P)return null;const Vt=_?gr(h):void 0;if(!n&&qs.length===0&&!w&&!Je)return null;const ai=(()=>{if(S.userContinuationSuccessorTurnId)return"mb-1";if(q&&!zs&&!x)return"mb-10";if(!q&&x&&n)return"pb-[40px]"})();return s.jsx(mr.Provider,{value:xe,children:s.jsxs(hr,{children:[s.jsx(pr,{dateHeaderType:c,turn:S}),s.jsxs("article",{className:_e("text-token-text-primary w-full focus:outline-none","[--shadow-height:45px] has-data-writing-block:pointer-events-none has-data-writing-block:-mt-(--shadow-height) has-data-writing-block:pt-(--shadow-height) [&:has([data-writing-block])>*]:pointer-events-auto",Wo&&"[content-visibility:auto] supports-[content-visibility:auto]:[contain-intrinsic-size:auto_100lvh]",!T&&l==="finalAgentTurn"?"opacity-0":"",{hidden:Ts&&ke},q?"scroll-mt-(--header-height)":"scroll-mt-[calc(var(--header-height)+min(200px,max(70px,20svh)))]"),tabIndex:-1,style:Us?it():void 0,ref:ye,dir:"auto","data-turn-id":S.id,"data-testid":"conversation-turn-".concat(e),"data-scroll-anchor":!T&&n,"data-turn":q?"user":"assistant",children:[s.jsx(fr,{role:S.role,gizmo:cs}),s.jsx(xr,{role:S.role,children:s.jsxs(vr,{horizontalPadding:fs||f?"none":"standard",verticalPadding:xs,children:[fs?s.jsxs(s.Fragment,{children:[s.jsx(Nd,Q({isFeedbackEnabled:ps,variantIds:ve,conversationTurnMountTime:ao},a)),Za&&s.jsx("div",{className:"mt-4 flex w-full justify-center",children:s.jsxs(Na,{color:"secondary",className:"text-token-text-primary","data-testid":"paragen-skip-button",onClick:()=>{Oa.publish({kind:"requestCompletion",isForSkippingParagen:!0})},children:[s.jsx(br,{className:"text-token-text-secondary me-1"}),s.jsx(we,{id:"IuTr+b",defaultMessage:"Skip"})]})})]}):s.jsxs(Ra,{tabIndex:-1,className:_e("group/turn-messages focus-visible:outline-hidden",Je&&"super-widget-visible",ai,Ur({isUserTurn:q})),children:[us&&s.jsx(Ir,{gizmo:cs}),Je&&s.jsx(_r,{clientThreadId:t.id,query:os?nt(os):null,state:Ls,isAssistantResponseSuppressed:!!Hs}),zo&&s.jsx(Sr,{handleShowRetrievalResults:Qs,clientThreadId:t.id,turnIndex:e,responseComplete:!Ge,className:"mb-6"}),!q&&s.jsx($d,{messages:j,clientThreadId:t.id,gizmoId:pe==null?void 0:pe.gizmo.id}),j.some(o=>{var v,A,B;return(B=(v=o.metadata)==null?void 0:v.async_completion_id)!=null?B:q&&((A=o.metadata)==null?void 0:A.async_task_title)})&&s.jsx(Cr,{message:j.find(o=>{var v,A,B;return(B=(v=o.metadata)==null?void 0:v.async_completion_id)!=null?B:q&&o.author.role===se.User&&((A=o.metadata)==null?void 0:A.async_task_title)}),clientThreadId:t.id,isUserTurn:q}),Co&&q&&s.jsx(Kd,{clientThreadId:t.id,messages:j}),Fe&&be?s.jsx(ba,{message:be,clientThreadId:t.id,onRequestCompletion:r,onExitEdit:so,disabled:St}):!Hs&&s.jsx(ct,Ie(Q({allMessages:h,groupedMessagesToRender:Y,allGroupedMessages:E},a),{isUserTurn:q,isFinalUserTurn:Ue,isFinalAssistantTurn:Ke,isWithinFirstAssistantTurns:Ms,isCompletionRequestInProgress:Te,isFeedbackEnabled:ps,isFinalTurn:n,isGlauxTurn:is,hasActiveRequest:St,isAgentTurn:w,isKAUR1BR5:te,query:os?nt(os):null,wasInterrupted:Mo,superWidgetContent:(yn=ae==null?void 0:ae.content)!=null?yn:null,lastAgentMetadataNode:X,hasSearchSystemHint:(Tn=J==null?void 0:J.includes(vs.Search))!=null?Tn:!1})),Ho&&(D&&qo?s.jsx(Qd,{turnIndex:e,clientThreadId:t.id,variant:"bottom"}):s.jsx(Wn,{handleShowRetrievalResults:Qs,clientThreadId:t.id,turnIndex:e,responseComplete:!Ge})),Qo&&s.jsx(yr,{message:d,clientThreadId:t.id,turnIndex:e,referenceMessageId:d.id,responseComplete:!n||!Te}),ti&&s.jsx(Tr,{clientThreadId:t.id}),Js&&Js.length>0&&!Te&&s.jsx(Mr,{clientThreadId:t.id,examples:Js}),Vt&&s.jsx(wr,{message:Vt,className:"mt-4"}),zs&&s.jsx(Ud,{isUserTurn:q,alwaysShow:!0,children:q?x?null:s.jsx(Vd,{activeVariantIndex:Qe,clientThreadId:t.id,numVariants:ve.length,onAnticipateEdit:ba.prefetch,onChangeIndex:Dt,onEnterEdit:eo,showCopyButton:Gt,showEditMessageButton:Oo,showPagination:Ft,turnIndex:e,reportableMessageId:(Mn=be==null?void 0:be.id)!=null?Mn:null,reportableMessageAuthoredByCurrentUser:Lo,isSharedConversation:Ye,serverThreadIdForReporting:bt}):s.jsxs(s.Fragment,{children:[s.jsx(Gd,{activeVariantIndex:Qe,clientThreadId:t.id,conversationMode:Ne,lastMessage:d,messages:j,numVariants:ve.length,onChangeIndex:Dt,onRate:no,showCanvasButton:go,showCopyButton:Gt,showPagination:Ft,showPlayButton:Go,showRatingButtons:ps,showRegenerateButton:si,turn:S,turnIndex:e,parentPrompt:ne,isAgentTurn:w,isKAUR1BR5:te,reportableMessageId:(wn=d==null?void 0:d.id)!=null?wn:null,isSharedConversation:Ye,serverThreadIdForReporting:bt,projectId:ns,projectConversationId:oo}),is&&Xs?s.jsx(Wn,{handleShowRetrievalResults:Qs,clientThreadId:t.id,turnIndex:e,responseComplete:!Ge}):s.jsx(s.Fragment,{children:!U&&s.jsx($n,{clientThreadId:t.id,message:G!=null?G:d,turnIndex:e,isAgentTurn:w})}),At&&s.jsx(jr,{canShowInlineMessageFeedback:Cs,clientThreadId:t.id,messageForRating:d}),!1]})}),Ke&&h.some(kr)&&!h.some(Pr)&&!h.some(Rr)&&s.jsx(Er,{isCompletionRequestInProgress:Te,conversation:t,messages:h}),Xo&&s.jsx(Ar,{clientThreadId:t.id}),Yo&&s.jsx(Fr,{clientThreadId:t.id,messages:j}),ko&&s.jsx($n,{clientThreadId:t.id,message:G!=null?G:d,turnIndex:e,isAgentTurn:w}),!1,At&&s.jsx(Nr,{canShowInlineMessageFeedback:Cs,clientThreadId:t.id,messageForRating:d,allGroupedMessages:E,currentModelId:i}),s.jsx(gd,{mode:"wait",children:Et&&s.jsx(Dr,{lastUserMessageId:O.id,setIsDismissed:Fo})}),Eo&&(Ze?s.jsx(Br,{clientThreadId:t.id,connectorToUpsell:Ze,analyticsMetadata:Os}):s.jsx(Or,{followups:Jo,actionSuggestions:ei,categorySuggestions:Zo,clientThreadId:t.id,lastMessageId:Es,analyticsMetadata:Os,isTatertotFollowupsEnabled:Ce,shouldHideFollowups:Ro}))]}),s.jsx(Gr,{clientThreadId:t.id,turn:S,isFinalTurn:n}),s.jsx(Vr,{clientThreadId:t.id,turn:S})]})})]})]})})}const Yd=({clientThreadId:a,turn:e,turnIndex:n,conversationTurnWrapperRef:t})=>{const r=Lr();g.useEffect(()=>{if(!r)return;const i=new IntersectionObserver(l=>{l.forEach(m=>{m.isIntersecting?He(a,c=>{var b;c.turnIdsInViewpoint=[...(b=c.turnIdsInViewpoint)!=null?b:[],{turnId:e.id,turnIndex:n,role:e.role}]}):He(a,c=>{var b;c.turnIdsInViewpoint=(b=c.turnIdsInViewpoint)==null?void 0:b.filter(({turnId:f})=>f!==e.id)})})},{root:null,threshold:.1});return t.current&&i.observe(t.current),()=>{He(a,l=>{var m;l.turnIdsInViewpoint=(m=l.turnIdsInViewpoint)==null?void 0:m.filter(({turnId:c})=>c!==e.id)}),i.disconnect()}},[a,t,r,e.id,e.role,n])},Jd=Ta.memo(Xd),Zd=({image:a,onClose:e,onRequestCompletion:n,clientThreadId:t,currentModelId:r,post:i,canDelete:l,onOpenReport:m})=>{var S;const c=qe(),b=Ss(),f=ut(),[u,T]=g.useState("default"),p=zr(),y=g.useRef(null),x=g.useRef(p);g.useEffect(()=>{x.current=p},[p]);const _=g.useCallback(()=>Wr(c),[c]),C=g.useCallback(()=>{a&&T("inpaint")},[a]),I=g.useCallback(()=>{T("default"),x.current.clearAllDrawings()},[]),H=g.useCallback(()=>{a&&$r({url:a.url,fileName:_()})},[a,_]),D=g.useCallback(()=>{var P;return(P=y.current)==null?void 0:P.getImageData()},[]),F=g.useCallback(async()=>{if(window.confirm(c.formatMessage({id:"postReceiverModal.deletePostConfirmation",defaultMessage:"Are you sure you want to delete this post?"})))try{await ht.safeDelete("/share/post/{post_id}",{parameters:{path:{post_id:i.id}}}),f("/",{replace:!0})}catch(P){b.danger(ci({id:"postReceiverModal.deletePostError",defaultMessage:"Failed to delete the post"}),{toastId:"post_receiver_modal.delete_post_error"})}},[i.id,c,b,f]),U=u==="inpaint"?c.formatMessage({id:"TjVqYb",defaultMessage:"Edit Selection"}):(S=i.text)!=null?S:c.formatMessage({id:"htGxHc",defaultMessage:"Image"}),R=g.useCallback(P=>{P.key==="Escape"&&(e(),P.preventDefault())},[e]);return g.useEffect(()=>(document.addEventListener("keydown",R),()=>document.removeEventListener("keydown",R)),[R]),s.jsx(at.Root,{isOpen:!0,onClose:e,testId:"modal-lightbox-post-share",shouldIgnoreClickOutside:u==="inpaint",children:s.jsx(at.Overlay,{children:s.jsxs(at.Content,{size:"fullscreen",removePopoverStyling:!0,className:"grid min-h-0 grid-rows-[auto_minmax(0,1fr)] overflow-hidden",children:[s.jsxs("header",{className:"flex h-14 w-full items-center justify-between gap-2 px-2 md:px-4",children:[s.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[s.jsx(Ve,{icon:xd,onClick:e,"aria-label":c.formatMessage({id:"EYLKSm",defaultMessage:"Close"})}),s.jsx("h2",{className:"line-clamp-1 text-base font-medium",children:U})]}),s.jsx("div",{className:"flex items-center gap-2",children:u==="inpaint"?s.jsxs(s.Fragment,{children:[s.jsx(Ve,{className:"aspect-square",icon:Kr,onClick:p.undoDrawing,disabled:!p.canUndoDrawing,"aria-label":c.formatMessage({id:"OmaTPx",defaultMessage:"Undo"})}),s.jsx(Ve,{className:"aspect-square",icon:Qr,onClick:p.redoDrawing,disabled:!p.canRedoDrawing,"aria-label":c.formatMessage({id:"ZUr4oh",defaultMessage:"Redo"})}),s.jsx(Ve,{className:"w-auto px-3",onClick:I,children:c.formatMessage({id:"D9xvar",defaultMessage:"Cancel"})})]}):s.jsxs(s.Fragment,{children:[s.jsx(Ve,{className:"aspect-square",icon:Xr,onClick:C,"aria-label":c.formatMessage({id:"pRGwlp",defaultMessage:"Edit image"})}),s.jsx(Ve,{className:"aspect-square",icon:Yr,onClick:H,"aria-label":c.formatMessage({id:"9DNHka",defaultMessage:"Download image"})}),s.jsx(Ve,{className:"aspect-square",icon:gt,onClick:m,"aria-label":c.formatMessage({id:"2gNXdX",defaultMessage:"Report content"})}),l&&s.jsx(Ve,{className:"aspect-square",icon:Ea,onClick:F,"aria-label":c.formatMessage({id:"rzlDpj",defaultMessage:"Delete post"})})]})})]}),s.jsxs("div",{className:"grid h-full w-full grid-rows-[1fr_auto] items-center overflow-y-auto overscroll-contain",children:[s.jsx("div",{className:"flex h-full w-full items-center justify-center px-4 pb-4",children:a&&s.jsxs("div",{className:"relative inline-block max-h-full rounded bg-neutral-100",children:[s.jsx("img",{src:a.url,alt:U,className:"h-full max-h-[70vh] w-auto max-w-full rounded object-contain",fetchPriority:"high"}),u==="inpaint"&&s.jsx(Jr,{image:a,drawingState:p,drawingCanvasRef:y})]})}),s.jsx("div",{className:"flex w-full justify-center px-4 pb-8",children:s.jsx("div",{className:"w-full max-w-[768px]",children:s.jsx(Fd,{clientThreadId:t,currentModelId:r,onRequestCompletion:n,onClose:e,activeImage:a,currentDrawnShape:p.currentDrawnShape,getImageData:D,onCancelInpaint:I})})})]})]})})})};function vc({postWithProfile:a,clientThreadId:e,onClose:n}){var t,r;return((t=a.post.attachments[0])==null?void 0:t.kind)==="media_generation"?s.jsx(ec,{postWithProfile:a,clientThreadId:e,onClose:n}):((r=a.post.attachments[0])==null?void 0:r.kind)==="message_slice"?s.jsx(sc,{postWithProfile:a,onClose:n}):null}function ec({postWithProfile:a,clientThreadId:e,onClose:n}){var S;const t=ts(),r=Sd(t,e),i=g.useRef(null),[l,m]=g.useState(!1),c=ut(),{post:b}=a,f=b.attachments[b.attachments.length-1],u={url:f.url,content_type:ia.ImageAssetPointer,asset_pointer:(S=f.asset_pointer)!=null?S:oa(f.id),width:f.width,height:f.height},T=qe(),p=Cd(),y=ce(r.serverId$),x=Ss(),_=g.useCallback(P=>p.getState().files.find(k=>k.tempId===P),[p]),C=f.url,I=g.useCallback(async P=>{if(i.current){const k=await i.current,h=k?_(k==null?void 0:k.tempId):null;if(h)return h}return i.current=fetch(P).then(k=>k.blob()).then(k=>{const h=new File([k],"image.png",{type:"image/png"}),E=yd(h);return ra.uploadFile(p,E,h,Td.Multimodal,[h.type],T,x).then(()=>{const N=_(E);return N&&N.status===Md.Ready&&N.fileId?N:null})}),i.current},[p,T,x,_]),H=ce(()=>ft(r).id),D=!pt(t),F=g.useCallback(async P=>{var k;if(!(!P.promptMessage||D))try{const h=await I(C);if(!h||!h.fileId||!h.fileSpec)return;const E=[{content_type:ia.ImageAssetPointer,asset_pointer:oa(h.fileId),size_bytes:h.fileSpec.size,width:f.width,height:f.height},...P.promptMessage.content.content_type===Ns.MultimodalText||P.promptMessage.content.content_type===Ns.Text?P.promptMessage.content.parts:[]];nl(Ie(Q({conversation:r},P),{promptMessage:Ie(Q({},P.promptMessage),{content:{content_type:Ns.MultimodalText,parts:E}}),extraStreamParams:Ie(Q({},(k=P.extraStreamParams)!=null?k:{}),{continueFromSharedPostId:b.id})})),ra.reset(p)}catch(h){Ds.addError(new Error("post_receiver_handle_request_failed",{cause:h})),x.danger({id:"postReceiverModal.editImageError",defaultMessage:"Failed to edit the image",description:"Error message for editing an image"},{toastId:"post_receiver_modal.edit_image_error"})}},[r,f.height,f.width,I,p,C,D,x,b.id]),U={id:b.id,archived:!1,transformationId:null,url:u.url,assetPointer:u.asset_pointer,thumbnail:null,width:u.width,height:u.height,title:null,conversationId:y,messageId:b.id},R=g.useCallback(()=>{n(),c("/",{replace:!0})},[n,c]);return s.jsxs(s.Fragment,{children:[s.jsx(Zd,{image:U,onClose:R,onRequestCompletion:F,clientThreadId:r.id,currentModelId:H,post:b,canDelete:!!b.permissions.can_delete,onOpenReport:()=>m(!0)}),l&&s.jsx(Xa,{post:b,onClose:()=>m(!1)})]})}function sc({postWithProfile:a,onClose:e}){const[n,t]=g.useState(!1),{post:r}=a;return s.jsxs("div",{className:"bg-token-bg-primary absolute start-0 end-0 top-0 bottom-0 h-full w-full",children:[s.jsx(tc,{post:r,setIsReportModalOpen:t,onClose:e}),s.jsx(al,{attachments:r.attachments,variant:"fullscreen"}),n&&s.jsx(Xa,{post:r,onClose:()=>t(!1)})]})}function tc({post:a,setIsReportModalOpen:e,onClose:n,additionalButtons:t}){const r=ut(),i=qe(),l=Ss(),m=g.useCallback(async()=>{if(window.confirm(i.formatMessage({id:"postReceiverModal.deletePostConfirmation",defaultMessage:"Are you sure you want to delete this post?"})))try{await ht.safeDelete("/share/post/{post_id}",{parameters:{path:{post_id:a.id}}}),r("/",{replace:!0})}catch(c){l.danger({id:"postReceiverModal.deletePostError",defaultMessage:"Failed to delete the post",description:"Error message for deleting a post"},{toastId:"post_receiver_modal.delete_post_error"})}},[a.id,i,l,r]);return s.jsx(s.Fragment,{children:s.jsxs(wd.div,Ie(Q({className:"flex h-16 w-full px-2 sm:px-4"},ol),{children:[s.jsx("div",{className:"flex items-center justify-self-start text-start",children:s.jsx(il,{onClose:()=>{n(),r("/",{replace:!0})}})}),s.jsx("div",{className:"flex w-full flex-1 flex-col items-center justify-center justify-self-stretch",children:s.jsx(rl,{areButtonsFullWidth:!0,post:a,setIsReportModalOpen:e})}),s.jsxs("div",{className:"flex items-center justify-self-end text-end",children:[a.permissions.can_delete&&s.jsx(ll,{tooltip:i.formatMessage({id:"postReceiverModal.deletePost",defaultMessage:"Delete"}),onClick:m,children:s.jsx(Ea,{})}),t]})]}))})}function Xa({post:a,onClose:e}){var m;const n=ts(),{data:t}=el(n,aa.Post),r=qe(),i=sl(n,r,a.id,aa.Post,_d.ChatGPTPost);if(t==null)return null;const l="Report ".concat((m=a.text)!=null?m:"Post");return s.jsx(tl,{reasons:t.reasons,submitReport:i,title:l,onClose:e,header:t.header,subHeader:t.header_explanation})}function nc(){var t;const a=g.useContext(Wa),e=(t=a==null?void 0:a.postWithProfile)==null?void 0:t.post,n=a==null?void 0:a.setIsReportModalOpen;return!e||!n?null:s.jsxs("div",{className:"outline-token-border-default mx-4 flex items-center justify-between gap-2.5 rounded-2xl py-1 ps-4 pe-0.5 outline-1 outline-offset-[-1px]",children:[s.jsx("span",{className:"text-token-text-secondary justify-center text-sm leading-tight",children:s.jsx(we,{id:"e2L5bY",defaultMessage:"Content created using ChatGPT"})}),s.jsx(vd,{size:"default",contentAlign:"end",sideOffset:4,triggerButton:s.jsx(Zr,{className:"rounded-full",label:"",icon:s.jsx(Id,{className:"icon-sm"})}),children:s.jsx(bd.Item,{icon:gt,onClick:()=>n(!0),children:s.jsx(we,{id:"jHHbcM",defaultMessage:"Flag content as unsafe"})})})]})}function bc(){var t;const a=g.useContext(Wa),e=(t=a==null?void 0:a.postWithProfile)==null?void 0:t.post,n=a==null?void 0:a.setIsReportModalOpen;return!e||!n?null:s.jsx("div",{className:"text-token-text-secondary text-sm",children:s.jsx(we,{id:"iRpGVT",defaultMessage:"Content created using ChatGPT. <reportButton>Report</reportButton> if unsafe.",values:{reportButton:r=>s.jsx("button",{className:"text-token-text-primary decoration-token-text-primary underline",onClick:()=>{n(!0)},children:r})}})})}const _a=ze(()=>ss(()=>import("./d3ia29s4ey7jfka4.js"),__vite__mapDeps([9,1,2,3,4,5])).then(a=>a.ThreadReportConversationModal));function Ic(a){const{prefetchNavlink:e,clearPrefetchNavlink:n,conversation:t,pageLoadSearchQuery:r}=a,i=ts(),l=ka(i),m=dl(t.id),c=cl(),b=ul(),[f,u]=ce(()=>[jd(i),Bs(i)]),[T]=gl(),{isOpen:p}=lt(),y=b.store.useContentAreaDimensions(ml.Header,I=>I!=null&&I.height?I.height:void 0);let x=null;y||(x=!l&&p?"max-sm:pb-25":"pb-25",f?x=T===hl.Chat?"pb-12":"pb-13":u&&(x="pb-0"));let _=s.jsx(ac,Q({isNewScrollEnabled:l},a));const C=pl();return C&&(_=s.jsx(fl,{clientThreadId:t.id,children:_})),_=s.jsx(xl,{clientThreadId:t.id,children:_}),s.jsxs("div",{onCopy:m,className:_e("flex flex-col text-sm",C?"pt-4":u?"thread-xl:pt-0 pt-0":"thread-xl:pt-header-height",c&&"keyboard-open:pb-[calc(var(--composer-height,100px)+var(--screen-keyboard-height,0))]",x),style:{paddingBottom:y},children:[r&&s.jsx("div",{children:s.jsx(Ed,{query:r})}),e?s.jsx(kd,{name:"prefetch-navlink",onError:I=>{Ds.addError("Error with prefetch navlink",{error:I}),n()},children:s.jsx(g.Suspense,{fallback:null,children:s.jsx(Ad,{clientThreadId:t.id,prefetchNavlink:e,clearPrefetchNavlink:n})})}):null,s.jsx(Pd,{children:_})]})}function ac({onRequestCompletion:a,conversation:e,scrollContainerRef:n,isNewScrollEnabled:t}){var N,V,d,G,z;const r=ts(),i=ce(()=>Bs(r)),[l,m,c,b,f,u]=Ee(e.id,w=>[$.getConversationTurnIds(w),w==null?void 0:w.pulseCardId,w==null?void 0:w.scrollToMessageId,w==null?void 0:w.scrollToMessageIsAssistant,$.hasUserMessage(w),$.isMessageTurnEnded(w)]),T=Pa(r),p=ce(()=>Kn(r)&&T.isCardViewOpen$()),y=ce(()=>Kn(r)&&T.isFeedbackViewOpen$()),x=ce(()=>vl(r)),{data:_}=bl(m),C=m&&!f,I=qa(),H=za(),D=Rd(),F=ce(()=>ft(e));Il({isSharedConversation:I,clientThreadId:e.id}),g.useEffect(()=>{I&&(Is(r,"chatgpt_continue_conversation_page_loaded"),De.logEvent("Continue Conversation: Page Loaded"),Is(r,"chatgpt_conversation_share_page_loaded"),De.logEvent("Share Public Chat: Shared Conversation Loaded"))},[r,I]);const[U,R]=g.useState(!1),[S,P]=g.useState(!1),k=g.useRef(null),h=_l(e.id),E=H&&!D;return s.jsxs(s.Fragment,{children:[y&&s.jsx(Sl,{}),E&&s.jsx(nc,{}),I&&s.jsxs(s.Fragment,{children:[s.jsx(Ra,{children:s.jsx("p",{className:"text-xs text-gray-500",children:s.jsx(we,{id:"threadLayout.sharedConversationCopyDisclaimer",defaultMessage:"This is a copy of a conversation between ChatGPT & Anonymous."})})}),s.jsx("div",{className:"text-token-text-primary mb-5 text-center text-xs font-semibold",children:s.jsx("button",{onPointerOver:()=>_a.prefetch(),onClick:()=>{Ha(r,_a,{clientThreadId:e.id,serverThreadId:e.sharedConversationId,isSharedConversation:!0,isStaticSharedThread:!1}),Is(r,"chatgpt_conversation_share_report_content_clicked",void 0,{location:"Static Shared Thread Page"}),De.logEvent("Share Public Chat: Report Content Clicked",{location:"Dynamic Shared Thread Page"})},children:s.jsx(we,{id:"thread.reportSharedConversation",defaultMessage:"Report conversation"})})})]}),_&&s.jsx(Cl,{imageSrc:(V=(N=_.image)==null?void 0:N.url)!=null?V:"",fallbackSrc:(G=(d=_.image)==null?void 0:d.fallback_url)!=null?G:"",title:(z=_.title)!=null?z:"",cardId:m}),l.map((w,de)=>{var X;return s.jsx(Ta.Fragment,{children:s.jsx(Jd,{isFinalTurn:de===l.length-1,turnIndex:de,conversation:e,onRequestCompletion:a,currentModelId:(X=F==null?void 0:F.id)!=null?X:null,scrollToMessageId:t||C?void 0:c,scrollToMessageIsAssistant:t||C?void 0:b,dateHeaderType:h(de)},w)},w)}),!t&&s.jsxs(s.Fragment,{children:[(n==null?void 0:n.current)&&s.jsx(la,{setIsScrolledToEdge:w=>{R(w)},options:{root:n.current,threshold:0,rootMargin:"0%"}},"threadBottomEdgeScrollObserver"),s.jsx("div",{ref:k}),p&&(n==null?void 0:n.current)&&s.jsx(la,{setIsScrolledToEdge:w=>{P(!w)},options:{root:n.current,threshold:0,rootMargin:"-30px 0px"}},"pulseCardModalEdgeScrollObserver"),p&&s.jsx(yl,{show:S&&u}),s.jsx(Tl,{show:U&&!i&&!y&&!x,className:_e("bottom-[calc(var(--composer-overlap-px)+--spacing(6))]"),onClick:()=>{var w;Is(r,"chatgpt_thread_scroll_to_bottom"),(w=k.current)==null||w.scrollIntoView({behavior:"smooth",block:"end"})}})]})]})}export{Qa as C,vc as P,bc as S,Ic as T,Xa as a,Jd as b};
//# sourceMappingURL=5uqv5sdajcdsdc3v.js.map

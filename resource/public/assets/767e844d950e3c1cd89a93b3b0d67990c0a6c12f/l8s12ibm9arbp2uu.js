var rt=Object.defineProperty,lt=Object.defineProperties;var ot=Object.getOwnPropertyDescriptors;var Re=Object.getOwnPropertySymbols;var ct=Object.prototype.hasOwnProperty,dt=Object.prototype.propertyIsEnumerable;var De=(t,e,s)=>e in t?rt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,w=(t,e)=>{for(var s in e||(e={}))ct.call(e,s)&&De(t,s,e[s]);if(Re)for(var s of Re(e))dt.call(e,s)&&De(t,s,e[s]);return t},I=(t,e)=>lt(t,ot(e));import{i as Ge,c as ye,h as ae,r as j,j as a,v as $e,d as Qe,M as Oe}from"./mw35uwhq4g8r9eam.js";import{p as ut,m as He,C as he,b as pt,P as mt,g as ht,D as gt,h as ft,R as _t,c as xt,d as we,u as yt,e as Mt,S as bt,f as vt}from"./irqezh7teqj3ew03.js";import{l as kt,d as Ct,m as St,e as jt,g as Be,i as me,v as Ze,f as Je,a as wt,h as Pt,s as Nt,c as Q,j as Se,k as Et,n as _e,o as ve,u as pe,b as ke,p as At}from"./fkrqr6nqq2852orb.js";import{g as It,c as Tt,u as fe}from"./la79eh1q1qxrfcxi.js";import{Q as Ut,_ as te,hC as se,R as Ye,dp as je,aB as Pe,D as Ne,bq as Fe,bk as Le,dz as Me,u as Ee,cF as de,rr as Ve,L as Rt,jf as Dt,w7 as Ot,J as Bt}from"./d0xa318sl7ywi0za.js";import{A as Ft,be as Lt,bi as Vt,at as Wt,z as qt,lE as zt}from"./g2euln7v5pbm31qa.js";import{i as We,P as Gt}from"./e5aqc9nw1k4ebw2k.js";import{a as be,u as Ae,E as $t,P as Qt,A as Ke}from"./ehwx8pj63nln1ugv.js";import{a as Ht,u as Zt}from"./ktjtg3fnpomr03qk.js";import{r as Jt}from"./oj9zwxa6l3kpv1x2.js";import{M as Yt}from"./i693kfbch8smq86y.js";import"./ffo9fz3385kae4ff.js";import"./bzxitjpdx1z6hpbp.js";import"./iman6sxicn70h91g.js";import"./nvot86jvh8vwigra.js";import"./l2u6v2d9vfposl4n.js";import"./e5bg4yzr7nht9sxr.js";import"./hdkg0cys1b7b4f0v.js";import"./l4v2i2dq9gwjak1q.js";import"./ia54sddtrl9qa2wj.js";import"./kbj1b07s2z6vxqkg.js";import"./hu1bt0oauegdhua6.js";import"./h1em0bjkpkjv8ykw.js";import"./gy1lpvuoewmzh42c.js";import"./h4yh1661qhhbu5v5.js";import"./iknugp00locgtve5.js";const Kt=async({intl:t,store:e,clientThreadId:s})=>{var o,d,p,g;const i=window.location.href,n=i.includes("/share/");try{const r=Ut(s),c=await It(I(w({items:e.items},n?{sharedConversationUrl:i}:{conversationId:r}),{existing_customer_session_client_secret:e.preloadCustomerSessionClientSecret}));return e.setInitialCart(c),((o=c.cart.errors)==null?void 0:o.length)>0?(te.logEventWithStatsig("product_checkout","product_checkout",I(w({},se((d=e.cartMetadata)!=null?d:{})),{action:"cart_load_failed",reason:"error_response_from_endpoint",error_message:c.cart.errors[0].message})),{error:c.cart.errors[0].message}):c.customer_session_client_secret&&c.publishable_key?(c.cart.shipping_option_id&&kt(e,c.id,c.cart.shipping_options,c.cart.shipping_option_id,"prefill"),c.cart.shipping_address&&Ct(e,c.id,I(w({},St(c.cart.shipping_address)),{complete:!0}),"prefill"),{client_secret:c.customer_session_client_secret,publishable_key:c.publishable_key}):(te.logEventWithStatsig("product_checkout","product_checkout",I(w({},se((p=e.cartMetadata)!=null?p:{})),{action:"cart_load_failed",reason:"error_response_from_endpoint",error_message:"Missing customer_session_client_secret or publishable_key"})),{error:t.formatMessage({id:"imEcZX",defaultMessage:"Failed to load cart session (1300)"})})}catch(r){return te.logEventWithStatsig("product_checkout","product_checkout",I(w({},se((g=e.cartMetadata)!=null?g:{})),{action:"cart_load_failed",reason:"error_thrown_from_endpoint",error_message:r instanceof Error?r.message:"Unknown error"})),{error:r instanceof Error?r.message:t.formatMessage({id:"S86mYy",defaultMessage:"Failed to load cart session (1301)"})}}};function Xe(){return Ge({mutationFn:({phoneNumber:t,triggeringProduct:e,verificationExpiryWindowMs:s})=>Ye.safePost("/accounts/v1/phone_registry/enroll/start",{requestBody:{phone_number:t,triggering_product:e,verification_expiry_window_ms:s}})})}function Xt(){return Ge({mutationFn:({phoneNumber:t,triggeringProduct:e,verificationCode:s})=>Ye.safePost("/accounts/v1/phone_registry/enroll/finish",{requestBody:{phone_number:t,triggering_product:e,verification_code:s}})})}function es(t){"use forget";const e=ye.c(94),{onClose:s,phoneNumber:i,triggeringProduct:n,logEvent:o,onSuccess:d,onBack:p,onCancel:g}=t,r=ae(),[c,_]=j.useState(""),[b,u]=j.useState(null),[l,M]=j.useState(null),f=Xt(),v=Xe();let m,h;e[0]!==o?(m=()=>{o("sheet_shown",{step:"finish_enrollment"})},h=[o],e[0]=o,e[1]=m,e[2]=h):(m=e[1],h=e[2]),j.useEffect(m,h);let y;e[3]!==g||e[4]!==s?(y=()=>{g(),s()},e[3]=g,e[4]=s,e[5]=y):y=e[5];const x=y;let C;e[6]!==r?(C=le=>{var Te,Ue;const ee=le,oe=typeof((Te=ee==null?void 0:ee.json)==null?void 0:Te.detail)=="string"?ee.json.detail:void 0;return(Ue=oe!=null?oe:ee==null?void 0:ee.message)!=null?Ue:r.formatMessage({id:"MbV2xj",defaultMessage:"Verification failed, please try again."})},e[6]=r,e[7]=C):C=e[7];const S=C;let T;e[8]!==c||e[9]!==f||e[10]!==o||e[11]!==s||e[12]!==d||e[13]!==i||e[14]!==S||e[15]!==n?(T=async()=>{if(o("verify_code_tapped",{step:"finish_enrollment"}),c.trim().length===6)try{u(null),await f.mutateAsync({phoneNumber:i,verificationCode:c.trim(),triggeringProduct:n}),o("verify_code_succeeded",{step:"finish_enrollment"}),s(),d()}catch(le){const oe=S(le);o("verify_code_failed",{step:"finish_enrollment",reason:oe}),u(oe)}},e[8]=c,e[9]=f,e[10]=o,e[11]=s,e[12]=d,e[13]=i,e[14]=S,e[15]=n,e[16]=T):T=e[16];const R=T;let D;e[17]!==r||e[18]!==o||e[19]!==i||e[20]!==v||e[21]!==S||e[22]!==n?(D=async()=>{o("resend_code_tapped",{step:"finish_enrollment"});try{u(null),M(null),await v.mutateAsync({phoneNumber:i,triggeringProduct:n}),o("send_code_succeeded",{step:"finish_enrollment",resend:!0}),M(r.formatMessage({id:"6ZdNIT",defaultMessage:"Code sent, please check your phone."}))}catch(le){const oe=S(le);o("send_code_failed",{step:"finish_enrollment",resend:!0,reason:oe}),u(oe)}},e[17]=r,e[18]=o,e[19]=i,e[20]=v,e[21]=S,e[22]=n,e[23]=D):D=e[23];const k=D;let E;e[24]!==p||e[25]!==s?(E=()=>{s(),p()},e[24]=p,e[25]=s,e[26]=E):E=e[26];const N=E;let P;e[27]!==r?(P=r.formatMessage({id:"Oq/uUi",defaultMessage:"Enter code"}),e[27]=r,e[28]=P):P=e[28];let A;e[29]!==P?(A=a.jsx("span",{className:"text-heading-3",children:P}),e[29]=P,e[30]=A):A=e[30];let U;e[31]!==r?(U=r.formatMessage({id:"LsrdZy",defaultMessage:"Back"}),e[31]=r,e[32]=U):U=e[32];let B;e[33]!==N||e[34]!==U?(B=a.jsx(je.Button,{color:"secondary",title:U,onClick:N}),e[33]=N,e[34]=U,e[35]=B):B=e[35];let F;e[36]!==r?(F=r.formatMessage({id:"Gjhl3C",defaultMessage:"Verify"}),e[36]=r,e[37]=F):F=e[37];let G;e[38]!==c||e[39]!==f.isPending?(G=c.trim().length!==6||f.isPending,e[38]=c,e[39]=f.isPending,e[40]=G):G=e[40];let $;e[41]!==f.isPending||e[42]!==R||e[43]!==F||e[44]!==G?($=a.jsx(je.Button,{"data-testid":"shopping-checkout-phone-verification-step-up-modal__verify",title:F,color:"primary",disabled:G,loading:f.isPending,onClick:R}),e[41]=f.isPending,e[42]=R,e[43]=F,e[44]=G,e[45]=$):$=e[45];let W;e[46]!==R?(W=le=>{le.preventDefault(),R()},e[46]=R,e[47]=W):W=e[47];let H;e[48]!==r||e[49]!==i?(H=r.formatMessage({id:"FH0uY0",defaultMessage:"Enter the 6-digit code we sent to {phoneNumber}."},{phoneNumber:i}),e[48]=r,e[49]=i,e[50]=H):H=e[50];let Z;e[51]!==H?(Z=a.jsx("p",{children:H}),e[51]=H,e[52]=Z):Z=e[52];let J;e[53]!==r?(J=r.formatMessage({id:"ImwJZd",defaultMessage:"Enter code"}),e[53]=r,e[54]=J):J=e[54];let q;e[55]!==b?(q=le=>{const ee=le.target.value.replace(/\D/g,"").slice(0,6);_(ee),b&&u(null)},e[55]=b,e[56]=q):q=e[56];let z;e[57]!==c||e[58]!==J||e[59]!==q?(z=a.jsx(Ft,{ariaLabel:!1,name:"shopping-checkout-phone-verification-code",value:c,inputMode:"numeric",maxLength:6,autoComplete:"one-time-code",placeholder:J,onChange:q}),e[57]=c,e[58]=J,e[59]=q,e[60]=z):z=e[60];let L;e[61]!==b?(L=b&&a.jsx("p",{className:"text-xs text-red-500",role:"alert",children:b}),e[61]=b,e[62]=L):L=e[62];let Y;e[63]!==r?(Y=r.formatMessage({id:"5hOqfV",defaultMessage:"Didn't get a code?"}),e[63]=r,e[64]=Y):Y=e[64];let O;e[65]!==Y?(O=a.jsx("span",{children:Y}),e[65]=Y,e[66]=O):O=e[66];let ne;e[67]!==r||e[68]!==v.isPending?(ne=v.isPending?r.formatMessage({id:"GR93Ko",defaultMessage:"Sending..."}):r.formatMessage({id:"enMU6z",defaultMessage:"Send again"}),e[67]=r,e[68]=v.isPending,e[69]=ne):ne=e[69];let ie;e[70]!==k||e[71]!==v.isPending||e[72]!==ne?(ie=a.jsx("button",{type:"button",className:"ms-1 text-blue-400",onClick:k,disabled:v.isPending,children:ne}),e[70]=k,e[71]=v.isPending,e[72]=ne,e[73]=ie):ie=e[73];let re;e[74]!==l?(re=l&&a.jsx("div",{className:"text-token-text-primary mt-1 text-xs",children:l}),e[74]=l,e[75]=re):re=e[75];let K;e[76]!==O||e[77]!==ie||e[78]!==re?(K=a.jsxs("div",{className:"text-token-text-secondary text-xs",children:[O,ie,re]}),e[76]=O,e[77]=ie,e[78]=re,e[79]=K):K=e[79];let ue;e[80]!==Z||e[81]!==z||e[82]!==L||e[83]!==K?(ue=a.jsxs("div",{className:"flex flex-col gap-3",children:[Z,z,L,K]}),e[80]=Z,e[81]=z,e[82]=L,e[83]=K,e[84]=ue):ue=e[84];let V;e[85]!==W||e[86]!==ue?(V=a.jsx("form",{onSubmit:W,className:"text-token-text-primary w-full text-sm",children:ue}),e[85]=W,e[86]=ue,e[87]=V):V=e[87];let X;return e[88]!==x||e[89]!==B||e[90]!==$||e[91]!==V||e[92]!==A?(X=a.jsx(Pe,{testId:"modal-shopping-checkout-phone-verification-step-up",isOpen:!0,type:"success",noPadding:!0,contentClassName:"flex flex-col items-start gap-6 p-6",headerClassName:"!px-6 !py-0 !h-[76px] !items-center",showCloseButton:!0,hasSeparator:!0,onClose:x,title:A,secondaryButton:B,primaryButton:$,children:V}),e[88]=x,e[89]=B,e[90]=$,e[91]=V,e[92]=A,e[93]=X):X=e[93],X}const qe=t=>t.trim().replace(/\s+/g,"").startsWith("+1");function ts(t){"use forget";const e=ye.c(63),{onClose:s,triggeringProduct:i,logEvent:n,onContinue:o,onCancel:d,onSkipVerification:p,initialPhoneNumber:g}=t,r=ae(),[c,_]=j.useState(g!=null?g:""),[b,u]=j.useState(null),l=Xe();let M,f,v,m;if(e[0]!==r||e[1]!==c){v=c.trim();let O;e[6]!==r?(O=r.formatMessage({id:"LGmH6v",defaultMessage:"Please enter a phone number with a +1 country code"}),e[6]=r,e[7]=O):O=e[7],M=O,f=We(v),m=qe(v),e[0]=r,e[1]=c,e[2]=M,e[3]=f,e[4]=v,e[5]=m}else M=e[2],f=e[3],v=e[4],m=e[5];const h=m,y=v.length>0&&f&&!h?M:null,x=b!=null?b:y;let C,S;e[8]!==n?(C=()=>{n("sheet_shown",{step:"start_enrollment"})},S=[n],e[8]=n,e[9]=C,e[10]=S):(C=e[9],S=e[10]),j.useEffect(C,S);let T;e[11]!==d||e[12]!==s?(T=()=>{d(),s()},e[11]=d,e[12]=s,e[13]=T):T=e[13];const R=T;let D;e[14]!==M||e[15]!==r||e[16]!==n||e[17]!==s||e[18]!==o||e[19]!==p||e[20]!==c||e[21]!==l||e[22]!==i?(D=async()=>{var ie,re;n("send_code_tapped",{step:"start_enrollment"});const O=c.trim();if(!We(O)){u(r.formatMessage({id:"O2638w",defaultMessage:"Please enter a valid phone number"}));return}if(!qe(O)){u(M);return}let ne;try{u(null);const K=await l.mutateAsync({phoneNumber:O,triggeringProduct:i});ne=K.sms_sent===!1,n("send_code_succeeded",{step:"start_enrollment",sms_sent:K.sms_sent})}catch(K){const V=K,X=typeof((ie=V==null?void 0:V.json)==null?void 0:ie.detail)=="string"?V.json.detail:void 0;n("send_code_failed",{step:"start_enrollment",reason:X!=null?X:V==null?void 0:V.message}),u((re=X!=null?X:V==null?void 0:V.message)!=null?re:r.formatMessage({id:"ptsFtS",defaultMessage:"We couldn't send a code. Please check your number and try again."}));return}if(s(),ne){p();return}o(O)},e[14]=M,e[15]=r,e[16]=n,e[17]=s,e[18]=o,e[19]=p,e[20]=c,e[21]=l,e[22]=i,e[23]=D):D=e[23];const k=D;let E;e[24]!==r?(E=r.formatMessage({id:"WUzqsU",defaultMessage:"Verify your phone number"}),e[24]=r,e[25]=E):E=e[25];let N;e[26]!==E?(N=a.jsx("span",{className:"text-heading-3",children:E}),e[26]=E,e[27]=N):N=e[27];let P;e[28]!==r?(P=r.formatMessage({id:"G/pZCX",defaultMessage:"Send code"}),e[28]=r,e[29]=P):P=e[29];const A=!f||!h||l.isPending;let U;e[30]!==k||e[31]!==l.isPending||e[32]!==P||e[33]!==A?(U=a.jsx(je.Button,{"data-testid":"shopping-checkout-phone-number-step-up-modal__continue",title:P,color:"primary",disabled:A,loading:l.isPending,onClick:k}),e[30]=k,e[31]=l.isPending,e[32]=P,e[33]=A,e[34]=U):U=e[34];let B;e[35]!==k?(B=O=>{O.preventDefault(),k()},e[35]=k,e[36]=B):B=e[36];let F;e[37]!==r?(F=r.formatMessage({id:"d2OOS4",defaultMessage:"We use your phone number to confirm it's really you before completing checkout."}),e[37]=r,e[38]=F):F=e[38];let G;e[39]!==F?(G=a.jsx("p",{children:F}),e[39]=F,e[40]=G):G=e[40];let $;e[41]!==r?($=r.formatMessage({id:"pQgrkU",defaultMessage:"Phone number"}),e[41]=r,e[42]=$):$=e[42];let W;e[43]!==b?(W=O=>{_(O!=null?O:""),b&&u(null)},e[43]=b,e[44]=W):W=e[44];let H;e[45]===Symbol.for("react.memo_cache_sentinel")?(H=["US"],e[45]=H):H=e[45];let Z;e[46]===Symbol.for("react.memo_cache_sentinel")?(Z={layout:"inline",showDialCodePrefix:!1,rounded:"lg",densePadding:!0,triggerShowOnlyDialCode:!0,fullWidthJustifyDialCode:!1,placeholderTextSize:"sm",dropdownPanelWidthPx:320},e[46]=Z):Z=e[46];const J=x!=null?x:void 0;let q;e[47]!==c||e[48]!==$||e[49]!==W||e[50]!==J?(q=a.jsx(Gt,{label:$,value:c,setValue:W,defaultCountry:"US",countries:H,initialValueFormat:"national",appearance:Z,error:J}),e[47]=c,e[48]=$,e[49]=W,e[50]=J,e[51]=q):q=e[51];let z;e[52]!==G||e[53]!==q?(z=a.jsxs("div",{className:"flex flex-col gap-3",children:[G,q]}),e[52]=G,e[53]=q,e[54]=z):z=e[54];let L;e[55]!==B||e[56]!==z?(L=a.jsx("form",{onSubmit:B,className:"text-token-text-primary w-full text-sm",children:z}),e[55]=B,e[56]=z,e[57]=L):L=e[57];let Y;return e[58]!==R||e[59]!==U||e[60]!==L||e[61]!==N?(Y=a.jsx(Pe,{testId:"modal-shopping-checkout-phone-number-step-up",isOpen:!0,type:"success",noPadding:!0,contentClassName:"flex flex-col items-start gap-6 p-6",headerClassName:"!px-6 !py-0 !h-[76px] !items-center",showCloseButton:!0,hasSeparator:!0,onClose:R,title:N,primaryButton:U,children:L}),e[58]=R,e[59]=U,e[60]=L,e[61]=N,e[62]=Y):Y=e[62],Y}const et=(t,e,s={},i)=>{var o,d,p;const n=w(I(w(I(w({},se((o=t.cartMetadata)!=null?o:{})),{checkout_id:t.cartId}),i?{attempt_id:i}:{}),{action:e}),s);te.logEventWithStatsig("product_checkout","product_checkout",n),Ne.addAction("shopping_checkout.".concat(e),w(w({merchant_id:(d=t.merchant)==null?void 0:d.externalId,merchant_network_id:(p=t.merchant)==null?void 0:p.networkId,cart_total:t.grandTotal.value},"reason"in s?{reason:s.reason}:{}),s))},ze="COMMERCE";class tt extends Error{constructor(e="Phone verification cancelled"){super(e),this.name="PhoneStepUpCancelledError"}}async function ss(t,e,s){const i=(n,o={})=>et(e,n,o,s);return await new Promise((n,o)=>{let d=!1;const p=_=>{d||(d=!0,_())},g=_=>{i("flow_cancelled",_?{step:_}:void 0),p(()=>o(new tt))},r=_=>{Fe(t,ts,{triggeringProduct:ze,logEvent:i,onContinue:b=>{c(b)},onCancel:()=>g("start_enrollment"),onSkipVerification:()=>{p(()=>n())},initialPhoneNumber:_})},c=_=>{Fe(t,es,{phoneNumber:_,triggeringProduct:ze,logEvent:i,onBack:()=>{r(_)},onCancel:()=>g("finish_enrollment"),onSuccess:()=>{p(()=>n())}})};r()})}async function st({store:t,merchant:e,elements:s,stripe:i,ctx:n,userEmail:o,intl:d,finalShippingAddress:p,expressPaymentType:g,paymentAttemptId:r,onConfirm:c,onComplete:_}){var u,l,M,f,v;const b=performance.now();t.setCartStatus("submitting"),r||(r=$e());try{if(as({store:t,merchant:e,finalShippingAddress:p,expressPaymentType:g,paymentAttemptId:r}),!ns({elements:s,stripe:i,userEmail:o,intl:d,store:t,paymentAttemptId:r}))return;const m=g!==void 0;let h=null;if(t.cachedPaymentDetailsResponse&&!m)h=t.cachedPaymentDetailsResponse;else if(h=await ut({stripe:Le(i),elements:Le(s),intl:d,billingName:(M=(l=p==null?void 0:p.name)!=null?l:(u=t.billingAddress)==null?void 0:u.name)!=null?M:"",billingEmail:o!=null?o:"",isExpressCheckout:m}),h!=null&&h.isError)return ce(I(w({},h),{store:t,paymentAttemptId:r}));if(h)m||t.setCachedPaymentDetailsResponse(h);else return;c==null||c(),await at({store:t,paymentMethod:h,intl:d,onComplete:_,paymentAttemptId:r,finalShippingAddress:p,startMs:b,expressPaymentType:g,ctx:n})}catch(m){const h=m;let y="payment_failed_general_error";const{stripe_error_code:x,stripe_decline_code:C}=((f=h==null?void 0:h.json)==null?void 0:f.detail)||{};let S=x&&C?await i.localizeError({code:x,decline_code:C}):void 0;h.message==="Failed to fetch"&&!S&&(y="payment_failed_network_error",S=d.formatMessage({id:"DPyhFG",defaultMessage:"Failed to submit payment (1347). Please refresh the page and try again."})),ce({store:t,action:"payment_failed",reason:y,uiMessage:(v=S!=null?S:h.message)!=null?v:d.formatMessage({id:"nyG5lS",defaultMessage:"Failed to submit payment (1350)"}),internalMessage:(x!=null?x:C)?"Stripe error code: ".concat(x,"  ::  Stripe decline code: ").concat(C):h.message,paymentAttemptId:r})}finally{t.setCartStatus("idle")}}function as({store:t,merchant:e,finalShippingAddress:s,expressPaymentType:i,paymentAttemptId:n}){var d,p,g,r,c,_,b,u;const o=t.shippingOptions.find(l=>l.id===t.shippingMethodId);xe(t,{merchant_name:e==null?void 0:e.title,merchant_url:e==null?void 0:e.url,totals:t.totals,total_price:t.grandTotal.value,shipping_city:(p=s==null?void 0:s.city)!=null?p:(d=t.shippingAddress)==null?void 0:d.city,shipping_state:(r=s==null?void 0:s.state)!=null?r:(g=t.shippingAddress)==null?void 0:g.state,shipping_zip:(_=s==null?void 0:s.postal_code)!=null?_:(c=t.shippingAddress)==null?void 0:c.postalCode,shipping_country:(u=s==null?void 0:s.country)!=null?u:(b=t.shippingAddress)==null?void 0:b.country,payment_method:nt(t,i),shipping_method_name:o==null?void 0:o.title,shipping_method_price:o==null?void 0:o.subtotal,shipping_method_index:t.shippingOptions.findIndex(l=>l.id===t.shippingMethodId),items:t.items.map(l=>({product_id:l.id,product_title:"title"in l?l.title:void 0,variant:"variant"in l?l.variant:void 0,quantity:l.quantity,price:"price"in l?l.price:void 0})),action:"pay_button_clicked",attempt_id:n})}function ns({elements:t,stripe:e,userEmail:s,intl:i,store:n,paymentAttemptId:o}){return!t||!e?(ce({store:n,action:"payment_failed",reason:"elements_or_stripe_null",uiMessage:i.formatMessage({id:"/MYGq8",defaultMessage:"Failed to submit payment (1340)"}),internalMessage:"elements or stripe is null",paymentAttemptId:o}),!1):s?!0:(ce({store:n,action:"payment_failed",reason:"user_email_empty",uiMessage:i.formatMessage({id:"Zs2vbs",defaultMessage:"Failed to submit payment (1346)"}),internalMessage:"userEmail is empty",paymentAttemptId:o}),!1)}async function at({store:t,paymentMethod:e,intl:s,onComplete:i,paymentAttemptId:n,finalShippingAddress:o,startMs:d,expressPaymentType:p,ctx:g,allowStepUpRetry:r=!0}){var b,u,l,M,f,v,m,h;const c=(b=e.billing_details)!=null&&b.address?He(e.billing_details.name,e.billing_details.address,e.billing_details.phone):t.billingAddress?jt(t.billingAddress):null;if(!e.id||!e.type||!c){ce({store:t,action:"payment_failed",reason:"missing_payment_method_or_billing_address",uiMessage:s.formatMessage({id:"xYuTJ8",defaultMessage:"Failed to submit payment (1344)"}),internalMessage:"Missing payment method or billing address",extraLogData:{error_message:"Missing payment method: ".concat(e.id," with type: ").concat(e.type)},paymentAttemptId:n});return}const _=await Tt(t.cartId,t.items,{id:e.id,type:e.type,billing_address:c},n,o);if(_.step_up_action==="PhoneNumberVerification"){if(!r){ce({store:t,action:"payment_failed",reason:"phone_step_up_retry_failed",uiMessage:s.formatMessage({id:"bKp2EC",defaultMessage:"We couldn't verify your phone number. Please try again."}),internalMessage:"Step up requested more than once for the same checkout attempt",paymentAttemptId:n});return}try{await ss(g,t,n)}catch(y){if(y instanceof tt){ce({store:t,action:"payment_failed",reason:"phone_step_up_cancelled",uiMessage:s.formatMessage({id:"ETPsrm",defaultMessage:"Phone verification is required to complete checkout."}),internalMessage:"User cancelled phone verification flow",paymentAttemptId:n});return}throw y}await at({store:t,paymentMethod:e,intl:s,onComplete:i,paymentAttemptId:n,finalShippingAddress:o,startMs:d,expressPaymentType:p,ctx:g,allowStepUpRetry:!1});return}if(et(t,"flow_bypassed",{},n),_.cart!=null){if((u=_.cart.errors)!=null&&u.length){t.setErrors(_.cart.errors),xe(t,{action:"payment_failed",reason:"openai_complete_shopping_cart_failed",error_message:_.cart.errors.map(y=>y.message).join(", "),attempt_id:n});return}if((l=_.order)!=null&&l.id&&((M=_.order)==null?void 0:M.status)==="placed")try{xe(t,{action:"payment_succeeded",attempt_id:n}),Ne.addAction("shopping_checkout.complete",{durationMs:performance.now()-d,merchant_id:(f=t.merchant)==null?void 0:f.externalId,merchant_network_id:(v=t.merchant)==null?void 0:v.networkId,cart_total:t.grandTotal.value,payment_method:nt(t,p)}),typeof i=="function"&&await i(_.order),t.closeCheckout()}catch(y){ce({store:t,action:"refresh_convo_failed",uiMessage:s.formatMessage({id:"d45UJa",defaultMessage:"Failed to update conversation (1400)"}),internalMessage:y instanceof Error?y.message:"Unknown error",paymentAttemptId:n})}else ce({store:t,action:"payment_failed",reason:"openai_complete_shopping_cart_failed",uiMessage:s.formatMessage({id:"QJ9CZQ",defaultMessage:"Failed to create order (1345)"}),internalMessage:"Missing orderID",extraLogData:{error_message:"Missing orderID: ".concat((m=_.order)==null?void 0:m.id," with status: ").concat((h=_.order)==null?void 0:h.status)},paymentAttemptId:n})}}function xe(t,e){var s,i,n;te.logEventWithStatsig("product_checkout","product_checkout",w(I(w({},se((s=t.cartMetadata)!=null?s:{})),{checkout_id:t.cartId}),e)),Ne.addAction("shopping_checkout.".concat(e.action),{merchant_id:(i=t.merchant)==null?void 0:i.externalId,merchant_network_id:(n=t.merchant)==null?void 0:n.networkId,cart_total:t.grandTotal.value,reason:e.reason})}function ce({store:t,action:e,reason:s,uiMessage:i,internalMessage:n,extraLogData:o,paymentAttemptId:d}){const p=i+"";t.setErrors([{group:"general",message:p}]),xe(t,w(w(w(w({action:e},s?{reason:s}:{}),n?{error_message:n}:{}),o!=null?o:{}),(e==="payment_failed"||e==="payment_succeeded")&&d?{attempt_id:d}:{}))}function nt(t,e){var s,i,n;return(n=e==null?void 0:e.toLocaleLowerCase())!=null?n:(i=(s=t.paymentDetails)==null?void 0:s.label)==null?void 0:i.toLocaleLowerCase()}const it=({store:t,optionOverrides:e,onConfirm:s,onReady:i,onComplete:n,surface:o})=>{var v;const d=be(),p=Ae(),g=Me(),r=g==null?void 0:g.email,c=ae(),_=Qe(),b=Ee(),u=j.useRef(void 0),l=j.useRef(void 0),M=t.items,f=j.useMemo(()=>{var h,y,x,C,S,T;const m={buttonHeight:40,shippingAddressRequired:!0,billingAddressRequired:!0,allowedShippingCountries:t.allowedCountries,business:{name:(y=(h=t.merchant)==null?void 0:h.title)!=null?y:""},phoneNumberRequired:!0,paymentMethods:{applePay:(x=t==null?void 0:t.paymentTypes[o])!=null&&x.includes("apple_pay")?"always":"never",googlePay:(C=t==null?void 0:t.paymentTypes[o])!=null&&C.includes("google_pay")?"always":"never",shopPay:(S=t==null?void 0:t.paymentTypes[o])!=null&&S.includes("shop_pay")?"auto":"never",link:(T=t==null?void 0:t.paymentTypes[o])!=null&&T.includes("link")?"auto":"never"},paymentMethodOrder:["apple_pay","google_pay","shop_pay","link"],shippingRates:Be(M,t.shippingOptions,c)};return w(w({},m),e)},[(v=t.merchant)==null?void 0:v.title,t.allowedCountries,e,o,t.paymentTypes,t.shippingOptions,c,M]);return a.jsx($t,{options:f,onConfirm:async m=>{var y,x,C;const h=(y=m.shippingAddress)!=null&&y.address&&((x=m.shippingAddress)!=null&&x.name)?He(m.shippingAddress.name,m.shippingAddress.address,(C=m.billingDetails)==null?void 0:C.phone):void 0;await st({store:t,merchant:t.merchant,elements:d,stripe:p,ctx:b,userEmail:r,intl:c,finalShippingAddress:h,expressPaymentType:m.expressPaymentType,paymentAttemptId:u.current,onConfirm:s,onComplete:async S=>{await Je({store:t,order:S,navigate:_}),await(n==null?void 0:n(S))}})},onReady:()=>{i==null||i()},onClick:m=>{var C;const{expressPaymentType:h,resolve:y,reject:x}=m;if(l.current=t.shippingAddress,u.current=$e(),te.logEventWithStatsig("product_checkout","product_checkout",I(w({},se((C=t.cartMetadata)!=null?C:{})),{payment_method:h,checkout_id:t.cartId,action:"express_checkout_button_clicked",attempt_id:u.current})),Ze(t,c))return y();x()},onShippingAddressChange:async function({address:m,resolve:h,reject:y}){try{const x=await fe(t.cartId,{items:M,shippingAddress:{name:null,addressLine1:null,addressLine2:null,city:m.city,state:m.state,postalCode:m.postal_code,country:m.country,complete:!0}});t.updateCart(x);const C=Be(M,x.cart.shipping_options,c);if(C.length===0){y();return}d&&d.update({amount:x.cart.grand_total.value_minor}),h({shippingRates:C})}catch(x){y()}},onCancel:async()=>{try{if(me(t,l.current)){const m=await fe(t.cartId,{items:M,shippingAddress:l.current});t.updateCart(m),d&&d.update({amount:m.cart.grand_total.value_minor})}}catch(m){}},onShippingRateChange:async function({shippingRate:m,resolve:h,reject:y}){try{const x=await fe(t.cartId,{items:M,shippingMethodId:m.id});t.updateCart(x),d&&d.update({amount:x.cart.grand_total.value_minor}),h()}catch(x){y()}}})},ge=({cartErrors:t,section:e})=>{var i;const s=(i=t==null?void 0:t.filter(n=>e?n.group===e:!0))!=null?i:[];return s.length?a.jsx("div",{className:"flex flex-col gap-1 pt-3",children:s.map(n=>{var o;return a.jsx(he,{message:n.message,level:(o=n.level)!=null?o:"error"},n.message)})}):null};let Ce=0;function is({store:t,pushPane:e,loadingCartSession:s,loadingPayment:i,loadingAddress:n,cartLoadError:o,stripeLoadingError:d,merchant:p,footerMessage:g,isCurrentPane:r}){var W,H,Z,J,q,z;const c=Me(),_=c==null?void 0:c.email,{cartStatus:b,paymentDetails:u,shippingAddress:l,shippingMethodId:M,shippingOptions:f,totals:v,grandTotal:m,errors:h,headerMessage:y}=t,x=wt(t.items),C=j.useMemo(()=>f.find(L=>L.id===M),[f,M]),S=!!(u!=null&&u.complete),T=!!(l!=null&&l.complete),R=(s||i||n)&&!o,D=!R,k=D&&!x,E=b==="complete",N=b==="updating",P=D&&(S||i||n),A=!!(T&&f.length>0&&C),U=!!g&&!R,B=ae(),F=j.useCallback(()=>{if(!Pt(t.agreements))return Nt(t,B),!1;e("paymentMethod")},[e]),G=j.useCallback(()=>{e("shippingAddress")},[e]),$=j.useCallback(()=>{e("shippingMethod")},[e]);return a.jsxs("div",{className:"relative flex h-full flex-col",children:[E&&a.jsx("div",{className:"bg-token-bg-primary absolute inset-0 z-50 flex items-center justify-center",children:a.jsx(pt,{className:"h-44 w-44 text-green-400",loop:!1})}),a.jsxs("div",{className:"flex flex-col px-6 pb-6",children:[a.jsx("div",{className:"mb-4",children:a.jsx(ls,{item:t.items[0],store:t,canUpdateQuantity:k,isLoading:s&&!o})}),d&&a.jsx(he,{message:d}),o&&a.jsx(he,{message:o}),y&&a.jsx(he,{message:y,level:"info"}),D&&a.jsxs(a.Fragment,{children:[P&&a.jsxs("div",{className:de(t.cartStatus==="submitting"&&"pointer-events-none opacity-50"),children:[a.jsxs("div",{className:"border-token-border-light border-t",children:[a.jsx(mt,{onClick:F,isComplete:(W=u==null?void 0:u.complete)!=null?W:!1,label:(H=u==null?void 0:u.label)!=null?H:"",sublabel:(Z=u==null?void 0:u.sublabel)!=null?Z:"",icon:(J=u==null?void 0:u.icon)!=null?J:void 0,isLoading:i}),a.jsx(ge,{cartErrors:h,section:"payment_method"})]}),a.jsxs("div",{className:"border-token-border-light border-t",children:[a.jsx(ht,{name:l==null?void 0:l.name,addressLine1:l==null?void 0:l.addressLine1,addressLine2:l==null?void 0:l.addressLine2,city:l==null?void 0:l.city,state:(q=l==null?void 0:l.state)!=null?q:void 0,isComplete:(z=l==null?void 0:l.complete)!=null?z:!1,isLoading:n,onClick:G}),a.jsx(ge,{cartErrors:h,section:"shipping_address"})]}),x&&a.jsx("div",{className:"border-token-border-light border-t",children:a.jsx(gt,{emailAddress:_})}),A&&C&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"border-token-border-light border-t",children:a.jsx(ft,{method:C,onClick:$})}),a.jsx(ge,{cartErrors:h,section:"shipping_option"})]})]}),a.jsx(ds,{totals:v,grandTotal:m,isLoading:N}),a.jsx(us,{store:t}),!o&&a.jsx(ge,{cartErrors:h,section:P?"general":void 0}),!o&&!s&&a.jsx(rs,{store:t,merchant:p,hasValidPaymentMethod:S,isCurrentPane:r,pushPane:e})]})]}),U&&a.jsx(Ie,{className:"bg-token-bg-elevated-secondary text-token-text-tertiary border-token-border-light h-full border-t p-6 text-xs",components:{a:L=>a.jsx("a",I(w({},L),{className:de(L.className,"text-blue-400 underline"),target:"_blank",children:L.children}))},children:g})]})}const rs=t=>{"use forget";var R,D;const e=ye.c(28),{store:s,merchant:i,hasValidPaymentMethod:n,isCurrentPane:o,pushPane:d}=t,p=ae(),g=Ae(),r=be(),c=Qe(),_=(R=Me())==null?void 0:R.email,b=Ee(),[u,l]=j.useState(!1);let M,f;e[0]!==n?(M=()=>{n&&l(!1)},f=[n],e[0]=n,e[1]=M,e[2]=f):(M=e[1],f=e[2]),j.useEffect(M,f);let v;e[3]!==s?(v=Ht(s),e[3]=s,e[4]=v):v=e[4];const m=!v,h=s.cartStatus==="submitting",y=s.cartStatus==="updating",x=(D=i==null?void 0:i.title)!=null?D:"";let C;e[5]!==o||e[6]!==s?(C=o&&a.jsx(it,{store:s,surface:"payment_sheet",onReady:()=>l(!0)}),e[5]=o,e[6]=s,e[7]=C):C=e[7];let S;e[8]!==b||e[9]!==r||e[10]!==p||e[11]!==i||e[12]!==c||e[13]!==s||e[14]!==g||e[15]!==_?(S=async()=>{Ze(s,p)&&await st({store:s,merchant:i,elements:r,stripe:g,ctx:b,userEmail:_,intl:p,onComplete:async k=>await Je({store:s,order:k,navigate:c})})},e[8]=b,e[9]=r,e[10]=p,e[11]=i,e[12]=c,e[13]=s,e[14]=g,e[15]=_,e[16]=S):S=e[16];let T;return e[17]!==u||e[18]!==n||e[19]!==d||e[20]!==s.paymentSheetButtonCta||e[21]!==m||e[22]!==h||e[23]!==y||e[24]!==x||e[25]!==C||e[26]!==S?(T=a.jsx(xt,{isDisabled:m,isSubmitting:h,isUpdating:y,merchantTitle:x,hasValidPaymentMethod:n,expressCheckoutElement:C,expressCheckoutElementReady:u,paymentSheetButtonCta:s.paymentSheetButtonCta,onClickPay:S,pushPane:d}),e[17]=u,e[18]=n,e[19]=d,e[20]=s.paymentSheetButtonCta,e[21]=m,e[22]=h,e[23]=y,e[24]=x,e[25]=C,e[26]=S,e[27]=T):T=e[27],T},ls=({item:t,store:e,canUpdateQuantity:s,isLoading:i})=>a.jsxs("div",{className:"flex gap-4",children:[a.jsx("div",{className:"bg-token-bg-tertiary dark:bg-token-main-surface-primary-inverse overflow-clip rounded-lg",children:i?a.jsx("div",{className:"relative m-0 aspect-square h-32 w-32",children:a.jsx("div",{className:"absolute inset-0 z-3 w-full overflow-hidden",children:a.jsx("div",{className:"absolute start-[-150%] top-[-150%] h-[400%] w-[400%]",children:a.jsx("div",{className:"diagonal-sweep-gradient h-full w-full"})})})}):a.jsx("img",{className:"m-0 aspect-square h-32 w-32 object-cover mix-blend-darken",src:t.imageUrl,alt:t.title})}),a.jsxs("div",{className:"flex flex-1 flex-col",children:[a.jsx("div",{className:"text-normal line-clamp-2 min-h-6 leading-snug font-medium",title:t.title,children:i?a.jsx(Ve,{index:1,width:80,heightSize:"sm"}):t.title}),a.jsx("div",{className:"text-token-text-secondary h-[18px] text-[13px]",children:i?a.jsx(Ve,{index:2,width:60,heightSize:"sm"}):t.variant}),a.jsx("div",{className:"mt-2 flex flex-1 items-end",children:s&&!i&&a.jsx(cs,{quantity:t.quantity,store:e,itemId:t.id,isDisabled:e.cartStatus==="submitting"||e.cartStatus==="updating"})})]})]}),os=600,cs=({quantity:t,store:e,itemId:s,isDisabled:i})=>{const n=ae(),o=j.useRef(e);j.useEffect(()=>{o.current=e},[e]);const d=j.useCallback(Rt(async(g,r)=>{var b,u,l,M,f,v,m;const c=o.current;if(!c)return;const _=++Ce;c.setCartStatus("updating"),c.setErrors([]);try{const h=await fe(g,{items:r,shippingMethodId:c.shippingMethodId,shippingAddress:c.shippingAddress});if(_===Ce){c.updateCart(h);const y=(f=(M=(u=(b=h.cart.line_items)==null?void 0:b[0])==null?void 0:u.item.quantity)!=null?M:(l=r[0])==null?void 0:l.quantity)!=null?f:0;te.logEventWithStatsig("product_checkout","product_checkout",I(w({},se((v=c.cartMetadata)!=null?v:{})),{checkout_id:c.cartId,product_id:s,action:"quantity_changed",new_quantity:y.toString()}))}}catch(h){_===Ce&&(c.setErrors([{group:"general",message:n.formatMessage(Q.cartUpdateQuantityErrorMessage)}]),te.logEventWithStatsig("product_checkout","product_checkout",I(w({},se((m=c.cartMetadata)!=null?m:{})),{action:"cart_update_failed",reason:"error_response_from_endpoint",error_message:h})),c.setCartStatus("idle"))}},os),[]),p="bg-token-bg-tertiary hover:bg-token-bg-secondary text-token-text-primary flex items-center justify-center px-2 py-2 text-xl font-bold";return a.jsxs("div",{className:de("inline-flex items-center select-none",i&&"pointer-events-none opacity-50"),children:[a.jsx("button",{className:de(p,"rounded-s-xl"),onClick:()=>{if(t===1){confirm(n.formatMessage({id:"XvhtH9",defaultMessage:"Are you sure you want to remove this item?"}))&&Se(e,"deleted_item");return}const g=e.updateQuantity(s,Math.max(t-1,1));d(e.cartId,g)},children:t===1?a.jsx(Lt,{className:"icon"}):a.jsx(Vt,{className:"icon"})}),a.jsx("span",{className:"bg-token-bg-tertiary text-token-text-primary flex h-9 w-6 items-center justify-center text-sm font-semibold",children:t}),a.jsx("button",{className:de(p,"rounded-e-xl"),onClick:()=>{const g=e.updateQuantity(s,t+1);d(e.cartId,g)},children:a.jsx(Wt,{className:"icon"})})]})},ds=({totals:t,grandTotal:e,isLoading:s})=>e!=null&&e.value?a.jsxs("div",{className:"flex flex-col gap-3 pt-3",children:[a.jsx("div",{children:t==null?void 0:t.map(i=>a.jsxs("div",{className:"text-token-text-secondary flex items-end justify-between text-[13px]",children:[a.jsx("span",{className:"font-medium",children:i.title}),a.jsx(Ie,{className:de("transition-opacity duration-200",s&&"opacity-50"),remarkPlugins:[[Jt,{singleTilde:!1}]],children:i.formatted_value})]},i.title))}),a.jsxs("div",{className:"flex items-end justify-between",children:[a.jsxs("div",{className:"flex flex-col text-[13px]",children:[a.jsx("span",{className:"font-medium",children:e.title}),a.jsx("span",{className:"text-token-text-secondary",children:e.subtitle})]}),a.jsx("div",{className:"text-xl font-medium",children:e.value_minor>0?a.jsx(_t,{text:e.formatted_value,className:de("transition-opacity duration-200",s&&"opacity-50")}):"-"})]})]}):null,us=t=>{"use forget";const e=ye.c(2),{store:s}=t;let i;return e[0]!==s?(i=s.agreements&&s.agreements.length>0&&a.jsx("div",{className:"flex flex-col gap-2 pt-3",children:s.agreements.map(n=>a.jsx(ps,{store:s,agreement:n},n.id))}),e[0]=s,e[1]=i):i=e[1],i},ps=({agreement:t,store:e})=>{"use no forget";return j.useEffect(()=>{var s;te.logEventWithStatsig("product_checkout","product_checkout",I(w({},se((s=e.cartMetadata)!=null?s:{})),{checkout_id:e.cartId,action:"agreement_shown",agreement_id:t.id}))},[]),a.jsx(qt,{id:t.id,checked:t.is_checked,onChange:s=>{var n;const i=s.currentTarget.checked;e.setHasAcceptedAgreement(t.id,i),te.logEventWithStatsig("product_checkout","product_checkout",I(w({},se((n=e.cartMetadata)!=null?n:{})),{checkout_id:e.cartId,action:"agreement_clicked",agreement_id:t.id,checked:i}))},labelClassName:"ps-3 text-[13px] font-medium select-none text-token",label:a.jsx(Ie,{components:{a:s=>a.jsx("a",I(w({},s),{className:de(s.className,"text-blue-400 underline"),target:"_blank",children:s.children}))},children:t.content+(t.is_required?" *":"")})},t.id)},Ie=j.memo(Yt),ms=10*1e3,hs=({store:t,pushPane:e,resetPanes:s,setLoadingPayment:i,loadingAddress:n,setStripeLoadingError:o,isCurrentPane:d})=>{var T,R,D;const p=ae(),g=Me(),r=g==null?void 0:g.email,c=be(),_=Ae(),[b,u]=j.useState(null),[l,M]=j.useState(!1),[f,v]=j.useState((T=t.paymentDetails)!=null&&T.complete?t.paymentDetails:null),[m,h]=j.useState(void 0),y=j.useRef(!0),x=j.useRef(!0),C=()=>{y.current=!1,o(p.formatMessage(Q.stripeLoadingPaymentMethodError)),i(!1)};j.useEffect(()=>{const k=setTimeout(()=>{y.current&&C()},ms);return()=>clearTimeout(k)},[]);const S=async k=>{var E,N,P,A,U,B;if(u(null),y.current){if(y.current=!1,(E=t.paymentDetails)!=null&&E.complete&&((N=t.billingAddress)!=null&&N.complete)&&t.cachedPaymentDetailsResponse){ve(t,(P=t.paymentDetails)==null?void 0:P.label,"prefill"),i(!1);return}if(k.complete&&((A=k.value.payment_method)!=null&&A.id)){t.setPaymentDetails(I(w({},ke(k)),{complete:!0})),t.setCachedPaymentDetailsResponse({id:k.value.payment_method.id,type:k.value.payment_method.type,billing_details:{address:k.value.payment_method.billing_details.address,name:(U=k.value.payment_method.billing_details.name)!=null?U:""}});const F=I(w({},_e(k.value.payment_method.billing_details.address,k.value.payment_method.billing_details.name,k.value.payment_method.billing_details.phone)),{complete:!0});t.setBillingAddress(F),v(I(w({},ke(k)),{complete:k.complete})),!n&&t.isShippingAddressSameAsBilling&&F.addressLine1&&!me(t,t.shippingAddress)&&await pe({store:t,fields:{items:t.items,shippingAddress:F},errorMessage:p.formatMessage(Q.cartUpdateShippingAddressErrorMessage),source:"prefill"}),ve(t,(B=k.preview)==null?void 0:B.label,"prefill")}i(!1);return}k.complete&&v(I(w({},ke(k)),{complete:!0}))};return a.jsxs("div",{className:"flex w-full flex-col gap-4 px-6 pb-6",children:[d&&((R=t.paymentDetails)==null?void 0:R.complete)&&a.jsx("div",{className:"min-h-10",children:a.jsx(it,{store:t,surface:"payment_sheet",optionOverrides:{layout:{maxRows:1,overflow:"auto"}},onConfirm:()=>{t.setPaymentDetails(void 0),t.setShippingAddress(void 0),s()}})}),!t.paymentTypes.payment_sheet.includes("card")&&!((D=t.paymentDetails)!=null&&D.complete)&&a.jsx("div",{className:"text-token-text-tertiary py-10 text-center text-sm",children:a.jsx(Oe,{id:"7t8tjX",defaultMessage:"No other payment methods available"})}),a.jsxs("div",{className:t.paymentTypes.payment_sheet.includes("card")?"":"hidden",children:[a.jsx(Qt,{id:"payment-element",options:{fields:{billingDetails:{email:"never",phone:"never"}},wallets:{applePay:"never",googlePay:"never"},defaultValues:{billingDetails:{email:r}},business:{name:"OpenAI"},layout:{type:"accordion",defaultCollapsed:!1}},onLoadError:()=>{y.current&&C()},onChange:S,onSavedPaymentMethodRemove:k=>{var E,N,P,A;((E=t.paymentDetails)==null?void 0:E.paymentMethodId)===((N=k.payment_method)==null?void 0:N.id)&&(t.setPaymentDetails(void 0),v(null)),Et(t,(A=(P=k.payment_method)==null?void 0:P.type)!=null?A:"")}}),b&&a.jsx("div",{className:"mt-2",children:a.jsx(he,{message:b})}),a.jsx("div",{className:"mt-6 mb-2 text-sm font-medium",children:a.jsx(Oe,{id:"8pb7do",defaultMessage:"Billing address"})}),a.jsx(Ke,{options:{mode:"billing",allowedCountries:t.allowedCountries,fields:{phone:"always"},validation:{phone:{required:"always"}}},onChange:k=>{if(u(null),x.current){x.current=!1;return}h(I(w({},_e(k.value.address,k.value.name,k.value.phone)),{complete:!0}))}})]}),a.jsx(we,{isSaving:l,isDisabled:l,onClick:async()=>{var k;if(u(null),!c){u(p.formatMessage(Q.cartUpdateGeneralErrorRetryMessage));return}try{if(!f){u(p.formatMessage(Q.cartUpdateGeneralErrorMessage));return}if(!(m!=null&&m.name)){u(p.formatMessage(Q.stripeLoadingBillingAddressError));return}M(!0);const{error:E,paymentMethod:N}=await _.preparePaymentMethod({elements:c,params:{allow_redisplay:"always",billing_details:{name:m.name,email:r}}});if(M(!1),E){const{code:P,decline_code:A}=E||{},U=P&&A?await _.localizeError({code:P,decline_code:A}):E.message;u(U);return}ve(t,f==null?void 0:f.label,"user"),t.setPaymentDetails(I(w({},f),{complete:!0,paymentMethodId:N==null?void 0:N.id,paymentMethodType:N==null?void 0:N.type,label:f==null?void 0:f.label,sublabel:f==null?void 0:f.sublabel})),t.setBillingAddress(m),t.setCachedPaymentDetailsResponse(N)}catch(E){u(p.formatMessage(Q.cartUpdateGeneralErrorMessage)),M(!1);return}t.isShippingAddressSameAsBilling&&pe({store:t,fields:{items:t.items,shippingAddress:m},errorMessage:p.formatMessage(Q.cartUpdateShippingAddressErrorMessage),source:"prefill"}),(k=t.shippingAddress)!=null&&k.addressLine1?s():e("shippingAddress")}})]})},gs=10*1e3;function fs({store:t,resetPanes:e,setLoadingAddress:s,loadingPayment:i,setStripeLoadingError:n,isCurrentPane:o}){var b,u;const d=ae(),p=j.useRef(!0),g=be(),r=j.useRef(!1);j.useEffect(()=>{me(t,t.shippingAddress)&&pe({store:t,fields:{items:t.items,shippingAddress:t.shippingAddress},errorMessage:d.formatMessage(Q.cartUpdateShippingAddressErrorMessage),source:"prefill",skipLogging:!0});const l=setTimeout(()=>{p.current&&(p.current=!1,n(d.formatMessage(Q.stripeLoadingShippingAddressError)),s(!1))},gs);return()=>clearTimeout(l)},[]);const c=async l=>{var M;if(p.current){if(p.current=!1,me(t,t.shippingAddress)){s(!1);return}l.complete&&((M=l.value.address)!=null&&M.line1)?await pe({store:t,fields:{items:t.items,shippingAddress:I(w({},_e(l.value.address,l.value.name,l.value.phone)),{complete:l.complete})},errorMessage:d.formatMessage(Q.cartUpdateShippingAddressErrorMessage),onLocalMutationComplete:()=>{s(!1)},source:"prefill"}):!i&&me(t,t.billingAddress)&&(t.setIsShippingAddressSameAsBilling(!0),await pe({store:t,fields:{items:t.items,shippingAddress:t.billingAddress},errorMessage:d.formatMessage(Q.cartUpdateShippingAddressErrorMessage),onLocalMutationComplete:()=>{s(!1)},source:"prefill"})),s(!1);return}o&&(r.current=!0),t.setIsShippingAddressSameAsBilling(l.syncAddress)},_=(b=t.additionalFields)==null?void 0:b.includes("shipping_address_phone_number");return a.jsxs("div",{className:"flex h-full flex-col gap-4 px-6 pb-6",children:[a.jsx(Ke,{id:"address-element",options:{mode:"shipping",allowedCountries:t.allowedCountries,defaultValues:(u=t.shippingAddress)!=null&&u.complete?At(t.shippingAddress,_):void 0,fields:{phone:_?"always":"never"},validation:w({},_&&{phone:{required:"always"}})},onChange:c,onLoadError:()=>{p.current&&(p.current=!1,n(d.formatMessage(Q.stripeLoadingShippingAddressError)),s(!1))}}),a.jsx(we,{onClick:async()=>{var M;const l=await((M=g==null?void 0:g.getElement("address",{mode:"shipping"}))==null?void 0:M.getValue());if(l!=null&&l.complete){if(r.current){const f=I(w({},_e(l.value.address,l.value.name,l.value.phone)),{complete:l.complete});pe({store:t,fields:{items:t.items,shippingAddress:f},errorMessage:d.formatMessage(Q.cartUpdateShippingAddressErrorMessage),source:"user"})}e()}}})]})}function _s({shippingMethods:t,resetPanes:e,store:s}){const i=ae(),[n,o]=j.useState(s.shippingMethodId);return a.jsxs("div",{className:"flex h-full flex-col gap-4 px-6 pb-6",children:[a.jsx("div",{className:"divide-token-border-light -mt-4 flex flex-col gap-2 divide-y",children:t.map(d=>a.jsxs("button",{type:"button",onClick:()=>{o(d.id)},className:"flex w-full items-center gap-3 rounded-lg px-4 py-3 text-start",children:[n===d.id?a.jsx(Dt,{className:"text-token-text-primary h-6 w-6"}):a.jsx(Ot,{className:"text-token-text-primary h-6 w-6"}),a.jsxs("div",{className:"flex flex-1 flex-col items-start",children:[a.jsx("span",{className:"text-token-text-primary flex items-center gap-2 text-base",children:d.title}),a.jsx("span",{className:"text-token-text-secondary text-sm leading-tight font-normal",children:d.subtitle})]})]},d.id))}),a.jsx(we,{onClick:()=>{n&&(pe({store:s,fields:{shippingMethodId:n,items:s.items},errorMessage:i.formatMessage(Q.cartUpdateShippingAddressErrorMessage),source:"user"}),e())}})]})}function Qs(){var b,u,l,M,f,v,m,h,y,x,C,S,T,R,D,k,E,N;const t=Ee(),e=Zt(t),s=!!e.items[0],i=yt("overview"),n=ae(),{currentPane:o,pushPane:d,popPane:p,resetPanes:g}=i,r=Bt(t,"3375735072");j.useEffect(()=>{e.isCheckoutOpen||g()},[e.isCheckoutOpen,g]);const c=j.useMemo(()=>{var P,A,U,B;return[...(A=(P=e.paymentTypes)==null?void 0:P.express_checkout)!=null?A:[],...(B=(U=e.paymentTypes)==null?void 0:U.payment_sheet)!=null?B:[]]},[e.paymentTypes]),_=(b=e.cartMetadata)==null?void 0:b.clientThreadId;return!r||!e.isCheckoutOpen||!s||!_?null:a.jsx(Pe,{testId:"modal-shopping-checkout",isOpen:!0,hideSeparator:!0,showCloseButton:e.cartStatus!=="submitting",size:"large",type:"success",className:"min-h-36 max-w-[550px]!",headerClassName:"sm:p-0 sm:px-6 sm:py-4 items-center sm:-me-1",contentClassName:"!p-0 pt-3",rootClassName:"z-40",shouldIgnoreClickOutside:!0,onEscapeKeyDown:P=>{P.preventDefault(),Se(e,"closed")},onClose:()=>{Se(e,"closed")},title:a.jsx(bt,{currentPane:o,popPane:p,url:(u=e.merchant)==null?void 0:u.url,faviconUrl:(l=e.merchant)==null?void 0:l.logoUrl,title:(f=(M=e.merchant)==null?void 0:M.title)!=null?f:"",subtitle:(m=(v=e.merchant)==null?void 0:v.subtitle)!=null?m:"",subtitlePrefix:(h=e.merchant)==null?void 0:h.subtitlePrefix,subtitleUrl:(y=e.merchant)==null?void 0:y.subtitleUrl,PANES:ys}),children:a.jsx(Mt,{grandTotal:e.grandTotal.value_minor>0?e.grandTotal.value_minor:(S=(C=(x=e.totals)==null?void 0:x.find(P=>P.type==="subtotal"))==null?void 0:C.value_minor)!=null?S:0,merchantExternalId:(R=(T=e.merchant)==null?void 0:T.externalId)!=null?R:"",merchantNetworkId:(k=(D=e.merchant)==null?void 0:D.networkId)!=null?k:"",merchantTitle:(N=(E=e.merchant)==null?void 0:E.title)!=null?N:"",paymentMethodTypes:c,clientThreadId:_,fetchSession:()=>Kt({intl:n,store:e,clientThreadId:_}),children:({loadingCartSession:P,cartLoadError:A})=>a.jsx(xs,{paneStack:i,pushPane:d,store:e,loadingCartSession:P,cartLoadError:A,resetPanes:g})})})}function xs({paneStack:t,pushPane:e,store:s,loadingCartSession:i,cartLoadError:n,resetPanes:o}){var l,M;const[d,p]=j.useState(!me(s,s.shippingAddress)),[g,r]=j.useState(!((l=s.paymentDetails)!=null&&l.complete)),[c,_]=j.useState(null),b=zt({namespace:"shopping_checkout"}),u=(i||g||d)&&!n;return j.useEffect(()=>{var f,v,m,h,y;if(s.isCheckoutOpen&&!u&&s.cartMetadata&&s.cartId){const x=s.items[0];te.logEventWithStatsig("product_checkout","product_checkout",I(w({},se(s.cartMetadata)),{checkout_id:s.cartId,merchant_name:(f=s.merchant)==null?void 0:f.title,merchant_url:(v=s.merchant)==null?void 0:v.url,hadSavedPaymentMethod:!!((m=s.paymentDetails)!=null&&m.complete),items:[{quantity:x.quantity.toString(),price:"price"in x?x.price:void 0,variants:"variant"in x?x.variant:void 0,product_id:x.id,product_title:"title"in x?x.title:void 0}],action:"shown"})),b.endBlock("shown",{context:{merchant_id:(h=s.merchant)==null?void 0:h.externalId,merchant_network_id:(y=s.merchant)==null?void 0:y.networkId,cart_total:s.grandTotal.value,product_id:"productId"in x?x.productId:void 0}})}},[(M=s.cartMetadata)==null?void 0:M.clientThreadId,s.isCheckoutOpen,s.cartId,u]),a.jsx("div",{className:"relative w-full",children:a.jsx(vt,{className:"min-h-[755px] w-full",paneStack:t,useDelayedEnteringPane:!0,alwaysMountedPanes:["paymentMethod","overview","shippingAddress"],renderPane:f=>{switch(f){case"overview":return a.jsx(is,{store:s,pushPane:v=>{s.setErrors([]),_(null),e(v)},loadingCartSession:i,loadingPayment:g,loadingAddress:d,cartLoadError:n,stripeLoadingError:c,merchant:s.merchant,footerMessage:s.footerMessage,isCurrentPane:t.currentPane==="overview"});case"paymentMethod":return!i&&!n&&a.jsx(hs,{store:s,pushPane:e,resetPanes:o,loadingPayment:g,setLoadingPayment:r,loadingAddress:d,setStripeLoadingError:_,isCurrentPane:t.currentPane==="paymentMethod"});case"shippingAddress":return!i&&!n&&a.jsx(fs,{store:s,resetPanes:o,setLoadingAddress:p,loadingPayment:g,setStripeLoadingError:_,isCurrentPane:t.currentPane==="shippingAddress"});case"shippingMethod":return a.jsx(_s,{shippingMethods:s.shippingOptions,store:s,resetPanes:o})}}})})}const ys={overview:{name:{id:"shopping-checkout.pane.overview.title",defaultMessage:"Overview",description:"Title for shopping checkout overview pane"}},shippingAddress:{name:{id:"shopping-checkout.pane.shippingAddress.title",defaultMessage:"Add Shipping Address",description:"Title for shopping checkout shipping address pane"}},shippingMethod:{name:{id:"shopping-checkout.pane.shippingMethod.title",defaultMessage:"Select Shipping Method",description:"Title for shopping checkout shipping method pane"}},paymentMethod:{name:{id:"shopping-checkout.pane.paymentMethod.title",defaultMessage:"Add payment method",description:"Title for shopping checkout payment method pane"}}};export{Qs as CheckoutModal};
//# sourceMappingURL=l8s12ibm9arbp2uu.js.map

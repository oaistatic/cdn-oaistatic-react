var H=Object.defineProperty,Z=Object.defineProperties;var V=Object.getOwnPropertyDescriptors;var B=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var T=(r,t,e)=>t in r?H(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,_=(r,t)=>{for(var e in t||(t={}))X.call(t,e)&&T(r,e,t[e]);if(B)for(var e of B(t))Y.call(t,e)&&T(r,e,t[e]);return r},D=(r,t)=>Z(r,V(t));import{r as n,h as J,ao as Q,j as f,M as U}from"./mw35uwhq4g8r9eam.js";import{D as $,bd as ee,W as te,mH as N,aA as q,h5 as L,cF as W,er as I,lk as re,_ as ne,a7 as se}from"./d0xa318sl7ywi0za.js";import{lX as G,lY as oe,lZ as z,l_ as P,aZ as K}from"./g2euln7v5pbm31qa.js";function k(r,t){return e=>{$.addAction("".concat(r,".").concat(t),e)}}function ce(r){return(t,e)=>{$.addError(t,D(_({},e),{name:r,status:"error"}))}}const S={recording:{start:k("whisper-recording","start"),cancel:k("whisper-recording","cancel"),submit:k("whisper-recording","submit")},transcription:{request:k("whisper-transcription","request"),transcriptDelivered:k("whisper-transcription","transcriptDelivered"),error:ce("whisper-transcription"),requestSuccess:k("whisper-transcription","requestSuccess")}};class ae{static async transcribe(t,e,M={}){const w=new FormData;w.append("file",t),e&&w.append("language",e);const h={durationMs:M.durationMs,language:e,fileSize:t.size},g=performance.now();return S.transcription.request(h),ee.post("".concat(te,"/transcribe"),w).then(o=>{const c=performance.now()-g;return S.transcription.requestSuccess(D(_({},h),{durationMs:c})),o}).catch(o=>{const c=performance.now()-g;throw S.transcription.error(o,D(_({},h),{durationMs:c})),o})}}const ie=48e3,ue=10,j=ie*ue,le=4e3,de=600*1e3,y=r=>G.setState(t=>{t.status=r}),pe=r=>{const t=n.useRef(r);t.current=r;const e=n.useRef(null),M=n.useRef([]),w=n.useRef(null),h=n.useRef(null),g=n.useRef(null),o=n.useRef(new Float32Array(0)),c=n.useRef(null),b=n.useRef(null),v=n.useRef(!1),i=n.useCallback(()=>{o.current=new Float32Array,t.current.onWaveformDataUpdate(void 0)},[]),x=n.useCallback(async(u,m)=>{var p;y("transcribing");try{let l;N()?l=new File([u],"whisper.mp3",{type:"audio/mpeg"}):l=new File([u],"whisper.".concat(u.type.split(/[\/;]/)[1]||"mp3"),{type:u.type});const a=await ae.transcribe(l,void 0,{durationMs:m});y("idle"),S.transcription.transcriptDelivered({durationMs:m,transcriptLength:a.text.length}),t.current.onSuccess(a.text,a.asset_pointer,a.asset_ttl,(p=a.asset_format)!=null?p:null),i()}catch(l){y("error"),S.transcription.error(l,{durationMs:m}),i()}},[i]),R=n.useCallback(u=>{var p,l,a,d,s;if(!v.current)return;v.current=!1,b.current!==null&&(clearTimeout(b.current),b.current=null);const m=c.current!=null?performance.now()-c.current:void 0;u&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,y("idle"),i(),S.recording.cancel({durationMs:m}),c.current=null),(p=e.current)==null||p.stop(),(l=e.current)==null||l.stream.getTracks().forEach(A=>A.stop()),e.current=null,(a=g.current)==null||a.disconnect(),g.current=null,(d=h.current)==null||d.disconnect(),h.current=null,(s=w.current)==null||s.close(),w.current=null,u||S.recording.submit({durationMs:m})},[i]),F=n.useCallback(()=>{i(),y("recording"),oe.getUserMedia({audio:{sampleRate:le,channelCount:1}}).then(u=>{c.current=performance.now(),S.recording.start(),e.current=new MediaRecorder(u);const m=N();v.current=!0,m?(M.current=[],e.current.ondataavailable=d=>{d.data.size>0&&M.current.push(d.data)},e.current.onstop=async()=>{const d=new Blob(M.current,{type:"audio/mpeg-3"}),s=c.current!=null?performance.now()-c.current:void 0;await x(d,s)},e.current.start(1e3)):(e.current.ondataavailable=async d=>{const s=c.current!=null?performance.now()-c.current:void 0;await x(d.data,s)},e.current.start()),o.current=new Float32Array(j).fill(t.current.initialValue),t.current.onWaveformDataUpdate(o.current),y("recording"),b.current=window.setTimeout(()=>{R()},de);const p=new AudioContext;w.current=p;const l=p.createMediaStreamSource(u);h.current=l;const a=p.createScriptProcessor(2048,1,1);g.current=a,a.onaudioprocess=d=>{const s=d.inputBuffer.getChannelData(0);for(let C=0;C<s.length;C++)s[C]=Math.max(s[C],t.current.initialValue);const A=o.current,E=new Float32Array(A.length+s.length);if(E.set(A,0),E.set(s,A.length),E.length>j){const C=E.length-j;o.current=E.slice(C)}else o.current=E;t.current.onWaveformDataUpdate(o.current)},l.connect(a),a.connect(p.destination)}).catch(()=>{y("error"),i(),S.recording.cancel()})},[i,R,x]);return n.useEffect(()=>()=>{R(!0)},[R]),{startRecording:F,stopRecording:R}};function we({disabled:r=!1,initialValue:t,onSuccess:e,onWaveformDataUpdate:M,onExit:w,buttonClassName:h,visualTreatment:g}){const o=J(),c=G(s=>s.status),b=n.useRef(!1),{startRecording:v,stopRecording:i}=pe({onSuccess:e,onWaveformDataUpdate:M,initialValue:t}),x=Q();n.useEffect(()=>()=>{i()},[i]),n.useEffect(()=>{b.current||(v(),b.current=!0)},[v]),n.useEffect(()=>{x.state!=="idle"&&i()},[x.state,i]);const R=()=>{i(!0),w()},F=g==="codex"?f.jsx(q,{type:"button",color:"ghost",size:"small",onClick:R,icon:L,disabled:r||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},children:f.jsx(U,{id:"wham.whisperModeControls.cancel",defaultMessage:"Cancel"})}):f.jsx("div",{children:f.jsx("button",{"aria-label":o.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:R,disabled:r||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:W(g==="composer-btn"?"composer-btn":W(z,r?"opacity-30":P,h)),children:f.jsx(L,{"aria-label":o.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"icon",fontSize:"inherit"})})}),u=c==="transcribing",m=u?f.jsx(I,{}):f.jsx(K,{className:"icon-lg"}),p=u?o.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):o.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),l=()=>{ne.logEvent("Whisper on Web/Windows: Clicked to end dictation"),se.logEvent("chatgpt_composer_whisper_button_clicked_end"),i()},a=s=>{s.key==="Escape"&&re(s)&&(R(),s.preventDefault())},d=g==="codex"?f.jsx(q,{type:"button",color:"secondary",size:"small",disabled:r,icon:u?I:K,onClick:l,onKeyDown:a,ref:O,children:f.jsx(U,{id:"wham.whisperModeControls.done",defaultMessage:"Done"})}):f.jsx("div",{children:f.jsx("button",{type:"button","aria-label":p,disabled:r,className:g==="composer-btn"?"composer-btn":W(z,r?"opacity-30":P,h),onClick:l,onKeyDown:a,ref:O,children:m})});return f.jsxs("div",{className:"flex gap-x-1.5",children:[F,d]})}function O(r){r==null||r.focus()}export{we as WhisperModeControls};
//# sourceMappingURL=g5x7vnyap4gl71d1.js.map

var Et=Object.defineProperty,xt=Object.defineProperties;var It=Object.getOwnPropertyDescriptors;var fe=Object.getOwnPropertySymbols;var We=Object.prototype.hasOwnProperty,ze=Object.prototype.propertyIsEnumerable;var He=(e,n,t)=>n in e?Et(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,_=(e,n)=>{for(var t in n||(n={}))We.call(n,t)&&He(e,t,n[t]);if(fe)for(var t of fe(n))ze.call(n,t)&&He(e,t,n[t]);return e},Q=(e,n)=>xt(e,It(n));var me=(e,n)=>{var t={};for(var s in e)We.call(e,s)&&n.indexOf(s)<0&&(t[s]=e[s]);if(e!=null&&fe)for(var s of fe(e))n.indexOf(s)<0&&ze.call(e,s)&&(t[s]=e[s]);return t};import{r as i,d as Dt,u as it,_ as Rt,j as S,h as se,e as at}from"./mw35uwhq4g8r9eam.js";import{ih as H,ne as Me,y0 as pe,qH as Ge,mg as ct,rP as Pe,y1 as Le,rR as R,rQ as rt,qz as he,y2 as be,md as te,ma as N,h as Pt,qx as $,y3 as Lt,y4 as lt,bN as Vt,y5 as At,y6 as J,dz as ut,qE as Nt,qD as Qe,qC as Je,qB as Xe,y7 as Ot,y8 as jt,y9 as Ft,ya as Ut,yb as Bt,yc as $t,yd as dt,ye as Kt,m8 as qt,pT as Ht,yf as Wt,ie as zt}from"./g2euln7v5pbm31qa.js";import{c as Gt,$ as Qt,C as Jt,_ as q,y as Xt,W as Yt,O as ft,N as Zt,I as en,R as tn,Y as nn,F as sn,S as ge,d as Y,a as on,e as an,T as cn,L as rn,u as ln,g as un}from"./ehb03yyzqhj5ry6r.js";import{jv as I,jU as ye,xS as dn,c as fn,p as mn,r as Ve,cu as ke,jZ as Ae,xT as gn,qK as vn,u as Ne,I as pn,eX as Sn,mu as hn,T as bn,m as yn,bl as kn,V as Se,P as Ee,bm as _n,mw as xe,gr as Cn,d as Tn,jW as Oe,xU as Mn,_ as Ye,xV as wn,U as En,xW as xn,mI as In,e_ as Dn,fG as mt,bj as Rn,g as Pn,e5 as Ie,cF as De,cw as Ln,er as je,h5 as Vn,aA as An}from"./d0xa318sl7ywi0za.js";import{b as Nn,R as L,M as On,C as X,T as ve,c as jn,d as Fn,a as ue,e as Un,E as Bn}from"./ftef8970ba1zoykr.js";import{L as $n}from"./iiok29s29bpdre61.js";import{S as Kn}from"./cvtbni005816i9ea.js";import{S as qn,a as Hn,b as Wn,c as zn}from"./laafg2mog1bp1gmd.js";import{u as Gn,s as Qn}from"./kcp2yv1bqmcmvayq.js";import{V as Jn}from"./lmjej3aac0uhz664.js";function Xn(){const e=H(),n=Gt(),t=i.useCallback(()=>{Me.debug("disconnected from room"),pe(e)},[e]),s=i.useCallback(c=>{n.danger("Something went wrong",{toastId:"livekit_room_error"}),Me.error("an error occurred within the room",c);const a=Ge(e.getState());I.voiceMode.error(Q(_({},a),{error:c.message})),e.setState(r=>{r.metrics.livekitConnectSuccessTime||(r.metrics.livekitConnectFailTime=new Date)}),pe(e)},[n,e]),o=i.useCallback(c=>{n.danger("Something went wrong",{toastId:"livekit_room_error",loggingTitle:"Encryption error",loggingDescription:c.message}),Me.error("an encryption error occurred within the room",c);const a=Ge(e.getState());I.voiceMode.error(_({encryptionError:c.message,eventSource:"voice-session"},a)),e.setState(r=>{r.metrics.livekitConnectSuccessTime||(r.metrics.livekitConnectFailTime=new Date)}),pe(e)},[n,e]);return{onDisconnected:t,onError:s,onEncryptionError:o}}const Ze=async(e,n)=>{var s;n||(n=await ct.getLocalDevices());const t=(s=n.find(o=>o.deviceId===e))==null?void 0:s.label;return t!=null?t:e};function gt(e){var n,t,s="";if(typeof e=="string"||typeof e=="number")s+=e;else if(typeof e=="object")if(Array.isArray(e)){var o=e.length;for(n=0;n<o;n++)e[n]&&(t=gt(e[n]))&&(s&&(s+=" "),s+=t)}else for(t in e)e[t]&&(s&&(s+=" "),s+=t);return s}function Yn(){for(var e,n,t=0,s="",o=arguments.length;t<o;t++)(e=arguments[t])&&(n=gt(e))&&(s&&(s+=" "),s+=n);return s}function Zn(...e){return(...n)=>{for(const t of e)if(typeof t=="function")try{t(...n)}catch(s){console.error(s)}}}function vt(...e){const n=_({},e[0]);for(let t=1;t<e.length;t++){const s=e[t];for(const o in s){const c=n[o],a=s[o];typeof c=="function"&&typeof a=="function"&&o[0]==="o"&&o[1]==="n"&&o.charCodeAt(2)>=65&&o.charCodeAt(2)<=90?n[o]=Zn(c,a):(o==="className"||o==="UNSAFE_className")&&typeof c=="string"&&typeof a=="string"?n[o]=Yn(c,a):n[o]=a!==void 0?a:c}}return n}const es={connect:!0,audio:!1,video:!1};function ts(e){const x=_(_({},es),e),{token:n,serverUrl:t,options:s,room:o,connectOptions:c,connect:a,audio:r,video:u,screen:f,onConnected:h,onDisconnected:g,onError:l,onMediaDeviceFailure:b,onEncryptionError:m,simulateParticipants:k}=x,T=me(x,["token","serverUrl","options","room","connectOptions","connect","audio","video","screen","onConnected","onDisconnected","onError","onMediaDeviceFailure","onEncryptionError","simulateParticipants"]);s&&o&&q.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[d,O]=i.useState();i.useEffect(()=>{O(o!=null?o:new Nn(s))},[o]);const j=i.useMemo(()=>{const{className:w}=Xt();return vt(T,{className:w})},[T]);return i.useEffect(()=>{if(!d)return;const w=()=>{const K=d.localParticipant;q.debug("trying to publish local tracks"),Promise.all([K.setMicrophoneEnabled(!!r,typeof r!="boolean"?r:void 0),K.setCameraEnabled(!!u,typeof u!="boolean"?u:void 0),K.setScreenShareEnabled(!!f,typeof f!="boolean"?f:void 0)]).catch(G=>{q.warn(G),l==null||l(G)})},B=K=>{const G=On.getFailure(K);b==null||b(G)},P=K=>{m==null||m(K)};return d.on(L.SignalConnected,w).on(L.MediaDevicesError,B).on(L.EncryptionError,P),()=>{d.off(L.SignalConnected,w).off(L.MediaDevicesError,B).off(L.EncryptionError,P)}},[d,r,u,f,l,m,b]),i.useEffect(()=>{if(d){if(k){d.simulateParticipants({participants:{count:k},publish:{audio:!0,useRealTracks:!0}});return}if(!n){q.debug("no token yet");return}if(!t){q.warn("no livekit url provided"),l==null||l(Error("no livekit url provided"));return}a?(q.debug("connecting"),d.connect(t,n,c).catch(w=>{q.warn(w),l==null||l(w)})):(q.debug("disconnecting because connect is false"),d.disconnect())}},[a,n,JSON.stringify(c),d,l,t,k]),i.useEffect(()=>{if(!d)return;const w=B=>{switch(B){case X.Disconnected:g&&g();break;case X.Connected:h&&h();break}};return d.on(L.ConnectionStateChanged,w),()=>{d.off(L.ConnectionStateChanged,w)}},[n,h,g,d]),i.useEffect(()=>{if(d)return()=>{q.info("disconnecting on onmount"),d.disconnect()}},[d]),{room:d,htmlProps:j}}const ns=i.forwardRef(function(e,n){const{room:t,htmlProps:s}=ts(e);return i.createElement("div",_({ref:n},s),t&&i.createElement(Qt.Provider,{value:t},i.createElement(Jt.Provider,{value:e.featureFlags},e.children)))});function ss(e){return e!==void 0}function os(...e){return vt(...e.filter(ss))}function is(e,n={}){var k;const[t,s]=i.useState(tn(e)),[o,c]=i.useState(t==null?void 0:t.isMuted),[a,r]=i.useState(t==null?void 0:t.isSubscribed),[u,f]=i.useState(t==null?void 0:t.track),[h,g]=i.useState("landscape"),l=i.useRef(),{className:b,trackObserver:m}=i.useMemo(()=>nn(e),[(k=e.participant.sid)!=null?k:e.participant.identity,e.source,sn(e)&&e.publication.trackSid]);return i.useEffect(()=>{const T=m.subscribe(d=>{q.debug("update track",d),s(d),c(d==null?void 0:d.isMuted),r(d==null?void 0:d.isSubscribed),f(d==null?void 0:d.track)});return()=>T==null?void 0:T.unsubscribe()},[m]),i.useEffect(()=>{var T,d;return u&&(l.current&&u.detach(l.current),(T=n.element)!=null&&T.current&&!(ft(e.participant)&&(u==null?void 0:u.kind)==="audio")&&u.attach(n.element.current)),l.current=(d=n.element)==null?void 0:d.current,()=>{l.current&&(u==null||u.detach(l.current))}},[u,n.element]),i.useEffect(()=>{var T,d;if(typeof((T=t==null?void 0:t.dimensions)==null?void 0:T.width)=="number"&&typeof((d=t==null?void 0:t.dimensions)==null?void 0:d.height)=="number"){const O=t.dimensions.width>t.dimensions.height?"landscape":"portrait";g(O)}},[t]),{publication:t,isMuted:o,isSubscribed:a,track:u,elementProps:os(n.props,_({className:b,"data-lk-local-participant":e.participant.isLocal,"data-lk-source":t==null?void 0:t.source},(t==null?void 0:t.kind)==="video"&&{"data-lk-orientation":h}))}}var as=typeof ge=="object"&&ge&&ge.Object===Object&&ge,cs=typeof self=="object"&&self&&self.Object===Object&&self;as||cs||Function("return this")();const rs=i.forwardRef(function(a,c){var r=a,{trackRef:e,onSubscriptionStatusChanged:n,volume:t,muted:s}=r,o=me(r,["trackRef","onSubscriptionStatusChanged","volume","muted"]);const u=en(e),f=i.useRef(null);i.useImperativeHandle(c,()=>f.current);const{elementProps:h,isSubscribed:g,track:l,publication:b}=is(u,{element:f,props:o});return i.useEffect(()=>{n==null||n(!!g)},[g,n]),i.useEffect(()=>{l===void 0||t===void 0||(l instanceof jn?l.setVolume(t):q.warn("Volume can only be set on remote audio tracks."))},[t,l]),i.useEffect(()=>{b===void 0||s===void 0||(b instanceof Fn?b.setEnabled(!s):q.warn("Can only call setEnabled on remote track publications."))},[s,b,l]),i.createElement("audio",_({ref:f},h))});function ls({volume:e,muted:n}){const t=Yt([ve.Source.Microphone,ve.Source.ScreenShareAudio,ve.Source.Unknown],{updateOnlyOn:[],onlySubscribed:!0}).filter(s=>!ft(s.participant)&&s.publication.kind===ve.Kind.Audio);return i.createElement("div",{style:{display:"none"}},t.map(s=>i.createElement(rs,{key:Zt(s),trackRef:s,volume:e,muted:n})))}function us(){fs(),ms(),gs(),ds()}function ds(){const{room:e,debug:n}=Y(),{cameraTrackState:t}=Pe(),o=Le().video,c=i.useMemo(()=>{const a=["audioinput","audiooutput"];return o&&a.push("videoinput"),a},[o]);i.useEffect(()=>{function a(){Promise.all(c.map(async r=>{if(t!==R.Started&&r==="videoinput")return;const u=await ct.getLocalDevices(r),f=e==null?void 0:e.getActiveDevice(r),h=await he(r);if(!(f===(h==null?void 0:h.deviceId))){let l=null;if(h?l=h.deviceId:u[0]&&(l=u[0].deviceId),l){const b=await Ze(l,u),m=await Ze(f,u);n("Current active ".concat(r,' device "').concat(m,'" doesn\'t match default "').concat(b,'", switching to that instead')),await(e==null?void 0:e.switchActiveDevice(r,l)),I.defaultMediaDeviceChanged.success({kind:r})}}})).catch(r=>{I.defaultMediaDeviceChanged.failure(r)})}if(navigator)return navigator.mediaDevices.addEventListener("devicechange",a),()=>{navigator.mediaDevices.removeEventListener("devicechange",a)}},[e,n,c,t])}function fs(){const{room:e,debug:n}=Y(),t=e==null?void 0:e.getActiveDevice("audioinput"),s=e==null?void 0:e.getActiveDevice("audiooutput");i.useEffect(()=>{async function o(){var f,h;const c=(f=await he("audioinput"))==null?void 0:f.deviceId,a=(h=await he("audiooutput"))==null?void 0:h.deviceId,r=async()=>{c&&t!==c&&(n("switching audio input to default"),await(e==null?void 0:e.switchActiveDevice("audioinput",c)))},u=async()=>{if(a&&s!==a){n("switching audio output to default");try{await(e==null?void 0:e.switchActiveDevice("audiooutput",a))}catch(g){n("failed to switch audio output",g)}}};await Promise.all([r(),u()])}o()},[t,s,n,e])}function ms(){const{cameraTrackState:e,finalizeCameraState:n}=Pe(),{room:t,debug:s}=Y(),o=H(),a=Le().video,r=a?t==null?void 0:t.getActiveDevice("videoinput"):void 0;i.useEffect(()=>{async function u(){if(t)if(e===R.Starting)try{await t.localParticipant.setCameraEnabled(!0),be(t,o,"camera_front","live"),n(R.Started)}catch(f){n(R.Stopped)}else e===R.Stopping&&(await t.localParticipant.setCameraEnabled(!1),be(t,o,"camera_front","ended"),n(R.Stopped))}u()},[e,n,t,o]),i.useEffect(()=>{async function u(){var g;const f=(g=await he("videoinput"))==null?void 0:g.deviceId;await(async()=>{f&&r!==f&&(s("switching video input to default"),await(t==null?void 0:t.switchActiveDevice("videoinput",f)))})()}a&&e===R.Started&&u()},[r,s,t,a,e])}function gs(){const{room:e}=Y(),{screenshareTrackState:n,finalizeScreenshareState:t}=rt(),s=H();i.useEffect(()=>{async function o(){if(e)if(n===R.Starting)try{await e.localParticipant.setScreenShareEnabled(!0,{video:{displaySurface:"monitor"}}),be(e,s,"screen_share","live"),t(R.Started)}catch(c){t(R.Stopped)}else n===R.Stopping&&(await e.localParticipant.setScreenShareEnabled(!1),be(e,s,"screen_share","ended"),t(R.Stopped))}o()},[e,n,t,s])}const vs=async({serverThreadId:e,message:n})=>{const t=await ye(dn);if(t)switch(n.type){case"full_chat_message":{const s=fn(n.payload.message);t.handleResponse({type:"message",message:s,conversationId:e});break}case te.ConversationUpdate:{t.handleConversationUpdate(n.payload.conversation_id);break}}};function pt(){const{debug:e}=Y(),n=N(s=>s.conversationId),t=mn();return i.useCallback(async s=>{const o=s,c=n&&!Ve(n)?n:void 0,a=o!=null?o:c;if(a){e("refetch conversationId ".concat(a));try{await Pt(a)}catch(r){const u="Failed to update conversation";e(u,r),t.danger(u,{toastId:"refetch_conversation"})}}},[n,e,t])}var St=(e=>(e.EXCELLENT="excellent",e.GOOD="good",e.POOR="poor",e.LOST="lost",e.UNKNOWN="unknown",e))(St||{});const ps={[ue.Excellent]:"excellent",[ue.Good]:"good",[ue.Poor]:"poor",[ue.Lost]:"lost",[ue.Unknown]:"unknown"},Ss=5e3,hs=2e3,bs=500,_e=e=>{var T;const n=H(),{room:t}=Y(),s=N(d=>d.disconnectPending),o=N(d=>d.server.remoteState===$.Speaking),c=(T=N(d=>d.conversationId))!=null?T:void 0,a=ke(c),r=i.useRef(!1),u=pt(),f=Dt(),h=it(),g=N(d=>d.server.connectionState),l=Ae();r.current=o||r.current;const b=i.useCallback(async d=>{clearTimeout(s),n.setState(j=>{j.disconnectPending=void 0}),t==null||t.disconnect(),await u(a),n.setState(Lt);const O=a!=null?a:d;O?lt(f,h,O):c&&l&&!Ve(c)&&f("/c/".concat(c)),ye(()=>{gn()},bs),e!=null&&e.refetchLater&&window.setTimeout(()=>{u(a)},hs),vn.set(!1)},[s,t,u,a,e==null?void 0:e.refetchLater,f,h,n,c,l]),m=r.current&&!a&&g===X.Connected,k=i.useCallback(()=>{n.setState(d=>{d.disconnectPending=window.setTimeout(b,Ss)})},[b,n]);return{disconnectPending:s!==void 0,shouldDelayDisconnect:m,delayDisconnect:k,immediateDisconnect:b}};function et(e){performance.mark("voice_mode.end");const n=performance.measure("voice_mode","voice_mode.start","voice_mode.end").duration.toFixed(0);I.voiceMode.connect({durationMs:n}),e.metrics.sessionConnectedTime=new Date}function ys(){var x,w,B;const e=Ne(),n=it(),t=H(),{room:s,debug:o,decoder:c}=Y(),{disconnectPending:a,shouldDelayDisconnect:r,delayDisconnect:u,immediateDisconnect:f}=_e(),h=pt(),g=i.useRef(!1),l=i.useRef(!1),b=i.useRef(!1),{session:m}=pn(e),k=Ae(),T=(x=N(P=>P.conversationId))!=null?x:void 0,d=ke(T),O=Sn(P=>P.lastVoiceSessionStartTime),j=hn()==="livekit";i.useEffect(()=>{const P=async C=>{const{new_state:v}=C;if(t.setState(y=>{(y.voiceMode!=="advanced"||v!==$.Thinking)&&(y.server.remoteState=v)}),v===$.Listening&&!g.current&&O instanceof Date){const W=new Date().getTime()-O.getTime();I.firstListeningLatency.success({durationMs:W}),g.current=!0}if(v===$.ListeningIntently)I.voiceSessionListeningIntently.stateChange();else if(v===$.Listening){if(t.setState(y=>{y.metrics.numListening+=1}),!l.current){const y=t.getState().voiceSessionId;I.voiceSessionFirstListening.stateChange({voice_session_id:y!=null?y:"unknown"}),l.current=!0}l.current=!0,I.voiceSessionListening.stateChange()}else if(v===$.Thinking)t.setState(y=>{y.metrics.numThinking+=1}),I.voiceSessionThinking.stateChange();else if(v===$.Speaking){if(t.setState(y=>{y.metrics.numSpeaking+=1}),!b.current){const y=t.getState().voiceSessionId;I.voiceSessionFirstSpeaking.stateChange({voice_session_id:y!=null?y:"unknown"}),b.current=!0}I.voiceSessionSpeaking.stateChange()}else v===$.Halted&&I.voiceSessionHalted.stateChange()},K=async C=>{t.setState(v=>{v.server.usage=C})},G=async C=>{if(t.setState(v=>{v.server.toolUpdate=_({},C)}),C.update_type==="hangup")r?u():f();else if(C.update_type==="mute"){const v=t.getState().dev.room,y=v==null?void 0:v.localParticipant;if(!v||!y){o("mute update received without active room/local participant");return}if(!y.isMicrophoneEnabled)return;try{await y.setMicrophoneEnabled(!1),At(v,t,"microphone","muted"),I.toggleMuteButton.click({toggleTo:"mute",source:"tool"})}catch(W){o("mute update failed to mute microphone",W),I.toggleMuteButton.error(W,{toggleTo:"mute",source:"tool"})}}},oe=async C=>{var y,W,de;let v;try{v=JSON.parse(c.decode(C)),o("data received",v)}catch(M){o("error parsing data",M);return}switch(t.setState(M=>(M.server.messages.push(Q(_({},v),{timestamp:new Date,source:"remote"})),M)),v.type){case te.StateUpdate:{o("state update",v.payload);const{new_state:M,delay_s:V}=v.payload,E=!!t.getState().metrics.sessionConnectedTime;[$.Thinking,$.Speaking].includes(M)&&t.getState().server.turnContext.clear(),M===$.Listening&&!E&&t.setState(D=>{et(D)}),M===$.Thinking&&V&&(o("".concat(s==null?void 0:s.name," delay thinking state by ").concat(V," seconds")),P({new_state:$.ListeningIntently}),await new Promise(D=>setTimeout(D,V*1e3))),P(v.payload);break}case te.ConversationUpdate:{o("conversation update",v.payload);const M=t.getState().conversationId,{conversation_id:V}=v.payload;if(M&&Ve(M)){if(t.setState(z=>{z.conversationId=V}),k)break;bn.initThread({clientThreadId:M,conversationMode:{kind:yn.PrimaryAssistant},userId:(y=m==null?void 0:m.user)==null?void 0:y.id,accountId:(W=m==null?void 0:m.account)==null?void 0:W.id});const E=t.getState().conversationId;E!=null&&kn(e,E,V),lt(Vt,n,V);const D=Se.getGizmoId(Ee(M));_n(n,D)}k||await h(V),a&&f(V);break}case te.UsageUpdate:K(v.payload);break;case te.ToolUpdate:G(v.payload);break;case te.Performance:{const M=v.payload.metrics;t.setState(V=>{M.forEach(E=>{E.name==="total_latency_ms"?V.metrics.totalLatencyMs.push(E.ms):E.name==="current_rtt_ms"&&V.metrics.currentRttMs.push(E.ms)})});break}case te.StartupTelemetry:{const[M]=v.payload.metrics,V=v.payload.success;o("conversation loaded (startup telemetry)"),t.setState(E=>{var D;V?(E.server.relayReady=!0,E.metrics.conversationStartSuccessTime=new Date):E.metrics.conversationStartFailTime=new Date,E.metrics.conversationLatency=(D=M==null?void 0:M.ms)!=null?D:-1}),I.conversationStart.latency({durationMs:(de=M==null?void 0:M.ms)!=null?de:-1,success:V});break}}vs({serverThreadId:d,message:v})},ce=(C,v)=>{o("track published",C,v)},ne=()=>{o("disconnected"),t.setState(C=>{C.metrics.sessionEndTime=new Date}),pe(t),I.voiceSessionDisconnected.stateChange()},F=(C,v)=>{o("Connection quality changed for participant ".concat(v==null?void 0:v.identity,": ").concat(C)),t.setState(y=>{y.server.voiceConnectionQuality=ps[C]})},re=()=>{t.setState(C=>{o("WebRTC connection established"),C.metrics.livekitConnectSuccessTime||(C.metrics.livekitConnectSuccessTime=new Date),j&&!C.metrics.sessionConnectedTime&&et(C),C.hasConnectedOnce=!0})};return s==null||s.on(L.Connected,re),s==null||s.on(L.DataReceived,oe),s==null||s.on(L.TrackPublished,ce),s==null||s.on(L.ConnectionQualityChanged,F),s==null||s.on(L.Disconnected,ne),()=>{s==null||s.off(L.Connected,re),s==null||s.off(L.DataReceived,oe),s==null||s.off(L.TrackPublished,ce),s==null||s.off(L.ConnectionQualityChanged,F),s==null||s.off(L.Disconnected,ne)}},[e,o,c,u,a,f,O,n,h,s,(w=m==null?void 0:m.account)==null?void 0:w.id,(B=m==null?void 0:m.user)==null?void 0:B.id,r,t,j,d,k])}function ks(){_s(),Cs(),Ts(),Ms(),ws()}function _s(){const{room:e}=Y(),n=H();i.useEffect(()=>{n.setState(t=>{t.dev.room=e})},[e,n])}function Cs(){const{getConnectionState:e}=on(),n=e(),t=H();i.useEffect(()=>{t.setState(s=>{s.server.connectionState=n})},[n,t])}function Ts(){const{room:e,debug:n,encoder:t}=Y(),s=H();i.useEffect(()=>{const o=!!s.getState().server.actions;if(e&&!o){const c=async a=>{n("publishing action",a);const r={type:te.ActionRequest,payload:{action:a}};await e.localParticipant.publishData(t.encode(JSON.stringify(r)),{reliable:!0}),s.setState(u=>{u.server.messages.push(Q(_({},r),{timestamp:new Date,source:"local"}))})};s.setState(a=>{a.server.actions={[J.StartListeningIntently]:()=>c(J.StartListeningIntently),[J.StopListeningIntently]:()=>c(J.StopListeningIntently),[J.HaltAllActivity]:()=>c(J.HaltAllActivity),[J.ResumeListening]:()=>c(J.ResumeListening),[J.RelayMessage]:()=>c(J.RelayMessage)}})}},[e,n,t,s])}function Ms(){const n=H()(o=>o.isVoiceModeActive),t=Ae();i.useEffect(()=>(xe({isVoiceActive:n}),()=>{xe({isVoiceActive:!1})}),[n]);const s=Ne();i.useEffect(()=>{if(n&&!t)return Cn(s).limitActionGroups([])},[s,n,t])}function ws(){const e=H(),{room:n,encoder:t}=Y(),s=i.useCallback(async o=>{await(n==null?void 0:n.localParticipant.publishData(t.encode(JSON.stringify(o)),{reliable:!0})),e.setState(c=>{c.server.messages.push(Q(_({},o),{timestamp:new Date,source:"local"}))})},[n,t,e]);i.useEffect(()=>{e.setState(o=>{o.server.turnContext.setPublisher(s)})},[s,e])}const Es=i.memo(function(){return ys(),ks(),us(),null});function xs(e={}){const[n,t]=i.useState(!1),[s,o]=i.useState(!1),[c,a]=i.useState(!1);let r=an().microphoneTrack;const[u,f]=i.useState();e.trackRef&&(r=e.trackRef.publication);const h=i.useCallback(async g=>{if(g){const{KrispNoiseFilter:l,isKrispNoiseFilterSupported:b}=await Rt(async()=>{const{KrispNoiseFilter:m,isKrispNoiseFilterSupported:k}=await import("./iveu78zecg5unjye.js");return{KrispNoiseFilter:m,isKrispNoiseFilterSupported:k}},[]);if(!b()){console.warn("Krisp noise filter is not supported in this browser");return}u||f(l(e.filterOptions))}t(l=>(l!==g&&o(!0),g))},[]);return i.useEffect(()=>{var g;if(r&&r.track instanceof Un&&u){const l=r.track.getProcessor();l&&l.name==="livekit-noise-filter"?(o(!0),l.setEnabled(n).finally(()=>{o(!1),a(n)})):!l&&n&&(o(!0),(g=r==null?void 0:r.track)==null||g.setProcessor(u).then(()=>u.setEnabled(n)).then(()=>{a(!0)}).catch(b=>{a(!1),console.error(b)}).finally(()=>{o(!1)}))}},[n,r,u]),{setNoiseFilterEnabled:h,isNoiseFilterEnabled:c,isNoiseFilterPending:s,processor:u}}const Is=i.memo(function(){const{setNoiseFilterEnabled:n}=xs();return i.useEffect(()=>{n(!0)},[n]),null}),Ds=()=>Tn(()=>Oe())==="transceiver",Rs=new $n(new URL("{{.assetPrefix}}/assets/livekit-client.e2ee.worker-CnFd6278.js",import.meta.url),{type:"module"}),Ys=i.memo(function({children:n,executors:t}){const s=i.useRef({keyProvider:new Bn}).current,[o,c]=i.useState(!1),{token:a,url:r,e2eeKey:u}=N(m=>m.credentials),f=Xn(),h=N(m=>m.isVoiceModeActive),g=N(m=>{var k;return(k=m.audioInputDevice)==null?void 0:k.deviceId}),l=Ds(),b=l?cn:rn;return i.useEffect(()=>{const m=a&&r&&u;!o&&m?s.keyProvider.setKey(u).then(()=>{c(!0)}):o&&!m&&c(!1)},[a,r,u,o,s]),h?S.jsx(ns,Q(_({},f),{connect:!0,token:a!=null?a:void 0,serverUrl:r!=null?r:void 0,audio:{deviceId:{ideal:g,exact:g},noiseSuppression:!0,echoCancellation:!0},options:{e2ee:{keyProvider:s.keyProvider,worker:Rs}},children:S.jsxs(b,{children:[n,l||o&&a&&r?S.jsx(Es,{}):null,o&&a&&r&&S.jsx(ls,{}),o&&a&&r&&S.jsx(Is,{}),!1,t]})})):t}),tt=e=>e.length>0?Ot(e):null,A=e=>{var n;return(n=e==null?void 0:e.toISOString())!=null?n:null};async function Ps(e){return await ye(async()=>{const{voiceMode:n,metrics:t}=e.getState(),s=jt(),o=await Ft(),c=await Ut(),a=await Bt(),r=await $t();return{session_create_time:A(t.sessionCreateTime),get_status_sent_time:A(t.getStatusSentTime),get_status_success_time:A(t.getStatusSuccessTime),get_status_failed_time:A(t.getStatusFailedTime),proof_of_work_start_time:A(t.proofOfWorkStartTime),proof_of_work_end_time:A(t.proofOfWorkEndTime),get_token_sent_time:A(t.getTokenSentTime),get_token_success_time:A(t.getTokenSuccessTime),get_token_failed_time:A(t.getTokenFailedTime),conversation_start_success_time:A(t.conversationStartSuccessTime),conversation_start_fail_time:A(t.conversationStartFailTime),livekit_connect_time:A(t.livekitConnectTime),livekit_connect_success_time:A(t.livekitConnectSuccessTime),livekit_connect_fail_time:A(t.livekitConnectFailTime),session_connected_time:A(t.sessionConnectedTime),data_channel_open_time:A(t.dataChannelOpenTime),conversation_latency_ms:t.conversationLatency,voice_mode:n,get_token:_({},s),peer_connection:_({},o),pre_connect:_({},c),connect:_({},r),post_connect:_({},a)}})}async function Ls(e,n,t){const s=await ut();return ye(()=>{const{voiceMode:o,metrics:c}=e.getState(),a=Oe(),r=Nt();return Q(_(_(_(_({session_end_time:A(c.sessionEndTime),avg_total_latency_ms:tt(c.totalLatencyMs),avg_rtt_ms:tt(c.currentRttMs),num_of_turns_speaking:c.numSpeaking,num_of_turns_thinking:c.numThinking,num_of_turns_listening:c.numListening,protocol:a,voice_session_id:t,reason:n,conversation_latency_ms:c.conversationLatency},Xe().length>0?{status_prefetch_failed_reasons:Xe().join(",")}:{}),Je().length>0?{status_prefetch_ineligible_reasons:Je().join(",")}:{}),r?{status_cache_skipped_reason:r}:{}),Qe().length>0?{status_prefetch_eligible_reasons:Qe().join(",")}:{}),{voice_mode:o,microphone_permission_state:s})})}function Vs({conversationId:e}){const{shouldDelayDisconnect:n,delayDisconnect:t,immediateDisconnect:s}=_e({refetchLater:!0}),{toggleMute:o}=dt(),c=ke(e),a=H(),r=Mn();return i.useCallback(async u=>{I.voiceSessionEndedByUser.click({reason:u}),a.setState(P=>{P.metrics.sessionEndTime=new Date}),xe({voiceFeedbackThread:c,lastVoiceSessionEndTime:new Date});const f=await Ls(a,u,r),h=await Ps(a),{metrics:{sessionCreateTime:g,sessionConnectedTime:l,sessionEndTime:b,numSpeaking:m,numThinking:k,numListening:T},voiceMode:d,server:{connectionState:O}}=a.getState(),j=g==null?void 0:g.getTime(),x=b==null?void 0:b.getTime(),w=l==null?void 0:l.getTime(),B=j!==void 0&&x!==void 0?x-j:void 0;Ye.logStructuredEvent(wn,{voiceMode:d!=null?d:void 0,voiceSessionId:r||void 0,protocol:Oe(),sessionStartTsMs:j,sessionEndTsMs:x,sessionConnectedTsMs:w,sessionDurationMs:B,numOfTurnsSpeaking:m,numOfTurnsThinking:k,numOfTurnsListening:T,sessionEndReason:u,wasConnectedAtTimeOfExit:O===X.Connected}),Ye.logEvent("Voice Session End Summary",Q(_(_({},f),h),{integratedMode:En(()=>xn())})),n?(a.setState(P=>{P.video=R.Stopping,P.screenshare=R.Stopping}),await o(),t()):(await s(),Kt())},[t,s,c,n,o,a,r])}const ht="inline-flex items-center bg-transparent text-token-text-secondary hover:text-token-text-primary",nt=({message:e,onClick:n,type:t})=>{const s=se(),o=In()&&Dn;switch(t){case"microphone_denied":return o?S.jsxs("a",{href:"ms-settings:privacy-microphone",className:ht,children:[e,S.jsx(mt,{className:"icon-sm ms-1"})]}):S.jsx(st,{onClick:n,message:e});case"disconnected":return S.jsxs("div",{className:"inline-flex items-center",children:[s.formatMessage(Re.lostConnection),S.jsx("button",{onClick:n,className:"ms-1",children:S.jsx("strong",{children:s.formatMessage(Re.retry)})})]});case"normal":return S.jsx(st,{onClick:n,message:e})}},st=({message:e,onClick:n})=>{const t=se();return S.jsxs("button",{onClick:n,className:ht,"aria-label":t.formatMessage(Re.openInfoModal),children:[e,S.jsx(mt,{className:"icon-sm ms-1"})]})},Re=at({openInfoModal:{id:"hintMessage.openInfoModal",defaultMessage:"Open info modal"},retry:{id:"hintMessage.retry",defaultMessage:"Retry"},lostConnection:{id:"hintMessage.lostConnection",defaultMessage:"Lost connection."}});function Zs({conversationId:e}){var Ue,Be,$e,Ke,qe;const n=Ne(),t=se(),s=H(),o=Vs({conversationId:e}),c=N(p=>p.server.usage),a=N(p=>p.server.voiceConnectionQuality),r=p=>p===St.LOST,u=qt(),{voiceName:f}=Ht(),[h,g]=i.useState(!1),l=N(p=>p.server.toolUpdate),[b,m]=i.useState(!1),[k,T]=i.useState(!0),d=Gn(),[O,j]=i.useState(null),[x,w]=i.useState(null),[B,P]=i.useState(null),K=i.useRef(!1),G=ke(e),{startVoiceMode:oe,stopVoiceMode:ce,isVoiceModeActive:ne}=ln(),F=N(p=>p.server.connectionState),re=i.useRef(!1),C=i.useRef(!1),{requestMicrophonePermissions:v,userDeclinedMicrophonePermissions:y,microphoneAvailable:W,microphoneLabel:de}=Wt(),M=i.useCallback(async()=>{if(re.current)return;re.current=!0;let p;const U=await ut();U==="prompt"?p="userIgnoredMicrophonePrompt":U==="denied"?p="userDeniedMicrophonePrompt":C.current?p="limitReached":F==null||F===X.Connecting||F===X.Reconnecting||F===X.SignalReconnecting?p="userAbort":F===X.Connected?p="userRequest":p="networkDisconnected",o(p)},[F,o]);i.useEffect(()=>{v()},[v]),i.useEffect(()=>{ne&&y&&(g(!1),P(null),j(t.formatMessage(we.hint)),w({title:t.formatMessage(we.title),description_markdown:t.formatMessage(we.description_markdown),buttons:[]}))},[t,ne,y]),i.useEffect(()=>{var p;if(W&&!F&&!K.current){K.current=!0,j(null),w(null);const U=Ee(e);let Z;d!==void 0?(Z=d,Qn.set(void 0)):(Z=un({serverThreadId:G,parentMessageId:(p=Se.getCurrentNode(U))==null?void 0:p.id,isAdvancedMode:!0,eventSource:"composer_speech_button",clientThreadId:e,gizmoId:Se.getGizmoId(U)}),I.voiceSessionStarted.click({voice:f}),Z.requested_default_model=Rn(Pn(n,e)).id),oe(Z)}},[n,F,e,W,G,oe,f,d]);const V=N(p=>p.hasConnectedOnce),{reaching_limit_disclosure:E,exceed_limit_message:D}=(Ue=c==null?void 0:c.rate_limit_message)!=null?Ue:{},z=u==null?void 0:u.modes.find(p=>p.mode===(u==null?void 0:u.default_voice_mode)),le=z==null?void 0:z.disclosure_message,ee=z==null?void 0:z.info_message,bt=i.useMemo(()=>F!==X.Connected?!0:!!r(a),[F,a]),[yt,Fe]=i.useState(!1);i.useEffect(()=>{F===X.Connected&&Fe(!1)},[F]);const Te=(Ke=($e=(Be=E==null?void 0:E.hint)!=null?Be:D==null?void 0:D.title)!=null?$e:le==null?void 0:le.hint)!=null?Ke:null;i.useEffect(()=>{var p,U;z&&!y&&j((U=(p=z.disclosure_message)==null?void 0:p.hint)!=null?U:null)},[z,y]),i.useEffect(()=>{const p=l==null?void 0:l.text;let U,Z,ae;return p&&(T(!1),U=setTimeout(()=>{m(!0),Z=setTimeout(()=>{m(!1),ae=setTimeout(()=>{T(!0),s.setState(wt=>{wt.server.toolUpdate=null})},750)},3e3)},750)),()=>{clearTimeout(U),clearTimeout(Z),clearTimeout(ae)}},[l,s]),i.useEffect(()=>{if(!y){if(Te&&j(Te),D&&ne){C.current=!0,ce();const p={title:D.title,description_markdown:D.description_markdown,buttons:D.buttons};h?P(p):(w(p),g(!0));const U=D.buttons.some(ae=>ae.action==="upgrade_to_plus"),Z=D.buttons.some(ae=>ae.action==="upgrade_to_pro");I.rateLimitReached.success({upgrade_to_plus:U,upgrade_to_pro:Z})}else if(!x){const p=E!=null?E:le;p&&w({title:p.title,description_markdown:p.message_markdown,buttons:p.buttons})}}},[le,D,Te,h,ne,x,E,ce,y,ee]);const kt=i.useCallback(()=>{B&&(w(B),P(null)),g(!0)},[B]),_t=i.useCallback(()=>{ee&&w({title:ee.title,description_markdown:ee.message_markdown,buttons:ee.buttons}),g(!0)},[ee]),Ct=i.useCallback(()=>{g(!1)},[]),Tt=N(p=>p.voiceMode),Mt=async()=>{try{j(null),Fe(!0),await oe({conversation_id:G,eventSource:"lost_connection_hint_message",voice_mode:Tt,voice:f,clientThreadId:e,gizmo_id:Se.getGizmoId(Ee(e)),skipCacheReason:"lost-connection-retry",forceDisconnect:!0})}catch(p){const U=p instanceof Error?p.message:String(p);I.voiceMode.error({error:U,eventSource:"lost_connection_hint_message"})}};let ie="normal";return y?ie="microphone_denied":O?ie="normal":bt&&!yt&&V&&(ie="disconnected"),S.jsxs("div",{className:"flex w-full flex-col items-center",children:[S.jsxs("div",{className:"text-token-text-secondary relative mb-6 flex min-h-5 w-full items-center justify-center text-xs",children:[(l==null?void 0:l.text)&&S.jsx(Ie.div,{initial:{opacity:0},animate:{opacity:b?1:0},transition:{duration:.5},style:{position:"absolute",left:"50%",transform:"translateX(-50%)",textAlign:"center"},children:S.jsxs("div",{className:"flex items-center",children:[(l==null?void 0:l.text)&&S.jsx(Kn,{className:"icon-sm me-1"}),l==null?void 0:l.text]})}),S.jsx(Ie.div,{initial:{opacity:0},animate:{opacity:k?1:0},transition:{duration:.5},style:{position:"absolute",left:"50%",transform:"translateX(-50%)",textAlign:"center",pointerEvents:l!=null&&l.text?"none":"auto",cursor:l!=null&&l.text?"default":"pointer"},children:S.jsx("div",{className:"flex items-center",children:O||ie==="disconnected"?S.jsx(nt,{type:ie,message:O,onClick:ie==="disconnected"?Mt:kt}):ee?S.jsx(nt,{type:"normal",message:ee.title,onClick:_t}):null})})]}),S.jsxs("div",{className:De("flex flex-row items-center gap-6","rounded-full px-3 py-1","transition-width duration-200 ease-in-out"),children:[S.jsx(ot,{capability:"video",children:S.jsx(As,{})}),S.jsx(Ns,{hideTooltip:y,microphoneLabel:de,isMicrophoneEnabled:W}),S.jsx(ot,{capability:"screenshare",children:S.jsx(Os,{})}),S.jsx(js,{onClick:M})]}),S.jsx(Jn,{conversationId:e,isOpen:h,onClose:Ct,title:x==null?void 0:x.title,description_markdown:x==null?void 0:x.description_markdown,buttons:(qe=x==null?void 0:x.buttons)!=null?qe:[]}),!1]})}function ot({children:e,capability:n}){return Le()[n]?e:null}function As(){const{cameraTrackState:e,toggleCamera:n}=Pe(),t=se();let s=null;const o=[R.Starting,R.Stopping].includes(e),c=e===R.Started;o?s=je:s=Wn;const a=c?"bg-gray-900 hover:bg-gray-800 active:bg-gray-700":"bg-black/5 hover:bg-black/10 active:bg-black/20 dark:bg-[rgba(255,255,255,0.04)] dark:hover:bg-white/5 dark:active:bg-white/10",r=c?"text-token-main-surface-primary":"text-token-main-surface-primary-inverse",u=t.formatMessage({id:"SRVwhB",defaultMessage:"Toggle video"});return S.jsx(Ce,{"aria-label":u,onClick:()=>n("ControlButton"),disabled:o,icon:s,className:a,iconColor:r})}function Ns({hideTooltip:e,microphoneLabel:n,isMicrophoneEnabled:t}){const{isMuting:s,toggleMute:o}=dt(),c=se(),{disconnectPending:a}=_e(),r=!!N(m=>{var k;return(k=m.dev.room)==null?void 0:k.localParticipant.isMicrophoneEnabled}),u=!!N(m=>{var k;return(k=m.dev.room)==null?void 0:k.localParticipant.isMicrophoneForceMuted}),f=t&&r,h=f?qn:Hn,g=f?"bg-black/5 hover:bg-black/10 active:bg-black/20 dark:bg-[rgba(255,255,255,0.04)] dark:hover:bg-white/5 dark:active:bg-white/10":"bg-red-500/10 hover:bg-red-500/15 active:bg-red-500/20 dark:bg-red-500/10 dark:hover:bg-red-500/15 dark:active:bg-red-500/20",l=f?"text-token-main-surface-primary-inverse":"text-danger",b=u?c.formatMessage({id:"bVgTcp",defaultMessage:"Microphone muted in system settings / hardware switch"}):f?c.formatMessage({id:"FI36QI",defaultMessage:"Turn off microphone"}):c.formatMessage({id:"j3oMt1",defaultMessage:"Turn on microphone"});return S.jsx(Ce,{"aria-label":b,onClick:o,icon:h,disabled:s||a||u,className:g,iconColor:l,tooltipPrimaryLabel:!e&&n?b:"",tooltipSecondaryLabel:n})}function Os(){const{screenshareTrackState:e,toggleScreenShare:n}=rt(),t=se();let s=null;const o=[R.Starting,R.Stopping].includes(e),c=e===R.Started;o?s=je:s=zn;const a=c?"bg-gray-900 hover:bg-gray-800 active:bg-gray-700":"bg-black/5 hover:bg-black/10 active:bg-black/20 dark:bg-[rgba(255,255,255,0.04)] dark:hover:bg-white/5 dark:active:bg-white/10",r=c?"text-token-main-surface-primary":"text-token-main-surface-primary-inverse",u=t.formatMessage({id:"ShdqyW",defaultMessage:"Toggle screenshare"});return S.jsx(Ce,{"aria-label":u,onClick:()=>n("ControlButton"),disabled:o,icon:s,className:a,iconColor:r})}function js({className:e,onClick:n}){const t=se(),{disconnectPending:s}=_e(),o="bg-black/5 hover:bg-black/10 active:bg-black/20 dark:bg-[rgba(255,255,255,0.04)] dark:hover:bg-white/5 dark:active:bg-white/10",c=t.formatMessage({id:"9Mto0a",defaultMessage:"End"});return S.jsx(Ce,{disabled:s,onClick:n,icon:s?je:Vn,iconColor:"text-token-main-surface-primary-inverse",className:e!=null?e:o,"aria-label":t.formatMessage({id:"7/8k4Y",defaultMessage:"End voice mode"}),tooltipPrimaryLabel:c})}function Ce(e){const T=e,{icon:n,disabled:t,className:s,iconColor:o="text-current",iconSize:c="icon-xl",buttonSize:a="h-16 w-16",tooltipPrimaryLabel:r,tooltipSecondaryLabel:u}=T,f=me(T,["icon","disabled","className","iconColor","iconSize","buttonSize","tooltipPrimaryLabel","tooltipSecondaryLabel"]),[h,g]=i.useState(!1),l=i.useRef(void 0),b=i.useCallback(()=>{clearTimeout(l.current);const d=window.setTimeout(()=>{g(!0)},zt);l.current=d},[]),m=i.useCallback(()=>{clearTimeout(l.current),g(!1)},[]);i.useEffect(()=>()=>{clearTimeout(l.current)},[]);const k=S.jsx(Us,Q(_({className:De(s,a,"text-token-text-primary hover:text-token-text-secondary overflow-hidden rounded-full border-none p-0.5 transition-colors duration-200 ease-in-out"),disabled:t},f),{children:S.jsx(n,{className:De(c,o)})}));return r?S.jsx(Ln,{sideOffset:14,label:r,secondaryLabel:u,contentClassName:"flex flex-col items-center justify-center",className:"flex",open:h,side:"top",children:S.jsx("span",{onPointerEnter:b,onPointerLeave:m,children:k})}):k}const Fs=i.forwardRef(function(n,t){return S.jsx(An,Q(_({},n),{ref:t}))}),Us=Ie.create(Fs),we=at({hint:{id:"micMessages.hint",defaultMessage:"Enable microphone access in Settings"},title:{id:"micMessages.title",defaultMessage:"Microphone access required"},description_markdown:{id:"micMessages.description_markdown",defaultMessage:"To use voice mode, you'll need to enable your microphone and try again."}});export{Ce as C,js as S,Ys as V,ot as W,Vs as a,Zs as b,St as c,_e as d,Ps as g,Ds as u};
//# sourceMappingURL=ep9fotatx7vn0ew6.js.map

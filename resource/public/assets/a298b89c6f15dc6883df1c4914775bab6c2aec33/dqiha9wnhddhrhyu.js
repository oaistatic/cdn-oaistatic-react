var D=Object.defineProperty,J=Object.defineProperties;var I=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var G=(e,t,n)=>t in e?D(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,O=(e,t)=>{for(var n in t||(t={}))K.call(t,n)&&G(e,n,t[n]);if(R)for(var n of R(t))Y.call(t,n)&&G(e,n,t[n]);return e},B=(e,t)=>J(e,I(t));var Q=(e,t)=>{var n={};for(var i in e)K.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&R)for(var i of R(e))t.indexOf(i)<0&&Y.call(e,i)&&(n[i]=e[i]);return n};import{bq as N,o as ee,p3 as te,aS as ne,bK as ie,br as T,aY as oe}from"./ewse8exzafeu10ji.js";import{cA as re,cz as l,is as se}from"./ny10lj7zpuz89fvf.js";import{d as ae,v as de}from"./n75kuy1cx6f5mogg.js";const h=ae({starting:{id:"jitPluginMessage.starting",defaultMessage:"Starting action"},confirmingSimple:{id:"jitPluginMessage.confirming.simple",defaultMessage:"{gizmoName} wants to talk to {domain}"},confirmingSubtitle:{id:"jitPluginMessage.confirming.subtitle",defaultMessage:"Only allow sites you trust."},running:{id:"jitPluginMessage.runningV4",defaultMessage:"Talking to {domain}"},finished:{id:"jitPluginMessage.finishedV4",defaultMessage:"Talked to {domain}"},stopped:{id:"jitPluginMessage.stoppedV4",defaultMessage:"Stopped talking to {domain}"},error:{id:"jitPluginMessage.errorV5",defaultMessage:"Error talking to {domain}"},declined:{id:"jitPluginMessage.declined",defaultMessage:"You declined this action"},ranTest:{id:"jitPluginMessage.ranTest",defaultMessage:"Tested {operationName}"},confirmParamsTitle:{id:"jitPluginMessage.confirmParamsTitleV3",defaultMessage:"{gizmoName} wants to share this info with {domain}"},sentParamsTitle:{id:"jitPluginMessage.sentParamsTitleV2",defaultMessage:"{gizmoName} sent this info to {domain}"},privacyPolicyLink:{id:"jitPluginMessage.privacyPolicyLinkV2",defaultMessage:"Privacy policy"},connectorDeclined:{id:"jitPluginMessage.connectorDeclined",defaultMessage:"Declined connection to {domain}"},rememberForThisConversation:{id:"jitPluginMessage.rememberForThisConversation",defaultMessage:"Remember for this conversation"}});var f=(e=>(e[e.Running=0]="Running",e[e.Finished=1]="Finished",e[e.Error=2]="Error",e[e.Stopped=3]="Stopped",e[e.OauthLogin=4]="OauthLogin",e[e.NoAuthLink=5]="NoAuthLink",e[e.UserConfirmation=6]="UserConfirmation",e[e.Denied=7]="Denied",e[e.Hidden=8]="Hidden",e))(f||{});const ce=e=>{const[t,...n]=e,i=n.filter(u=>u.author.role===T.Tool),o=i.filter(u=>{var d,s,p;return((p=(s=(d=u.metadata)==null?void 0:d.jit_plugin_data)==null?void 0:s.from_server)==null?void 0:p.type)==="debug"}),r=i.filter(u=>!["debug","send_test"].some(d=>{var s,p,v;return d===((v=(p=(s=u.metadata)==null?void 0:s.jit_plugin_data)==null?void 0:p.from_server)==null?void 0:v.type)})),a=i[i.length-1];return{assistantMessage:t,toolMessages:i,debugMessages:o,actionableMessages:r,lastToolMessage:a}},X=new WeakMap,z=e=>{const t=X.get(e);if(t)return t;const n=ce(e);return X.set(e,n),n};function ue(e){if(e&&"user_action"in e){const t=e.user_action;e=O(O({},e),t.data),"target_message_id"in e&&t.target_message_id&&(e.target_message_id=t.target_message_id)}return e}function Z(e,t){var n,i,o,r;return((n=e==null?void 0:e.from_server)==null?void 0:n.type)==="confirm_action"?(o=(i=e==null?void 0:e.from_server)==null?void 0:i.body)==null?void 0:o.operation:(r=t==null?void 0:t.parsed_function_call)==null?void 0:r.name}function ye(e,t){var r,a;const{jitPluginData:n,invokedPlugin:i,lastConfirmActionJitPluginData:o}=C(e,t);return(a=(r=Z(n,i))!=null?r:Z(o,void 0))!=null?a:""}function ke(e,t){var n,i,o,r;return((n=e==null?void 0:e.from_server)==null?void 0:n.type)==="confirm_action"?(o=(i=e==null?void 0:e.from_server)==null?void 0:i.body)==null?void 0:o.params:(r=t==null?void 0:t.parsed_function_call)==null?void 0:r.kwargs}function C(e,t){var r,a,u,d,s,p,v,y,k,A,S,b,M,j,w,E,q,x;const{assistantMessage:n,actionableMessages:i}=z(e);let o;for(let g=i.length-1;g>=0;g--){const c=(r=i[g].metadata)==null?void 0:r.jit_plugin_data;if(((a=c==null?void 0:c.from_server)==null?void 0:a.type)==="confirm_action"){o=c;break}}if(((s=(d=(u=n.metadata)==null?void 0:u.jit_plugin_data)==null?void 0:d.from_server)==null?void 0:s.type)==="send_test")return{uiState:f.Hidden,lastConfirmActionJitPluginData:o,jitPluginData:void 0,invokedPlugin:void 0,fileAttachments:void 0};if(i.some(g=>g.content.content_type===N.SystemError))return{uiState:f.Error,lastConfirmActionJitPluginData:o,jitPluginData:void 0,invokedPlugin:void 0,fileAttachments:void 0};if(re(n))return{uiState:f.Stopped,lastConfirmActionJitPluginData:o,jitPluginData:void 0,invokedPlugin:void 0,fileAttachments:void 0};for(let g=i.length-1;g>=0;g--){const c=i[g];if((p=c.metadata)!=null&&p.invoked_plugin){const V=[];return i.forEach(P=>{var W,L;const H=(L=(W=P.metadata)==null?void 0:W.attachments)==null?void 0:L.filter(U=>U.display_files_from_actions_ext);H&&V.push(...H)}),{uiState:f.Finished,lastConfirmActionJitPluginData:o,jitPluginData:c.metadata.jit_plugin_data,invokedPlugin:c.metadata.invoked_plugin,fileAttachments:V}}const m=ue((y=(v=c.metadata)==null?void 0:v.jit_plugin_data)==null?void 0:y.from_client);if(m!=null){if((m==null?void 0:m.type)==="contact_gizmo")return{uiState:f.Finished,lastConfirmActionJitPluginData:o,jitPluginData:(A=(k=i[g-1])==null?void 0:k.metadata)==null?void 0:A.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};if((m==null?void 0:m.type)==="deny")return{uiState:f.Denied,lastConfirmActionJitPluginData:o,jitPluginData:void 0,invokedPlugin:void 0,fileAttachments:void 0};if((m==null?void 0:m.type)==="oauth_success")return{uiState:f.Running,lastConfirmActionJitPluginData:o,jitPluginData:(S=c.metadata)==null?void 0:S.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};if((m==null?void 0:m.type)==="link_success")return{uiState:f.Running,lastConfirmActionJitPluginData:o,jitPluginData:(b=c.metadata)==null?void 0:b.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};break}const _=(j=(M=c.metadata)==null?void 0:M.jit_plugin_data)==null?void 0:j.from_server;if((_==null?void 0:_.type)==="preview"&&t)return{uiState:f.Running,lastConfirmActionJitPluginData:o,jitPluginData:(w=c.metadata)==null?void 0:w.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};if((_==null?void 0:_.type)==="confirm_action"&&t)return{uiState:f.UserConfirmation,lastConfirmActionJitPluginData:o,jitPluginData:(E=c.metadata)==null?void 0:E.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};if((_==null?void 0:_.type)==="oauth_required"&&t)return{uiState:f.OauthLogin,lastConfirmActionJitPluginData:o,jitPluginData:(q=c.metadata)==null?void 0:q.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};if((_==null?void 0:_.type)==="link_required"&&t)return{uiState:f.NoAuthLink,lastConfirmActionJitPluginData:o,jitPluginData:(x=c.metadata)==null?void 0:x.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0}}return{uiState:t?f.Running:f.Stopped,lastConfirmActionJitPluginData:o,jitPluginData:void 0,invokedPlugin:void 0,fileAttachments:void 0}}function Ae(e,t,n,i){var p,v,y,k,A,S,b,M,j,w;var o=(p=te(e,n))!=null?p:void 0;if(!o)return{connectorId:void 0,connectorToolStatus:null,connectorStatusMessage:null,showConnectorConnect:!1};if(t===e)return{connectorId:o,connectorToolStatus:null,connectorStatusMessage:null,showConnectorConnect:!1};var r=l.Running,a=null,u=!1;const d=n[n.length-1],s=(v=d==null?void 0:d.metadata)==null?void 0:v.jit_plugin_data;return n.some(E=>E.content.content_type===N.SystemError)?(r=l.Error,a=h.error):d?((y=s==null?void 0:s.from_server)==null?void 0:y.type)==="oauth_required"&&i?(r=l.Paused,a=null,u=!0):((k=s==null?void 0:s.from_server)==null?void 0:k.type)==="link_required"&&i?(r=l.Paused,a=null,u=!0):(((A=s==null?void 0:s.from_server)==null?void 0:A.type)==="oauth_required"||((S=s==null?void 0:s.from_server)==null?void 0:S.type)==="link_required")&&!i?(r=l.Stopped,a=h.connectorDeclined):((b=s==null?void 0:s.from_client)==null?void 0:b.type)==="deny"?(r=l.Stopped,a=h.connectorDeclined):((M=s==null?void 0:s.from_client)==null?void 0:M.type)==="oauth_success"?(r=l.Stopped,a=null):((j=s==null?void 0:s.from_client)==null?void 0:j.type)==="link_success"?(r=l.Stopped,a=null):(w=d==null?void 0:d.metadata)!=null&&w.invoked_plugin?(r=l.Finished,a=h.finished):(r=l.Stopped,a=h.stopped):(r=l.Running,a=h.running),{connectorId:o,connectorToolStatus:r,connectorStatusMessage:a,showConnectorConnect:u}}function fe({recipient:e,actionData:t,gizmoId:n}){return{id:de(),author:{role:T.Tool,name:e},content:{content_type:N.Text,parts:[""]},recipient:"all",metadata:{jit_plugin_data:{from_client:t},gizmo_id:n},clientMetadata:{completionSampleFinishTime:Date.now()}}}function Se(a){var u=a,{clientThreadId:e,actionData:t,assistantMessage:n,onRequestCompletion:i,activeSystemHint:o}=u,r=Q(u,["clientThreadId","actionData","assistantMessage","onRequestCompletion","activeSystemHint"]);var s;const d=(s=ne(e))==null?void 0:s.mode;i(B(O({},r),{promptMessage:fe({recipient:n.recipient,actionData:t,gizmoId:d&&"gizmo_id"in d?d.gizmo_id:void 0}),completionMetadata:{conversationMode:d!=null?d:{kind:ie.PrimaryAssistant},systemHints:o?[o]:void 0}}))}function be(e,t){if(e.type!==ee.JIT_PLUGIN||!e.metadata.json_schema)return!1;let n=!1;function i(o){for(const r in o)r==="operationId"&&o[r]===t&&(n=!0),o[r]&&typeof o[r]=="object"&&i(o[r])}return i(e.metadata.json_schema),n}function $(e){var t,n,i;if(e&&(((t=e.from_server)==null?void 0:t.type)==="confirm_action"||((n=e.from_server)==null?void 0:n.type)==="oauth_required"||((i=e.from_server)==null?void 0:i.type)==="preview"))return e.from_server.body.params}function F(e){var t,n,i;if(e&&(((t=e.from_server)==null?void 0:t.type)==="confirm_action"||((n=e.from_server)==null?void 0:n.type)==="preview"))return(i=e.from_server.body.tool_call_safety_summary)!=null?i:void 0}function me(e){const t=oe(e);if(t)try{return JSON.parse(t)}catch(n){return{text:t}}}function Me(e,t){var r,a;const{assistantMessage:n}=z(e),{jitPluginData:i,lastConfirmActionJitPluginData:o}=C(e,t);return(a=(r=$(i))!=null?r:$(o))!=null?a:me(n)}function je(e,t){var o,r;const{jitPluginData:n,lastConfirmActionJitPluginData:i}=C(e,t);return(r=(o=F(n))!=null?o:F(i))!=null?r:void 0}function _e(e){if(!e)return;const t=e.content.content_type===N.Text?e.content.parts[0]:e.content.content_type===N.Code?e.content.text:void 0;if(t)try{return JSON.parse(t)}catch(n){return t}}const we=e=>{const{lastToolMessage:t}=z(e);return _e(t)},Ne=(e,t)=>{var i,o,r,a;const{jitPluginData:n}=C(e,t);return((i=n==null?void 0:n.from_server)==null?void 0:i.type)==="confirm_action"?(a=(r=(o=n==null?void 0:n.from_server)==null?void 0:o.body)==null?void 0:r.offer_remember_answer)!=null?a:!0:!1},pe=(e,t)=>{var i,o;const{jitPluginData:n}=C(e,t);return((i=n==null?void 0:n.from_server)==null?void 0:i.type)!=="denied_by_user"&&!!((o=n==null?void 0:n.from_server)!=null&&o.body.actions.length)},Ce=(e,t)=>se(e)&&pe(e,t);export{f as J,Ne as a,Me as b,Ce as c,be as d,Ae as e,ue as f,C as g,Se as h,h as i,je as j,we as k,ye as l,ke as m,z as p};
//# sourceMappingURL=dqiha9wnhddhrhyu.js.map

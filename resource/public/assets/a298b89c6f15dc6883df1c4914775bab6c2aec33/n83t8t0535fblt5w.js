var jo=Object.defineProperty,qo=Object.defineProperties;var Wo=Object.getOwnPropertyDescriptors;var at=Object.getOwnPropertySymbols;var on=Object.prototype.hasOwnProperty,rn=Object.prototype.propertyIsEnumerable;var an=e=>{throw TypeError(e)};var kt=(e,n,t)=>n in e?jo(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,te=(e,n)=>{for(var t in n||(n={}))on.call(n,t)&&kt(e,t,n[t]);if(at)for(var t of at(n))rn.call(n,t)&&kt(e,t,n[t]);return e},xe=(e,n)=>qo(e,Wo(n));var sn=(e,n)=>{var t={};for(var o in e)on.call(e,o)&&n.indexOf(o)<0&&(t[o]=e[o]);if(e!=null&&at)for(var o of at(e))n.indexOf(o)<0&&rn.call(e,o)&&(t[o]=e[o]);return t};var ae=(e,n,t)=>kt(e,typeof n!="symbol"?n+"":n,t),cn=(e,n,t)=>n.has(e)||an("Cannot "+t);var G=(e,n,t)=>(cn(e,n,"read from private field"),t?t.call(e):n.get(e)),ke=(e,n,t)=>n.has(e)?an("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(e):n.set(e,t),_e=(e,n,t,o)=>(cn(e,n,"write to private field"),o?o.call(e,t):n.set(e,t),t);import{aN as Ho,O as $o,L as Nt,p as Bn,f as jn,l as Go,b8 as st,aQ as Ko,j8 as W,cr as qn,eK as Wn,m6 as Yo,uv as Qo,i as $t,dg as Xo,d5 as pt,mb as Hn,bN as Jo,bK as Ut,cs as Zo,aR as zt,aS as Vt,fs as er,eQ as tr,uw as un,bW as nr,ux as or,bv as rr,s0 as ir,hG as ar,x as Bt,bU as sr,_ as $n,e as Ve,B as ct,E as ln,y as cr,U as ur,ae as lr,P as dr,f4 as fr,at as pr}from"./ewse8exzafeu10ji.js";import{r as u,j as k,g as mr,u as Gn,b as Kn,h as vr,M as Re,m as hr}from"./n75kuy1cx6f5mogg.js";import{gb as Yn,lB as ue,mH as Qn,mB as gr,xJ as br,uA as re,xK as Sr,xL as yr,xM as Ue,xN as dn,xO as wr,xP as Cr,xQ as Tr,xR as xr,xS as Xn,xT as jt,xU as kr,xV as Ar,xW as _r,xX as Mr,xY as Er,xZ as Dr,x_ as Ir,x$ as Rr,y0 as Pr,uU as Jn,uQ as he,uV as Lr,y1 as Je,y2 as mt,lE as Me,f as Fr,uX as Z,y3 as Or,y4 as Zn,mD as Ie,bQ as eo,sk as Nr,uB as Ur,y5 as Se,uS as to,y6 as zr,y7 as Vr,y8 as Br,y9 as jr,ya as qr,uH as fn,uG as Wr,uF as Hr,uE as pn,k_ as $r,yb as Gr,yc as Kr,uC as Yr,yd as no,xo as Qr,xp as Xr,uW as Jr,lC as At,ye as Zr,dm as ei,dF as ti}from"./ny10lj7zpuz89fvf.js";import{u as ni}from"./kq6o2ff0g84prlfu.js";import{d as oi,a as A,T as ge,P as N,e as fe,C as se}from"./kg55sov6c624o43c.js";const ri=Ho(void 0),Ps=()=>$o(ri),ii=()=>Yn().some(n=>n.voice==="shade"),mn=Bn.JumpToShade,ai=()=>{const e=Nt.getItem(mn)==="true",n=u.useCallback(()=>{Nt.setItem(mn,"true")},[]);return{alreadyTriggered:e,setAlreadyTriggered:n}},si=()=>{const e=jn(),n=ue(),t=u.useCallback(()=>n.getState().isVoiceModeActive,[n]);return u.useMemo(()=>new Proxy(e,{get(o,r){const i=o[r];return t()||r==="closeAll"?i:()=>{}}}),[t,e])},vn=async(e,n)=>{var o;n||(n=await Qn.getLocalDevices());const t=(o=n.find(r=>r.deviceId===e))==null?void 0:o.label;return t!=null?t:e};function oo(){var t,o,r,i;const e=gr();if(!e)return{video:!1,screenshare:!1};const n=br(e);return{video:(o=(t=n==null?void 0:n.features)==null?void 0:t.video)!=null?o:!1,screenshare:(i=(r=n==null?void 0:n.features)==null?void 0:r.screen_sharing)!=null?i:!1}}var ci=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ui(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ro={exports:{}};(function(e){(function(n,t){e.exports?e.exports=t():n.log=t()})(ci,function(){var n=function(){},t="undefined",o=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],i={},a=null;function l(p,h){var y=p[h];if(typeof y.bind=="function")return y.bind(p);try{return Function.prototype.bind.call(y,p)}catch(b){return function(){return Function.prototype.apply.apply(y,[p,arguments])}}}function s(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(p){return p==="debug"&&(p="log"),typeof console===t?!1:p==="trace"&&o?s:console[p]!==void 0?l(console,p):console.log!==void 0?l(console,"log"):n}function f(){for(var p=this.getLevel(),h=0;h<r.length;h++){var y=r[h];this[y]=h<p?n:this.methodFactory(y,p,this.name)}if(this.log=this.debug,typeof console===t&&p<this.levels.SILENT)return"No console available for logging"}function m(p){return function(){typeof console!==t&&(f.call(this),this[p].apply(this,arguments))}}function v(p,h,y){return c(p)||m.apply(this,arguments)}function d(p,h){var y=this,b,S,D,P="loglevel";typeof p=="string"?P+=":"+p:typeof p=="symbol"&&(P=void 0);function H(E){var U=(r[E]||"silent").toUpperCase();if(!(typeof window===t||!P)){try{window.localStorage[P]=U;return}catch(K){}try{window.document.cookie=encodeURIComponent(P)+"="+U+";"}catch(K){}}}function $(){var E;if(!(typeof window===t||!P)){try{E=window.localStorage[P]}catch(I){}if(typeof E===t)try{var U=window.document.cookie,K=encodeURIComponent(P),T=U.indexOf(K+"=");T!==-1&&(E=/^([^;]+)/.exec(U.slice(T+K.length+1))[1])}catch(I){}return y.levels[E]===void 0&&(E=void 0),E}}function le(){if(!(typeof window===t||!P)){try{window.localStorage.removeItem(P)}catch(E){}try{window.document.cookie=encodeURIComponent(P)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(E){}}}function O(E){var U=E;if(typeof U=="string"&&y.levels[U.toUpperCase()]!==void 0&&(U=y.levels[U.toUpperCase()]),typeof U=="number"&&U>=0&&U<=y.levels.SILENT)return U;throw new TypeError("log.setLevel() called with invalid level: "+E)}y.name=p,y.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},y.methodFactory=h||v,y.getLevel=function(){var E;return(E=D!=null?D:S)!=null?E:b},y.setLevel=function(E,U){return D=O(E),U!==!1&&H(D),f.call(y)},y.setDefaultLevel=function(E){S=O(E),$()||y.setLevel(E,!1)},y.resetLevel=function(){D=null,le(),f.call(y)},y.enableAll=function(E){y.setLevel(y.levels.TRACE,E)},y.disableAll=function(E){y.setLevel(y.levels.SILENT,E)},y.rebuild=function(){if(a!==y&&(b=O(a.getLevel())),f.call(y),a===y)for(var E in i)i[E].rebuild()},b=O(a?a.getLevel():"WARN");var X=$();X!=null&&(D=O(X)),f.call(y)}a=new d,a.getLogger=function(p){if(typeof p!="symbol"&&typeof p!="string"||p==="")throw new TypeError("You must supply a name when creating a logger.");var h=i[p];return h||(h=i[p]=new d(p,a.methodFactory)),h};var g=typeof window!==t?window.log:void 0;return a.noConflict=function(){return typeof window!==t&&window.log===a&&(window.log=g),a},a.getLoggers=function(){return i},a.default=a,a})})(ro);var li=ro.exports;const di=ui(li);var qt=function(e,n){return qt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,o){t.__proto__=o}||function(t,o){for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r])},qt(e,n)};function Ae(e,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");qt(e,n);function t(){this.constructor=e}e.prototype=n===null?Object.create(n):(t.prototype=n.prototype,new t)}function fi(e,n,t,o){function r(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function l(f){try{c(o.next(f))}catch(m){a(m)}}function s(f){try{c(o.throw(f))}catch(m){a(m)}}function c(f){f.done?i(f.value):r(f.value).then(l,s)}c((o=o.apply(e,[])).next())})}function io(e,n){var t={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return a.next=l(0),a.throw=l(1),a.return=l(2),typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function l(c){return function(f){return s([c,f])}}function s(c){if(o)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(t=0)),t;)try{if(o=1,r&&(i=c[0]&2?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[c[0]&2,i.value]),c[0]){case 0:case 1:i=c;break;case 4:return t.label++,{value:c[1],done:!1};case 5:t.label++,r=c[1],c=[0];continue;case 7:c=t.ops.pop(),t.trys.pop();continue;default:if(i=t.trys,!(i=i.length>0&&i[i.length-1])&&(c[0]===6||c[0]===2)){t=0;continue}if(c[0]===3&&(!i||c[1]>i[0]&&c[1]<i[3])){t.label=c[1];break}if(c[0]===6&&t.label<i[1]){t.label=i[1],i=c;break}if(i&&t.label<i[2]){t.label=i[2],t.ops.push(c);break}i[2]&&t.ops.pop(),t.trys.pop();continue}c=n.call(e,t)}catch(f){c=[6,f],r=0}finally{o=i=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function He(e){var n=typeof Symbol=="function"&&Symbol.iterator,t=n&&e[n],o=0;if(t)return t.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&o>=e.length&&(e=void 0),{value:e&&e[o++],done:!e}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")}function vt(e,n){var t=typeof Symbol=="function"&&e[Symbol.iterator];if(!t)return e;var o=t.call(e),r,i=[],a;try{for(;(n===void 0||n-- >0)&&!(r=o.next()).done;)i.push(r.value)}catch(l){a={error:l}}finally{try{r&&!r.done&&(t=o.return)&&t.call(o)}finally{if(a)throw a.error}}return i}function ht(e,n,t){if(arguments.length===2)for(var o=0,r=n.length,i;o<r;o++)(i||!(o in n))&&(i||(i=Array.prototype.slice.call(n,0,o)),i[o]=n[o]);return e.concat(i||Array.prototype.slice.call(n))}function Be(e){return this instanceof Be?(this.v=e,this):new Be(e)}function pi(e,n,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var o=t.apply(e,n||[]),r,i=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),l("next"),l("throw"),l("return",a),r[Symbol.asyncIterator]=function(){return this},r;function a(d){return function(g){return Promise.resolve(g).then(d,m)}}function l(d,g){o[d]&&(r[d]=function(p){return new Promise(function(h,y){i.push([d,p,h,y])>1||s(d,p)})},g&&(r[d]=g(r[d])))}function s(d,g){try{c(o[d](g))}catch(p){v(i[0][3],p)}}function c(d){d.value instanceof Be?Promise.resolve(d.value.v).then(f,m):v(i[0][2],d)}function f(d){s("next",d)}function m(d){s("throw",d)}function v(d,g){d(g),i.shift(),i.length&&s(i[0][0],i[0][1])}}function mi(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=e[Symbol.asyncIterator],t;return n?n.call(e):(e=typeof He=="function"?He(e):e[Symbol.iterator](),t={},o("next"),o("throw"),o("return"),t[Symbol.asyncIterator]=function(){return this},t);function o(i){t[i]=e[i]&&function(a){return new Promise(function(l,s){a=e[i](a),r(l,s,a.done,a.value)})}}function r(i,a,l,s){Promise.resolve(s).then(function(c){i({value:c,done:l})},a)}}function Q(e){return typeof e=="function"}function Gt(e){var n=function(o){Error.call(o),o.stack=new Error().stack},t=e(n);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var _t=Gt(function(e){return function(n){e(this),this.message=n?n.length+" errors occurred during unsubscription:\n"+n.map(function(t,o){return o+1+") "+t.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=n}});function gt(e,n){if(e){var t=e.indexOf(n);0<=t&&e.splice(t,1)}}var et=function(){function e(n){this.initialTeardown=n,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var n,t,o,r,i;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var l=He(a),s=l.next();!s.done;s=l.next()){var c=s.value;c.remove(this)}}catch(p){n={error:p}}finally{try{s&&!s.done&&(t=l.return)&&t.call(l)}finally{if(n)throw n.error}}else a.remove(this);var f=this.initialTeardown;if(Q(f))try{f()}catch(p){i=p instanceof _t?p.errors:[p]}var m=this._finalizers;if(m){this._finalizers=null;try{for(var v=He(m),d=v.next();!d.done;d=v.next()){var g=d.value;try{hn(g)}catch(p){i=i!=null?i:[],p instanceof _t?i=ht(ht([],vt(i)),vt(p.errors)):i.push(p)}}}catch(p){o={error:p}}finally{try{d&&!d.done&&(r=v.return)&&r.call(v)}finally{if(o)throw o.error}}}if(i)throw new _t(i)}},e.prototype.add=function(n){var t;if(n&&n!==this)if(this.closed)hn(n);else{if(n instanceof e){if(n.closed||n._hasParent(this))return;n._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(n)}},e.prototype._hasParent=function(n){var t=this._parentage;return t===n||Array.isArray(t)&&t.includes(n)},e.prototype._addParent=function(n){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(n),t):t?[t,n]:n},e.prototype._removeParent=function(n){var t=this._parentage;t===n?this._parentage=null:Array.isArray(t)&&gt(t,n)},e.prototype.remove=function(n){var t=this._finalizers;t&&gt(t,n),n instanceof e&&n._removeParent(this)},e.EMPTY=function(){var n=new e;return n.closed=!0,n}(),e}(),ao=et.EMPTY;function so(e){return e instanceof et||e&&"closed"in e&&Q(e.remove)&&Q(e.add)&&Q(e.unsubscribe)}function hn(e){Q(e)?e():e.unsubscribe()}var vi={Promise:void 0},hi={setTimeout:function(e,n){for(var t=[],o=2;o<arguments.length;o++)t[o-2]=arguments[o];return setTimeout.apply(void 0,ht([e,n],vt(t)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function co(e){hi.setTimeout(function(){throw e})}function gn(){}function lt(e){e()}var Kt=function(e){Ae(n,e);function n(t){var o=e.call(this)||this;return o.isStopped=!1,t?(o.destination=t,so(t)&&t.add(o)):o.destination=Si,o}return n.create=function(t,o,r){return new Wt(t,o,r)},n.prototype.next=function(t){this.isStopped||this._next(t)},n.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},n.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},n.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},n.prototype._next=function(t){this.destination.next(t)},n.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},n.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},n}(et),gi=function(){function e(n){this.partialObserver=n}return e.prototype.next=function(n){var t=this.partialObserver;if(t.next)try{t.next(n)}catch(o){ut(o)}},e.prototype.error=function(n){var t=this.partialObserver;if(t.error)try{t.error(n)}catch(o){ut(o)}else ut(n)},e.prototype.complete=function(){var n=this.partialObserver;if(n.complete)try{n.complete()}catch(t){ut(t)}},e}(),Wt=function(e){Ae(n,e);function n(t,o,r){var i=e.call(this)||this,a;return Q(t)||!t?a={next:t!=null?t:void 0,error:o!=null?o:void 0,complete:r!=null?r:void 0}:a=t,i.destination=new gi(a),i}return n}(Kt);function ut(e){co(e)}function bi(e){throw e}var Si={closed:!0,next:gn,error:bi,complete:gn},Yt=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function uo(e){return e}function yi(e){return e.length===0?uo:e.length===1?e[0]:function(n){return e.reduce(function(t,o){return o(t)},n)}}var ce=function(){function e(n){n&&(this._subscribe=n)}return e.prototype.lift=function(n){var t=new e;return t.source=this,t.operator=n,t},e.prototype.subscribe=function(n,t,o){var r=this,i=Ci(n)?n:new Wt(n,t,o);return lt(function(){var a=r,l=a.operator,s=a.source;i.add(l?l.call(i,s):s?r._subscribe(i):r._trySubscribe(i))}),i},e.prototype._trySubscribe=function(n){try{return this._subscribe(n)}catch(t){n.error(t)}},e.prototype.forEach=function(n,t){var o=this;return t=bn(t),new t(function(r,i){var a=new Wt({next:function(l){try{n(l)}catch(s){i(s),a.unsubscribe()}},error:i,complete:r});o.subscribe(a)})},e.prototype._subscribe=function(n){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(n)},e.prototype[Yt]=function(){return this},e.prototype.pipe=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return yi(n)(this)},e.prototype.toPromise=function(n){var t=this;return n=bn(n),new n(function(o,r){var i;t.subscribe(function(a){return i=a},function(a){return r(a)},function(){return o(i)})})},e.create=function(n){return new e(n)},e}();function bn(e){var n;return(n=e!=null?e:vi.Promise)!==null&&n!==void 0?n:Promise}function wi(e){return e&&Q(e.next)&&Q(e.error)&&Q(e.complete)}function Ci(e){return e&&e instanceof Kt||wi(e)&&so(e)}function Ti(e){return Q(e==null?void 0:e.lift)}function tt(e){return function(n){if(Ti(n))return n.lift(function(t){try{return e(t,this)}catch(o){this.error(o)}});throw new TypeError("Unable to lift unknown Observable type")}}function bt(e,n,t,o,r){return new xi(e,n,t,o,r)}var xi=function(e){Ae(n,e);function n(t,o,r,i,a,l){var s=e.call(this,t)||this;return s.onFinalize=a,s.shouldUnsubscribe=l,s._next=o?function(c){try{o(c)}catch(f){t.error(f)}}:e.prototype._next,s._error=i?function(c){try{i(c)}catch(f){t.error(f)}finally{this.unsubscribe()}}:e.prototype._error,s._complete=r?function(){try{r()}catch(c){t.error(c)}finally{this.unsubscribe()}}:e.prototype._complete,s}return n.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var o=this.closed;e.prototype.unsubscribe.call(this),!o&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},n}(Kt),ki=Gt(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),lo=function(e){Ae(n,e);function n(){var t=e.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return n.prototype.lift=function(t){var o=new Sn(this,this);return o.operator=t,o},n.prototype._throwIfClosed=function(){if(this.closed)throw new ki},n.prototype.next=function(t){var o=this;lt(function(){var r,i;if(o._throwIfClosed(),!o.isStopped){o.currentObservers||(o.currentObservers=Array.from(o.observers));try{for(var a=He(o.currentObservers),l=a.next();!l.done;l=a.next()){var s=l.value;s.next(t)}}catch(c){r={error:c}}finally{try{l&&!l.done&&(i=a.return)&&i.call(a)}finally{if(r)throw r.error}}}})},n.prototype.error=function(t){var o=this;lt(function(){if(o._throwIfClosed(),!o.isStopped){o.hasError=o.isStopped=!0,o.thrownError=t;for(var r=o.observers;r.length;)r.shift().error(t)}})},n.prototype.complete=function(){var t=this;lt(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var o=t.observers;o.length;)o.shift().complete()}})},n.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(n.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),n.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},n.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},n.prototype._innerSubscribe=function(t){var o=this,r=this,i=r.hasError,a=r.isStopped,l=r.observers;return i||a?ao:(this.currentObservers=null,l.push(t),new et(function(){o.currentObservers=null,gt(l,t)}))},n.prototype._checkFinalizedStatuses=function(t){var o=this,r=o.hasError,i=o.thrownError,a=o.isStopped;r?t.error(i):a&&t.complete()},n.prototype.asObservable=function(){var t=new ce;return t.source=this,t},n.create=function(t,o){return new Sn(t,o)},n}(ce),Sn=function(e){Ae(n,e);function n(t,o){var r=e.call(this)||this;return r.destination=t,r.source=o,r}return n.prototype.next=function(t){var o,r;(r=(o=this.destination)===null||o===void 0?void 0:o.next)===null||r===void 0||r.call(o,t)},n.prototype.error=function(t){var o,r;(r=(o=this.destination)===null||o===void 0?void 0:o.error)===null||r===void 0||r.call(o,t)},n.prototype.complete=function(){var t,o;(o=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||o===void 0||o.call(t)},n.prototype._subscribe=function(t){var o,r;return(r=(o=this.source)===null||o===void 0?void 0:o.subscribe(t))!==null&&r!==void 0?r:ao},n}(lo);(function(e){Ae(n,e);function n(t){var o=e.call(this)||this;return o._value=t,o}return Object.defineProperty(n.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),n.prototype._subscribe=function(t){var o=e.prototype._subscribe.call(this,t);return!o.closed&&t.next(this._value),o},n.prototype.getValue=function(){var t=this,o=t.hasError,r=t.thrownError,i=t._value;if(o)throw r;return this._throwIfClosed(),i},n.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},n})(lo);var Ai={now:function(){return Date.now()}},_i=function(e){Ae(n,e);function n(t,o){return e.call(this)||this}return n.prototype.schedule=function(t,o){return this},n}(et),yn={setInterval:function(e,n){for(var t=[],o=2;o<arguments.length;o++)t[o-2]=arguments[o];return setInterval.apply(void 0,ht([e,n],vt(t)))},clearInterval:function(e){return clearInterval(e)},delegate:void 0},Mi=function(e){Ae(n,e);function n(t,o){var r=e.call(this,t,o)||this;return r.scheduler=t,r.work=o,r.pending=!1,r}return n.prototype.schedule=function(t,o){var r;if(o===void 0&&(o=0),this.closed)return this;this.state=t;var i=this.id,a=this.scheduler;return i!=null&&(this.id=this.recycleAsyncId(a,i,o)),this.pending=!0,this.delay=o,this.id=(r=this.id)!==null&&r!==void 0?r:this.requestAsyncId(a,this.id,o),this},n.prototype.requestAsyncId=function(t,o,r){return r===void 0&&(r=0),yn.setInterval(t.flush.bind(t,this),r)},n.prototype.recycleAsyncId=function(t,o,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return o;o!=null&&yn.clearInterval(o)},n.prototype.execute=function(t,o){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(t,o);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},n.prototype._execute=function(t,o){var r=!1,i;try{this.work(t)}catch(a){r=!0,i=a||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),i},n.prototype.unsubscribe=function(){if(!this.closed){var t=this,o=t.id,r=t.scheduler,i=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,gt(i,this),o!=null&&(this.id=this.recycleAsyncId(r,o,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},n}(_i),wn=function(){function e(n,t){t===void 0&&(t=e.now),this.schedulerActionCtor=n,this.now=t}return e.prototype.schedule=function(n,t,o){return t===void 0&&(t=0),new this.schedulerActionCtor(this,n).schedule(o,t)},e.now=Ai.now,e}(),Ei=function(e){Ae(n,e);function n(t,o){o===void 0&&(o=wn.now);var r=e.call(this,t,o)||this;return r.actions=[],r._active=!1,r}return n.prototype.flush=function(t){var o=this.actions;if(this._active){o.push(t);return}var r;this._active=!0;do if(r=t.execute(t.state,t.delay))break;while(t=o.shift());if(this._active=!1,r){for(;t=o.shift();)t.unsubscribe();throw r}},n}(wn);new Ei(Mi);function Di(e){return e&&Q(e.schedule)}function Ii(e){return e[e.length-1]}function fo(e){return Di(Ii(e))?e.pop():void 0}var po=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function mo(e){return Q(e==null?void 0:e.then)}function vo(e){return Q(e[Yt])}function ho(e){return Symbol.asyncIterator&&Q(e==null?void 0:e[Symbol.asyncIterator])}function go(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Ri(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var bo=Ri();function So(e){return Q(e==null?void 0:e[bo])}function yo(e){return pi(this,arguments,function(){var n,t,o,r;return io(this,function(i){switch(i.label){case 0:n=e.getReader(),i.label=1;case 1:i.trys.push([1,,9,10]),i.label=2;case 2:return[4,Be(n.read())];case 3:return t=i.sent(),o=t.value,r=t.done,r?[4,Be(void 0)]:[3,5];case 4:return[2,i.sent()];case 5:return[4,Be(o)];case 6:return[4,i.sent()];case 7:return i.sent(),[3,2];case 8:return[3,10];case 9:return n.releaseLock(),[7];case 10:return[2]}})})}function wo(e){return Q(e==null?void 0:e.getReader)}function nt(e){if(e instanceof ce)return e;if(e!=null){if(vo(e))return Pi(e);if(po(e))return Li(e);if(mo(e))return Fi(e);if(ho(e))return Co(e);if(So(e))return Oi(e);if(wo(e))return Ni(e)}throw go(e)}function Pi(e){return new ce(function(n){var t=e[Yt]();if(Q(t.subscribe))return t.subscribe(n);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Li(e){return new ce(function(n){for(var t=0;t<e.length&&!n.closed;t++)n.next(e[t]);n.complete()})}function Fi(e){return new ce(function(n){e.then(function(t){n.closed||(n.next(t),n.complete())},function(t){return n.error(t)}).then(null,co)})}function Oi(e){return new ce(function(n){var t,o;try{for(var r=He(e),i=r.next();!i.done;i=r.next()){var a=i.value;if(n.next(a),n.closed)return}}catch(l){t={error:l}}finally{try{i&&!i.done&&(o=r.return)&&o.call(r)}finally{if(t)throw t.error}}n.complete()})}function Co(e){return new ce(function(n){Ui(e,n).catch(function(t){return n.error(t)})})}function Ni(e){return Co(yo(e))}function Ui(e,n){var t,o,r,i;return fi(this,void 0,void 0,function(){var a,l;return io(this,function(s){switch(s.label){case 0:s.trys.push([0,5,6,11]),t=mi(e),s.label=1;case 1:return[4,t.next()];case 2:if(o=s.sent(),!!o.done)return[3,4];if(a=o.value,n.next(a),n.closed)return[2];s.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return l=s.sent(),r={error:l},[3,11];case 6:return s.trys.push([6,,9,10]),o&&!o.done&&(i=t.return)?[4,i.call(t)]:[3,8];case 7:s.sent(),s.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return n.complete(),[2]}})})}function Fe(e,n,t,o,r){o===void 0&&(o=0),r===void 0&&(r=!1);var i=n.schedule(function(){t(),r?e.add(this.schedule(null,o)):this.unsubscribe()},o);if(e.add(i),!r)return i}function To(e,n){return n===void 0&&(n=0),tt(function(t,o){t.subscribe(bt(o,function(r){return Fe(o,e,function(){return o.next(r)},n)},function(){return Fe(o,e,function(){return o.complete()},n)},function(r){return Fe(o,e,function(){return o.error(r)},n)}))})}function xo(e,n){return n===void 0&&(n=0),tt(function(t,o){o.add(e.schedule(function(){return t.subscribe(o)},n))})}function zi(e,n){return nt(e).pipe(xo(n),To(n))}function Vi(e,n){return nt(e).pipe(xo(n),To(n))}function Bi(e,n){return new ce(function(t){var o=0;return n.schedule(function(){o===e.length?t.complete():(t.next(e[o++]),t.closed||this.schedule())})})}function ji(e,n){return new ce(function(t){var o;return Fe(t,n,function(){o=e[bo](),Fe(t,n,function(){var r,i,a;try{r=o.next(),i=r.value,a=r.done}catch(l){t.error(l);return}a?t.complete():t.next(i)},0,!0)}),function(){return Q(o==null?void 0:o.return)&&o.return()}})}function ko(e,n){if(!e)throw new Error("Iterable cannot be null");return new ce(function(t){Fe(t,n,function(){var o=e[Symbol.asyncIterator]();Fe(t,n,function(){o.next().then(function(r){r.done?t.complete():t.next(r.value)})},0,!0)})})}function qi(e,n){return ko(yo(e),n)}function Wi(e,n){if(e!=null){if(vo(e))return zi(e,n);if(po(e))return Bi(e,n);if(mo(e))return Vi(e,n);if(ho(e))return ko(e,n);if(So(e))return ji(e,n);if(wo(e))return qi(e,n)}throw go(e)}function Hi(e,n){return n?Wi(e,n):nt(e)}Gt(function(e){return function(n){n===void 0&&(n=null),e(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=n}});function ot(e,n){return tt(function(t,o){var r=0;t.subscribe(bt(o,function(i){o.next(e.call(n,i,r++))}))})}function $i(e,n,t,o,r,i,a,l){var s=[],c=0,f=0,m=!1,v=function(){m&&!s.length&&!c&&n.complete()},d=function(p){return c<o?g(p):s.push(p)},g=function(p){c++;var h=!1;nt(t(p,f++)).subscribe(bt(n,function(y){n.next(y)},function(){h=!0},void 0,function(){if(h)try{c--;for(var y=function(){var b=s.shift();a||g(b)};s.length&&c<o;)y();v()}catch(b){n.error(b)}}))};return e.subscribe(bt(n,d,function(){m=!0,v()})),function(){}}function Ao(e,n,t){return t===void 0&&(t=1/0),Q(n)?Ao(function(o,r){return ot(function(i,a){return n(o,i,r,a)})(nt(e(o,r)))},t):(typeof n=="number"&&(t=n),tt(function(o,r){return $i(o,r,e,t)}))}function Gi(e){return Ao(uo,e)}function Ki(){return Gi(1)}function Cn(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return Ki()(Hi(e,fo(e)))}function rt(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var t=fo(e);return tt(function(o,r){(t?Cn(e,o,t):Cn(e,o)).subscribe(r)})}var Yi="lk";function _o(e){return typeof e>"u"?!1:Qi(e)||Xi(e)}function Qi(e){var n;return e?e.hasOwnProperty("participant")&&e.hasOwnProperty("source")&&e.hasOwnProperty("track")&&typeof((n=e.publication)==null?void 0:n.track)<"u":!1}function Xi(e){return e?e.hasOwnProperty("participant")&&e.hasOwnProperty("source")&&e.hasOwnProperty("publication")&&typeof e.publication<"u":!1}function Ji(e){return e?e.hasOwnProperty("participant")&&e.hasOwnProperty("source")&&typeof e.publication>"u":!1}function Ls(e){if(typeof e=="string"||typeof e=="number")return"".concat(e);if(Ji(e))return"".concat(e.participant.identity,"_").concat(e.source,"_placeholder");if(_o(e))return"".concat(e.participant.identity,"_").concat(e.publication.source,"_").concat(e.publication.trackSid);throw new Error("Can't generate a id for the given track reference: ".concat(e))}function Fs(e){return e instanceof oi}var Zi=[A.ConnectionStateChanged,A.RoomMetadataChanged,A.ActiveSpeakersChanged,A.ConnectionQualityChanged,A.ParticipantConnected,A.ParticipantDisconnected,A.ParticipantPermissionsChanged,A.ParticipantMetadataChanged,A.ParticipantNameChanged,A.ParticipantAttributesChanged,A.TrackMuted,A.TrackUnmuted,A.TrackPublished,A.TrackUnpublished,A.TrackStreamStateChanged,A.TrackSubscriptionFailed,A.TrackSubscriptionPermissionChanged,A.TrackSubscriptionStatusChanged],ea=[...Zi,A.LocalTrackPublished,A.LocalTrackUnpublished];N.TrackPublished,N.TrackUnpublished,N.TrackMuted,N.TrackUnmuted,N.TrackStreamStateChanged,N.TrackSubscribed,N.TrackUnsubscribed,N.TrackSubscriptionPermissionChanged,N.TrackSubscriptionFailed,N.LocalTrackPublished,N.LocalTrackUnpublished;var ta=[N.ConnectionQualityChanged,N.IsSpeakingChanged,N.ParticipantMetadataChanged,N.ParticipantPermissionsChanged,N.TrackMuted,N.TrackUnmuted,N.TrackPublished,N.TrackUnpublished,N.TrackStreamStateChanged,N.TrackSubscriptionFailed,N.TrackSubscriptionPermissionChanged,N.TrackSubscriptionStatusChanged];[...ta,N.LocalTrackPublished,N.LocalTrackUnpublished];var St=di.getLogger("lk-components-js");St.setDefaultLevel("WARN");function Mo(e){return typeof e=="object"}function Eo(e){return Array.isArray(e)&&e.filter(Mo).length>0}function na(e){return"".concat(Yi,"-").concat(e)}function Os(e){const n=Tn(e),t=Do(e.participant).pipe(ot(()=>Tn(e)),rt(n));return{className:na(e.source===ge.Source.Camera||e.source===ge.Source.ScreenShare?"participant-media-video":"participant-media-audio"),trackObserver:t}}function Tn(e){if(_o(e))return e.publication;{const{source:n,name:t,participant:o}=e;if(n&&t)return o.getTrackPublications().find(r=>r.source===n&&r.trackName===t);if(t)return o.getTrackPublicationByName(t);if(n)return o.getTrackPublication(n);throw new Error("At least one of source and name needs to be defined")}}function oa(e,...n){return new ce(t=>{const o=()=>{t.next(e)};return n.forEach(r=>{e.on(r,o)}),()=>{n.forEach(r=>{e.off(r,o)})}}).pipe(rt(e))}function ra(e,n){return new ce(t=>{const o=(...r)=>{t.next(r)};return e.on(n,o),()=>{e.off(n,o)}})}function ia(e){return ra(e,A.ConnectionStateChanged).pipe(ot(([n])=>n),rt(e.state))}function aa(e,...n){return new ce(t=>{const o=()=>{t.next(e)};return n.forEach(r=>{e.on(r,o)}),()=>{n.forEach(r=>{e.off(r,o)})}}).pipe(rt(e))}function Do(e){return aa(e,N.TrackMuted,N.TrackUnmuted,N.ParticipantPermissionsChanged,N.TrackPublished,N.TrackUnpublished,N.LocalTrackPublished,N.LocalTrackUnpublished,N.MediaDevicesError,N.TrackSubscriptionStatusChanged).pipe(ot(n=>{const{isMicrophoneEnabled:t,isCameraEnabled:o,isScreenShareEnabled:r}=n,i=n.getTrackPublication(ge.Source.Microphone),a=n.getTrackPublication(ge.Source.Camera);return{isCameraEnabled:o,isMicrophoneEnabled:t,isScreenShareEnabled:r,cameraTrack:a,microphoneTrack:i,participant:n}}))}new TextEncoder;new TextDecoder;function Ns(){return{className:"lk-room-container"}}function xn(e,n,t=!0){const o=[e.localParticipant,...Array.from(e.remoteParticipants.values())],r=[];return o.forEach(i=>{n.forEach(a=>{const l=Array.from(i.trackPublications.values()).filter(s=>s.source===a&&(!t||s.track)).map(s=>({participant:i,publication:s,source:s.source}));r.push(...l)})}),{trackReferences:r,participants:o}}function sa(e,n,t){var o,r;const i=(o=t.additionalRoomEvents)!=null?o:ea,a=(r=t.onlySubscribed)!=null?r:!0,l=Array.from(new Set([A.ParticipantConnected,A.ParticipantDisconnected,A.ConnectionStateChanged,A.LocalTrackPublished,A.LocalTrackUnpublished,A.TrackPublished,A.TrackUnpublished,A.TrackSubscriptionStatusChanged,...i]).values());return oa(e,...l).pipe(ot(s=>{const c=xn(s,n,a);return St.debug("TrackReference[] was updated. (length ".concat(c.trackReferences.length,")"),c),c}),rt(xn(e,n,a)))}u.createContext(void 0);const ca=u.createContext(void 0);function ua(){return u.useContext(ca)}function Us(e){const n=ua(),t=e!=null?e:n;if(!t)throw new Error("No TrackRef, make sure you are inside a TrackRefContext or pass the TrackRef explicitly");return t}u.createContext(void 0);const la=u.createContext(void 0);function Io(){return u.useContext(la)}function Qt(e){const n=Io(),t=e!=null?e:n;if(!t)throw new Error("No room provided, make sure you are inside a Room context or pass the room explicitly");return t}const zs=u.createContext(void 0);function da(e,n,t=!0){const[o,r]=u.useState(n);return u.useEffect(()=>{if(t&&r(n),typeof window>"u"||!e)return;const i=e.subscribe(r);return()=>i.unsubscribe()},[e,t]),o}function fa(e){const n=Qt(e),t=u.useMemo(()=>ia(n),[n]);return da(t,n.state)}function Vs(e={}){const n=Qt(e.room),[t,o]=u.useState(n.localParticipant),[r,i]=u.useState(t.isMicrophoneEnabled),[a,l]=u.useState(t.isMicrophoneEnabled),[s,c]=u.useState(t.lastMicrophoneError),[f,m]=u.useState(t.lastCameraError),[v,d]=u.useState(t.isMicrophoneEnabled),[g,p]=u.useState(void 0),[h,y]=u.useState(void 0),b=S=>{l(S.isCameraEnabled),i(S.isMicrophoneEnabled),d(S.isScreenShareEnabled),y(S.cameraTrack),p(S.microphoneTrack),c(S.participant.lastMicrophoneError),m(S.participant.lastCameraError),o(S.participant)};return u.useEffect(()=>{const S=Do(n.localParticipant).subscribe(b);return()=>S.unsubscribe()},[n]),{isMicrophoneEnabled:r,isScreenShareEnabled:v,isCameraEnabled:a,microphoneTrack:g,cameraTrack:h,lastMicrophoneError:s,lastCameraError:f,localParticipant:t}}function pa(e=[ge.Source.Camera,ge.Source.Microphone,ge.Source.ScreenShare,ge.Source.ScreenShareAudio,ge.Source.Unknown],n={}){const t=Qt(n.room),[o,r]=u.useState([]),[i,a]=u.useState([]),l=u.useMemo(()=>e.map(s=>Mo(s)?s.source:s),[JSON.stringify(e)]);return u.useEffect(()=>{const s=sa(t,l,{additionalRoomEvents:n.updateOnlyOn,onlySubscribed:n.onlySubscribed}).subscribe(({trackReferences:c,participants:f})=>{St.debug("setting track bundles",c,f),r(c),a(f)});return()=>s.unsubscribe()},[t,JSON.stringify(n.onlySubscribed),JSON.stringify(n.updateOnlyOn),JSON.stringify(e)]),u.useMemo(()=>{if(Eo(e)){const s=va(e,i),c=Array.from(o);return i.forEach(f=>{var m;s.has(f.identity)&&((m=s.get(f.identity))!=null?m:[]).forEach(v=>{if(o.find(({participant:g,publication:p})=>f.identity===g.identity&&p.source===v))return;St.debug("Add ".concat(v," placeholder for participant ").concat(f.identity,"."));const d={participant:f,source:v};c.push(d)})}),c}else return o},[o,i,e])}function ma(e,n){const t=new Set(e);for(const o of n)t.delete(o);return t}function va(e,n){const t=new Map;if(Eo(e)){const o=e.filter(r=>r.withPlaceholder).map(r=>r.source);n.forEach(r=>{const i=r.getTrackPublications().map(l=>{var s;return(s=l.track)==null?void 0:s.source}).filter(l=>l!==void 0),a=Array.from(ma(new Set(o),new Set(i)));a.length>0&&t.set(r.identity,a)})}return t}var dt=(e=>(e.Local="local",e.Remote="remote",e))(dt||{}),Ro=(e=>(e.Audio="audio",e.Video="video",e))(Ro||{}),Xe=(e=>(e.Camera="camera",e.Microphone="microphone",e.ScreenShare="screen_share",e))(Xe||{});const ha=e=>e.flatMap(n=>{const t=[],o=n.publication.trackName,r=n.participant.identity,i=n.participant.isLocal?"local":"remote";let a;n.publication.source===ge.Source.Camera?a="camera":n.publication.source===ge.Source.ScreenShare?a="screen_share":a="microphone";const l=(s,c)=>{s&&t.push({id:s.mediaStreamTrack.id,source:a,name:o,userName:r,origin:i,media:c,track:s.mediaStreamTrack,isMuted:s.isMuted,isSystemMuted:s.mediaStreamTrack.muted,setMuted:f=>{s.mediaStreamTrack.enabled=!f},onEnded:f=>{s.on("ended",f)},offEnded:f=>{s.off("ended",f)}})};return l(n.publication.audioTrack,"audio"),l(n.publication.videoTrack,"video"),t}),Mt=(e,n)=>{var o;const t={id:e.id,source:n.source,name:n.name,userName:n.userName,media:e.kind==="audio"?"audio":"video",origin:n.origin,track:e,get isMuted(){return!e.enabled||e.muted},get isSystemMuted(){return e.muted},setMuted:r=>{var i;e.enabled=!r,(i=n.mutedCb)==null||i.call(n,t.isMuted,t.isSystemMuted)},onEnded:r=>{e.onended=r},offEnded:r=>{e.onended=null}};return e.onmute=()=>{var r;(r=n.mutedCb)==null||r.call(n,t.isMuted,t.isSystemMuted)},e.onunmute=()=>{var r;(r=n.mutedCb)==null||r.call(n,t.isMuted,t.isSystemMuted)},(o=n.mutedCb)==null||o.call(n,t.isMuted,t.isSystemMuted),t};class ga{constructor(){ae(this,"mediaDevicesPromises",[])}getUserMedia(...n){const t=navigator.mediaDevices.getUserMedia(...n);return this.mediaDevicesPromises.push(t),t}getDisplayMedia(...n){const t=navigator.mediaDevices.getDisplayMedia(...n);return this.mediaDevicesPromises.push(t),t}closeAllStreams(){const n=this.mediaDevicesPromises.map(t=>t.then(o=>{o.getTracks().forEach(r=>{r.readyState==="live"&&r.stop()})}));return this.mediaDevicesPromises=[],Promise.all(n)}}const ba=500,Sa=1e3,ya=3,wa=2e3;function kn({packets:e,packetsLost:n,fractionLost:t,rtt:o}){let r;if(e!==void 0&&n!==void 0?r=n*100/e:t!==void 0&&(r=t*100),r===void 0||o===void 0||isNaN(r))return;const i=o*1e3/2;let a=i/40;i>160&&(a=(i-120)/10);const l=100-a-r;return Math.max(l,0)}function An(e){if(e===void 0)return fe.Unknown;let n;return e<=0?n=1:e>=100?n=4.5:n=1+.035*e+7e-6*e*(e-60)*(100-e),n>4?fe.Excellent:n>3.5?fe.Good:fe.Poor}class ze{constructor(n,t){ae(this,"size");ae(this,"type");ae(this,"buf");this.size=n,this.type=t,this.buf=[]}push(n){n!==void 0&&(this.buf.length===this.size&&this.buf.shift(),this.buf.push(n))}get(){if(this.buf.length!==0)switch(this.type){case"cumulative":{const n=this.buf[0];return(this.buf[this.buf.length-1]-n)/this.buf.length}case"individual":return this.buf.reduce((n,t)=>n+t,0)/this.buf.length}}}class Ca{constructor(n,t){ae(this,"pc");ae(this,"cb");ae(this,"reportTimerId");ae(this,"pollingTimerId");ae(this,"localWindow");ae(this,"remoteWindow");ae(this,"reportTimestamps");ae(this,"stale",!1);const o=ya;this.pc=n,this.cb=t,this.reportTimerId=void 0,this.localWindow={packetsLost:new ze(o,"cumulative"),fractionLost:new ze(o,"individual"),rtt:new ze(o,"individual")},this.remoteWindow={packetsSent:new ze(o,"cumulative"),packetsLost:new ze(o,"cumulative"),rtt:new ze(o,"individual")},this.reportTimestamps={}}start(){this.reportTimerId||this.pollingTimerId||(this.reportTimerId=window.setInterval(this.report.bind(this),ba),this.pollingTimerId=window.setInterval(this.poll.bind(this),Sa))}stop(){window.clearInterval(this.reportTimerId),window.clearInterval(this.pollingTimerId),this.reportTimerId=void 0,this.pollingTimerId=void 0}isFresh(n){let t=!0;if(this.reportTimestamps[n.type]!==void 0){const r=Date.now()-this.reportTimestamps[n.type]<wa;t=n.timestamp!==this.reportTimestamps[n.type]||r}return this.reportTimestamps[n.type]=n.timestamp,t}async poll(){const n=await this.pc.getStats();let t;const o={};let r=!1;n.forEach(a=>{const l=a.kind||a.mediaType;a.type==="transport"&&a.selectedCandidatePairId&&(t=a.selectedCandidatePairId),a.type==="remote-inbound-rtp"&&l==="audio"&&(r||(r=!this.isFresh(a)),this.localWindow.packetsLost.push(a.packetsLost),this.localWindow.fractionLost.push(a.fractionLost)),a.type==="inbound-rtp"&&l==="audio"&&(r||(r=!this.isFresh(a)),this.remoteWindow.packetsSent.push(a.packetsReceived+a.packetsLost),this.remoteWindow.packetsLost.push(a.packetsLost)),a.type==="candidate-pair"&&(o[a.id]=a)}),this.stale=r;const i=t!==void 0&&o[t];i?(this.remoteWindow.rtt.push(i.currentRoundTripTime),this.localWindow.rtt.push(i.currentRoundTripTime)):re.error("QualityMonitor no candidate-pair found!")}report(){if(this.stale)return this.cb({local:fe.Unknown,general:fe.Unknown});const n=kn({packets:void 0,packetsLost:this.localWindow.packetsLost.get(),fractionLost:this.localWindow.fractionLost.get(),rtt:this.localWindow.rtt.get()}),t=kn({packets:this.remoteWindow.packetsSent.get(),packetsLost:this.remoteWindow.packetsLost.get(),fractionLost:void 0,rtt:this.remoteWindow.rtt.get()}),o=[n,t].filter(l=>l!==void 0),r=o.length>0?Math.min(...o):void 0,i=An(n),a=An(r);this.cb({local:i,general:a})}}class ft{static abortPendingNegotiation(n){this._controller&&(this._controller.abort("[abort] ".concat(n)),this._controller=null)}static clearNegotiation(){this._controller=null}static beginNegotiation(){this._controller&&this._controller.abort("[abort] Starting new negotiation");const n=new AbortController;return this._controller=n,n.signal}}ae(ft,"_controller",null);const _n="User",Mn="Assistant",En=0,Ta=[],Xt=u.createContext({room:void 0,getTracks:()=>Ta,getConnectionState:()=>null,selectVoiceModeMetadata:()=>{throw new Error("Null implementation - please provide a proper context")},getTokenSetup:()=>{},initVoiceMode:()=>Promise.reject(new Error("Null implementation - please provide a proper context"))}),Jt=()=>u.useContext(Xt),Bs=({children:e})=>{const n=Io(),t=pa(),o=fa(n),r=ue(),i=u.useCallback(f=>{const m=ha(t);return f?m.filter(v=>f.includes(v.source)):m},[t]),a=u.useCallback(()=>o,[o]),l=u.useCallback(f=>{const{default_voice_mode:m,modes:v}=f,d=v.find(g=>g.mode===m);if(!d)throw new Error("No voice status mode found for default mode "+m);return d},[]),s=u.useCallback(async(f,m)=>{var d;const v=await Xn.startLivekitSession(f,m.eventSource,m.proofOfWorkAnswer);return v.token&&v.url&&v.e2ee_key?(jt({conversationId:(d=f.conversation_id)!=null?d:m.clientThreadId,voiceSessionId:f.voice_session_id,voiceMode:v.voice_mode_decision.voice_mode,credentials:xe(te({},v),{e2eeKey:v.e2ee_key})},r),{type:"livekit",success:!0}):{type:"livekit",success:!1,error:"get_token failed to return expected fields .token, .url and .e2ee_key",response:v}},[r]),c=u.useMemo(()=>({room:n,getTracks:i,getConnectionState:a,getTokenSetup:()=>{},initVoiceMode:s,selectVoiceModeMetadata:l}),[n,i,a,s,l]);return k.jsx(Xt.Provider,{value:c,children:e})};let Et;const xa=()=>(Et===void 0&&(Et=new TextEncoder),Et);function ka(e){switch(e){case"checking":return se.Connecting;case"connected":case"completed":return se.Connected;case"disconnected":return se.Reconnecting;case"new":case"failed":case"closed":return se.Disconnected}}const js=({children:e})=>{const n=ue(),t=Go(Ko()),o=u.useRef(null),r=u.useRef(void 0),i=u.useRef(void 0),a=u.useCallback(async({avmTrack:M,initialSetup:C=!1})=>{const w=M.media===Ro.Audio?r:i;if(w.current&&!w.current.stopped)await w.current.sender.replaceTrack(M.track);else if(C)w.current=me().addTransceiver(M.track);else throw new Error("Cannot replace track on ".concat(M.media," transceiver that was not initialized."))},[]),[l,s]=u.useState(void 0),[c,f]=u.useState(void 0),[m,v]=u.useState(void 0),d=u.useRef(void 0),g=u.useRef(void 0),p=u.useRef(void 0),h=n(M=>M.voiceMode),[y,b]=u.useState(null),S=u.useCallback(()=>y,[y]),D=u.useCallback(M=>{de(C=>st(C,w=>{w&&(w.activeSpeakers.some(x=>x.identity===M)||w.activeSpeakers.push({identity:M}))}))},[]),P=u.useCallback(M=>{de(C=>st(C,w=>{w&&(w.activeSpeakers=w.activeSpeakers.filter(x=>x.identity!==M))}))},[]),H=u.useRef(null),$=u.useRef([]),le=u.useRef([]),O=u.useRef([]),X=u.useRef([]),E=u.useRef([]),U=u.useRef(!1),K=u.useRef([]),T=u.useCallback(M=>{K.current.forEach(C=>C(M))},[]),I=u.useRef(y);u.useEffect(()=>{I.current=y},[y]);const _=u.useRef(void 0);u.useEffect(()=>{_.current=l},[l]);const R=u.useRef(void 0);u.useEffect(()=>{R.current=m},[m]);const J=u.useRef(new ga).current,z=u.useRef(void 0),j=u.useRef(void 0),V=u.useRef(void 0),[Y,de]=u.useState(()=>({localParticipant:{isMicrophoneEnabled:!1,setMicrophoneEnabled:function(C){var w;return(w=_.current)==null||w.setMuted(!C),Promise.resolve(void 0)},setCameraEnabled:async function(C,w,x){if(C)try{const L=await Ce("camera");await a({avmTrack:L}),T(L)}catch(L){throw re.error("[transceiver] Error acquiring camera input",L),L}else await q();return Promise.resolve(void 0)},setScreenShareEnabled:async function(C,w,x){if(C)try{const L=await Ce("screenshare");await a({avmTrack:L}),T(L)}catch(L){throw re.error("[transceiver] Error acquiring screen share input",L),L}else await q();return Promise.resolve(void 0)},publishData:async function(C,w){const x=H.current;if(!x||x.readyState!=="open")throw new Error("Data channel is not open");const L=new TextDecoder().decode(C),F=JSON.stringify({type:"data_message",data:L});x.send(F)},on:function(C,w){C===A.ConnectionQualityChanged&&le.current.push(w)},off:function(C,w){C===A.ConnectionQualityChanged&&(le.current=le.current.filter(x=>x!==w))}},getActiveDevice:C=>{switch(C){case"audioinput":return d.current;case"videoinput":return g.current;case"audiooutput":return p.current}},disconnect:async function(C=!0){var w;ft.abortPendingNegotiation("Disconnecting"),(w=z.current)==null||w.stop(),U.current=!0,C&&J.closeAllStreams(),we.current&&(we.current.close(),we.current=void 0),o.current&&(o.current.srcObject=null),await q(),b(se.Disconnected),I.current=se.Disconnected,E.current.forEach(x=>x())},name:"",switchActiveDevice:async(C,w,x)=>{var L;if(I.current!==se.Connected)return re.debug("[transceiver] Attempt to switch device when not connected, current state is",I.current),!1;try{switch(C){case"audioinput":{const F=await De(w);return await a({avmTrack:F}),T(F),!0}case"videoinput":{const F=await Ce("camera",w);return await a({avmTrack:F}),T(F),!0}case"audiooutput":return await((L=o.current)==null?void 0:L.setSinkId(w)),p.current=w,!0}}catch(F){return re.error("[transceiver] Failed to switch ".concat(C," device"),F),!1}},on:function(C,w){switch(C){case A.DataReceived:O.current.push(w);break;case A.Disconnected:E.current.push(w);break;case A.Connected:X.current.push(w);break;case A.TrackPublished:K.current.push(w);break;case A.ConnectionQualityChanged:$.current.push(w);break}},off:function(C,w){switch(C){case A.DataReceived:O.current=O.current.filter(x=>x!==w);break;case A.Disconnected:E.current=E.current.filter(x=>x!==w);break;case A.Connected:X.current=X.current.filter(x=>x!==w);break;case A.TrackPublished:K.current=K.current.filter(x=>x!==w);break;case A.ConnectionQualityChanged:$.current=$.current.filter(x=>x!==w);break}},state:se.Disconnected,numParticipants:0,activeSpeakers:[]})),pe=u.useRef(!1),we=u.useRef(void 0),me=()=>(we.current===void 0&&(we.current=Sr.getFreshPeerConnection("voice-mode")),we.current),Ee=u.useCallback((M,C)=>{de(w=>st(w,x=>{x&&(x.localParticipant.isMicrophoneEnabled=!M,x.localParticipant.isMicrophoneForceMuted=C,M?P(_n):D(_n))}))},[D,P]),Oe=u.useCallback(M=>{const C=[l,c,m].filter(w=>w!==void 0);return M?C.filter(w=>M.includes(w.source)):C},[l,c,m]),De=u.useCallback(async M=>{M||(M=await yr());const w=(await J.getUserMedia({audio:M?{deviceId:{exact:M}}:!0})).getTracks();if(w.length!==1)throw re.error("[transceiver] Only one input is supported for now, detected these tracks",w),new Error("Only one input is supported for now");const[x]=w;d.current=x.getSettings().deviceId,_.current&&_.current.track!==x&&_.current.track.stop();const L=Mt(x,{source:Xe.Microphone,name:"user",userName:"User",origin:dt.Local,mutedCb:Ee});return s(L),Ee(L.isMuted,L.isSystemMuted),L},[Ee,J]),Ce=u.useCallback(async(M,C)=>{const x=(M==="camera"?await J.getUserMedia({video:C?{deviceId:{exact:C}}:!0}):await J.getDisplayMedia()).getTracks();if(x.length!==1)throw re.error("[transceiver] Only one video input is supported for now, detected these tracks",x),new Error("Only one video input is supported for now");const[L]=x;M==="camera"&&(g.current=L.getSettings().deviceId),R.current&&R.current.track!==L&&R.current.track.stop();const F=Mt(L,{source:M==="camera"?Xe.Camera:Xe.ScreenShare,name:"user",userName:"User",origin:dt.Local});return v(F),F},[J]),q=u.useCallback(async()=>{if(R.current&&(re.debug("[transceiver] Stop and clear video track"),R.current.track.stop(),v(void 0),i.current&&!i.current.stopped)){re.debug("[transceiver] Stop the video transceiver");try{await i.current.sender.replaceTrack(null)}catch(M){re.debug("[transceiver] Failed to stop transceiver on disconnect due to",M)}}},[]),ne=u.useCallback(M=>{const{default_voice_mode:C,modes:w}=M,x=w.find(L=>L.mode===C);if(!x)throw new Error("No voice status mode found for default mode ".concat(C));return x},[]),ve=u.useCallback(async()=>{const M=performance.now(),C=Ue(Mr,()=>me()),w=Ue(kr,()=>me().createDataChannel("",{negotiated:!0,id:En}));H.current=w,Ue(Er,()=>{w.onopen=()=>{n.setState(F=>{F.metrics.dataChannelOpenTime||(F.metrics.dataChannelOpenTime=new Date)})},w.onmessage=F=>{const oe=JSON.parse(F.data);if(oe.type==="data_message"){const Te=xa().encode(oe.data);O.current.forEach(Ne=>Ne(Te))}},w.onclose=()=>{U.current?U.current=!1:E.current.forEach(F=>F()),P(Mn)},C.oniceconnectionstatechange=()=>{const F=me().iceConnectionState,oe=ka(F);oe===se.Connected&&X.current.forEach(Te=>Te()),b(oe),n.setState(Te=>{Te.server.connectionState=oe})},C.ontrack=F=>{if(o.current!=null){o.current.srcObject=F.streams[0];const oe=F.streams[0].getTracks();if(oe.length!==1)throw re.error("[transceiver] Only one remote track is supported for now, detected these tracks",oe),new Error("Only one remote track is supported for transceiver");const[Te]=oe,Ne=Mt(Te,{source:Xe.Microphone,name:h==="advanced"?"audio":"shout",userName:"Assistant",origin:dt.Remote});f(Ne),T(Ne),de($e=>st($e,Ge=>{Ge&&(Ge.numParticipants=2)})),D(Mn)}}}),Ue(Dr,()=>{r.current=C.addTransceiver("audio"),i.current&&!i.current.stopped&&(i.current.stop(),C.removeTrack(i.current.sender)),i.current=C.addTransceiver("video",{direction:"sendonly"})});const x=await dn(Ar,async()=>{const F=await C.createOffer();return C.setLocalDescription(F),F}),L=performance.now();return wr.set({start_time:M,end_time:L}),{offer:x}},[D,T,P,h,n]),ie=u.useCallback(()=>{const M=performance.now(),C=De();return C.then(()=>{const x=performance.now();Cr.set({start_time:M,end_time:x})}),{completeAudioSetup:async()=>{const x=await C,L=performance.now();await a({avmTrack:x,initialSetup:!0});const F=performance.now();return _r.set({start_time:L,end_time:F}),{microphoneTrack:x}}}},[De,a]),it=u.useCallback(()=>{const M=performance.now(),C=me();z.current&&z.current.stop(),z.current=new Ca(C,x=>{const L=I.current&&[se.Disconnected,se.Reconnecting,se.SignalReconnecting].includes(I.current);$.current.forEach(F=>F(L?fe.Lost:x.general)),le.current.forEach(F=>F(L?fe.Lost:x.local))}),z.current.start();const w=performance.now();Tr.set({start_time:M,end_time:w})},[]),xt=u.useCallback(()=>{V.current=ie(),j.current=ve()},[ve,ie]),ee=u.useCallback(async(M,C,w)=>{const x=performance.now(),L=await dn(Rr,()=>w.text()),F=me();Ue(Pr,()=>{F.setRemoteDescription({sdp:L,type:"answer"})}),V.current||(re.error("[transceiver] Audio input setup step not executed for initial TC offer!"),V.current=ie());const{completeAudioSetup:oe}=V.current,{microphoneTrack:Te}=await oe();T(Te),n.setState($e=>{var Ge;$e.conversationId=(Ge=M.conversation_id)!=null?Ge:C.clientThreadId,$e.voiceSessionId=M.voice_session_id,$e.voiceMode=M.voice_mode}),pe.current=!1,b(se.Connected);const Ne=performance.now();xr.set({start_time:x,end_time:Ne})},[ie,V,T,n]),nn=u.useCallback(async(M,C)=>{var F,oe;if(pe.current)throw new Error("Not ready to connect, ".concat(JSON.stringify({isConnecting:pe.current})));pe.current=!0,(F=j.current)!=null||(j.current=ve()),(oe=V.current)!=null||(V.current=ie());const{offer:w}=await j.current,x=Ue(Ir,()=>ft.beginNegotiation()),L=await Xn.startTransceiverSession({payload:M,accessToken:t,proofOfWorkAnswer:C.proofOfWorkAnswer,eventSource:C.eventSource,signal:x,dataChannelId:En,offer:w});return ft.clearNegotiation(),it(),ee(M,C,L),{type:"transceiver",success:!0}},[ve,ie,t,it,ee]),Bo=u.useMemo(()=>({room:Y,getTracks:Oe,getConnectionState:S,initVoiceMode:nn,selectVoiceModeMetadata:ne,getTokenSetup:xt}),[Y,Oe,S,nn,ne,xt]);return k.jsxs(Xt.Provider,{value:Bo,children:[k.jsx("audio",{ref:o,autoPlay:!0,playsInline:!0}),e]})};function be(){const{room:e}=Jt(),n=u.useRef({debug:(...t)=>{var o;return re.debug("[".concat((o=e==null?void 0:e.name)!=null?o:"no room","]"),...t)},encoder:new TextEncoder,decoder:new TextDecoder}).current;return te({room:e},n)}function Aa(){Ma(),Ea(),Da(),_a()}function _a(){const{room:e,debug:n}=be(),{cameraTrackState:t}=Jn(),r=oo().video,i=u.useMemo(()=>{const a=["audioinput","audiooutput"];return r&&a.push("videoinput"),a},[r]);u.useEffect(()=>{function a(){Promise.all(i.map(async l=>{if(t!==he.Started&&l==="videoinput")return;const s=await Qn.getLocalDevices(l),c=e==null?void 0:e.getActiveDevice(l),f=await Je(l);if(!(c===(f==null?void 0:f.deviceId))){let v=null;if(f?v=f.deviceId:s[0]&&(v=s[0].deviceId),v){const d=await vn(v,s),g=await vn(c,s);n("Current active ".concat(l,' device "').concat(g,'" doesn\'t match default "').concat(d,'", switching to that instead')),await(e==null?void 0:e.switchActiveDevice(l,v)),W.defaultMediaDeviceChanged.success({kind:l})}}})).catch(l=>{W.defaultMediaDeviceChanged.failure(l)})}if(navigator)return navigator.mediaDevices.addEventListener("devicechange",a),()=>{navigator.mediaDevices.removeEventListener("devicechange",a)}},[e,n,i,t])}function Ma(){const{room:e,debug:n}=be(),t=e==null?void 0:e.getActiveDevice("audioinput"),o=e==null?void 0:e.getActiveDevice("audiooutput");u.useEffect(()=>{async function r(){var c,f;const i=(c=await Je("audioinput"))==null?void 0:c.deviceId,a=(f=await Je("audiooutput"))==null?void 0:f.deviceId,l=async()=>{i&&t!==i&&(n("switching audio input to default"),await(e==null?void 0:e.switchActiveDevice("audioinput",i)))},s=async()=>{if(a&&o!==a){n("switching audio output to default");try{await(e==null?void 0:e.switchActiveDevice("audiooutput",a))}catch(m){n("failed to switch audio output",m)}}};await Promise.all([l(),s()])}r()},[t,o,n,e])}function Ea(){const{cameraTrackState:e,finalizeCameraState:n}=Jn(),{room:t,debug:o}=be(),r=ue(),a=oo().video,l=a?t==null?void 0:t.getActiveDevice("videoinput"):void 0;u.useEffect(()=>{async function s(){if(t)if(e===he.Starting)try{await t.localParticipant.setCameraEnabled(!0),mt(t,r,"camera_front","live"),n(he.Started)}catch(c){n(he.Stopped)}else e===he.Stopping&&(await t.localParticipant.setCameraEnabled(!1),mt(t,r,"camera_front","ended"),n(he.Stopped))}s()},[e,n,t,r]),u.useEffect(()=>{async function s(){var m;const c=(m=await Je("videoinput"))==null?void 0:m.deviceId;await(async()=>{c&&l!==c&&(o("switching video input to default"),await(t==null?void 0:t.switchActiveDevice("videoinput",c)))})()}a&&e===he.Started&&s()},[l,o,t,a,e])}function Da(){const{room:e}=be(),{screenshareTrackState:n,finalizeScreenshareState:t}=Lr(),o=ue();u.useEffect(()=>{async function r(){if(e)if(n===he.Starting)try{await e.localParticipant.setScreenShareEnabled(!0,{video:{displaySurface:"monitor"}}),mt(e,o,"screen_share","live"),t(he.Started)}catch(i){t(he.Stopped)}else n===he.Stopping&&(await e.localParticipant.setScreenShareEnabled(!1),mt(e,o,"screen_share","ended"),t(he.Stopped))}r()},[e,n,t,o])}function Po(){const{debug:e}=be(),n=Me(o=>o.conversationId),t=jn();return u.useCallback(async o=>{const r=o,i=n&&!qn(n)?n:void 0,a=r!=null?r:i;if(a){e("refetch conversationId ".concat(a));try{await Fr(a)}catch(l){const s="Failed to update conversation";e(s,l),t.danger(s,{toastId:"refetch_conversation"})}}},[n,e,t])}var Ia=(e=>(e.EXCELLENT="excellent",e.GOOD="good",e.POOR="poor",e.LOST="lost",e.UNKNOWN="unknown",e))(Ia||{});const Ra={[fe.Excellent]:"excellent",[fe.Good]:"good",[fe.Poor]:"poor",[fe.Lost]:"lost",[fe.Unknown]:"unknown"},Pa=5e3,La=2e3,Fa=500,Oa=e=>{var p;const n=ue(),{room:t}=be(),o=Me(h=>h.disconnectPending),r=Me(h=>h.server.remoteState===Z.Speaking),i=(p=Me(h=>h.conversationId))!=null?p:void 0,a=Wn(i),l=u.useRef(!1),s=Po(),c=mr(),f=Gn(),m=Me(h=>h.server.connectionState);l.current=r||l.current;const v=u.useCallback(async h=>{clearTimeout(o),n.setState(b=>{b.disconnectPending=void 0}),t==null||t.disconnect(),await s(a),n.setState(Or);const y=a!=null?a:h;y&&Zn(c,f,y),Yo(()=>{Qo()},Fa),e!=null&&e.refetchLater&&window.setTimeout(()=>{s(a)},La)},[o,t,s,a,e==null?void 0:e.refetchLater,c,f,n]),d=l.current&&!a&&m===se.Connected,g=u.useCallback(()=>{n.setState(h=>{h.disconnectPending=window.setTimeout(v,Pa)})},[v,n]);return{disconnectPending:o!==void 0,shouldDelayDisconnect:d,delayDisconnect:g,immediateDisconnect:v}};function Dn(e){performance.mark("voice_mode.end");const n=performance.measure("voice_mode","voice_mode.start","voice_mode.end").duration.toFixed(0);W.voiceMode.connect({durationMs:n}),e.metrics.sessionConnectedTime=new Date}function Na(){var D,P,H;const e=$t(),n=Gn(),t=ue(),{room:o,debug:r,decoder:i}=be(),{disconnectPending:a,shouldDelayDisconnect:l,delayDisconnect:s,immediateDisconnect:c}=Oa(),f=Po(),m=u.useRef(!1),v=u.useRef(!1),d=u.useRef(!1),{session:g}=Xo(),p=!1,h=(D=Me($=>$.conversationId))!=null?D:void 0,y=Wn(h),b=pt($=>$.lastVoiceSessionStartTime),S=Hn()==="livekit";u.useEffect(()=>{const $=async I=>{const{new_state:_}=I;if(t.setState(R=>{(R.voiceMode!=="advanced"||_!==Z.Thinking)&&(R.server.remoteState=_)}),_===Z.Listening&&!m.current&&b instanceof Date){const J=new Date().getTime()-b.getTime();W.firstListeningLatency.success({durationMs:J}),m.current=!0}if(_===Z.ListeningIntently)W.voiceSessionListeningIntently.stateChange();else if(_===Z.Listening){if(t.setState(R=>{R.metrics.numListening+=1}),!v.current){const R=t.getState().voiceSessionId;W.voiceSessionFirstListening.stateChange({voice_session_id:R!=null?R:"unknown"}),v.current=!0}v.current=!0,W.voiceSessionListening.stateChange()}else if(_===Z.Thinking)t.setState(R=>{R.metrics.numThinking+=1}),W.voiceSessionThinking.stateChange();else if(_===Z.Speaking){if(t.setState(R=>{R.metrics.numSpeaking+=1}),!d.current){const R=t.getState().voiceSessionId;W.voiceSessionFirstSpeaking.stateChange({voice_session_id:R!=null?R:"unknown"}),d.current=!0}W.voiceSessionSpeaking.stateChange()}else _===Z.Halted&&W.voiceSessionHalted.stateChange()},le=async I=>{t.setState(_=>{_.server.usage=I})},O=async I=>{t.setState(_=>{_.server.toolUpdate=te({},I)}),I.update_type==="hangup"&&(l?s():c())},X=async I=>{var R,J;let _;try{_=JSON.parse(i.decode(I)),r("data received",_)}catch(z){r("error parsing data",z);return}switch(t.setState(z=>(z.server.messages.push(xe(te({},_),{timestamp:new Date,source:"remote"})),z)),_.type){case Ie.StateUpdate:{r("state update",_.payload);const{new_state:z,delay_s:j}=_.payload,V=!!t.getState().metrics.sessionConnectedTime;[Z.Thinking,Z.Speaking].includes(z)&&t.getState().server.turnContext.clear(),z===Z.Listening&&!V&&t.setState(Y=>{Dn(Y)}),z===Z.Thinking&&j&&(r("".concat(o==null?void 0:o.name," delay thinking state by ").concat(j," seconds")),$({new_state:Z.ListeningIntently}),await new Promise(Y=>setTimeout(Y,j*1e3))),$(_.payload);break}case Ie.ConversationUpdate:{r("conversation update",_.payload);const z=t.getState().conversationId,{conversation_id:j}=_.payload;if(z&&qn(z)){t.setState(de=>{de.conversationId=j}),Jo.initThread({clientThreadId:z,conversationMode:{kind:Ut.PrimaryAssistant},userId:(R=g==null?void 0:g.user)==null?void 0:R.id,accountId:(J=g==null?void 0:g.account)==null?void 0:J.id});const V=t.getState().conversationId;V!=null&&Zo(e,V,j),Zn(eo,n,j);const Y=zt.getGizmoId(Vt(z));Nr(n,Y)}await f(j),a&&c(j);break}case Ie.UsageUpdate:le(_.payload);break;case Ie.ToolUpdate:O(_.payload);break;case Ie.Performance:{const z=_.payload.metrics;t.setState(j=>{z.forEach(V=>{V.name==="total_latency_ms"?j.metrics.totalLatencyMs.push(V.ms):V.name==="current_rtt_ms"&&j.metrics.currentRttMs.push(V.ms)})});break}case Ie.StartupTelemetry:{const[z]=_.payload.metrics,j=_.payload.success;r("conversation loaded (startup telemetry)"),t.setState(V=>{var Y;j?(V.server.relayReady=!0,V.metrics.conversationStartSuccessTime=new Date):V.metrics.conversationStartFailTime=new Date,V.metrics.conversationLatency=(Y=z==null?void 0:z.ms)!=null?Y:-1});break}}},E=(I,_)=>{r("track published",I,_)},U=()=>{r("disconnected"),t.setState(I=>{I.metrics.sessionEndTime=new Date}),Ur(t),W.voiceSessionDisconnected.stateChange()},K=(I,_)=>{r("Connection quality changed for participant ".concat(_==null?void 0:_.identity,": ").concat(I)),t.setState(R=>{R.server.voiceConnectionQuality=Ra[I]})},T=()=>{t.setState(I=>{r("WebRTC connection established"),I.metrics.livekitConnectSuccessTime||(I.metrics.livekitConnectSuccessTime=new Date),S&&!I.metrics.sessionConnectedTime&&Dn(I),I.hasConnectedOnce=!0})};return o==null||o.on(A.Connected,T),o==null||o.on(A.DataReceived,X),o==null||o.on(A.TrackPublished,E),o==null||o.on(A.ConnectionQualityChanged,K),o==null||o.on(A.Disconnected,U),()=>{o==null||o.off(A.Connected,T),o==null||o.off(A.DataReceived,X),o==null||o.off(A.TrackPublished,E),o==null||o.off(A.ConnectionQualityChanged,K),o==null||o.off(A.Disconnected,U)}},[e,r,i,s,a,c,b,n,f,o,(P=g==null?void 0:g.account)==null?void 0:P.id,(H=g==null?void 0:g.user)==null?void 0:H.id,l,t,S,y,p])}function Ua(){za(),Va(),Ba(),ja(),qa()}function za(){const{room:e}=be(),n=ue();u.useEffect(()=>{n.setState(t=>{t.dev.room=e})},[e,n])}function Va(){const{getConnectionState:e}=Jt(),n=e(),t=ue();u.useEffect(()=>{t.setState(o=>{o.server.connectionState=n})},[n,t])}function Ba(){const{room:e,debug:n,encoder:t}=be(),o=ue();u.useEffect(()=>{const r=!!o.getState().server.actions;if(e&&!r){const i=async a=>{n("publishing action",a);const l={type:Ie.ActionRequest,payload:{action:a}};await e.localParticipant.publishData(t.encode(JSON.stringify(l)),{reliable:!0}),o.setState(s=>{s.server.messages.push(xe(te({},l),{timestamp:new Date,source:"local"}))})};o.setState(a=>{a.server.actions={[Se.StartListeningIntently]:()=>i(Se.StartListeningIntently),[Se.StopListeningIntently]:()=>i(Se.StopListeningIntently),[Se.HaltAllActivity]:()=>i(Se.HaltAllActivity),[Se.ResumeListening]:()=>i(Se.ResumeListening),[Se.RelayMessage]:()=>i(Se.RelayMessage)}})}},[e,n,t,o])}function ja(){const n=ue()(o=>o.isVoiceModeActive);u.useEffect(()=>(pt.setState({isVoiceActive:n}),()=>{pt.setState({isVoiceActive:!1})}),[n]);const t=$t();u.useEffect(()=>{if(n)return er(t).limitActionGroups([])},[t,n])}function qa(){const e=ue(),{room:n,encoder:t}=be(),o=u.useCallback(async r=>{await(n==null?void 0:n.localParticipant.publishData(t.encode(JSON.stringify(r)),{reliable:!0})),e.setState(i=>{i.server.messages.push(xe(te({},r),{timestamp:new Date,source:"local"}))})},[n,t,e]);u.useEffect(()=>{e.setState(r=>{r.server.turnContext.setPublisher(o)})},[o,e])}const qs=u.memo(function(){return Na(),Ua(),Aa(),null});function Dt(e){return[...e].sort().join(", ")}function Ws(e){return te({conversation_id:e.serverThreadId,parent_message_id:e.parentMessageId,voice_mode:e.isAdvancedMode?"advanced":"standard",eventSource:e.eventSource,clientThreadId:e.clientThreadId,gizmo_id:e.gizmoId,voice:e.voice},e.skipCacheReason?{useVoiceStatusCache:!1,skipCacheReason:e.skipCacheReason}:{useVoiceStatusCache:!0})}function Wa({requestMicPermissions:e}={requestMicPermissions:!1}){const n=Kn(),t=ue(),o=si(),{voiceName:r,voiceMainLanguage:i}=to(),a=Me(b=>b.isVoiceModeActive),l=zr(),{room:s}=be(),{initVoiceMode:c,selectVoiceModeMetadata:f,getTokenSetup:m}=Jt(),v=Vr(),d=Br(),g=tr(),p=n.formatMessage({id:"useVoiceModeButtonAction.error",defaultMessage:"Failed to start voice mode"}),h=u.useCallback(async()=>{l&&(await(s==null?void 0:s.disconnect()),jt(null,t),t.setState(b=>{b.server.remoteState=Z.Halted}))},[l,s,t]);return{startVoiceMode:u.useCallback(async b=>{var H,$,le,O,E,U,K;Nt.setItem(Bn.VoiceLastUsed,new Date().toUTCString());let S="unset-".concat(jr());un.set(S),(l||b.forceDisconnect)&&(await(s==null?void 0:s.disconnect()),jt(null,t)),e&&await d();const D=await Je("audioinput");m(),t.setState(T=>{T.audioInputDevice=D,T.isVoiceModeActive=!0,T.voiceMode=b.voice_mode,T.server.remoteState=Z.Connecting,T.metrics.sessionCreateTime=new Date,T.metrics.totalLatencyMs=[],T.metrics.currentRttMs=[],T.metrics.numSpeaking=0,T.metrics.numThinking=0,T.metrics.numListening=0,T.metrics.getStatusSentTime=void 0,T.metrics.getStatusSuccessTime=void 0,T.metrics.getStatusFailedTime=void 0,T.metrics.proofOfWorkStartTime=void 0,T.metrics.proofOfWorkEndTime=void 0,T.metrics.getTokenSentTime=void 0,T.metrics.getTokenSuccessTime=void 0,T.metrics.getTokenFailedTime=void 0,T.metrics.livekitConnectTime=void 0,T.metrics.livekitConnectSuccessTime=void 0,T.metrics.livekitConnectFailTime=void 0,T.metrics.conversationStartSuccessTime=void 0,T.metrics.conversationStartFailTime=void 0,T.metrics.sessionConnectedTime=void 0});const P=performance.now();try{W.livekit.connectCalled(),t.setState(ee=>{ee.metrics.getStatusSentTime=new Date});const T=qr(),I=Dt(fn()),_=Dt(Wr()),R=Dt(Hr()),J=I.length>0,z=_.length>0;!b.useVoiceStatusCache?(W.voiceStatusCache.skipped({reason:b.skipCacheReason}),pn.set(b.skipCacheReason)):(pn.set(void 0),z?W.voiceStatusCache.ineligible({reason:_}):J?W.voiceStatusCache.failed({reason:I}):T?W.voiceStatusCache.hit({allowlisted:R||!1}):fn.set(["unexpected-empty-cache"]));const V=T==null?void 0:T.proofOfWorkPromise,Y=b.useVoiceStatusCache&&T?T:await v({conversation_id:(H=b.conversation_id)!=null?H:null,requested_voice_mode:($=b.voice_mode)!=null?$:null,gizmo_id:(le=b.gizmo_id)!=null?le:null,voice:b.voice,requested_default_model:(O=b.requested_default_model)!=null?O:null},b.eventSource);S=Y.voice_session_id,un.set(Y.voice_session_id),t.setState(ee=>{ee.metrics.getStatusSuccessTime=new Date,ee.metrics.proofOfWorkStartTime=new Date});const{default_voice_mode:de,chatreq:pe}=Y;performance.mark("livekit.start"),performance.mark("voice_mode.start");const X=b,{eventSource:we,voice:me,clientThreadId:Ee,voice_mode:Oe,gizmo_id:De}=X,Ce=sn(X,["eventSource","voice","clientThreadId","voice_mode","gizmo_id"]),ne=f(Y).default_model_slug,ve=de==="advanced"?ne:void 0,ie=b.useVoiceStatusCache&&V?await V:pe?await $r.getEnforcementToken(pe):null,it=b.gizmo_id?{kind:Ut.GizmoInteraction,gizmo_id:b.gizmo_id}:{kind:Ut.PrimaryAssistant};t.setState(ee=>{ee.metrics.proofOfWorkEndTime=new Date,ee.voiceStatus=Y,ee.metrics.getTokenSentTime=new Date}),Gr(Ce),(await c(xe(te({},Ce),{voice:me!=null?me:r,language_code:i,voice_session_id:S,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,voice_mode:de,model_slug:ne,model_slug_advanced:ve,chatreq_token:pe==null?void 0:pe.token,history_and_training_disabled:g,conversation_mode:it}),{eventSource:b.eventSource,clientThreadId:b.clientThreadId,proofOfWorkAnswer:ie})).success&&(t.setState(ee=>{ee.metrics.getTokenSuccessTime=new Date,ee.metrics.livekitConnectTime=new Date}),pt.setState({lastVoiceSessionStartTime:new Date}),t.setState(ee=>{ee.server.remoteState=Z.Listening}),performance.mark("livekit.end"),W.livekit.success({durationMs:performance.measure("livekit","livekit.start","livekit.end").duration.toFixed(0),voice_session_id:S}),W.connectionLatency.success({durationMs:performance.now()-P}))}catch(T){const I=Kr(T);t.setState(R=>{I||(R.metrics.getStatusSuccessTime||(R.metrics.getStatusFailedTime=new Date),R.metrics.getTokenSuccessTime||(R.metrics.getTokenFailedTime=new Date))});const _=Yr(t.getState());throw W.livekit.failure(T,xe(te({},_),{voice_session_id:S,eventSource:b.eventSource,voice:(E=b.voice)!=null?E:"(undefined)",requested_voice_mode:(U=b.voice_mode)!=null?U:"(undefined)",gizmo_id:(K=b.gizmo_id)!=null?K:"(undefined)",user_aborted:I})),re.debug("failed to get voice token",T),t.setState(R=>{R.server.remoteState=Z.Halted}),W.connectionLatency.failure(T,{durationMs:performance.now()-P,voice_session_id:S,user_aborted:I}),o.danger(p,{toastId:"start_voice_mode_failure"}),T}},[d,p,v,l,g,e,s,o,i,r,t,c,f,m]),stopVoiceMode:h,isConnected:l,isVoiceModeActive:a}}const Ha=2,$a=({viewport:e,canvasSize:n,shouldMeasurePerf:t,source:o})=>{const r=u.useRef({}),i=u.useCallback(a=>{const l=a.getExtension("WEBGL_debug_renderer_info");l&&(r.current.vendor=a.getParameter(l.UNMASKED_VENDOR_WEBGL),r.current.renderer=a.getParameter(l.UNMASKED_RENDERER_WEBGL))},[]);return u.useEffect(()=>{var s,c;const a={vendor:(s=r.current.vendor)!=null?s:"(unavailable)",renderer:(c=r.current.renderer)!=null?c:"(unavailable)",width:e[0],height:e[1],canvasWidth:n[0],canvasHeight:n[1],dpr:window.devicePixelRatio,source:o};!nr(a,r.current)&&t&&(r.current=a,no(Ha).then(f=>{W.bloop.performance(xe(te({},a),{fps:f}))}))},[n,t,e,o]),i},Ga=.25,Ka=3,In=28,It=55,Rt=200,Rn=1.1,Ya=({viewport:e,initialScale:n,shouldCalibrate:t})=>{const[o,r]=u.useState(n),i=u.useRef(void 0),a=u.useRef(void 0),l=u.useRef(void 0),s=u.useRef("down"),c=u.useCallback(()=>{const f=s.current==="up"?Ka:Ga;no(f).then(m=>{if(m<In){s.current="down";const v=Math.max(m,1),d=Math.sqrt(v/In);r(g=>g*d),a.current=window.setTimeout(c,Rt)}else if(l.current){const v=m>=It,d=m>=l.current*Rn;if(v||d)s.current="up",r(g=>g*Rn),a.current=window.setTimeout(c,Rt);else if(m<It){s.current="down";const g=Math.sqrt(m/It);r(p=>p*g)}}l.current=m})},[]);return u.useEffect(()=>{var p;const[f,m]=e,[v,d]=(p=i.current)!=null?p:[];return t&&(v!==f||d!==m)&&(i.current=e,clearTimeout(a.current),r(n),a.current=window.setTimeout(c,Rt)),()=>{clearTimeout(a.current)}},[t,c,n,e]),o};var Pt,Pn;function Qa(){if(Pn)return Pt;Pn=1;var e=or(),n=rr(),t=ir(),o=ar(),r=Qr(),i=Math.max;function a(l){if(!(l&&l.length))return[];var s=0;return l=e(l,function(c){if(r(c))return s=i(c.length,s),!0}),o(s,function(c){return n(l,t(c))})}return Pt=a,Pt}var Lt,Ln;function Xa(){if(Ln)return Lt;Ln=1;var e=Xr(),n=Qa(),t=e(n);return Lt=t,Lt}var Ja=Xa();const Ft=vr(Ja),Za={bands:5,loPass:100,hiPass:600,updateInterval:32,analyserOptions:{fftSize:2048}},es=e=>{const n=t=>{let i=1-Math.max(-100,Math.min(-10,t))*-1/100;return i=Math.sqrt(i),i};return e.map(t=>t===-1/0?0:n(t))};function Zt(e,n={}){const t=te(te({},Za),n),[o,r]=u.useState(new Array(t.bands).fill(0));return u.useEffect(()=>{if(!e)return;const{analyser:i,cleanup:a}=ts(e,t.analyserOptions),l=i.frequencyBinCount,s=new Float32Array(l),f=setInterval(()=>{i.getFloatFrequencyData(s);let m=new Float32Array(s.length);for(let p=0;p<s.length;p++)m[p]=s[p];m=m.slice(t.loPass,t.hiPass);const v=es(m),d=Math.ceil(v.length/t.bands),g=[];for(let p=0;p<t.bands;p++){const h=v.slice(p*d,(p+1)*d).reduce((y,b)=>y+=b,0);g.push(h/d)}r(g)},t.updateInterval);return()=>{a(),clearInterval(f)}},[e,JSON.stringify(n)]),o}function ts(e,n){const t=te({fftSize:2048,smoothingTimeConstant:.8,minDecibels:-100,maxDecibels:-80},n),o=ns();if(!o)throw new Error("Audio Context not supported on this browser");let r;e instanceof HTMLAudioElement?r=o.createMediaElementSource(e):r=o.createMediaStreamSource(new MediaStream([e]));const i=o.createAnalyser();i.minDecibels=t.minDecibels,i.maxDecibels=t.maxDecibels,i.fftSize=t.fftSize,i.smoothingTimeConstant=t.smoothingTimeConstant,r.connect(i),e instanceof HTMLAudioElement&&i.connect(o.destination);const a=new Uint8Array(i.frequencyBinCount);return{calculateVolume:()=>{i.getByteFrequencyData(a);let c=0;for(const m of a)c+=Math.pow(m/255,2);return Math.sqrt(c/a.length)},analyser:i,cleanup:async()=>{await o.close()}}}function ns(){const e=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if(e)return new e({latencyHint:"interactive"})}const os=60,Tt=Math.floor(1e3/os),en=240,Lo=2048,Fo=new Array(en).fill(0),rs=e=>{const n=Zt(e,{bands:en,updateInterval:Tt,loPass:0,hiPass:400,analyserOptions:{fftSize:Lo}});return n.length===0?Fo:n},tn=e=>{const{magnitudes:n,binCount:t,gainMultiplier:o}=e;if(n.length===0)return new Array(t).fill(0);const r=Math.ceil(n.length/t),i=[];for(let a=0;a<n.length;a+=r){const l=Math.min(a+r,n.length),s=n.slice(a,l).sort((v,d)=>v-d),c=Math.floor(s.length/2);let f;s.length%2===0?f=(s[c-1]+s[c])/2:f=s[c],f=Math.abs(f),f*=o;const m=f/(f+1);i.push(m)}return i},Oo=(e,n)=>{const t=n.sampleRate,o=e.length,r=n.bandCount,i=n.binCount,a=n.gainMultipliers;if(a.length!==r)throw new Error("gainMultipliers must have length equal to bandCount");const l=o*2,s=t/l,c=e.map((g,p)=>p*s),f=20,m=t/2,v=new Array(r+1).fill(0).map((g,p)=>f*Math.pow(m/f,p/r)),d=new Array(r).fill(null).map(()=>[]);for(let g=0;g<c.length;g+=1)for(let p=0;p<r;p+=1)if(c[g]>=v[p]&&c[g]<v[p+1]){d[p].push(e[g]);break}for(let g=0;g<r;g+=1){const p=d[g],h=a[g];d[g]=tn({magnitudes:p,binCount:i,gainMultiplier:h})}return d},Fn=60,No=48e3,is=1,as=2,ss=40,cs=2;function On({time:e,timeConstant:n}){return 1-Math.exp(-e/n)}function Nn(e,n){const t=n[1]-n[0];return n[0]+e*t}const Ot=e=>{if(!Array.isArray(e)||e.length!==2||typeof e[0]!="number"||typeof e[1]!="number")throw new Error("zip failed - received a value that is not a [number, number] tuple")},us=e=>{const{prevAudioData:n,prevCumulativeAudioData:t,deltaTimeS:o,audioDataRaw:r}=e,i=r.map(v=>v*o*Fn*is),a=On({time:o,timeConstant:as}),l=Ft(n,i).map(v=>(Ot(v),Nn(a,v))),s=r.map(v=>v*o*Fn*ss),c=Ft(t,s).map(v=>(Ot(v),v[0]+v[1])),f=On({time:o,timeConstant:cs}),m=Ft(t,c).map(v=>(Ot(v),Nn(f,v)));return{audioData:l,cumulativeAudioData:m}},Hs=(e,n)=>{const t=rs(e),o=Oo(t,{sampleRate:No,binCount:n.bins,bandCount:n.bands,gainMultipliers:n.gainMultipliers}),r=tn({magnitudes:t,binCount:1,gainMultiplier:1});return{bandMagnitudes:o,cumulativeMagnitude:r}};function ls(){let e=null,n,t=0;const o=350;let r;const i=(l,s,c)=>l+(s-l)*c,a=(l,s)=>{if(l.length!==s.length)return!1;for(let c=0;c<l.length;c++)if(l[c]!==s[c])return!1;return!0};return function(s){const c=performance.now();if(!e)return n={bloopColorMain:new Float32Array(s.bloopColorMain),bloopColorLow:new Float32Array(s.bloopColorLow),bloopColorMid:new Float32Array(s.bloopColorMid),bloopColorHigh:new Float32Array(s.bloopColorHigh)},e={bloopColorMain:new Float32Array(s.bloopColorMain),bloopColorLow:new Float32Array(s.bloopColorLow),bloopColorMid:new Float32Array(s.bloopColorMid),bloopColorHigh:new Float32Array(s.bloopColorHigh)},t=c,r=n,r;let f=!1;const m=["bloopColorMain","bloopColorLow","bloopColorMid","bloopColorHigh"];for(const g of m)if(!a(s[g],e[g])){f=!0;break}f&&(n={bloopColorMain:new Float32Array(r.bloopColorMain),bloopColorLow:new Float32Array(r.bloopColorLow),bloopColorMid:new Float32Array(r.bloopColorMid),bloopColorHigh:new Float32Array(r.bloopColorHigh)},t=c,e={bloopColorMain:new Float32Array(s.bloopColorMain),bloopColorLow:new Float32Array(s.bloopColorLow),bloopColorMid:new Float32Array(s.bloopColorMid),bloopColorHigh:new Float32Array(s.bloopColorHigh)});let v=(c-t)/o;v>1&&(v=1);const d={bloopColorMain:new Float32Array(n.bloopColorMain.length),bloopColorLow:new Float32Array(n.bloopColorLow.length),bloopColorMid:new Float32Array(n.bloopColorMid.length),bloopColorHigh:new Float32Array(n.bloopColorHigh.length)};for(const g of m){const p=n[g].length;for(let h=0;h<p;h++){const y=n[g][h],b=s[g][h];d[g][h]=i(y,b,v)}}return r=d,d}}function ds(e){const n=u.useRef(e);n.current=e;const[t,o]=u.useState(null),r=u.useCallback(i=>{o(i)},[]);return Bt(()=>{const i=new ResizeObserver(a=>{for(const l of a)n.current(l)});return t&&i.observe(t),()=>{i.disconnect()}},[t]),r}const Ke=re.createChild("GLCanvas");function fs({className:e,vert:n,frag:t,Behaviors:o,onViewportUpdate:r,onRenderComplete:i,onGlAvailable:a,onCanvasSizeUpdate:l,scale:s}){const c=u.useRef(null),f=u.useRef(null),[m,v]=u.useState(null),[d,g]=u.useState(),p=u.useRef(sr(b=>{const{width:S,height:D}=b.contentRect,P=Math.floor(Math.min(S!=null?S:0,D!=null?D:0));v(P),r==null||r({width:P,height:P})},100)),h=ds(p.current);if(Bt(()=>{const b=c.current,{width:S,height:D}=b!=null?b:{};if(b&&m!=null&&S&&D){const P=b.getContext("webgl2",{premultipliedAlpha:!0});P?g(P):Ke.error("webgl2 context not supported")}},[m]),Bt(()=>{if(!d)return;const b=d.createProgram(),S=d.createShader(d.VERTEX_SHADER),D=d.createShader(d.FRAGMENT_SHADER);if(!b){Ke.debug("failed to create program");return}if(!S||!D){Ke.debug("failed to create shaders",S,D);return}let P="";if(d.shaderSource(S,n),d.compileShader(S),P+="vertShader:\n".concat(d.getShaderInfoLog(S),"\n"),d.attachShader(b,S),d.shaderSource(D,t),d.compileShader(D),P+="fragShader:\n".concat(d.getShaderInfoLog(D),"\n"),d.attachShader(b,D),d.linkProgram(b),d.useProgram(b),P+=d.getProgramInfoLog(b),!d.getProgramParameter(b,d.LINK_STATUS))throw"Could not compile WebGL program. \n\n".concat(P);f.current=b,Ke.debug("program created"),a==null||a(d,b);const H=d.fenceSync(d.SYNC_GPU_COMMANDS_COMPLETE,0);return H&&(d.waitSync(H,0,d.TIMEOUT_IGNORED),i==null||i()),()=>{Ke.debug("cleaning up"),f.current=null,d.detachShader(b,S),d.detachShader(b,D),d.deleteShader(S),d.deleteShader(D),d.deleteProgram(b)}},[d,t,n]),m!=null&&d&&c.current){const b=c.current,S=m*window.devicePixelRatio*(s!=null?s:1);b.width=S,b.height=S,d.viewport(0,0,S,S),l==null||l({width:S,height:S})}const y=f.current;return k.jsxs("div",{className:e,ref:h,children:[k.jsx("canvas",{ref:c,style:{width:m!=null?m:void 0,height:m!=null?m:void 0}},m),d&&y&&o&&k.jsx(o,{ctx:d,program:y})]})}function ps({GLUniformsSetter:e,textureImage:n,textureName:t,variablesRef:o,className:r,vert:i,frag:a,onViewportUpdate:l,onRenderComplete:s,onGlAvailable:c,onCanvasSizeUpdate:f,scale:m}){const v=u.useRef(void 0),d=u.useCallback(async(h,y)=>{if(v.current=new e(h,y),n&&t){const b=h.createTexture();h.bindTexture(h.TEXTURE_2D,b),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,n);const S=h.getUniformLocation(y,t);h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,b),h.uniform1i(S,0)}c==null||c(h,y)},[e,n,t,c]),g=u.useRef(void 0),p=u.useCallback(()=>{v.current&&o.current&&v.current.setVariablesAndRender(o.current),g.current=requestAnimationFrame(p)},[o]);return u.useEffect(()=>(p(),()=>{g.current&&cancelAnimationFrame(g.current)}),[p]),k.jsx(fs,{className:r,vert:i,frag:a,onViewportUpdate:l,onRenderComplete:s,onGlAvailable:d,onCanvasSizeUpdate:f,scale:m,Behaviors:()=>null})}const ms="{{.assetPrefix}}/assets/noise-watercolor-m3j88gni.webp",vs={src:ms};let Uo;const yt=new window.Image;yt.crossOrigin="anonymous";yt.src=vs.src;yt.onload=()=>{Uo=yt};var hs="#version 300 es\n#define E (2.71828182846)\n#define pi (3.14159265358979323844)\n#define NUM_OCTAVES (4)\n\nprecision highp float;\n\nstruct ColoredSDF {\n  float distance;\n  vec4 color;\n};\n\nstruct SDFArgs {\n  vec2 st;\n  float amount;\n  float duration;\n  float time;\n  float mainRadius;\n};\n\nfloat triangle(float t, float p) {\n  return 2.0 * abs(t / p - floor(t / p + 0.5));\n}\n\nfloat spring(float t, float d) {\n  return 1.0 - exp(-E * 2.0 * t) * cos((1.0 - d) * 115.0 * t);\n}\n\nfloat silkySmooth(float t, float k) {\n  return atan(k * sin((t - 0.5) * pi)) / atan(k) * 0.5 + 0.5;\n}\n\nfloat scaled(float edge0, float edge1, float x) {\n  return clamp((x - edge0) / (edge1 - edge0), float(0), float(1));\n}\n\nfloat fixedSpring(float t, float d) {\n  float s = mix(\n    1.0 - exp(-E * 2.0 * t) * cos((1.0 - d) * 115.0 * t),\n    1.0,\n    scaled(0.0, 1.0, t)\n  );\n  return s * (1.0 - t) + t;\n}\n\nfloat bounce(float t, float d) {\n  return -sin(pi * (1.0 - d) * t) *\n  (1.0 - t) *\n  exp(-2.71828182846 * 2.0 * t) *\n  t *\n  10.0;\n}\n\nfloat random(vec2 st) {\n  return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453123);\n}\n\nfloat random(ivec2 st) {\n  return random(vec2(st));\n}\n\nfloat random(float p) {\n  return random(vec2(p));\n}\n\nfloat opSmoothUnion(float d1, float d2, float k) {\n  if (k <= 0.0) {\n    k = 0.000001;\n  }\n  float h = clamp(0.5 + 0.5 * (d2 - d1) / k, 0.0, 1.0);\n  return mix(d2, d1, h) - k * h * (1.0 - h);\n}\n\nfloat opSmoothSubtraction(float d1, float d2, float k) {\n  if (k <= 0.0) {\n    k = 0.000001;\n  }\n  float h = clamp(0.5 - 0.5 * (d2 + d1) / k, 0.0, 1.0);\n  return mix(d2, -d1, h) + k * h * (1.0 - h);\n}\n\nfloat opSmoothIntersection(float d1, float d2, float k) {\n  if (k <= 0.0) {\n    k = 0.000001;\n  }\n  float h = clamp(0.5 - 0.5 * (d2 - d1) / k, 0.0, 1.0);\n  return mix(d2, d1, h) + k * h * (1.0 - h);\n}\n\nfloat sdRoundedBox(vec2 p, vec2 b, vec4 r) {\n  r.xy = p.x > 0.0 ? r.xy : r.zw;\n  r.x = p.y > 0.0 ? r.x : r.y;\n  vec2 q = abs(p) - b + r.x;\n  return min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - r.x;\n}\n\nfloat sdSegment(vec2 p, vec2 a, vec2 b) {\n  vec2 pa = p - a;\n  vec2 ba = b - a;\n  float h = clamp(dot(pa, ba) / dot(ba, ba), 0.0, 1.0);\n  return length(pa - ba * h);\n}\n\nfloat sdArc(vec2 p, vec2 sca, vec2 scb, float ra, float rb) {\n  p *= mat2(sca.x, sca.y, -sca.y, sca.x);\n  p.x = abs(p.x);\n  return scb.y * p.x > scb.x * p.y\n    ? length(p - ra * scb) - rb\n    : abs(length(p) - ra) - rb;\n}\n\nfloat arc(vec2 st, float startAngle, float length, float radius, float width) {\n  return sdArc(\n    st,\n    vec2(sin(startAngle), cos(startAngle)),\n    vec2(sin(length), cos(length)),\n    radius,\n    width\n  );\n}\n\nvec2 rotate(vec2 v, float a) {\n  float s = sin(a);\n  float c = cos(a);\n  mat2 m = mat2(c, s, -s, c);\n  return m * v;\n}\n\nvec3 blendLinearBurn_13_5(vec3 base, vec3 blend) {\n  \n  return max(base + blend - vec3(1.0), vec3(0.0));\n}\n\nvec3 blendLinearBurn_13_5(vec3 base, vec3 blend, float opacity) {\n  return blendLinearBurn_13_5(base, blend) * opacity + base * (1.0 - opacity);\n}\n\nvec4 permute(vec4 x) {\n  return mod((x * 34.0 + 1.0) * x, 289.0);\n}\nvec4 taylorInvSqrt(vec4 r) {\n  return 1.79284291400159 - 0.85373472095314 * r;\n}\nvec3 fade(vec3 t) {\n  return t * t * t * (t * (t * 6.0 - 15.0) + 10.0);\n}\n\nfloat cnoise(vec3 P) {\n  vec3 Pi0 = floor(P);\n  vec3 Pi1 = Pi0 + vec3(1.0);\n  Pi0 = mod(Pi0, 289.0);\n  Pi1 = mod(Pi1, 289.0);\n  vec3 Pf0 = fract(P);\n  vec3 Pf1 = Pf0 - vec3(1.0);\n  vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n  vec4 iy = vec4(Pi0.yy, Pi1.yy);\n  vec4 iz0 = vec4(Pi0.z);\n  vec4 iz1 = vec4(Pi1.z);\n\n  vec4 ixy = permute(permute(ix) + iy);\n  vec4 ixy0 = permute(ixy + iz0);\n  vec4 ixy1 = permute(ixy + iz1);\n\n  vec4 gx0 = ixy0 / 7.0;\n  vec4 gy0 = fract(floor(gx0) / 7.0) - 0.5;\n  gx0 = fract(gx0);\n  vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);\n  vec4 sz0 = step(gz0, vec4(0.0));\n  gx0 -= sz0 * (step(vec4(0.0), gx0) - 0.5);\n  gy0 -= sz0 * (step(vec4(0.0), gy0) - 0.5);\n\n  vec4 gx1 = ixy1 / 7.0;\n  vec4 gy1 = fract(floor(gx1) / 7.0) - 0.5;\n  gx1 = fract(gx1);\n  vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);\n  vec4 sz1 = step(gz1, vec4(0.0));\n  gx1 -= sz1 * (step(vec4(0.0), gx1) - 0.5);\n  gy1 -= sz1 * (step(vec4(0.0), gy1) - 0.5);\n\n  vec3 g000 = vec3(gx0.x, gy0.x, gz0.x);\n  vec3 g100 = vec3(gx0.y, gy0.y, gz0.y);\n  vec3 g010 = vec3(gx0.z, gy0.z, gz0.z);\n  vec3 g110 = vec3(gx0.w, gy0.w, gz0.w);\n  vec3 g001 = vec3(gx1.x, gy1.x, gz1.x);\n  vec3 g101 = vec3(gx1.y, gy1.y, gz1.y);\n  vec3 g011 = vec3(gx1.z, gy1.z, gz1.z);\n  vec3 g111 = vec3(gx1.w, gy1.w, gz1.w);\n\n  vec4 norm0 = taylorInvSqrt(\n    vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110))\n  );\n  g000 *= norm0.x;\n  g010 *= norm0.y;\n  g100 *= norm0.z;\n  g110 *= norm0.w;\n  vec4 norm1 = taylorInvSqrt(\n    vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111))\n  );\n  g001 *= norm1.x;\n  g011 *= norm1.y;\n  g101 *= norm1.z;\n  g111 *= norm1.w;\n\n  float n000 = dot(g000, Pf0);\n  float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));\n  float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));\n  float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));\n  float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));\n  float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));\n  float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));\n  float n111 = dot(g111, Pf1);\n\n  vec3 fade_xyz = fade(Pf0);\n  vec4 n_z = mix(\n    vec4(n000, n100, n010, n110),\n    vec4(n001, n101, n011, n111),\n    fade_xyz.z\n  );\n  vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);\n  float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x);\n  return 2.2 * n_xyz;\n}\n\nfloat rand(vec2 n) {\n  return fract(sin(dot(n, vec2(12.9898, 4.1414))) * 43758.5453);\n}\n\nfloat noise(vec2 p) {\n  vec2 ip = floor(p);\n  vec2 u = fract(p);\n  u = u * u * (3.0 - 2.0 * u);\n\n  float res = mix(\n    mix(rand(ip), rand(ip + vec2(1.0, 0.0)), u.x),\n    mix(rand(ip + vec2(0.0, 1.0)), rand(ip + vec2(1.0, 1.0)), u.x),\n    u.y\n  );\n  return res * res;\n}\n\nfloat fbm(vec2 x) {\n  float v = 0.0;\n  float a = 0.5;\n  vec2 shift = vec2(100.0);\n  \n  mat2 rot = mat2(cos(0.5), sin(0.5), -sin(0.5), cos(0.5));\n  for (int i = 0; i < NUM_OCTAVES; ++i) {\n    v += a * noise(x);\n    x = rot * x * 2.0 + shift;\n    a *= 0.5;\n  }\n  return v;\n}\n\n/**\n * End new code for colored orb\n */\n\nColoredSDF applyIdleState(\n  ColoredSDF sdf,\n  SDFArgs args,\n  bool isDarkMode /**\n * new bool\n */\n) {\n  float midRadius = 0.12; \n  float maxRadius = 0.3; \n  float t1 = 1.0; \n  float gamma = 3.0; \n  float omega = pi / 2.0; \n\n  \n  float k = exp(-gamma) * omega;\n\n  float radius;\n  if (args.time <= t1) {\n    \n    float t_prime = args.time / t1;\n    \n    float springValue = 1.0 - exp(-gamma * t_prime) * cos(omega * t_prime);\n    radius = midRadius * springValue;\n  } else {\n    \n    float adjustedTime = args.time - t1;\n    \n    radius =\n      midRadius + (maxRadius - midRadius) * (1.0 - exp(-k * adjustedTime));\n  }\n\n  \n  float distance = length(args.st) - radius;\n\n  \n  sdf.distance = mix(sdf.distance, distance, args.amount);\n\n  \n  \n  float alpha = sin(pi / 0.7 * args.time) * 0.3 + 0.7;\n  vec4 color = vec4(isDarkMode ? vec3(1.0) : vec3(0.0), alpha);\n\n  \n  sdf.color = mix(sdf.color, color, args.amount);\n\n  return sdf;\n}\n\nColoredSDF applyIdleStateLegacy(ColoredSDF sdf, SDFArgs args, bool isDarkMode) {\n  float connectedLinearAnimation = scaled(0.0, 2.0, args.duration);\n  float connectedAnimation = fixedSpring(connectedLinearAnimation, 0.96);\n  float circleSize =\n    mix(\n      pow(scaled(0.0, 3.0, args.time), 2.0) * 0.75 + 0.1,\n      1.0,\n      connectedAnimation\n    ) *\n    0.33;\n  vec2 rotatedCoords = rotate(\n    args.st,\n    -args.time * pi -\n      connectedAnimation * pi * 2.0 -\n      pi * 2.0 * 5.0 * silkySmooth(scaled(0.0, 5.0, args.time), 2.0)\n  );\n\n  float strokeWidth = mix(circleSize / 2.0, circleSize, connectedAnimation);\n  float connecting = abs(length(args.st) - circleSize) - strokeWidth;\n\n  float connected = length(args.st) - circleSize;\n  float idleDist = mix(connecting, connected, connectedAnimation);\n\n  float d = min(sdf.distance, idleDist);\n  sdf.distance = mix(sdf.distance, d, args.amount);\n  float angle = atan(rotatedCoords.y, rotatedCoords.x);\n  float alpha = mix(\n    min(1.0, scaled(-pi, pi, angle)),\n    1.0,\n    connectedLinearAnimation\n  );\n\n  float spinningCircleDist =\n    length(\n      rotatedCoords -\n        vec2(-mix(circleSize, strokeWidth, connectedAnimation), 0.0)\n    ) -\n    strokeWidth;\n\n  alpha = min(\n    1.0,\n    max(\n      alpha,\n      smoothstep(0.005, 0.0, spinningCircleDist) + connectedAnimation * 4.0\n    )\n  );\n\n  sdf.color = mix(\n    sdf.color,\n    vec4(isDarkMode ? vec3(1.0) : vec3(0.0), alpha),\n    args.amount\n  );\n  return sdf;\n}\n\nColoredSDF applyListenState(\n  ColoredSDF sdf,\n  SDFArgs args,\n  float micLevel,\n  float listenTimestamp, /* new */\n  float touchDownTimestamp, /* new */\n  float touchUpTimestamp, /* new */\n  bool fadeBloopWhileListening /* new */\n) {\n  float breathingSequence = sin(args.time) * 0.5 + 0.5;\n  float entryAnimation = fixedSpring(scaled(0.0, 3.0, args.duration), 0.9);\n\n  float touch =\n    fixedSpring(scaled(0.0, 1.0, args.time - touchDownTimestamp), 0.99) -\n    fixedSpring(scaled(0.0, 0.8, args.time - touchUpTimestamp), 1.0);\n\n  float listenAnimation = clamp(\n    spring(scaled(0.0, 0.9, args.duration), 1.0),\n    0.0,\n    1.0\n  );\n  float radius = 0.0;\n  float smoothlevel = micLevel;\n  float l1 = smoothlevel;\n  radius = 0.38 + l1 * 0.05 + breathingSequence * 0.03;\n  radius *= 1.0 - (1.0 - entryAnimation) * 0.25;\n\n  float ring = 10000.0;\n\n  \n  if (touch > 0.0) {\n    touch = min(touch, listenAnimation); \n    float arcWidth = radius * 0.1;\n\n    \n    radius -= touch * arcWidth * 2.3;\n    \n    radius = min(\n      radius,\n      mix(radius, args.mainRadius - arcWidth * 2.3 - l1 * 0.01, touch)\n    );\n\n    float startAngle = 0.0;\n    float arcLengthTouch =\n      smoothstep(0.04, 1.0, touch) * pi * (1.0 - arcWidth / 3.0 / radius);\n\n    float arcLength = 0.0;\n    float radiusTouch =\n      radius * fixedSpring(scaled(0.0, 1.0, args.duration), 1.0) * args.amount +\n      l1 * 0.01;\n\n    radiusTouch +=\n      arcWidth * 1.3 * mix(-1.0, 1.0, smoothstep(0.0, 0.12, touch));\n\n    float ringRadius = 0.0;\n    arcLength = arcLengthTouch;\n    ringRadius = radiusTouch;\n    startAngle = pi / 2.0 - (args.time - touchDownTimestamp) / 2.0;\n\n    ring = arc(args.st, startAngle, arcLength, ringRadius, arcWidth); \n  }\n\n  float d = length(args.st) - radius;\n\n  d = min(d, ring);\n\n  sdf.distance = mix(sdf.distance, d, args.amount);\n\n  if (fadeBloopWhileListening) {\n    \n    sdf.color.a = mix(\n      sdf.color.a,\n      mix(1.0, 1.0 - l1 * 0.6, listenAnimation),\n      args.amount\n    );\n  } else {\n    sdf.color.a = 1.0;\n  }\n\n  return sdf;\n}\n\nColoredSDF applyThinkState(ColoredSDF sdf, SDFArgs args) {\n  float d = 1000.0; \n  int count = 5; \n  float entryAnimation = spring(scaled(0.0, 1.0, args.duration), 1.0);\n\n  float thinkingDotEntryAnimation = spring(\n    scaled(0.1, 1.1, args.duration),\n    1.0\n  );\n  float thinkingDotRadius =\n    mix(0.2, 0.06, thinkingDotEntryAnimation) * args.amount;\n\n  \n  args.st.x -= thinkingDotRadius * 0.5 * thinkingDotEntryAnimation;\n\n  for (int i = 0; i < count; i++) {\n    float f = float(float(i) + 0.5) / float(count); \n    float a =\n      -f * pi * 2.0 +\n      args.time / 3.0 +\n      spring(scaled(0.0, 10.0, args.duration), 1.0) * pi / 2.0;\n    float ringRadi = args.mainRadius * 0.45 * entryAnimation;\n\n    \n    ringRadi -=\n      (sin(\n        entryAnimation * pi * 4.0 +\n          a * pi * 2.0 +\n          args.time * 3.0 -\n          silkySmooth(args.time / 4.0, 2.0) * pi * 1.0\n      ) *\n        0.5 +\n        0.5) *\n      args.mainRadius *\n      0.1;\n\n    vec2 pos = vec2(cos(a), sin(a)) * ringRadi;\n    float dd = length(args.st - pos) - args.mainRadius * 0.5;\n\n    \n    d = opSmoothUnion(\n      d,\n      dd,\n      0.03 * scaled(0.0, 10.0, args.duration) + 0.8 * (1.0 - entryAnimation)\n    );\n\n    \n    float dotAngle = f * pi * 2.0;\n    float dotRingRadius =\n      (sin(\n        thinkingDotEntryAnimation * pi * 4.0 +\n          a * pi * 2.0 +\n          args.time * 0.1 * pi * 4.0\n      ) *\n        0.5 +\n        0.5) *\n      thinkingDotRadius *\n      0.3;\n    vec2 dotPos =\n      vec2(-args.mainRadius, args.mainRadius) * 0.8 * thinkingDotEntryAnimation;\n    vec2 dotOffset =\n      vec2(cos(dotAngle + args.time), sin(dotAngle + args.time)) *\n      dotRingRadius;\n    float dotD = length(args.st - dotPos - dotOffset) - thinkingDotRadius * 0.8;\n    d = opSmoothUnion(\n      d,\n      dotD,\n      (1.0 - min(thinkingDotEntryAnimation, args.amount)) * thinkingDotRadius\n    );\n  }\n  sdf.distance = mix(sdf.distance, d, args.amount);\n  sdf.color.a = 1.0;\n  return sdf;\n}\n\nColoredSDF applySpeakState(\n  ColoredSDF sdf,\n  SDFArgs args,\n  vec4 avgMag,\n  float silenceAmount,\n  float silenceDuration\n) {\n  float d = 1000.0;\n  int barCount = 4;\n  for (int i = 0; i < barCount; i++) {\n    float f = float(float(i) + 0.5) / float(barCount); \n\n    \n    float w = 1.0 / float(barCount) * 0.44;\n    float h = w;\n\n    \n    float wave = sin(f * pi * 0.8 + args.time) * 0.5 + 0.5;\n    float entryAnimation = spring(\n      scaled(0.1 + wave * 0.4, 1.0 + wave * 0.4, args.duration),\n      0.98\n    );\n    vec2 pos = vec2(f - 0.5, 0.0) * args.mainRadius * 1.9;\n    pos.y = 0.25 * (1.0 - entryAnimation);\n\n    \n    if (silenceAmount > 0.0) {\n      float bounceStagger = f / 5.0;\n      float bounceDelay = 0.6;\n      float bounceTimer = scaled(\n        bounceDelay,\n        bounceDelay + 1.0,\n        fract((silenceDuration + bounceStagger) / 2.0) * 2.0\n      );\n      pos.y +=\n        bounce(bounceTimer, 6.0) *\n        w *\n        0.25 *\n        silenceAmount *\n        pow(entryAnimation, 4.0) *\n        pow(args.amount, 4.0); \n    }\n\n    \n    h += avgMag[i] * (0.1 + (1.0 - abs(f - 0.5) * 2.0) * 0.1);\n\n    float dd = sdRoundedBox(args.st - pos, vec2(w, h), vec4(w));\n    d = opSmoothUnion(d, dd, 0.2 * (1.0 - args.amount));\n\n  }\n\n  sdf.distance = mix(sdf.distance, d, args.amount);\n  sdf.color.a = 1.0;\n  return sdf;\n}\n\nColoredSDF applyListenAndSpeakState(\n  ColoredSDF sdf,\n  SDFArgs args,\n  float micLevel,\n  vec4 avgMag,\n  vec4 cumulativeAudio,\n  int binCount,\n  vec3 bloopColorMain,\n  vec3 bloopColorLow,\n  vec3 bloopColorMid,\n  vec3 bloopColorHigh,\n  sampler2D uTextureNoise,\n  bool listening,\n  bool isAdvancedBloop\n) {\n  float entryAnimation = fixedSpring(scaled(0.0, 2.0, args.duration), 0.92);\n\n  \n  \n  float radius =\n    (listening ? 0.37 : 0.43) * (1.0 - (1.0 - entryAnimation) * 0.25) +\n    micLevel * 0.065;\n\n  \n  \n  \n  float maxDisplacement = 0.01;\n\n  \n  float oscillationPeriod = 4.0;\n  \n  float displacementOffset =\n    maxDisplacement * sin(2.0 * pi / oscillationPeriod * args.time);\n  \n  vec2 adjusted_st = args.st - vec2(0.0, displacementOffset);\n\n  \n  if (!isAdvancedBloop) {\n    sdf.color = mix(sdf.color, vec4(bloopColorMain, 1.0), args.amount);\n    sdf.distance = mix(sdf.distance, length(adjusted_st) - radius, args.amount);\n    return sdf;\n  }\n\n  \n  \n  vec4 uAudioAverage = avgMag;\n  vec4 uCumulativeAudio = cumulativeAudio;\n\n  \n  float scaleFactor = 1.0 / (2.0 * radius);\n  vec2 uv = adjusted_st * scaleFactor + 0.5;\n  uv.y = 1.0 - uv.y;\n\n  \n  float noiseScale = 1.25; \n  float windSpeed = 0.075; \n  float warpPower = 0.19; \n  float waterColorNoiseScale = 18.0; \n  float waterColorNoiseStrength = 0.01; \n  float textureNoiseScale = 1.0; \n  float textureNoiseStrength = 0.08; \n  float verticalOffset = 0.09; \n  float waveSpread = 1.0; \n  float layer1Amplitude = 1.0; \n  float layer1Frequency = 1.0; \n  float layer2Amplitude = 1.0; \n  float layer2Frequency = 1.0; \n  float layer3Amplitude = 1.0; \n  float layer3Frequency = 1.0; \n  float fbmStrength = 1.0; \n  float fbmPowerDamping = 0.55; \n  float overallSoundScale = 1.0; \n  float blurRadius = 1.0;\n  float timescale = 1.0;\n\n  \n  float time = args.time * timescale * 0.85;\n\n  vec3 sinOffsets = vec3(\n    uCumulativeAudio.x * 0.15 * overallSoundScale,\n    -uCumulativeAudio.y * 0.5 * overallSoundScale,\n    uCumulativeAudio.z * 1.5 * overallSoundScale\n  );\n  verticalOffset += 1.0 - waveSpread;\n\n  \n  float noiseX = cnoise(\n    vec3(\n      uv * 1.0 + vec2(0.0, 74.8572),\n      (time + uCumulativeAudio.x * 0.05 * overallSoundScale) * 0.3\n    )\n  );\n  float noiseY = cnoise(\n    vec3(\n      uv * 1.0 + vec2(203.91282, 10.0),\n      (time + uCumulativeAudio.z * 0.05 * overallSoundScale) * 0.3\n    )\n  );\n\n  uv += vec2(noiseX * 2.0, noiseY) * warpPower;\n\n  \n  float noiseA =\n    cnoise(vec3(uv * waterColorNoiseScale + vec2(344.91282, 0.0), time * 0.3)) +\n    cnoise(\n      vec3(uv * waterColorNoiseScale * 2.2 + vec2(723.937, 0.0), time * 0.4)\n    ) *\n      0.5;\n  uv += noiseA * waterColorNoiseStrength;\n  uv.y -= verticalOffset;\n\n  \n  vec2 textureUv = uv * textureNoiseScale;\n  float textureSampleR0 = texture(uTextureNoise, textureUv).r;\n  float textureSampleG0 = texture(\n    uTextureNoise,\n    vec2(textureUv.x, 1.0 - textureUv.y)\n  ).g;\n  float textureNoiseDisp0 =\n    mix(\n      textureSampleR0 - 0.5,\n      textureSampleG0 - 0.5,\n      (sin(time + uCumulativeAudio.a * 2.0) + 1.0) * 0.5\n    ) *\n    textureNoiseStrength;\n  textureUv += vec2(63.861 + uCumulativeAudio.x * 0.05, 368.937);\n  float textureSampleR1 = texture(uTextureNoise, textureUv).r;\n  float textureSampleG1 = texture(\n    uTextureNoise,\n    vec2(textureUv.x, 1.0 - textureUv.y)\n  ).g;\n  float textureNoiseDisp1 =\n    mix(\n      textureSampleR1 - 0.5,\n      textureSampleG1 - 0.5,\n      (sin(time + uCumulativeAudio.a * 2.0) + 1.0) * 0.5\n    ) *\n    textureNoiseStrength;\n  textureUv += vec2(272.861, 829.937 + uCumulativeAudio.y * 0.1);\n  textureUv += vec2(180.302 - uCumulativeAudio.z * 0.1, 819.871);\n  float textureSampleR3 = texture(uTextureNoise, textureUv).r;\n  float textureSampleG3 = texture(\n    uTextureNoise,\n    vec2(textureUv.x, 1.0 - textureUv.y)\n  ).g;\n  float textureNoiseDisp3 =\n    mix(\n      textureSampleR3 - 0.5,\n      textureSampleG3 - 0.5,\n      (sin(time + uCumulativeAudio.a * 2.0) + 1.0) * 0.5\n    ) *\n    textureNoiseStrength;\n  uv += textureNoiseDisp0;\n\n  \n  vec2 st = uv * noiseScale;\n\n  vec2 q = vec2(0.0);\n  q.x = fbm(\n    st * 0.5 +\n      windSpeed * (time + uCumulativeAudio.a * 0.175 * overallSoundScale)\n  );\n  q.y = fbm(\n    st * 0.5 +\n      windSpeed * (time + uCumulativeAudio.x * 0.136 * overallSoundScale)\n  );\n\n  vec2 r = vec2(0.0);\n  r.x = fbm(\n    st +\n      1.0 * q +\n      vec2(0.3, 9.2) +\n      0.15 * (time + uCumulativeAudio.y * 0.234 * overallSoundScale)\n  );\n  r.y = fbm(\n    st +\n      1.0 * q +\n      vec2(8.3, 0.8) +\n      0.126 * (time + uCumulativeAudio.z * 0.165 * overallSoundScale)\n  );\n\n  float f = fbm(st + r - q);\n  float fullFbm = (f + 0.6 * f * f + 0.7 * f + 0.5) * 0.5;\n  fullFbm = pow(fullFbm, fbmPowerDamping);\n  fullFbm *= fbmStrength;\n\n  \n  blurRadius = blurRadius * 1.5;\n  vec2 snUv =\n    (uv + vec2((fullFbm - 0.5) * 1.2) + vec2(0.0, 0.025) + textureNoiseDisp0) *\n    vec2(layer1Frequency, 1.0);\n  float sn =\n    noise(\n      snUv * 2.0 + vec2(sin(sinOffsets.x * 0.25), time * 0.5 + sinOffsets.x)\n    ) *\n    2.0 *\n    layer1Amplitude;\n  float sn2 = smoothstep(\n    sn - 1.2 * blurRadius,\n    sn + 1.2 * blurRadius,\n    (snUv.y - 0.5 * waveSpread) *\n      (5.0 - uAudioAverage.x * 0.1 * overallSoundScale * 0.5) +\n      0.5\n  );\n\n  vec2 snUvBis =\n    (uv + vec2((fullFbm - 0.5) * 0.85) + vec2(0.0, 0.025) + textureNoiseDisp1) *\n    vec2(layer2Frequency, 1.0);\n  float snBis =\n    noise(\n      snUvBis * 4.0 +\n        vec2(\n          sin(sinOffsets.y * 0.15) * 2.4 + 293.0,\n          time * 1.0 + sinOffsets.y * 0.5\n        )\n    ) *\n    2.0 *\n    layer2Amplitude;\n  float sn2Bis = smoothstep(\n    snBis - (0.9 + uAudioAverage.y * 0.4 * overallSoundScale) * blurRadius,\n    snBis + (0.9 + uAudioAverage.y * 0.8 * overallSoundScale) * blurRadius,\n    (snUvBis.y - 0.6 * waveSpread) * (5.0 - uAudioAverage.y * 0.75) + 0.5\n  );\n\n  vec2 snUvThird =\n    (uv + vec2((fullFbm - 0.5) * 1.1) + textureNoiseDisp3) *\n    vec2(layer3Frequency, 1.0);\n  float snThird =\n    noise(\n      snUvThird * 6.0 +\n        vec2(\n          sin(sinOffsets.z * 0.1) * 2.4 + 153.0,\n          time * 1.2 + sinOffsets.z * 0.8\n        )\n    ) *\n    2.0 *\n    layer3Amplitude;\n  float sn2Third = smoothstep(\n    snThird - 0.7 * blurRadius,\n    snThird + 0.7 * blurRadius,\n    (snUvThird.y - 0.9 * waveSpread) * 6.0 + 0.5\n  );\n\n  sn2 = pow(sn2, 0.8);\n  sn2Bis = pow(sn2Bis, 0.9);\n\n  \n  vec3 sinColor;\n  sinColor = blendLinearBurn_13_5(bloopColorMain, bloopColorLow, 1.0 - sn2);\n  sinColor = blendLinearBurn_13_5(\n    sinColor,\n    mix(bloopColorMain, bloopColorMid, 1.0 - sn2Bis),\n    sn2\n  );\n  sinColor = mix(\n    sinColor,\n    mix(bloopColorMain, bloopColorHigh, 1.0 - sn2Third),\n    sn2 * sn2Bis\n  );\n\n  \n  sdf.color = mix(sdf.color, vec4(sinColor, 1), args.amount);\n\n  \n  sdf.distance = mix(sdf.distance, length(adjusted_st) - radius, args.amount);\n\n  return sdf;\n}\n\nfloat micSdf(vec2 st, float muted) {\n  float d = 100.0;\n  float strokeWidth = 0.03;\n  vec2 elementSize = vec2(0.12, 0.26);\n  vec2 elementPos = vec2(0.0, elementSize.y * 0.585);\n  float element = sdRoundedBox(\n    st - elementPos,\n    elementSize,\n    vec4(min(elementSize.x, elementSize.y))\n  );\n  element = element - strokeWidth;\n  d = min(d, element);\n\n  vec2 standSize = elementSize * 2.2;\n  vec2 standPos = vec2(elementPos.x, elementPos.y - 0.05);\n  st.y += 0.08;\n  float ta = -pi / 2.0; \n  float tb = pi / 2.0; \n  float w = 0.0;\n  float stand = sdArc(\n    st - standPos,\n    vec2(sin(ta), cos(ta)),\n    vec2(sin(tb), cos(tb)),\n    standSize.x,\n    w\n  );\n  stand = min(\n    stand,\n    sdSegment(st - standPos, vec2(standSize.x, 0.06), vec2(standSize.x, 0.0))\n  );\n  stand = min(\n    stand,\n    sdSegment(st - standPos, vec2(-standSize.x, 0.06), vec2(-standSize.x, 0.0))\n  );\n\n  float foot = sdSegment(\n    st - standPos,\n    vec2(0.0, -standSize.x),\n    vec2(0.0, -standSize.x * 1.66)\n  );\n  foot = min(\n    foot,\n    sdSegment(\n      st - standPos,\n      vec2(-standSize.x * 0.68, -standSize.x * 1.66),\n      vec2(standSize.x * 0.68, -standSize.x * 1.66)\n    )\n  );\n  stand = min(stand, foot);\n\n  d = min(d, abs(stand) - strokeWidth);\n\n  return d;\n}\n\nColoredSDF applyBottomAlignedBarsAndMicState(\n  ColoredSDF sdf,\n  SDFArgs args,\n  vec4 avgMag,\n  float micLevel,\n  bool isDarkMode\n) {\n  float d = 1000.0;\n  int barCount = 5;\n  int loopCount = barCount;\n  if (args.amount == 0.0) {\n    loopCount = 1; \n  }\n  for (int i = 0; i < loopCount; i++) {\n    float f = float(float(i) + 0.5) / float(barCount); \n\n    \n    float w = 1.0 / float(barCount) * 0.42;\n    float h = w;\n\n    \n    float entryDuration = 1.8;\n    float entryAnimation =\n      fixedSpring(scaled(0.0, entryDuration, args.duration), 0.94) *\n      args.amount;\n    vec2 pos = vec2(f - 0.5, 0.0) * args.mainRadius * 1.9;\n    pos.x *= entryAnimation;\n\n    if (i == 0) {\n      float micScale = mix(6.0 - micLevel * 2.0, 6.0, args.amount);\n      float yOffset = w * 2.0;\n      d =\n        micSdf(\n          (args.st - pos + vec2(-w * 0.15 * args.amount, yOffset)) * micScale,\n          1.0 - args.amount\n        ) /\n        micScale;\n    } else {\n      \n      h += avgMag[i - 1] * (0.1 + (1.0 - abs(f - 0.5) * 2.0) * 0.1) * 0.7;\n      h = mix(w, h, smoothstep(0.8, 1.0, entryAnimation));\n\n      float bubbleInDur = 0.5;\n      float bubbleOutDur = 0.4;\n\n      \n      float bubbleEffect =\n        fixedSpring(\n          scaled(\n            f / 4.0,\n            f / 4.0 + bubbleInDur,\n            args.duration - entryDuration / 8.0\n          ),\n          1.0\n        ) *\n        pow(\n          1.0 -\n            scaled(\n              f / 8.0 + bubbleInDur / 8.0,\n              f / 4.0 + bubbleInDur / 8.0 + bubbleOutDur,\n              args.duration - entryDuration / 8.0\n            ),\n          2.0\n        );\n\n      h += bubbleEffect * min(h, w);\n\n      \n      w *= args.amount;\n      h *= args.amount;\n\n      h = min(h, 0.23); \n\n      pos.y -= 0.25;\n      pos.y += h;\n      pos.y += bubbleEffect * w * 0.5;\n\n      float dd = sdRoundedBox(args.st - pos, vec2(w, h), vec4(w));\n      d = min(d, dd);\n    }\n  }\n\n  sdf.distance = d; \n  sdf.color = mix(\n    sdf.color,\n    isDarkMode\n      ? vec4(1.0)\n      : vec4(0.0, 0.0, 0.0, 1.0),\n    args.amount\n  );\n  return sdf;\n}\n\nColoredSDF applyHaltState(ColoredSDF sdf, SDFArgs args) {\n  \n  float radius = mix(\n    0.4,\n    mix(0.4, 0.45, args.amount),\n    sin(args.time * 0.25) * 0.5 + 0.5\n  );\n  float strokeWidth = mix(radius / 2.0, 0.02, args.amount);\n\n  \n  radius -= strokeWidth;\n\n  radius *= mix(0.7, 1.0, args.amount);\n  float circle = abs(length(args.st) - radius) - strokeWidth;\n\n  sdf.distance = mix(sdf.distance, circle, args.amount);\n  sdf.color.a = mix(sdf.color.a, pow(0.8, 2.2), scaled(0.5, 1.0, args.amount));\n  return sdf;\n}\n\nvec3 blendNormal(vec3 base, vec3 blend) {\n  return blend;\n}\n\nvec3 blendNormal(vec3 base, vec3 blend, float opacity) {\n  return blendNormal(base, blend) * opacity + base * (1.0 - opacity);\n}\n\nin vec2 out_uv;\nout vec4 fragColor;\n\nlayout(std140) uniform BlorbUniformsObject {\n  float time;\n  float micLevel;\n  float touchDownTimestamp;\n  float touchUpTimestamp;\n  float stateListen;\n  float listenTimestamp;\n  float stateThink;\n  float thinkTimestamp;\n  float stateSpeak;\n  float speakTimestamp;\n  float readyTimestamp;\n  float stateHalt;\n  float haltTimestamp;\n  float stateFailedToConnect;\n  float failedToConnectTimestamp;\n  vec4 avgMag;\n  vec4 cumulativeAudio;\n  vec2 viewport;\n  float screenScaleFactor;\n  float silenceAmount;\n  float silenceTimestamp;\n  bool isDarkMode;\n  bool fadeBloopWhileListening;\n  bool isNewBloop;\n  bool isAdvancedBloop;\n  vec3 bloopColorMain;\n  vec3 bloopColorLow;\n  vec3 bloopColorMid;\n  vec3 bloopColorHigh;\n} ubo; \n\nuniform sampler2D uTextureNoise; \n\nvoid main() {\n  vec2 st = out_uv - 0.5;\n  float viewRatio = ubo.viewport.y / ubo.viewport.x;\n  st.y *= viewRatio;\n\n  ColoredSDF sdf;\n  sdf.distance = 1000.0;\n  sdf.color = vec4(1.0);\n\n  SDFArgs args;\n  args.st = st;\n  args.time = ubo.time;\n  args.mainRadius = 0.49;\n\n  SDFArgs idleArgs = args;\n  SDFArgs listenArgs = args;\n  SDFArgs thinkArgs = args;\n  SDFArgs speakArgs = args;\n  SDFArgs haltArgs = args;\n  SDFArgs failedToConnectArgs = args;\n\n  idleArgs.amount = 1.0;\n  listenArgs.amount = ubo.stateListen;\n  thinkArgs.amount = ubo.stateThink;\n  speakArgs.amount = ubo.stateSpeak;\n  haltArgs.amount = ubo.stateHalt;\n  failedToConnectArgs.amount = ubo.stateFailedToConnect;\n\n  idleArgs.duration = ubo.time - ubo.readyTimestamp;\n  listenArgs.duration = ubo.time - ubo.listenTimestamp;\n  thinkArgs.duration = ubo.time - ubo.thinkTimestamp;\n  speakArgs.duration = ubo.time - ubo.speakTimestamp;\n  haltArgs.duration = ubo.time - ubo.haltTimestamp;\n  failedToConnectArgs.duration = ubo.time - ubo.failedToConnectTimestamp;\n\n  if (ubo.isNewBloop) {\n    sdf = applyIdleState(sdf, idleArgs, ubo.isDarkMode);\n  } else {\n    sdf = applyIdleStateLegacy(sdf, idleArgs, ubo.isDarkMode);\n  }\n\n  if (failedToConnectArgs.amount > 0.0) {\n    sdf = applyHaltState(sdf, failedToConnectArgs);\n  }\n\n  if (listenArgs.amount > 0.0) {\n    if (ubo.isAdvancedBloop) {\n      if (speakArgs.amount > 0.0) {\n        listenArgs.amount = 1.0;\n      }\n\n      \n      int binCount = 1;\n      sdf = applyListenAndSpeakState(\n        sdf,\n        listenArgs,\n        ubo.micLevel,\n        ubo.avgMag,\n        ubo.cumulativeAudio,\n        binCount,\n        ubo.bloopColorMain,\n        ubo.bloopColorLow,\n        ubo.bloopColorMid,\n        ubo.bloopColorHigh,\n        uTextureNoise,\n        true,\n        ubo.isAdvancedBloop\n      );\n    } else {\n      sdf = applyListenState(\n        sdf,\n        listenArgs,\n        ubo.micLevel,\n        ubo.listenTimestamp,\n        ubo.touchDownTimestamp,\n        ubo.touchUpTimestamp,\n        ubo.fadeBloopWhileListening\n      );\n    }\n  }\n\n  if (thinkArgs.amount > 0.0) {\n    sdf = applyThinkState(sdf, thinkArgs);\n  }\n\n  if (speakArgs.amount > 0.0) {\n    if (ubo.isAdvancedBloop) {\n      int binCount = 1;\n      sdf = applyListenAndSpeakState(\n        sdf,\n        speakArgs,\n        ubo.micLevel,\n        ubo.avgMag,\n        ubo.cumulativeAudio,\n        binCount,\n        ubo.bloopColorMain,\n        ubo.bloopColorLow,\n        ubo.bloopColorMid,\n        ubo.bloopColorHigh,\n        uTextureNoise,\n        false,\n        ubo.isAdvancedBloop\n      );\n    } else {\n      float silenceDuration = ubo.time - ubo.silenceTimestamp;\n      sdf = applySpeakState(\n        sdf,\n        speakArgs,\n        ubo.avgMag,\n        ubo.silenceAmount,\n        silenceDuration\n      );\n    }\n  }\n\n  if (haltArgs.amount > 0.0) {\n    sdf = applyHaltState(sdf, haltArgs);\n  }\n\n  float clampingTolerance = 0.0075 / ubo.screenScaleFactor;\n  float clampedShape = smoothstep(clampingTolerance, 0.0, sdf.distance);\n  float alpha = sdf.color.a * clampedShape;\n  if (!ubo.isNewBloop) {\n    alpha *= scaled(0.0, 1.0, ubo.time);\n  }\n  fragColor = vec4(sdf.color.rgb * alpha, alpha);\n}",gs="#version 300 es\n\nout vec4 out_position;\nout vec2 out_uv;\n\nconst vec4 blitFullscreenTrianglePositions[6] = vec4[](\n  vec4(-1.0, -1.0, 0.0, 1.0),\n  vec4(3.0, -1.0, 0.0, 1.0),\n  vec4(-1.0, 3.0, 0.0, 1.0),\n  vec4(-1.0, -1.0, 0.0, 1.0),\n  vec4(3.0, -1.0, 0.0, 1.0),\n  vec4(-1.0, 3.0, 0.0, 1.0)\n);\n\nvoid main() {\n  out_position = blitFullscreenTrianglePositions[gl_VertexID];\n  out_uv = out_position.xy * 0.5 + 0.5;\n  out_uv.y = 1.0 - out_uv.y;\n  gl_Position = out_position;\n}",je,Ze,ye,qe,We,Pe,Le,wt;const Ct=class Ct{constructor(n,t){ke(this,je);ke(this,Ze);ke(this,ye);ke(this,qe,[]);ke(this,We,{});ke(this,Pe);ke(this,Le);_e(this,ye,n);const o=n.getUniformBlockIndex(t,G(Ct,wt)),r=n.getActiveUniformBlockParameter(t,o,n.UNIFORM_BLOCK_DATA_SIZE);_e(this,Pe,n.createBuffer()),n.bindBuffer(n.UNIFORM_BUFFER,G(this,Pe)),n.bufferData(n.UNIFORM_BUFFER,r,n.DYNAMIC_DRAW);const i=0;n.bindBufferBase(n.UNIFORM_BUFFER,i,G(this,Pe)),n.uniformBlockBinding(t,o,i);const a=n.getActiveUniformBlockParameter(t,o,n.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES);_e(this,qe,[]),_e(this,We,{});for(let l=0;l<a.length;l++){const s=a[l],c=n.getActiveUniform(t,s);if(!c)throw new Error("No uniformInfo for index "+s);let f=c.name;f=f.replace(/\[0\]$/,"");const m=n.getActiveUniforms(t,[s],n.UNIFORM_OFFSET)[0];G(this,qe).push(f),G(this,We)[f]=m}_e(this,Le,new ArrayBuffer(r)),_e(this,je,new Float32Array(G(this,Le))),_e(this,Ze,new Int32Array(G(this,Le)))}setVariablesAndRender(n){for(const t of G(this,qe)){const[,o]=t.split("."),i=G(this,We)[t]/4,a=n[o];typeof a=="number"?G(this,je)[i]=a:typeof a=="boolean"?G(this,Ze)[i]=a?1:0:Array.isArray(a)&&G(this,je).set(a,i)}G(this,ye).bindBuffer(G(this,ye).UNIFORM_BUFFER,G(this,Pe)),G(this,ye).bufferSubData(G(this,ye).UNIFORM_BUFFER,0,G(this,Le)),G(this,ye).drawArrays(G(this,ye).TRIANGLE_STRIP,0,6)}};je=new WeakMap,Ze=new WeakMap,ye=new WeakMap,qe=new WeakMap,We=new WeakMap,Pe=new WeakMap,Le=new WeakMap,wt=new WeakMap,ke(Ct,wt,"BlorbUniformsObject");let Ht=Ct;function B(e){const n=e.replace("#",""),t=parseInt(n.substring(0,2),16)/255,o=parseInt(n.substring(2,4),16)/255,r=parseInt(n.substring(4,6),16)/255;return new Float32Array([t,o,r])}const Ye={BLUE:{bloopColorMain:B("#DCF7FF"),bloopColorLow:B("#0181FE"),bloopColorMid:B("#A4EFFF"),bloopColorHigh:B("#FFFDEF")},DARK_BLUE:{bloopColorMain:B("#DAF5FF"),bloopColorLow:B("#0066CC"),bloopColorMid:B("#2EC6F5"),bloopColorHigh:B("#72EAF5")},GREYSCALE:{bloopColorMain:B("#D7D7D7"),bloopColorLow:B("#303030"),bloopColorMid:B("#989898"),bloopColorHigh:B("#FFFFFF")},WHITE:{bloopColorMain:B("#FFFFFF"),bloopColorLow:B("#FFFFFF"),bloopColorMid:B("#FFFFFF"),bloopColorHigh:B("#FFFFFF")},BLACK:{bloopColorMain:B("#000000"),bloopColorLow:B("#000000"),bloopColorMid:B("#000000"),bloopColorHigh:B("#000000")},ANGSTY_BLACK:{bloopColorMain:B("#494949"),bloopColorLow:B("#000000"),bloopColorMid:B("#7F7F7F"),bloopColorHigh:B("#696969")},HELLO_TIBOR:{bloopColorMain:B("#FFE987"),bloopColorLow:B("#E58B28"),bloopColorMid:B("#FB7256"),bloopColorHigh:B("#F3FDFE")}},bs=({isAdvanced:e,overrideColor:n})=>{const t=$n();return n&&Ye[n]?Ye[n]:e?Ye.BLUE:t?Ye.WHITE:Ye.BLACK},Un=[300,300],Ss={bands:4,loPass:0,hiPass:400},ys=e=>{const n=Zt(e,{bands:en,updateInterval:Tt,loPass:0,hiPass:400,analyserOptions:{fftSize:Lo}});return n.length===0?Fo:n},ws=(e,n)=>{const t=ys(e),o=Oo(t,{sampleRate:No,binCount:n.bins,bandCount:n.bands,gainMultipliers:n.gainMultipliers}),r=tn({magnitudes:t,binCount:1,gainMultiplier:1});return{bandMagnitudes:o,cumulativeMagnitude:r}},Cs=e=>{const[n,t]=u.useState({audioData:[0,0,0,0],cumulativeAudioData:[0,0,0,0]}),o=u.useRef([0,0,0,0]),r=u.useRef(void 0),i=u.useRef(performance.now()),{bandMagnitudes:a,cumulativeMagnitude:l}=ws(e,{bands:3,bins:1,gainMultipliers:[10,1,1]});o.current=[...a,l].flat();const s=u.useCallback(()=>{const c=performance.now(),f=(c-i.current)/1e3;i.current=c;const m=o.current,{audioData:v,cumulativeAudioData:d}=n,g=us({deltaTimeS:f,audioDataRaw:m,prevAudioData:v,prevCumulativeAudioData:d});t(g)},[n]);return u.useEffect(()=>(r.current||(r.current=window.setInterval(s,Tt)),()=>{clearInterval(r.current),r.current=void 0}),[s]),n},zn=Promise.resolve();function zo({url:e,readyToPlay:n}){const t=u.useRef(void 0),o=u.useRef(zn);return u.useEffect(()=>(t.current||(t.current=document.createElement("audio")),()=>{o.current.then(()=>{t.current&&(t.current.pause(),t.current.removeAttribute("src"),t.current.remove(),o.current=zn)})}),[]),u.useEffect(()=>{e&&t.current&&t.current.src!==e&&n&&o.current.then(()=>{t.current&&(t.current.crossOrigin="anonymous",t.current.src=e,o.current=t.current.play())})},[n,e]),t.current}function Ts({className:e,url:n}){const[t,o]=u.useState(!1),r=zo({url:n,readyToPlay:t}),i=Zt(r,Ss),a=u.useMemo(()=>[0,0,0,0],[]);return k.jsx(Vo,{className:e,isAdvanced:!1,avgMag:i,cumulativeAudioData:a,onRenderComplete:()=>o(!0)})}function xs({className:e,url:n,overrideColor:t}){const[o,r]=u.useState(!1),i=zo({url:n,readyToPlay:o}),a=Cs(i),{audioData:l,cumulativeAudioData:s}=a;return k.jsx(Vo,{className:e,isAdvanced:!0,overrideColor:t,avgMag:l,cumulativeAudioData:s,onRenderComplete:()=>r(!0)})}const Vo=({className:e,avgMag:n,cumulativeAudioData:t,isAdvanced:o,overrideColor:r,onRenderComplete:i})=>{const a=$n(),l=u.useMemo(()=>performance.now()/1e3,[]),s=u.useMemo(()=>performance.now()/1e3,[]),c=u.useRef(void 0),f=u.useRef(ls()),[m,v]=u.useState(Un),{canvasSizeRef:d,handleCanvasSizeUpdate:g}=Jr(Un),p=u.useCallback(H=>{v([H.width,H.height])},[]),[h,y]=u.useState(performance.now()/1e3);u.useEffect(()=>{const H=setInterval(()=>{y(performance.now()/1e3)},Tt);return()=>clearInterval(H)},[]);const b=bs({isAdvanced:o,overrideColor:r}),S=f.current(b),D=$a({viewport:m,canvasSize:d.current,shouldMeasurePerf:!0,source:"VoicePicker"}),P=Ya({shouldCalibrate:!0,viewport:m,initialScale:1});return c.current={time:h,micLevel:0,stateListen:0,listenTimestamp:0,stateThink:0,thinkTimestamp:0,stateSpeak:1,speakTimestamp:s,readyTimestamp:l,stateHalt:0,haltTimestamp:0,touchDownTimestamp:0,touchUpTimestamp:0,stateFailedToConnect:0,failedToConnectTimestamp:0,avgMag:n,cumulativeAudio:t,isNewBloop:!0,isAdvancedBloop:o,bloopColorMain:Array.from(S.bloopColorMain),bloopColorLow:Array.from(S.bloopColorLow),bloopColorMid:Array.from(S.bloopColorMid),bloopColorHigh:Array.from(S.bloopColorHigh),isDarkMode:a,screenScaleFactor:window.devicePixelRatio,viewport:m,silenceAmount:0,silenceTimestamp:0,fadeBloopWhileListening:!1},k.jsx(ps,{className:Ve("flex items-center justify-center",e),variablesRef:c,onViewportUpdate:p,onRenderComplete:i,textureImage:Uo,textureName:"uTextureNoise",onGlAvailable:D,onCanvasSizeUpdate:g,scale:P,GLUniformsSetter:Ht,vert:gs,frag:hs})};function ks({isUnauthenticated:e,loading:n,handleLoginClick:t,handleCancelClick:o,handleConfirmClick:r,selectedVoice:i,currentVoiceName:a,cameFromNux:l}){const s="w-52 whitespace-nowrap rounded-full px-20 py-3 font-semibold";return e?k.jsxs(k.Fragment,{children:[k.jsx(ct,{className:Ve(s,"text-white"),onClick:t,children:n?k.jsx(ln,{}):k.jsx(Re,{id:"IRALWH",defaultMessage:"Log in"})}),k.jsx(ct,{className:Ve(s,"text-black dark:text-white"),color:"ghost",onClick:o,children:k.jsx(Re,{id:"8fumUc",defaultMessage:"Back to chat"})})]}):k.jsxs(k.Fragment,{children:[k.jsx(ct,{className:Ve(s,"text-white"),onClick:r,children:n?k.jsx(ln,{}):(i==null?void 0:i.voice)===a&&!l?k.jsx(Re,{id:"MyKAgb",defaultMessage:"Done"}):k.jsx(Re,{id:"7+3LaJ",defaultMessage:"Start new chat"})}),k.jsx(ct,{className:Ve(s,"text-black dark:text-white"),color:"ghost",onClick:o,children:k.jsx(Re,{id:"dUn4Wd",defaultMessage:"Cancel"})})]})}const As={offscreenLeft:{x:"-24rem",opacity:0},left:{x:"-12rem",opacity:.5},center:{x:"0",opacity:1},right:{x:"12rem",opacity:.5},offscreenRight:{x:"24rem",opacity:0}};function $s({conversationId:e,onClose:n,cameFromNux:t=!1,initialVoiceName:o}){const r=$t(),i=!cr(r),{voiceName:a}=to(),l=ue(),s=Hn(),c=Yn(),[f,m]=u.useState(!1),v=zt.getGizmoId(Vt(e)),[d,g]=u.useState(!1),[p,h]=u.useState(!1);u.useEffect(()=>{requestAnimationFrame(()=>g(!0))},[]);const[y,b]=u.useState(!1),[S,D]=u.useState(null);u.useEffect(()=>{if(c.length>0){const q=c.findIndex(ne=>ne.voice===(o||a));q>=0?D(q):D(2),b(!0)}},[c,a,o]);const P=S!=null?(S-2+c.length)%c.length:0,H=S!=null?(S-1+c.length)%c.length:1,$=S!=null?(S+1)%c.length:3,le=S!=null?(S+2)%c.length:4,O=c[S!=null?S:0],X=c[P],E=c[H],U=c[$],K=c[le],T=ii(),{alreadyTriggered:I,setAlreadyTriggered:_}=ai();u.useEffect(()=>{if(T&&!I){const q=c.findIndex(ne=>ne.voice==="shade");q!==-1&&(D(q),_())}return()=>{T&&_()}},[T,I,c,D,_]);const R=u.useMemo(()=>{if(T&&(O==null?void 0:O.voice)==="shade")return"ANGSTY_BLACK"},[O==null?void 0:O.voice,T]),J=q=>{D(q)},{stopVoiceMode:z,startVoiceMode:j}=Wa({requestMicPermissions:t}),{setValue:V}=ni(ur.VoiceName),Y=Me(q=>q.voiceMode),de=t&&!v?"advanced":Y,pe=u.useCallback(()=>{h(!t),setTimeout(()=>{var ne,ve;const q=S!=null?(ne=c[S])==null?void 0:ne.voice:(ve=c[0])==null?void 0:ve.voice;sessionStorage.setItem("selectedVoiceName",q),lr(r,{fallbackScreenHint:"login",callback:ie=>{dr.logLogInButtonClicked({provider:ie,location:"Voice Picker Page"})},skipLoginModal:!1})},At)},[t,r,S,c]),we=u.useCallback(async()=>{h(!t),setTimeout(async()=>{var ne,ve;m(!0);const q=S!=null?(ne=c[S])==null?void 0:ne.voice:(ve=c[0])==null?void 0:ve.voice;if(t||q!==a){t||W.voiceSelected.click({action:"changed",voice:q}),V(q),await z(),eo("/");try{t?l.setState(ie=>{ie.isVoiceModeActive=!0}):await j({conversation_id:void 0,eventSource:"voice_picker",voice_mode:de,voice:q,clientThreadId:fr(),gizmo_id:zt.getGizmoId(Vt(e)),skipCacheReason:"user-switched-voice"})}catch(ie){pr.addError("Failed to start voice mode after voice picker: ".concat(ie),{protocol:s})}}else W.voiceSelected.click({action:"kept",voice:a});m(!1),n()},At)},[t,e,a,n,S,V,j,z,de,c,l,s]),me=()=>{h(!0),setTimeout(n,At)};Zr({setSelectedVoiceIndex:D,prevVoiceIndex:H,nextVoiceIndex:$});const[Ee,Oe]=u.useState(!1),De=q=>{q==="prev"?J(H):q==="next"&&J($),Oe(!0),setTimeout(()=>{Oe(!1)},175)},Ce=u.useMemo(()=>({className:"h-max min-h-bloop w-max min-w-bloop",url:O==null?void 0:O.preview_url}),[O==null?void 0:O.preview_url]);return!y||S==null?k.jsx("div",{className:"bg-token-main-surface-primary fixed start-0 top-0 z-50 flex h-full w-full"}):k.jsxs("div",{className:"fixed start-0 top-0 z-50 flex h-full w-full flex-col items-center justify-center bg-white transition-opacity duration-300 dark:bg-gray-800 ".concat(d&&!p?"opacity-100":"opacity-0"),children:[k.jsx("h1",{className:"mt-36 mb-8 text-3xl font-semibold",children:i?k.jsx(Re,{id:"P4GR/e",defaultMessage:"Try voice mode for free"}):k.jsx(Re,{id:"2whyE9",defaultMessage:"Choose a voice"})}),k.jsx("div",{className:"flex h-full w-full items-center justify-center",children:O?t&&!v||de==="advanced"?k.jsx(xs,xe(te({},Ce),{overrideColor:R})):k.jsx(Ts,te({},Ce)):null}),k.jsx("div",{className:"mb-8 flex items-center justify-between text-center",children:k.jsxs("div",{className:"relative flex h-24 w-48",children:[k.jsx(Qe,{voice:X,variant:"offscreenLeft"},X==null?void 0:X.name),k.jsx(Qe,{voice:E,variant:"left",onClick:()=>J(H)},E==null?void 0:E.name),k.jsx(Vn,{direction:"prev",onClick:()=>De("prev"),isFading:Ee}),k.jsx(Qe,{voice:O,variant:"center"},O==null?void 0:O.name),k.jsx(Vn,{direction:"next",onClick:()=>De("next"),isFading:Ee}),k.jsx(Qe,{voice:U,variant:"right",onClick:()=>J($)},U==null?void 0:U.name),k.jsx(Qe,{voice:K,variant:"offscreenRight"},K==null?void 0:K.name),k.jsx("div",{className:"pointer-events-none absolute h-full w-full -translate-x-52 transform bg-linear-to-r from-[var(--main-surface-background)] to-transparent"}),k.jsx("div",{className:"pointer-events-none absolute h-full w-full translate-x-52 transform bg-linear-to-l from-[var(--main-surface-background)] to-transparent"}),k.jsx("div",{className:"pointer-events-none absolute h-full w-full -translate-x-96 transform bg-white dark:bg-gray-800"}),k.jsx("div",{className:"pointer-events-none absolute h-full w-full translate-x-96 transform bg-white dark:bg-gray-800"})]})}),k.jsx("div",{className:"mb-36 flex flex-col space-y-3",children:k.jsx(ks,{isUnauthenticated:i,loading:f,handleLoginClick:pe,handleCancelClick:me,handleConfirmClick:we,selectedVoice:O,currentVoiceName:a,cameFromNux:t})})]})}function Qe({voice:e,variant:n,onClick:t}){return k.jsxs(hr.button,{onClick:t,className:"absolute flex w-48 flex-col items-center justify-center select-none",variants:As,animate:n,initial:n,transition:{duration:.25,ease:"easeInOut"},children:[k.jsx("p",{className:"text-lg ".concat(n==="center"?"font-semibold":""),children:e==null?void 0:e.name}),k.jsx("p",{className:"text-sm text-gray-600 dark:text-[var(--text-secondary)]",children:e==null?void 0:e.description})]})}function Vn({direction:e,onClick:n,isFading:t}){const o=e==="prev"?ei:ti,r=Kn(),i=e==="prev"?r.formatMessage({id:"ajuz05",defaultMessage:"Previous voice"}):r.formatMessage({id:"Dr8wrw",defaultMessage:"Next voice"});return k.jsx("button",{className:Ve("absolute top-2 z-50 transition-opacity duration-175",e==="prev"?"-start-4":"-end-4",t?"opacity-20":"opacity-100"),onClick:n,"aria-label":i,children:k.jsx(o,{className:"text-token-text-quaternary hover:text-token-text-secondary h-6 w-6"})})}export{la as $,Xe as A,Tt as B,zs as C,_o as F,ps as G,Us as I,Bs as L,Ls as N,Fs as O,Tn as R,ci as S,js as T,$s as V,pa as W,Os as Y,St as _,si as a,Oa as b,Ps as c,Ia as d,oo as e,Jt as f,Ws as g,dt as h,Hs as i,us as j,bs as k,$a as l,Ya as m,hs as n,Ht as o,Uo as p,Zt as q,ii as r,ri as s,ai as t,Wa as u,gs as v,Vs as w,qs as x,Ns as y};
//# sourceMappingURL=n83t8t0535fblt5w.js.map

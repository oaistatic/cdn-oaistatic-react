import{r as n,u as q,b as I,g as A,j as c,al as K,n as O,ae as B,D as U}from"./n75kuy1cx6f5mogg.js";import{kh as N,f as Q,ra as H,fq as z}from"./ewse8exzafeu10ji.js";import{W as $}from"./fttw4cm966c4jk9k.js";import{v as G,x as J,n as V,W as X,m as Y,o as Z,q as D,y as ee}from"./fmsmhem5hrm2cxrs.js";import{le as te,jQ as P,jR as L}from"./ny10lj7zpuz89fvf.js";import{u as re}from"./nyfr63odztw7y2ja.js";import{b as ne,g as oe,T as se,W as ue,c as ae}from"./on3o5me2wsmfitl8.js";import{u as ie}from"./ocpay82kuu2581xo.js";import"./h2dwuj1m5ps9l7uv.js";import"./j2ui4c2m3nj8pqst.js";import"./jx9lof8tzg97x4l9.js";import"./e2tpmvaykwot5faa.js";import"./ne36kgu5w1zang50.js";import"./frf4c35l48b0bjrb.js";import"./h76aawyn0y8q6s6p.js";import"./jocaiq9wugboh64i.js";import"./heyok871zyju5auh.js";import"./ltsv6em2m484o9yy.js";import"./kas18igmwglc2mb4.js";import"./fno7ypwqdtl0x211.js";import"./i70dhxk1j381usod.js";import"./j4iu4cyxlby9nd33.js";import"./jhe3wdj1wdglvpku.js";import"./eq0refymwif7pcpz.js";import"./iquhayvbn8ec35rz.js";import"./lptwpbjabrvjmhsj.js";import"./jwsjryhasdl9p2nq.js";import"./go4mpxmt63qgntp4.js";import"./fzrn137102spawew.js";import"./dv12g54ivgixitjp.js";import"./d5vv6ct7n3prp63a.js";import"./hkwix64yhkotslv1.js";import"./5hoqitp3r2hkdtny.js";import"./hm7mxp554vts8hxt.js";import"./j2tluvxda4ll72qx.js";import"./abgjeqojg38moqsp.js";import"./ca0tcsne49xiprm9.js";import"./gbvlxp0nrrwdd6eq.js";import"./n9nk4w8voewwsboc.js";import"./i3bw46mavo9n01l8.js";import"./ga8p3rr9o0mc72h0.js";function me(){return n.useSyncExternalStore(t=>(document.addEventListener("focusin",t),document.addEventListener("focusout",t),()=>{document.removeEventListener("focusin",t),document.removeEventListener("focusout",t)}),()=>{var t;return typeof document<"u"&&((t=document.activeElement)==null?void 0:t.hasAttribute("data-wham-comment-textarea"))===!0},()=>!1)}function ce(t){var k,_,M,T,h,w,E;const a=q(),i=N(),m=me(),{data:e,error:l}=G(t,{refetchOnWindowFocus:!0,refetchOnMount:!0}),{isLoading:d}=J(t),o=V(n.useCallback(({getTurnsForTask:s})=>{var u;return(u=s(t))!=null?u:[]},[t])),{focusedAssistantTurn:r,setFocusedAssistantTurnId:S}=ne({taskId:t,task:e==null?void 0:e.task,currentUserTurn:(k=e==null?void 0:e.current_user_turn)!=null?k:null,currentAssistantTurn:(_=e==null?void 0:e.current_assistant_turn)!=null?_:null}),v=n.useMemo(()=>{var s,u;return oe({focusedAssistantTurn:r,pastTurns:o,currentDiffTaskTurnId:(u=(s=e==null?void 0:e.current_diff_task_turn)==null?void 0:s.id)!=null?u:null})},[r,(M=e==null?void 0:e.current_diff_task_turn)==null?void 0:M.id,o]),p=(T=e==null?void 0:e.task)==null?void 0:T.current_turn_id,C=!!(e!=null&&e.task.has_unread_turn)&&p===((h=e==null?void 0:e.current_assistant_turn)==null?void 0:h.id),g=((w=e==null?void 0:e.current_assistant_turn)==null?void 0:w.turn_status)==="completed";n.useEffect(()=>{var f;if(!i)return;const s=(f=e==null?void 0:e.task)==null?void 0:f.title;if(!s)return;const u=document.title;return document.title=s,()=>{document.title=u}},[i,(E=e==null?void 0:e.task)==null?void 0:E.title]),n.useEffect(()=>{!C||!g||X.markTurnAsRead(t).then(()=>{a.invalidateQueries({queryKey:["wham","tasks"]}),a.invalidateQueries({queryKey:["wham","task",t]})})},[C,g,t,a]);const b=n.useMemo(()=>{var W,x,j,y;const s=r?Y(r.turn_status):!1,u=((j=r==null?void 0:r.sibling_turn_ids)==null?void 0:j.includes((x=(W=e==null?void 0:e.current_assistant_turn)==null?void 0:W.id)!=null?x:""))||(r==null?void 0:r.id)===((y=e==null?void 0:e.current_assistant_turn)==null?void 0:y.id),f=!(e!=null&&e.current_diff_task_turn);return s&&(u||f)},[r,e==null?void 0:e.current_assistant_turn,e==null?void 0:e.current_diff_task_turn]);return{taskDetails:e,taskDetailsError:l,loadingTurnMapping:d,turns:o,focusedAssistantTurn:r,setFocusedAssistantTurnId:S,currentDiffTaskTurn:v,canFollowUp:b,isCommentFocused:m}}function de(){const[t,a]=n.useState([]),[i,m]=n.useState(!1),e=n.useCallback(()=>{a([])},[]),l=n.useCallback(({onClose:d,isComposerEmpty:o})=>({force:r=!1}={})=>{if(r||t.length===0&&o){e(),d();return}m(!0)},[t.length,e]);return{comments:t,setComments:a,confirmClose:i,setConfirmClose:m,clearComments:e,createCloseHandler:l}}function le({taskId:t,onClose:a}){var y,F;const i=Q(),m=I(),e=A(),{composerController:l,isComposerEmpty:d}=ie(),{taskDetails:o,taskDetailsError:r,loadingTurnMapping:S,turns:v,focusedAssistantTurn:p,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g,canFollowUp:b,isCommentFocused:k}=ce(t),_=n.useMemo(()=>Z(p),[p]),M=n.useMemo(()=>({taskId:t,task:o==null?void 0:o.task,pastTurns:v,canFollowUp:b,focusedAssistantTurn:p,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g}),[t,o,v,b,p,C,g]),{comments:T,setComments:h,confirmClose:w,setConfirmClose:E,clearComments:s,createCloseHandler:u}=de(),f=n.useMemo(()=>({comments:T,setComments:h,clearComments:s,readonlyComments:_}),[T,h,s,_]),W=te.useCurrentImage()!=null,x=u({onClose:a,isComposerEmpty:d});re(),D([{key:"newTask",action:()=>{e("/codex",{state:{focusComposer:!0}})},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.newTask",defaultMessage:"New task"}),group:L.Chat,keyboardBinding:[P.Mod,P.Shift,"o"]},{key:"closeTask",action:()=>{e("/codex")},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.closeTask",defaultMessage:"Close task"}),group:L.Chat,keyboardBinding:[P.Escape],enabled:!W&&!k}]);const j=n.useCallback(({force:R=!1}={})=>{x({force:R})},[x]);return r?(i.danger({id:"wham.task-details.error",defaultMessage:"Error loading task",description:"Error message for failed to load task details"},{id:"wham-task-details-error-".concat(t),hasCloseButton:!0,duration:3,toastId:"wham_task_page_content_error"}),c.jsx(K,{to:"/codex"})):c.jsx(H.Provider,{value:l,children:c.jsx(se,{value:f,children:c.jsx(ue,{value:M,children:c.jsx(ae,{permissions:"write",turnId:(F=(y=o==null?void 0:o.current_assistant_turn)==null?void 0:y.id)!=null?F:"",confirmClose:w,setConfirmClose:E,handleClose:j,loadingTurnMapping:S})})})})}function pe(){var d;const t=A(),a=O(),{taskId:i}=B();ee();const m=(d=a.state)!=null?d:{},{backgroundLocation:e}=m,l=n.useCallback(()=>{t(e?-1:"/codex")},[e,t]);return i?c.jsx(z,{children:c.jsx($,{children:c.jsx(le,{taskId:i,onClose:l})})}):null}const tt=()=>[{title:"Codex"}],rt=U(function(){return c.jsx(pe,{})});export{rt as default,tt as meta};
//# sourceMappingURL=kwqa5t7updjnz0bm.js.map

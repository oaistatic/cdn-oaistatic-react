var Gt=Object.defineProperty,Wt=Object.defineProperties;var Xt=Object.getOwnPropertyDescriptors;var Ze=Object.getOwnPropertySymbols;var qt=Object.prototype.hasOwnProperty,jt=Object.prototype.propertyIsEnumerable;var Se=(n,e,t)=>e in n?Gt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,$=(n,e)=>{for(var t in e||(e={}))qt.call(e,t)&&Se(n,t,e[t]);if(Ze)for(var t of Ze(e))jt.call(e,t)&&Se(n,t,e[t]);return n},te=(n,e)=>Wt(n,Xt(e));var p=(n,e,t)=>Se(n,typeof e!="symbol"?e+"":e,t);import{d as Yt,r as P,v as Zt,z as Jt,j as ie,b as Qt}from"./n75kuy1cx6f5mogg.js";import{cI as en,rd as U,s5 as K,mi as Z,s7 as se,s6 as L,e as he,uf as tn,ug as nn,uh as Et,bU as sn,cq as _e,tS as Ct,ui as on,uj as Je,uk as rn,tO as an,ul as ze,um as Qe,at as cn,jZ as ln,hN as un,bG as dn,bW as pn,un as et,s4 as hn,tR as fn,uo as Mt,up as mn,uq as kt,ur as gn,us as wn,tW as xt,aQ as yn,pm as bt,ut as En,p9 as Cn,uu as Mn,bY as kn,f as xn,_ as bn,tG as vn,i as Pn,r as Tn,v as Sn,j as Rn,x as Dn}from"./ewse8exzafeu10ji.js";import{p as Nn,e as In,o as tt,k as An,j as On,n as Ln,q as Bn,r as Me,t as Re,a as vt,d as Vn,u as Pt,g as _n,b as Tt,v as zn}from"./jwqkjcig49ehpyv5.js";import{L as Hn,C as Fn,M as Un,a as He,b as nt}from"./czbf4ttx82qy2f0u.js";import{D as Kn,Z as $n}from"./ce3hgmw4iyyhicud.js";import{bx as st,e as Gn,i as Wn,nA as Y,xF as Xn,oy as qn,xG as jn,uc as Fe,xH as Yn,ud as St,xI as Zn,bs as Jn}from"./ny10lj7zpuz89fvf.js";import{u as Qn}from"./j2tluvxda4ll72qx.js";import{T as es,i as ts}from"./ooyih0iwl35v1a7o.js";import{z as ns,E as ss,C as ot}from"./j0qx0vaadhi6g6bi.js";import{z as rt,b as it,E as Ae,n as os,B as rs}from"./ly9hghfho7bi4z70.js";import{E as is,M as as,N as cs,f as ls,u as us,c as ds}from"./e52t6kvr8rhywzf0.js";import{stripDirectivePlugin as ps}from"./c2p82diba60cggxu.js";import{k as hs}from"./lep2wptoy14cfe2w.js";import{q as fs,u as ms}from"./o423tfdeb6azgv8l.js";import{H as gs}from"./ctddpbsbr3gj60l1.js";import{E as ws,k as ys,l as Es}from"./iqk1tse6yz14y9t9.js";const Cs=n=>en(n).checkGate("924611523");function Ms(n,e){const t=[];return n.descendants((s,o)=>{s.marks.forEach(r=>{r.type===e&&t.push({from:o,to:o+s.nodeSize,mark:r})})}),t}function ks(n,e,t){const s=e.mark.type,o=te($({},e.mark.attrs),{disabled:t});return n.removeMark(e.from,e.to,s),n.addMark(e.from,e.to,s.create(o)),n}const Ue=new K("disableUnsafeLinks");function xs(n,e){return n.setMeta(Ue,{safeUrls:e})}function bs(n){var e;return(e=n.getMeta(Ue))!=null?e:null}function vs(n=new Set){return new U({key:Ue,state:{init(e){return{safeUrls:n}},apply(e,t){const s=bs(e);if(s==null)return t;const{safeUrls:o}=s;return te($({},t),{safeUrls:o})}},appendTransaction(e,t,s){const o=this.getState(s),r=s.tr,i=s.schema.marks[Hn.proseMirrorMarkName()],a=Ms(s.doc,i);let c=!1;return a.forEach(l=>{const u=l.mark.attrs.href,d=o.safeUrls.has(u),h=l.mark.attrs.disabled===!0;d===h&&(ks(r,l,!d),c=!0)}),c?r:null}})}const xe=new K("placeholder");function Ps(n,e){return n.setMeta(xe,{isDisabled:e})}function Ts(n){var e;return(e=n.getMeta(xe))!=null?e:null}function Ss(n,e=!1){return new U({key:xe,state:{init(){return{isDisabled:e}},apply(t,s){const o=Ts(t);return(o==null?void 0:o.isDisabled)!=null?te($({},s),{isDisabled:o.isDisabled}):s}},props:{decorations(t){const{doc:s,selection:o}=t;if(xe.getState(t).isDisabled||!(o instanceof Z&&o.empty))return null;const{$cursor:i}=o;if(!i||!n)return null;const a=i.start();if(!((i.parent.isTextblock||i.parent.type.name==="doc")&&i.pos===a&&i.node().content.size===0))return null;const l=se.widget(a,()=>{const u=document.createTextNode(n.formatMessage(Rs.placeholder)),d=document.createElement("span");return d.className="text-token-text-tertiary dark:text-gray-500 pointer-events-none select-none",d.style.position="absolute",d.appendChild(u),d});return L.create(s,[l])}}})}const Rs=Yt({placeholder:{id:"n2B51U",defaultMessage:"Write something..."}}),Ds={"override-strong-color":"_override-strong-color_y6grp_1"};function Rt({isHovered:n,isRejected:e,isTextAcive:t}){return he({"line-through":!t,"filter grayscale-[0.6]":e,"opacity-60":e,"bg-opacity-50 dark:bg-opacity-50":e,"bg-opacity-10 dark:bg-opacity-10":e,"bg-opacity-60 dark:bg-opacity-60":!n})}function Ns({isHovered:n,isRejected:e,isReplacement:t}){return he("bg-red-100 dark:bg-red-600",Rt({isHovered:n,isRejected:e,isTextAcive:e}),{"dark:bg-red-800":e,"text-red-500 dark:text-red-200":!e,"border border-red-400 rounded-l border-e-0":e,"border border-red-400 rounded-sm":e})}function Is({isHovered:n,isRejected:e,isReplacement:t}){const s=!e;return he(Ds["override-strong-color"],"text-green-600 dark:text-green-200 bg-green-100 dark:bg-green-600",Rt({isHovered:n,isRejected:e,isTextAcive:s}),{"dark:bg-green-800":e,"border border-green-500 rounded-r border-s-0":e,"border border-green-500 rounded-sm":e})}const Oe=new K("edit"),at=(n,e,t,s)=>{const o=[];for(const{start:r,end:i,editId:a}of e)o.push(se.inline(r,i,{class:Ns({isHovered:!1,isRejected:!1,isReplacement:!1}),"data-edit-id":a}));for(const{start:r,end:i,editId:a}of n)o.push(se.inline(r,i,{class:Is({isHovered:!1,isRejected:!1,isReplacement:!0}),"data-edit-id":a}));return o},As=(n,e)=>new U({key:Oe,state:{init(){const s=new Set;return{decorations:at(n,e),hoveredEditId:null,rejectedEdits:s}},apply(t,s){var a;const o=(a=t.getMeta(Oe))!=null?a:null,{hoveredEditId:r,rejectedEdits:i}=o!=null?o:s;return{decorations:at(n,e),hoveredEditId:r,rejectedEdits:i}}},props:{decorations(t){const s=this.getState(t);return s?L.create(t.doc,s.decorations.concat()):L.empty},editable(){return!1},attributes(){return{class:"cursor-default",style:"--text-primary:var(--text-secondary)"}}}}),ae=class ae{constructor(e,t){this.length=e,this.step=t}cut(e){return e===this.length?this:new ae(e,this.step)}static slice(e,t,s){if(t===s)return ae.none;if(t===0&&s===ae.len(e))return e;const o=[];for(let r=0,i=0;i<s;r++){const a=e[r],c=i+a.length,l=Math.min(s,c)-Math.max(t,i);l>0&&o.push(a.cut(l)),i=c}return o}static join(e,t,s){if(e.length===0)return t;if(t.length===0)return e;const o=s(e[e.length-1].step,t[0].step);if(o==null)return e.concat(t);const r=e.slice(0,e.length-1);r.push(new ae(e[e.length-1].length+t[0].length,o));for(const i of t)r.push(i);return r}static len(e){let t=0;for(const s of e)t+=s.length;return t}};p(ae,"none",[]);let de=ae;class Os{constructor(e,t,s,o,r,i){this.fromA=e,this.toA=t,this.fromB=s,this.toB=o,this.deleted=r,this.inserted=i}get lenA(){return this.toA-this.fromA}get lenB(){return this.toB-this.fromB}}const ct=(n,e,t,s,o)=>new Os(n,e,t,s,n===e?de.none:[new de(e-n,o)],t===s?de.none:[new de(s-t,o)]);class be{constructor(e,t){this.doc=e,this.changes=t}static create(e){return new be(e,[])}addSteps(e,t){const s=[];for(const r of t){let i=0;if(r.getMap().forEach((a,c,l,u)=>{s.push(ct(a+i,c+i,l,u,r)),i=u-l-(c-a)}),r instanceof tn||r instanceof nn){const{from:a,to:c}=r;s.push(ct(a,c,a,c,r))}}if(s.length===0)return this;const o=this.changes.concat(s);return new be(e,o)}}const fe=new K("changeset"),Le=new K("highlightChanges"),Dt=n=>fe.getState(n),Ls=n=>{const{state:e}=n,t=e.tr.setMeta(fe,!0);n.updateState(e.apply(t))},Bs=n=>{const{state:e}=n,t=Dt(e);if(!t)return;const{maps:s,steps:o}=t,r=new Et(s),i=e.tr;for(let c=o.length-1;c>=0;c--){const l=o[c].map(r.slice(c+1));if(!l)continue;i.maybeStep(l).doc&&r.appendMap(l.getMap(),c)}const a=e.apply(i.setMeta(fe,!0));n.updateState(a)},Vs=()=>{const n=s=>({changeset:be.create(s),maps:[],steps:[]}),e=new U({key:fe,state:{init:(s,{doc:o})=>n(o),apply:(s,o,r,i)=>{const{doc:a}=i;if(s.getMeta(fe))return n(a);const{docChanged:l,mapping:u,steps:d,docs:h}=s;if(!l)return o;const{changeset:f,maps:w,steps:k}=o,{maps:x}=u,J=d.map((S,b)=>S.invert(h[b]));return{changeset:f.addSteps(a,d),maps:w.concat(x),steps:k.concat(J)}}}}),t=new U({key:Le,state:{init(){return{deco:L.empty,show:!1}},apply(s,o,r,i){const a=e.getState(i);if(!a)return o;const{changeset:c}=a,{doc:l}=i,{changes:u}=c,d=u.map(({fromB:f,toB:w})=>se.inline(f,w,{class:"blame-marker"})),h=s.getMeta(Le);return{deco:L.create(l,d),show:h!=null?h:o.show}}},props:{decorations(s){const o=this.getState(s);if(!(o!=null&&o.show))return L.empty;const{deco:r}=o;return r}}});return[e,t]},re=(n,e,t)=>{P.useEffect(()=>{const s=e.current;if(!s)return;const{state:o}=s,r=n(o.tr);r&&s.dispatch(r)},t)},pe=new K("autocomplete");function lt(n,e){return n.setMeta(pe,{suggestion:e})}function _s(n){return n.getMeta(pe)}function ut(n){if(!(n instanceof Z))return null;const{$cursor:e}=n;if(!e)return null;const t=e.end();return e.pos===t?t:null}function zs(n=null){return new U({key:pe,state:{init(){return{suggestion:n}},apply(e,t){var o;const s=_s(e);return s===void 0?t:te($({},t),{suggestion:(o=s.suggestion)!=null?o:null})}},props:{decorations(e){const{doc:t,selection:s}=e,{suggestion:o}=pe.getState(e);if(!o)return null;const r=ut(s);if(r==null)return L.empty;const i=se.widget(r,()=>{const a=document.createTextNode(o),c=document.createElement("span");return c.className="text-token-text-tertiary dark:text-gray-500 pointer-events-none select-none",c.appendChild(a),c});return L.create(t,[i])},handleDOMEvents:{keydown:(e,t)=>{const{state:s}=e,o=pe.getState(s),r=ut(s.selection);t.key==="Tab"&&o.suggestion&&r!=null&&(t.preventDefault(),e.dispatch(s.tr.insert(r,s.schema.text(o.suggestion))))}}}})}const Hs=(n,e)=>{const t=P.useRef(!1),s=P.useRef(null),o=P.useRef(e);o.current=e;const r=P.useCallback(sn(async i=>{var l;t.current=!1;const a=crypto.randomUUID();s.current=a;const c=await((l=o.current)==null?void 0:l.call(o,i()));!t.current&&c!==void 0&&n.current&&s.current===a&&n.current.dispatch(lt(n.current.state.tr,c))},200),[]);return P.useCallback(i=>{t.current=!0;const a=_e(n.current);a.dispatch(lt(a.state.tr,null)),r(i)},[r,n])};var me=(n=>(n.PROSEMIRROR_CONTEXT_CHILDREN="prosemirror-context-children",n.PROSEMIRROR_EDITOR_CONTAINER="prosemirror-editor-container",n))(me||{});function Fs(n,e){return{x:st(e.x,n.left,n.right),y:st(e.y,n.top,n.bottom)}}function Nt(n){let e=n.selection.$from.pos-1;if(e<0)return null;let t=n.doc.nodeAt(e);for(;(t==null||t.type.name===es.proseMirrorNodeName())&&e>0;)e-=1,t=n.doc.nodeAt(e);return t!=null?{node:t,pos:e}:t}function Us(n,e){const t=Nt(n);if(t==null)return!1;const{node:s,pos:o}=t,r=o+s.nodeSize,i=n.tr,c=n.schema.nodes.paragraph.create(null);i.insert(r,c);const l=r+c.nodeSize-1,u=i.doc.resolve(l),d=new Z(u);return i.setSelection(d),e(i),!0}function Ks(n,e){const t=Nt(n);if(t==null)return!1;const{node:s,pos:o}=t,r=n.tr;return r.deleteRange(o,o+s.nodeSize),e(r),!0}const dt=(n,e)=>{if(n===e)return null;let t=0,s=n.length,o=e.length;for(;t<s&&n.charCodeAt(t)===e.charCodeAt(t);)t+=1;for(;s>t&&o>t&&n.charCodeAt(s-1)===e.charCodeAt(o-1);)s-=1,o-=1;return{from:t,to:s,text:e.slice(t,o)}},pt=n=>Ae.theme({"&":{backgroundColor:n?"var(--main-surface-primary)":"var(--gray-100)"}});class Pe{constructor(e,t,s,o){p(this,"node");p(this,"updating",!1);p(this,"cm");p(this,"languageCompartment");p(this,"themeCompartment");p(this,"setLanguage",async e=>{const t=await Bn(e);t&&this.cm.dispatch({effects:this.languageCompartment.reconfigure(t)})});p(this,"setTheme",e=>{const t=[pt(e),ot(tt(e))];this.cm.dispatch({effects:this.themeCompartment.reconfigure(t)})});p(this,"handleBackspace",e=>{const{selection:t}=e.state;if(!(t.main.empty&&t.main.from===0)||this.cm.state.doc.length>0)return!1;const s=Ks(this.pmView.state,this.pmView.dispatch);return this.pmView.focus(),s});p(this,"handleShiftEnter",()=>{const e=Us(this.pmView.state,this.pmView.dispatch);return this.pmView.focus(),e});p(this,"dispatch",e=>{var r;if(this.cm.update([e]),this.updating)return;const t=((r=this.getPos())!=null?r:0)+1,s=e.state.doc.toString(),o=dt(this.node.textContent,s);if(o){const{text:i,from:a,to:c}=o,l=i?this.pmSchema.text(i):null,u=this.pmView.state.tr.replaceWith(a+t,c+t,l);this.pmView.dispatch(u)}this.forwardSelection()});p(this,"update",e=>{if(e.type!==this.node.type)return!1;e.attrs.lang!==this.node.attrs.lang&&this.setLanguage(e.attrs.lang),e.attrs.isDarkMode!=null&&e.attrs.isDarkMode!==this.node.attrs.isDarkMode&&this.setTheme(e.attrs.isDarkMode),this.node=e;const t=dt(this.cm.state.doc.toString(),e.textContent);if(t){const{text:s,from:o,to:r}=t;this.updating=!0,this.cm.dispatch({changes:{from:o,to:r,insert:s}}),this.updating=!1}return!0});p(this,"asProseMirrorSelection",e=>{var r;const t=((r=this.getPos())!=null?r:0)+2,{anchor:s,head:o}=this.cm.state.selection.main;return Z.create(e,s+t,o+t)});p(this,"forwardSelection",()=>{if(!this.cm.hasFocus)return;const{state:e}=this.pmView,t=this.asProseMirrorSelection(e.doc);t.eq(e.selection)||this.pmView.dispatch(e.tr.setSelection(t))});p(this,"maybeEscape",(e,t)=>s=>{var f;const{state:o}=s,{selection:r}=o,a=(()=>{const w=r.main.from,{number:k,from:x}=o.doc.lineAt(w);return{line:k,ch:w-x}})(),c=o.selection.ranges.some(w=>!w.empty),l=1,u=o.doc.lineAt(o.doc.length).number;if(c||a.line!==(t<0?l:u)||e==="char"&&a.ch!==(t<0?0:o.doc.line(a.line).length))return!1;const d=((f=this.getPos())!=null?f:0)+(t<0?0:this.node.nodeSize),h=Ct.near(this.pmView.state.doc.resolve(d),t);return this.pmView.dispatch(this.pmView.state.tr.setSelection(h).scrollIntoView()),this.pmView.focus(),!0});p(this,"setSelection",(e,t)=>{this.focus(),this.updating=!0,this.cm.dispatch({selection:{anchor:e,head:t}}),this.updating=!1});p(this,"focus",()=>{this.cm.focus(),this.forwardSelection()});p(this,"selectNode",()=>{this.focus()});p(this,"stopEvent",()=>!0);p(this,"destroy",()=>{this.cm.destroy()});p(this,"_setIsCodeBlockView",()=>{this.cm.dom.dataset.isCodeBlockView="true"});this.pmView=t,this.getPos=s,this.node=e;const r=[{key:"ArrowUp",run:this.maybeEscape("line",-1)},{key:"ArrowLeft",run:this.maybeEscape("char",-1)},{key:"ArrowDown",run:this.maybeEscape("line",1)},{key:"ArrowRight",run:this.maybeEscape("char",1)},{key:"Backspace",run:this.handleBackspace},{key:"Shift-Enter",run:this.handleShiftEnter}];this.languageCompartment=new rt,this.themeCompartment=new rt;const i=Nn(e.attrs.lang),a=it.create({doc:this.node.textContent,extensions:[this.themeCompartment.of([pt(o),ot(tt(o))]),Ae.theme({"&":{borderRadius:"4px",padding:"0.5rem"},"&.cm-focused":{outline:"none"}}),os.of([...r,...An,...On,Ln]),ns(),In(),ss(),rs(),this.languageCompartment.of(i!=null?[i]:[]),it.changeFilter.of(c=>(!c.docChanged&&!this.updating&&this.forwardSelection(),!0))]});this.cm=new Ae({state:a,dispatch:this.dispatch}),i==null&&this.setLanguage(e.attrs.lang)}get pmSchema(){return this.pmView.state.schema}get dom(){return this._setIsCodeBlockView(),this.cm.dom}static isInCodeBlockView(e){return e instanceof HTMLElement?e.closest("[data-is-code-block-view]")!=null:!1}}p(Pe,"_getIsCodeBlockView",e=>e.dataset.isCodeBlockView==="true");function $s(n,e,t){try{return e instanceof Z?Z.create(n,e.anchor,e.head):e instanceof on?Z.create(n,e.from,e.to):e instanceof Je?new Je(n):void 0}catch(s){return Z.create(n,0)}}class Gs extends is{unifiedInitializationHook(e){return e.use(ps)}}class Ws{constructor(e,t){p(this,"rules");this.rules=[].concat.apply([],e.syntaxExtensions().map(s=>s.proseMirrorInputRules(t)))}build(){return ts({rules:this.rules})}}class Xs{constructor(e,t){p(this,"keymap");this.keymap=new Map;for(const s of e.syntaxExtensions())this.addKeymap(s.proseMirrorKeymap(t));this.addKeymap(rn)}build(){const e={};return this.keymap.forEach((t,s)=>{e[s]=an(...t)}),ze(e)}addKeymap(e){for(const t in e)this.keymap.get(t)||this.keymap.set(t,[]),_e(this.keymap.get(t)).push(e[t])}}class qs{constructor(e){p(this,"nodeViews");this.nodeViews={};for(const t of e.nodeExtensions()){const s=t.proseMirrorNodeName(),o=t.proseMirrorNodeView();s!==Fn.proseMirrorNodeName()&&s!=null&&o!=null&&(this.nodeViews[s]=o)}}build(){return this.nodeViews}}class js{constructor(e){p(this,"nodes",{});p(this,"marks",{});for(const t of e.nodeExtensions()){const s=t.proseMirrorNodeName(),o=t.proseMirrorNodeSpec();s!=null&&o!=null&&(s!=="text"&&(o.attrs=te($({},o.attrs),{start:{default:void 0},end:{default:void 0}})),this.nodes[s]=o)}for(const t of e.markExtensions()){const s=t.proseMirrorMarkName(),o=t.proseMirrorMarkSpec();s!=null&&o!=null&&(this.marks[s]=o)}}build(){try{return new Qe({nodes:this.nodes,marks:this.marks})}catch(e){cn.addError(e,{nodes:this.nodes})}return new Qe({nodes:{doc:{content:"block+"},paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p",preserveWhitespace:"full"}],toDOM:()=>["p",0]},text:{group:"inline"}},marks:this.marks})}}class Ys{constructor(e){p(this,"extensionManager");this.extensionManager=e}build(){let e=Gn();for(const t of this.extensionManager.extensions())e=t.unifiedInitializationHook(e);return e}}function Zs(n){return n instanceof cs}function Js(n){return n instanceof as}class Qs{constructor(e){p(this,"markExtensionList");p(this,"nodeExtensionList");p(this,"otherExtensionList");this.markExtensionList=new Map,this.nodeExtensionList=new Map,this.otherExtensionList=new Map;for(const t of e)this.add(t)}extensions(){return this.syntaxExtensions().concat(Array.from(this.otherExtensionList.values()))}markExtensions(){return Array.from(this.markExtensionList.values())}nodeExtensions(){return Array.from(this.nodeExtensionList.values())}syntaxExtensions(){return this.nodeExtensions().concat(this.markExtensions())}add(e){for(const t of e.dependencies())this.add(t);if(Js(e)){this.markExtensionList.set(e.constructor,e);return}if(Zs(e)){this.nodeExtensionList.set(e.constructor,e);return}this.otherExtensionList.set(e.constructor,e)}}class eo{constructor(e){p(this,"extensionManager");this.extensionManager=e}convert(e){const t=this.convertNode(e);if(t.length!==1)throw new Error("Couldn't find any way to convert the root ProseMirror node.");return t[0]}convertNode(e){let t=null;const s=[];for(const o of this.extensionManager.nodeExtensions()){if(!o.proseMirrorToUnistTest(e))continue;s.push(o);let r=[];for(let i=0;i<e.childCount;++i)r=r.concat(this.convertNode(e.child(i)));t=o.proseMirrorNodeToUnistNodes(e,r)}return t==null?(console.warn("Couldn't find any way to convert ProseMirror node of type \""+e.type.name+'" to a unist node.'),[]):t.map(o=>{for(const r of e.marks){const{type:{name:i}}=r;if(s.some(l=>{var d;const u=(d=l.proseMirrorNodeSpec())==null?void 0:d.marks;return u!=null&&!u.includes(i)}))continue;let c=!1;for(const l of this.extensionManager.markExtensions())r.type.name===l.proseMirrorMarkName()&&(o=l.processConvertedUnistNode(o,r),c=!0);c||console.warn("Couldn't find any way to convert ProseMirror mark of type \""+i+'" to a unist node.')}return o})}}class Ke{constructor(e,t){p(this,"extensionManager");p(this,"proseMirrorSchema");this.extensionManager=e,this.proseMirrorSchema=t}static unistNodeIsParent(e){return"children"in e}convert(e){const t={},s=this.convertNode(e,t);for(const o of this.extensionManager.syntaxExtensions())o.postUnistToProseMirrorHook(t);if(s.length!==1)throw new Error("Couldn't find any way to convert the root unist node.");return s[0]}convertNode(e,t){let s=0;const o=(r,i)=>{var a;for(const c of this.extensionManager.syntaxExtensions()){if(!c.unistToProseMirrorTest(r)||Wn(r)&&c.customDirectiveName()!=null&&c.customDirectiveName()!==r.name)continue;let l=[];Ke.unistNodeIsParent(r)&&(l=r.children.flatMap(k=>o(k,i)));const{position:u}=r,d=(a=u==null?void 0:u.start.offset)!=null?a:s;let h=u==null?void 0:u.end.offset;if(h==null&&"value"in r&&typeof r.value=="string"){const{value:k}=r;h=d+k.length}h==null&&(h=d),s=h;const f={start:d,end:h};return ln(c.unistNodeToProseMirrorNodes({node:r,schema:this.proseMirrorSchema,convertedChildren:l,context:i,attrs:f})).filter(un)}return console.warn("Couldn't find any way to convert unist node of type \""+r.type+'" to a ProseMirror node.'),[]};return o(e,t)}}const to=5;class no{constructor(e=[]){p(this,"builtSchema");p(this,"inputRulesBuilder");p(this,"keymapBuilder");p(this,"nodeViewBuilder");p(this,"unistToProseMirrorConverter");p(this,"proseMirrorToUnistConverter");p(this,"unified");p(this,"memoizedProsemirrorDocs",new Map);const t=new Qs(e);this.builtSchema=new js(t).build(),this.inputRulesBuilder=new Ws(t,this.builtSchema),this.keymapBuilder=new Xs(t,this.builtSchema),this.nodeViewBuilder=new qs(t),this.unistToProseMirrorConverter=new Ke(t,this.builtSchema),this.proseMirrorToUnistConverter=new eo(t),this.unified=new Ys(t).build()}parse(e){try{if(this.memoizedProsemirrorDocs.has(e))return _e(this.memoizedProsemirrorDocs.get(e));const t=this.unistToProseMirrorConverter.convert(this.parseUnist(e));if(this.memoizedProsemirrorDocs.set(e,t),this.memoizedProsemirrorDocs.size>to){const s=this.memoizedProsemirrorDocs.keys().next().value;s&&this.memoizedProsemirrorDocs.delete(s)}return t}catch(t){Y.logError("Failed to parse document",t)}return this.schema().text(" ")}parseUnist(e){return this.unified.runSync(this.unified.parse(e))}schema(){return this.builtSchema}inputRulesPlugin(){return this.inputRulesBuilder.build()}keymapPlugin(){return this.keymapBuilder.build()}nodeViews(){return this.nodeViewBuilder.build()}serialize(e){const t=this.proseMirrorToUnistConverter.convert(e);return this.unified.stringify(t)}}const ht=new Map;function ce(n={}){const e=JSON.stringify(n);let t=ht.get(e);return t==null&&(t=new no([new Un,...n!=null&&n.shouldStripDirectives?[new Gs]:[]]),ht.set(e,t)),t}const so=(n,e,t,s)=>{const o=[];for(const r of e)for(const i of t)o.push({from:r,to:i,parentNodeNamesAtStart:r.parentNodeTypeNameStack,slice:n.slice(r.pmPos,i.pmPos)});return o.sort((r,i)=>{const a=Math.abs(r.from.sourcePos-s.start)+Math.abs(r.to.sourcePos-s.end),c=Math.abs(i.from.sourcePos-s.start)+Math.abs(i.to.sourcePos-s.end);return a===c?i.slice.size-r.slice.size:a-c}),o},oo=(n,e)=>pn(n.parentNodeNamesAtStart,e.parentNodeTypeNameStack),ft=new WeakMap,ro=({diff:n})=>{const e=new Xn(qn.GetDiffedDoc,{debug:!1});e.startBlock("get_diffed_doc");const t=ce(),{contentAfter:s,contentBefore:o,edits:r}=n,i=t.parse(s),a=t.parse(o),c=r.concat().sort((S,b)=>S.positionBefore.start-b.positionBefore.start),l=[],u=[];e.startBlock("init_position_transformers");const{sourceRangeToPmRange:d}=Me(a),{sourceRangeToPmRange:h}=Me(i);e.endBlock("init_position_transformers");let f=a,w=0,k=0;const x=[],J=(S,b,v)=>{for(const[B,G]of v.entries())try{if(!oo(b,G))continue;const{pmPos:D}=G,{slice:V}=b;return f=f.replace(D,D,V),l.push({editId:S,start:D,end:D+V.size}),[B,G]}catch(D){x.push(D)}return null};for(let S=0;S<c.length;S++){const{id:b,positionBefore:v,positionAfter:B}=c[S];e.startBlock("transform_positions");const G=d(v),D=h(B);e.endBlock("transform_positions");const{start:V,end:A}=G,{start:I,end:y}=D,E=B.start!==B.end,m=E?so(i,I,y,B):null;e.startBlock("get_merged_doc_positions");const{positions:_}=Me(f);e.endBlock("get_merged_doc_positions");const W=Math.max(...V.map(({pmPos:N})=>N)),O=Math.min(...A.map(({pmPos:N})=>N)),q=[].concat(A).concat(V),X=v.start!==v.end&&a.textBetween(W,O).length>0;let z=!1;if(X&&!E)u.push({editId:b,start:W+w,end:O+w}),z=!0;else if(!X&&!E)z=!0;else{const N=q.map(({pmPos:T})=>_[T+w]);for(const T of m!=null?m:[]){const H=J(b,T,N);if(H==null)continue;const F=H[0],ee=T.slice.size,ue=F<A.length;ue||(w+=ee),X&&u.push({editId:b,start:W+w,end:O+w}),ue&&(w+=ee),z=!0;break}}if(!z&&m!=null){const T=Math.min(...V.map(({pmPos:H})=>H))+w-1;for(const H of m)try{f=f.replace(T,T,H.slice),l.push({editId:b,start:T,end:T+H.slice.size}),w+=H.slice.size,X&&u.push({editId:b,start:W+w,end:O+w}),z=!0;break}catch(F){x.push(F)}}z?Y.logEvent("Canvas Diff Edit Success"):(Y.logEvent("Canvas Diff Edit Fail"),Y.logError("Failed to insert edit for diffed doc",dn(x),{errors:x.map(jn),replaceFromCandidates:V,replaceToCandidates:A,sliceFromCandidates:I,sliceToCandidates:y}),k++)}return Y.logDistribution("Canvas Diff Edit Success Ratio",(c.length-k)/c.length),Y.logDistribution("Canvas Diff Edit Fail Count",k),Y.logDistribution("Canvas Diff Edit Success Count",c.length-k),Y.logDistribution("Canvas Diff Edit Count",c.length),e.endBlock("get_diffed_doc"),{doc:f,addedRanges:l,deletedRanges:u}},io=({diff:n})=>{const e=ft.get(n);if(e!=null)return e;const t=ro({diff:n});return ft.set(n,t),t},Ee=new K("focus"),ao=(n,e)=>new U({key:Ee,state:{init:()=>!1,apply(t,s){const o=t.getMeta(Ee);return typeof o=="boolean"?o:s}},props:{handleDOMEvents:{blur:(t,s)=>{const{relatedTarget:o}=s;return o!=null&&Pe.isInCodeBlockView(o)||(e(s),t.dispatch(t.state.tr.setMeta(Ee,!1))),!1},focus:(t,s)=>(n(s),t.dispatch(t.state.tr.setMeta(Ee,!0)),!1)}}}),co=500,Q=class Q{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let s=this.items.length;for(;;s--)if(this.items.get(s-1).selection){--s;break}let o,r;t&&(o=this.remapping(s,this.items.length),r=o.maps.length);const i=e.tr;let a,c;const l=[],u=[];return this.items.forEach((d,h)=>{if(!d.step){o||(o=this.remapping(s,h+1),r=o.maps.length),r--,u.push(d);return}if(o){u.push(new j(d.map));const f=d.step.map(o.slice(r));let w;f&&i.maybeStep(f).doc&&(w=i.mapping.maps[i.mapping.maps.length-1],l.push(new j(w,void 0,void 0,l.length+u.length))),r--,w&&o.appendMap(w,r)}else i.maybeStep(d.step);if(d.selection)return a=o?d.selection.map(o.slice(r)):d.selection,c=new Q(this.items.slice(0,s).append(u.reverse().concat(l)),this.eventCount-1),!1},this.items.length,0),{remaining:c,transform:i,selection:a}}addTransform(e,t,s,o){const r=[];let i=this.eventCount,a=this.items,c=!o&&a.length?a.get(a.length-1):null;for(let u=0;u<e.steps.length;u++){const d=e.steps[u].invert(e.docs[u]);let h=new j(e.mapping.maps[u],d,t),f;(f=c&&c.merge(h))&&(h=f,u?r.pop():a=a.slice(0,a.length-1)),r.push(h),t&&(i++,t=void 0),o||(c=h)}const l=i-s.depth;return l>uo&&(a=lo(a,l),i-=l),new Q(a.append(r),i)}remapping(e,t){const s=new Et;return this.items.forEach((o,r)=>{const i=o.mirrorOffset!=null&&r-o.mirrorOffset>=e?s.maps.length-o.mirrorOffset:void 0;s.appendMap(o.map,i)},e,t),s}addMaps(e){return this.eventCount==0?this:new Q(this.items.append(e.map(t=>new j(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;const s=[],o=Math.max(0,this.items.length-t),r=e.mapping;let i=e.steps.length,a=this.eventCount;this.items.forEach(h=>{h.selection&&a--},o);let c=t;this.items.forEach(h=>{const f=r.getMirror(--c);if(f==null)return;i=Math.min(i,f);const w=r.maps[f];if(h.step){const k=e.steps[f].invert(e.docs[f]),x=h.selection&&h.selection.map(r.slice(c+1,f));x&&a++,s.push(new j(w,k,x))}else s.push(new j(w))},o);const l=[];for(let h=t;h<i;h++)l.push(new j(r.maps[h]));const u=this.items.slice(0,o).append(l).append(s);let d=new Q(u,a);return d.emptyItemCount()>co&&(d=d.compress(this.items.length-s.length)),d}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){const t=this.remapping(0,e);let s=t.maps.length;const o=[];let r=0;return this.items.forEach((i,a)=>{if(a>=e)o.push(i),i.selection&&r++;else if(i.step){const c=i.step.map(t.slice(s)),l=c&&c.getMap();if(s--,l&&t.appendMap(l,s),c){const u=i.selection&&i.selection.map(t.slice(s));u&&r++;const d=new j(l.invert(),c,u),h=o.length-1;let f;(f=o.length&&o[h].merge(d))?o[h]=f:o.push(d)}}else i.map&&s--},this.items.length,0),new Q(et.from(o.reverse()),r)}};p(Q,"empty",new Q(et.empty,0));let ge=Q;function lo(n,e){let t;return n.forEach((s,o)=>{if(s.selection&&e--==0)return t=o,!1}),n.slice(t)}class j{constructor(e,t,s,o){this.map=e,this.step=t,this.selection=s,this.mirrorOffset=o}merge(e){if(this.step&&e.step&&!e.selection){const t=e.step.merge(this.step);if(t)return new j(t.getMap().invert(),t,this.selection)}}}class ne{constructor(e,t,s,o,r){this.done=e,this.undone=t,this.prevRanges=s,this.prevTime=o,this.prevComposition=r}}const uo=20;function po(n,e,t,s){const o=t.getMeta(le);let r;if(o)return o.historyState;t.getMeta(mo)&&(n=new ne(n.done,n.undone,null,0,-1));const i=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(i&&i.getMeta(le))return i.getMeta(le).redo?new ne(n.done.addTransform(t,void 0,s,ke(e)),n.undone,mt(t.mapping.maps),n.prevTime,n.prevComposition):new ne(n.done,n.undone.addTransform(t,void 0,s,ke(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(i&&i.getMeta("addToHistory")===!1)){const a=t.getMeta("composition"),c=n.prevTime==0||!i&&n.prevComposition!=a&&(n.prevTime<(t.time||0)-s.newGroupDelay||!ho(t,n.prevRanges)),l=i?De(n.prevRanges,t.mapping):mt(t.mapping.maps);return new ne(n.done.addTransform(t,c?e.selection.getBookmark():void 0,s,ke(e)),ge.empty,l,t.time,a==null?n.prevComposition:a)}else return(r=t.getMeta("rebased"))?new ne(n.done.rebased(t,r),n.undone.rebased(t,r),De(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new ne(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),De(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function ho(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((s,o)=>{for(let r=0;r<e.length;r+=2)s<=e[r+1]&&o>=e[r]&&(t=!0)}),t}function mt(n){const e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((s,o,r,i)=>e.push(r,i));return e}function De(n,e){if(!n)return null;const t=[];for(let s=0;s<n.length;s+=2){const o=e.map(n[s],1),r=e.map(n[s+1],-1);o<=r&&t.push(o,r)}return t}function fo(n,e,t){const s=ke(e),o=le.get(e).spec.config,r=(t?n.undone:n.done).popEvent(e,s);if(!r)return null;const i=r.selection.resolve(r.transform.doc),a=(t?n.done:n.undone).addTransform(r.transform,e.selection.getBookmark(),o,s),c=new ne(t?a:r.remaining,t?r.remaining:a,null,0,-1);return r.transform.setSelection(i).setMeta(le,{redo:t,historyState:c})}let Ne=!1,gt=null;function ke(n){const e=n.plugins;if(gt!=e){Ne=!1,gt=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){Ne=!0;break}}return Ne}const le=new K("history"),mo=new K("closeHistory");function Ie(n={},e=void 0){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new U({key:le,state:{init(){return e!=null?e:new ne(ge.empty,ge.empty,null,0,-1)},apply(t,s,o){return po(s,o,t,n)}},config:n,props:{handleDOMEvents:{beforeinput(t,s){const o=s.inputType,r=o=="historyUndo"?At:o=="historyRedo"?Be:null;return!r||!t.editable?!1:(s.preventDefault(),r(t.state,t.dispatch))}}}})}function It(n,e){return(t,s)=>{const o=le.getState(t);if(!o||(n?o.undone:o.done).eventCount==0)return!1;if(s){const r=fo(o,t,n);r&&s(e?r.scrollIntoView():r)}return!0}}const At=It(!1,!0),Be=It(!0,!0),go=()=>new U({key:new K("katex"),props:{decorations(n){const e=[];return n.doc.descendants((t,s)=>{(t.type.name==="inline_math"||t.type.name==="math_block")&&e.push(se.widget(s+1,()=>{const o=document.createElement("span"),r=hs.renderToString(t.attrs.latex,{throwOnError:!1,displayMode:t.type.name==="math_block"});return o.innerHTML=r,o}))}),L.create(n.doc,e)}}});function wo(n,e){var s;const t=e&&((s=n.dom)==null?void 0:s.querySelectorAll('[data-edit-id="'.concat(e,'"]')));return t?Array.from(t):[]}function dr(n,e){return wo(n,e).flatMap(s=>Array.from(s.getClientRects()))}function Ve(n,e,t){return n>=t.left&&n<=t.right&&e>=t.top&&e<=t.bottom}function yo(n){const e=Math.min(...n.map(r=>r.left)),t=Math.max(...n.map(r=>r.right)),s=Math.min(...n.map(r=>r.top)),o=Math.max(...n.map(r=>r.bottom));return{left:e,right:t,top:s,bottom:o}}function Eo(n,e,t){return t.some(o=>Ve(n,e,o))?!0:t.length<2?!1:t.some(o=>n>=o.left&&n<=o.right&&e>o.bottom)&&t.some(o=>n>=o.left&&n<=o.right&&e<o.top)}const Co=new K("linkTooltip"),Mo=36;class ko{constructor(e){p(this,"tooltipElement");p(this,"button");p(this,"onMouseLeave");this.tooltipElement=document.createElement("div"),this.tooltipElement.className=he("absolute  py-1.5 px-2.5 bg-token-main-surface-primary border border-token-border-default rounded-lg text-xs z-50 items-center cursor-pointer shadow-md flex justify-center cursor-pointer","transform -translate-x-1/2"),this.button=document.createElement("button"),this.button.textContent="Open link",this.button.className=he("bg-none","border-none","text-token-text-primary ","text-sm"),this.tooltipElement.appendChild(this.button),this.onMouseLeave=e,this.tooltipElement.addEventListener("mouseleave",e)}show(e,t,s){document.body.appendChild(this.tooltipElement),this.tooltipElement.style.left="".concat(e,"px"),this.tooltipElement.style.top="".concat(t,"px");const o=()=>{window.open(s,"_blank"),this.hide()};this.button.addEventListener("click",o,{once:!0})}hide(){this.tooltipElement.parentNode&&this.tooltipElement.parentNode.removeChild(this.tooltipElement)}}function xo(){let n=null,e=null;const t=r=>{if(n==null||e==null)return!1;const i=Array.from(e.getClientRects()),a=n.tooltipElement.getBoundingClientRect();if(i.length===1){const c=i[0];return!Ve(r.clientX,r.clientY,yo([c,a]))}else return!Eo(r.clientX,r.clientY,[a,...i])},s=(r,i)=>{var h;n&&(n.hide(),n=null);const a=r.getAttribute("href");if(!a)return;const c=Array.from(r.getClientRects()),l=(h=c.find(f=>Ve(i.clientX,i.clientY,f)))!=null?h:c[0],u=l.left+l.width/2,d=l.top-Mo;n=new ko(f=>{t(f)&&o()}),n.show(u,d,a),e=r},o=()=>{n&&(n.hide(),n=null),e=null};return new U({key:Co,props:{handleDOMEvents:{mousemove(r,i){const a=()=>{const{target:l}=i;if(!(l instanceof HTMLElement))return!1;const u=l.closest("a[href]");return u!=null&&u!==e?(s(u,i),!0):!1},c=()=>{n==null||!t(i)||o()};a()||c()}}},view:()=>({destroy:o})})}function Ot(n){return ce().serialize(n).length}const bo=new K("maxLength"),vo=(n,e,t)=>new U({key:bo,state:{init(){return t},apply:()=>{}},filterTransaction(s){if(n==null||!s.steps.some(i=>i instanceof hn||i instanceof fn?i.slice.size>i.to-i.from:!1))return!0;const r=Ot(s.doc);return r<=t?!0:(e&&Fe(e,n),Y.logEvent("Canvas Prosemirror Max Length",{maxLength:t,newLength:r}),!1)}});function Po(n,e){var l,u;const{state:t}=n,{selection:s}=t,o=s.content(),{schema:r}=t,i=r.topNodeType.create(null,o.content),a=To(i,n),c=t.doc.textBetween(s.from,s.to,"\n");(l=e.clipboardData)==null||l.setData("application/x-prosemirror",c),(u=e.clipboardData)==null||u.setData("text/plain",a),e.preventDefault()}function To(n,e){let t="";function s(o){if(o.type.name==="paragraph")return o.content.forEach(r=>{s(r)}),t+="\n",!1;if(o.type.name==="contentReference"){const r=o.attrs.index,i=So(r,e);return i&&(t+="[".concat(i,"]")),!1}else o.isText&&o.text!==void 0&&(t+=o.text);return!0}return n.descendants(s),t.endsWith("\n")&&(t=t.slice(0,-1)),t}function So(n,e){var i,a,c;const t=Mt.getState(e.state),s=parseInt(n);if(t==null||s==null)return null;const o=(i=t==null?void 0:t.displayedContentReferences)==null?void 0:i[s];return o==null||o.type!=="grouped_webpages"?null:(c=(a=o.items)==null?void 0:a[0])==null?void 0:c.url}class Ro{constructor(e,t,s,o){p(this,"dom");p(this,"node");p(this,"view");p(this,"getPos");p(this,"key");p(this,"collectReactElement");this.node=e,this.getPos=s,this.view=t,this.dom=document.createElement("span"),this.dom.className="content-reference-node";const r=()=>"".concat(Zt());this.key="content-reference-node-".concat(r()),this.collectReactElement=o,this.renderReactComponent()}renderReactComponent(){var i;const{index:e}=this.node.attrs,t=Mt.getState(this.view.state);if(e==null)return;const s=(i=t==null?void 0:t.displayedContentReferences)==null?void 0:i[e];if(!s||s.type!=="grouped_webpages")return;const o=ie.jsx(Yn,{webpageRef:s,trackContentReferenceEvent:()=>{},index:e}),r=Jt.createPortal(o,this.dom);this.collectReactElement(this.key,r)}update(e){return e.attrs!==this.node.attrs&&(this.node=e,this.renderReactComponent()),!0}destroy(){this.collectReactElement(this.key,null)}}class Do{constructor(e,t,s){p(this,"dom");p(this,"node");p(this,"getPos");p(this,"view");this.getPos=s,this.view=t,this.node=e;const o=document.createElement("span");o.className="hive-log-wrapper",o.style.display="inline-block",o.style.userSelect="none";const r=document.createElement("span");r.className="hive-log",r.contentEditable="false",r.setAttribute("data-type","hive-log"),r.setAttribute("data-timestamp",e.attrs.timestamp),r.textContent=ls(e.attrs.timestamp);const i=a=>{a.preventDefault(),a.stopPropagation()};o.addEventListener("mousedown",i),r.addEventListener("mousedown",i),r.addEventListener("click",a=>{a.preventDefault();const{openSidebar:c,setCurrentTime:l}=us.getState();c(),l(parseInt(e.attrs.timestamp))}),o.appendChild(r),this.dom=o}stopEvent(e){return e.type==="mousedown"?(e.preventDefault(),!0):!1}destroy(){}}function No(n={}){return new U({view(e){return new Io(e,n)}})}class Io{constructor(e,t){var s;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(s=t.width)!==null&&s!==void 0?s:1,this.color=t.color===!1?void 0:t.color||"black",this.class=t.class,this.handlers=["dragover","dragend","drop","dragleave"].map(o=>{let r=i=>{this[o](i)};return e.dom.addEventListener(o,r),{name:o,handler:r}})}destroy(){this.handlers.forEach(({name:e,handler:t})=>this.editorView.dom.removeEventListener(e,t))}update(e,t){this.cursorPos!=null&&t.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),t=!e.parent.inlineContent,s;if(t){let a=e.nodeBefore,c=e.nodeAfter;if(a||c){let l=this.editorView.nodeDOM(this.cursorPos-(a?a.nodeSize:0));if(l){let u=l.getBoundingClientRect(),d=a?u.bottom:u.top;a&&c&&(d=(d+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2),s={left:u.left,right:u.right,top:d-this.width/2,bottom:d+this.width/2}}}}if(!s){let a=this.editorView.coordsAtPos(this.cursorPos);s={left:a.left-this.width/2,right:a.left+this.width/2,top:a.top,bottom:a.bottom}}let o=this.editorView.dom.offsetParent;this.element||(this.element=o.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",t),this.element.classList.toggle("prosemirror-dropcursor-inline",!t);let r,i;if(!o||o==document.body&&getComputedStyle(o).position=="static")r=-pageXOffset,i=-pageYOffset;else{let a=o.getBoundingClientRect();r=a.left-o.scrollLeft,i=a.top-o.scrollTop}this.element.style.left=s.left-r+"px",this.element.style.top=s.top-i+"px",this.element.style.width=s.right-s.left+"px",this.element.style.height=s.bottom-s.top+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let t=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),s=t&&t.inside>=0&&this.editorView.state.doc.nodeAt(t.inside),o=s&&s.type.spec.disableDropCursor,r=typeof o=="function"?o(this.editorView,t,e):o;if(t&&!r){let i=t.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let a=mn(this.editorView.state.doc,i,this.editorView.dragging.slice);a!=null&&(i=a)}this.setCursor(i),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){(e.target==this.editorView.dom||!this.editorView.dom.contains(e.relatedTarget))&&this.setCursor(null)}}function Ce(n){return(e,t,s)=>{var c;const{doc:o,selection:r}=e,{empty:i,$head:a}=r;if(i&&(s!=null&&s.endOfTextblock(n))){const l=n==="left"||n==="up"?-1:1,u=Ct.near(o.resolve(l>0?a.after():a.before()),l);if(((c=u.$head)==null?void 0:c.parent.type.name)===He)return t==null||t(e.tr.setSelection(u)),!0}return!1}}const Ao=ze({ArrowLeft:Ce("left"),ArrowRight:Ce("right"),ArrowUp:Ce("up"),ArrowDown:Ce("down")}),ve=new K("modelCursor");function Oo(n,e){return n.setMeta(ve,{modelCursor:e})}function Lo(n){var e;return(e=n.getMeta(ve))!=null?e:null}const wt=(n,e)=>{var c;const{doc:t}=n,s=[];if(!e)return L.empty;const{modelSelectionPositionRange:o,modelCursorPosition:r}=e,{sourceRangeToPmRange:i,sourceEndToPmPos:a}=Me(t);if(r!=null){const l=Re(r,a(r),"min");if(l==null)return L.empty;if(l!=null&&vt(t,l)){const u=t.resolve(l),d=t.nodeAt(l);if((d==null?void 0:d.type.name)===nt.proseMirrorNodeName()||((c=u.nodeBefore)==null?void 0:c.type.name)===nt.proseMirrorNodeName())return L.empty}s.push(se.widget(l,()=>{const u=document.createElement("span");return u.className=Vn.modelCursor,u},{ignoreSelection:!0,side:1}))}else if(o!=null){const{start:l,end:u}=i(o),d=Re(o.start,l,"max"),h=Re(o.end,u,"min");if(d==null||h==null)return L.empty;s.push(se.inline(d,h,{class:"".concat(Kn," bg-[Highlight]!")}))}return s.length?L.create(t,s):L.empty},Bo=(n,e)=>{const t=n.domAtPos(e);let s=t==null?void 0:t.node;if(s===n.dom)return null;for(;s&&!(s instanceof HTMLElement);)s=s.parentNode;return s},Vo=(n,e)=>{const t=Bo(n,e.to);t==null||t.scrollIntoView({behavior:"smooth",block:"center"})},_o=(n,e)=>{var o,r;if(n&&!e)return!0;const t=(o=n==null?void 0:n.modelSelectionPositionRange)==null?void 0:o.start,s=(r=e==null?void 0:e.modelSelectionPositionRange)==null?void 0:r.start;return t!==void 0&&(s===void 0||t!==s)};function yt(n=void 0,e=void 0){return new U({key:ve,state:{init:(t,s)=>{var o;return{modelCursor:n,deco:wt(s,n),isNewCursor:!1,isCursorActive:(o=e==null?void 0:e.isCursorActive)!=null?o:!1}},apply:(t,s,o,r)=>{var d;const i=Lo(t),a=(d=i==null?void 0:i.modelCursor)!=null?d:s.modelCursor,c=wt(r,a),l=!!((!s.isCursorActive||_o(a,s.modelCursor))&&c&&c.find()[0]),u=!!a&&(l||s.isCursorActive);return{modelCursor:a,deco:c,isNewCursor:l,isCursorActive:u}}},props:{decorations(t){const s=this.getState(t);return s==null?void 0:s.deco}},view(t){return{update(s){const{deco:o,isNewCursor:r}=ve.getState(s.state),i=o&&o.find()[0];i&&r&&Vo(s,i)}}}})}const Lt="ignoreDocChange";function zo(n){return n.setMeta(Lt,!0)}function Ho(n){return n.getMeta(Lt)===!0}function Fo(n){var t,s;const e=n.content.size-((s=(t=n.lastChild)==null?void 0:t.content.size)!=null?s:0)-1;if(vt(n,e))return Z.create(n,e)}const Bt=({intl:n,toaster:e,value:t,comments:s,diff:o,maxLength:r=St,selection:i,onFocus:a,onBlur:c,onSave:l,safeUrls:u,modelCursor:d,isDisabled:h,prevState:f,contentReferences:w,shouldUseContentReferencePlugin:k})=>{const x=ce(),J=x.schema();let S=t;r!=null&&S.length>r&&(S=S.slice(0,r),e!=null&&n!=null&&Fe(e,n));let b,v=[],B=[];o&&o.edits.length>0?{doc:b,addedRanges:v,deletedRanges:B}=io({diff:o}):b=x.parse(S);const G=i?$s(b,i):Fo(b),D=()=>{const A=f==null?void 0:f.plugins.find(I=>I.spec.key===Ie().spec.key);return A==null||f==null?Ie():Ie({},A.getState(f))},V=A=>{const I=f==null?void 0:f.plugins.find(E=>E.spec.key===yt().spec.key),y=f&&(I==null?void 0:I.getState(f));return yt(A,y)};return kt.create({doc:b,schema:J,selection:G,plugins:[...k?[gn(w)]:[],vo(n,e,r),x.inputRulesPlugin(),x.keymapPlugin(),ze({"Mod-s":()=>(l(),!0),"Mod-z":At,"Mod-shift-z":Be,"Mod-y":Be}),Ao,go(),No(),wn(),D(),ao(a,c),Pt(s!=null?s:[]),...o?[As(v,B)]:[],V(d),vs(new Set(u!=null?u:[])),Ss(n,h),zs(f?pe.getState(f).suggestion:null),xo(),...Vs()]})},Uo=(n,e)=>{const t=ce(),s=t.schema(),o=t.parse(n);return kt.create({doc:o,schema:s,plugins:[Pt(e!=null?e:[])]})},pr=({mount:n,value:e,comments:t,isDarkMode:s})=>new bt({mount:n},{editable:()=>!1,state:Uo(e,t),nodeViews:{[He]:(r,i,a)=>new Pe(r,i,a,s)}}),Ko=(n,{intl:e,toaster:t,comments:s,value:o,maxLength:r=St,onBlur:i,onFocus:a,onChange:c,onUpdate:l,onSave:u,safeUrls:d,modelCursor:h,selection:f,isDisabled:w,diff:k,prevState:x,contentReferences:J,collectReactElement:S},b=!1)=>{const v=xt(yn()),B=Bt({intl:e,toaster:t,comments:s,value:o,maxLength:r,onBlur:i,onFocus:a,onSave:u,safeUrls:d,modelCursor:h,selection:f,isDisabled:w,diff:k,prevState:x,contentReferences:J,shouldUseContentReferencePlugin:v});l(B);const G=y=>{const E=I.state.apply(y);if(I.updateState(E),l(E),!y.docChanged||Ho(y))return;const m=Dt(E);if(!m)return;const{doc:_}=E,{changeset:W}=m;c==null||c({transaction:y,changeset:W,doc:_,getSerializedDocument:()=>ce().serialize(_),getAdjustedComments:()=>{const O=_n(Tt,E);if(O==null)return[];const q=ce(),X=q.parse(q.serialize(_)),z=fs(X,O.positions);return ms(O.comments,z)}})},D=ce(),V=D.nodeViews(),A=$($($($({},V),v?{[kn]:(y,E,m)=>new Ro(y,E,m,S)}:{}),ds()?{[gs]:(y,E,m)=>new Do(y,E,m)}:{}),k!=null?{}:{[He]:(y,E,m)=>new Pe(y,E,m,b)}),I=new bt({mount:n},te($({state:B,editable:()=>!w,dispatchTransaction:G,nodeViews:A},v?{handleDOMEvents:{copy:(y,E)=>Po(y,E)}}:{}),{handlePaste(y,E){var z,N,T;let m;if(v&&(m=(z=E.clipboardData)==null?void 0:z.getData("application/x-prosemirror")),m||(m=(N=E.clipboardData)==null?void 0:N.getData("text/plain")),m==null)return!1;Y.logEvent("Canvas Prosemirror Paste",{textLength:m.length});const _=Ot(y.state.doc),W=_+m.length,O=r!=null&&W>r;O&&t!=null&&e!=null&&Fe(t,e);const q=(T=E.clipboardData)==null?void 0:T.getData("text/html");if(q){const H=$o(q),F=new window.DOMParser().parseFromString(H,"text/html"),ee=En.fromSchema(y.state.schema).parse(F.body),ue=new Cn(ee.content,1,1);return y.dispatch(y.state.tr.replaceSelection(ue)),!0}let X=m;if(O){const F=r-_-50;X=F>0?m.slice(0,F):""}return Mn(y,X,v),!0}}));return{view:I,pmu:D}},$o=n=>n.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3"),Go="_main_5jn6z_1",Wo={main:Go};function Xo(n,e){const t=e.target;if(t instanceof Element&&[me.PROSEMIRROR_EDITOR_CONTAINER,me.PROSEMIRROR_CONTEXT_CHILDREN].some(c=>t.closest("#".concat(c))!=null))return!1;n.focus();const s=Fs(n.dom.getBoundingClientRect(),{x:e.clientX,y:e.clientY}),o=n.state.tr,r=n.posAtCoords({left:s.x,top:s.y});if(r!=null){const i=Math.min(r.pos,zn(n.state.doc)-1);o.setSelection(new Z(o.doc.resolve(i))),n.dispatch(o)}return!0}const Vt=({editorRef:n,wrapperClassName:e,transparentBackground:t=!1,comments:s,commentingOn:o,diff:r,paddingBottom:i,hoveredCommentId:a,focusedCommentId:c,hoveredEditId:l,rejectedEdits:u,showChanges:d,isDisabled:h=!1,value:f,onBlur:w,onFocus:k,onChange:x,onMouseLeave:J,onSave:S,getAutocompleteSuggestion:b,safeUrls:v,children:B,width:G,modelCursor:D,shouldResetSelection:V=!1,contentReferences:A})=>{var je;const I=Qt(),y=xn(),E=P.useRef(null),m=P.useRef(null),[_,W]=P.useState(null),O=bn(),q=vn(),[{width:X},z]=Qn(),N=P.useRef(w);N.current=w;const T=P.useRef(k);T.current=k;const H=Hs(m,b),F=Pn(),ee=Tn(F),ue=(je=ee==null?void 0:ee.planType)!=null?je:Sn.FREE,we=Rn(F,"1958014328")?1e7:Zn(ue),$e=async g=>{x==null||x(g),Cs(F)&&H(g.getSerializedDocument)},ye=P.useRef($e);ye.current=$e;const oe=P.useRef(S);oe.current=S;const Te=xt(F),[Ht,Ft]=P.useState(()=>new Map),Ge=P.useCallback((g,R)=>{Ft(M=>{const C=new Map(M);return R==null?C.delete(g):C.set(g,R),C})},[]),We=P.useCallback((g=f)=>{var R;return Bt({intl:I,toaster:y,comments:s,diff:r,value:g,selection:V||(R=m.current)==null?void 0:R.state.selection,onBlur:M=>{var C;return(C=N.current)==null?void 0:C.call(N,M)},onFocus:M=>{var C;return(C=T.current)==null?void 0:C.call(T,M)},onSave:()=>{var M;return(M=oe.current)==null?void 0:M.call(oe)},modelCursor:D,isDisabled:h,safeUrls:v,prevState:_,contentReferences:A,shouldUseContentReferencePlugin:Te,maxLength:we})},[I,y,s,r,f,V,D,h,v,_,A,Ge,Te,we]),Ut=P.useCallback(g=>{var M;const R=We(g);(M=m.current)==null||M.updateState(R),W(R)},[We]);P.useImperativeHandle(n,()=>({UNSAFE_setValue:Ut,revertChanges:()=>{if(m.current==null)throw new Error("Tried to call revertChanges, but viewRef.current is null");Bs(m.current)},flushChanges:()=>{if(m.current==null)throw new Error("Tried to call flushChanges, but viewRef.current is null");Ls(m.current)},maybeFocusOnEditor:g=>{if(m.current==null)throw new Error("Tried to call maybeFocus, but viewRef.current is null");return Xo(m.current,g)},viewRef:m})),Dn(()=>{const{current:g}=E;if(!g)return;const{view:R}=Ko(g,{intl:I,toaster:y,comments:s,diff:r,value:f,onBlur:M=>{var C;return(C=N.current)==null?void 0:C.call(N,M)},onFocus:M=>{var C;return(C=T.current)==null?void 0:C.call(T,M)},onChange:M=>{var C;return(C=ye.current)==null?void 0:C.call(ye,M)},onUpdate:W,onSave:()=>{var M;return(M=oe.current)==null?void 0:M.call(oe)},isDisabled:h,safeUrls:v,prevState:_,contentReferences:A,collectReactElement:Ge,maxLength:we},O);return m.current=R,()=>{R==null||R.destroy()}},[r,we]),P.useEffect(()=>{var g;(g=m.current)==null||g.setProps({editable:()=>!h})},[h]),re(g=>Ps(g,h),m,[h]),re(g=>{if(!q)return;const{schema:R}=g.doc.type,M=R.nodes.code_block;return M?(g.doc.descendants((C,Ye)=>{if(C.type===M){const $t=C.type.create(te($({},C.attrs),{isDarkMode:O}),C.content,C.marks);g.replaceWith(Ye,Ye+C.nodeSize,$t)}}),zo(g)):g},m,[q,O]),re(g=>g.setMeta(Le,d),m,[d]),re(g=>Oo(g,D),m,[D]),re(g=>g.setMeta(Tt,{comments:s,commentingOn:o,hoveredCommentId:a,focusedCommentId:c}),m,[s,a,c,o]),re(g=>g.setMeta(Oe,{hoveredEditId:l,rejectedEdits:u!=null?u:new Set}),m,[l,u]),re(g=>xs(g,new Set(v!=null?v:[])),m,[v]);const Kt=P.useCallback(()=>m.current,[m]),Xe=[],qe=[];return P.Children.forEach(B,g=>{if(!P.isValidElement(g))return;const{type:R}=g;if(R===zt)Xe.push(g);else if(R===_t)qe.push(g);else throw new Error("Invalid Prosemirror child: "+JSON.stringify(R))}),ie.jsx(ws.Provider,{value:Kt,children:ie.jsx(ys.Provider,{value:_,children:ie.jsxs(Es.Provider,{value:X,children:[ie.jsx("div",{id:me.PROSEMIRROR_CONTEXT_CHILDREN,children:Xe}),ie.jsxs("div",{className:e,onMouseLeave:J,id:me.PROSEMIRROR_EDITOR_CONTAINER,style:{paddingBottom:i},children:[ie.jsx("div",{ref:Jn(E,z),className:he(Wo.main,$n.composer,"markdown prose dark:prose-invert contain-inline-size focus:outline-hidden",t?"bg-transparent":"bg-[var(--canvas-bg,var(--bg-primary))]"),style:{width:G}}),qe,Te?Array.from(Ht.values()):null]})]})})})},_t=({children:n})=>n,zt=({children:n})=>n;Vt.EditorChildren=_t;Vt.ContextChildren=zt;export{Vt as P,me as T,Uo as a,dr as b,pr as c,yo as d,wo as g,Wo as s};
//# sourceMappingURL=dmzl3n6ea4ax04tv.js.map

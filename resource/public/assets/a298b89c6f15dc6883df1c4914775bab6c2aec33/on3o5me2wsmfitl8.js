const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/d61hyg0k34cvdg7r.js","assets/n75kuy1cx6f5mogg.js","assets/fno7ypwqdtl0x211.js","assets/ewse8exzafeu10ji.js","assets/root-l2v84m1w.css","assets/i70dhxk1j381usod.js","assets/ny10lj7zpuz89fvf.js","assets/conversation-small-hotcas67.css","assets/j4iu4cyxlby9nd33.js","assets/jhe3wdj1wdglvpku.js","assets/ansi-1f6vhsjh.css","assets/eq0refymwif7pcpz.js","assets/iquhayvbn8ec35rz.js","assets/fmsmhem5hrm2cxrs.js","assets/jocaiq9wugboh64i.js","assets/kas18igmwglc2mb4.js","assets/lptwpbjabrvjmhsj.js","assets/jwsjryhasdl9p2nq.js","assets/go4mpxmt63qgntp4.js","assets/fzrn137102spawew.js","assets/dv12g54ivgixitjp.js","assets/jx9lof8tzg97x4l9.js","assets/e2tpmvaykwot5faa.js","assets/ne36kgu5w1zang50.js","assets/frf4c35l48b0bjrb.js","assets/h76aawyn0y8q6s6p.js","assets/d5vv6ct7n3prp63a.js","assets/hkwix64yhkotslv1.js","assets/5hoqitp3r2hkdtny.js","assets/hm7mxp554vts8hxt.js","assets/wham-task-page-content-layout-ihk5sr3r.css","assets/j2tluvxda4ll72qx.js","assets/abgjeqojg38moqsp.js","assets/ca0tcsne49xiprm9.js","assets/gbvlxp0nrrwdd6eq.js","assets/nyfr63odztw7y2ja.js","assets/heyok871zyju5auh.js","assets/ltsv6em2m484o9yy.js","assets/n9nk4w8voewwsboc.js","assets/i3bw46mavo9n01l8.js","assets/ga8p3rr9o0mc72h0.js"])))=>i.map(i=>d[i]);
var Rt=Object.defineProperty,Dt=Object.defineProperties;var Et=Object.getOwnPropertyDescriptors;var it=Object.getOwnPropertySymbols;var Ot=Object.prototype.hasOwnProperty,Bt=Object.prototype.propertyIsEnumerable;var rt=(a,e,o)=>e in a?Rt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[e]=o,U=(a,e)=>{for(var o in e||(e={}))Ot.call(e,o)&&rt(a,o,e[o]);if(it)for(var o of it(e))Bt.call(e,o)&&rt(a,o,e[o]);return a},Ie=(a,e)=>Dt(a,Et(e));import{bG as xt,e as ke,E as wt,x as qt,fB as Wt,ex as ne,B as _e,gg as Ht,ej as vt,ek as _t,C as Ut,f as Se,db as Gt,gz as Qt,i as Ue,j as Me,hC as Vt,so as Kt,gs as $t,R as tt,eG as Ge,dv as zt,tL as Yt,T as bt,ik as je,af as Xt,p as Jt,on as Zt,dG as At}from"./ewse8exzafeu10ji.js";import{r as g,j as t,b as me,M as j,c as yt,g as at,m as kt,a as Pe,f as Tt,u as Qe,A as ea,d as ta,h as aa}from"./n75kuy1cx6f5mogg.js";import{bs as oa,gs as sa,jQ as qe,jR as Je,cO as ia,N as Ze,aq as ra,jx as na,o6 as la,t as nt,jv as da,jw as ca,ar as Ve,a3 as ua,v4 as Ke,bJ as ma,dH as ha,ug as lt,uh as dt,v5 as fa,v6 as ga,kM as pa,dD as xa}from"./ny10lj7zpuz89fvf.js";import{M as $e,b as Ae,W as wa,I as va,f as _a,p as Oe,c as ba,d as ct,a as ya,e as ka}from"./fno7ypwqdtl0x211.js";import{U as Le,m as Ct,v as Ca,c as We,q as jt,V as ja,W as ue,l as Te,w as et,j as Ma,g as ve,n as He,X as Re,k as Pa,u as Sa,b as Ia}from"./fmsmhem5hrm2cxrs.js";import{u as Na}from"./j2tluvxda4ll72qx.js";import{T as Fa,a as La,b as Ra}from"./hm7mxp554vts8hxt.js";import{a as ut,S as Da}from"./abgjeqojg38moqsp.js";import{S as Ea}from"./ca0tcsne49xiprm9.js";import{S as Oa}from"./gbvlxp0nrrwdd6eq.js";import{u as Ba,c as ot,W as qa,d as Mt}from"./jx9lof8tzg97x4l9.js";import{d as Wa,g as Ha,N as Ua}from"./nyfr63odztw7y2ja.js";import{W as mt,D as Ne,O as Ga}from"./n9nk4w8voewwsboc.js";import{s as Be,B as Qa}from"./i3bw46mavo9n01l8.js";const Pt=g.createContext(null);function Vo({value:a,children:e}){return t.jsx(Pt.Provider,{value:a,children:e})}function De(){const a=g.useContext(Pt);if(!a)throw new Error("useWhamTaskPageContext must be used within its provider");return a}function Va(a){var d,u;const e={},o={};let s;for(const n of a)Le(n)?n.previous_turn_id?o[n.previous_turn_id]=n:s=n:n.previous_turn_id&&((u=e[d=n.previous_turn_id])!=null?u:e[d]=[]).push(n);if(!s)return null;const i=n=>{var l;const c=(l=e[n.id])!=null?l:[],r={};for(const m of c){const x=o[m.id];x&&(r[m.id]=i(x))}return{userTurn:n,assistantTurns:c,children:r}};return i(s)}function Ka(a){for(let e=a.length-1;e>=0;e--){const o=a[e];if(Le(o)&&o.previous_turn_id)return o.previous_turn_id}return null}function $a(a,e){var i,d,u,n;if(!a)return[];const o=[];if(e){const c=l=>{for(const m of l.assistantTurns){if(m.id===e)return[{node:l,activeId:m.id}];const x=l.children[m.id],w=x&&c(x);if(w)return[{node:l,activeId:m.id},...w]}return null},r=c(a);r&&o.push(...r)}o.length===0&&o.push({node:a,activeId:(d=(i=a.assistantTurns[0])==null?void 0:i.id)!=null?d:null});let s=o[o.length-1];for(;s!=null&&s.activeId;){const c=s.node.children[s.activeId];if(!c)break;o.push({node:c,activeId:(n=(u=c.assistantTurns[0])==null?void 0:u.id)!=null?n:null}),s=o[o.length-1]}return o}function za(a){return a==null?void 0:a.assistantTurns.some(e=>Ct(e.turn_status))}function Ya({className:a,focusedAssistantTurn:e,currentTab:o,permissions:s,task:i,turns:d,containerHeight:u,onClickFile:n,setFocusedAssistantTurnId:c,onTabChange:r,latestTurnRef:l,latestUserMessageRef:m,hasComments:x,clearComments:w,showFullDiff:p,loadingTurnMapping:h,reserveComposerSpace:k=!0}){var G;g.useEffect(()=>{if(!e){const P=Ka(d);P&&c(P)}},[e,d,c]);const _=g.useMemo(()=>Va(d),[d]),v=g.useMemo(()=>{var P;return $a(_,(P=e==null?void 0:e.id)!=null?P:null)},[_,e==null?void 0:e.id]),O=v.length-1,B=v.slice(0,O),D=xt(v),L=k&&za(D==null?void 0:D.node),{data:f}=Ca(i==null?void 0:i.id),M=g.useMemo(()=>{var Z,te,K;if(!h||!(f!=null&&f.current_assistant_turn))return null;const P=f.current_assistant_turn,Q=((te=(Z=P.sibling_turn_ids)==null?void 0:Z.length)!=null?te:0)+1,V=(K=P.attempt_placement)!=null?K:0,J=Array.from({length:Q},(W,H)=>H===V?P.id:"placeholder-".concat(H)),q={};return J.forEach((W,H)=>q[W]=H),{attemptIds:J,idToIdxMap:q}},[h,f==null?void 0:f.current_assistant_turn]);return t.jsx("div",{className:ke("relative flex h-full w-full flex-col",a),children:t.jsx("div",{className:"flex h-fit min-h-full shrink-0 flex-col gap-6 pt-6 text-sm",children:h&&i&&(f!=null&&f.current_user_turn)&&(f!=null&&f.current_assistant_turn)?t.jsxs("div",{ref:l,className:ke("flex min-h-full shrink-0 flex-col gap-6",L&&"pb-36"),style:{minHeight:u-24},children:[t.jsx("div",{className:"text-token-text-secondary flex w-full items-center justify-center gap-2",children:t.jsx(wt,{className:"text-xl"})}),t.jsx($e,{isLatest:!0,task:i,userTurn:f.current_user_turn,assistantTurns:[f.current_assistant_turn],selectedAssistantId:f.current_assistant_turn.id,focusedAssistantTurn:f.current_assistant_turn,setFocusedAssistantTurnId:c,onClickFile:n,currentTab:o,onTabChange:r,permissions:s,startOpen:!0,hasComments:x,clearComments:w,showFullDiff:p,attemptIdsOverride:M==null?void 0:M.attemptIds,idToIndexMapOverride:M==null?void 0:M.idToIdxMap,latestUserMessageRef:m})]}):t.jsxs(t.Fragment,{children:[B.length>0&&t.jsx("div",{className:"flex flex-col gap-6",children:B.map(({node:P,activeId:Q},V)=>t.jsx($e,{isLatest:V===O,task:i,userTurn:P.userTurn,assistantTurns:P.assistantTurns,selectedAssistantId:Q,focusedAssistantTurn:e,setFocusedAssistantTurnId:c,onClickFile:n,startOpen:V===O,currentTab:o,onTabChange:r,permissions:s,hasComments:x,clearComments:w,showFullDiff:p},P.userTurn.id))}),D&&t.jsx("div",{ref:l,className:ke("flex min-h-full shrink-0 flex-col gap-6",L&&"pb-36"),style:{minHeight:u-24},children:t.jsx($e,{isLatest:!0,task:i,userTurn:D.node.userTurn,assistantTurns:D.node.assistantTurns,selectedAssistantId:(G=e==null?void 0:e.id)!=null?G:null,focusedAssistantTurn:e,setFocusedAssistantTurnId:c,onClickFile:n,currentTab:o,onTabChange:r,permissions:s,startOpen:!0,hasComments:x,clearComments:w,showFullDiff:p,latestUserMessageRef:m})})]})})})}const St=g.createContext(null);function Ko({value:a,children:e}){return t.jsx(St.Provider,{value:a,children:e})}function st(){const a=g.useContext(St);if(!a)throw new Error("useTaskComments must be used within a TaskCommentsProvider");return a}function Xa({currentTab:a,permissions:e,onClickFile:o,onTabChange:s,showFullDiff:i,loadingTurnMapping:d,footer:u}){const{task:n,focusedAssistantTurn:c,pastTurns:r,setFocusedAssistantTurnId:l}=De(),{comments:m,clearComments:x}=st(),[{height:w},p]=Na(),h=g.useRef(null),k=g.useRef(null),_=g.useRef(null);return qt(()=>{const v=h.current,O=_.current;!v||!O||!v.contains(O)||O.scrollIntoView({block:"start",behavior:"auto"})},[r.length,d]),t.jsx("div",{ref:oa(p,h),className:"flex h-full w-full scroll-pt-3 flex-col items-center overflow-y-auto px-6",children:t.jsxs("div",{className:ke("@container w-full",Ae),children:[t.jsx(Ya,{focusedAssistantTurn:c,currentTab:a,permissions:e,task:n,turns:r,containerHeight:w,onClickFile:o,setFocusedAssistantTurnId:l,onTabChange:s,latestTurnRef:k,latestUserMessageRef:_,hasComments:m.length>0,clearComments:x,showFullDiff:i,loadingTurnMapping:d,reserveComposerSpace:u!=null}),u&&t.jsx("div",{className:"keyboard-open:fixed absolute start-0 end-0 bottom-0",children:u})]})})}function Ja({unifiedDiff:a,setUnifiedDiff:e,showFullDiff:o,setShowFullDiff:s}){const i=me(),[d,u]=g.useState(!1);return t.jsxs(Wt,{open:d,onOpenChange:u,contentAlign:"end",sideOffset:8,modal:!0,triggerButton:t.jsx("button",{type:"button",onClick:()=>u(!0),className:"hover:bg-token-border-light flex items-center justify-center rounded p-3","aria-label":i.formatMessage({id:"wham.diffModeDropdown.openMenu",defaultMessage:"Open diff settings menu"}),children:t.jsx(ut,{className:"icon"})}),children:[t.jsxs(ne.RadioGroup,{value:a?"unified":"split",onValueChange:n=>e(n==="unified"),onClick:n=>n.stopPropagation(),children:[t.jsx(ne.RadioItem,{value:"split",onClick:n=>n.stopPropagation(),children:t.jsxs("div",{className:"text-token-text-primary flex items-center gap-3",children:[t.jsx(ut,{className:"icon"}),t.jsx(j,{id:"wham.message.modal.footer.splitDiff",defaultMessage:"Split diff"})]})}),t.jsx(ne.RadioItem,{value:"unified",onClick:n=>n.stopPropagation(),children:t.jsxs("div",{className:"text-token-text-primary flex items-center gap-3",children:[t.jsx(Da,{className:"icon"}),t.jsx(j,{id:"wham.message.modal.footer.unifiedDiff",defaultMessage:"Unified diff"})]})})]}),t.jsx(ne.Separator,{}),t.jsxs(ne.RadioGroup,{value:o?"full":"latest",onValueChange:n=>s(n==="full"),onClick:n=>{n.stopPropagation()},children:[t.jsx(ne.RadioItem,{value:"full",children:t.jsx(j,{id:"wham.copyFile.showFullDiff",defaultMessage:"Full diff"})}),t.jsx(ne.RadioItem,{value:"latest",children:t.jsx(j,{id:"wham.copyFile.showLatestCommit",defaultMessage:"Incremental diff"})})]})]})}function Za(a){"use forget";const e=yt.c(10),{onRetry:o,isRetrying:s}=a,i=me();let d;e[0]!==i?(d=i.formatMessage({id:"wham.whamPreviewImageCarousel.retryAriaLabel",defaultMessage:"Retry loading preview images"}),e[0]=i,e[1]=d):d=e[1];const u=d;let n;e[2]===Symbol.for("react.memo_cache_sentinel")?(n=t.jsx("div",{className:"bg-token-bg-tertiary text-token-text-tertiary rounded-full p-3",children:t.jsx(Ea,{className:"icon-lg"})}),e[2]=n):n=e[2];let c;e[3]===Symbol.for("react.memo_cache_sentinel")?(c=t.jsx("p",{className:"text-token-text-primary text-base font-medium",children:t.jsx(j,{id:"wham.whamPreviewImageCarousel.errorTitle",defaultMessage:"Preview unavailable"})}),e[3]=c):c=e[3];let r;e[4]===Symbol.for("react.memo_cache_sentinel")?(r=t.jsxs("div",{className:"flex flex-col gap-2",children:[c,t.jsx("p",{className:"text-token-text-secondary text-sm",children:t.jsx(j,{id:"wham.whamPreviewImageCarousel.errorSubtitle",defaultMessage:"We couldn't load the preview images. Please try again."})})]}),e[4]=r):r=e[4];let l;e[5]===Symbol.for("react.memo_cache_sentinel")?(l=t.jsx(j,{id:"wham.whamPreviewImageCarousel.retry",defaultMessage:"Retry"}),e[5]=l):l=e[5];let m;return e[6]!==s||e[7]!==o||e[8]!==u?(m=t.jsxs("div",{className:"flex h-full w-full flex-col items-center justify-center gap-4 px-6 text-center",children:[n,r,t.jsx(_e,{color:"secondary",onClick:o,loading:s,label:u,className:"mt-1",children:l})]}),e[6]=s,e[7]=o,e[8]=u,e[9]=m):m=e[9],m}function Aa({previewImages:a}){"use forget";var _;const e=me(),o=sa(a.map(v=>{var O,B,D,L;return{content_type:Ht.ImageAssetPointer,asset_pointer:(O=v.asset_pointer)!=null?O:"",size_bytes:(B=v.size_bytes)!=null?B:0,width:(D=v.width)!=null?D:0,height:(L=v.height)!=null?L:0}})),s=g.useMemo(()=>o.filter(v=>v.data),[o]),i=s.length>0,d=g.useMemo(()=>o.some(v=>v.isError),[o]),u=g.useMemo(()=>o.some(v=>v.isFetching),[o]),[n,c]=g.useState(0),[r,l]=g.useState(!1),m=Math.min(Math.max(n,0),Math.max(s.length-1,0)),x=g.useCallback(()=>{s.length<=1||(c(v=>(v-1+s.length)%s.length),We.recordPreviewImagesCarouselPrev())},[s.length]),w=g.useCallback(()=>{s.length<=1||(c(v=>(v+1)%s.length),We.recordPreviewImagesCarouselNext())},[s.length]),p=g.useCallback(async()=>{l(!0);try{await Promise.all(o.map(v=>v.refetch({throwOnError:!1})))}finally{l(!1)}},[o]);jt([{key:"previewCarouselPrev",action:x,actionMessageDescriptor:e.formatMessage({id:"wham.keyboardActions.previousPreviewImage",defaultMessage:"Select previous image"}),group:Je.Chat,keyboardBinding:[qe.ArrowLeft],enabled:s.length>1},{key:"previewCarouselNext",action:w,actionMessageDescriptor:e.formatMessage({id:"wham.keyboardActions.nextPreviewImage",defaultMessage:"Select next image"}),group:Je.Chat,keyboardBinding:[qe.ArrowRight],enabled:s.length>1}]);const h=(_=s[m])==null?void 0:_.data,k=!i&&d&&!u;return t.jsxs("div",{className:"relative flex h-full w-full items-center justify-center overflow-hidden p-4",children:[k?t.jsx(Za,{isRetrying:r,onRetry:()=>{p()}}):h?t.jsx("div",{className:"flex h-full w-full items-start justify-center overflow-auto",children:t.jsx("img",{src:h.url,width:h.width,height:h.height,alt:e.formatMessage({id:"wham.whamTaskPageContentLoaded.previewImageAlt",defaultMessage:"Generated image"}),className:"h-auto max-w-full"},m)}):t.jsx("div",{className:"text-secondary flex h-full w-full items-center justify-center text-sm",children:t.jsx(j,{id:"wham.whamPreviewImageCarousel.loading",defaultMessage:"Loading preview…"})}),s.length>1&&t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button","aria-label":e.formatMessage({id:"wham.whamPreviewImageCarousel.prev",defaultMessage:"Previous image"}),onClick:x,className:"absolute start-2 top-1/2 -translate-y-1/2 rounded-md bg-black/40 px-2 py-1 text-white hover:bg-black/60 focus:ring-2 focus:ring-white/70 focus:outline-none",children:"‹"}),t.jsx("button",{type:"button","aria-label":e.formatMessage({id:"wham.whamPreviewImageCarousel.next",defaultMessage:"Next image"}),onClick:w,className:"absolute end-2 top-1/2 -translate-y-1/2 rounded-md bg-black/40 px-2 py-1 text-white hover:bg-black/60 focus:ring-2 focus:ring-white/70 focus:outline-none",children:"›"}),t.jsxs("div",{className:"pointer-events-none absolute start-1/2 bottom-2 -translate-x-1/2 rounded-md bg-black/40 px-2 py-0.5 text-xs text-white",children:[m+1," / ",s.length]})]})]})}const It=vt(()=>_t(()=>import("./d61hyg0k34cvdg7r.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40])).then(a=>a.WhamTaskPageCodeDiffContent),{loading:()=>t.jsx("div",{className:"flex-1"})});function Ta(a){"use forget";var re,be;const e=yt.c(97),{currentTab:o,setCurrentTab:s,defaultTab:i,isMobile:d,hasDiff:u,previewImages:n,diffFiles:c,unifiedDiff:r,handleDiffModeChange:l,showFullDiff:m,setShowFullDiff:x,isPreferencesLoading:w,isSharedExampleTask:p,focusedAssistantTurn:h,leftContent:k}=a,{taskId:_,task:v,canFollowUp:O,pastTurns:B}=De(),{comments:D,setComments:L}=st(),f=me();let M;e[0]!==w?(M=[w],e[0]=w,e[1]=M):M=e[1],g.useEffect(ao,M);let G;e:{if(!h){G=null;break e}let b;e[2]!==B?(b=B!=null?B:[],e[2]=B,e[3]=b):b=e[3];const z=b,pe=z.findIndex(X=>X.id===h.id);if(pe>0)for(let X=pe-1;X>=0;X=X-1,X){const we=z[X];if(Le(we)){G=we;break e}}if(h.previous_turn_id){let X;if(e[4]!==h.previous_turn_id||e[5]!==z){let ye;e[7]!==h.previous_turn_id?(ye=Ee=>Le(Ee)&&Ee.id===h.previous_turn_id,e[7]=h.previous_turn_id,e[8]=ye):ye=e[8],X=z.find(ye),e[4]=h.previous_turn_id,e[5]=z,e[6]=X}else X=e[6];const we=X;if(we){G=we;break e}}let xe;e[9]!==z?(xe=[...z].reverse().find(to),e[9]=z,e[10]=xe):xe=e[10];const Y=xe;G=Y!=null?Y:null}const P=G,Q=(re=h==null?void 0:h.id)!=null?re:_,V=!d;let J;e[11]!==f?(J=f.formatMessage({id:"wham.whamTaskPageContentLoaded.conversation",defaultMessage:"Conversation"}),e[11]=f,e[12]=J):J=e[12];let q;e[13]!==f?(q=f.formatMessage({id:"wham.whamTaskPageContentLoaded.conversationAriaLabel",defaultMessage:"Tab to view the conversation with the assistant"}),e[13]=f,e[14]=q):q=e[14];let Z;e[15]!==k||e[16]!==V||e[17]!==J||e[18]!==q?(Z={key:"chat",isHidden:V,label:J,ariaLabel:q,children:k},e[15]=k,e[16]=V,e[17]=J,e[18]=q,e[19]=Z):Z=e[19];const te=n.length===0;let K;e[20]!==f?(K=f.formatMessage({id:"wham.whamTaskPageContentLoaded.preview",defaultMessage:"Preview"}),e[20]=f,e[21]=K):K=e[21];let W;e[22]!==f?(W=f.formatMessage({id:"wham.whamTaskPageContentLoaded.previewAriaLabel",defaultMessage:"Tab to view preview images"}),e[22]=f,e[23]=W):W=e[23];let H;e[24]!==n?(H=t.jsx(Aa,{previewImages:n}),e[24]=n,e[25]=H):H=e[25];let he;e[26]!==W||e[27]!==H||e[28]!==te||e[29]!==K?(he={key:"preview",isHidden:te,label:K,ariaLabel:W,children:H},e[26]=W,e[27]=H,e[28]=te,e[29]=K,e[30]=he):he=e[30];const fe=!u;let le;e[31]!==f?(le=f.formatMessage({id:"wham.whamTaskPageContentLoaded.diff",defaultMessage:"Diff"}),e[31]=f,e[32]=le):le=e[32];let de;e[33]!==f?(de=f.formatMessage({id:"wham.whamTaskPageContentLoaded.diffAriaLabel",defaultMessage:"Tab to view the code diff"}),e[33]=f,e[34]=de):de=e[34];let ae;e[35]!==O||e[36]!==D||e[37]!==c||e[38]!==u||e[39]!==w||e[40]!==L||e[41]!==r?(ae=!w&&u&&t.jsx(It,{diffFiles:c,unifiedDiff:r,enableComments:O,comments:D,setComments:L}),e[35]=O,e[36]=D,e[37]=c,e[38]=u,e[39]=w,e[40]=L,e[41]=r,e[42]=ae):ae=e[42];let oe;e[43]!==fe||e[44]!==le||e[45]!==de||e[46]!==ae?(oe={key:"diff",isHidden:fe,label:le,ariaLabel:de,children:ae},e[43]=fe,e[44]=le,e[45]=de,e[46]=ae,e[47]=oe):oe=e[47];let se;e[48]!==f?(se=f.formatMessage({id:"wham.whamTaskPageContentLoaded.logs",defaultMessage:"Logs"}),e[48]=f,e[49]=se):se=e[49];let A;e[50]!==f?(A=f.formatMessage({id:"wham.whamTaskPageContentLoaded.logsAriaLabel",defaultMessage:"Tab to view the work logs"}),e[50]=f,e[51]=A):A=e[51];const ce=(be=h==null?void 0:h.environment)==null?void 0:be.agent_network_access;let T;e[52]!==h||e[53]!==ce||e[54]!==_?(T=t.jsx(wa,{taskId:_,focusedAssistantTurn:h,agentNetworkAccess:ce}),e[52]=h,e[53]=ce,e[54]=_,e[55]=T):T=e[55];let S;e[56]!==p||e[57]!==se||e[58]!==A||e[59]!==T?(S={key:"logs",isHidden:p,label:se,ariaLabel:A,children:T},e[56]=p,e[57]=se,e[58]=A,e[59]=T,e[60]=S):S=e[60];let R;e[61]!==f?(R=f.formatMessage({id:"wham.whamTaskPageContentLoaded.internalDataModels",defaultMessage:"Internal Data Models"}),e[61]=f,e[62]=R):R=e[62];let N;e[63]!==f?(N=f.formatMessage({id:"wham.whamTaskPageContentLoaded.internalDataModelsAriaLabel",defaultMessage:"Tab to view internal data models"}),e[63]=f,e[64]=N):N=e[64];const ge=h==null?void 0:h.internal_only_rollouts;let ee;e[65]!==h||e[66]!==ge||e[67]!==v||e[68]!==P?(ee=t.jsx(va,{task:v,userTurn:P,assistantTurn:h,rollout:ge}),e[65]=h,e[66]=ge,e[67]=v,e[68]=P,e[69]=ee):ee=e[69];let ie;e[70]!==R||e[71]!==N||e[72]!==ee?(ie={key:"internal_data_models",isHidden:!0,label:R,ariaLabel:N,children:ee},e[70]=R,e[71]=N,e[72]=ee,e[73]=ie):ie=e[73];let $;e[74]!==he||e[75]!==oe||e[76]!==S||e[77]!==ie||e[78]!==Z?($=[Z,he,oe,S,ie],e[74]=he,e[75]=oe,e[76]=S,e[77]=ie,e[78]=Z,e[79]=$):$=e[79];let y;e[80]!==l||e[81]!==u||e[82]!==x||e[83]!==m||e[84]!==r?(y=u&&t.jsx(Ja,{unifiedDiff:r,setUnifiedDiff:l,showFullDiff:m,setShowFullDiff:x}),e[80]=l,e[81]=u,e[82]=x,e[83]=m,e[84]=r,e[85]=y):y=e[85];let I;e[86]!==d||e[87]!==y?(I=t.jsx(Fa,{withUnderline:d,className:"items-center border-b p-3 pe-16 max-md:py-0",children:y}),e[86]=d,e[87]=y,e[88]=I):I=e[88];let C;e[89]===Symbol.for("react.memo_cache_sentinel")?(C=t.jsx(La,{children:eo}),e[89]=C):C=e[89];let E;return e[90]!==o||e[91]!==i||e[92]!==s||e[93]!==$||e[94]!==Q||e[95]!==I?(E=t.jsx("div",{className:"relative flex h-full w-full flex-col",children:t.jsxs(Ra,{onChange:s,currentTab:o,defaultTab:i,tabs:$,children:[I,C]},Q)}),e[90]=o,e[91]=i,e[92]=s,e[93]=$,e[94]=Q,e[95]=I,e[96]=E):E=e[96],E}function eo(a){const{content:e}=a;return t.jsx("div",{className:"flex h-full w-full",children:e})}function to(a){return Le(a)}function ao(){It.prefetch()}function oo({isOpen:a,onConfirm:e,onClose:o,loading:s}){return t.jsx(Ut,{isOpen:a,onClose:o,testId:"modal-wham-retry-all-turns",type:"warning",title:t.jsx("p",{className:"text-token-text-primary font-semibold",children:t.jsx(j,{id:"wham.retryAllTurnsModal.title",defaultMessage:"Retry all turns"})}),primaryButton:t.jsx(_e,{color:"primary",loading:s,onClick:e,children:t.jsx(j,{id:"wham.retryAllTurnsModal.confirm",defaultMessage:"Retry all turns"})}),secondaryButton:t.jsx(_e,{color:"secondary",onClick:o,children:t.jsx(j,{id:"wham.retryAllTurnsModal.cancel",defaultMessage:"Cancel"})}),children:t.jsx("div",{className:"text-sm",children:t.jsx(j,{id:"wham.retryAllTurnsModal.message",defaultMessage:"All latest turns will restart, including any siblings turns that are in progress or completed."})})})}function so({focusedAssistantTurn:a,lastTurn:e,siblings:o}){const s=(e==null?void 0:e.type)==="assistant"?e.turn_status:"completed";return a&&((e==null?void 0:e.id)===a.id||o.some(d=>d.id===(e==null?void 0:e.id)))?a.turn_status:s}function io({turnId:a,comments:e,clearComments:o,lastTurn:s,focusedAssistantTurn:i,retry:d,attemptIndex:u,siblings:n}){var oe,se,A,ce,T;const{taskId:c,task:r,setFocusedAssistantTurnId:l}=De(),m=at(),x=me(),w=Se(),p=Gt(),h=Qt(),k=Ba(),_=S=>{Kt($t(h)),o(),l(S.turn.id)},v=async()=>{var S,R;if(d){M(!0);try{if(d.previousTurnId){const N=await ue.createFollowUpTask(c,d.previousTurnId,d.prompt,(S=d.comments)!=null?S:[],!1,q?(R=d.bestOfN)!=null?R:1:void 0,k?d.attachments:[]);_(N)}else{const N=await ue.createNewTask(d.environmentId,d.branch,d.prompt,!1,q?d.bestOfN:void 0,k?d.attachments:[]);m("/codex/tasks/".concat(N.task.id))}P(!1)}catch(N){N instanceof Te?et(N,a,x,w):w.danger({id:"wham.whamTaskPageFooter.errorRetryingTask",defaultMessage:"Error retrying task",description:"Error retrying task"},{toastId:"wham_task_page_footer_error_retrying_task"})}finally{M(!1)}}},O=!!i&&ot(i.output_items).outputDiffs.length>0,B=!s||!i||s.id===(i==null?void 0:i.id)||!O,D=d&&B&&(i==null?void 0:i.turn_status)==="failed",L=(i==null?void 0:i.previous_turn_id)&&(s==null?void 0:s.type)==="assistant"&&i.previous_turn_id===s.previous_turn_id,[f,M]=g.useState(!1),[G,P]=g.useState(!1),Q=Ue(),V=Me(Q,"1406552515"),J=Me(Q,"879591222")||void 0,q=Me(Q,"3492040717"),Z=g.useMemo(()=>{var N,ge,ee,ie,$,y,I;const S=[...(ee=(ge=(N=i==null?void 0:i.output_items)==null?void 0:N.find(C=>C.type==="review"))==null?void 0:ge.suggested_followup_tasks)!=null?ee:[],...($=(ie=i==null?void 0:i.output_items)==null?void 0:ie.filter(C=>C.type==="suggested_task"))!=null?$:[]],R=_a((I=(y=i==null?void 0:i.child_turns)==null?void 0:y.filter(C=>C.source.type==="suggested_task"))==null?void 0:I.map(C=>[C.source.suggested_task_id,C]));return S.map(C=>{var E,re,be,b;return{suggestion:C,userTurnId:C.id&&(re=(E=R[C.id])==null?void 0:E.assistant_turn_id)!=null?re:null,assistantTurnId:C.id&&(b=(be=R[C.id])==null?void 0:be.user_turn_id)!=null?b:null}})},[i]),te=(oe=i==null?void 0:i.id)!=null?oe:a,K=g.useMemo(()=>{var S,R;return(R=(S=i==null?void 0:i.output_items)==null?void 0:S.filter(ja))!=null?R:[]},[i]),W=g.useMemo(()=>K.reduce((S,R)=>S+R.comments.filter(N=>N.priority===0||N.priority===1).length,0),[K]),H=((A=(se=r==null?void 0:r.task_status_display)==null?void 0:se.latest_turn_status_display)==null?void 0:A.intent)==="cr",he=(B||L)&&K.length>0,fe=Wa({taskId:c,latestTurnId:te}),le=fe.isPending||!te||W===0||V,de=so({focusedAssistantTurn:i,lastTurn:s,siblings:n}),ae=(ce=n==null?void 0:n.map(S=>S.turn_status))!=null?ce:[];return(s==null?void 0:s.type)==="assistant"&&["pending","in_progress"].includes(s.turn_status)&&!J?null:t.jsxs(t.Fragment,{children:[t.jsxs("div",{id:"wham-message-modal-footer",className:"z-50 flex w-full justify-center",children:[(B||L)&&t.jsx("div",{className:"flex w-full justify-center px-4",children:t.jsx("div",{className:ke("relative z-1 flex w-full flex-col pt-2 pb-4",Ae),children:D?t.jsx(_e,{className:"w-full",color:"primary",size:"large",loading:f&&!G,onClick:()=>{var S;((S=d==null?void 0:d.bestOfN)!=null?S:1)>1?P(!0):v()},children:((T=d.bestOfN)!=null?T:1)>1?x.formatMessage({id:"wham.whamTaskPageFooter.retryAllTurns",defaultMessage:"Retry all turns"}):x.formatMessage({id:"wham.whamTaskPageFooter.retry",defaultMessage:"Retry"})}):he?t.jsxs("div",{className:"flex w-full flex-col gap-3",children:[t.jsx(mt,{}),t.jsx(_e,{className:"w-full",color:"primary",size:"large",disabled:le,loading:fe.isPending,onClick:()=>{le||fe.mutateAsync(void 0)},children:t.jsx(j,{id:"wham.whamTaskPageFooter.fixIssues",defaultMessage:"{count, plural, one {Fix issue} other {Fix issues}}",values:{count:W}})})]}):o&&!H&&t.jsxs("div",{className:"flex w-full flex-col gap-3",children:[t.jsx(mt,{}),!V&&t.jsx(qa,{disableAutoFocus:!0,disableDuringSubmit:!0,onSuccess:_,onClearComments:o,followUp:{taskId:c,turnId:a,comments:e,turnStatus:de,siblingTurnStatuses:ae,followUpSuggestions:Z},attemptIndex:u,ariaLabel:x.formatMessage({id:"wham.whamTaskPageFooter.composerAriaLabel",defaultMessage:"Composer to enter a follow up prompt to the task"})})]})})}),!B&&!L&&t.jsx(kt.div,{layout:!0,className:ke("dark mx-6 mb-6 w-full",Ae),initial:{opacity:0,translateY:10},animate:{opacity:1,translateY:0},exit:{opacity:0,translateY:10},transition:{duration:p?0:.25},children:t.jsx(Vt,{title:t.jsx(j,{id:"wham.whamTaskPageFooter.previousTurn",defaultMessage:"You are viewing a previous turn"}),primaryCtaText:t.jsx(j,{id:"wham.whamTaskPageFooter.viewLatestTurn",defaultMessage:"View latest"}),content:t.jsx(j,{id:"wham.whamTaskPageFooter.followUpsLatestTurn",defaultMessage:"Follow-ups are only available for the latest turn"}),icon:t.jsx(Oa,{className:"icon"}),onPrimaryCtaClick:()=>l(s.id)})})]}),t.jsx(oo,{isOpen:G,onClose:()=>P(!1),onConfirm:v,loading:f})]})}const Nt=window.location.origin+"/s/";function ro(a){return"".concat(Nt).concat(a)}function Ft(a){var e,o;return!a||!a.attachments||a.attachments.length===0||a.attachments[0].kind!=="codex"?null:{postId:a.id,permalink:(e=a.permalink)!=null?e:ro(a.id),permissions:(o=a.permissions.share_setting)!=null?o:"public",codexTask:a.attachments[0].task,codexTurn:a.attachments[0].turns}}function Fe(a){return["codex_tasks","result","share",a]}function no({taskId:a,enabled:e}){return Tt({enabled:!!a&&e,queryKey:Fe(a),queryFn:async()=>{const o=await tt.safeGet("/share/post/by_codex_task/{codex_task_id}",{parameters:{path:{codex_task_id:a}}});return o.post?Ft(o.post):null}})}function lo({taskId:a,onSuccess:e,onError:o}){return Pe({scope:{id:a},mutationFn:()=>ue.forkSharedTask(a),onSuccess:e,onError:o})}function co({taskId:a,turnId:e,onSuccess:o,onError:s}){return Pe({scope:{id:a},mutationFn:async()=>{const i=await tt.safePost("/share/post",{requestBody:{attachments_to_create:[{kind:"codex",codex_task_id:a,current_codex_turn_id:e}]}});return Ft(i.post)},onSuccess:o,onError:s})}function uo({taskId:a,sharedResult:e}){var s;const o=Qe();return Pe({scope:{id:(s=e==null?void 0:e.postId)!=null?s:""},mutationFn:async({sharedResultId:i,access:d})=>(await tt.safePost("/share/post/update_access",{requestBody:{post_id:i,share_settings:d}})).share_setting,onMutate:({access:i})=>{const d=Fe(a),u=o.getQueryData(d);return o.setQueryData(d,u&&Ie(U({},u),{permissions:i})),{previousAccess:u==null?void 0:u.permissions}},onSuccess:i=>{const d=Fe(a),u=o.getQueryData(d);u&&o.setQueryData(d,Ie(U({},u),{permissions:i}))},onError:(i,d,u)=>{var r;const n=Fe(a),c=o.getQueryData(n);o.setQueryData(n,c&&Ie(U({},c),{permissions:(r=u==null?void 0:u.previousAccess)!=null?r:"public"}))}})}function mo({taskId:a}){const e=me(),o=Se(),s=at(),{mutate:i}=lo({taskId:a,onSuccess:d=>{var u,n;(u=d==null?void 0:d.task)!=null&&u.id&&s("/codex/tasks/".concat((n=d==null?void 0:d.task)==null?void 0:n.id))},onError:()=>{o.danger(e.formatMessage({id:"wham.codexForkButton.failedToFork",defaultMessage:"Failed to fork task"}))}});return t.jsx(_e,{size:"small",color:"secondary",type:"button",className:"px-3 py-2",onClick:()=>i(),children:t.jsx(j,{id:"wham.share.taskForkButton",defaultMessage:"Fork"})})}const ho="".concat(Nt,"...");function fo({taskId:a,turnId:e,isLoading:o,sharedResult:s,title:i}){const[d,u]=g.useState(!1),n=(_,v)=>{_&&ua(_,void 0,v).then(()=>{u(!0),setTimeout(()=>u(!1),1500)}).catch(()=>{})},c=Qe(),r=Se(),{mutate:l,isPending:m}=co({taskId:a,turnId:e,onSuccess:_=>{if(!_){r.danger("Failed to create share link");return}c.setQueryData(Fe(a),_),n(_.permalink)}}),{mutate:x}=uo({taskId:a,sharedResult:s}),w=g.useRef(null),p=_=>{var v;(v=w.current)==null||v.focus(),s?n(s.permalink,_):l()},h=_=>{s&&x({sharedResultId:s.postId,access:_})},k=_=>{switch(_){case"public":return Ve.PUBLIC;case"private":return Ve.PRIVATE;case"workspace":return Ve.WORKSPACE}};return t.jsx(Qa,{inputRef:w,isLoading:o,isPublishedVersionLatest:!0,sharedObject:s&&{id:s.postId,title:i,access:k(s.permissions)},title:i,shareTextPlaceholder:ho,shareUrl:s==null?void 0:s.permalink,isCopySuccessful:d,isCreateLinkRequestInProgress:m,handlePrivacyChange:h,handlePrimaryButtonClick:p})}function go({taskId:a,turnId:e,isDisabled:o,title:s}){const i=Ge(),d=zt(),u=me(),[n,c]=g.useState(!1),{data:r,isLoading:l}=no({taskId:a,enabled:n&&!o}),{triggerRef:m,container:x}=Yt({isOpen:n,onClose:()=>c(!1)}),w=(d==null?void 0:d.isWorkspaceAccount())&&!(d!=null&&d.features.includes(ia.WorkspaceShareLinks));return o||w?t.jsx(bt,{label:w?u.formatMessage(Be.workspaceSharingDisabled):u.formatMessage(Be.share),children:t.jsx(Ze,{disabled:!0,icon:ra,"aria-label":u.formatMessage(w?Be.workspaceSharingDisabled:Be.share)})}):t.jsxs(na,{open:n,onOpenChange:c,children:[t.jsx(la,{ref:m,asChild:!0,children:i?t.jsx(Ze,{icon:nt,"aria-label":u.formatMessage({id:"wham.whamTaskPageHeader.shareAriaLabel",defaultMessage:"Share task"})}):t.jsx(_e,{icon:nt,color:"ghost","aria-label":u.formatMessage({id:"wham.whamTaskPageHeader.shareAriaLabel",defaultMessage:"Share task"}),children:t.jsx(j,{id:"wham.whamTaskPageHeader.share",defaultMessage:"Share"})})}),t.jsx(ea,{children:n&&t.jsx(da,{forceMount:!0,container:x,children:t.jsx(ca,{align:"end",className:"z-50",sideOffset:8,collisionPadding:8,children:t.jsx(fo,{title:s,taskId:a,turnId:e,sharedResult:r,isLoading:l})})})})]})}function po({assistantTurn:a}){var w,p,h,k,_,v;const e=me(),o=Se(),s=Ge(),i=(h=(p=(w=a==null?void 0:a.pull_request_data)==null?void 0:w.head)!=null?p:a==null?void 0:a.branch)!=null?h:"",d=Ha(i),u=i&&i!==d,{outputDiffs:n}=ot(a==null?void 0:a.output_items),c=n[0],r=(v=(_=a==null?void 0:a.base_commit_sha)!=null?_:(k=a==null?void 0:a.pull_request_data)==null?void 0:k.base_sha)!=null?v:c==null?void 0:c.base_commit_sha;if(s||!i)return null;const l=r!=null&&i!==r,x=l?t.jsx("span",{className:"text-token-text-secondary hover:text-token-text-primary cursor-pointer",onClick:()=>{navigator.clipboard.writeText(r!=null?r:""),o.success(e.formatMessage({id:"wham.baseSha.copied",defaultMessage:"Copied branch commit SHA to clipboard"}))},children:r}):u?i:void 0;return t.jsx(bt,{label:x,side:"bottom",disabled:!x,interactive:l,children:t.jsx("span",{className:"text-token-text-secondary hover:text-token-text-primary cursor-pointer truncate",onClick:()=>{navigator.clipboard.writeText(i),o.success(e.formatMessage({id:"wham.branchName.copied",defaultMessage:"Copied branch name to clipboard"}))},children:d})})}const xo=({assistantTurn:a})=>{const e=me(),o=g.useMemo(()=>a!=null&&a.created_at?new Date(a.created_at*1e3):null,[a==null?void 0:a.created_at]),s=g.useMemo(()=>(o==null?void 0:o.getFullYear())===new Date().getFullYear(),[o]);return o?o.toLocaleDateString(e.locale,{month:"short",day:"numeric",year:s?void 0:"numeric"}):null},wo=" · ";function vo({title:a,assistantTurn:e}){var c,r,l,m;const{linesAdded:o,linesRemoved:s}=Mt(e),i=(c=e==null?void 0:e.environment)==null?void 0:c.label,d=(m=(l=(r=e==null?void 0:e.pull_request_data)==null?void 0:r.head)!=null?l:e==null?void 0:e.branch)!=null?m:"",n=[{key:"created-at",element:t.jsx("span",{className:"text-token-text-secondary truncate empty:hidden max-md:hidden",children:t.jsx(xo,{assistantTurn:e})}),hideOnMobile:!0,shouldShow:!!(e!=null&&e.created_at)},{key:"environment",element:t.jsx("span",{className:"text-token-text-secondary truncate",children:i}),hideOnMobile:!1,shouldShow:!!i},{key:"branch",element:t.jsx(po,{assistantTurn:e}),hideOnMobile:!0,shouldShow:!!d,noSeparator:!0},{key:"stats",element:t.jsx("span",{className:"max-md:hidden",children:t.jsx(Ma,{linesAdded:o,linesRemoved:s})}),hideOnMobile:!0,shouldShow:!!(o||s)}].filter(x=>x.shouldShow);return t.jsxs("div",{className:"flex min-w-0 flex-col text-sm",children:[t.jsx("div",{className:"flex items-center gap-1",children:t.jsx("span",{className:"truncate font-medium",children:a})}),t.jsx("div",{className:"flex gap-2 max-md:flex-wrap max-md:gap-1",children:n.map((x,w)=>{const p=n[w-1],h=(p==null?void 0:p.hideOnMobile)||x.hideOnMobile||x.noSeparator;return t.jsxs(g.Fragment,{children:[w>0&&t.jsx("span",{"aria-hidden":"true",className:ke("text-token-text-secondary",h?"max-md:hidden":""),children:wo}),x.element]},x.key)})})]})}const _o=({copyApplyToClipboard:a,copyPatchToClipboard:e,createPr:o,updateBranch:s,navigateToCreatingPrPage:i,canCreatePr:d,isCreatingPr:u,permissions:n,assistantTurn:c,showOnlyViewPr:r})=>{var p,h;const l=Ue(),m=me(),x=Me(l,"296452287"),w=t.jsxs(t.Fragment,{children:[s&&d&&t.jsx(ne.Item,{icon:je,onClick:()=>o(),"aria-label":m.formatMessage(F.createNewPr),children:t.jsx("div",{className:"flex items-center gap-1.5",children:t.jsx(j,U({},F.createNewPr))})}),t.jsx(ne.Item,{icon:Ke,onClick:()=>a(),"aria-label":m.formatMessage(F.copyGitApply),children:t.jsx(j,U({},F.copyGitApply))}),t.jsx(ne.Item,{icon:Ke,onClick:()=>e(),"aria-label":m.formatMessage(F.copyPatch),children:t.jsx(j,U({},F.copyPatch))})]});return r?(p=c==null?void 0:c.pull_request_data)!=null&&p.url?t.jsx(_e,{icon:je,onClick:()=>{var k;(k=c==null?void 0:c.pull_request_data)!=null&&k.url&&window.open(c.pull_request_data.url,"_blank")},children:t.jsx(j,U({},F.viewPullRequest))}):null:!d||n==="read"?t.jsx(Ne,{buttonIcon:ma,onClick:()=>a(),triggerButtonAriaLabel:F.openDropdown,dropdownContent:t.jsx(ne.Item,{icon:Ke,onClick:()=>e(),"aria-label":m.formatMessage(F.copyPatch),children:t.jsx(j,U({},F.copyPatch))}),children:t.jsx(j,U({},F.copyGitApply))}):u?t.jsx(Ne,{buttonIcon:wt,onClick:i,dropdownContent:w,triggerButtonAriaLabel:F.openDropdown,children:t.jsx(j,U({},F.viewPullRequest))}):(h=c==null?void 0:c.pull_request_data)!=null&&h.url&&(c==null?void 0:c.pull_request_status)!=="externally_created"?t.jsx(Ne,{buttonIcon:je,as:"a",href:c.pull_request_data.url,dropdownContent:w,triggerButtonAriaLabel:F.openDropdown,children:t.jsx(j,U({},F.viewPullRequest))}):s?t.jsx(Ne,{buttonIcon:je,onClick:()=>s(),dropdownContent:w,triggerButtonAriaLabel:F.openDropdown,children:t.jsx(j,U({},F.updateExistingBranch))}):t.jsx(Ne,{buttonIcon:je,onClick:()=>o(),"aria-label":m.formatMessage(F.createPr),triggerButtonAriaLabel:F.openDropdown,dropdownContent:t.jsxs(t.Fragment,{children:[t.jsx(ne.Item,{icon:je,onClick:()=>o("draft"),"aria-label":m.formatMessage(F.createDraftPr),children:t.jsx(j,U({},F.createDraftPr))}),x&&t.jsx(ne.Item,{icon:je,onClick:()=>o("auto_merge"),"aria-label":m.formatMessage(F.createAutoMergePr),children:t.jsx(j,U({},F.createAutoMergePr))}),t.jsx(ne.Separator,{}),w]}),children:t.jsx(j,U({},F.createPr))})},F=ta({copyGitApply:{id:"wham.whamTaskPushDiffDropdown.copyGitApply",defaultMessage:"Copy git apply"},copyPatch:{id:"wham.whamTaskPushDiffDropdown.copyPatch",defaultMessage:"Copy patch"},viewPullRequest:{id:"wham.message.modal.footer.viewPr",defaultMessage:"View PR"},createPr:{id:"wham.message.modal.footer.createPrItem",defaultMessage:"Create PR"},createNewPr:{id:"wham.whamTaskPushDiffDropdown.createNewPr",defaultMessage:"Create new PR"},createDraftPr:{id:"wham.message.modal.footer.createDraftPr",defaultMessage:"Create draft PR"},createAutoMergePr:{id:"wham.message.modal.footer.createAutoMergePr",defaultMessage:"Create auto-merged PR"},updateExistingBranch:{id:"wham.whamTaskPushDiffDropdown.updateExistingBranch",defaultMessage:"Update branch"},openDropdown:{id:"wham.whamTaskPushDiffDropdown.openDropdown",defaultMessage:"Open git action menu"}});var ze,ht;function bo(){if(ht)return ze;ht=1;function a(e){return e&&e.length?e[0]:void 0}return ze=a,ze}var Ye,ft;function yo(){return ft||(ft=1,Ye=bo()),Ye}var ko=yo();const Co=aa(ko);function jo({focusedAssistantTurn:a,onClose:e,shouldShowShare:o,shouldShowFork:s,permissions:i,title:d,isSharedExampleTask:u=!1}){var ie,$;const{taskId:n,task:c,currentDiffTaskTurn:r}=De(),[l,m]=g.useState((r==null?void 0:r.pull_request_status)==="creating"),[x,w]=g.useState(void 0),p=Se(),h=Qe(),k=me(),_=Co(ve(r)),v=i==="write",O=He(y=>y.getTurnsForTask(n).filter(Re)),B=He(y=>y.getTurnsForTask(n)),D=new Map(B.map(y=>[y.id,y])),L=y=>{if(Re(y)){const C=c==null?void 0:c.external_pull_requests;if(C&&C.length)for(let E=C.length-1;E>=0;E--){const re=C[E];if(re.assistant_turn_id===y.id)return re}}const I=y.previous_turn_id?D.get(y.previous_turn_id):void 0;return I?L(I):void 0},f=r!=null?r:a,M=f?L(f):void 0,{linesAdded:G,linesRemoved:P}=Mt(r),{outputDiffs:Q,hasPreApplyPatch:V}=ot(r==null?void 0:r.output_items),J=v&&!V,q=(($=(ie=c==null?void 0:c.task_status_display)==null?void 0:ie.latest_turn_status_display)==null?void 0:$.intent)==="cr",Z=at(),te=Ue(),W=(Me(te,"2665240312")||void 0)&&!!(a!=null&&a.id)&&v&&!q,H=Me(te,"369193424"),fe=O.filter(y=>{var I;return(I=r==null?void 0:r.sibling_turn_ids)==null?void 0:I.includes(y.id)}).some(y=>{var I;return(I=y.pull_request_data)==null?void 0:I.url}),le=H&&i==="write"&&M&&!M.pull_request.merged&&M.pull_request.state!=="closed"&&M.codex_updated_sha!==""&&((r==null?void 0:r.id)!==M.assistant_turn_id||(r==null?void 0:r.pull_request_status)==="externally_created")&&!fe,de=g.useRef(null),{mutate:ae,isPending:oe}=Pe({mutationFn:async()=>{n&&await ue.archiveTask(n)},onSuccess:async()=>{await h.invalidateQueries({queryKey:["wham","tasks"]}),await h.invalidateQueries({queryKey:["wham","task",n]}),Z("/codex")},onError:()=>{p.danger({id:"wham.whamTaskPageHeader.failedToArchiveTask",defaultMessage:"Failed to archive task",description:"Toast when archive request fails"},{toastId:"wham_task_page_header_failed_to_archive_task"})}}),{mutate:se,isPending:A}=Pe({mutationFn:async()=>{n&&await ue.recoverTask(n)},onSuccess:async()=>{await h.invalidateQueries({queryKey:["wham","tasks"]}),await h.invalidateQueries({queryKey:["wham","task",n]})},onError:()=>{p.danger({id:"wham.whamTaskPageHeader.failedToArchiveTask",defaultMessage:"Failed to archive task",description:"Toast when archive request fails"},{toastId:"wham_task_page_header_failed_to_archive_task"})}}),ce=oe||A;g.useEffect(()=>{(r==null?void 0:r.pull_request_status)==="creating"?(m(!0),h.invalidateQueries({queryKey:["wham","task",n,"turns"]})):m(!1)},[n,r==null?void 0:r.pull_request_status,h]),jt([{key:"copyApplyToClipboard",action:()=>{T()},actionMessageDescriptor:k.formatMessage({id:"wham.keyboardActions.copyApplyToClipboard",defaultMessage:"Copy git apply"}),group:Je.Chat,keyboardBinding:[qe.Mod,qe.Shift,";"],enabled:!!_}]);const T=async()=>{_&&(await navigator.clipboard.writeText(" (cd \"$(git rev-parse --show-toplevel)\" && git apply --3way <<'EOF' \n".concat(_," \nEOF\n)")),p.success(k.formatMessage({id:"wham.message.modal.footer.copiedToClipboard",defaultMessage:"Copied git apply command to clipboard"}),{duration:3,hasCloseButton:!0}),r!=null&&r.id&&(We.recordGitAction("diff-copied",G,P,n,r.id,"regular"),ue.copyGitApply(n,r.id,!0)))},S=async()=>{_&&(await navigator.clipboard.writeText(_),p.success(k.formatMessage({id:"wham.whamTaskPageHeader.copiedPatchToClipboard",defaultMessage:"Copied patch to clipboard"}),{duration:3,hasCloseButton:!0}),r!=null&&r.id&&await ue.copyGitApply(n,r.id,!1))},R=async()=>{if(!M||!(r!=null&&r.id)){p.danger({id:"wham.whamTaskPageHeader.noPrToUpdate",defaultMessage:"No PR to update",description:"Toast when no PR is found to update"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_no_pr_to_update"});return}m(!0);try{await ue.updatePr(n,r.id,M.id)}catch(y){m(!1),await ue.getTaskTurnPR(n,M.assistant_turn_id),y instanceof Te?et(y,r.id,k,p):p.danger({id:"wham.whamTaskPageHeader.failedToUpdatePr",defaultMessage:"Failed to update PR",description:"Toast when failed to update PR"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_failed_to_update_pr"})}finally{await h.refetchQueries({queryKey:["wham","tasks"]}),await h.refetchQueries({queryKey:["wham","task",n]}),m(!1)}},N=async y=>{if(!(r!=null&&r.id))return;w(y);const I=de.current;try{m(!0),await ue.createPr(n,r.id,y),await h.refetchQueries({queryKey:["wham","task"]}),await h.fetchQuery(Pa(n,r.id)).then(C=>{const E=C;E.turn.pull_request_data!=null&&(I&&!I.closed&&E.turn.pull_request_data.url&&I.location.assign(E.turn.pull_request_data.url),fa({title:E.task.title,clientThreadId:E.turn.conversation_id,subtitle:k.formatMessage({id:"wham.message.modal.footer.prCreatedSuccess",defaultMessage:"Click to view your pull request."}),onClick:()=>{var re;window.open((re=E.turn.pull_request_data)==null?void 0:re.url,"_blank")}}))}),We.recordGitAction("pr-created",G,P,n,r.id,y!=null?y:"regular")}catch(C){m(!1),I==null||I.close(),C instanceof Te?et(C,r.id,k,p):p.danger({id:"wham.message.modal.footer.createPrError",defaultMessage:"Failed to create PR",description:"Error message for failed to create PR"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_failed_to_create_pr"})}},ge=()=>{if(!(r!=null&&r.id))return;const y=x?"?mode=".concat(x):"";de.current=window.open("/codex/tasks/".concat(n,"/turns/").concat(r.id,"/pr").concat(y),"_blank")},ee=!!Ge();return t.jsxs("div",{className:"border-b-token-border-default flex w-full justify-between gap-2 border-b p-3 transition-colors duration-50",children:[t.jsxs("div",{className:"flex min-w-0 flex-shrink max-md:gap-2",children:[e?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"hover:bg-token-bg-tertiary group-radix-state-open:bg-token-bg-tertiary rounded-sm p-2 font-semibold",onClick:e,"aria-label":k.formatMessage({id:"wham.taskPageHeader.goBack",defaultMessage:"Go back to tasks"}),children:t.jsx(ha,{className:"icon-lg text-token-text-secondary"})}),t.jsx("div",{className:"bg-token-border-default my-auto ms-[11px] me-4 h-4 w-[1px] max-md:hidden"})]}):t.jsx("div",{className:"ms-3"}),t.jsx(vo,{title:d,assistantTurn:a})]}),t.jsxs("div",{className:"relative flex h-10 items-center gap-1.5",children:[!1,s&&(a==null?void 0:a.id)&&t.jsx(mo,{taskId:n}),W&&(ee?t.jsx(Ze,{icon:c!=null&&c.archived?lt:dt,onClick:()=>c!=null&&c.archived?se():ae(),disabled:ce,"aria-label":c!=null&&c.archived?k.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelUnarchive",defaultMessage:"Unarchive Task"}):k.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelArchive",defaultMessage:"Archive Task"})}):t.jsx(_e,{color:"ghost",icon:c!=null&&c.archived?lt:dt,loading:ce,onClick:()=>c!=null&&c.archived?se():ae(),"aria-label":c!=null&&c.archived?k.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelUnarchive",defaultMessage:"Unarchive Task"}):k.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelArchive",defaultMessage:"Archive Task"}),children:c!=null&&c.archived?t.jsx(j,{id:"wham.whamTaskPageHeader.unarchive",defaultMessage:"Unarchive"}):t.jsx(j,{id:"wham.whamTaskPageHeader.archive",defaultMessage:"Archive"})})),o&&(a==null?void 0:a.id)&&t.jsx(go,{taskId:n,turnId:a==null?void 0:a.id,isDisabled:!1,title:d!=null?d:""}),i==="write"&&!ee&&t.jsx(Ga,{taskId:n}),Q.length>0&&!q&&t.jsx(_o,{isCreatingPr:l,assistantTurn:r,copyApplyToClipboard:T,copyPatchToClipboard:S,createPr:N,navigateToCreatingPrPage:ge,canCreatePr:J,updateBranch:le?R:void 0,permissions:i,showOnlyViewPr:u}),!ee&&!u&&t.jsx(Ua,{})]})]})}function Mo({focusedAssistantTurn:a,showFullDiff:e,currentDiffTaskTurn:o}){if(!a)return[];const s=!e;if(ve(a,s).length>0)return Oe({assistantTurn:a,followUp:s});if(ve(a,!1).length>0)return Oe({assistantTurn:a,followUp:!1});if(ve(a,!0).length>0)return Oe({assistantTurn:a,followUp:!0});if(!o||o.id===a.id)return[];const n=ve(o,!1),c=ve(o,!0);if(n.length===0&&c.length===0)return[];const r=n.length===0&&c.length>0;return Oe({assistantTurn:o,followUp:r})}const gt=new Set,Po=vt(()=>_t(()=>import("./d61hyg0k34cvdg7r.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40])).then(a=>a.WhamTaskPageCodeDiffContent),{loading:()=>t.jsx("div",{className:"flex-1"})});function $o({turnId:a,permissions:e,confirmClose:o,setConfirmClose:s,handleClose:i,showForkButton:d,loadingTurnMapping:u,isSharedExampleTask:n=!1}){"use forget";var E,re,be;const{taskId:c,task:r,focusedAssistantTurn:l,pastTurns:m,canFollowUp:x,currentDiffTaskTurn:w}=De(),{comments:p,clearComments:h,setComments:k}=st(),_=me(),{data:v,isLoading:O}=Sa(),B=Qe(),[D,L]=g.useState(void 0),f=g.useMemo(()=>ve(l,!0).length>0,[l]),[M,G]=Xt(Jt.WhamShowFullDiff,!f,ga),P=g.useMemo(()=>Mo({focusedAssistantTurn:l,showFullDiff:M,currentDiffTaskTurn:w}),[l,M,w]),Q=g.useMemo(()=>l?l.output_items.filter(b=>b.type==="message").flatMap(b=>b.content).filter(b=>b.content_type==="image_asset_pointer_citation").map(b=>({content_type:"image_asset_pointer_citation",asset_pointer:b.asset_pointer,width:b.width,height:b.height,size_bytes:b.size_bytes})):[],[l]),V=(l==null?void 0:l.turn_status)==="failed",J=Q.length>0,q=P.length>0,Z=xt(m),te=r?(E=r.title)!=null?E:_.formatMessage({id:"wham.whamTaskPageContentLoaded.newTask",defaultMessage:"New Task"}):null,K=Se(),W=!!Ge(),H=W||(v==null?void 0:v.git_diff_mode)==="unified",he=Ue(),fe=Me(he,"3673716873");g.useEffect(()=>{const b=l==null?void 0:l.id;b&&!gt.has(b)&&(l==null?void 0:l.turn_status)==="completed"&&(gt.add(b),ue.markTurnViewed(c,b))},[l==null?void 0:l.id,c,l==null?void 0:l.turn_status]);const{mutate:le}=Pe({mutationFn:b=>ue.updateUserPreferences(b),onSuccess:async()=>{await Ia(B)},onError:()=>{K.danger({id:"wham.whamTaskPageContentLoaded.failedToUpdatePreferences",defaultMessage:"Failed to update preferences",description:"Failed to update preferences error message"},{toastId:"wham_task_page_content_loaded_failed_to_update_preferences"})}}),de=b=>{le({diffView:b?"unified":"split"})},ae=J?"preview":W?"chat":q?"diff":void 0,[oe,se]=g.useState(!1);!oe&&r&&(se(!0),L(ae));const A=l!=null&&l.turn_status?Ct(l==null?void 0:l.turn_status):null,ce=g.useRef(!1),T=g.useRef({}),S=(re=l==null?void 0:l.id)!=null?re:a,R=g.useCallback(b=>T.current[b],[]),N=g.useCallback((b,z)=>{T.current[b]=z},[]),ge=g.useMemo(()=>({versionKey:S,getOpenState:R,setOpenState:N}),[S,R,N]);g.useEffect(()=>{A===!1?ce.current=!0:A===!0&&ce.current&&q&&L("diff")},[A]);const ee=g.useMemo(()=>{var b,z,pe,xe;if(V&&(l!=null&&l.environment_id)&&(l!=null&&l.branch)){const Y=[...m].reverse().find(Ce=>Ce.type==="user"),X=(b=Y==null?void 0:Y.input_items.find(Ce=>Ce.type==="message"))==null?void 0:b.content.find(Ce=>Ce.content_type==="text"),we=X==null?void 0:X.text,ye=Y==null?void 0:Y.input_items.filter(Ce=>Ce.type==="comment"),Ee=((pe=(z=l==null?void 0:l.sibling_turn_ids)==null?void 0:z.length)!=null?pe:0)+1,Lt=ba((xe=Y==null?void 0:Y.input_items)!=null?xe:[]);return{environmentId:l==null?void 0:l.environment_id,branch:l==null?void 0:l.branch,previousTurnId:Y==null?void 0:Y.previous_turn_id,prompt:we!=null?we:"",comments:ye!=null?ye:[],bestOfN:Ee,attachments:Lt}}},[V,l,m]),{attemptIndex:ie,siblings:$}=g.useMemo(()=>{if(!l)return{attemptIndex:null,hasSiblingTurns:!1};const b=m.filter(pe=>{var xe;return Re(pe)&&!!((xe=pe.sibling_turn_ids)!=null&&xe.includes(l.id))}),z=b.findIndex(pe=>pe.id===l.id);return{attemptIndex:z===-1?null:z+1,siblings:b}},[l,m]),y=e==="write"?t.jsx(io,{turnId:(be=l==null?void 0:l.id)!=null?be:a,comments:p,clearComments:h,focusedAssistantTurn:l,lastTurn:Z,retry:ee,attemptIndex:ie,siblings:$!=null?$:[]}):null,I=t.jsx(Xa,{currentTab:D,permissions:e,onClickFile:()=>L("diff"),onTabChange:b=>L(b),showFullDiff:M,loadingTurnMapping:u,footer:y}),C=t.jsx(ct.Provider,{value:ge,children:t.jsx(Ta,{currentTab:D,setCurrentTab:b=>L(b),defaultTab:ae,isMobile:W,hasDiff:q,previewImages:Q,diffFiles:P,unifiedDiff:H,handleDiffModeChange:de,showFullDiff:M,setShowFullDiff:G,isPreferencesLoading:O,isSharedExampleTask:n,focusedAssistantTurn:l,leftContent:I})});return t.jsxs(t.Fragment,{children:[t.jsxs(kt.div,Ie(U({className:ke("relative flex size-full flex-1 flex-col items-center",W?"[--right-bg:var(--bg-primary)]":"[--right-bg:var(--bg-tertiary)] dark:[--right-bg:black]")},pa),{children:[t.jsx(jo,{title:te,focusedAssistantTurn:l,onClose:i?()=>i==null?void 0:i({force:!0}):void 0,permissions:e,shouldShowShare:fe&&e==="write",shouldShowFork:!!d,isSharedExampleTask:n}),t.jsx("div",{className:"bg-token-bg-primary flex min-h-0 w-full flex-1",children:!r||!oe?t.jsx(Zt,{}):W?C:t.jsx(ya,{leftContent:I,rightContent:n&&q?t.jsx("div",{className:"relative h-full w-full bg-[var(--right-bg)]",children:t.jsx(ct.Provider,{value:ge,children:t.jsx(Po,{diffFiles:P,unifiedDiff:H,enableComments:x,comments:p,setComments:k})})}):D?t.jsxs("div",{className:"relative h-full w-full bg-[var(--right-bg)]",children:[C,t.jsx(xa,{className:"absolute end-3 top-2.5",icon:t.jsx(At,{}),label:_.formatMessage({id:"wham.whamTaskPageContentLoaded.close",defaultMessage:"Close"}),onClick:()=>L(void 0)})]}):void 0})})]})),o&&s&&i&&t.jsx(ka,{setConfirmClose:s,handleClose:i})]})}function zo({taskId:a,task:e,currentUserTurn:o,currentAssistantTurn:s}){var l,m,x,w;const i=He(p=>p.addTurnToTaskMap),d=He(p=>p.getTurnsForTask),[u,n]=g.useState((m=(l=s==null?void 0:s.id)!=null?l:e==null?void 0:e.current_turn_id)!=null?m:null);g.useEffect(()=>{var p;a&&(s&&["pending","in_progress","failed"].includes(s.turn_status)?n(s.id):n((p=s==null?void 0:s.id)!=null?p:null),o&&i(a,o),s&&i(a,s))},[s,o,a,i]);const c=d(a!=null?a:"");let r=(w=(x=c==null?void 0:c.filter(p=>p.type==="assistant"))==null?void 0:x.find(p=>p.id===u))!=null?w:null;return r||(r=s),{focusedAssistantTurn:r,setFocusedAssistantTurnId:n}}function Yo({focusedAssistantTurn:a,pastTurns:e,currentDiffTaskTurnId:o}){if(!a)return null;if(Xe(a))return a;const s=So(e);if(o){const d=s.get(o);if(d&&Re(d)&&Xe(d))return d}let i=pt(a,s);for(;i;){const d=s.get(i);if(!d||!Re(d))return null;if(Xe(d))return d;i=pt(d,s)}return null}function Xe(a){return ve(a,!1).length>0||ve(a,!0).length>0}function So(a){const e=new Map;for(const o of a)e.set(o.id,o);return e}function pt(a,e){var s,i;const o=e.get((s=a.previous_turn_id)!=null?s:"");return o&&(i=o.previous_turn_id)!=null?i:null}export{Ko as T,Vo as W,De as a,zo as b,$o as c,Yo as g,st as u};
//# sourceMappingURL=on3o5me2wsmfitl8.js.map

var H=Object.defineProperty,V=Object.defineProperties;var X=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var T=(r,t,e)=>t in r?H(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,D=(r,t)=>{for(var e in t||(t={}))Z.call(t,e)&&T(r,e,t[e]);if(j)for(var e of j(t))J.call(t,e)&&T(r,e,t[e]);return r},_=(r,t)=>V(r,X(t));import{r as n,b as Q,ao as Y,j as f,M as U}from"./n75kuy1cx6f5mogg.js";import{at as O,bS as ee,bI as te,mm as I,B as N,dG as q,e as W,E as L,kW as re,P as ne,an as se}from"./ewse8exzafeu10ji.js";import{lG as $,lH as P,lI as z,ck as G}from"./ny10lj7zpuz89fvf.js";function k(r,t){return e=>{O.addAction("".concat(r,".").concat(t),e)}}function oe(r){return(t,e)=>{O.addError(t,_(D({},e),{name:r,status:"error"}))}}const S={recording:{start:k("whisper-recording","start"),cancel:k("whisper-recording","cancel"),submit:k("whisper-recording","submit")},transcription:{request:k("whisper-transcription","request"),transcriptDelivered:k("whisper-transcription","transcriptDelivered"),error:oe("whisper-transcription"),requestSuccess:k("whisper-transcription","requestSuccess")}};class ce{static async transcribe(t,e,b={}){const w=new FormData;w.append("file",t),e&&w.append("language",e);const m={durationMs:b.durationMs,language:e,fileSize:t.size},g=performance.now();return S.transcription.request(m),ee.post("".concat(te,"/transcribe"),w).then(o=>{const c=performance.now()-g;return S.transcription.requestSuccess(_(D({},m),{durationMs:c})),o}).catch(o=>{const c=performance.now()-g;throw S.transcription.error(o,_(D({},m),{durationMs:c})),o})}}const ae=48e3,ie=10,B=ae*ie,ue=4e3,le=10*60*1e3,v=r=>$.setState(t=>{t.status=r}),de=r=>{const t=n.useRef(r);t.current=r;const e=n.useRef(null),b=n.useRef([]),w=n.useRef(null),m=n.useRef(null),g=n.useRef(null),o=n.useRef(new Float32Array(0)),c=n.useRef(null),M=n.useRef(null),y=n.useRef(!1),i=n.useCallback(()=>{o.current=new Float32Array,t.current.onWaveformDataUpdate(void 0)},[]),x=n.useCallback(async(u,h)=>{var p;v("transcribing");try{let l;I()?l=new File([u],"whisper.mp3",{type:"audio/mpeg"}):l=new File([u],"whisper.".concat(u.type.split(/[\/;]/)[1]||"mp3"),{type:u.type});const a=await ce.transcribe(l,void 0,{durationMs:h});v("idle"),S.transcription.transcriptDelivered({durationMs:h,transcriptLength:a.text.length}),t.current.onSuccess(a.text,a.asset_pointer,a.asset_ttl,(p=a.asset_format)!=null?p:null),i()}catch(l){v("error"),S.transcription.error(l,{durationMs:h}),i()}},[i]),R=n.useCallback(u=>{var p,l,a,d,s;if(!y.current)return;y.current=!1,M.current!==null&&(clearTimeout(M.current),M.current=null);const h=c.current!=null?performance.now()-c.current:void 0;u&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,v("idle"),i(),S.recording.cancel({durationMs:h}),c.current=null),(p=e.current)==null||p.stop(),(l=e.current)==null||l.stream.getTracks().forEach(A=>A.stop()),e.current=null,(a=g.current)==null||a.disconnect(),g.current=null,(d=m.current)==null||d.disconnect(),m.current=null,(s=w.current)==null||s.close(),w.current=null,u||S.recording.submit({durationMs:h})},[i]),F=n.useCallback(()=>{i(),v("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:ue,channelCount:1}}).then(u=>{c.current=performance.now(),S.recording.start(),e.current=new MediaRecorder(u);const h=I();y.current=!0,h?(b.current=[],e.current.ondataavailable=d=>{d.data.size>0&&b.current.push(d.data)},e.current.onstop=async()=>{const d=new Blob(b.current,{type:"audio/mpeg-3"}),s=c.current!=null?performance.now()-c.current:void 0;await x(d,s)},e.current.start(1e3)):(e.current.ondataavailable=async d=>{const s=c.current!=null?performance.now()-c.current:void 0;await x(d.data,s)},e.current.start()),o.current=new Float32Array(B).fill(t.current.initialValue),t.current.onWaveformDataUpdate(o.current),v("recording"),M.current=window.setTimeout(()=>{R()},le);const p=new AudioContext;w.current=p;const l=p.createMediaStreamSource(u);m.current=l;const a=p.createScriptProcessor(2048,1,1);g.current=a,a.onaudioprocess=d=>{const s=d.inputBuffer.getChannelData(0);for(let C=0;C<s.length;C++)s[C]=Math.max(s[C],t.current.initialValue);const A=o.current,E=new Float32Array(A.length+s.length);if(E.set(A,0),E.set(s,A.length),E.length>B){const C=E.length-B;o.current=E.slice(C)}else o.current=E;t.current.onWaveformDataUpdate(o.current)},l.connect(a),a.connect(p.destination)}).catch(()=>{v("error"),i(),S.recording.cancel()})},[i,R,x]);return n.useEffect(()=>()=>{R(!0)},[R]),{startRecording:F,stopRecording:R}};function he({disabled:r=!1,initialValue:t,onSuccess:e,onWaveformDataUpdate:b,onExit:w,buttonClassName:m,visualTreatment:g}){const o=Q(),c=$(s=>s.status),M=n.useRef(!1),{startRecording:y,stopRecording:i}=de({onSuccess:e,onWaveformDataUpdate:b,initialValue:t}),x=Y();n.useEffect(()=>()=>{i()},[i]),n.useEffect(()=>{M.current||(y(),M.current=!0)},[y]),n.useEffect(()=>{x.state!=="idle"&&i()},[x.state,i]);const R=()=>{i(!0),w()},F=g==="codex"?f.jsx(N,{type:"button",color:"ghost",size:"small",onClick:R,icon:q,disabled:r||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},children:f.jsx(U,{id:"wham.whisperModeControls.cancel",defaultMessage:"Cancel"})}):f.jsx("div",{children:f.jsx("button",{"aria-label":o.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:R,disabled:r||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:W(g==="composer-btn"?"composer-btn":W(P,r?"opacity-30":z,m)),children:f.jsx(q,{"aria-label":o.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"icon",fontSize:"inherit"})})}),u=c==="transcribing",h=u?f.jsx(L,{}):f.jsx(G,{className:"icon-lg"}),p=u?o.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):o.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),l=()=>{ne.logEvent("Whisper on Web/Windows: Clicked to end dictation"),se.logEvent("chatgpt_composer_whisper_button_clicked_end"),i()},a=s=>{s.key==="Escape"&&re(s)&&(R(),s.preventDefault())},d=g==="codex"?f.jsx(N,{type:"button",color:"secondary",size:"small",disabled:r,icon:u?L:G,onClick:l,onKeyDown:a,ref:K,children:f.jsx(U,{id:"wham.whisperModeControls.done",defaultMessage:"Done"})}):f.jsx("div",{children:f.jsx("button",{type:"button","aria-label":p,disabled:r,className:g==="composer-btn"?"composer-btn":W(P,r?"opacity-30":z,m),onClick:l,onKeyDown:a,ref:K,children:h})});return f.jsxs("div",{className:"flex gap-x-1.5",children:[F,d]})}function K(r){r==null||r.focus()}export{he as WhisperModeControls};
//# sourceMappingURL=lbs87s0y0bqj2oiw.js.map

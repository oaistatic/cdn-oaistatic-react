import{dz as Ke,cN as Ze,aR as Ye,aF as ie,aA as W,f as qe,aV as Ve,f4 as He,c2 as ne,e as et,s as H,N as F,aS as Fe,ab as B,bR as tt,aa as nt,en as st,gZ as it,bb as ot,d$ as rt,a6 as be,hg as at,cs as ct,bd as Ce,cl as ut,be as dt,ca as lt,hh as ht,g$ as gt,ev as ke,g7 as Re,fL as ft,aL as mt,cd as pt,hi as wt}from"./eb6xg52mym6rhnsh.js";import{ao as yt,d as St,bd as vt,hX as Tt,x as _t,lL as xe,lM as bt,iF as Ct,lN as kt,iG as Rt,lO as xt,jg as Et,lP as At,lQ as Mt,lR as Pt,lS as Dt,lT as Kt,lU as qt,lV as Ht,jB as Ee,lW as Ft,lX as Lt,lY as It,lZ as Nt}from"./pduvb49qgyq1mqhk.js";import{r as p,a as zt,d as Ot}from"./cs2gapsc2bulabhw.js";import{d as L,P as I,D as Q,a as Le,T as ue,p as $t}from"./e95x0gs5di7mq1tw.js";const Ie=new L("transactionEventPlugin"),Ae="prosemirrorDispatchTransaction";function Me(n,e){const{eventTarget:t}=Ie.getState(n.state);return t.addEventListener(Ae,e),()=>{t.removeEventListener(Ae,e)}}function rn(n){return new I({key:Ie,state:{init(){return{eventTarget:n}},apply(e,t){return t}}})}const se=new L("customKeymapPlugin");function Ut(n,e){n.dispatch(n.state.tr.setMeta(se,{handlers:e}))}function an(n={handlers:{}}){return new I({key:se,state:{init(){return{...n}},apply(e,t){const s=e.getMeta(se);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const o=se.getState(e.state).handlers[t.key];return o?o(t):!1}}})}const cn=n=>n?{enabled:!!Ke(n,"463092697").value?.softmentionEnabled}:{enabled:!1};function Bt(){return{trackingKeywordsRegex:void 0,decorations:Q.empty,highlightedKeywords:new Set,matchedKeywords:new Set}}const Ne=({tr:n,regex:e,prevHighlightedKeywords:t,prevMatchedKeywords:s})=>{const o=[],i=new Set,r=new Set;return e?(n.doc.descendants((a,c)=>{if(!a.isText||!a.text)return;const u=a.text;for(const h of u.matchAll(e)){if(i.add(h[1]),!t.has(h[1])&&s.has(h[1]))continue;r.add(h[1]);const y=c+h.index,b=y+h[0].length;o.push(Le.inline(y,b,{class:"hint-pill"},{keyword:h[1]}))}}),{decorations:Q.create(n.doc,o),matchedKeywords:i,highlightedKeywords:r}):{decorations:Q.empty,matchedKeywords:i,highlightedKeywords:r}},Gt=(n,e)=>{const{state:t,dispatch:s}=e,o=t.tr,i=_.getState(t);if(i){const r=n.length>0?new RegExp(`\\b(${n.join("|")})\\b`,"gi"):void 0,{decorations:a,highlightedKeywords:c,matchedKeywords:u}=Ne({tr:o,regex:r,prevHighlightedKeywords:i.highlightedKeywords,prevMatchedKeywords:i.matchedKeywords});o.setMeta(_,{...i,trackingKeywordsRegex:r,decorations:a,highlightedKeywords:c,matchedKeywords:u})}s(o)},Qt=(n,e)=>{if(n.length===0)return;const{state:t,dispatch:s}=e,o=t.tr,i=_.getState(t);if(i){const r=i.decorations.remove(i.decorations.find(void 0,void 0,a=>a.keyword&&n.includes(a.keyword)));o.setMeta(_,{...i,decorations:r,highlightedKeywords:new Set([...i.highlightedKeywords].filter(a=>!n.includes(a)))})}s(o)},_=new L("keywordPlugin");function un(){return new I({key:_,state:{init(){return Bt()},apply(n,e){if(n.getMeta(_))return{...e,...n.getMeta(_)};if(!n.docChanged)return e;const{decorations:t,matchedKeywords:s,highlightedKeywords:o}=Ne({tr:n,regex:e.trackingKeywordsRegex,prevHighlightedKeywords:e.highlightedKeywords,prevMatchedKeywords:e.matchedKeywords});return{...e,decorations:t,highlightedKeywords:o,matchedKeywords:s}}},props:{decorations(n){const e=this.getState(n);return e?e.decorations:Q.empty}}})}const E=new L("menuSelectorPlugin");function Pe(n){n.dispatch(n.state.tr.setMeta(E,{active:!1,onMenuAction:void 0}))}function dn(n,e){n.dispatch(n.state.tr.setMeta(E,{active:!0,onMenuAction:e}))}function ln(n={submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[" "]}){return new I({key:E,state:{init(){return{...n,active:!1}},apply(e,t){const s=e.getMeta(E);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const s=E.getState(e.state);if(!s.active)return!1;if(!t.isComposing)return s.submitKeys.includes(t.key)?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),Pe(e),s.onMenuAction?.("submit")??!0):s.cancelKeys.includes(t.key)?(t.preventDefault(),s.onMenuAction?.("cancel"),Pe(e),!0):t.key==="ArrowUp"?(t.preventDefault(),s.onMenuAction?.("up"),!0):t.key==="ArrowDown"?(t.preventDefault(),s.onMenuAction?.("down"),!0):s.checkStrictMatchKeys.includes(t.key)&&s.onMenuAction?.("checkMatch")?(t.preventDefault(),!0):!1},handleDOMEvents:{blur:e=>{E.getState(e.state).onMenuAction?.("cancel")}}}})}const G=new L("placeholderPlugin");function hn(n){return new I({key:G,state:{init(){return{placeholder:n}},apply(e,t){return e.getMeta(G)?{placeholder:e.getMeta(G).placeholder}:t}},props:{decorations(e){const{doc:t}=e;if(t.childCount===1&&t.firstChild?.isTextblock&&t.firstChild.content.size===0){const o=[],{placeholder:i}=G.getState(e);return e.doc.descendants((r,a)=>{const c=Le.node(a,a+r.nodeSize,{class:"placeholder","data-placeholder":i});o.push(c)}),Q.create(t,o)}}}})}const oe="command_token",gn={group:"inline",inline:!0,atom:!0,content:"text*",attrs:{id:"",hint:""},selectable:!1,draggable:!1,toDOM:n=>["span",{"data-mention-id":n.attrs.id,"data-mention-hint":n.attrs.hint,class:"hint-pill"},n.attrs.hint],parseDOM:[{tag:"span[data-mention-id][data-mention-hint]",getAttrs:n=>{const e=n.getAttribute("data-mention-id"),t=n.getAttribute("data-mention-hint");return{id:e,hint:t}}}]};function ze(n,e){if(n.depth===0)return;const t=n.nodeBefore?.text?.match(/(?:^|\s)(\/(\w*))$/);if(t?.[1].length!==void 0){const s=n.pos-t[1].length,o=n.pos,i=s===e?.from;return{range:{from:s,to:o},queryText:t[2],isDismissed:i}}}const de=new L("systemHintPlugin");function Oe(n,e){return n.setMeta(de,e),n}function fn(n){const t=n.state.selection.$from,s=ze(t,void 0);n.dispatch(Oe(n.state.tr,{...re(),dismissedRange:s?.range}))}function re(){return{queryText:"",active:!1,range:void 0,dismissedRange:void 0}}function Wt(n,e,t,s,o){const i=n.state.tr;Oe(i,re());const r=t+" ",a=n.state.schema.nodes[oe].create({id:e,hint:r},n.state.schema.text(r));if(o===s){const c=i.doc.resolve(s).nodeAfter;if(c?.isText){const u=c?.textContent.match(new RegExp(`^(?:${t}) ?`));u&&(o=s+u[0].length)}}i.replaceWith(s,o,a),i.doc.descendants((c,u)=>{c.type.name===oe&&c!==a&&(s===1&&u===s+a.nodeSize||u===1&&s===u+c.nodeSize?i.delete(u,u+c.nodeSize):i.insertText(c.textContent,u,u+c.nodeSize))}),n.dispatch(i)}function jt(n){const e=n.state.tr;e.doc.descendants((t,s)=>{if(t.type.name===oe){const o=s+t.nodeSize;s===1&&e.doc.resolve(o).nodeAfter==null?e.delete(s,o):e.insertText(t.textContent,s,s+t.nodeSize)}}),e.steps.length>0&&n.dispatch(e)}function De(n){const{active:e,range:t,queryText:s,onHintMatch:o}=n;if(o)return o(!e||!t?void 0:{text:s,range:t})}function Jt(n){const e=[];return n.descendants(t=>{t.type.name===oe&&typeof t.attrs?.id=="string"&&e.push(t.attrs.id)}),e}function mn(){return new I({key:de,state:{init(){return re()},apply(n,e,t,s){const o=n.getMeta(de),i={...re(),...e,...o},r=n.selection;if(r.from!==r.to||s.doc.eq(t.doc))return De(i),i;const a=r.$from,c=ze(a,e.dismissedRange);return i.active=!!c&&!c.isDismissed,c&&(i.queryText=c.queryText,i.range=c.range,c.isDismissed&&(c.queryText===""&&e.queryText!==""?i.dismissedRange=void 0:i.dismissedRange=c.range)),De(i),i}}})}class Xt extends Ze{constructor(e){super(),this.view=e,this.subscribe("focus",()=>this._store.setState({isFocused:!0})),this.subscribe("blur",()=>this._store.setState({isFocused:!1}))}fileInputHandle=null;_store=Ye(e=>({isFocused:!1,autocompletions:[],showTaggingDropdown:!1,waveWidth:300,isInReasonMode:!1,rateLimitBannerFeature:null,setShowTaggingDropdown:t=>e({showTaggingDropdown:t})}));get store(){return this._store}_usedDictation=!1;_dictationEdited=!1;_dictationAssetPointer=null;_dictationAssetTTL=null;get usedDictation(){return this._usedDictation}set usedDictation(e){this._usedDictation=e}get dictationEdited(){return this._dictationEdited}set dictationEdited(e){this._dictationEdited=e}get dictationAssetPointer(){return this._dictationAssetPointer}set dictationAssetPointer(e){this._dictationAssetPointer=e}get dictationAssetTTL(){return this._dictationAssetTTL}set dictationAssetTTL(e){this._dictationAssetTTL=e}get element(){return this.view.dom}get document(){return this.view.dom.ownerDocument}isEmpty(){return this.view.state.doc.textContent.trim().length===0}isFocused(){return this.view.hasFocus()}trimLeadingText(e){const s=this.view.state.tr;let o=0;return s.doc.descendants((i,r)=>{if(i.isText&&i.text){if(typeof e=="string"&&i.text.startsWith(e))o=e.length;else if(e instanceof RegExp){const a=i.text.match(e);a?.index===0&&(o=a[0].length)}if(o){const a=i.text.substring(o).trimStart();o=i.text.length-a.length,s.delete(r,r+o)}}return!i.isLeaf}),o>0?(this.view.dispatch(s),!0):!1}replaceAll(e,t){const o=this.view.state.tr,i=[];o.doc.descendants((r,a)=>{!r.isText||r.text===void 0||i.push({node:r,pos:a})}),i.reverse(),i.forEach(({node:r,pos:a})=>{!r.isText||r.text===void 0||r.text.includes(e)&&o.insertText(r.text.replaceAll(e,t),a,a+r.text.length)}),this.view.dispatch(o)}appendText(e){this.view.dispatch(this.view.state.tr.insertText(e))}delete(e,t){this.view.dispatch(this.view.state.tr.delete(e,t))}focus(){this.view.hasFocus()||(this.view.focus(),this.view.dispatch(this.view.state.tr.setSelection(ue.atEnd(this.view.state.doc)).scrollIntoView()))}setText(e){const{tr:t,schema:s}=this.view.state,o=e?s.nodes.paragraph.create(null,s.text(e)):s.nodes.paragraph.create();this.view.dispatch(t.replaceWith(0,this.view.state.doc.content.size,o)),this.view.hasFocus()&&this.view.dispatch(this.view.state.tr.setSelection(ue.atEnd(this.view.state.doc)))}getContentLength(){return this.view.state.doc.content.size}getCurrentText(){return this.view.state.doc.textContent}hasMultipleLines(){let e=0;return this.view.state.doc.descendants(t=>{t.isBlock&&e++}),e>1}getContentToSend(){return $t(this.view)}resize(){}isReady(){return!!this.view.state.doc}setPlaceholder(e){this.view.dispatch(this.view.state.tr.setMeta(G,{placeholder:e}))}getSelectionStart(){return this.view.state.selection.ranges[0].$from.pos}setSelection(e,t){this.view.dispatch(this.view.state.tr.setSelection(ue.create(this.view.state.doc,e,t))),this.view.focus()}isMenuSelectorActive(){return E.getState(this.view.state).active}registerKeyHandlers(e){Ut(this.view,e)}registerFileInput(e){this.fileInputHandle=e}openFileDialog(){this.fileInputHandle?.openFileDialog()}acceptLegacyKeydown(){return!1}subscribe(e,t){if(e==="change"){const s=()=>{this.usedDictation&&(this._dictationEdited=!0),t(void 0)};return Me(this.view,s)}return this.view.dom?.addEventListener(e,t,{capture:!0}),()=>{this.view.dom?.removeEventListener(e,t,{capture:!0})}}useState(e){return p.useSyncExternalStore(t=>Me(this.view,t),()=>e(this),()=>e(this))}getSystemHint(){return Jt(this.view.state.tr.doc)[0]??null}getKeywords(){return[..._.getState(this.view.state)?.matchedKeywords??[]]}removeKeywordDecorations(e){e.length!==0&&Qt(e,this.view)}resetTrackingKeywords(e){Gt(e,this.view)}addSystemHint(e,t,s=1,o=1){Wt(this.view,e,t,s,o)}removeSystemHints(){jt(this.view)}canShowAutocompletion(){const e=this.getSystemHint();return e===ie.PictureV2||e===ie.Tatertot||!this.isMenuSelectorActive()&&!e}}const Zt=W({}),$e=W(void 0),Yt=W(void 0),le=W(0),he=W(0),pn=({serverThreadId:n,clientThreadId:e,getIsDisabled:t,composerController:s,currentModelId:o,account:i,onReset:r,onInfer:a,isInferEnabledForModel:c})=>{const[u,h]=p.useState(!1),y=qe(),b=Ke(y,"3519990784").value,j=Number(b?.inference_debounce_ms??200),A=Ve(y,"209963048")&&["gpt-4o","auto"].includes(o),N=He(),S=p.useRef(null),M=yt(({enableInferredJuice:d})=>d)||A||c,P=p.useRef(a);P.current=a;const C=p.useRef(0),k=p.useRef(0),J=ne(()=>Yt()),R=p.useCallback(St(d=>{if(t())return;et.logEventWithStatsig("chatgpt_web_autoswitch_infer_called","chatgpt_web_autoswitch_infer_called",{is_paid_user:i?.hasPaidSubscription()});const f=d.length,X=f<5?"<5":f<=10?"5-10":f<=20?"10-20":f<=50?"30-50":"50+";if(H.count(F.DEFAULT,"chatgpt_web_autoswitch_infer_called",{prompt_length:X,is_paid_user:i?.hasPaidSubscription()?"true":"false"}),A)return;const z=++C.current,Z=Date.now();h(Z);const ce=Fe(e),O=B.getCurrentNode(ce);tt.postAnonAware("/conversation/infer",{prompt:d,conversation_id:n??null,is_history_and_training_disabled:N,parent_message_id:O.message.id,auto_switcher_treatment_override:J},{additionalHeaders:{"x-conduit-token":S.current??""}}).then(T=>{if(S.current=T.conduit_token,t()||k.current>z||s.getContentToSend().content.length<d.length)return;k.current=z;const{effort_mode:$,debug_info:Y,request_id:V}=T;Y&&Zt.set(Y),V&&$e.set(V),le.set(D=>D+1),he.set(d.length),P.current($)}).finally(()=>{h(T=>T&&Z<T?T:!1)})},j),[t,n,J]),w=nt(e,d=>d?.modelId),v=p.useRef(void 0);return p.useEffect(()=>{if(!M||!(s instanceof Xt)){w&&w!==v.current&&(v.current=w);return}const d=()=>{const{content:f}=s.getContentToSend();t()||!M||(f?R(f):(S.current=null,r(),h(!1),++C.current,k.current=C.current))};return w&&w!==v.current&&(v.current=w,d()),s.subscribe("change",()=>{d()})},[M,t,s,R,a,r,n,N,w]),u!==!1};function wn(n){const e=qe(),t=zt(),s=st(),o=He(),i=it(),r=Ot(),a=vt(),c=Tt(n),u=c&&"gizmo"in c?c.gizmo?.gizmo.id:void 0,h=_t(u),y=u?h?xe.PROJECT:xe.GPT:void 0,b=bt(),j=ne(()=>$e()),ae=ne(()=>le()),A=ne(()=>he()),N=Ct(P=>P.threads[n]?.modelSelection),S=N?.type===kt.EFFORT_MODE?N.effortMode:void 0,{configurationMenuType:ge}=Rt(),M=ge!=="none";return p.useCallback(async function({requestedModelId:P,completionType:C=ct.Next,sourceEvent:k,eventSource:J,completionMetadata:R,extraStreamParams:w,parentMessageId:v,promptMessage:d,existingMessages:f,prependMessages:X,appendMessages:z,profiler:Z,skipNotification:ce}){const O=k?.timeStamp??performance.now(),T=J??(k?xt(k):"mouse"),$=new AbortController,Y=at(),V=ot(n),D=`request-${n}-${Y}`,g=Fe(n),{conduitToken:fe=null,prepareState:me="none",lastPrepareTimestamp:pe=null}=g??{},ee=P??g?.modelId??Et(rt(t)).id,we=B.findNode(g,l=>l.message.author.role===be.Assistant||l.message.author.role===be.Tool)==null,Ue=g?.continuingFromSharedConversationId!=null,Be=!!g?.continuingFromSharedPostId,ye=v?B.getNode(g,v):f?.[0]?B.getParentNode(g,f[0].id):B.getCurrentNode(g),Ge=ye.message.id??ye.id,Se=[...f??[],...X??[],...d?[d]:[],...z??[]],U=new At({clientRequestId:D,gizmoType:y,preflightTime:O});if(U.onUserMessages(Se),h&&we){const l=M?R?.systemHints:R?.systemHints?.filter(te=>te!==ie.Canvas&&te!==ie.PictureV2);Mt(e).set(te=>({...te,[n]:l??[]}))}const K=new Pt(e,D,t,g,n,v,X,d,z,C,ee,S??g?.effortMode,T,o,O,r,h,we,Ue,U,ce??!1,i,Be),Qe=Dt(n);Kt(n)?.value===Ce.REALTIME&&await Qe,ut.publish({kind:"requestCompletion"}),qt(n,{source:dt.CLIENT,value:Ce.STREAMING}),lt.addRequest(D,$,U),Ht.onCompletionRequestStarted(D),K.updateBeforeRequest();const We=performance.now(),x=[],q=ht()??(x.push("chatReq"),await gt());q.force_login&&a({authType:"login"});const je=Ee.getEnforcementTokenSync(q)??(x.push("turnstile"),await Ee.getEnforcementToken(q)),Je=ke.getEnforcementTokenSync(q)??(x.push("proofofwork"),await ke.getEnforcementToken(q));t.getQueriesData(Re)==null&&await t.ensureQueryData(Re);const ve=x.includes("chatReq")?"false":"true",Te=x.includes("turnstile")?"false":"true",_e=x.includes("proofofwork")?"false":"true";H.hist(F.DEFAULT,"chat_req_time",[{key:"wasChatReqSync",value:ve},{key:"wasTurnstileSync",value:Te},{key:"wasProofofworkSync",value:_e}],performance.now()-We),ft(mt(),{eventName:"chatgpt_web_completion_integrity_checks",value:x.length===0?"true":"false",metadata:{wasChatReqSync:ve,wasTurnstileSync:Te,wasProofofworkSync:_e}}),Ft()&&await Lt();const m=It();if(U.onCompletionStarted(C,ee),K.preflightTime=performance.now()-O,b&&pe!=null){const l=performance.now()-pe;l<=6e4&&H.hist(F.DEFAULT,"fast_conversation_last_prepare_to_convo_client",[{key:"model_id",value:ee},{key:"prepare_state",value:String(me)},{key:"has_conduit_token",value:fe!=null?"true":"false"}],l)}(S??g?.effortMode)&&(H.hist(F.DEFAULT,"chatgpt_web_autoswitcher_infer_calls_per_message",[],ae),le.set(0),A!==0&&d?H.hist(F.DEFAULT,"chatgpt_web_autoswitcher_prompt_length_difference",[],pt(d).length-A):H.count(F.DEFAULT,"chatgpt_web_autoswitcher_message_before_infer_completed"),he.set(0));const Xe=Nt(e,{conversationOrigin:g?.conversationOrigin??null,model:ee,completionType:C,prepareState:me,conduitToken:fe,threadId:V,effortMode:S??g?.effortMode??void 0,inferRequestId:j,continueFromSharedConversationId:g?.continuingFromSharedConversationId,continueFromSharedPostId:g?.continuingFromSharedPostId,forkFromSharedPost:g?.forkFromSharedPost,historyDisabled:o,isAnonModeEnabled:i,parentMessageId:Ge,messages:Se,chatReq:q,turnstileToken:je,proofToken:Je,completionMetadata:R,contextualInfo:{is_dark_mode:s,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window.innerHeight,page_width:window.innerWidth,pixel_ratio:window.devicePixelRatio,screen_height:window.screen.height,screen_width:window.screen.width},isOnboardingConversation:R?.isOnboardingConversation,forceParagen:m.forceParagen,forceParagenModel:m.forceParagen?m.forceParagenModel.value:void 0,forceRateLimit:m.forceRateLimit,resetRateLimits:m.resetRateLimits,recordRendering:m.recordRendering,disableSystemContentToggling:m.rebaseSystemMessageContent!=null,forceUseSearch:m.forceUseSearch??void 0,paragenStreamType:m.paragenStreamType,paragenCotSummaryDisplay:m.paragenCotSummaryDisplay,...b?{f_completion:!0}:{},...w},U,Z,$.signal,n);try{for await(const l of Xe)l.type==="connected"?K.handleStreamConnected(l):l.type!=="perf_stats"&&l.type!=="server_ste_metadata"&&K.handleResponse(l)}catch(l){wt(l)||$.signal.aborted?K.handleAbort(l):K.handleError(l)}},[n,t,y,h,e,S,o,r,b,j,s,M,a,ae,A,i])}export{Xt as P,oe as a,mn as b,an as c,rn as d,Oe as e,dn as f,cn as g,Pe as h,fn as i,pn as j,un as k,ln as m,hn as p,gn as s,Ae as t,wn as u};
//# sourceMappingURL=do5nmvaddt7ak8xi.js.map

import{r as t,f as L,af as N,j as R}from"./cs2gapsc2bulabhw.js";import{j0 as q,c0 as F,c1 as j,j1 as I}from"./pduvb49qgyq1mqhk.js";import{an as T,bR as P,bN as z,gU as B,c as D,e as $,aJ as G,L as O}from"./eb6xg52mym6rhnsh.js";import{u as U}from"./j4xydz7ji1z9xseb.js";function A(o,r){return e=>{T.addAction(`${o}.${r}`,e)}}function H(o){return(r,e)=>{T.addError(r,{...e,name:o,status:"error"})}}const m={recording:{start:A("whisper-recording","start"),cancel:A("whisper-recording","cancel"),submit:A("whisper-recording","submit")},transcription:{request:A("whisper-transcription","request"),transcriptDelivered:A("whisper-transcription","transcriptDelivered"),error:H("whisper-transcription"),requestSuccess:A("whisper-transcription","requestSuccess")}};class V{static async transcribe(r,e,w={}){const d=new FormData;d.append("file",r),e&&d.append("language",e);const u={durationMs:w.durationMs,language:e,fileSize:r.size},p=performance.now();return m.transcription.request(u),P.post(`${z}/transcribe`,d).then(n=>{const s=performance.now()-p;return m.transcription.requestSuccess({...u,durationMs:s}),n}).catch(n=>{const s=performance.now()-p;throw m.transcription.error(n,{...u,durationMs:s}),n})}}const X=48e3,J=10,W=X*J,Z=4e3,K=10*60*1e3,v=o=>U.setState(r=>{r.status=o}),Q=o=>{const r=t.useRef(o);r.current=o;const e=t.useRef(null),w=t.useRef([]),d=t.useRef(null),u=t.useRef(null),p=t.useRef(null),n=t.useRef(new Float32Array(0)),s=t.useRef(null),S=t.useRef(null),M=t.useRef(!1),c=t.useCallback(()=>{n.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),x=t.useCallback(async(i,l)=>{v("transcribing");try{let a;B()?a=new File([i],"whisper.mp3",{type:"audio/mpeg"}):a=new File([i],`whisper.${i.type.split(/[\/;]/)[1]||"mp3"}`,{type:i.type});const f=await V.transcribe(a,void 0,{durationMs:l});v("idle"),m.transcription.transcriptDelivered({durationMs:l,transcriptLength:f.text.length}),r.current.onSuccess(f.text,f.asset_pointer,f.asset_ttl),c()}catch(a){v("error"),m.transcription.error(a,{durationMs:l}),c()}},[c]),b=t.useCallback(i=>{if(!M.current)return;M.current=!1,S.current!==null&&(clearTimeout(S.current),S.current=null);const l=s.current!=null?performance.now()-s.current:void 0;i&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,v("idle"),c(),m.recording.cancel({durationMs:l}),s.current=null),e.current?.stop(),e.current?.stream.getTracks().forEach(a=>a.stop()),e.current=null,p.current?.disconnect(),p.current=null,u.current?.disconnect(),u.current=null,d.current?.close(),d.current=null,i||m.recording.submit({durationMs:l})},[c]),C=t.useCallback(()=>{c(),v("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:Z,channelCount:1}}).then(i=>{s.current=performance.now(),m.recording.start(),e.current=new MediaRecorder(i);const l=B();M.current=!0,l?(w.current=[],e.current.ondataavailable=h=>{h.data.size>0&&w.current.push(h.data)},e.current.onstop=async()=>{const h=new Blob(w.current,{type:"audio/mpeg-3"}),g=s.current!=null?performance.now()-s.current:void 0;await x(h,g)},e.current.start(1e3)):(e.current.ondataavailable=async h=>{const g=s.current!=null?performance.now()-s.current:void 0;await x(h.data,g)},e.current.start()),n.current=new Float32Array(W).fill(r.current.initialValue),r.current.onWaveformDataUpdate(n.current),v("recording"),S.current=window.setTimeout(()=>{b()},K);const a=new AudioContext;d.current=a;const f=a.createMediaStreamSource(i);u.current=f;const _=a.createScriptProcessor(2048,1,1);p.current=_,_.onaudioprocess=h=>{const g=h.inputBuffer.getChannelData(0);for(let y=0;y<g.length;y++)g[y]=Math.max(g[y],r.current.initialValue);const k=n.current,E=new Float32Array(k.length+g.length);if(E.set(k,0),E.set(g,k.length),E.length>W){const y=E.length-W;n.current=E.slice(y)}else n.current=E;r.current.onWaveformDataUpdate(n.current)},f.connect(_),_.connect(a.destination)}).catch(()=>{v("error"),c(),m.recording.cancel()})},[c,b,x]);return t.useEffect(()=>()=>{b(!0)},[b]),{startRecording:C,stopRecording:b}};function ne({disabled:o=!1,initialValue:r,onSuccess:e,onWaveformDataUpdate:w,onExit:d,buttonClassName:u,visualTreatment:p}){const n=L(),s=U(f=>f.status),S=t.useRef(!1),{startRecording:M,stopRecording:c}=Q({onSuccess:e,onWaveformDataUpdate:w,initialValue:r}),x=N();t.useEffect(()=>()=>{c()},[c]),t.useEffect(()=>{S.current||(M(),S.current=!0)},[M]),t.useEffect(()=>{x.state!=="idle"&&c()},[x.state,c]);const b=R.jsx("div",{children:R.jsx("button",{"aria-label":n.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:()=>{c(!0),d()},disabled:o||s==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:D(p==="composer-btn"?"composer-btn":D(F,o?"opacity-30":j,u)),children:R.jsx(q,{"aria-label":n.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"h-[18px] w-[18px]",fontSize:"inherit"})})}),C=s==="transcribing",i=C?R.jsx(O,{}):R.jsx(I,{className:"icon-lg"}),l=C?n.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):n.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),a=R.jsx("div",{children:R.jsx("button",{type:"button","aria-label":l,disabled:o,className:p==="composer-btn"?"composer-btn":D(F,o?"opacity-30":j,u),onClick:()=>{$.logEvent("Whisper on Web/Windows: Clicked to end dictation"),G.logEvent("chatgpt_composer_whisper_button_clicked_end"),c()},children:i})});return R.jsxs("div",{className:"flex gap-x-1.5",children:[b,a]})}export{ne as WhisperModeControls};
//# sourceMappingURL=shaq3471n38ji8c4.js.map

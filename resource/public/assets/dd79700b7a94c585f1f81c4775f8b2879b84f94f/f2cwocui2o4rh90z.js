import{r as M,c as A,j as I}from"./cs2gapsc2bulabhw.js";import{s as B,a as Q,g as $,t as J,m as X,p as Y,b as Z,k as ee,c as te,d as ne,P as se,u as re}from"./do5nmvaddt7ak8xi.js";import{c_ as ae,eN as oe,q as ie,f as le,h5 as pe,bb as ue,bQ as de,aa as ce,am as me,a9 as fe,aF as P,aS as ge,dj as he,ab as ve}from"./eb6xg52mym6rhnsh.js";import{P as we,d as K,M as Ce,e as U,g as Me,E as Se,h as Te,n as be,i as xe,j as Ee}from"./e95x0gs5di7mq1tw.js";import{k as H,g as Pe}from"./ggve90in2x9hqouv.js";import{ku as _,kv as ye,hK as ke,cK as Ie,jg as He,b6 as Oe,kw as De,b7 as Re,kx as Fe,ky as Ue,kz as je,kA as Ne,U as Ae,kB as Ke,i4 as _e,i3 as Ge,kC as Le,kD as Ve,eH as qe,kE as ze}from"./pduvb49qgyq1mqhk.js";const We=500;class g{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let a=this.items.length;for(;;a--)if(this.items.get(a-1).selection){--a;break}let s,r;t&&(s=this.remapping(a,this.items.length),r=s.maps.length);let o=e.tr,i,l,u=[],d=[];return this.items.forEach((p,c)=>{if(!p.step){s||(s=this.remapping(a,c+1),r=s.maps.length),r--,d.push(p);return}if(s){d.push(new h(p.map));let m=p.step.map(s.slice(r)),f;m&&o.maybeStep(m).doc&&(f=o.mapping.maps[o.mapping.maps.length-1],u.push(new h(f,void 0,void 0,u.length+d.length))),r--,f&&s.appendMap(f,r)}else o.maybeStep(p.step);if(p.selection)return i=s?p.selection.map(s.slice(r)):p.selection,l=new g(this.items.slice(0,a).append(d.reverse().concat(u)),this.eventCount-1),!1},this.items.length,0),{remaining:l,transform:o,selection:i}}addTransform(e,t,a,s){let r=[],o=this.eventCount,i=this.items,l=!s&&i.length?i.get(i.length-1):null;for(let d=0;d<e.steps.length;d++){let p=e.steps[d].invert(e.docs[d]),c=new h(e.mapping.maps[d],p,t),m;(m=l&&l.merge(c))&&(c=m,d?r.pop():i=i.slice(0,i.length-1)),r.push(c),t&&(o++,t=void 0),s||(l=c)}let u=o-a.depth;return u>Qe&&(i=Be(i,u),o-=u),new g(i.append(r),o)}remapping(e,t){let a=new Ce;return this.items.forEach((s,r)=>{let o=s.mirrorOffset!=null&&r-s.mirrorOffset>=e?a.maps.length-s.mirrorOffset:void 0;a.appendMap(s.map,o)},e,t),a}addMaps(e){return this.eventCount==0?this:new g(this.items.append(e.map(t=>new h(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let a=[],s=Math.max(0,this.items.length-t),r=e.mapping,o=e.steps.length,i=this.eventCount;this.items.forEach(c=>{c.selection&&i--},s);let l=t;this.items.forEach(c=>{let m=r.getMirror(--l);if(m==null)return;o=Math.min(o,m);let f=r.maps[m];if(c.step){let S=e.steps[m].invert(e.docs[m]),v=c.selection&&c.selection.map(r.slice(l+1,m));v&&i++,a.push(new h(f,S,v))}else a.push(new h(f))},s);let u=[];for(let c=t;c<o;c++)u.push(new h(r.maps[c]));let d=this.items.slice(0,s).append(u).append(a),p=new g(d,i);return p.emptyItemCount()>We&&(p=p.compress(this.items.length-a.length)),p}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),a=t.maps.length,s=[],r=0;return this.items.forEach((o,i)=>{if(i>=e)s.push(o),o.selection&&r++;else if(o.step){let l=o.step.map(t.slice(a)),u=l&&l.getMap();if(a--,u&&t.appendMap(u,a),l){let d=o.selection&&o.selection.map(t.slice(a));d&&r++;let p=new h(u.invert(),l,d),c,m=s.length-1;(c=s.length&&s[m].merge(p))?s[m]=c:s.push(p)}}else o.map&&a--},this.items.length,0),new g(_.from(s.reverse()),r)}}g.empty=new g(_.empty,0);function Be(n,e){let t;return n.forEach((a,s)=>{if(a.selection&&e--==0)return t=s,!1}),n.slice(t)}class h{constructor(e,t,a,s){this.map=e,this.step=t,this.selection=a,this.mirrorOffset=s}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new h(t.getMap().invert(),t,this.selection)}}}class w{constructor(e,t,a,s,r){this.done=e,this.undone=t,this.prevRanges=a,this.prevTime=s,this.prevComposition=r}}const Qe=20;function $e(n,e,t,a){let s=t.getMeta(C),r;if(s)return s.historyState;t.getMeta(Ye)&&(n=new w(n.done,n.undone,null,0,-1));let o=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(o&&o.getMeta(C))return o.getMeta(C).redo?new w(n.done.addTransform(t,void 0,a,x(e)),n.undone,j(t.mapping.maps),n.prevTime,n.prevComposition):new w(n.done,n.undone.addTransform(t,void 0,a,x(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(o&&o.getMeta("addToHistory")===!1)){let i=t.getMeta("composition"),l=n.prevTime==0||!o&&n.prevComposition!=i&&(n.prevTime<(t.time||0)-a.newGroupDelay||!Je(t,n.prevRanges)),u=o?y(n.prevRanges,t.mapping):j(t.mapping.maps);return new w(n.done.addTransform(t,l?e.selection.getBookmark():void 0,a,x(e)),g.empty,u,t.time,i??n.prevComposition)}else return(r=t.getMeta("rebased"))?new w(n.done.rebased(t,r),n.undone.rebased(t,r),y(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new w(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),y(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function Je(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((a,s)=>{for(let r=0;r<e.length;r+=2)a<=e[r+1]&&s>=e[r]&&(t=!0)}),t}function j(n){let e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((a,s,r,o)=>e.push(r,o));return e}function y(n,e){if(!n)return null;let t=[];for(let a=0;a<n.length;a+=2){let s=e.map(n[a],1),r=e.map(n[a+1],-1);s<=r&&t.push(s,r)}return t}function Xe(n,e,t){let a=x(e),s=C.get(e).spec.config,r=(t?n.undone:n.done).popEvent(e,a);if(!r)return null;let o=r.selection.resolve(r.transform.doc),i=(t?n.done:n.undone).addTransform(r.transform,e.selection.getBookmark(),s,a),l=new w(t?i:r.remaining,t?r.remaining:i,null,0,-1);return r.transform.setSelection(o).setMeta(C,{redo:t,historyState:l})}let k=!1,N=null;function x(n){let e=n.plugins;if(N!=e){k=!1,N=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){k=!0;break}}return k}const C=new K("history"),Ye=new K("closeHistory");function Ze(n={}){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new we({key:C,state:{init(){return new w(g.empty,g.empty,null,0,-1)},apply(e,t,a){return $e(t,a,e,n)}},config:n,props:{handleDOMEvents:{beforeinput(e,t){let a=t.inputType,s=a=="historyUndo"?L:a=="historyRedo"?O:null;return s?(t.preventDefault(),s(e.state,e.dispatch)):!1}}}})}function G(n,e){return(t,a)=>{let s=C.getState(t);if(!s||(n?s.undone:s.done).eventCount==0)return!1;if(a){let r=Xe(s,t,n);r&&a(e?r.scrollIntoView():r)}return!0}}const L=G(!1,!0),O=G(!0,!0);function et(){return H({"Shift-Enter":(n,e)=>U(n,e),Enter:(n,e)=>window.innerWidth>ye[ke.Medium]||ae||oe()?!1:U(n,e)})}const tt=["p",0],nt=["br"],st=new Me({nodes:{paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p",preserveWhitespace:"full"}],toDOM(){return tt}},text:{group:"inline"},hard_break:{inline:!0,group:"inline",selectable:!1,parseDOM:[{tag:"br"}],toDOM(){return nt}},[Q]:B,doc:{content:"block+"}},marks:{}});function rt(n=null,e){const t=new EventTarget,a=$(e).enabled,s=new Se(null,{state:Te.create({schema:st,plugins:[Ze(),X(),Y(""),Z(),...a?[ee()]:[],et(),H({"Mod-z":L,"Mod-y":O,"Mod-Shift-z":O}),te(),H(Ee),ne(t),Pe()]}),dispatchTransaction(r){const o=s.state.apply(r);s.updateState(o),r.docChanged&&t.dispatchEvent(new Event(J))},handlePaste(r,o){const i=o.clipboardData?.getData("text/plain");return i===void 0?!1:(o.defaultPrevented||xe(r,i),!0)},clipboardTextSerializer(r){return be(r.content).content}});return n!=null&&s.state.doc.textContent.trim().length===0&&s.dispatch(s.state.tr.insertText(n)),s}const D=M.createContext(null),at=n=>{"use forget";const e=A.c(8),{children:t,clientThreadId:a,ignoreParentComposerController:s}=n,r=s===void 0?!1:s,o=M.useContext(D),i=le();let l,u;e[0]!==a||e[1]!==o||e[2]!==i||e[3]!==r?(u=o&&!r?o:new se(rt(a?pe(ue(a))?.content??null:null,i)),e[0]=a,e[1]=o,e[2]=i,e[3]=r,e[4]=u):u=e[4],l=u;const d=l;let p;return e[5]!==t||e[6]!==d?(p=I.jsx(D.Provider,{value:d,children:t}),e[5]=t,e[6]=d,e[7]=p):p=e[7],p},ft=()=>{"use forget";const n=A.c(2),e=M.useContext(D);let t;return n[0]!==e?(t=ie(e),n[0]=e,n[1]=t):t=n[1],t};function V(){return{clientThreadId:"",isLoggedInUser:!1,focusedObject:null,currentModelId:"",isModelLoaded:!1,isEmbeddedInFocusedView:!1,isInstalledApp:!1,onNewThread:()=>{throw new Error("onNewThread not implemented")},onRequestCompletion:()=>{throw new Error("onRequestCompletion not implemented")},resetThread:()=>{throw new Error("resetThread not implemented")}}}const q=M.createContext(V());function ot(){try{return M.use(q)}catch{return V()}}function gt({children:n,clientThreadId:e,setClientThreadId:t,routeType:a,prefetchSearchPromises:s}){const{createNewThread:r,resetThread:o}=Ie({clientThreadId:e,setClientThreadId:t}),{data:i}=de(),l=He(i),u=ce(e,b=>b?.modelId),d=Oe(),p=l.id,c=u??p,m=De(),f=Re(),{isUnauthenticated:S}=me(),v=!S,T=re(e),E=M.useMemo(()=>({clientThreadId:e,currentModelId:c,isModelLoaded:!!u,isEmbeddedInFocusedView:d,isInstalledApp:m,isLoggedInUser:v,focusedObject:f,onNewThread:r,onRequestCompletion:T,resetThread:o,prefetchSearchPromises:s,routeType:a}),[e,c,u,d,m,v,f,r,T,o,s,a]);return I.jsx(q.Provider,{value:E,children:I.jsx(at,{clientThreadId:e,children:n})})}function ht(){const{store:n}=Fe(),e=Ue(),{clearSystemHintModeTrigger:t,getSystemHintModeTrigger:a}=je(),{value:s}=fe("1988730211"),r=!Ne.useDisabledGlobally(),{onRequestCompletion:o}=ot();return M.useCallback((i,l,u,d)=>{const p=n.getSharedProps();if(!p)return;const{clientThreadId:c,onResetState:m,conversationMode:f}=p;Ae.hideThreadHeader();const S=e.has(P.Search),v=S?a(P.Search):void 0,T=ge(c),{systemHints:E,extraStreamParams:b}=Ke(l)?{systemHints:[l.categoryId],extraStreamParams:l.modelOverride?{model:l.modelOverride}:{}}:s?_e(Array.from(e)):{systemHints:Array.from(e),extraStreamParams:{}};r&&(b.enableMessageFollowups=!0);const R=Ge(),F={is_starter_prompt:!0,suggestion_type:l.type,starter_prompt_id:"id"in l?l.id:void 0};R&&(F.__internal={search_settings:R});const z=he(Le(l),F);o({promptMessage:z,sourceEvent:i,extraStreamParams:b,completionMetadata:{suggestions:u,suggestion:l,suggestionIndex:d,conversationMode:f??T?.mode,systemHints:E,searchSource:v}});const W=ve.getCurrentNode(T).message.id;m(),Ve(l,d,c,W),qe()||ze(),v&&S&&t(P.Search)},[n,e,a,s,r,o,t])}export{at as C,gt as a,rt as b,D as c,ot as d,ht as e,ft as u};
//# sourceMappingURL=f2cwocui2o4rh90z.js.map

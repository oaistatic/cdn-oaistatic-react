const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/oxcdf5lnls24q75m.js","assets/eb6xg52mym6rhnsh.js","assets/cs2gapsc2bulabhw.js","assets/root-o1pc79my.css","assets/do5nmvaddt7ak8xi.js","assets/pduvb49qgyq1mqhk.js","assets/conversation-small-ggtqjiqs.css","assets/e95x0gs5di7mq1tw.js","assets/f2cwocui2o4rh90z.js","assets/ggve90in2x9hqouv.js","assets/nlj97v8clhezwsxr.js","assets/bzo48ft2wb6beuij.js","assets/fb2gj4fu6zbut62o.js","assets/kmvt5g0oz7ekj3ft.js","assets/otrhg4fwlde4g25l.js","assets/epqkr08njby1t19h.js","assets/c1w85nn5shpnb9e0.js","assets/7u88g4wa9fostszz.js","assets/codkr9xsn28rihk7.js","assets/h71lg9jejkufcc57.js","assets/l9t7qwwrq1pkwdh1.js","assets/ec6jcwftshefgs7y.js","assets/kn0lvqy8pfftaqm4.js","assets/evmyafqvn996a7fd.js","assets/f3ceh929le7g5gef.js"])))=>i.map(i=>d[i]);
import{c as F,F as ce,en as le,am as ue,an as q,dB as de,hm as ge,a9 as me,h as fe,O as pe,_ as he}from"./eb6xg52mym6rhnsh.js";import{j as n,a5 as W,f as $,r as a,a as xe,p as Me}from"./cs2gapsc2bulabhw.js";import{I as X,D as ve,a as te,u as Ie}from"./jkqdpka3582aq7je.js";import{nf as M,aJ as Re,am as _e,aN as O,al as we,aX as Ce,aM as be,ng as Se,nh as ke,aL as ye,i7 as je,jc as ae,je as Ne,ni as Ee,nj as Ge,nk as Ae}from"./pduvb49qgyq1mqhk.js";import{a as Te}from"./fmwxh0ltx5kcz6xh.js";import{I as Pe}from"./jkpqdvui6jfmbala.js";import{C as De}from"./dugtojg1blcdqewy.js";import"./od9e6kpswbmmrkkx.js";import"./j0zvljvurep0tkuq.js";import"./do5nmvaddt7ak8xi.js";import"./e95x0gs5di7mq1tw.js";import"./epqkr08njby1t19h.js";import"./evmyafqvn996a7fd.js";import"./f3ceh929le7g5gef.js";function Oe({title:e,description:t,shimmer:r}){return!e&&!t?null:n.jsxs("div",{className:"border-token-border-default my-2 max-w-[480px] min-w-72 rounded-2xl border p-6",children:[!!e&&n.jsx("p",{className:F("text-lg font-medium",r&&"loading-shimmer-pure-text-inverted",!!t&&"mb-1"),children:e}),!!t&&n.jsx("p",{children:t})]})}const ne=({children:e,isDimensionsUnknown:t})=>n.jsxs(W.div,{className:F(["relative max-w-[480px] rounded-2xl",t&&"aspect-square overflow-hidden"]),children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]}),Le=({cotMessages:e,visualPercentComplete:t,isInterrupted:r=!1,state:o})=>{const m=$().formatMessage({id:"imagegen.thinkingHeader.interrupted",defaultMessage:"Stopped creating image"}),s=o===M.Complete||t===1,f=a.useMemo(()=>{if(r)return m;if(!e)return;if(s)return e.complete;if(t){const d=Object.keys(e.generating);for(let u=0;u<d.length;u+=1){const l=parseFloat(d[u]);if(t<l)return e.generating[d[u]]}}else return e.thinking;return e.complete},[e,m,r,s,t]);return f&&n.jsx(Te,{latestHeadline:f,isComplete:s||r,isExpandDisabled:!0})},J=ce.div`invisible absolute top-3 flex gap-1 group-hover/paragen-image:visible z-2
  ${({$rightAlign:e})=>e?"end-3":"start-3"}
  ${({$alwaysVisible:e})=>e?"visible":""}`,ze=({imageUrl:e})=>{const[t,r]=a.useState(void 0),o=$(),i=Re(),m=a.useCallback(()=>{const s=new Date;return`${o.formatDate(s,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}.png`},[o]);return n.jsxs("div",{className:"group/paragen-image absolute inset-0 z-3",children:[n.jsxs(J,{$alwaysVisible:!0,children:[t!==!1&&n.jsx(X,{icon:_e,selected:t===!0,variant:"large",onClick:s=>{s.stopPropagation(),O.paragenImageRated({liked:!0,analyticsContext:i}),r(!0)}}),t!==!0&&n.jsx(X,{icon:we,selected:t===!1,variant:"large",onClick:s=>{s.stopPropagation(),O.paragenImageRated({liked:!1,analyticsContext:i}),r(!1)}})]}),n.jsx(J,{$alwaysVisible:!0,$rightAlign:!0,children:n.jsx(X,{icon:Ce,variant:"large",onClick:s=>{s.stopPropagation(),O.paragenDownload({analyticsContext:i}),be({url:e,fileName:m()})}})})]})};function se({withLottie:e}){const r=$().formatMessage({id:"imagegen.progressIndicator.ariaLabel",defaultMessage:"Generating image..."});return n.jsx("div",{className:"absolute start-0 top-0 flex h-full w-full items-center justify-center rounded-full","aria-label":r,children:n.jsx(De,{size:40,arcPercentage:.2,children:n.jsx(ve,{animate:e,matchTextColor:!0,className:"h-6 w-6"})})})}const re=300,Be=1.3,Z=.05,Ue=/blur\(([\d.]+)px\)/,He={duration:re/1e3,ease:"linear"};function Y(e,t,r){e.sort((s,f)=>s.lastSrcReceivedTime-f.lastSrcReceivedTime);const o=new Array(e.length).fill(0);for(let s=0;s<=e.length;s+=1){const f=s-1,d=s,u=e[f]?.availablePercentComplete??0,l=e[d]?.availablePercentComplete??1;if(t>=u&&t<=l&&u!==l){const p=(t-u)/(l-u);o[f]=1-p,o[d]=p}}const i=o[o.length-1],m=o[o.length-2];return i===1&&m===0&&(o[o.length-2]=.01),r&&t<=e[0]?.availablePercentComplete&&(o[0]=1),o}const Fe=({alt:e,src:t,availablePercentComplete:r,onAnimationUpdate:o,ignoreFirstChunk:i=!1,isTransparent:m=!1,dimensions:s,onError:f,unconstrainedWidth:d=!1})=>{const u=le(),l=a.useMemo(()=>`url(${u?Se:ke})`,[u]),[p,g]=a.useState(!1),[G,A]=a.useState(1e3),[j,C]=a.useState(r??0),[c,T]=a.useState(0),N=a.useRef(performance.now()),P=a.useRef(0),h=a.useRef([]),[_,k]=a.useState([0]),[E,L]=a.useState(!1),w=a.useRef(!1),b=a.useRef(null),D=j===1,v=r===1&&E,y=s?s.width/s.height:1;a.useEffect(()=>{!p&&r&&(g(!0),P.current=performance.now())},[p,r]),a.useEffect(()=>{const x=h.current[h.current.length-1]?.src;if(t&&t!==x){const S=h.current.findIndex(H=>H.availablePercentComplete===r);S!==-1?h.current[S]={src:t,availablePercentComplete:r??0,lastSrcReceivedTime:performance.now()}:h.current.push({src:t,availablePercentComplete:r??0,lastSrcReceivedTime:performance.now()}),k(Y(h.current,j,i))}},[t,j,i,r]);const B=a.useCallback(()=>{b.current&&r&&(A(v?re:(performance.now()-N.current)*Be),(!i||w.current||r>=Z)&&r!==1&&T(r),w.current=!0,N.current=performance.now())},[r,v,i]),z=a.useCallback(x=>{const S=parseFloat(x.height)/100;o?.(S),C(S),k(Y(h.current,parseFloat(x.height)/100,i))},[o,i]),R=a.useCallback(x=>{const S=x.filter.toString().match(Ue)?.[1]??"0",V=(16-parseFloat(S))/16,ie=1-c,Q=c+ie*V;o?.(Q),C(Q),k(Y(h.current,Q,i))},[i,c,o]);if(!p)return n.jsx(ne,{isDimensionsUnknown:!0,children:n.jsx(se,{withLottie:!0})});const U={duration:G/1e3,ease:"linear"},I=r!==1||!m;return n.jsxs("div",{className:F("relative z-0 cursor-pointer overflow-hidden",y<1?"max-w-[400px]":"max-w-[480px]",!D&&"pointer-events-none",!w.current&&"bg-token-main-surface-secondary",d&&"max-w-full"),"aria-label":e,style:{aspectRatio:y},children:[r&&r<Z&&n.jsx("div",{className:"absolute inset-0 z-3 w-full overflow-hidden",children:n.jsx("div",{className:"absolute start-[-150%] top-[-150%] h-[400%] w-[400%]",children:n.jsx("div",{className:"diagonal-sweep-gradient h-full w-full"})})}),n.jsxs(W.div,{className:"absolute start-0 end-0 top-0 z-2 w-full overflow-hidden transition-[mask] ease-linear",initial:v?!1:{height:"0%"},animate:D?{height:"100%"}:{height:`${c*100}%`},onUpdate:v?void 0:z,transition:v?{duration:0,ease:"linear"}:U,style:D?void 0:{mask:"linear-gradient(rgb(0,0,0) 0%, rgb(0,0,0) calc(100% - 24px), rgba(0,0,0,0) 100%)"},children:[t&&n.jsx("img",{ref:b,src:t,onLoad:B,onError:f,alt:e,className:"absolute top-0 z-1 w-full",style:{aspectRatio:y}}),m&&n.jsx("div",{className:"absolute inset-0 z-0 w-full overflow-hidden opacity-0 transition-opacity duration-300 group-hover/imagegen-image:opacity-100 group-focus/imagegen-image:opacity-100",children:n.jsx("div",{className:"absolute inset-0 bg-repeat",style:{backgroundImage:l,backgroundSize:"auto"}})})]}),n.jsx(W.div,{className:"relative z-1 w-full overflow-hidden",initial:{filter:"blur(16px)"},animate:v?{filter:"blur(0px)"}:void 0,transition:v?He:void 0,onUpdate:v?R:void 0,style:{aspectRatio:y},children:h.current.map((x,S)=>{const H=_[S],V=x.availablePercentComplete===1;return H!==0||V?n.jsx("img",{src:x.src,alt:e,style:{opacity:H,willChange:"opacity",aspectRatio:y},className:"absolute top-0 w-full",onLoad:V?()=>L(!0):void 0},x.src):null})}),n.jsx(W.div,{className:"absolute inset-0 z-0 scale-110 overflow-hidden blur-2xl",style:{aspectRatio:y},children:I&&h.current.filter((x,S)=>_[S]!==0).map(x=>n.jsx("img",{src:x.src,alt:e,className:"absolute top-0 w-full"},x.src))})]})},ee=2,oe=({pointer:e,altLabel:t,isEditorAvailable:r,onPercentageRendered:o,messageId:i,clientThreadId:m,serverThreadId:s,isMultiGen:f,onEditorClick:d})=>{const u=xe(),[l,p]=a.useState(void 0),g=a.useRef(void 0),G=e.metadata?.generation?.gen_id,A=e.metadata?.generation?.height??void 0,j=e.height,C=(A??0)/j,c=a.useRef({}),[T]=Me(),{isUnauthenticated:N}=ue(),[P,h]=a.useState(!1),_=a.useContext(te),k=e.width/e.height,E=ye({imageAssetPointer:e,serverThreadId:s}),w=a.useCallback((I=!1)=>{!I&&g.current===e.asset_pointer||(g.current=e.asset_pointer,je.fetch(u,{asset:e,conversationId:s,force:I,isUnauthenticated:N}).then(x=>{p(x)}).finally(()=>{g.current=void 0}))},[e,u,s,N,null]);a.useEffect(()=>{const I=e.asset_pointer!==l?.asset_pointer;(!l||I)&&w()},[l,e.asset_pointer,w]);const b=a.useMemo(()=>ae({pointer:l,conversationId:s,messageId:i,source:_?"paragen":"chat"}),[l,s,i,_]),D=a.useRef(C);a.useEffect(()=>{C===1&&D.current<1&&O.renderingComplete({analyticsContext:b})},[C,b]);const v=a.useCallback(()=>{l&&d?.({image:l,messageId:i,analyticsContext:b})},[l,i,d,b]),y=a.useMemo(()=>({width:e.width,height:e.height}),[e]),B=a.useCallback(()=>{const I=(c.current[e.asset_pointer]??0)+1;if(c.current[e.asset_pointer]=I,c.current[e.asset_pointer]>ee)return q.addAction("image-gen-asset-error",{name:"retries-exhausted",conversation_id:s,asset_pointer:e.asset_pointer,max_retries:ee});q.addAction("image-gen-asset-retry",{name:"retry-attempted",conversation_id:s,asset_pointer:e.asset_pointer,current_retry:I}),c.current[e.asset_pointer]=I,w(!0)},[e.asset_pointer,w,s]),z=a.useCallback(I=>{I===1&&h(!0),o?.(I)},[o]),R=l?.url,K=f?"rounded-lg":"rounded-2xl",U=E??R;return n.jsx(Ne.Provider,{value:b,children:n.jsxs("div",{className:F("group/imagegen-image relative overflow-hidden",k<1?"max-w-[400px]":"max-w-[480px]",K,_&&"max-w-full",i===T.get("image")&&"[view-transition-name:var(--vt-active-image)]"),id:`image-${i}`,style:{aspectRatio:k},onClick:r?v:void 0,tabIndex:0,children:[E&&n.jsx("img",{alt:t,className:"absolute inset-0 z-1 opacity-0",src:E}),n.jsx(Fe,{alt:t,src:R,availablePercentComplete:C,onAnimationUpdate:z,isEditorAvailable:r,ignoreFirstChunk:!0,isTransparent:e.metadata?.generation?.transparent_background,dimensions:y,onError:B,unconstrainedWidth:_},G),P&&(_?n.jsx(ze,{imageUrl:R??""}):n.jsx(Pe,{imageAssetPointer:R,imageUrl:U,onEditorClick:v,isEditorAvailable:r,messageId:i,clientThreadId:m,serverThreadId:s,shouldShowOverflow:E!==void 0}))]},G)})},$e=({pointersToRender:e,altLabel:t,isEditorAvailable:r,updatePercentageRendered:o,messageIds:i,clientThreadId:m,serverThreadId:s,handleEditorClick:f})=>{const d=a.useRef({}),u=a.useCallback(l=>p=>{d.current[l]=p;const g=Object.keys(d.current).length,G=Object.values(d.current).reduce((A,j)=>A+j,0);o?.(G/g)},[o]);return e.map((l,p)=>{const g=l.metadata?.generation?.gen_id;return n.jsx(oe,{pointer:l,altLabel:t,isEditorAvailable:r,onPercentageRendered:g?u(g):void 0,messageId:i[p],clientThreadId:m,serverThreadId:s,isMultiGen:!0,onEditorClick:f},g)})};function Ke(e){const t=e.find(s=>s.author.role==="tool"&&s.author.name===Ee&&s.content.content_type==="text"),[r,...o]=t?.content.content_type==="text"?t.content.parts:[],i=o.pop(),m=o.length;return r&&i&&o.length>0?{thinking:r,complete:i,generating:o.reduce((s,f,d)=>{const u=(d+1)/m;return s[u.toFixed(2)]=f,s},{})}:void 0}const Ve=e=>{const t=$(),{size:r="image",count:o=1}=e||{};return o>1?{thinking:t.formatMessage({id:"cdnmKo",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"aTbInH",defaultMessage:"Creating images. May take a moment."}),"0.67":t.formatMessage({id:"WRM3Yw",defaultMessage:"Creating images. May take a moment."}),"1.00":t.formatMessage({id:"8ZydRG",defaultMessage:"Creating images. May take a moment."})},complete:t.formatMessage({id:"XQ81dl",defaultMessage:"Images created"})}:r==="xlimage"?{thinking:t.formatMessage({id:"y7op2E",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"cdrDJH",defaultMessage:"Creating image. May take a moment."}),"0.67":t.formatMessage({id:"RP4bRn",defaultMessage:"Adding details"}),"1.00":t.formatMessage({id:"o36MSQ",defaultMessage:"Finishing touches"})},complete:t.formatMessage({id:"QsnnBN",defaultMessage:"Image created"})}:{thinking:t.formatMessage({id:"6c7+kN",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"DP6/8y",defaultMessage:"Creating image"}),"0.67":t.formatMessage({id:"k9y1TT",defaultMessage:"Creating image"}),"1.00":t.formatMessage({id:"GpR7v3",defaultMessage:"Creating image"})},complete:t.formatMessage({id:"l2Izz4",defaultMessage:"Image created"})}},We=pe(async()=>he(()=>import("./oxcdf5lnls24q75m.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24])).then(e=>e.ImageGenNewEditor)),Qe=[M.Empty,M.Errored],lt=({messages:e,clientThreadId:t,isLastTurnInConversation:r,disableClickThru:o=!1})=>{const i=de(t),m=$(),s=m.formatMessage({id:"imagegen.message.altLabel",defaultMessage:"Generated image"}),[f,d]=a.useState(!1),[u,l]=a.useState(null),{messageIds:p,imageAssetPointers:g}=a.useMemo(()=>Ge(e),[e]),G=g?.[0]?.metadata?.generation?.gen_size,A=Ve({size:G??"image",count:g?.length??1}),j=a.useMemo(()=>Ke(e)??A,[e,A]),C=e.find(R=>R.metadata?.image_gen_async),c=a.useMemo(()=>Ae(e,r),[e,r]),T=a.useRef(!1),N=a.useRef(!1),P=a.useRef(null),h=a.useMemo(()=>ae({pointer:g[0],conversationId:i,messageId:p[0],source:o?"paragen":"chat"}),[g,p,i,o]);a.useEffect(()=>{if(!T.current&&(c===M.Thinking||c===M.Generating))T.current=!0,P.current=performance.now();else if(T.current&&!N.current)if(c===M.Complete){const R=P.current?performance.now()-P.current:void 0;O.generationSuccess({analyticsContext:h,durationMs:R}),N.current=!0}else c===M.Errored&&(O.generationFailure({analyticsContext:h,errorReason:"assistant_error"}),N.current=!0)},[c,h]);const _=e[e.length-1],k=a.useMemo(()=>_&&ge(_),[_]),{value:E}=me("3058498100"),L=a.useMemo(()=>E?g:g.slice(0,1),[E,g]),w=L.length>1,b=Ie({clientThreadId:t})&&c===M.Complete,[D,v]=a.useState(0),[y,B]=a.useState(null),z=a.useCallback(({image:R,messageId:K,analyticsContext:U})=>{l(R),B(K),d(!0),O.editorClick({sourceOperation:R.metadata?.dalle?.edit_op??"none",analyticsContext:U})},[]);return Qe.includes(c)?null:n.jsxs(te.Provider,{value:o,children:[n.jsxs("div",{className:"flex flex-col",children:[c!==M.Unavailable&&c!==M.AsyncGenerating&&c!==M.AsyncHanging&&n.jsx("div",{className:"pb-3",children:n.jsx(Le,{cotMessages:j,visualPercentComplete:D,isInterrupted:k,state:c})}),c===M.Thinking&&!k&&n.jsx(ne,{isDimensionsUnknown:!0,children:n.jsx(se,{withLottie:!0})}),c===M.AsyncGenerating&&!C?.metadata?.is_visually_hidden_from_conversation&&n.jsx(Oe,{shimmer:!0,title:C?.metadata?.ui_card_title,description:C?.metadata?.ui_card_description}),(c===M.Generating||c===M.Complete)&&!k&&n.jsx("div",{className:F("grid pb-2",{"grid-cols-2 gap-2":w,"grid-cols-1":!w}),children:w?n.jsx($e,{pointersToRender:L,altLabel:s,isEditorAvailable:b,updatePercentageRendered:v,messageIds:p,clientThreadId:t,serverThreadId:i,handleEditorClick:z}):n.jsx(oe,{pointer:L[0],altLabel:s,isEditorAvailable:b,onPercentageRendered:v,messageId:p[0],clientThreadId:t,serverThreadId:i,onEditorClick:z})})]}),n.jsx(fe,{testId:"modal-image-gen-content",type:"success",size:"fullscreen",isOpen:f,onClose:()=>d(!1),title:m.formatMessage({id:"imagegen.message.contentModalTitle",defaultMessage:"Edit image"}),visuallyHiddenHeader:!0,className:"dark:bg-(--gray-800)",children:u&&n.jsx(We,{image:u,isLoadingNewImage:!1,clientThreadId:t,onClose:()=>d(!1),messageId:y??""})})]})};export{lt as ImageGenMessage};
//# sourceMappingURL=odxc11i523oo3x5r.js.map

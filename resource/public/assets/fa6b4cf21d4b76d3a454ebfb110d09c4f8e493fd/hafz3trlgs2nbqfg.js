import{e as I,j as a,ai as me,u as he,r,a8 as x,M,a9 as V}from"./ls1hkjm4csy89kc5.js";import{a as T,l as fe,cN as pe,P as N,as as U,at as P,dH as ge,db as k,z as X,D as xe,dE as Ce,m as ye,K as ve,B as K,H as we}from"./jfjoua4700kji9z3.js";import{u as Me}from"./epe2ts57f6uih0zz.js";import{dh as Te,lU as se,bK as je,L as Se,M as ke,jc as be,R as _e,lV as Ne,aJ as Ie,lW as Re}from"./hj6jep7mk4776vwc.js";import{C as c,a as Ee,b as Ae}from"./lh104zerb9ve2tyv.js";import{F as ae,l as Oe}from"./mqyx9svnjg4qfuxq.js";import{g as Fe,a as qe,b as Ue,i as Pe,c as ze,C as De,d as He,h as Le}from"./m9dr8qz6tq7kspod.js";import"./jhwen9m0dt0iy2gd.js";import"./ghefszvvbc0hzvcq.js";import"./b9iv65ef6it0bnl8.js";import"./h1em0bjkpkjv8ykw.js";import"./m3f31zjufq98h3xn.js";import"./jl53i4v1h82l6528.js";import"./gws83r0h557ixj4e.js";import"./lqfx7r9jl2q1tbdy.js";import"./r19pqfj3as87cukj.js";import"./dt7ksh4fvumz5f8p.js";import"./nh14du86kynnf5fc.js";import"./oe4qwwp6lvtt8c1x.js";import"./iwazw5q362siufqb.js";import"./gstsldttv6qa02ku.js";import"./pc2givv05uuq8g6l.js";import"./iijxhy0p5rwh7gyf.js";import"./nxur2fbfj63tq7sy.js";import"./ekgxdfqrb84ds7yx.js";const _=24,J=12,q=4,Be=5e3;function R(e,t,s){switch(t.type){case c.Thought:return t.thought.summary;case c.Recap:return t.content;case c.Search:return s?e.formatMessage({id:"+a5J9x",defaultMessage:"Searched the web"}):e.formatMessage({id:"GamH3R",defaultMessage:"Searching the web"});case c.CodeAnalysis:return s?e.formatMessage({id:"SGdXPO",defaultMessage:"Analyzed"}):e.formatMessage({id:"rEhiFx",defaultMessage:"Analyzing"});case c.ImageAnalysis:return s?e.formatMessage({id:"fjqIXj",defaultMessage:"Analyzed image"}):e.formatMessage({id:"D//PTx",defaultMessage:"Analyzing image"});case c.ComputerOutput:return}}function Ge(e){const t=new Set,s=new Set;for(const n of e)if(n.type===c.Search){for(const o of n.queries)t.add(o.q);for(const o of n.sources)s.add(o.domain)}return{queries:t.size,sources:s.size}}const We="_markdown_1frq2_10",Ye="_fade_1frq2_1",Qe={markdown:We,fade:Ye},Ve=({chunk:e,isExpanded:t,isComplete:s})=>{const n=I(),[o,m]=e.messages,f=Fe(o)!=null;return a.jsxs("div",{className:"flex w-full flex-col gap-2 text-sm",children:[t&&R(n,e,s),f&&a.jsxs("div",{children:[a.jsx(qe,{message:o,forceDarkMode:!0,FormattedText:ae,showActionBar:!1,codeRendererClassName:T("rounded-md max-h-[calc(clamp(20px,1/4*var(--thread-safe-area-height,100lvh),400px))] overflow-auto",m&&"rounded-b-none"),codeContainerClassName:"overflow-visible!"}),m&&a.jsx(Ue,{forceDarkMode:!0,wrapperClassName:"max-h-[calc(clamp(20px,1/8*var(--thread-safe-area-height,100lvh),200px))] w-full overflow-auto dark rounded-b-md",codeContainerClassName:"whitespace-pre-wrap",message:m,showLabel:!1})]})]})},Xe=({chunk:e,isExpanded:t,isComplete:s})=>{const n=I(),o=e.messages[1],m=me(),{isUnauthenticated:f}=fe(),p=o.metadata?.aggregate_result?.messages.find(Pe),g=p?.image_url&&Te(p.image_url),{data:l}=he(g?ze(g,f):{enabled:!1,queryKey:[]}),d=l?.status===pe.Success?l.download_url:void 0,{isSuccess:i}=se(d),[y]=r.useState(i);return a.jsxs("div",{className:"flex w-full flex-col gap-2 text-sm",children:[t&&R(n,e,s),a.jsxs("div",{className:"bg-token-bg-secondary relative flex h-[calc(clamp(150px,1/4*var(--thread-safe-area-height,100lvh),400px))] justify-center overflow-hidden rounded-md p-2",children:[d&&a.jsx(x.div,{initial:{opacity:y?.5:0,scale:1.1},animate:{opacity:i?.5:0,scale:s||m?1.1:[1.1,1.25,1.1]},transition:{opacity:{ease:"easeInOut"},scale:s?{type:"spring",stiffness:300,damping:20}:{duration:2.5,repeat:1/0,ease:"easeInOut"}},className:"absolute inset-0 bg-cover bg-center bg-no-repeat opacity-40 blur-lg filter",style:{backgroundImage:`url(${JSON.stringify(d)})`}}),a.jsx(x.div,{initial:{opacity:y?1:0},animate:{opacity:i?1:0},className:"relative *:m-0 *:h-full *:w-full *:rounded-md *:object-center *:shadow-lg",children:a.jsx(De,{isCoT:!0,message:o})})]})]})},Ke=4,Je=3,Ze=3,$e={hidden:{opacity:0},visible:{opacity:1}},Z={hidden:{opacity:0,x:-5},visible:{opacity:1,x:0}},et=({chunk:e,isExpanded:t,isComplete:s})=>{const{queries:n,sources:o}=e,m=I(),[f,p]=r.useState(s);return a.jsxs("div",{className:"flex min-w-0 flex-col gap-2 text-sm",children:[t&&R(m,e,s),a.jsxs("div",{className:"flex min-w-0 flex-col gap-1",children:[a.jsx($,{isComplete:s,items:n,max:Ze,getKey:g=>g.q,Item:tt,ShowMoreButton:nt,onAnimationComplete:()=>p(!0)}),a.jsx($,{isComplete:s,items:f?o:[],max:Ke,getKey:g=>g.entries[0].url,Item:st,ShowMoreButton:at})]})]})},$=({isComplete:e,items:t,max:s,getKey:n,Item:o,ShowMoreButton:m,onAnimationComplete:f})=>{const[p,g]=r.useState(!1),[l,d]=t.length>s?[t.slice(0,s-1),t.slice(s-1)]:[t];return a.jsxs(x.div,{className:"flex flex-wrap items-center gap-1",initial:e?"visible":"hidden",animate:"visible",transition:{duration:.25,staggerChildren:.1,delayChildren:.3},onAnimationComplete:f,children:[l.map(i=>a.jsx(x.div,{variants:$e,className:"flex max-w-full items-center",children:a.jsx(o,{item:i})},n(i))),p&&a.jsx(x.div,{className:"contents",initial:"hidden",animate:"visible",transition:{duration:.2,staggerChildren:.02},children:d?.map(i=>a.jsx(x.div,{variants:Z,className:"flex max-w-full items-center",children:a.jsx(o,{item:i})},n(i)))}),d&&a.jsx(x.div,{variants:Z,className:"flex items-center",children:a.jsx(m,{moreItems:d,isShowingMore:p,onClick:()=>g(i=>!i)})},"more")]})},tt=({item:e})=>a.jsxs(E,{componentType:"span",children:[a.jsx(je,{className:"-ms-1 h-3 w-3 shrink-0"}),a.jsx("span",{className:"overflow-hidden text-ellipsis whitespace-nowrap",children:e.q})]}),st=({item:e})=>{const t=e.entries[0],s=r.useMemo(()=>({url:t.url,title:t.title}),[t.url,t.title]);r.useEffect(()=>{N.logEventWithStatsig("link_action","link_action",{...s,action:"show"})},[s]);const n=()=>{N.logEventWithStatsig("link_action","link_action",{...s,action:"click"})};return a.jsxs(E,{componentType:Se,href:t.url,onClick:n,children:[a.jsx(ne,{url:t.url}),t.attribution??ke(t.url)]})},ne=({url:e,withBorder:t=!1})=>{const{isSuccess:s,isError:n}=se(be(e,32)),[o]=r.useState(s);return n?null:a.jsx(x.div,{initial:{opacity:o?1:0},animate:{opacity:s?1:0},className:T("bg-token-main-surface-primary -ms-3 box-content h-3 w-3 shrink-0 overflow-hidden rounded-full first:-ms-1",t&&"border-token-main-surface-secondary group-hover:border-token-text-primary dark:group-hover:border-token-text-primary border"),children:a.jsx(_e,{url:e,size:32,minSize:16,className:"m-0"})})},at=({moreItems:e,isShowingMore:t,onClick:s})=>a.jsx(E,{onClick:s,children:t?a.jsx(M,{id:"19fGXl",defaultMessage:"Show less"}):a.jsxs(a.Fragment,{children:[e.slice(0,Je).map((n,o)=>a.jsx(ne,{url:n.entries[0].url,withBorder:!0},o)),a.jsx(M,{id:"5ob5C8",defaultMessage:"{count} more",values:{count:e.length}})]})}),nt=({moreItems:e,isShowingMore:t,onClick:s})=>a.jsx(E,{onClick:s,children:t?a.jsx(M,{id:"0SWns2",defaultMessage:"Show less"}):a.jsx(M,{id:"PpZw7t",defaultMessage:"{count} more",values:{count:e.length}})}),E=({className:e,componentType:t="button",children:s,...n})=>a.jsx(t,{className:T(Oe,"group max-w-full gap-1",(n.href!=null||n.onClick!=null)&&"hover:bg-token-main-surface-primary-inverse hover:text-token-text-inverted dark:hover:bg-token-text-primary",e),...n,children:s});var oe=(e=>(e.STATIC="static",e.ENTER="enter",e.STAGE="stage",e))(oe||{});const ot=({isAnimationComplete:e=!1,isExpanded:t=!1,isLast:s=!1,index:n,chunk:o,onClick:m,onMeasure:f,onAnimationComplete:p,showBullet:g=!1})=>{const l=s||t,d=!s||e,i=d?"static":"stage",y=d?"static":"enter",v=r.useRef(null);v.current=()=>{p?.(n,"enter")},r.useEffect(()=>{if(y!=="enter")return;const C=setTimeout(()=>{U.count(P.COT_SUMMARIZER,"cot_chunk_timeout"),v.current?.()},Be);return()=>clearTimeout(C)},[y]);const b=y==="static",j=r.useRef(null);return ge(()=>Ne({axis:"height",target:j.current,onChange:({height:C})=>f(n,C)}),[]),a.jsx(x.div,{role:t?void 0:"button",variants:{static:{opacity:1,scale:1,position:"static",translateY:0},enter:{position:"static",translateY:0,scale:1,opacity:1},stage:{position:"absolute",translateY:-_,scale:.95,opacity:0}},initial:i,animate:y,exit:t?void 0:{opacity:0,pointerEvents:"none",position:"absolute",translateY:_,filter:"blur(8px)"},style:{zIndex:n},transition:e||y==="static"?{duration:0}:{type:"spring",bounce:.05},className:T("text-token-text-secondary start-0 end-0 top-0 flex origin-left",!l&&"pointer-events-none"),onAnimationComplete:C=>C!=="enter"&&p(n,C),onClick:m,ref:j,children:a.jsx(Ie,{onComplete:v.current,isDisabled:b,defaultDelayPerSegmentMs:20,children:g?a.jsxs("div",{className:"flex w-full items-start gap-2 overflow-clip",children:[a.jsxs("div",{className:"flex h-full w-4 shrink-0 flex-col items-center gap-2",children:[a.jsx("div",{className:"flex h-5 shrink-0 items-center justify-center",children:a.jsx(Ee,{chunk:o,size:"small"})}),!s&&a.jsx(x.div,{initial:{translateY:-_,opacity:0},animate:{translateY:0,opacity:1},className:"bg-token-border-medium h-full w-[1px] rounded-full"})]}),a.jsx(ee,{chunk:o,isExpanded:t,isComplete:d})]}):a.jsx(ee,{chunk:o,isExpanded:t,isComplete:d})})})},rt=r.memo(ot),ee=({chunk:e,isExpanded:t,isComplete:s})=>{switch(e.type){case c.Thought:return a.jsx(it,{content:e.thought.content});case c.Recap:return a.jsx("div",{className:"text-token-text-secondary text-sm",children:a.jsx(M,{id:"Eo2n2s",defaultMessage:"Done"})});case c.Search:return a.jsx(et,{chunk:e,isExpanded:t,isComplete:s});case c.CodeAnalysis:return a.jsx(Ve,{chunk:e,isExpanded:t,isComplete:s});case c.ImageAnalysis:return a.jsx(Xe,{chunk:e,isExpanded:t,isComplete:s});case c.ComputerOutput:return null}},it=({content:e})=>a.jsx(ae,{className:T(Qe.markdown,"text-token-text-secondary text-sm"),componentOverrides:{code:t=>a.jsx(He,{...t,wrapperClassName:"",showActionBar:!1})},children:e}),te=new WeakMap;function ct(e){const t=[];for(const s of e){let n=te.get(s);n||(n=lt(s),n&&te.set(s,n)),n&&t.push(...n)}return t}function lt(e){switch(e.type){case k.ReasoningRecap:{const t=e.messages[e.messages.length-1].content.content;return[{type:c.Recap,content:t}]}case k.StructuredThoughts:{const t=[];for(const s of e.messages){const{thoughts:n}=s.content;for(const o of n)!o.content&&!o.summary||t.push({type:c.Thought,thought:o})}return t}case k.CodeInterpreter:{const[t,s]=e.messages;if(t.author.role!==X.Assistant||s&&s.author.role!==X.Tool){xe.addError(new Error("[cot] out of order code tool messages"));break}return[{type:s!=null&&Le(s)?c.ImageAnalysis:c.CodeAnalysis,messages:e.messages}]}case k.CoTSearchTool:{const t={type:c.Search,queries:[],sources:[]};for(const s of e.messages)if(s.metadata?.search_queries?.length&&(t.queries=s.metadata.search_queries),s.metadata?.search_result_groups?.length)for(const n of s.metadata.search_result_groups)t?.sources?.some(o=>o.domain===n.domain)||t.sources?.push(n);return[t]}case k.n7jupd_c:{const t=[];for(const s of e.messages)t.push({type:c.ComputerOutput,messages:[s]});return t}}}const ut={duration:.3,ease:"easeInOut"},dt=.2,Ht=({isStreaming:e,messageGroups:t})=>{const s=r.useMemo(()=>ct(t),[t]);return a.jsx(mt,{isStreaming:e,chunks:s})},mt=({isStreaming:e,chunks:t})=>{const s=I(),n=Ce(ye(),"3133027893"),[o,m]=r.useState(!1),[f,p]=r.useState([]),g=r.useMemo(()=>Ge(t),[t]),l=!e,d=ve(t,u=>u.type!==c.Recap&&(n||!(e&&u===K(t)))),[i,y]=r.useState(e?-1:t.length),v=i===-1?void 0:t[i],b=i<d||i===d&&!e,j=e?d:t.length,C=ft(v),[z,D]=r.useState(!e||i<0),H=r.useRef(performance.now()),L=r.useRef(performance.now());r.useEffect(()=>{H.current=performance.now()},[i]),r.useEffect(()=>{L.current=performance.now()},[v]);const[B]=r.useState(e);r.useEffect(()=>{if(B&&b&&z){const u=performance.now(),h=Math.max(0,ht(v)-(u-H.current),C-(u-L.current));setTimeout(()=>{y(j),D(!1)},h)}},[B,b,z,C,v,j]);const w=l?t:t.slice(0,i+1),A=r.useMemo(()=>{const u=K(w);return l?u?.type===c.Recap?u:void 0:u?.type===c.Thought?we(w,h=>h.type===c.Thought&&h.thought.summary!=null&&h.thought.summary.length>0):u},[l,w]),G=[...w.entries()];let W=o?G:G.slice(-1);pt(i,l);const S=w.length>0&&t[0].type!==c.Recap,re=S&&(!l||o),Y=S&&!l&&!o,ie=Re(f)+(f.length-1)*J+2*q,ce=l?"auto":o?ie:(f[i]??0)+2*q,le=r.useCallback((u,h)=>{u===i&&h===oe.ENTER&&setTimeout(()=>{D(!0)},C)},[i,C]),O=r.useCallback((u,h)=>{m(u),U.count(P.COT_SUMMARIZER,u?"expand":"collapse",[{key:"is_streaming",value:String(e)},{key:"source",value:h}]),N.logEventWithStatsig(u?"CoT Expanded":"CoT Collapsed",u?"chatgpt_cot_expanded":"chatgpt_cot_collapsed",{is_streaming:String(e),source:h})},[e]),ue=r.useCallback(()=>{O(!0,"chunk")},[O]),de=r.useCallback((u,h)=>{p(F=>{const Q=[...F];return Q[u]=h,Q})},[]);return r.useEffect(()=>{l||i<0||N.logEventWithStatsig(o?"Streamed CoT Chunk Viewed":"Streamed CoT Chunk Ignored",o?"chatgpt_streamed_cot_chunk_viewed":"chatgpt_streamed_cot_chunk_ignored")},[i,l,o,e]),l&&!S?null:a.jsxs("div",{className:"relative my-1 min-h-6",children:[e&&(!S||Y)&&a.jsx("div",{className:"loading-shimmer text-token-text-secondary absolute top-0 select-none",children:a.jsx(M,{id:"hgnsat",defaultMessage:"Thinking"})}),S&&a.jsxs(x.div,{className:T("relative flex max-w-[calc(0.8*var(--thread-content-max-width,40rem))] origin-top-left flex-col gap-2 overflow-x-clip",Y&&"bg-token-main-surface-primary border-token-border-default mx-[calc(--spacing(-2)-1px)] -my-[1px] box-content rounded-2xl border bg-clip-padding px-5 py-4 @max-3xl:-top-2 @3xl:-start-3 @3xl:-top-4"),initial:e&&{opacity:0,scale:.85},animate:{opacity:1,scale:1},transition:{ease:"easeOut",duration:dt},children:[a.jsx(Ae,{latestHeadline:A&&R(s,A,l),latestChunk:A,counters:g,onToggleExpanded:()=>O(!o,"header"),isExpanded:o,isExpandDisabled:w.length<2,isComplete:l}),a.jsx(V,{children:re&&a.jsx(x.div,{className:"relative z-0",initial:l?{opacity:0,height:0,overflowY:"hidden"}:!1,animate:{opacity:1,height:ce},exit:{height:0,opacity:0,pointerEvents:"none",overflowY:"hidden",filter:l?"blur(8px)":void 0,translateY:-_},transition:ut,children:a.jsx("div",{className:"relative flex h-full flex-col",style:{gap:J,margin:`${q}px 0`},children:a.jsx(V,{children:W.map(([u,h],F)=>a.jsx(rt,{index:u,chunk:h,isLast:W.length-1===F,onClick:ue,onAnimationComplete:le,onMeasure:de,isAnimationComplete:l,isExpanded:o,showBullet:o},u))})})})})]})]})};function ht(e){return e?.type===c.Thought?Math.min(3e3,1e3+e.thought.content.length*3.5):1200}function ft(e){return e?.type===c.Thought?500:0}function pt(e,t){const s=r.useRef(null),n=Me(e),o=r.useCallback(()=>{if(s.current!=null){const m=performance.now()-s.current;U.hist(P.COT_SUMMARIZER,"cot_chunk_display_time",void 0,m)}},[n]);r.useEffect(()=>{if(t){o();return}e!==-1&&(o(),s.current=performance.now())},[e,t,o])}export{Ht as CoT,mt as CoTChunks};
//# sourceMappingURL=hafz3trlgs2nbqfg.js.map

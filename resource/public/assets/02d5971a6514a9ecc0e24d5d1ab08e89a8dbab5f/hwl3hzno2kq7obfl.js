import{cz as Ge,c5 as Be,bg as te,bi as G,g as Ae,f1 as Qe,r as We,cy as Pe,bE as V,an as Je,bG as A,bH as P,bQ as qe,ax as $,b as je,bo as Ye,e8 as Ze,gK as Xe,am as Ve,dJ as et,bW as be,gR as tt,cd as nt,bS as st,aB as it,aC as ot,bU as at,gS as rt,gM as ct,ew as Te,fV as Ce,f3 as ut,bY as lt,j as dt,gT as ht,ao as ft}from"./i3bl95k8z8nuf4dv.js";import{aA as gt,d as mt,bK as pt,db as St,M as vt,m4 as Re,iC as wt,m5 as yt,i9 as _t,m6 as bt,ia as Tt,m7 as Ct,jw as Rt,m8 as xt,m9 as Et,ma as kt,mb as Dt,aZ as Mt,mc as At,k_ as xe,md as Pt,me as qt,mf as Ht,mg as Ft}from"./idf4u2jy0wx0pvap.js";import{r as S,a as It,d as Lt}from"./msupklk377u8vx8o.js";import{a as B,P as Q,D as Nt,b as Kt,T as ue,p as zt}from"./hmii3551qscelikg.js";const He=new B("transactionEventPlugin"),Ee="prosemirrorDispatchTransaction";function ke(n,e){const{eventTarget:t}=He.getState(n.state);return t.addEventListener(Ee,e),()=>{t.removeEventListener(Ee,e)}}function Vt(n){return new Q({key:He,state:{init(){return{eventTarget:n}},apply(e,t){return t}}})}const ee=new B("customKeymapPlugin");function Ot(n,e){n.dispatch(n.state.tr.setMeta(ee,{handlers:e}))}function en(n={handlers:{}}){return new Q({key:ee,state:{init(){return{...n}},apply(e,t){const s=e.getMeta(ee);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const i=ee.getState(e.state).handlers[t.key];return i?i(t):!1}}})}const b=new B("menuSelectorPlugin");function De(n){n.dispatch(n.state.tr.setMeta(b,{active:!1,onMenuAction:void 0}))}function tn(n,e){n.dispatch(n.state.tr.setMeta(b,{active:!0,onMenuAction:e}))}function nn(n={submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[" "]}){return new Q({key:b,state:{init(){return{...n,active:!1}},apply(e,t){const s=e.getMeta(b);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const s=b.getState(e.state);if(!s.active)return!1;if(!t.isComposing)return s.submitKeys.includes(t.key)?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),De(e),s.onMenuAction?.("submit")??!0):s.cancelKeys.includes(t.key)?(t.preventDefault(),s.onMenuAction?.("cancel"),De(e),!0):t.key==="ArrowUp"?(t.preventDefault(),s.onMenuAction?.("up"),!0):t.key==="ArrowDown"?(t.preventDefault(),s.onMenuAction?.("down"),!0):s.checkStrictMatchKeys.includes(t.key)&&s.onMenuAction?.("checkMatch")?(t.preventDefault(),!0):!1},handleDOMEvents:{blur:e=>{b.getState(e.state).onMenuAction?.("cancel")}}}})}const U=new B("placeholderPlugin");function sn(n){return new Q({key:U,state:{init(){return{placeholder:n}},apply(e,t){return e.getMeta(U)?{placeholder:e.getMeta(U).placeholder}:t}},props:{decorations(e){const{doc:t}=e;if(t.childCount===1&&t.firstChild?.isTextblock&&t.firstChild.content.size===0){const i=[],{placeholder:o}=U.getState(e);return e.doc.descendants((a,c)=>{const r=Nt.node(c,c+a.nodeSize,{class:"placeholder","data-placeholder":o});i.push(r)}),Kt.create(t,i)}}}})}const ne="command_token",on={group:"inline",inline:!0,atom:!0,content:"text*",attrs:{id:"",hint:""},selectable:!1,draggable:!1,toDOM:n=>["span",{"data-mention-id":n.attrs.id,"data-mention-hint":n.attrs.hint,class:"hint-pill"},n.attrs.hint],parseDOM:[{tag:"span[data-mention-id][data-mention-hint]",getAttrs:n=>{const e=n.getAttribute("data-mention-id"),t=n.getAttribute("data-mention-hint");return{id:e,hint:t}}}]};function Fe(n,e){if(n.depth===0)return;const t=n.nodeBefore?.text?.match(/(?:^|\s)(\/(\w*))$/);if(t?.[1].length!==void 0){const s=n.pos-t[1].length,i=n.pos,o=s===e?.from;return{range:{from:s,to:i},queryText:t[2],isDismissed:o}}}const le=new B("systemHintPlugin");function Ie(n,e){return n.setMeta(le,e),n}function an(n){const t=n.state.selection.$from,s=Fe(t,void 0);n.dispatch(Ie(n.state.tr,{...se(),dismissedRange:s?.range}))}function se(){return{queryText:"",active:!1,range:void 0,dismissedRange:void 0}}function $t(n,e,t,s,i){const o=n.state.tr;Ie(o,se());const a=t+" ",c=n.state.schema.nodes[ne].create({id:e,hint:a},n.state.schema.text(a));if(i===s){const r=o.doc.resolve(s).nodeAfter;if(r?.isText){const l=r?.textContent.match(new RegExp(`^(?:${t}) ?`));l&&(i=s+l[0].length)}}o.replaceWith(s,i,c),o.doc.descendants((r,l)=>{r.type.name===ne&&r!==c&&(s===1&&l===s+c.nodeSize||l===1&&s===l+r.nodeSize?o.delete(l,l+r.nodeSize):o.insertText(r.textContent,l,l+r.nodeSize))}),n.dispatch(o)}function Ut(n){const e=n.state.tr;e.doc.descendants((t,s)=>{if(t.type.name===ne){const i=s+t.nodeSize;s===1&&e.doc.resolve(i).nodeAfter==null?e.delete(s,i):e.insertText(t.textContent,s,s+t.nodeSize)}}),e.steps.length>0&&n.dispatch(e)}function Me(n){const{active:e,range:t,queryText:s,onHintMatch:i}=n;if(i)return i(!e||!t?void 0:{text:s,range:t})}function Gt(n){const e=[];return n.descendants(t=>{t.type.name===ne&&typeof t.attrs?.id=="string"&&e.push(t.attrs.id)}),e}function rn(){return new Q({key:le,state:{init(){return se()},apply(n,e,t,s){const i=n.getMeta(le),o={...se(),...e,...i},a=n.selection;if(a.from!==a.to||s.doc.eq(t.doc))return Me(o),o;const c=a.$from,r=Fe(c,e.dismissedRange);return o.active=!!r&&!r.isDismissed,r&&(o.queryText=r.queryText,o.range=r.range,r.isDismissed&&(r.queryText===""&&e.queryText!==""?o.dismissedRange=void 0:o.dismissedRange=r.range)),Me(o),o}}})}class Bt extends Ge{constructor(e){super(),this.view=e,this.subscribe("focus",()=>this._store.setState({isFocused:!0})),this.subscribe("blur",()=>this._store.setState({isFocused:!1}))}fileInputHandle=null;_store=Be(e=>({isFocused:!1,autocompletions:[],showTaggingDropdown:!1,waveWidth:300,isInReasonMode:!1,rateLimitBannerFeature:null,setShowTaggingDropdown:t=>e({showTaggingDropdown:t})}));get store(){return this._store}_usedDictation=!1;get usedDictation(){return this._usedDictation}set usedDictation(e){this._usedDictation=e}get element(){return this.view.dom}get document(){return this.view.dom.ownerDocument}isEmpty(){return this.view.state.doc.textContent.trim().length===0}isFocused(){return this.view.hasFocus()}trimLeadingText(e){const s=this.view.state.tr;let i=0;return s.doc.descendants((o,a)=>{if(o.isText&&o.text){if(typeof e=="string"&&o.text.startsWith(e))i=e.length;else if(e instanceof RegExp){const c=o.text.match(e);c?.index===0&&(i=c[0].length)}if(i){const c=o.text.substring(i).trimStart();i=o.text.length-c.length,s.delete(a,a+i)}}return!o.isLeaf}),i>0?(this.view.dispatch(s),!0):!1}replaceAll(e,t){const i=this.view.state.tr,o=[];i.doc.descendants((a,c)=>{!a.isText||a.text===void 0||o.push({node:a,pos:c})}),o.reverse(),o.forEach(({node:a,pos:c})=>{!a.isText||a.text===void 0||a.text.includes(e)&&i.insertText(a.text.replaceAll(e,t),c,c+a.text.length)}),this.view.dispatch(i)}appendText(e){this.view.dispatch(this.view.state.tr.insertText(e))}delete(e,t){this.view.dispatch(this.view.state.tr.delete(e,t))}focus(){this.view.hasFocus()||(this.view.focus(),this.view.dispatch(this.view.state.tr.setSelection(ue.atEnd(this.view.state.doc)).scrollIntoView()))}setText(e){const{tr:t,schema:s}=this.view.state,i=e?s.nodes.paragraph.create(null,s.text(e)):s.nodes.paragraph.create();this.view.dispatch(t.replaceWith(0,this.view.state.doc.content.size,i)),this.view.hasFocus()&&this.view.dispatch(this.view.state.tr.setSelection(ue.atEnd(this.view.state.doc)))}getContentLength(){return this.view.state.doc.content.size}getCurrentText(){return this.view.state.doc.textContent}hasMultipleLines(){let e=0;return this.view.state.doc.descendants(t=>{t.isBlock&&e++}),e>1}getContentToSend(){return zt(this.view)}resize(){}isReady(){return!!this.view.state.doc}setPlaceholder(e){this.view.dispatch(this.view.state.tr.setMeta(U,{placeholder:e}))}getSelectionStart(){return this.view.state.selection.ranges[0].$from.pos}setSelection(e,t){this.view.dispatch(this.view.state.tr.setSelection(ue.create(this.view.state.doc,e,t))),this.view.focus()}isMenuSelectorActive(){return b.getState(this.view.state).active}registerKeyHandlers(e){Ot(this.view,e)}registerFileInput(e){this.fileInputHandle=e}openFileDialog(){this.fileInputHandle?.openFileDialog()}acceptLegacyKeydown(){return!1}subscribe(e,t){if(e==="change"){const s=()=>t(void 0);return ke(this.view,s)}return this.view.dom?.addEventListener(e,t,{capture:!0}),()=>{this.view.dom?.removeEventListener(e,t,{capture:!0})}}useState(e){return S.useSyncExternalStore(t=>ke(this.view,t),()=>e(this),()=>e(this))}getSystemHint(){return Gt(this.view.state.tr.doc)[0]??null}addSystemHint(e,t,s=1,i=1){$t(this.view,e,t,s,i)}removeSystemHints(){Ut(this.view)}canShowAutocompletion(){const e=this.getSystemHint();return e===te.PictureV2||e===te.Tatertot||!this.isMenuSelectorActive()&&!e}}const Qt=G({}),Le=G(void 0),Wt=G(void 0),de=G(0),he=G(0),cn=({serverThreadId:n,clientThreadId:e,getIsDisabled:t,composerController:s,currentModelId:i,account:o,onReset:a,onInfer:c,isInferEnabledForModel:r})=>{const[l,v]=S.useState(!1),q=Ae(),W=Qe(q,"3519990784").value,T=Number(W?.inference_debounce_ms??200),H=We(q,"209963048")&&["gpt-4o","auto"].includes(i),C=Pe(),R=S.useRef(null),I=gt(({enableInferredJuice:d})=>d)||H||r,L=S.useRef(c);L.current=c;const w=S.useRef(0),y=S.useRef(0),x=V(()=>Wt()),J=S.useCallback(mt(d=>{if(t())return;Je.logEventWithStatsig("chatgpt_web_autoswitch_infer_called","chatgpt_web_autoswitch_infer_called",{is_paid_user:o?.hasPaidSubscription()});const h=d.length,N=h<5?"<5":h<=10?"5-10":h<=20?"10-20":h<=50?"30-50":"50+";if(A.count(P.DEFAULT,"chatgpt_web_autoswitch_infer_called",{prompt_length:N,is_paid_user:o?.hasPaidSubscription()?"true":"false"}),H)return;const K=++w.current,z=Date.now();v(z);const oe=qe(e),ae=$.getCurrentNode(oe);je.postAnonAware("/conversation/infer",{prompt:d,conversation_id:n??null,is_history_and_training_disabled:C,parent_message_id:ae.message.id,auto_switcher_treatment_override:x},{additionalHeaders:{"x-conduit-token":R.current??""}}).then(m=>{if(R.current=m.conduit_token,t()||y.current>K||s.getContentToSend().content.length<d.length)return;y.current=K;const{effort_mode:re,debug_info:k,request_id:j}=m;k&&Qt.set(k),j&&Le.set(j),de.set(ce=>ce+1),he.set(d.length),L.current(re)}).finally(()=>{v(m=>m&&z<m?m:!1)})},T),[t,n,x]),g=Ye(e,d=>d?.modelId),E=S.useRef(void 0);return S.useEffect(()=>{if(!I||!(s instanceof Bt)){g&&g!==E.current&&(E.current=g);return}const d=()=>{const{content:h}=s.getContentToSend();t()||!I||(h?J(h):(R.current=null,a(),v(!1),++w.current,y.current=w.current))};return g&&g!==E.current&&(E.current=g,d()),s.subscribe("change",()=>{d()})},[I,t,s,J,c,a,n,C,g]),l!==!1};function un(n){const e=Ae(),t=It(),s=Ze(),i=Pe(),o=Xe(),a=Lt(),c=pt(),r=St(n),l=r&&"gizmo"in r?r.gizmo?.gizmo.id:void 0,v=vt(l),q=l?v?Re.PROJECT:Re.GPT:void 0,W=wt(n),T=yt(),ie=V(()=>Le()),H=V(()=>de()),C=V(()=>he()),R=_t(w=>w.threads[n]?.modelSelection),F=R?.type===bt.EFFORT_MODE?R.effortMode:void 0,{configurationMenuType:I}=Tt(),L=I!=="none";return S.useCallback(async function({requestedModelId:w,completionType:y=nt.Next,sourceEvent:x,eventSource:J,completionMetadata:g,extraStreamParams:E,parentMessageId:d,promptMessage:h,existingMessages:N,prependMessages:K,appendMessages:z,profiler:oe,skipNotification:ae}){const m=x?.timeStamp??performance.now(),re=J??(x?Ct(x):"mouse"),k=new AbortController,j=tt(),ce=Ve(n),Y=`request-${n}-${j}`,f=qe(n),{conduitToken:fe=null,prepareState:ge="none",lastPrepareTimestamp:me=null}=f??{},Z=w??f?.modelId??Rt(et(t)).id,pe=$.findNode(f,u=>u.message.author.role===be.Assistant||u.message.author.role===be.Tool)==null,Ne=f?.continuingFromSharedConversationId!=null,Se=d?$.getNode(f,d):N?.[0]?$.getParentNode(f,N[0].id):$.getCurrentNode(f),Ke=Se.message.id??Se.id,ve=[...N??[],...K??[],...h?[h]:[],...z??[]],O=new xt({clientRequestId:Y,gizmoType:q,preflightTime:m});if(O.onUserMessages(ve),v&&pe){const u=L?g?.systemHints:g?.systemHints?.filter(X=>X!==te.Canvas&&X!==te.PictureV2);Et(e).set(X=>({...X,[n]:u??[]}))}const D=new kt(e,Y,t,f,n,d,K,h,z,y,Z,F??f?.effortMode,re,i,m,a,v,pe,Ne,O,ae??!1,o);Dt(n),st.publish({kind:"requestCompletion"}),Mt(n,{source:ot.CLIENT,value:it.STREAMING}),at.addRequest(Y,k,O),At.onCompletionRequestStarted(Y),D.updateBeforeRequest();const ze=performance.now(),_=[],M=rt()??(_.push("chatReq"),await ct());M.force_login&&c({authType:"login"});const Oe=xe.getEnforcementTokenSync(M)??(_.push("turnstile"),await xe.getEnforcementToken(M)),$e=Te.getEnforcementTokenSync(M)??(_.push("proofofwork"),await Te.getEnforcementToken(M));t.getQueriesData(Ce)==null&&await t.ensureQueryData(Ce);const we=_.includes("chatReq")?"false":"true",ye=_.includes("turnstile")?"false":"true",_e=_.includes("proofofwork")?"false":"true";A.hist(P.DEFAULT,"chat_req_time",[{key:"wasChatReqSync",value:we},{key:"wasTurnstileSync",value:ye},{key:"wasProofofworkSync",value:_e}],performance.now()-ze),ut(ft(),{eventName:"chatgpt_web_completion_integrity_checks",value:_.length===0?"true":"false",metadata:{wasChatReqSync:we,wasTurnstileSync:ye,wasProofofworkSync:_e}}),Pt()&&await qt();const p=Ht();if(O.onCompletionStarted(y,Z),D.preflightTime=performance.now()-m,T&&me!=null){const u=performance.now()-me;u<=6e4&&A.hist(P.DEFAULT,"fast_conversation_last_prepare_to_convo_client",[{key:"model_id",value:Z},{key:"prepare_state",value:String(ge)},{key:"has_conduit_token",value:fe!=null?"true":"false"}],u)}(F??f?.effortMode)&&(A.hist(P.DEFAULT,"chatgpt_web_autoswitcher_infer_calls_per_message",[],H),de.set(0),C!==0&&h?A.hist(P.DEFAULT,"chatgpt_web_autoswitcher_prompt_length_difference",[],lt(h).length-C):A.count(P.DEFAULT,"chatgpt_web_autoswitcher_message_before_infer_completed"),he.set(0));const Ue=Ft(e,{conversationOrigin:f?.conversationOrigin??null,model:Z,completionType:y,prepareState:ge,conduitToken:fe,threadId:ce,effortMode:F??f?.effortMode??void 0,inferRequestId:ie,continueFromSharedConversationId:f?.continuingFromSharedConversationId,historyDisabled:i,isAnonModeEnabled:o,parentMessageId:Ke,messages:ve,chatReq:M,turnstileToken:Oe,proofToken:$e,completionMetadata:g,contextualInfo:{is_dark_mode:s,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window.innerHeight,page_width:window.innerWidth,pixel_ratio:window.devicePixelRatio,screen_height:window.screen.height,screen_width:window.screen.width},isOnboardingConversation:g?.isOnboardingConversation??W,forceParagen:p.forceParagen,forceParagenModel:p.forceParagen?p.forceParagenModel.value:void 0,forceRateLimit:p.forceRateLimit,resetRateLimits:p.resetRateLimits,recordRendering:p.recordRendering,disableSystemContentToggling:p.rebaseSystemMessageContent!=null,forceUseSearch:p.forceUseSearch??void 0,paragenStreamType:p.paragenStreamType,paragenCotSummaryDisplay:p.paragenCotSummaryDisplay,...T?{f_completion:!0}:{},...!T&&dt(e).checkGate("3257646228")?{f_shadow_completion:!0}:{},...E},O,oe,k.signal,n);try{for await(const u of Ue)u.type==="connected"?D.handleStreamConnected(u):u.type!=="perf_stats"&&u.type!=="server_ste_metadata"&&D.handleResponse(u)}catch(u){ht(u)||k.signal.aborted?D.handleAbort(u):D.handleError(u)}},[n,t,q,v,e,F,i,a,T,ie,s,W,L,c,H,C,o])}export{Bt as P,ne as a,rn as b,en as c,Vt as d,Ie as e,tn as f,De as g,an as h,cn as i,nn as m,sn as p,on as s,Ee as t,un as u};
//# sourceMappingURL=hwl3hzno2kq7obfl.js.map

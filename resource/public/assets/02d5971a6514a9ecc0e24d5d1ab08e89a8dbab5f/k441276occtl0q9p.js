import{r as t,f as W,ag as T,j as l}from"./msupklk377u8vx8o.js";import{hP as D,d0 as B,d1 as _,dK as F}from"./idf4u2jy0wx0pvap.js";import{b as j,bf as I,gA as N,c as A,an as U,bR as P,bI as L}from"./i3bl95k8z8nuf4dv.js";import{u as k}from"./efv25d1ajdici77v.js";class G{static async transcribe(r,e){const i=new FormData;return i.append("file",r),e&&i.append("language",e),j.post(`${I}/transcribe`,i)}}const O=48e3,q=10,C=O*q,z=4e3,H=10*60*1e3,p=c=>k.setState(r=>{r.status=c}),V=c=>{const r=t.useRef(c);r.current=c;const e=t.useRef(null),i=t.useRef([]),w=t.useRef(null),g=t.useRef(null),m=t.useRef(null),n=t.useRef(new Float32Array(0)),d=t.useRef(null),a=t.useCallback(()=>{n.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),h=t.useCallback(async u=>{p("transcribing");try{const f=await G.transcribe(new File([u],"whisper.mp3",{type:"audio/mpeg-3"}));p("idle"),r.current.onSuccess(f.text),a()}catch{p("error"),a()}},[a]),s=t.useCallback(u=>{d.current!==null&&(clearTimeout(d.current),d.current=null),u&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,p("idle"),a()),e.current?.stop(),e.current?.stream.getTracks().forEach(f=>f.stop()),e.current=null,m.current?.disconnect(),m.current=null,g.current?.disconnect(),g.current=null,w.current?.close(),w.current=null},[a]),v=t.useCallback(()=>{a(),p("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:z,channelCount:1}}).then(u=>{e.current=new MediaRecorder(u),N()?(i.current=[],e.current.ondataavailable=o=>{o.data.size>0&&i.current.push(o.data)},e.current.onstop=async()=>{const o=new Blob(i.current,{type:"audio/mpeg-3"});await h(o)},e.current.start(1e3)):(e.current.ondataavailable=async o=>{await h(o.data)},e.current.start()),n.current=new Float32Array(C).fill(r.current.initialValue),r.current.onWaveformDataUpdate(n.current),p("recording"),d.current=window.setTimeout(()=>{s()},H);const b=new AudioContext;w.current=b;const y=b.createMediaStreamSource(u);g.current=y;const R=b.createScriptProcessor(2048,1,1);m.current=R,R.onaudioprocess=o=>{const M=o.inputBuffer.getChannelData(0);for(let x=0;x<M.length;x++)M[x]=Math.max(M[x],r.current.initialValue);const E=n.current,S=new Float32Array(E.length+M.length);if(S.set(E,0),S.set(M,E.length),S.length>C){const x=S.length-C;n.current=S.slice(x)}else n.current=S;r.current.onWaveformDataUpdate(n.current)},y.connect(R),R.connect(b.destination)}).catch(()=>{p("error"),a()})},[a,s,h]);return t.useEffect(()=>()=>{s(!0)},[s]),{startRecording:v,stopRecording:s}};function J({disabled:c=!1,initialValue:r,onSuccess:e,onWaveformDataUpdate:i,onExit:w,buttonClassName:g,visualTreatment:m}){const n=W(),d=k(o=>o.status),a=t.useRef(!1),{startRecording:h,stopRecording:s}=V({onSuccess:e,onWaveformDataUpdate:i,initialValue:r}),v=T();t.useEffect(()=>()=>{s()},[s]),t.useEffect(()=>{a.current||(h(),a.current=!0)},[h]),t.useEffect(()=>{v.state!=="idle"&&s()},[v.state,s]);const u=l.jsx("div",{children:l.jsx("button",{"aria-label":n.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:()=>{s(!0),w()},disabled:c||d==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:A(m==="composer-btn"?"composer-btn":A(B,c?"opacity-30":_,g)),children:l.jsx(D,{"aria-label":n.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"h-[18px] w-[18px]",fontSize:"inherit"})})}),f=d==="transcribing",b=f?l.jsx(L,{}):l.jsx(F,{className:"icon-lg"}),y=f?n.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):n.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),R=l.jsx("div",{children:l.jsx("button",{type:"button","aria-label":y,disabled:c,className:m==="composer-btn"?"composer-btn":A(B,c?"opacity-30":_,g),onClick:()=>{U.logEvent("Whisper on Web/Windows: Clicked to end dictation"),P.logEvent("chatgpt_composer_whisper_button_clicked_end"),s()},children:b})});return l.jsxs("div",{className:"flex gap-x-1.5",children:[u,R]})}export{J as WhisperModeControls};
//# sourceMappingURL=k441276occtl0q9p.js.map

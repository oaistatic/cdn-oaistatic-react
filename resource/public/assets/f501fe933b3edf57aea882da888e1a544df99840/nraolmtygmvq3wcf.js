import{dc as ge,aI as _e,R as Y,gh as me,b as p,gi as Z,gj as ee,gk as fe,gl as pe,D as Q,n as j,aC as he,gm as ve,P as te,a as oe,F as ne,cf as Te,eF as ye,bE as Se,gn as Ce,go as we,aL as Ee,s as Re,r as se,ap as w,a4 as ie,t as Ie,ao as ke,ak as Me,aj as Oe,aR as Ae,be as Ne,gp as be,gq as qe}from"./n26mv7rx7nquqst2.js";import{dV as le,dW as De,dX as xe,dY as re,dZ as ae,d_ as de,d$ as Pe,e0 as He,o as Fe,e1 as Le,e2 as We,e3 as Ue,e4 as Be,ay as Ve,e5 as $e,e6 as je,e7 as ze}from"./pceg3mlzf8dzw9ob.js";import{v as Je,a as Ke,r as Qe}from"./n1tvutderx19k1zs.js";import{T as Ge}from"./hexva2s1lo90zidg.js";const Xe="OAI-Echo-Logs",A={FOCUS_IN:0,FOCUS_OUT:1,COPY:2,PASTE:3,TOUCH_START:4,TOUCH_END:5},ue=[];function N(n){return()=>{ue.push({type:n,ts:Math.round(performance.now())})}}const Ye={focusin:N(A.FOCUS_IN),focusout:N(A.FOCUS_OUT),copy:N(A.COPY),paste:N(A.PASTE),touchstart:N(A.TOUCH_START),touchend:N(A.TOUCH_END)};function at(n){const e=n??document.getElementById(Ge);for(const[i,l]of Object.entries(Ye))e?.removeEventListener(i,l),e?.addEventListener(i,l)}function Ze(){return{[Xe]:ue.slice(0,10).map(n=>`${n.type},${n.ts}`).join(",")}}const et=1e3*30,W=le.getTracer("completion");class ce extends Error{}function tt(n,e,i,l,h){const g=new AbortController,E=h?De([h,g.signal]):g.signal,b="threadId"in e?e.threadId:void 0,q="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,R=Je(),v=e.model,z={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:b,continue_from_shared_conversation_id:b!=null?void 0:q,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:e.completionMetadata?.variantPurpose,suggestions:e.completionMetadata?.suggestions?e.completionMetadata.suggestions.map(o=>xe(o)):void 0,chosen_suggestion:e.completionMetadata?.suggestion?{type:e.completionMetadata.suggestion.type,index:e.completionMetadata.suggestionIndex,source:e.completionMetadata?.suggestion.type===re.Autocomplete?e.completionMetadata.suggestion.source:void 0,user_input:e.completionMetadata?.suggestion.type===re.Autocomplete?e.completionMetadata.suggestion.userInput:void 0}:void 0,history_and_training_disabled:e.historyDisabled,juice:e.completionMetadata?.juice,conversation_mode:e.completionMetadata?.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:R,source:e.completionMetadata?.source,system_hints:e.completionMetadata?.systemHints,prefetch_ids:e.completionMetadata?.prefetchIds,supports_buffering:!0,supported_encodings:[ae.V1],conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_reported_search_source:e.completionMetadata?.searchSource,client_contextual_info:e.contextualInfo,paragen_stream_type_override:e.paragenStreamType==="none"?null:e.paragenStreamType,paragen_cot_summary_display_override:e.paragenCotSummaryDisplay==="none"?null:e.paragenCotSummaryDisplay,is_onboarding_conversation:e.isOnboardingConversation},D=v.startsWith("o1")&&v.endsWith("o");let I,m;const k=ge(n);_e(k)?(m=window.location.origin+"/backend-anon",I=Y.getUnauthHeaders().additionalHeaders):(D?m=window.location.origin+"/backend-alt":m=window.location.origin+"/backend-api",I=Y.getAuthedHeadersWithAccessToken(k?.accessToken));const r=`${m}/conversation`,T=me(e.chatReq,e.turnstileToken,e.proofToken,null),J={...I,...Ze(),...T};let y=!1,U=!1,B=!1,V=!1,f,x,_,P,a;W.startActiveSpan("completion.response",o=>{f=W.startSpan("completion.first_response"),x=W.startSpan("completion.first_token_including_tool_calls"),_=W.startSpan("completion.first_token_including_visible_content"),P=W.startSpan("completion.first_token"),a=o});const G=le.setSpan(de.active(),a);let $=null,H=!1;function S(){H||(H=!0,i({type:"done"}))}function u(o){if(e.turnTracker.onBytesReceived(o.data),o.data==="[DONE]")g.abort(),a.end(),S();else if(o.event!=="ping")try{let t=JSON.parse(o.data);if(o.event==="delta_encoding")if(t===ae.V1)e.turnTracker.stream_encoding=t,$=new He;else{Q.addError(`[completion-delta] unknown delta encoding: ${t}`);return}else if(o.event==="delta"){if(!$){Q.addError("[completion-delta] delta event before delta_encoding");return}t=$.applyDelta(t)}if(t.error){const C=p.createWithErrorMessage(r,"server",t.error);throw i({type:"error",error:C}),C}else"type"in t?t.type==="gizmo_inline_review"?i({type:"gizmo_inline_review",gizmoId:t.gizmo_id}):t.type==="title_generation"?i({type:"title_generation",title:t.title,conversation_id:t.conversation_id}):t.type==="moderation"?i({type:"moderation",conversationId:t.conversation_id,messageId:t.message_id,isCompletion:t.is_completion,flagged:t.moderation_response.flagged,blocked:t.moderation_response.blocked,disclaimers:t.moderation_response.disclaimers,metadata:t.moderation_response.metadata}):t.type==="url_moderation"?i({type:"url_moderation",conversationId:t.conversation_id,messageId:t.message_id,url:t.url_moderation_result.full_url,isSafe:t.url_moderation_result.is_safe}):t.type==="num_variants_in_stream"?i({type:"num_variants_in_stream",num_variants_in_stream:t.num_variants_in_stream,display_treatment:t.display_treatment}):t.type==="conversation_detail_metadata"?i(t):t.type==="message_stream_complete"&&S():(i({type:"message",message:t.message,conversationId:t.conversation_id}),y||(y=!0,f.end()),!U&&t.message.author.role===j.Assistant&&(U=!0,x.end()),!B&&t.message.author.role===j.Assistant&&he(t.message)&&(B=!0,_.end()),!V&&t.message.author.role===j.Assistant&&ve(t.message)&&(V=!0,P.end()))}catch(t){if(t instanceof p)throw t}}let d=null,M=setTimeout(()=>{d===!0?(te.logEvent(oe.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:ne.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):d===!1&&(te.logEvent(oe.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:ne.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},et);de.with(G,()=>(e.profiler?.logTiming("fetch_event_source"),Pe(r,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...J},body:JSON.stringify(z),signal:E,openWhenHidden:!0,async onopen(o){const t=o.headers.get("content-type")??"",C=o.headers.get("Cf-Ray")??null;if(o.ok&&t.includes("text/event-stream")){d=!1,l(C,e.model,e.turnTracker);return}else if(t.includes("application/json")){const O=await o.json(),s=new p(r,o.status,O);if(s.isServerError())throw s;if((s?.code==="expired_session_key"||s?.code==="invalid_api_key"||s?.code==="token_expired")&&typeof window<"u"&&window._oaiHandleSessionExpired?.("stream",JSON.stringify(s)),s?.code==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}throw s}else{const O=await o.text();throw new p(r,o.status,{detail:{message:Z,code:"unexpected_content_type",contentType:t,text:O?.substring(0,1e3)}})}},onmessage:o=>{if(d)throw p.createWithErrorMessage(r,"server",Z);M&&(clearTimeout(M),M=null),u(o)},onerror(o){let t=o instanceof Error?o:new Error(JSON.stringify(o));throw t instanceof ce||d||(t.message==="Failed to fetch"&&(t=p.createWithErrorMessage(r,"server",`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${ee}`)),t.message==="network error"&&(t=p.createWithErrorMessage(r,"client",`A network error occurred. Please check your connection and try again. ${ee}`)),fe("fetch-error:conversation:new-message",{url:r,message:t?.message}),i({type:"error",error:t})),t}}))).catch(async o=>{o instanceof ce||(o instanceof p?pe(o):Q.addError(o),e.turnTracker.handleRawError(o.message??"Something went wrong",o.status))})}function dt({clientThreadId:n,onCreate:e=Ne}){const i=Ke(),l=Te(),h=ye(),g=Se(),E=Fe(),b=null;return Qe.useCallback(async function({model:q,completionType:R,parentNodeId:v,metadata:z,completionMetadata:D,extraStreamParams:I,prependMessages:m,appendMessages:k,turnTracker:r,profiler:T}){const J=performance.now();T?.logTiming("start_chat_requirements");const y=await Ce();T?.logTiming("fetched_chat_requirements"),y.force_login&&E({authType:"login"});const[U,B]=await Promise.all([Le.getEnforcementToken(y).then(s=>(T?.logTiming("fetched_turnstile_token"),s),s=>null),we.getEnforcementToken(y).then(s=>(T?.logTiming("fetched_p_token"),s),s=>null)]),V=performance.now()-J;Ee.publish({kind:"requestCompletion"});const f=Re.getTree(se(n));w.retainThread(n);const x=qe(),_=`${be}${n}-${x}`,P=`${n}-${x}`,a=f.getNodeByIdOrMessageId(v);f.getConversationTurns(v,b!=null).length>2&&w.updateScrollToMessageId(n,a.message.id);const H={gizmo_id:a.message.metadata?.gizmo_id};D?.juice!=null&&(H.snorkle_status=1),w.updateTree(n,s=>{s.addNode(_,"",v,j.Assistant,void 0,H)}),w.setThreadCurrentLeafId(n,_);let S,u=[],d=f.getNodeByIdOrMessageId(a.parentId);for(;d!=null&&(d.metadata?.isPlaceholderTemplateAssistantWelcomeMessage===!0||d.metadata?.isClientCreatedSystemMessage===!0);){const s=d.message;u.unshift(s);const c=f.getNodeByIdOrMessageId(d.parentId);S=c.message?.id??c.id,d=c}if(R===ie.Next||R===ie.Variant){const s=f.getNodeByIdOrMessageId(a.parentId);if(S??=s.message?.id??s.id,m){let c=a.parentId,F=a.id;w.updateTree(n,L=>{for(const K of m)L.insertNodeBefore(F,{id:K.id,message:K,parentId:c,children:[]}),c=K.id}),u.push(...m)}if(u.push(a.message),k){let c=v;w.updateTree(n,F=>{for(const L of k)F.insertNodeBefore(_,{id:L.id,message:L,parentId:c,children:[]}),c=L.id}),u.push(...k)}u=ot(u,I)}else S??=a.message.id;const M=Ie(n);M===void 0&&ke(n)&&w.updateInitialThreadDataForNewThread(n,q),r.updateAttachmentCount(u),We()&&await Ue();const X=new Be(i,n,_,R,q,z.eventSource,e,h,P,r,g),o=(s,c,F)=>{s&&F.onReceivedRequestId(s),je(P,c,s,V)},t={is_dark_mode:l,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window?.innerHeight,page_width:window?.innerWidth,pixel_ratio:window?.devicePixelRatio,screen_height:window?.screen?.height,screen_width:window?.screen?.width},C=se(n),O=new AbortController;tt(i,{conversationOrigin:C?.conversationOrigin??null,model:q,completionType:R,threadId:M,continueFromSharedConversationId:C?.continuingFromSharedConversationId,historyDisabled:g,parentMessageId:S,messages:u,chatReq:y,turnstileToken:U,proofToken:B,completionMetadata:D,...I,turnTracker:r,profiler:T,contextualInfo:t,isOnboardingConversation:D?.isOnboardingConversation},X.handleResponse,o,O.signal),Ve(n,{source:Me.CLIENT,value:Oe.STREAMING}),Ae.addRequest(_,O,r),$e.onCompletionRequestStarted(_)},[n,i,e,h,g,l,b,E])}const ot=(n,e)=>{let i=n;return e?.forceUseSearch===!1&&n.length>0&&(i=n.map(l=>{const{system_hints:h,...g}=l.metadata||{};return{...l,metadata:{...g,system_hints:h?.filter(E=>E!==ze.Search)}}})),i};export{at as t,dt as u};
//# sourceMappingURL=nraolmtygmvq3wcf.js.map

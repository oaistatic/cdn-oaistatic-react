const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ocbo82eisw0w775w.js","assets/m60bpb0x3x7rg8fj.js","assets/ggjzadbnd3k1vu0k.js","assets/lgw4q0e8zlqqfgug.js","assets/root-otc54kct.css","assets/conversation-small-j0gcsxmz.css","assets/hg4s4237azdb5era.js","assets/gohr301ka7cpfe4s.js","assets/jobqnbdildqzowzf.js","assets/ls4akj6tri7bc2dz.js","assets/glu06a3y5u0laqff.js","assets/dgb06x9f8z6d0ar9.js","assets/iayy5u2a26jybmdr.js","assets/l9bupap4fyh5egbo.js"])))=>i.map(i=>d[i]);
import{z as B,B as Me,s as ye,f as je,L as ke,M as se,kn as ae,tg as Re,mf as ie,iV as Ne,ko as oe,e as ge,aZ as Ae,Z as Ee,bb as me,bF as Ge,t as Pe,Y as fe,hz as Ue,hB as De,hC as Te,ei as ze,aa as ee,th as C,ap as Le,gN as Be,P as Oe,T as te,g as he,R as Fe,d0 as He,ed as $e,ti as qe,eE as Ve,tj as re,tk as We,tl as Ke,nA as Qe,e_ as Ye,dr as Je,b_ as Xe,b$ as Ze}from"./lgw4q0e8zlqqfgug.js";import{j as n,m as F,f as $,a as et,r as i,A as tt,h as pe,b as nt,c as st}from"./m60bpb0x3x7rg8fj.js";import{I as X,D as xe,u as at}from"./ltxonioslfmyr00u.js";import{mj as it,iC as ot,ej as rt,sd as lt,d6 as ct,c$ as H,d8 as ut,da as dt,d1 as gt,se as mt,sf as ft,sg as ht,bS as Se,d0 as we,sh as pt,lb as xt,si as ne,j as St}from"./ggjzadbnd3k1vu0k.js";import{C as ve}from"./crheuewn890nts1d.js";import{D as wt}from"./mr7j3fxti6m51rk7.js";import{C as vt}from"./kkg7k3irromdz83f.js";import"./hv81c3k3l9e69foo.js";import"./lqxrayj6ap3vzwmb.js";import"./cs281ckvaib8kadh.js";const Ie=({children:e,isDimensionsUnknown:t})=>n.jsxs(F.div,{className:B(["relative max-w-[480px] rounded-2xl",t&&"aspect-square overflow-hidden"]),children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]}),It=({children:e,isDimensionsUnknown:t,width:s,height:r})=>n.jsxs(F.div,{layout:!0,transition:{duration:.3,ease:"easeInOut"},exit:{opacity:0,transition:{duration:.1,ease:"easeInOut"}},className:B(["relative max-w-[480px] overflow-hidden rounded-2xl",t&&"aspect-square"]),style:{width:s??"auto",height:r??"auto"},children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]}),bt=()=>{const e=$(),t=et();return n.jsxs("div",{className:"absolute start-0 bottom-0 flex w-full items-center justify-between bg-white/10 p-4",children:[n.jsxs("div",{className:"flex min-w-0 flex-col",children:[n.jsx("span",{className:"text-sm font-medium text-white",children:e.formatMessage({id:"PlfJ+x",defaultMessage:"Creation might take a moment"})}),n.jsx("span",{className:"text-sm font-normal text-white/80",children:e.formatMessage({id:"4JG8yC",defaultMessage:"Upgrade to create faster"})})]}),n.jsx(Me,{size:"medium",color:"primary-inverse",onClick:()=>ye(t,"Image Gen Latency Upsell"),children:e.formatMessage(je.getPlus)})]})};function Ct(e){const[t,s]=ke(se.ImageGenProgressUpsellV2,null,a=>a!=null&&typeof a=="object"&&(typeof a.lastSeenUpsellAt=="number"||a.lastSeenUpsellAt==null)&&(typeof a.lastUsedImageGen=="number"||a.lastUsedImageGen==null)&&(typeof a.lastMessageId=="string"||a.lastMessageId==null)&&(typeof a.lastCanBeSeen=="boolean"||a.lastCanBeSeen==null)),r=t&&t.lastSeenUpsellAt?ae(t.lastSeenUpsellAt):null,o=t&&t.lastUsedImageGen?ae(t.lastUsedImageGen):null,c=e?t&&t.lastMessageId===e?t.lastCanBeSeen:(r==null||Re(r,ie(new Date,3)))&&o!=null&&Ne(o,ie(new Date,1)):!1;return{canBeSeen:c,markImageGenUsed:()=>{if(e){const a={lastSeenUpsellAt:c?oe(new Date):t?.lastSeenUpsellAt??null,lastUsedImageGen:oe(new Date),lastMessageId:e??null,lastCanBeSeen:c};s(a),localStorage.setItem(se.ImageGenProgressUpsellV2,JSON.stringify(a))}}}}function _t(){const[t,s]=i.useState(new Date);i.useEffect(()=>{s(new Date)},[]);const r=ot(+t,12e4);return n.jsx(rt,{percentage:r,sizeOverride:30,thickness:1/15,className:"text-white",backgroundStrokeClassName:"stroke-white/20",transitionDuration:`${(100-r)/100*.2}s`,transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})}const be=({isGettingStarted:e,messageId:t})=>{const s=ge(),o=Ae()?.isFree()??!1,{canBeSeen:c,markImageGenUsed:l}=Ct(t),a=o&&c&&Ee(s,"1997515563").get("should_show_image_gen_latency_upsell",!1);it(()=>{l()});const d=$(),f=i.useMemo(()=>e?d.formatMessage({id:"SxQKjt",defaultMessage:"Getting started"}):d.formatMessage({id:"Y3ETLn",defaultMessage:"Creating image"}),[e,d]),u=me(s,"3019066937").get("should_show_cot_header",!1),h=i.useMemo(()=>e?n.jsx(ve,{size:30,arcPercentage:.2,strokeWidth:2}):n.jsx(_t,{}),[e]);return n.jsxs("div",{className:B("absolute inset-0 flex justify-between px-6 py-6",a?"items-start":"items-end"),children:[n.jsxs(tt,{mode:"popLayout",children:[u&&n.jsx(F.span,{className:B("flex items-center gap-1 align-middle text-lg",!e&&"text-white"),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,overflow:"hidden",whiteSpace:"nowrap"},transition:{duration:.1,ease:"easeInOut"},children:f},f),n.jsx("div",{className:"flex flex-1 items-center justify-end",children:h})]}),a&&n.jsx(bt,{})]})},le=Ge.div`invisible absolute top-3 flex gap-1 group-hover/paragen-image:visible z-2
  ${({$rightAlign:e})=>e?"end-3":"start-3"}
  ${({$alwaysVisible:e})=>e?"visible":""}`,Mt=({imageUrl:e})=>{const[t,s]=i.useState(void 0),r=$(),o=lt(),c=i.useCallback(()=>{const l=new Date;return`${r.formatDate(l,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}.png`},[r]);return n.jsxs("div",{className:"group/paragen-image absolute inset-0 z-3",children:[n.jsxs(le,{$alwaysVisible:!0,children:[t!==!1&&n.jsx(X,{icon:ct,selected:t===!0,variant:"large",onClick:l=>{l.stopPropagation(),H.paragenImageRated({liked:!0,analyticsContext:o}),s(!0)}}),t!==!0&&n.jsx(X,{icon:ut,selected:t===!1,variant:"large",onClick:l=>{l.stopPropagation(),H.paragenImageRated({liked:!1,analyticsContext:o}),s(!1)}})]}),n.jsx(le,{$alwaysVisible:!0,$rightAlign:!0,children:n.jsx(X,{icon:dt,variant:"large",onClick:l=>{l.stopPropagation(),H.paragenDownload({analyticsContext:o}),gt({url:e,fileName:c()})}})})]})};function Ce({withLottie:e}){const s=$().formatMessage({id:"imagegen.progressIndicator.ariaLabel",defaultMessage:"Generating image..."});return n.jsx("div",{className:"absolute start-0 top-0 flex h-full w-full items-center justify-center rounded-full","aria-label":s,children:n.jsx(ve,{size:40,arcPercentage:.2,children:n.jsx(wt,{animate:e,matchTextColor:!0,className:"h-6 w-6"})})})}const _e=300,yt=1.3,ce=.05,jt=/blur\(([\d.]+)px\)/,kt={duration:_e/1e3,ease:"linear"};function Z(e,t,s){e.sort((l,a)=>l.lastSrcReceivedTime-a.lastSrcReceivedTime);const r=new Array(e.length).fill(0);for(let l=0;l<=e.length;l+=1){const a=l-1,d=l,f=e[a]?.availablePercentComplete??0,u=e[d]?.availablePercentComplete??1;if(t>=f&&t<=u&&f!==u){const h=(t-f)/(u-f);r[a]=1-h,r[d]=h}}const o=r[r.length-1],c=r[r.length-2];return o===1&&c===0&&(r[r.length-2]=.01),s&&t<=e[0]?.availablePercentComplete&&(r[0]=1),r}const Rt=({alt:e,src:t,availablePercentComplete:s,onAnimationUpdate:r,ignoreFirstChunk:o=!1,isTransparent:c=!1,dimensions:l,onError:a,unconstrainedWidth:d=!1,progressLoaderProps:f})=>{const u=Pe(),h=i.useMemo(()=>`url(${u?mt:ft})`,[u]),[x,M]=i.useState(!1),[v,g]=i.useState(1e3),[b,N]=i.useState(s??0),[p,I]=i.useState(s===1?1:0),E=i.useRef(performance.now()),k=i.useRef(0),S=i.useRef([]),[U,P]=i.useState([0]),[O,z]=i.useState(s===1),L=i.useRef(!1),D=i.useRef(null),R=b===1,j=s===1&&O,A=l?l.width/l.height:1;i.useEffect(()=>{!x&&s&&(M(!0),k.current=performance.now())},[x,s]),i.useEffect(()=>{const _=S.current[S.current.length-1]?.src;if(t&&t!==_){const m=S.current.findIndex(y=>y.availablePercentComplete===s);m!==-1?S.current[m]={src:t,availablePercentComplete:s??0,lastSrcReceivedTime:performance.now()}:S.current.push({src:t,availablePercentComplete:s??0,lastSrcReceivedTime:performance.now()}),P(Z(S.current,b,o))}},[t,b,o,s]);const G=i.useCallback(()=>{D.current&&s&&(g(j?_e:(performance.now()-E.current)*yt),(!o||L.current||s>=ce)&&s!==1&&I(s),L.current=!0,E.current=performance.now(),f?.setHasImageReady(!0))},[s,j,o,f]),K=i.useCallback(_=>{const m=parseFloat(_.height)/100;r?.(m),N(m),P(Z(S.current,parseFloat(_.height)/100,o))},[r,o]),q=i.useCallback(_=>{const m=_.filter.toString().match(jt)?.[1]??"0",w=(16-parseFloat(m))/16,Q=1-p,J=p+Q*w;r?.(J),N(J),P(Z(S.current,J,o))},[o,p,r]);if(!x)return n.jsx(Ie,{isDimensionsUnknown:!0,children:n.jsx(Ce,{withLottie:!0})});const W={duration:v/1e3,ease:"linear"},T=s!==1||!c;return n.jsxs("div",{className:B("relative z-0 cursor-pointer overflow-hidden",A<1?"max-w-[400px]":"max-w-[480px]",!R&&"pointer-events-none",!L.current&&"bg-token-main-surface-secondary",d&&"max-w-full"),"aria-label":e,style:{aspectRatio:A},children:[!f?.shouldHideDiagonalShimmer&&s&&s<ce&&n.jsx("div",{className:"absolute inset-0 z-3 w-full overflow-hidden",children:n.jsx("div",{className:"absolute start-[-150%] top-[-150%] h-[400%] w-[400%]",children:n.jsx("div",{className:"diagonal-sweep-gradient h-full w-full"})})}),n.jsxs(F.div,{className:"absolute start-0 end-0 top-0 z-2 w-full overflow-hidden transition-[mask] ease-linear",initial:j?!1:{height:"0%"},animate:R?{height:"100%"}:{height:`${p*100}%`},onUpdate:j?void 0:K,transition:j?{duration:0,ease:"linear"}:W,style:R?void 0:{mask:"linear-gradient(rgb(0,0,0) 0%, rgb(0,0,0) calc(100% - 24px), rgba(0,0,0,0) 100%)"},children:[t&&n.jsx("img",{ref:D,src:t,onLoad:G,onError:a,alt:e,className:"absolute top-0 z-1 w-full",style:{aspectRatio:A}}),c&&n.jsx("div",{className:"absolute inset-0 z-0 w-full overflow-hidden opacity-0 transition-opacity duration-300 group-hover/imagegen-image:opacity-100 group-focus/imagegen-image:opacity-100",children:n.jsx("div",{className:"absolute inset-0 bg-repeat",style:{backgroundImage:h,backgroundSize:"auto"}})})]}),n.jsx(F.div,{className:"relative z-1 w-full overflow-hidden",initial:{filter:"blur(16px)"},animate:j?{filter:"blur(0px)"}:void 0,transition:j?kt:void 0,onUpdate:j?q:void 0,style:{aspectRatio:A},children:S.current.map((_,m)=>{const y=U[m],w=_.availablePercentComplete===1;return y!==0||w?n.jsx("img",{src:_.src,alt:e,style:{opacity:y,willChange:"opacity",aspectRatio:A},className:!j&&f?.shouldShowPulseAnimation?"bg-scale-pulse":"",onLoad:w?()=>z(!0):void 0},_.src):null})}),n.jsx(F.div,{className:"absolute inset-0 z-0 scale-110 overflow-hidden blur-2xl",style:{aspectRatio:A},children:T&&S.current.filter((_,m)=>U[m]!==0).map(_=>n.jsx("img",{src:_.src,alt:e,className:"absolute top-0 w-full"},_.src))})]})},Nt=({imageAssetPointer:e,serverThreadId:t})=>{const[s,r]=i.useState(void 0),o=ht(),c=e.metadata?.watermarked_asset_pointer,l=i.useRef(!1),{isUnauthenticated:a}=fe();return i.useEffect(()=>{if(o&&c&&!l.current){l.current=!0;const f=Ue(c);De(f,void 0,a,t,!1).then(u=>{u.status===Te.Success&&r(u.download_url)}).catch(u=>{u instanceof ze||ee.addError(new Error(`Could not fetch watermarked image with ID ${c} from file service`,{cause:u}))})}},[o,c,a,t,null]),s},ue=2,Y=({pointer:e,altLabel:t,isEditorAvailable:s,onPercentageRendered:r,messageId:o,imageIndex:c,clientThreadId:l,serverThreadId:a,onEditorClick:d,compact:f,progressLoaderProps:u})=>{const h=pe(),[x,M]=i.useState(void 0),v=i.useRef(void 0),g=e.metadata?.generation?.gen_id,b=e.metadata?.generation?.height??void 0,N=e.height,p=(b??0)/N,I=i.useRef({}),[E]=nt(),{isUnauthenticated:k}=fe(),[S,U]=i.useState(!1),P=i.useContext(xe),O=e.width/e.height,z=Nt({imageAssetPointer:e,serverThreadId:a}),D=i.useCallback((m=!1)=>{!m&&v.current===e.asset_pointer||(v.current=e.asset_pointer,Se.fetch(h,{asset:e,conversationId:a,force:m,isUnauthenticated:k}).then(y=>{M(y)}).finally(()=>{v.current=void 0}))},[e,h,a,k,null]);i.useEffect(()=>{const m=e.asset_pointer!==x?.asset_pointer;(!x||m)&&D()},[x,e.asset_pointer,D]);const R=i.useMemo(()=>we({pointer:x,conversationId:a,messageId:o,source:P?"paragen":"chat",imageIndex:c.toString()}),[x,a,o,P,c]),j=i.useRef(p);i.useEffect(()=>{p===1&&j.current<1&&H.renderingComplete({analyticsContext:R})},[p,R]);const A=i.useCallback(()=>{x&&d?.({image:x,messageId:o,analyticsContext:R})},[x,o,d,R]),G=i.useMemo(()=>({width:e.width,height:e.height}),[e]),K=i.useCallback(()=>{const m=(I.current[e.asset_pointer]??0)+1;if(I.current[e.asset_pointer]=m,I.current[e.asset_pointer]>ue)return ee.addAction("image-gen-asset-error",{name:"retries-exhausted",conversation_id:a,asset_pointer:e.asset_pointer,max_retries:ue});ee.addAction("image-gen-asset-retry",{name:"retry-attempted",conversation_id:a,asset_pointer:e.asset_pointer,current_retry:m}),I.current[e.asset_pointer]=m,D(!0)},[e.asset_pointer,D,a]),q=i.useCallback(m=>{m===1&&U(!0),r?.(m)},[r]),V=i.useRef(null),W=i.useRef(null);i.useEffect(()=>{if(V.current&&u?.setContainerSize){const m=V.current.getBoundingClientRect(),y={width:m.width,height:m.height},w=W.current;(!w||w.width!==y.width||w.height!==y.height)&&(W.current=y,u.setContainerSize(y))}},[u]);const T=x?.url,_=z??T;return n.jsx(pt.Provider,{value:R,children:n.jsxs("div",{ref:V,className:B("group/imagegen-image relative w-full overflow-hidden",O<1?"max-w-[400px]":"max-w-[480px]",f?"rounded-lg":"rounded-2xl",P&&"max-w-full",o===E.get("image")&&"[view-transition-name:var(--vt-active-image)]"),id:`image-${o}`,style:{aspectRatio:O},onClick:s?A:void 0,tabIndex:0,children:[z&&n.jsx("img",{alt:t,className:"absolute inset-0 z-1 opacity-0",src:z}),n.jsx(Rt,{alt:t,src:T,availablePercentComplete:p,onAnimationUpdate:q,isEditorAvailable:s,ignoreFirstChunk:!0,isTransparent:e.metadata?.generation?.transparent_background,dimensions:G,onError:K,unconstrainedWidth:P,progressLoaderProps:u},g),u?.state&&u?.state!==C.Complete&&!S&&u?.hasImageReady&&n.jsx(be,{isGettingStarted:!1,messageId:o}),S&&!f&&(P?n.jsx(Mt,{imageUrl:T??""}):n.jsx(xt,{imageAssetPointer:T,imageUrl:_,messageId:o,clientThreadId:l,serverThreadId:a,shouldShowOverflow:z!==void 0}))]},g)})},At=({imageGenerationState:e,isInterrupted:t,asyncMessage:s,imageAssetPointer:r,altLabel:o,clientThreadId:c,serverThreadId:l,onEditorClick:a,isEditorAvailable:d,setAnimationPercentage:f,messageId:u})=>{const[h,x]=i.useState(null),M=h==null,[v,g]=i.useState(!0),b=e===C.Thinking||e===C.AsyncGenerating&&!s?.metadata?.is_visually_hidden_from_conversation,N=e===C.Generating||e===C.Complete;return i.useEffect(()=>{b&&g(!1)},[b]),t?null:n.jsxs(n.Fragment,{children:[(b||!v)&&n.jsx(It,{isDimensionsUnknown:M,width:h?.width,height:h?.height,children:M&&n.jsx(be,{isGettingStarted:!0,messageId:u})}),N&&n.jsx(F.div,{className:"pb-2",variants:{hidden:{opacity:0},visible:{opacity:1}},initial:"hidden",animate:v?"visible":"hidden",exit:"hidden",children:r&&n.jsx(Y,{pointer:r,altLabel:o,isEditorAvailable:d,onPercentageRendered:f,messageId:u,clientThreadId:c,serverThreadId:l,imageIndex:0,onEditorClick:a,progressLoaderProps:{state:e,setContainerSize:x,hasImageReady:v,setHasImageReady:g,shouldHideDiagonalShimmer:!0,shouldShowPulseAnimation:!0}})})]})};function Et({title:e,description:t,shimmer:s}){return!e&&!t?null:n.jsxs("div",{className:"border-token-border-default my-2 max-w-[480px] min-w-72 rounded-2xl border p-6",children:[!!e&&n.jsx("p",{className:B("text-lg font-medium",s&&"loading-shimmer-pure-text-inverted",!!t&&"mb-1"),children:e}),!!t&&n.jsx("p",{children:t})]})}const Gt=e=>{"use forget";const t=st.c(6),{cotMessages:s,visualPercentComplete:r,isInterrupted:o,state:c}=e,l=o===void 0?!1:o,a=$();let d;t[0]!==a?(d=a.formatMessage({id:"imagegen.thinkingHeader.interrupted",defaultMessage:"Stopped creating image"}),t[0]=a,t[1]=d):d=t[1];const f=d,u=c===C.Complete||r===1;let h;e:{if(l){h=f;break e}else if(!s){h=void 0;break e}if(u){h=s.complete;break e}if(r){const v=Object.keys(s.generating);for(let g=0;g<v.length;g=g+1,g){const b=parseFloat(v[g]);if(r<b){h=s.generating[v[g]];break e}}}else{h=s.thinking;break e}h=s.complete}const x=h;let M;return t[2]!==x||t[3]!==l||t[4]!==u?(M=x&&n.jsx(vt,{latestHeadline:x,isComplete:u||l,showChunkIcon:!1,isExpandDisabled:!0}),t[2]=x,t[3]=l,t[4]=u,t[5]=M):M=t[5],M},Pt=({pointersToRender:e,altLabel:t,isEditorAvailable:s,updatePercentageRendered:r,toolCallMessage:o,toolOutputMessageIds:c,clientThreadId:l,serverThreadId:a,handleEditorClick:d})=>{const f=ne.useStore(),u=ne.useSelectedIndex();i.useEffect(()=>{f.setSelectedIndex(Math.max(c.findIndex(p=>p===o?.metadata?.selected_image_message_id),0))},[]);const h=i.useRef({}),x=i.useCallback(p=>I=>{h.current[p]=I;const E=Object.keys(h.current).length,k=Object.values(h.current).reduce((S,U)=>S+U,0);r?.(k/E)},[r]),[M,v]=i.useState(null),g=Le(l,te.getRequestId),b=Be(g);i.useEffect(()=>{!b&&M!=null&&o!=null&&a!=null&&(de(o.id,c[M],l,a),v(null))},[b]);const N=i.useCallback(p=>{f.setSelectedIndex(p);const I=Object.values(h.current);Oe.logEventWithStatsig("chatgpt_image_switched","chatgpt_image_switched",{conversationId:a,messageId:c[p],imageIndex:p.toString(),isLoading:(I.length===0||I.some(S=>S<1)).toString()});const k=te.getConversationLastTurn(he(l))?.messages.find(S=>S.id===o?.id)!=null;o!=null&&a!=null&&(k&&b?v(p):de(o.id,c[p],l,a))},[o,c,l,a,f,b,v]);return n.jsxs("div",{className:"flex gap-2",children:[n.jsx(Y,{pointer:e[u],altLabel:t,isEditorAvailable:s,messageId:c[u],imageIndex:u,clientThreadId:l,serverThreadId:a,onEditorClick:d},c[u]),n.jsx("div",{className:"flex flex-col gap-2",children:e.map((p,I)=>n.jsx(Ut,{pointer:p,altLabel:t,isSelected:I===u,onClick:()=>N(I),onPercentageRendered:p.metadata?.generation?.gen_id?x(p.metadata.generation.gen_id):void 0,messageId:c[I],imageIndex:I,clientThreadId:l,serverThreadId:a},c[I]))})]})},Ut=({pointer:e,altLabel:t,isSelected:s,onClick:r,onPercentageRendered:o,messageId:c,imageIndex:l,clientThreadId:a,serverThreadId:d})=>n.jsxs("button",{type:"button",onClick:r,className:"relative w-14 rounded-lg p-1",children:[n.jsx("div",{className:B(s&&"opacity-70"),children:n.jsx(Y,{pointer:e,altLabel:t,isEditorAvailable:!1,onPercentageRendered:o,messageId:c,imageIndex:l,clientThreadId:a,serverThreadId:d,compact:!0})}),s&&n.jsx("div",{className:"border-token-border-default pointer-events-none absolute inset-0 rounded-xl border-2"})]});async function de(e,t,s,r){const o=await Fe.safePost("/image-gen/message-select",{requestBody:{message_id:e,selected_image_message_id:t,conversation_id:r}}),c=o.id;c!=null&&He(s,l=>{$e.updateTree(l,a=>{a.updateNodeMessage(c,o)})})}function Dt(e){const t=e.find(l=>l.author.role==="tool"&&l.author.name===qe&&l.content.content_type==="text"),[s,...r]=t?.content.content_type==="text"?t.content.parts:[],o=r.pop(),c=r.length;return s&&o&&r.length>0?{thinking:s,complete:o,generating:r.reduce((l,a,d)=>{const f=(d+1)/c;return l[f.toFixed(2)]=a,l},{})}:void 0}const Tt=e=>{const t=$(),{size:s="image",count:r=1}=e||{};return r>1?{thinking:t.formatMessage({id:"cdnmKo",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"aTbInH",defaultMessage:"Creating images. May take a moment."}),"0.67":t.formatMessage({id:"WRM3Yw",defaultMessage:"Creating images. May take a moment."}),"1.00":t.formatMessage({id:"8ZydRG",defaultMessage:"Creating images. May take a moment."})},complete:t.formatMessage({id:"XQ81dl",defaultMessage:"Images created"})}:s==="xlimage"?{thinking:t.formatMessage({id:"y7op2E",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"cdrDJH",defaultMessage:"Creating image. May take a moment."}),"0.67":t.formatMessage({id:"RP4bRn",defaultMessage:"Adding details"}),"1.00":t.formatMessage({id:"o36MSQ",defaultMessage:"Finishing touches"})},complete:t.formatMessage({id:"QsnnBN",defaultMessage:"Image created"})}:{thinking:t.formatMessage({id:"6c7+kN",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"DP6/8y",defaultMessage:"Creating image"}),"0.67":t.formatMessage({id:"k9y1TT",defaultMessage:"Creating image"}),"1.00":t.formatMessage({id:"GpR7v3",defaultMessage:"Creating image"})},complete:t.formatMessage({id:"l2Izz4",defaultMessage:"Image created"})}},zt=Xe(()=>Ze(()=>import("./ocbo82eisw0w775w.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])).then(e=>e.ImageGenConversationLightboxNew)),Lt=[C.Empty,C.Errored],Yt=({messages:e,clientThreadId:t,isLastTurnInConversation:s,isParagen:r=!1})=>{const o=Ve(t),l=$().formatMessage({id:"imagegen.message.altLabel",defaultMessage:"Generated image"}),{messageIds:a,imageAssetPointers:d}=i.useMemo(()=>re(e),[e]),f=e.find(We),u=ne.useSelectedIndex(),h=d?.[u]?.metadata?.generation?.gen_size,x=Tt({size:h??"image",count:d?.length??1}),M=i.useMemo(()=>Dt(e)??x,[e,x]),v=e.find(G=>G.metadata?.image_gen_async),g=i.useMemo(()=>Ke(e,s),[e,s]),b=i.useRef(!1),N=i.useRef(!1),p=i.useRef(null),I=i.useMemo(()=>we({pointer:d[u],conversationId:o,messageId:a[u],source:r?"paragen":"chat",imageIndex:u.toString()}),[d,a,u,o,r]);i.useEffect(()=>{if(!b.current&&(g===C.Thinking||g===C.Generating))b.current=!0,p.current=performance.now();else if(b.current&&!N.current)if(g===C.Complete){const G=p.current?performance.now()-p.current:void 0;H.generationSuccess({analyticsContext:I,durationMs:G}),N.current=!0}else g===C.Errored&&(H.generationFailure({analyticsContext:I,errorReason:"assistant_error"}),N.current=!0)},[g,I]);const E=e[e.length-1],k=i.useMemo(()=>E&&Qe(E),[E]),S=ge(),{onRequestCompletion:U}=St(),O=Ye(t)?.id??null,z=me(S,"3019066937").get("should_use_new_ui",!1),L=at({clientThreadId:t})&&g===C.Complete,[D,R]=i.useState(0),j=pe(),A=i.useCallback(async({image:G,analyticsContext:K})=>{const q=he(t),V=q?te.getConversationTurns(q).flatMap(w=>w.messages):e,{imageAssetPointers:W,messageIds:T}=re(V,{skipSort:!0}),m=(r?[G]:await Promise.all(W.map(w=>Se.fetch(j,{asset:w,conversationId:o})))).map((w,Q)=>({id:w.metadata?.generation?.gen_id??T[Q],archived:!1,transformationId:w.metadata?.generation?.gen_id??null,url:w.url,assetPointer:w.asset_pointer,thumbnail:null,width:w.width,height:w.height,title:null,conversationId:o,messageId:T[Q]}));H.editorClick({sourceOperation:G.metadata?.dalle?.edit_op??"none",analyticsContext:K});const y=m.findIndex(w=>w.assetPointer===G.asset_pointer);Je(S,({onClose:w})=>n.jsx(zt,{images:m,initialIndex:y===-1?0:y,onClose:w,onRequestCompletion:U,clientThreadId:t,currentModelId:O}))},[e,o,S,U,t,O,j,r]);return Lt.includes(g)?null:n.jsx(xe.Provider,{value:r,children:n.jsx("div",{className:"flex flex-col",children:z?n.jsx(At,{imageGenerationState:g,isInterrupted:k,asyncMessage:v,imageAssetPointer:d[0],altLabel:l,clientThreadId:t,serverThreadId:o,onEditorClick:A,setAnimationPercentage:R,isEditorAvailable:L,messageId:a[0]}):n.jsxs(n.Fragment,{children:[g!==C.Unavailable&&g!==C.AsyncGenerating&&g!==C.AsyncHanging&&n.jsx("div",{className:"pb-3",children:n.jsx(Gt,{cotMessages:M,visualPercentComplete:D,isInterrupted:k,state:g})}),g===C.Thinking&&!k&&n.jsx(Ie,{isDimensionsUnknown:!0,children:n.jsx(Ce,{withLottie:!0})}),g===C.AsyncGenerating&&!v?.metadata?.is_visually_hidden_from_conversation&&n.jsx(Et,{shimmer:!0,title:v?.metadata?.ui_card_title,description:v?.metadata?.ui_card_description}),(g===C.Generating||g===C.Complete)&&!k&&n.jsx("div",{className:"pb-2",children:d.length>1?n.jsx(Pt,{pointersToRender:d,altLabel:l,isEditorAvailable:L,updatePercentageRendered:R,toolCallMessage:f,toolOutputMessageIds:a,clientThreadId:t,serverThreadId:o,handleEditorClick:A}):n.jsx(Y,{pointer:d[0],altLabel:l,isEditorAvailable:L,onPercentageRendered:R,messageId:a[0],imageIndex:0,clientThreadId:t,serverThreadId:o,onEditorClick:A})})]})})})};export{Yt as ImageGenMessage};
//# sourceMappingURL=0obq87aul2xadkgb.js.map

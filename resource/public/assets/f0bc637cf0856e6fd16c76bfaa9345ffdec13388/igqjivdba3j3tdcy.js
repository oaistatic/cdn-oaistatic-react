import{jZ as C,oV as R,fp as S,jT as c,jU as v,fY as w,oW as O,R as N,oX as k,oY as A,jV as f,k4 as P,oZ as x,o_ as y}from"./lgw4q0e8zlqqfgug.js";import{r as T}from"./m60bpb0x3x7rg8fj.js";import{m as D}from"./nbcw9m75c6j7so0w.js";import{cs as d,ct as g}from"./ggjzadbnd3k1vu0k.js";function ue({composerController:o,parsedDocumentHandler:e}){const{connectorConfig:s}=C();return T.useEffect(()=>{R(S(o),{transformPasted:(t,n)=>{const{allDocIds:r,nextSlice:a}=U(t,n,s);return requestAnimationFrame(()=>{e(r)}),a}})},[o,s,e]),null}function U(o,e,s){const t=[],n=e.state.schema,r=i=>{if(i.isText){let u=i.text??"";const p=b(u,s);if(p.length===0)return i;for(const m of p)t.push(m),m.isConnected&&(u=u.replaceAll(m.url,""));return u===""?null:n.text(u,i.marks)}if(i.isLeaf)return i;const l=[];return i.forEach(u=>{const p=r(u);p&&l.push(p)}),i.copy(y.fromArray(l))},a=[];return o.content.forEach(i=>{const l=r(i);l&&a.push(l)}),{allDocIds:t,nextSlice:new x(y.fromArray(a),o.openStart,o.openEnd)}}function b(o,e){const s=[];for(const t of e.values())switch(t.type){case c.GDRIVE:{if(t.link_enabled??!0){const n=F(o,t);s.push(...n)}break}case c.O365:break;case c.O365_BUSINESS:{const n=Z(o,t).filter(r=>r!=null);s.push(...n);break}case c.O365_PERSONAL:{const n=J(o,t).filter(r=>r!=null);s.push(...n);break}case c.CONFLUENCE:{const n=H(o,t).filter(r=>r!=null);s.push(...n);break}case c.JIRA:{const n=W(o,t).filter(r=>r!=null);s.push(...n);break}case c.NOTION_OPEN_CONNECTOR:{const n=re(o,t).filter(r=>r!=null);s.push(...n);break}case c.SLACK_OPEN_CONNECTOR:{const n=V(o,t).filter(r=>r!=null);s.push(...n);break}}return s.length&&v.linkPasted(D(w(s,t=>t.type),t=>t.length)),s}const $=/\bhttps:\/\/docs\.google\.com\/(document|spreadsheets|presentation)\/d\/([\w-]+)\/?(?:(?:edit|view)\/?)?(?:\?[\w\-.~%=]*)?(?:#[\w\-.~%=]*)?/gm,j=/\bhttps:\/\/drive\.google\.com\/(file)\/d\/([\w-]+)\/?(?:(?:edit|view)\/?)?(?:\?[\w\-.~%=]*)?(?:#[\w\-.~%=]*)?/gm,L="https://www.googleapis.com/auth/drive.readonly";function F(o,e){return[...o.matchAll($),...o.matchAll(j)].map(s=>{const t={url:s[0],id:s[2],type:c.GDRIVE,isConnected:e.access_token!=null};return e.access_token&&e.scopes&&e.scopes.includes(L)?{...t,handler:{type:"fetch",tryFetch:async()=>{g.logAttemptIfAccessTokenIsExpired(e,f.Link);const r=`https://www.googleapis.com/drive/v3/files/${t.id}?fields=name,mimeType`,a=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${e.access_token}`,"Content-Type":"application/json"}});if(!a.ok)return Promise.reject(new Error(`HTTP ${a.status}`));const{name:i,mimeType:l}=await a.json(),u=P(l);return{connector:c.GDRIVE,id:t.id,title:i,mimeType:l,url:t.url,syntheticExtension:u}}}}:{...t,handler:{type:"prompt",message:"not-connected"}}})}function _(o){let e;try{e=new URL(o).toString()}catch{return null}return`u!${btoa(e).replaceAll("=","").replaceAll("/","_").replaceAll("+","-")}`}const B=/\bhttps:\/\/onedrive\.live\.com\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm,G=/\bhttps:\/\/photos\.onedrive\.com\/(?:share|photo)\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm,M=/\bhttps:\/\/1drv\.ms\/[\w\-_.~!*'();:@&=+$,\\/?%#[\]]*/gm;function J(o,e){return[...o.matchAll(B),...o.matchAll(M),...o.matchAll(G)].map(s=>{const t=_(s[0]);if(!t)return null;const n={url:s[0],id:t,type:c.O365_PERSONAL,isConnected:e.access_token!=null};return e.access_token?{...n,handler:{type:"fetch",tryFetch:E(d.OneDrive_PERSONAL_SHARES,t,e.access_token,e)}}:{...n,handler:{type:"prompt",message:"not-connected"}}})}const z=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/wiki\/spaces\/[^\s]+\/pages\/(\d+)\/([^\s]+)?/gm;function H(o,e){return[...o.matchAll(z)].map(s=>{const t=s[1],n=s[2],r=s[3];if(!n)return null;const a={url:s[0],id:n,type:c.CONFLUENCE,isConnected:e.access_token!=null};return e.access_token?{...a,handler:{type:"fetch",tryFetch:async()=>{let i=r;return!r&&e.access_token&&(i=await se(e.access_token,`https://${t}`,e,n)),{connector:e.type,id:n,title:i,mimeType:"text/html",url:a.url,syntheticExtension:null,manifest:{id:n,domain:t,type:A.PAGE,manifest_type:c.CONFLUENCE}}}}}:{...a,handler:{type:"prompt",message:"not-connected"}}})}const q=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/browse\/([^\s]+)\??/gm,K=/\bhttps:\/\/([^\s]+?\.atlassian\.net)\/jira\/(?:[^\s]+\/)*projects\/(?:[^\s]+\/)+(?:[^\s]+\/?)\?selectedIssue=([^\s]+)&?/gm;function W(o,e){return[...o.matchAll(q),...o.matchAll(K)].map(s=>{const t=s[1],n=s[2];if(!n||!t)return null;const r={url:s[0],id:n,type:c.JIRA,isConnected:e.access_token!=null};return e.access_token?{...r,handler:{type:"fetch",tryFetch:async()=>{const a=await ne(e.access_token,`https://${t}`,e,n);return Promise.resolve({connector:e.type,id:n,title:a,mimeType:"text/markdown",url:r.url,syntheticExtension:null,manifest:{id_or_key:n,domain:t,manifest_type:c.JIRA}})}}}:{...r,handler:{type:"prompt",message:"not-connected"}}})}const Y=/\bhttps:\/\/[^\s]+?\.sharepoint\.com\/[^\s]*/gm;function Z(o,e){return[...o.matchAll(Y)].map(s=>{const t=_(s[0]),n=d.OneDrive_BUSINESS_SHARES;if(!t)return null;const r={url:s[0],id:t,type:c.O365_BUSINESS,isConnected:e.access_token!=null};return e.access_token?{...r,handler:{type:"fetch",tryFetch:E(n,t,e.access_token,e)}}:{...r,handler:{type:"prompt",message:"not-connected"}}})}const X=/\bhttps:\/\/(?<domain>[^\s]+?\.(?:enterprise\.)?slack\.com)\/archives\/(?<conversation_id>[^\s/]+)\/?\??$/gm,Q=/\bhttps:\/\/(?<domain>[^\s]+?\.(?:enterprise\.)?slack\.com)\/archives\/(?<conversation_id>[^\s/]+)\/p(?<message_id>[^\s?&]+)(?:\?(?:.*thread_ts=(?<thread_id>[^\s&]+)(?:&.*))?)?/gm;function V(o,e){return[...o.matchAll(Q),...o.matchAll(X)].map(s=>{const t=s.groups?.domain;if(!t)throw new Error(`No domain found in match ${JSON.stringify(s)}`);const n=s.groups?.conversation_id;if(!n)throw new Error(`No conversation ID found in match ${JSON.stringify(s)}`);const r=s.groups?.message_id;let a=null;r&&(a=`${r.slice(0,10)}.${r.slice(10)}`);const i=s.groups?.thread_id??null;let l="Conversation",u=`conversation-${n}`;a?(l="Message",u=`message-${a}`):i?(l="Thread",u=`thread-${i}`):n[0]==="D"&&(l="Direct message");const p={id:u,url:s[0],domain:t,conversationId:n,messageId:a,threadId:i,type:c.SLACK_OPEN_CONNECTOR,isConnected:e.access_token!=null};return e.access_token?{...p,handler:{type:"fetch",tryFetch:async()=>e.access_token?Promise.resolve({connector:e.type,id:p.id,title:l,mimeType:"application/json",url:p.url,syntheticExtension:null,manifest:{conversation_id:p.conversationId,domain:p.domain,manifest_type:c.SLACK_OPEN_CONNECTOR,message_id:p.messageId,thread_id:i,type:O.MESSAGE}}):Promise.reject(new Error("Not connected"))}}:{...p,handler:{type:"prompt",message:"not-connected"}}})}function E(o,e,s,t,n){switch(o){case d.OneDrive_BUSINESS_SHARES:case d.OneDrive_PERSONAL_SHARES:return()=>h(`${o}/${encodeURIComponent(e)}/driveItem`,s,t);case d.OneDrive_BUSINESS_DRIVE_ITEMS:return()=>h(`${o}/${encodeURIComponent(e)}`,s,t);case d.OneDrive_BUSINESS_DRIVE_ROOT:return async()=>{const r=await ee(s,e);if(!r)return Promise.reject(null);const a=`${o}:${encodeURIComponent(r)}`;return h(a,s,t)};case d.OneDrive_PERSONAL_DRIVE_ITEMS:return()=>Promise.reject(null)}}async function ee(o,e){const t=await fetch("https://graph.microsoft.com/v1.0/me/drive/root",{method:"GET",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(!t.ok)return null;const{webUrl:n}=await t.json(),a=new URL(n).pathname;return e.startsWith(a)?e.substring(a.length):e}async function h(o,e,s,t){g.logAttemptIfAccessTokenIsExpired(s,f.Link);const n=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!n.ok)return Promise.reject(new Error(`HTTP ${n.status}`));const{id:r,name:a,file:i,webUrl:l,...u}=await n.json();return t||(t=u.parentReference?.driveId),{connector:s.type,id:r,title:a??"",mimeType:i?.mimeType??"",url:l??"",syntheticExtension:null,o365DriveId:t}}const te="https://api.atlassian.com/oauth/token/accessible-resources";async function I(o,e,s){g.logAttemptIfAccessTokenIsExpired(s,f.Link);const n=(await fetch(te,{headers:{Authorization:`Bearer ${o}`}}).then(r=>r.json())).find(r=>r.url===e)?.id;return n||Promise.reject(new Error("Cloud ID not found"))}async function se(o,e,s,t){const n=await I(o,e,s);return(await fetch(`https://api.atlassian.com/ex/confluence/${n}/wiki/api/v2/pages/${t}?include-version=false`,{headers:{Authorization:`Bearer ${o}`}}).then(i=>i.json())).title??"Confluence Page"}async function ne(o,e,s,t){const n=await I(o,e,s);return(await fetch(`https://api.atlassian.com/ex/jira/${n}/rest/api/2/issue/${t}?fields=summary`,{headers:{Authorization:`Bearer ${o}`}}).then(i=>i.json())).fields.summary??"Jira Issue"}const oe=/\bhttps:\/\/www\.notion\.so\/(?:.*?)?(?<page_id>[a-f0-9]{32})(?:\?[\x21-\x7e]*)?/gm;function re(o,e){return[...o.matchAll(oe)].map(s=>{const t=s.groups?.page_id;if(!t)return null;const n={url:s[0],id:t,type:c.NOTION_OPEN_CONNECTOR,isConnected:e.access_token!=null};return e.access_token?{...n,handler:{type:"fetch",tryFetch:async()=>{const r=await N.safePost("/connectors/metadata",{requestBody:{manifest:{id:t,manifest_type:c.NOTION_OPEN_CONNECTOR}}});return Promise.resolve({connector:e.type,id:t,title:r.title??"Notion Page",mimeType:"application/json",url:n.url,syntheticExtension:null,manifest:{id:t,type:k.PAGE,manifest_type:c.NOTION_OPEN_CONNECTOR}})}}}:{...n,handler:{type:"prompt",message:"not-connected"}}})}export{ue as ContextConnectorDocumentParser,_ as encodeOneDriveShareUrl,b as parseDocumentURLs};
//# sourceMappingURL=igqjivdba3j3tdcy.js.map

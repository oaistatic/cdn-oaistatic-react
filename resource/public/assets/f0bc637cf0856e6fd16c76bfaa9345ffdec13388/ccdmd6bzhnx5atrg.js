const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/eohx4aye08k34pt6.js","assets/m60bpb0x3x7rg8fj.js","assets/d6raol4cdcsdp19u.js","assets/lgw4q0e8zlqqfgug.js","assets/root-otc54kct.css","assets/ggjzadbnd3k1vu0k.js","assets/conversation-small-j0gcsxmz.css","assets/n26tu9wxezmtzr3d.js","assets/dmk30rbb7u1k7gl7.js","assets/ansi-1f6vhsjh.css","assets/795byvwofdax2f6d.js","assets/m3hp25w3mcid81ib.js","assets/g7o69yifmkuxfsll.js","assets/m9elivgqkyz3hcka.js","assets/jii3s2n86nvi5fnj.js","assets/dp7t1jmnbbend843.js","assets/mdsdqbg7dtklqnuw.js","assets/kj109at7ry8iempm.js","assets/jtj7tm19s85de1gz.js","assets/ngdk8aaa28n1ff0n.js","assets/cb9cgv53vja8utnc.js","assets/o7wniqoxhh56wvjg.js","assets/czj65b9i5sztgpdb.js","assets/nyb6qzfj9cwbbq9m.js","assets/ijm2v97qh75qdidh.js","assets/hvkmppraevglbeo3.js","assets/kfjcy5y4cxuymbdf.js","assets/lf8mxjdfum7t34gh.js","assets/gjtxw5aaotq3dyvk.js","assets/wham-task-page-content-layout-ico853ag.css","assets/9q3v44p2xpoi75pn.js","assets/ll84t6t68j83ysyi.js","assets/tfkm8dsw7zx8il21.js","assets/kkyb18g9gdccsonu.js","assets/fxwiivjy9rf81dg2.js","assets/lycvq5rqsik44ye8.js","assets/crheuewn890nts1d.js","assets/df3y7yi36gehsn95.js","assets/og0mzunrykkt4tp0.js","assets/lff9oru7r5vtmz06.js"])))=>i.map(i=>d[i]);
import{cO as ze,z as Y,S as Ye,c as mt,dN as ft,cd as L,f5 as ht,b_ as Xe,b$ as Je,C as pt,B as J,b2 as te,aD as gt,fx as xt,e as _e,p as X,i6 as wt,s3 as _t,fp as vt,R as Be,cq as ve,aZ as kt,tM as bt,m as yt,cs as Ze,hi as K,cy as Ct,L as Mt,M as Pt,o7 as jt,bc as Tt}from"./lgw4q0e8zlqqfgug.js";import{r as f,j as e,f as O,M as _,a as qe,m as et,i as ee,u as St,h as ke,A as It,d as Nt,g as Dt}from"./m60bpb0x3x7rg8fj.js";import{jW as Lt,fc as Ft,iq as pe,ir as Ne,N as De,am as Rt,id as Bt,m9 as qt,n as Ue,ib as Et,ic as Ot,an as Pe,Y as Ut,sW as je,bm as Wt,sl as We,sj as Ae,sX as At,jo as Ht,cV as Qt}from"./ggjzadbnd3k1vu0k.js";import{M as Te,b as Le,W as Gt,f as Vt,p as fe,c as $t,a as Kt,d as zt}from"./d6raol4cdcsdp19u.js";import{Q as tt,l as at,s as Yt,x as st,W as q,f as Fe,w as Re,k as Xt,g as z,h as ge,R as xe,T as Jt,e as Zt,u as ea,b as ta}from"./g7o69yifmkuxfsll.js";import{u as aa}from"./9q3v44p2xpoi75pn.js";import{JsonViewer as sa}from"./mdsdqbg7dtklqnuw.js";import{T as ra,a as na,b as oa}from"./gjtxw5aaotq3dyvk.js";import{a as He,S as ia}from"./ll84t6t68j83ysyi.js";import{W as we}from"./cb9cgv53vja8utnc.js";import{S as la}from"./tfkm8dsw7zx8il21.js";import{u as da,g as Ee,W as ca,b as rt}from"./ngdk8aaa28n1ff0n.js";import{W as ua,D as ne,O as ma}from"./kkyb18g9gdccsonu.js";import{S as fa}from"./fxwiivjy9rf81dg2.js";import{g as ha,N as pa}from"./lycvq5rqsik44ye8.js";import{s as he,B as ga}from"./og0mzunrykkt4tp0.js";const nt=f.createContext(null);function ms({value:t,children:s}){return e.jsx(nt.Provider,{value:t,children:s})}function ie(){const t=f.useContext(nt);if(!t)throw new Error("useWhamTaskPageContext must be used within its provider");return t}function xa(t){const s={},r={};let a;for(const i of t)tt(i)?i.previous_turn_id?r[i.previous_turn_id]=i:a=i:i.previous_turn_id&&(s[i.previous_turn_id]??=[]).push(i);if(!a)return null;const n=i=>{const u=s[i.id]??[],o={};for(const d of u){const c=r[d.id];c&&(o[d.id]=n(c))}return{userTurn:i,assistantTurns:u,children:o}};return n(a)}function wa(t){for(let s=t.length-1;s>=0;s--){const r=t[s];if(tt(r)&&r.previous_turn_id)return r.previous_turn_id}return null}function _a(t,s){if(!t)return[];const r=[];if(s){const n=u=>{for(const o of u.assistantTurns){if(o.id===s)return[{node:u,activeId:o.id}];const d=u.children[o.id],c=d&&n(d);if(c)return[{node:u,activeId:o.id},...c]}return null},i=n(t);i&&r.push(...i)}r.length===0&&r.push({node:t,activeId:t.assistantTurns[0]?.id??null});let a=r[r.length-1];for(;a?.activeId;){const n=a.node.children[a.activeId];if(!n)break;r.push({node:n,activeId:n.assistantTurns[0]?.id??null}),a=r[r.length-1]}return r}function va(t){return t?.assistantTurns.some(s=>at(s.turn_status))}function ka({className:t,focusedAssistantTurn:s,currentTab:r,permissions:a,task:n,turns:i,containerHeight:u,onClickFile:o,setFocusedAssistantTurnId:d,onTabChange:c,latestTurnRef:l,latestUserMessageRef:h,hasComments:k,clearComments:p,showFullDiff:b,loadingTurnMapping:g,reserveComposerSpace:P=!0}){f.useEffect(()=>{if(!s){const M=wa(i);M&&d(M)}},[s,i,d]);const x=f.useMemo(()=>xa(i),[i]),I=f.useMemo(()=>_a(x,s?.id??null),[x,s?.id]),v=I.length-1,F=I.slice(0,v),S=ze(I),N=P&&va(S?.node),{data:C}=Yt(n?.id),U=f.useMemo(()=>{if(!g||!C?.current_assistant_turn)return null;const M=C.current_assistant_turn,R=(M.sibling_turn_ids?.length??0)+1,E=M.attempt_placement??0,G=Array.from({length:R},(H,W)=>W===E?M.id:`placeholder-${W}`),B={};return G.forEach((H,W)=>B[H]=W),{attemptIds:G,idToIdxMap:B}},[g,C?.current_assistant_turn]);return e.jsx("div",{className:Y("relative flex h-full w-full flex-col",t),children:e.jsx("div",{className:"flex h-fit min-h-full shrink-0 flex-col gap-6 pt-6 text-sm",children:g&&n&&C?.current_user_turn&&C?.current_assistant_turn?e.jsxs("div",{ref:l,className:Y("flex min-h-full shrink-0 flex-col gap-6",N&&"pb-36"),style:{minHeight:u-24},children:[e.jsx("div",{className:"text-token-text-secondary flex w-full items-center justify-center gap-2",children:e.jsx(Ye,{className:"text-xl"})}),e.jsx(Te,{isLatest:!0,task:n,userTurn:C.current_user_turn,assistantTurns:[C.current_assistant_turn],selectedAssistantId:C.current_assistant_turn.id,focusedAssistantTurn:C.current_assistant_turn,setFocusedAssistantTurnId:d,onClickFile:o,currentTab:r,onTabChange:c,permissions:a,startOpen:!0,hasComments:k,clearComments:p,showFullDiff:b,attemptIdsOverride:U?.attemptIds,idToIndexMapOverride:U?.idToIdxMap,latestUserMessageRef:h})]}):e.jsxs(e.Fragment,{children:[F.length>0&&e.jsx("div",{className:"flex flex-col gap-6",children:F.map(({node:M,activeId:R},E)=>e.jsx(Te,{isLatest:E===v,task:n,userTurn:M.userTurn,assistantTurns:M.assistantTurns,selectedAssistantId:R,focusedAssistantTurn:s,setFocusedAssistantTurnId:d,onClickFile:o,startOpen:E===v,currentTab:r,onTabChange:c,permissions:a,hasComments:k,clearComments:p,showFullDiff:b},M.userTurn.id))}),S&&e.jsx("div",{ref:l,className:Y("flex min-h-full shrink-0 flex-col gap-6",N&&"pb-36"),style:{minHeight:u-24},children:e.jsx(Te,{isLatest:!0,task:n,userTurn:S.node.userTurn,assistantTurns:S.node.assistantTurns,selectedAssistantId:s?.id??null,focusedAssistantTurn:s,setFocusedAssistantTurnId:d,onClickFile:o,currentTab:r,onTabChange:c,permissions:a,startOpen:!0,hasComments:k,clearComments:p,showFullDiff:b,latestUserMessageRef:h})})]})})})}const ot=f.createContext(null);function fs({value:t,children:s}){return e.jsx(ot.Provider,{value:t,children:s})}function Oe(){const t=f.useContext(ot);if(!t)throw new Error("useTaskComments must be used within a TaskCommentsProvider");return t}function ba({currentTab:t,permissions:s,onClickFile:r,onTabChange:a,showFullDiff:n,loadingTurnMapping:i,footer:u}){const{task:o,focusedAssistantTurn:d,pastTurns:c,setFocusedAssistantTurnId:l}=ie(),{comments:h,clearComments:k}=Oe(),[{height:p},b]=aa(),g=f.useRef(null),P=f.useRef(null),x=f.useRef(null);return mt(()=>{const I=g.current,v=x.current;!I||!v||!I.contains(v)||v.scrollIntoView({block:"start",behavior:"auto"})},[c,i]),e.jsx("div",{ref:Lt(b,g),className:"flex h-full w-full scroll-pt-3 flex-col items-center overflow-y-auto px-6",children:e.jsxs("div",{className:Y("@container w-full",Le),children:[e.jsx(ka,{focusedAssistantTurn:d,currentTab:t,permissions:s,task:o,turns:c,containerHeight:p,onClickFile:r,setFocusedAssistantTurnId:l,onTabChange:a,latestTurnRef:P,latestUserMessageRef:x,hasComments:h.length>0,clearComments:k,showFullDiff:n,loadingTurnMapping:i,reserveComposerSpace:u!=null}),u&&e.jsx("div",{className:"keyboard-open:fixed absolute start-0 end-0 bottom-0",children:u})]})})}function ya({unifiedDiff:t,setUnifiedDiff:s,showFullDiff:r,setShowFullDiff:a}){const n=O(),[i,u]=f.useState(!1);return e.jsxs(ft,{open:i,onOpenChange:u,contentAlign:"end",sideOffset:8,modal:!0,triggerButton:e.jsx("button",{type:"button",onClick:()=>u(!0),className:"hover:bg-token-border-light flex items-center justify-center rounded p-3","aria-label":n.formatMessage({id:"wham.diffModeDropdown.openMenu",defaultMessage:"Open diff settings menu"}),children:e.jsx(He,{className:"icon"})}),children:[e.jsxs(L.RadioGroup,{value:t?"unified":"split",onValueChange:o=>s(o==="unified"),onClick:o=>o.stopPropagation(),children:[e.jsx(L.RadioItem,{value:"split",onClick:o=>o.stopPropagation(),children:e.jsxs("div",{className:"text-token-text-primary flex items-center gap-3",children:[e.jsx(He,{className:"icon"}),e.jsx(_,{id:"wham.message.modal.footer.splitDiff",defaultMessage:"Split diff"})]})}),e.jsx(L.RadioItem,{value:"unified",onClick:o=>o.stopPropagation(),children:e.jsxs("div",{className:"text-token-text-primary flex items-center gap-3",children:[e.jsx(ia,{className:"icon"}),e.jsx(_,{id:"wham.message.modal.footer.unifiedDiff",defaultMessage:"Unified diff"})]})})]}),e.jsx(L.Separator,{}),e.jsxs(L.RadioGroup,{value:r?"full":"latest",onValueChange:o=>a(o==="full"),onClick:o=>{o.stopPropagation()},children:[e.jsx(L.RadioItem,{value:"full",children:e.jsx(_,{id:"wham.copyFile.showFullDiff",defaultMessage:"Full diff"})}),e.jsx(L.RadioItem,{value:"latest",children:e.jsx(_,{id:"wham.copyFile.showLatestCommit",defaultMessage:"Incremental diff"})})]})]})}function Ca({previewImages:t}){const s=O(),r=Ft(t.map(l=>({content_type:ht.ImageAssetPointer,asset_pointer:l.asset_pointer??"",size_bytes:l.size_bytes??0,width:l.width??0,height:l.height??0}))),a=f.useMemo(()=>r.filter(l=>l.data),[r]),[n,i]=f.useState(0),u=Math.min(Math.max(n,0),Math.max(a.length-1,0)),o=f.useCallback(()=>{a.length<=1||(i(l=>(l-1+a.length)%a.length),we.recordPreviewImagesCarouselPrev())},[a.length]),d=f.useCallback(()=>{a.length<=1||(i(l=>(l+1)%a.length),we.recordPreviewImagesCarouselNext())},[a.length]);st([{key:"previewCarouselPrev",action:o,actionMessageDescriptor:s.formatMessage({id:"wham.keyboardActions.previousPreviewImage",defaultMessage:"Select previous image"}),group:Ne.Chat,keyboardBinding:[pe.ArrowLeft],enabled:a.length>1},{key:"previewCarouselNext",action:d,actionMessageDescriptor:s.formatMessage({id:"wham.keyboardActions.nextPreviewImage",defaultMessage:"Select next image"}),group:Ne.Chat,keyboardBinding:[pe.ArrowRight],enabled:a.length>1}]);const c=a[u]?.data;return e.jsxs("div",{className:"relative flex h-full w-full items-center justify-center overflow-hidden p-4",children:[c?e.jsx("img",{src:c.url,width:c.width,height:c.height,alt:s.formatMessage({id:"wham.whamTaskPageContentLoaded.previewImageAlt",defaultMessage:"Generated image"}),className:"max-h-full max-w-full object-contain"},u):e.jsx("div",{className:"text-secondary text-sm",children:s.formatMessage({id:"wham.whamPreviewImageCarousel.loading",defaultMessage:"Loading preview…"})}),a.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button","aria-label":s.formatMessage({id:"wham.whamPreviewImageCarousel.prev",defaultMessage:"Previous image"}),onClick:o,className:"absolute start-2 top-1/2 -translate-y-1/2 rounded-md bg-black/40 px-2 py-1 text-white hover:bg-black/60 focus:ring-2 focus:ring-white/70 focus:outline-none",children:"‹"}),e.jsx("button",{type:"button","aria-label":s.formatMessage({id:"wham.whamPreviewImageCarousel.next",defaultMessage:"Next image"}),onClick:d,className:"absolute end-2 top-1/2 -translate-y-1/2 rounded-md bg-black/40 px-2 py-1 text-white hover:bg-black/60 focus:ring-2 focus:ring-white/70 focus:outline-none",children:"›"}),e.jsxs("div",{className:"pointer-events-none absolute start-1/2 bottom-2 -translate-x-1/2 rounded-md bg-black/40 px-2 py-0.5 text-xs text-white",children:[u+1," / ",a.length]})]})]})}const Qe=Xe(()=>Je(()=>import("./eohx4aye08k34pt6.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39])).then(t=>t.WhamTaskPageCodeDiffContent),{loading:()=>e.jsx("div",{className:"flex-1"})});function Ma({currentTab:t,setCurrentTab:s,defaultTab:r,isMobile:a,hasDiff:n,previewImages:i,diffFiles:u,unifiedDiff:o,handleDiffModeChange:d,showFullDiff:c,setShowFullDiff:l,isPreferencesLoading:h,isSharedExampleTask:k,focusedAssistantTurn:p,leftContent:b}){const{taskId:g,canFollowUp:P}=ie(),{comments:x,setComments:I}=Oe(),v=O();return f.useEffect(()=>{Qe.prefetch()},[h]),e.jsx("div",{className:"relative flex h-full w-full flex-col",children:e.jsxs(ra,{onChange:s,currentTab:t,defaultTab:r,tabs:[{key:"chat",isHidden:!a,label:v.formatMessage({id:"wham.whamTaskPageContentLoaded.conversation",defaultMessage:"Conversation"}),ariaLabel:v.formatMessage({id:"wham.whamTaskPageContentLoaded.conversationAriaLabel",defaultMessage:"Tab to view the conversation with the assistant"}),children:b},{key:"preview",isHidden:i.length===0,label:v.formatMessage({id:"wham.whamTaskPageContentLoaded.preview",defaultMessage:"Preview"}),ariaLabel:v.formatMessage({id:"wham.whamTaskPageContentLoaded.previewAriaLabel",defaultMessage:"Tab to view preview images"}),children:e.jsx(Ca,{previewImages:i})},{key:"diff",isHidden:!n,label:v.formatMessage({id:"wham.whamTaskPageContentLoaded.diff",defaultMessage:"Diff"}),ariaLabel:v.formatMessage({id:"wham.whamTaskPageContentLoaded.diffAriaLabel",defaultMessage:"Tab to view the code diff"}),children:!h&&n&&e.jsx(Qe,{diffFiles:u,unifiedDiff:o,enableComments:P,comments:x,setComments:I})},{key:"logs",isHidden:k,label:v.formatMessage({id:"wham.whamTaskPageContentLoaded.logs",defaultMessage:"Logs"}),ariaLabel:v.formatMessage({id:"wham.whamTaskPageContentLoaded.logsAriaLabel",defaultMessage:"Tab to view the work logs"}),children:e.jsx(Gt,{taskId:g,focusedAssistantTurn:p,agentNetworkAccess:p?.environment?.agent_network_access})},{key:"internal_rollout",isHidden:p?.internal_only_rollouts==null||!0,label:v.formatMessage({id:"wham.whamTaskPageContentLoaded.internalRollout",defaultMessage:"Internal Rollout"}),ariaLabel:v.formatMessage({id:"wham.whamTaskPageContentLoaded.internalRolloutAriaLabel",defaultMessage:"Tab to view the internal rollout information"}),children:e.jsx("div",{className:"flex h-full w-full overflow-auto p-4",children:e.jsx(sa,{json:p?.internal_only_rollouts??void 0,jsonViewProps:{collapsed:5}})})}],children:[e.jsx(na,{withUnderline:a,className:"items-center border-b p-3 pe-16 max-md:py-0",children:n&&e.jsx(ya,{unifiedDiff:o,setUnifiedDiff:d,showFullDiff:c,setShowFullDiff:l})}),e.jsx(oa,{children:({content:F})=>e.jsx("div",{className:"flex h-full w-full",children:F})})]},p?.id??g)})}function Pa({isOpen:t,onConfirm:s,onClose:r,loading:a}){return e.jsx(pt,{isOpen:t,onClose:r,testId:"modal-wham-retry-all-turns",type:"warning",title:e.jsx("p",{className:"text-token-text-primary font-semibold",children:e.jsx(_,{id:"wham.retryAllTurnsModal.title",defaultMessage:"Retry all turns"})}),primaryButton:e.jsx(J,{color:"primary",loading:a,onClick:s,children:e.jsx(_,{id:"wham.retryAllTurnsModal.confirm",defaultMessage:"Retry all turns"})}),secondaryButton:e.jsx(J,{color:"secondary",onClick:r,children:e.jsx(_,{id:"wham.retryAllTurnsModal.cancel",defaultMessage:"Cancel"})}),children:e.jsx("div",{className:"text-sm",children:e.jsx(_,{id:"wham.retryAllTurnsModal.message",defaultMessage:"All latest turns will restart, including any siblings turns that are in progress or completed."})})})}function ja({focusedAssistantTurn:t,lastTurn:s,siblings:r}){const a=s?.type==="assistant"?s.turn_status:"completed";return t&&(s?.id===t.id||r.some(i=>i.id===s?.id))?t.turn_status:a}function Ta({turnId:t,comments:s,clearComments:r,lastTurn:a,focusedAssistantTurn:n,retry:i,attemptIndex:u,siblings:o}){const{taskId:d,setFocusedAssistantTurnId:c}=ie(),l=qe(),h=O(),k=te(),p=gt(),b=xt(),g=da(),P=j=>{_t(vt(b)),r(),c(j.turn.id)},x=async()=>{if(i){C(!0);try{if(i.previousTurnId){const j=await q.createFollowUpTask(d,i.previousTurnId,i.prompt,i.comments??[],!1,B?i.bestOfN??1:void 0,g?i.attachments:[]);P(j)}else{const j=await q.createNewTask(i.environmentId,i.branch,i.prompt,!1,B?i.bestOfN:void 0,g?i.attachments:[]);l(`/codex/tasks/${j.task.id}`)}M(!1)}catch(j){j instanceof Fe?Re(j,t,h,k):k.danger({id:"wham.whamTaskPageFooter.errorRetryingTask",defaultMessage:"Error retrying task",description:"Error retrying task"},{toastId:"wham_task_page_footer_error_retrying_task"})}finally{C(!1)}}},I=!!n&&Ee(n.output_items).outputDiffs.length>0,v=!a||!n||a.id===n?.id||!I,F=i&&v&&n?.turn_status==="failed",S=n?.previous_turn_id&&a?.type==="assistant"&&n.previous_turn_id===a.previous_turn_id,[N,C]=f.useState(!1),[U,M]=f.useState(!1),R=_e(),E=X(R,"1406552515"),G=X(R,"879591222")||void 0,B=X(R,"3492040717"),H=f.useMemo(()=>{const j=[...n?.output_items?.find(T=>T.type==="review")?.suggested_followup_tasks??[],...n?.output_items?.filter(T=>T.type==="suggested_task")??[]],V=Vt(n?.child_turns?.filter(T=>T.source.type==="suggested_task")?.map(T=>[T.source.suggested_task_id,T]));return j.map(T=>({suggestion:T,userTurnId:T.id?V[T.id]?.assistant_turn_id??null:null,assistantTurnId:T.id?V[T.id]?.user_turn_id??null:null}))},[n]),W=ja({focusedAssistantTurn:n,lastTurn:a,siblings:o}),ae=o?.map(j=>j.turn_status)??[];return a?.type==="assistant"&&["pending","in_progress"].includes(a.turn_status)&&!G?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"wham-message-modal-footer",className:"z-50 flex w-full justify-center",children:[(v||S)&&e.jsx("div",{className:"flex w-full justify-center px-4",children:e.jsx("div",{className:Y("relative z-1 flex w-full flex-col pt-2 pb-4",Le),children:F?e.jsx(J,{className:"w-full",color:"primary",size:"large",loading:N&&!U,onClick:()=>{(i?.bestOfN??1)>1?M(!0):x()},children:(i.bestOfN??1)>1?h.formatMessage({id:"wham.whamTaskPageFooter.retryAllTurns",defaultMessage:"Retry all turns"}):h.formatMessage({id:"wham.whamTaskPageFooter.retry",defaultMessage:"Retry"})}):r&&e.jsxs("div",{className:"flex w-full flex-col gap-3",children:[e.jsx(ua,{}),!E&&e.jsx(ca,{disableAutoFocus:!0,disableDuringSubmit:!0,onSuccess:P,onClearComments:r,followUp:{taskId:d,turnId:t,comments:s,turnStatus:W,siblingTurnStatuses:ae,followUpSuggestions:H},attemptIndex:u,ariaLabel:h.formatMessage({id:"wham.whamTaskPageFooter.composerAriaLabel",defaultMessage:"Composer to enter a follow up prompt to the task"})})]})})}),!v&&!S&&e.jsx(et.div,{layout:!0,className:Y("dark mx-6 mb-6 w-full",Le),initial:{opacity:0,translateY:10},animate:{opacity:1,translateY:0},exit:{opacity:0,translateY:10},transition:{duration:p?0:.25},children:e.jsx(wt,{title:e.jsx(_,{id:"wham.whamTaskPageFooter.previousTurn",defaultMessage:"You are viewing a previous turn"}),primaryCtaText:e.jsx(_,{id:"wham.whamTaskPageFooter.viewLatestTurn",defaultMessage:"View latest"}),content:e.jsx(_,{id:"wham.whamTaskPageFooter.followUpsLatestTurn",defaultMessage:"Follow-ups are only available for the latest turn"}),icon:e.jsx(la,{className:"icon"}),onPrimaryCtaClick:()=>c(a.id)})})]}),e.jsx(Pa,{isOpen:U,onClose:()=>M(!1),onConfirm:x,loading:N})]})}const it=window.location.origin+"/s/";function Sa(t){return`${it}${t}`}function lt(t){return!t||!t.attachments||t.attachments.length===0||t.attachments[0].kind!=="codex"?null:{postId:t.id,permalink:t.permalink??Sa(t.id),permissions:t.permissions.share_setting??"public",codexTask:t.attachments[0].task,codexTurn:t.attachments[0].turns}}function oe(t){return["codex_tasks","result","share",t]}function Ia({taskId:t,enabled:s}){return St({enabled:!!t&&s,queryKey:oe(t),queryFn:async()=>{const r=await Be.safeGet("/share/post/by_codex_task/{codex_task_id}",{parameters:{path:{codex_task_id:t}}});return r.post?lt(r.post):null}})}function Na({taskId:t,onSuccess:s,onError:r}){return ee({scope:{id:t},mutationFn:()=>q.forkSharedTask(t),onSuccess:s,onError:r})}function Da({taskId:t,turnId:s,onSuccess:r,onError:a}){return ee({scope:{id:t},mutationFn:async()=>{const n=await Be.safePost("/share/post",{requestBody:{attachments_to_create:[{kind:"codex",codex_task_id:t,current_codex_turn_id:s}]}});return lt(n.post)},onSuccess:r,onError:a})}function La({taskId:t,sharedResult:s}){const r=ke();return ee({scope:{id:s?.postId??""},mutationFn:async({sharedResultId:a,access:n})=>(await Be.safePost("/share/post/update_access",{requestBody:{post_id:a,share_settings:n}})).share_setting,onMutate:({access:a})=>{const n=oe(t),i=r.getQueryData(n);return r.setQueryData(n,i&&{...i,permissions:a}),{previousAccess:i?.permissions}},onSuccess:a=>{const n=oe(t),i=r.getQueryData(n);i&&r.setQueryData(n,{...i,permissions:a})},onError:(a,n,i)=>{const u=oe(t),o=r.getQueryData(u);r.setQueryData(u,o&&{...o,permissions:i?.previousAccess??"public"})}})}function Fa({taskId:t}){const s=O(),r=te(),a=qe(),{mutate:n}=Na({taskId:t,onSuccess:i=>{i?.task?.id&&a(`/codex/tasks/${i?.task?.id}`)},onError:()=>{r.danger(s.formatMessage({id:"wham.codexForkButton.failedToFork",defaultMessage:"Failed to fork task"}))}});return e.jsx(J,{size:"small",color:"secondary",type:"button",className:"px-3 py-2",onClick:()=>n(),children:e.jsx(_,{id:"wham.share.taskForkButton",defaultMessage:"Fork"})})}const Ra=`${it}...`;function Ba({taskId:t,turnId:s,isLoading:r,sharedResult:a,title:n}){const[i,u]=f.useState(!1),o=(x,I)=>{x&&Ut(x,void 0,I).then(()=>{u(!0),setTimeout(()=>u(!1),1500)}).catch(()=>{})},d=ke(),c=te(),{mutate:l,isPending:h}=Da({taskId:t,turnId:s,onSuccess:x=>{if(!x){c.danger("Failed to create share link");return}d.setQueryData(oe(t),x),o(x.permalink)}}),{mutate:k}=La({taskId:t,sharedResult:a}),p=f.useRef(null),b=x=>{p.current?.focus(),a?o(a.permalink,x):l()},g=x=>{a&&k({sharedResultId:a.postId,access:x})},P=x=>{switch(x){case"public":return Pe.PUBLIC;case"private":return Pe.PRIVATE;case"workspace":return Pe.WORKSPACE}};return e.jsx(ga,{inputRef:p,isLoading:r,isPublishedVersionLatest:!0,sharedObject:a&&{id:a.postId,title:n,access:P(a.permissions)},title:n,shareTextPlaceholder:Ra,shareUrl:a?.permalink,isCopySuccessful:i,isCreateLinkRequestInProgress:h,handlePrivacyChange:g,handlePrimaryButtonClick:b})}function qa({taskId:t,turnId:s,isDisabled:r,title:a}){const n=ve(),i=kt(),u=O(),[o,d]=f.useState(!1),{data:c,isLoading:l}=Ia({taskId:t,enabled:o&&!r}),{triggerRef:h,container:k}=bt({isOpen:o,onClose:()=>d(!1)}),p=i?.isWorkspaceAccount()&&!i?.features.includes(yt.WorkspaceShareLinks);return r||p?e.jsx(Ze,{label:p?u.formatMessage(he.workspaceSharingDisabled):u.formatMessage(he.share),children:e.jsx(De,{disabled:!0,icon:Rt,"aria-label":u.formatMessage(p?he.workspaceSharingDisabled:he.share)})}):e.jsxs(Bt,{open:o,onOpenChange:d,children:[e.jsx(qt,{ref:h,asChild:!0,children:n?e.jsx(De,{icon:Ue,"aria-label":u.formatMessage({id:"wham.whamTaskPageHeader.shareAriaLabel",defaultMessage:"Share task"})}):e.jsx(J,{icon:Ue,color:"ghost","aria-label":u.formatMessage({id:"wham.whamTaskPageHeader.shareAriaLabel",defaultMessage:"Share task"}),children:e.jsx(_,{id:"wham.whamTaskPageHeader.share",defaultMessage:"Share"})})}),e.jsx(It,{children:o&&e.jsx(Et,{forceMount:!0,container:k,children:e.jsx(Ot,{align:"end",className:"z-50",sideOffset:8,collisionPadding:8,children:e.jsx(Ba,{title:a,taskId:t,turnId:s,sharedResult:c,isLoading:l})})})})]})}function Ea({assistantTurn:t}){const s=O(),r=te(),a=ve(),n=t?.pull_request_data?.head??t?.branch??"",i=ha(n),u=n&&n!==i,{outputDiffs:o}=Ee(t?.output_items),d=o[0],c=t?.base_commit_sha??t?.pull_request_data?.base_sha??d?.base_commit_sha;if(a||!n)return null;const l=c!=null&&n!==c,k=l?e.jsx("span",{className:"text-token-text-secondary hover:text-token-text-primary cursor-pointer",onClick:()=>{navigator.clipboard.writeText(c??""),r.success(s.formatMessage({id:"wham.baseSha.copied",defaultMessage:"Copied branch commit SHA to clipboard"}))},children:c}):u?n:void 0;return e.jsx(Ze,{label:k,side:"bottom",disabled:!k,interactive:l,children:e.jsx("span",{className:"text-token-text-secondary hover:text-token-text-primary cursor-pointer truncate",onClick:()=>{navigator.clipboard.writeText(n),r.success(s.formatMessage({id:"wham.branchName.copied",defaultMessage:"Copied branch name to clipboard"}))},children:i})})}const Oa=({assistantTurn:t})=>{const s=O(),r=f.useMemo(()=>t?.created_at?new Date(t.created_at*1e3):null,[t?.created_at]),a=f.useMemo(()=>r?.getFullYear()===new Date().getFullYear(),[r]);return r?r.toLocaleDateString(s.locale,{month:"short",day:"numeric",year:a?void 0:"numeric"}):null},Ua=({title:t,assistantTurn:s})=>{const{linesAdded:r,linesRemoved:a}=rt(s),n=s?.environment?.label;return e.jsxs("div",{className:"flex min-w-0 flex-col text-sm",children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"truncate font-medium",children:t})}),e.jsxs("div",{className:"flex gap-2 max-md:flex-wrap max-md:gap-1",children:[e.jsx("span",{className:"text-token-text-secondary truncate empty:hidden max-md:hidden",children:e.jsx(Oa,{assistantTurn:s})}),e.jsx("span",{className:"text-token-text-secondary max-md:hidden","aria-hidden":"true",children:" · "}),e.jsx("span",{className:"text-token-text-secondary truncate",children:n}),!!n&&e.jsx("span",{className:"text-token-text-secondary","aria-hidden":"true",children:" · "}),e.jsx(Ea,{assistantTurn:s}),e.jsx("span",{className:"max-md:hidden",children:e.jsx(Xt,{linesAdded:r,linesRemoved:a})})]})]})},Wa=({copyApplyToClipboard:t,copyPatchToClipboard:s,createPr:r,updateBranch:a,navigateToCreatingPrPage:n,canCreatePr:i,isCreatingPr:u,permissions:o,assistantTurn:d,showOnlyViewPr:c})=>{const l=_e(),h=O(),k=X(l,"296452287"),p=e.jsxs(e.Fragment,{children:[a&&i&&e.jsx(L.Item,{icon:K,onClick:()=>r(),"aria-label":h.formatMessage(y.createNewPr),children:e.jsx("div",{className:"flex items-center gap-1.5",children:e.jsx(_,{...y.createNewPr})})}),e.jsx(L.Item,{icon:je,onClick:()=>t(),"aria-label":h.formatMessage(y.copyGitApply),children:e.jsx(_,{...y.copyGitApply})}),e.jsx(L.Item,{icon:je,onClick:()=>s(),"aria-label":h.formatMessage(y.copyPatch),children:e.jsx(_,{...y.copyPatch})})]});return c?d?.pull_request_data?.url?e.jsx(J,{icon:K,onClick:()=>{d?.pull_request_data?.url&&window.open(d.pull_request_data.url,"_blank")},children:e.jsx(_,{...y.viewPullRequest})}):null:!i||o==="read"?e.jsx(ne,{buttonIcon:Wt,onClick:()=>t(),triggerButtonAriaLabel:y.openDropdown,dropdownContent:e.jsx(L.Item,{icon:je,onClick:()=>s(),"aria-label":h.formatMessage(y.copyPatch),children:e.jsx(_,{...y.copyPatch})}),children:e.jsx(_,{...y.copyGitApply})}):u?e.jsx(ne,{buttonIcon:Ye,onClick:n,dropdownContent:p,triggerButtonAriaLabel:y.openDropdown,children:e.jsx(_,{...y.viewPullRequest})}):d?.pull_request_data?.url&&d?.pull_request_status!=="not_created"?e.jsx(ne,{buttonIcon:K,as:"a",href:d.pull_request_data.url,dropdownContent:p,triggerButtonAriaLabel:y.openDropdown,children:e.jsx(_,{...y.viewPullRequest})}):a?e.jsx(ne,{buttonIcon:K,onClick:()=>a(),dropdownContent:p,triggerButtonAriaLabel:y.openDropdown,children:e.jsx(_,{...y.updateExistingBranch})}):e.jsx(ne,{buttonIcon:K,onClick:()=>r(),"aria-label":h.formatMessage(y.createPr),triggerButtonAriaLabel:y.openDropdown,dropdownContent:e.jsxs(e.Fragment,{children:[e.jsx(L.Item,{icon:K,onClick:()=>r("draft"),"aria-label":h.formatMessage(y.createDraftPr),children:e.jsx(_,{...y.createDraftPr})}),k&&e.jsx(L.Item,{icon:K,onClick:()=>r("auto_merge"),"aria-label":h.formatMessage(y.createAutoMergePr),children:e.jsx(_,{...y.createAutoMergePr})}),e.jsx(L.Separator,{}),p]}),children:e.jsx(_,{...y.createPr})})},y=Nt({copyGitApply:{id:"wham.whamTaskPushDiffDropdown.copyGitApply",defaultMessage:"Copy git apply"},copyPatch:{id:"wham.whamTaskPushDiffDropdown.copyPatch",defaultMessage:"Copy patch"},viewPullRequest:{id:"wham.message.modal.footer.viewPr",defaultMessage:"View PR"},createPr:{id:"wham.message.modal.footer.createPrItem",defaultMessage:"Create PR"},createNewPr:{id:"wham.whamTaskPushDiffDropdown.createNewPr",defaultMessage:"Create new PR"},createDraftPr:{id:"wham.message.modal.footer.createDraftPr",defaultMessage:"Create draft PR"},createAutoMergePr:{id:"wham.message.modal.footer.createAutoMergePr",defaultMessage:"Create auto-merged PR"},updateExistingBranch:{id:"wham.whamTaskPushDiffDropdown.updateExistingBranch",defaultMessage:"Update branch"},openDropdown:{id:"wham.whamTaskPushDiffDropdown.openDropdown",defaultMessage:"Open git action menu"}});var Se,Ge;function Aa(){if(Ge)return Se;Ge=1;function t(s){return s&&s.length?s[0]:void 0}return Se=t,Se}var Ie,Ve;function Ha(){return Ve||(Ve=1,Ie=Aa()),Ie}var Qa=Ha();const Ga=Dt(Qa);function Va({focusedAssistantTurn:t,onClose:s,shouldShowShare:r,shouldShowFork:a,permissions:n,title:i,isSharedExampleTask:u=!1}){const{taskId:o,task:d}=ie(),[c,l]=f.useState(t?.pull_request_status==="creating"),[h,k]=f.useState(void 0),p=te(),b=ke(),g=O(),P=Ga(z(t)),x=n==="write",I=ge(w=>w.getTurnsForTask(o).filter(xe)),v=ge(w=>w.getTurnsForTask(o)),F=new Map(v.map(w=>[w.id,w])),S=w=>{if(xe(w)){const m=d?.external_pull_requests;if(m&&m.length)for(let D=m.length-1;D>=0;D--){const Q=m[D];if(Q.assistant_turn_id===w.id)return Q}}const A=w.previous_turn_id?F.get(w.previous_turn_id):void 0;return A?S(A):void 0},N=t?S(t):void 0,{linesAdded:C,linesRemoved:U}=rt(t),{outputDiffs:M,hasPreApplyPatch:R}=Ee(t?.output_items),E=x&&!R,G=t?.output_items?.some(Jt)??!1,B=qe(),H=_e(),W=X(H,"2665240312")||void 0,ae=X(H,"369193424"),V=I.filter(w=>t?.sibling_turn_ids?.includes(w.id)).some(w=>w.pull_request_data?.url),T=ae&&n==="write"&&N&&!N.pull_request.merged&&N.pull_request.state!=="closed"&&N.codex_updated_sha!==""&&(t?.id!==N.assistant_turn_id||t?.pull_request_status==="not_created")&&!V,le=f.useRef(null),{mutate:de,isPending:be}=ee({mutationFn:async()=>{o&&await q.archiveTask(o)},onSuccess:async()=>{await b.invalidateQueries({queryKey:["wham","tasks"]}),await b.invalidateQueries({queryKey:["wham","task",o]}),B("/codex")},onError:()=>{p.danger({id:"wham.whamTaskPageHeader.failedToArchiveTask",defaultMessage:"Failed to archive task",description:"Toast when archive request fails"},{toastId:"wham_task_page_header_failed_to_archive_task"})}}),{mutate:se,isPending:ce}=ee({mutationFn:async()=>{o&&await q.recoverTask(o)},onSuccess:async()=>{await b.invalidateQueries({queryKey:["wham","tasks"]}),await b.invalidateQueries({queryKey:["wham","task",o]})},onError:()=>{p.danger({id:"wham.whamTaskPageHeader.failedToArchiveTask",defaultMessage:"Failed to archive task",description:"Toast when archive request fails"},{toastId:"wham_task_page_header_failed_to_archive_task"})}}),ue=be||ce;f.useEffect(()=>{t?.pull_request_status==="creating"?(l(!0),b.invalidateQueries({queryKey:["wham","task",o,"turns"]})):l(!1)},[o,t?.pull_request_status,b]),st([{key:"copyApplyToClipboard",action:()=>{Z()},actionMessageDescriptor:g.formatMessage({id:"wham.keyboardActions.copyApplyToClipboard",defaultMessage:"Copy git apply"}),group:Ne.Chat,keyboardBinding:[pe.Mod,pe.Shift,";"],enabled:!!P}]);const Z=async()=>{P&&(await navigator.clipboard.writeText(` (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
${P} 
EOF
)`),p.success(g.formatMessage({id:"wham.message.modal.footer.copiedToClipboard",defaultMessage:"Copied git apply command to clipboard"}),{duration:3,hasCloseButton:!0}),t?.id&&(we.recordGitAction("diff-copied",C,U,o,t.id,"regular"),q.copyGitApply(o,t.id,!0)))},me=async()=>{P&&(await navigator.clipboard.writeText(P),p.success(g.formatMessage({id:"wham.whamTaskPageHeader.copiedPatchToClipboard",defaultMessage:"Copied patch to clipboard"}),{duration:3,hasCloseButton:!0}),t?.id&&await q.copyGitApply(o,t.id,!1))},ye=async()=>{if(!N||!t?.id){p.danger({id:"wham.whamTaskPageHeader.noPrToUpdate",defaultMessage:"No PR to update",description:"Toast when no PR is found to update"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_no_pr_to_update"});return}l(!0);try{await q.updatePr(o,t.id,N.id)}catch(w){l(!1),await q.getTaskTurnPR(o,N.assistant_turn_id),w instanceof Fe?Re(w,t.id,g,p):p.danger({id:"wham.whamTaskPageHeader.failedToUpdatePr",defaultMessage:"Failed to update PR",description:"Toast when failed to update PR"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_failed_to_update_pr"})}finally{await b.refetchQueries({queryKey:["wham","tasks"]}),await b.refetchQueries({queryKey:["wham","task",o]}),l(!1)}},Ce=async w=>{if(!t?.id)return;k(w);const A=le.current;try{l(!0),await q.createPr(o,t.id,w),await b.refetchQueries({queryKey:["wham","task"]}),await b.fetchQuery(Zt(o,t.id)).then(m=>{const D=m;D.turn.pull_request_data!=null&&(A&&!A.closed&&D.turn.pull_request_data.url&&A.location.assign(D.turn.pull_request_data.url),Ct({title:D.task.title,clientThreadId:D.turn.conversation_id,subtitle:g.formatMessage({id:"wham.message.modal.footer.prCreatedSuccess",defaultMessage:"Click to view your pull request."}),onClick:()=>{window.open(D.turn.pull_request_data?.url,"_blank")}}))}),we.recordGitAction("pr-created",C,U,o,t.id,w??"regular")}catch(m){l(!1),A?.close(),m instanceof Fe?Re(m,t.id,g,p):p.danger({id:"wham.message.modal.footer.createPrError",defaultMessage:"Failed to create PR",description:"Error message for failed to create PR"},{duration:3,hasCloseButton:!0,toastId:"wham_task_page_header_failed_to_create_pr"})}},Me=()=>{if(!t?.id)return;const w=h?`?mode=${h}`:"";le.current=window.open(`/codex/tasks/${o}/turns/${t.id}/pr${w}`,"_blank")},re=!!ve();return e.jsxs("div",{className:"border-b-token-border-default flex w-full justify-between gap-2 border-b p-3 transition-colors duration-50",children:[e.jsxs("div",{className:"flex min-w-0 flex-shrink max-md:gap-2",children:[s?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"hover:bg-token-bg-tertiary group-radix-state-open:bg-token-bg-tertiary rounded-sm p-2 font-semibold",onClick:s,"aria-label":g.formatMessage({id:"wham.taskPageHeader.goBack",defaultMessage:"Go back to tasks"}),children:e.jsx(fa,{className:"icon-lg text-token-text-secondary"})}),e.jsx("div",{className:"bg-token-border-default my-auto ms-[11px] me-4 h-4 w-[1px] max-md:hidden"})]}):e.jsx("div",{className:"ms-3"}),e.jsx(Ua,{title:i,assistantTurn:t})]}),e.jsxs("div",{className:"relative flex h-10 items-center gap-1.5",children:[!1,a&&t?.id&&e.jsx(Fa,{taskId:o}),W&&t?.id&&x&&(re?e.jsx(De,{icon:d?.archived?We:Ae,onClick:()=>d?.archived?se():de(),disabled:ue,"aria-label":d?.archived?g.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelUnarchive",defaultMessage:"Unarchive Task"}):g.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelArchive",defaultMessage:"Archive Task"})}):e.jsx(J,{color:"ghost",icon:d?.archived?We:Ae,loading:ue,onClick:()=>d?.archived?se():de(),"aria-label":d?.archived?g.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelUnarchive",defaultMessage:"Unarchive Task"}):g.formatMessage({id:"wham.whamTaskPageHeader.ariaLabelArchive",defaultMessage:"Archive Task"}),children:d?.archived?e.jsx(_,{id:"wham.whamTaskPageHeader.unarchive",defaultMessage:"Unarchive"}):e.jsx(_,{id:"wham.whamTaskPageHeader.archive",defaultMessage:"Archive"})})),r&&t?.id&&e.jsx(qa,{taskId:o,turnId:t?.id,isDisabled:!1,title:i??""}),n==="write"&&!re&&e.jsx(ma,{taskId:o}),M.length>0&&!G&&e.jsx(Wa,{isCreatingPr:c,assistantTurn:t,copyApplyToClipboard:Z,copyPatchToClipboard:me,createPr:Ce,navigateToCreatingPrPage:Me,canCreatePr:E,updateBranch:T?ye:void 0,permissions:n,showOnlyViewPr:u}),!re&&!u&&e.jsx(pa,{})]})]})}function $a({focusedAssistantTurn:t,pastTurns:s,showFullDiff:r}){if(!t)return[];const a=Ka(s),n=!r;if(z(t,n).length>0)return fe({assistantTurn:t,followUp:n});if(z(t,!1).length>0)return fe({assistantTurn:t,followUp:!1});if(z(t,!0).length>0)return fe({assistantTurn:t,followUp:!0});let d=$e(t,a);for(;d;){const c=a.get(d);if(c&&xe(c)){const l=z(c,!1),h=z(c,!0);if(l.length>0||h.length>0){const k=l.length===0&&h.length>0;return fe({assistantTurn:c,followUp:k})}d=$e(c,a)}else break}return[]}function Ka(t){const s=new Map;for(const r of t)s.set(r.id,r);return s}function $e(t,s){const r=s.get(t.previous_turn_id??"");return r?r.previous_turn_id??null:null}const Ke=new Set,za=Xe(()=>Je(()=>import("./eohx4aye08k34pt6.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39])).then(t=>t.WhamTaskPageCodeDiffContent),{loading:()=>e.jsx("div",{className:"flex-1"})});function hs({turnId:t,permissions:s,confirmClose:r,setConfirmClose:a,handleClose:n,showForkButton:i,loadingTurnMapping:u,isSharedExampleTask:o=!1}){const{taskId:d,task:c,focusedAssistantTurn:l,pastTurns:h,canFollowUp:k}=ie(),{comments:p,clearComments:b,setComments:g}=Oe(),P=O(),{data:x,isLoading:I}=ea(),v=ke(),[F,S]=f.useState(void 0),N=f.useMemo(()=>z(l,!0).length>0,[l]),[C,U]=Mt(Pt.WhamShowFullDiff,!N,At),M=f.useMemo(()=>$a({focusedAssistantTurn:l,pastTurns:h,showFullDiff:C}),[l,h,C]),R=f.useMemo(()=>l?l.output_items.filter(m=>m.type==="message").flatMap(m=>m.content).filter(m=>m.content_type==="image_asset_pointer_citation").map(m=>({content_type:"image_asset_pointer_citation",asset_pointer:m.asset_pointer,width:m.width,height:m.height,size_bytes:m.size_bytes})):[],[l]),E=l?.turn_status==="failed",G=R.length>0,B=M.length>0,H=ze(h),W=c?c.title??P.formatMessage({id:"wham.whamTaskPageContentLoaded.newTask",defaultMessage:"New Task"}):null,ae=te(),j=!!ve(),V=j||x?.git_diff_mode==="unified",T=_e(),le=X(T,"3673716873");f.useEffect(()=>{const m=l?.id;m&&!Ke.has(m)&&l?.turn_status==="completed"&&(Ke.add(m),q.markTurnViewed(d,m))},[l?.id,d,l?.turn_status]);const{mutate:de}=ee({mutationFn:m=>q.updateUserPreferences(m),onSuccess:async()=>{await ta(v)},onError:()=>{ae.danger({id:"wham.whamTaskPageContentLoaded.failedToUpdatePreferences",defaultMessage:"Failed to update preferences",description:"Failed to update preferences error message"},{toastId:"wham_task_page_content_loaded_failed_to_update_preferences"})}}),be=m=>{de({diffView:m?"unified":"split"})},se=G?"preview":j?"chat":B?"diff":void 0,[ce,ue]=f.useState(!1);!ce&&c&&(ue(!0),S(se));const Z=l?.turn_status?at(l?.turn_status):null,me=f.useRef(!1);f.useEffect(()=>{Z===!1?me.current=!0:Z===!0&&me.current&&B&&S("diff")},[Z]);const ye=f.useMemo(()=>{if(E&&l?.environment_id&&l?.branch){const m=[...h].reverse().find($=>$.type==="user"),Q=m?.input_items.find($=>$.type==="message")?.content.find($=>$.content_type==="text")?.text,dt=m?.input_items.filter($=>$.type==="comment"),ct=(l?.sibling_turn_ids?.length??0)+1,ut=$t(m?.input_items??[]);return{environmentId:l?.environment_id,branch:l?.branch,previousTurnId:m?.previous_turn_id,prompt:Q??"",comments:dt??[],bestOfN:ct,attachments:ut}}},[E,l,h]),{attemptIndex:Ce,siblings:Me}=f.useMemo(()=>{if(!l)return{attemptIndex:null,hasSiblingTurns:!1};const m=h.filter(Q=>xe(Q)&&!!Q.sibling_turn_ids?.includes(l.id)),D=m.findIndex(Q=>Q.id===l.id);return{attemptIndex:D===-1?null:D+1,siblings:m}},[l,h]),re=s==="write"?e.jsx(Ta,{turnId:l?.id??t,comments:p,clearComments:b,focusedAssistantTurn:l,lastTurn:H,retry:ye,attemptIndex:Ce,siblings:Me??[]}):null,w=e.jsx(ba,{currentTab:F,permissions:s,onClickFile:()=>S("diff"),onTabChange:m=>S(m),showFullDiff:C,loadingTurnMapping:u,footer:re}),A=e.jsx(Ma,{currentTab:F,setCurrentTab:m=>S(m),defaultTab:se,isMobile:j,hasDiff:B,previewImages:R,diffFiles:M,unifiedDiff:V,handleDiffModeChange:be,showFullDiff:C,setShowFullDiff:U,isPreferencesLoading:I,isSharedExampleTask:o,focusedAssistantTurn:l,leftContent:w});return e.jsxs(e.Fragment,{children:[e.jsxs(et.div,{className:Y("relative flex size-full flex-1 flex-col items-center",j?"[--right-bg:var(--bg-primary)]":"[--right-bg:var(--bg-tertiary)] dark:[--right-bg:black]"),...Ht,children:[e.jsx(Va,{title:W,focusedAssistantTurn:l,onClose:n?()=>n?.({force:!0}):void 0,permissions:s,shouldShowShare:le&&s==="write",shouldShowFork:!!i,isSharedExampleTask:o}),e.jsx("div",{className:"bg-token-bg-primary flex min-h-0 w-full flex-1",children:!c||!ce?e.jsx(jt,{}):j?A:e.jsx(Kt,{leftContent:w,rightContent:o&&B?e.jsx("div",{className:"relative h-full w-full bg-[var(--right-bg)]",children:e.jsx(za,{diffFiles:M,unifiedDiff:V,enableComments:k,comments:p,setComments:g})}):F?e.jsxs("div",{className:"relative h-full w-full bg-[var(--right-bg)]",children:[A,e.jsx(Qt,{className:"absolute end-3 top-2.5",icon:e.jsx(Tt,{}),label:P.formatMessage({id:"wham.whamTaskPageContentLoaded.close",defaultMessage:"Close"}),onClick:()=>S(void 0)})]}):void 0})})]}),r&&a&&n&&e.jsx(zt,{setConfirmClose:a,handleClose:n})]})}function ps({taskId:t,task:s,currentUserTurn:r,currentAssistantTurn:a}){const n=ge(l=>l.addTurnToTaskMap),i=ge(l=>l.getTurnsForTask),[u,o]=f.useState(a?.id??s?.current_turn_id??null);f.useEffect(()=>{t&&(a&&["pending","in_progress","failed"].includes(a.turn_status)?o(a.id):o(a?.id??null),r&&n(t,r),a&&n(t,a))},[a,r,t,n]);let c=i(t??"")?.filter(l=>l.type==="assistant")?.find(l=>l.id===u)??null;return c||(c=a),{focusedAssistantTurn:c,setFocusedAssistantTurnId:o}}export{fs as T,ms as W,ps as a,hs as b,Oe as u};
//# sourceMappingURL=ccdmd6bzhnx5atrg.js.map

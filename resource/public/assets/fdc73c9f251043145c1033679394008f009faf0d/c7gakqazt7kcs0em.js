import{h as D,j as e,f as R,r as j,M as p,p as Ne,v as Se}from"./juy90og0wtbp77qa.js";import{i1 as ke,B as h,aC as M,hc as Pe,aS as ie,g8 as Te,la as Ce,b3 as Ie,$ as re,eZ as ze,fL as Ae,ak as Le,kR as Ee,hj as Fe,h8 as Be,ga as De,ik as Re,dM as Ve,bW as F,bX as Oe,bA as Ge,i2 as Je,fJ as $e}from"./or7jf62i5kvok6pm.js";import{L as Ue,M as We,a as ee}from"./jxnsuo98r1og4iiw.js";import{hn as oe,dP as He,jx as Ke,ak as Qe,b4 as P,b3 as qe,f5 as le,b5 as Xe,bz as de,jy as Ze}from"./kax7wcp9i7f7jtvz.js";const Ye=M.div`h-px bg-token-border-default`,v=M.div`text-sm font-medium py-3 leading-6`,et=M.div`my-4 p-5 w-full rounded-2xl popover bg-token-main-surface-primary shadow-lg border border-token-border-default`,$=":",tt=({to:t,cc:s,bcc:a,subject:n,body:i,onClick:r,isDraft:l=!0,isCanceled:d=!1})=>{const c=D(),f=[];return t&&f.push(e.jsx("div",{children:e.jsxs("div",{className:"flex",children:[e.jsxs(v,{className:"text-token-text-tertiary me-1",children:[c.formatMessage(w.draftToFieldLabel),$]}),e.jsx(v,{children:t})]})},"to")),s&&f.push(e.jsx("div",{children:e.jsxs("div",{className:"flex",children:[e.jsxs(v,{className:"text-token-text-tertiary me-1",children:[c.formatMessage(w.draftCcFieldLabel),$]}),e.jsx(v,{children:s})]})},"cc")),a&&f.push(e.jsx("div",{children:e.jsxs("div",{className:"flex",children:[e.jsxs(v,{className:"text-token-text-tertiary me-1",children:[c.formatMessage(w.draftBccFieldLabel),$]}),e.jsx(v,{children:a})]})},"bcc")),n&&f.push(e.jsx(v,{children:n},"subject")),i&&f.push(e.jsx(v,{className:"whitespace-pre-line",children:i},"body")),e.jsxs(et,{children:[e.jsxs("div",{className:"mb-4 flex items-center",children:[e.jsx(ke,{className:"icon-sm me-4"}),e.jsx("div",{className:"font-semibold",children:l?c.formatMessage(w.draftMessageLabel):c.formatMessage(w.sentMessageLabel)})]}),f.map((_,T)=>e.jsxs(j.Fragment,{children:[e.jsx(Ye,{}),_]},T)),l&&!d&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(h,{color:"primary",className:"py-2",onClick:r,children:c.formatMessage(w.sendButton)})}),d&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(h,{color:"primary",className:"py-2",disabled:!0,children:c.formatMessage(w.canceledButton)})})]})},w=R({draftMessageLabel:{id:"emailView.draftMessageLabel",defaultMessage:"Draft Message"},sentMessageLabel:{id:"emailView.sentMessageLabel",defaultMessage:"Sent Message"},sendButton:{id:"emailView.sendButton",defaultMessage:"Send"},draftToFieldLabel:{id:"emailView.draftToLabel",defaultMessage:"To"},draftCcFieldLabel:{id:"emailView.draftCcLabel",defaultMessage:"Cc"},draftBccFieldLabel:{id:"emailView.draftBccLabel",defaultMessage:"Bcc"},canceledButton:{id:"emailView.canceledButton",defaultMessage:"Canceled"}});function st({action:t,handleUserAction:s,userActionParams:a,displayParams:n}){const i=Pe();return t.type==="deny"?e.jsx(h,{color:"secondary",size:"small",onClick:r=>{s({sourceEvent:r,...a,actionData:{type:"deny",...t.deny}})},children:e.jsx(p,{...t.name==="decline"?b.decline:b.deny})}):t.type==="allow"?e.jsx(h,{color:"primary",size:"small",onClick:r=>{s({sourceEvent:r,...a,actionData:{type:"allow",...t.allow}})},children:e.jsx(p,{...t.name==="allow"?b.allow:b.confirm})}):t.type==="always_allow"?e.jsx(h,{color:"secondary",size:"small",onClick:r=>{s({sourceEvent:r,...a,actionData:{type:"always_allow",...t.always_allow}})},children:e.jsx(p,{...b.alwaysAllow})}):t.type==="oauth_redirect"?n.connector?e.jsx(at,{connector:n.connector,onClick:()=>{const r=ie(a.clientThreadId),l=r?new URL(oe(r),window.location.origin):new URL(window.location.href);l.searchParams.set("oauth_success","true"),i({connectorId:n.connector?.id,redirectAfter:l.toString()})}}):e.jsx(h,{color:"primary",size:"small",onClick:()=>{nt(t.oauth_redirect,a.clientThreadId,a.turnGizmo)},children:e.jsx(p,{...b.signInButton,values:{domain:n.domain}})}):t.type==="contact_gizmo"?e.jsx(h,{color:"secondary",size:"small",onClick:r=>{s({sourceEvent:r,...a,actionData:{type:"contact_gizmo",...t.contact_gizmo}})},children:e.jsx(p,{...b.allow})}):null}function at({connector:t,onClick:s}){const a=D();return e.jsxs("div",{className:"flex w-80 flex-col items-center rounded-xl border p-6 text-center",children:[e.jsx(Te,{connector:t,size:"large",className:"bg-primary shadow-xxs max-h-fit rounded-2xl border bg-clip-padding p-2"}),e.jsx("div",{className:"text-token-text-primary mt-3 text-lg font-semibold",children:Ce(t.name,a)}),e.jsx("div",{className:"text-token-text-secondary mt-1 text-sm",children:t.description}),e.jsx(h,{className:"mt-4 w-full",color:"secondary",onClick:s,children:e.jsx(p,{...b.connectButton})})]})}function nt(t,s,a){const n=Ie(s),i=ie(s),r=n?.mode?.kind===re.GizmoTest,l=i&&!r?oe(i,a):window.location.href;t.gizmo_id==="FAKE_PLUGIN_GIZMO"?ze({id:t.gizmo_action_id},l):He.doOAuthRedirect(t.gizmo_id,t.gizmo_action_id,t.domain,l,r)}const b=R({alwaysAllow:{id:"jitPluginMessage.alwaysAllow",defaultMessage:"Always Allow"},allow:{id:"jitPluginMessage.allow",defaultMessage:"Allow"},decline:{id:"jitPluginMessage.decline",defaultMessage:"Decline"},confirm:{id:"jitPluginMessage.confirm",defaultMessage:"Confirm"},deny:{id:"jitPluginMessage.deny",defaultMessage:"Deny"},signInButton:{id:"jitPluginMessage.signInButton",defaultMessage:"Sign in with {domain}"},connectButton:{id:"jitPluginMessage.connectButton",defaultMessage:"Connect"}}),it=({html:t,title:s})=>{const a=j.useRef(null),n=j.useRef(!1),[i,r]=j.useState(null),[l,d]=j.useState(null);return j.useEffect(()=>{!a.current||n.current||(n.current=!0)},[]),j.useEffect(()=>{(async()=>{if(i)for await(const f of i.runHTML(t))console.log("received:",f),f.type===We.SET_INTRINSIC_HEIGHT&&d(f.intrinsicHeight)})()},[i,t]),e.jsx("iframe",{title:s,className:"no-scrollbar w-full border-none",style:{height:l?`${l}px`:"auto"},src:`${Ue}/kanzi-sandbox.html`,sandbox:"allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox",ref:a,tabIndex:-1})},rt=M.div`h-px bg-token-border-default`,te=M.div`text-sm font-medium py-3 leading-6`,ot=M.div`my-4 p-5 w-full rounded-2xl popover bg-token-main-surface-primary shadow-lg border border-token-border-default`,lt=":",dt=({functionName:t,parameters:s,onClick:a,isDraft:n=!0,isCanceled:i=!1})=>{const r=D(),l=Object.entries(s).filter(([d,c])=>!c||d==="timezone_str"&&c===Intl.DateTimeFormat().resolvedOptions().timeZone?!1:c.length>0);return e.jsxs(ot,{children:[e.jsx("div",{className:"mb-4 flex items-center font-semibold",children:e.jsx("div",{children:n?W(t):ct(t,r)})}),l.map(([d,c])=>e.jsxs("div",{children:[e.jsx(rt,{}),e.jsxs("div",{className:"flex",children:[e.jsxs(te,{className:"text-token-text-tertiary me-1",children:[W(d),lt]}),e.jsx(te,{className:"whitespace-pre-line",children:ce(c,r)})]})]},d)),n&&!i&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(h,{color:"primary",className:"py-2",onClick:a,children:r.formatMessage(B.approveButton)})}),i&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(h,{color:"primary",className:"py-2",disabled:!0,children:r.formatMessage(B.canceledButton)})})]})},ct=(t,s)=>{switch(t){case"create_event":return"Created Event ✅";default:return`${W(t)} ${s.formatMessage(B.completedAction)} ✅`}},W=t=>{switch(t){case"timezone_str":return"Timezone";default:return t.split("_").map(s=>s.charAt(0).toUpperCase()+s.slice(1).toLowerCase()).join(" ")}},ce=(t,s)=>{if(Array.isArray(t))return t.map(i=>ce(i,s)).join(s.formatMessage(B.valueSeparator));if(typeof t=="object")return JSON.stringify(t);if(t.match(/^\s*\d{4}-\d{2}-\d{2}/)==null)return t;const n=new Date(t);return Number.isNaN(n.getTime())?t:s.formatDate(n,{weekday:"short",month:"short",day:"numeric",hour:"numeric",minute:"numeric"})},B=R({approveButton:{id:"ParametersView.approveButton",defaultMessage:"Approve"},completedAction:{id:"ParametersView.completedAction",defaultMessage:"Completed"},canceledButton:{id:"ParametersView.canceledButton",defaultMessage:"Canceled"},valueSeparator:{id:"ParametersView.valueSeparator",defaultMessage:","}}),me="openaiFileIdRefs",mt=["send_email","batch_modify_email","create_event","update_event","delete_event"];function wt({messages:t,clientThreadId:s,isLastTurnInConversation:a,onRequestCompletion:n,useFetchConnectorPlatformConnectors:i=Fe}){const[r,l]=Ne(),[d,...c]=t,f=D(),_=Ae(s),T=d.metadata?.gizmo_id??_,C=Le(s,o=>Ze(o?.mode,T)),fe=Ke(C)&&C.gizmo_id===T,I=Qe(T,fe)?.data,H=Ee(d.recipient);let V;if(H?.functionName!=null&&I?.tools!=null){for(const o of I.tools)if(pt(o,H.functionName)){V=o;break}}const ge=c.filter(o=>o.metadata?.jit_plugin_data?.from_server?.type==="debug"),O=c.filter(o=>!["debug","send_test"].some(u=>u===o.metadata?.jit_plugin_data?.from_server?.type)),{uiState:m,jitPluginData:g,fileAttachments:pe,invokedPlugin:K}=gt(d,O,a);let z;for(let o=O.length-1;o>=0;o--){const u=O[o].metadata?.jit_plugin_data;if(u?.from_server?.type==="confirm_action"){z=u;break}}let x=g?.from_server?.type!=="denied_by_user"?g?.from_server?.body.domain:V?.metadata?.domain;const xe=g?.from_server?.type==="oauth_required"?g?.from_server?.body?.connector_id:void 0,Q=i(!0,Be.JIT_PLUGIN).platformConnectors.get(xe??"");x?x.endsWith("__jit_plugin")&&(x=x.slice(0,-12)):x="connector";const he=V?.metadata?.privacy_policy_url;j.useEffect(()=>{if(ue(g?.from_client)?.type==="oauth_success")return;const o=r.get("oauth_success");if(g?.from_server?.type==="oauth_required"&&o){l(u=>(u.delete("oauth_success"),u),{replace:!0});for(const u of g.from_server.body.actions)if(u.type==="oauth_redirect"){U({eventSource:"url",assistantMessage:d,onRequestCompletion:n,actionData:{type:"oauth_success",target_message_id:u.oauth_redirect.target_message_id},conversationMode:C});return}}},[C,d,t,s,n,g,a,r,l]);let N=P.Running,S=x?y.running:y.starting,G={domain:x};if(m===7)return null;m===4||m===5?(N=P.Paused,S=y.confirmingSimple,G={...{gizmoName:I?.gizmo.display.name??"ChatGPT",domain:x},title:u=>e.jsxs("div",{className:"inline-flex items-center gap-1 text-sm",children:[u,e.jsx(de,{className:"icon-sm"})]}),subtitle:u=>e.jsx("div",{className:"text-xs",children:u})}):m===1?(N=P.Finished,S=y.finished,G={domain:x}):m===2?(N=P.Error,S=y.error):(m===3||m===6)&&(N=P.Stopped,S=m===6?y.declined:y.stopped);const q={assistantMessage:d,allMessages:t,clientThreadId:s,turnGizmo:I,onRequestCompletion:n,conversationMode:C},_e={domain:x,connector:Q},X=g?.from_server?.type!=="denied_by_user"?g?.from_server?.body.actions.map((o,u)=>e.jsx(st,{action:o,displayParams:_e,handleUserAction:U,userActionParams:q},u)):null,ye=S?f.formatMessage(S,G):null,je=M.div`flex gap-2 flex-wrap mt-1 empty:hidden`,A=c[c.length-1],J=ne(g)??ne(z),Z=xt(A),ve=J?.[me]??[],be=!!J||!!Z||ve.length>0;let L=e.jsx(e.Fragment,{});const E=se(g,K)??se(z,void 0)??"";if(mt.includes(E)&&(m===5||m===1||m===3||m===6)){const o=m!==1,u=(m===3||m===6)&&!a,k=ae(g,K)??ae(z,void 0),Y=we=>{g?.from_server?.type==="confirm_action"&&g?.from_server?.body?.actions?.[0].type==="allow"&&(U({...q,sourceEvent:we,actionData:{type:"allow",...g?.from_server?.body?.actions?.[0].allow}}),Ge(s,Me=>{Me.scrollToMessageId=s}))};switch(E){case"send_email":L=e.jsx(tt,{to:k?.to,cc:k?.cc,bcc:k?.bcc,subject:k?.subject,body:k?.body,onClick:m===5?Y:()=>{},isDraft:o,isCanceled:u});break;default:L=e.jsx(dt,{functionName:E??"",parameters:k??{},onClick:m===5?Y:()=>{},isDraft:o,isCanceled:u});break}}else(m===5||m===4)&&X&&(L=e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2 flex gap-2",children:X}),!Q&&e.jsxs("div",{className:"my-1 flex items-center gap-2 text-sm",children:[e.jsx(De,{className:"icon-sm"}),e.jsx(p,{...y.confirmingSubtitle})]})]}));return e.jsxs(e.Fragment,{children:[e.jsx(ft,{debugMessages:ge}),e.jsx(qe,{highlightedCommand:ye,status:N,showWorkUserSetting:!1,children:be?e.jsx(ht,{privacyPolicyUrl:he,name:d.recipient??E,params:J,result:Z,isPromptingForPermission:N===P.Paused}):null}),e.jsx(je,{children:pe?.map(o=>e.jsx(le,{file:o.name,fileId:o.id,width:"wide",alwaysShowData:!0,showDownloadButton:!0,downloadLink:o.download_url,contextConnectorInfo:Re(o.context_connector_info)},o.id))}),A&&A.metadata?.chatgpt_sdk?.rendered_template&&e.jsx(it,{html:A.metadata.chatgpt_sdk.rendered_template,title:""}),L]})}function ut({messageMetadata:t}){const[s,a]=j.useState(!1);return e.jsxs("div",{className:"my-2 flex flex-col text-sm",children:[e.jsxs("div",{className:"flex flex-row items-center hover:cursor-pointer",onClick:()=>{a(!s)},children:[s?e.jsx(de,{className:"icon-sm"}):e.jsx($e,{className:"icon-sm"}),e.jsx("div",{className:"font-semibold",children:t.display_message})]}),s&&e.jsx("pre",{children:JSON.stringify(t.data,null,2)})]})}function ft({debugMessages:t}){return t.length===0?null:e.jsx("div",{children:t.map((s,a)=>{const n=s.metadata?.jit_plugin_data?.from_server;return n&&n.type==="debug"?e.jsx(ut,{messageMetadata:n.body},a):null})})}function se(t,s){return t?.from_server?.type==="confirm_action"?t?.from_server?.body?.operation:s?.parsed_function_call?.name}function ae(t,s){return t?.from_server?.type==="confirm_action"?t?.from_server?.body?.params:s?.parsed_function_call?.kwargs}function gt(t,s,a){if(t.metadata?.jit_plugin_data?.from_server?.type==="send_test")return{uiState:7};if(s.some(n=>n.content.content_type===F.SystemError))return{uiState:2};if(Xe(t))return{uiState:3};for(let n=s.length-1;n>=0;n--){const i=s[n];if(i.metadata?.invoked_plugin){const d=[];return s.forEach(c=>{const f=c.metadata?.attachments?.filter(_=>_.display_files_from_actions_ext);f&&d.push(...f)}),{uiState:1,jitPluginData:i.metadata.jit_plugin_data,invokedPlugin:i.metadata.invoked_plugin,fileAttachments:d}}const r=ue(i.metadata?.jit_plugin_data?.from_client);if(r!=null){if(r?.type==="contact_gizmo")return{uiState:1,jitPluginData:s[n-1]?.metadata?.jit_plugin_data};if(r?.type==="deny")return{uiState:6};if(r?.type==="oauth_success")return{uiState:0,jitPluginData:i.metadata?.jit_plugin_data};break}const l=i.metadata?.jit_plugin_data?.from_server;if(l?.type==="preview"&&a)return{uiState:0,jitPluginData:i.metadata?.jit_plugin_data};if(l?.type==="confirm_action"&&a)return{uiState:5,jitPluginData:i.metadata?.jit_plugin_data};if(l?.type==="oauth_required"&&a)return{uiState:4,jitPluginData:i.metadata?.jit_plugin_data}}return{uiState:a?0:3}}function U({actionData:t,assistantMessage:s,turnGizmo:a,onRequestCompletion:n,conversationMode:i,...r}){const l={id:Se(),author:{role:Oe.Tool,name:s.recipient},content:{content_type:F.Text,parts:[""]},recipient:"all",metadata:{jit_plugin_data:{from_client:t},gizmo_id:a?.gizmo.id},clientMetadata:{completionSampleFinishTime:Date.now()}};n({...r,promptMessage:l,completionMetadata:{conversationMode:i??{kind:re.PrimaryAssistant}}})}function pt(t,s){if(t.type!==Ve.JIT_PLUGIN||!t.metadata.json_schema)return!1;let a=!1;function n(i){for(const r in i)r==="operationId"&&i[r]===s&&(a=!0),i[r]&&typeof i[r]=="object"&&n(i[r])}return n(t.metadata.json_schema),a}function ne(t){if(t&&(t.from_server?.type==="confirm_action"||t.from_server?.type==="oauth_required"||t.from_server?.type==="preview"))return t.from_server.body.params}function xt(t){if(!t)return;const s=t.content.content_type===F.Text?t.content.parts[0]:t.content.content_type===F.Code?t.content.text:void 0;if(s)try{return JSON.parse(s)}catch{return s}}function ht({name:t,params:s,result:a,privacyPolicyUrl:n,isPromptingForPermission:i}){const l=(s?.[me]??[]).map((d,c)=>{const f=d.name.startsWith("dalle-");let _=d.name;return f&&(_=`${_}.webp`),e.jsx(le,{file:_,fileId:d.id},c)});return e.jsxs("div",{className:"divide-token-border-default border-token-border-default mt-1 mb-4 divide-y overflow-hidden rounded-xl border",children:[s&&e.jsxs(e.Fragment,{children:[t&&e.jsx("div",{className:"bg-token-bg-tertiary text-token-text-secondary px-4 py-2 text-sm",children:e.jsx(p,{id:"JITPluginMessage.params.toolCall",defaultMessage:"Tool call: {name}",values:{name:e.jsx("span",{className:"text-token-text-primary",children:t})}})}),e.jsxs("div",{className:"bg-token-bg-tertiary text-token-text-secondary flex justify-between px-4 py-2 text-sm",children:[i?e.jsx(p,{id:"JITPluginMessage.params.sharing.present",defaultMessage:"The following will be shared:"}):e.jsx(p,{id:"JITPluginMessage.params.sharing.past",defaultMessage:"The following was shared:"}),n&&e.jsx("a",{href:Je(n),className:"text-token-text-primary",target:"_blank",rel:"noreferrer",children:e.jsx(p,{...y.privacyPolicyLink})})]}),e.jsx("div",{className:"px-4 py-2",children:e.jsx(ee,{value:s})}),l.length>0&&e.jsx("div",{className:"px-4 py-2",children:l})]}),a&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-token-bg-tertiary text-token-text-secondary flex justify-between px-4 py-2 text-sm",children:e.jsx(p,{id:"JITPluginMessage.params.result",defaultMessage:"Result:"})}),e.jsx("div",{className:"px-4 py-2",children:e.jsx(ee,{value:a})})]})]})}function ue(t){if(t&&"user_action"in t){const s=t.user_action;t={...t,...s.data},"target_message_id"in t&&s.target_message_id&&(t.target_message_id=s.target_message_id)}return t}const y=R({starting:{id:"jitPluginMessage.starting",defaultMessage:"Starting action"},confirmingSimple:{id:"jitPluginMessage.confirming.simple",defaultMessage:"{gizmoName} wants to talk to {domain}"},confirmingSubtitle:{id:"jitPluginMessage.confirming.subtitle",defaultMessage:"Only allow sites you trust."},running:{id:"jitPluginMessage.runningV4",defaultMessage:"Talking to {domain}"},finished:{id:"jitPluginMessage.finishedV4",defaultMessage:"Talked to {domain}"},stopped:{id:"jitPluginMessage.stoppedV4",defaultMessage:"Stopped talking to {domain}"},error:{id:"jitPluginMessage.errorV5",defaultMessage:"Error talking to {domain}"},declined:{id:"jitPluginMessage.declined",defaultMessage:"You declined this action"},ranTest:{id:"jitPluginMessage.ranTest",defaultMessage:"Tested {operationName}"},confirmParamsTitle:{id:"jitPluginMessage.confirmParamsTitleV3",defaultMessage:"{gizmoName} wants to share this info with {domain}"},sentParamsTitle:{id:"jitPluginMessage.sentParamsTitleV2",defaultMessage:"{gizmoName} sent this info to {domain}"},privacyPolicyLink:{id:"jitPluginMessage.privacyPolicyLinkV2",defaultMessage:"Privacy policy"}});export{wt as JITPluginMessage};
//# sourceMappingURL=c7gakqazt7kcs0em.js.map

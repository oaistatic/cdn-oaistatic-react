const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/bc0md0wib1cjfmx5.js","assets/juy90og0wtbp77qa.js","assets/kax7wcp9i7f7jtvz.js","assets/or7jf62i5kvok6pm.js","assets/root-ms9lll5g.css","assets/conversation-small-j9iamy23.css","assets/ghzyx04jxko7zqcu.js","assets/g1mzshmp15rgsy0r.js","assets/mj9z9iuqobsziv2h.js","assets/g0j29k77kzjbz76f.js","assets/ocpfit0g1gfti5z4.js","assets/kwrsfo4prmlqgo0w.js","assets/6l5wykugon65myc6.js","assets/fgnsrp7wj3i83g7e.js","assets/klzyif2r6c67lyfu.js","assets/osl7p7pfd29pg5qh.js","assets/khey9wv8trxtr5w5.js","assets/fzazeczfeeq2yus7.js","assets/o899j6tq6eofkz5m.js"])))=>i.map(i=>d[i]);
import{ar as F,e as me,eI as fe,aC as ye,ay as je,bd as ke,D as re,ak as Ne,P as Ee,b2 as te,b3 as he,R as Ae,bA as Ge,bD as Pe,dW as De,lW as Te,cf as Oe,b0 as ze,C as Le,as as pe,at as xe}from"./or7jf62i5kvok6pm.js";import{j as n,m as W,h as K,r as a,A as He,u as ve,p as Ue}from"./juy90og0wtbp77qa.js";import{I as Z,D as Be,a as we,u as Fe}from"./l46kwutoeleonnsb.js";import{hG as qe,dM as $e,pq as We,bM as Ke,bE as B,bO as Qe,bQ as Ve,bG as Ye,pr as Xe,ps as Je,hQ as Ze,f6 as Ie,bF as Se,hR as et,pt as I,kK as tt,pu as ne,fc as nt,pv as at,pw as ce,px as st,py as it}from"./kax7wcp9i7f7jtvz.js";import{C as _e}from"./jbze7lwlszm657iq.js";import{b as ot}from"./g1mzshmp15rgsy0r.js";import{C as rt}from"./mh6p4y5np464yd8j.js";import"./gbryk52yvym6pvzs.js";import"./mj9z9iuqobsziv2h.js";import"./gu6gv8q29qfpkqrc.js";import"./l0ojckr7ctyz3k3l.js";import"./cthaea829w6zpbcu.js";import"./m2ly71nz794qjc4q.js";import"./klzyif2r6c67lyfu.js";import"./pc2givv05uuq8g6l.js";import"./hdclltxvbgzx8xl8.js";import"./bp3e26benx61nzb4.js";import"./b6vbevykvjt8za99.js";import"./osl7p7pfd29pg5qh.js";const be=({children:e,isDimensionsUnknown:t})=>n.jsxs(W.div,{className:F(["relative max-w-[480px] rounded-2xl",t&&"aspect-square overflow-hidden"]),children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]}),ct=({children:e,isDimensionsUnknown:t,width:s,height:o})=>n.jsxs(W.div,{layout:!0,transition:{duration:.3,ease:"easeInOut"},exit:{opacity:0,transition:{duration:.1,ease:"easeInOut"}},className:F(["relative max-w-[480px] overflow-hidden rounded-2xl",t&&"aspect-square"]),style:{width:s??"auto",height:o??"auto"},children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]});function lt(){const[t,s]=a.useState(new Date);a.useEffect(()=>{s(new Date)},[]);const o=qe(+t,12e4);return n.jsx($e,{percentage:o,sizeOverride:30,thickness:1/15,className:"text-white",backgroundStrokeClassName:"stroke-white/20",transitionDuration:`${(100-o)/100*.2}s`,transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})}const Ce=({isGettingStarted:e})=>{const t=K(),s=a.useMemo(()=>e?t.formatMessage({id:"SxQKjt",defaultMessage:"Getting started"}):t.formatMessage({id:"Y3ETLn",defaultMessage:"Creating image"}),[e,t]),o=me(),i=fe(o,"3019066937").get("should_show_cot_header",!1),l=a.useMemo(()=>e?n.jsx(_e,{size:30,arcPercentage:.2,strokeWidth:2}):n.jsx(lt,{}),[e]);return n.jsx("div",{className:F("absolute inset-0 flex items-end justify-between px-6 py-6"),children:n.jsxs(He,{mode:"popLayout",children:[i&&n.jsx(W.span,{className:F("flex items-center gap-1 align-middle text-lg",!e&&"text-white"),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,overflow:"hidden",whiteSpace:"nowrap"},transition:{duration:.1,ease:"easeInOut"},children:s},s),n.jsx("div",{className:"flex flex-1 items-center justify-end",children:l})]})})},le=ye.div`invisible absolute top-3 flex gap-1 group-hover/paragen-image:visible z-2
  ${({$rightAlign:e})=>e?"end-3":"start-3"}
  ${({$alwaysVisible:e})=>e?"visible":""}`,dt=({imageUrl:e})=>{const[t,s]=a.useState(void 0),o=K(),i=We(),l=a.useCallback(()=>{const r=new Date;return`${o.formatDate(r,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}.png`},[o]);return n.jsxs("div",{className:"group/paragen-image absolute inset-0 z-3",children:[n.jsxs(le,{$alwaysVisible:!0,children:[t!==!1&&n.jsx(Z,{icon:Ke,selected:t===!0,variant:"large",onClick:r=>{r.stopPropagation(),B.paragenImageRated({liked:!0,analyticsContext:i}),s(!0)}}),t!==!0&&n.jsx(Z,{icon:Qe,selected:t===!1,variant:"large",onClick:r=>{r.stopPropagation(),B.paragenImageRated({liked:!1,analyticsContext:i}),s(!1)}})]}),n.jsx(le,{$alwaysVisible:!0,$rightAlign:!0,children:n.jsx(Z,{icon:Ve,variant:"large",onClick:r=>{r.stopPropagation(),B.paragenDownload({analyticsContext:i}),Ye({url:e,fileName:l()})}})})]})};function Me({withLottie:e}){const s=K().formatMessage({id:"imagegen.progressIndicator.ariaLabel",defaultMessage:"Generating image..."});return n.jsx("div",{className:"absolute start-0 top-0 flex h-full w-full items-center justify-center rounded-full","aria-label":s,children:n.jsx(_e,{size:40,arcPercentage:.2,children:n.jsx(Be,{animate:e,matchTextColor:!0,className:"h-6 w-6"})})})}const Re=300,ut=1.3,de=.05,gt=/blur\(([\d.]+)px\)/,mt={duration:Re/1e3,ease:"linear"};function ee(e,t,s){e.sort((r,c)=>r.lastSrcReceivedTime-c.lastSrcReceivedTime);const o=new Array(e.length).fill(0);for(let r=0;r<=e.length;r+=1){const c=r-1,p=r,u=e[c]?.availablePercentComplete??0,m=e[p]?.availablePercentComplete??1;if(t>=u&&t<=m&&u!==m){const _=(t-u)/(m-u);o[c]=1-_,o[p]=_}}const i=o[o.length-1],l=o[o.length-2];return i===1&&l===0&&(o[o.length-2]=.01),s&&t<=e[0]?.availablePercentComplete&&(o[0]=1),o}const ft=({alt:e,src:t,availablePercentComplete:s,onAnimationUpdate:o,ignoreFirstChunk:i=!1,isTransparent:l=!1,dimensions:r,onError:c,unconstrainedWidth:p=!1,progressLoaderProps:u})=>{const m=je(),_=a.useMemo(()=>`url(${m?Xe:Je})`,[m]),[S,C]=a.useState(!1),[v,A]=a.useState(1e3),[w,D]=a.useState(s??0),[g,b]=a.useState(s===1?1:0),N=a.useRef(performance.now()),f=a.useRef(0),x=a.useRef([]),[T,j]=a.useState([0]),[H,O]=a.useState(s===1),L=a.useRef(!1),E=a.useRef(null),k=w===1,R=s===1&&H,G=r?r.width/r.height:1;a.useEffect(()=>{!S&&s&&(C(!0),f.current=performance.now())},[S,s]),a.useEffect(()=>{const h=x.current[x.current.length-1]?.src;if(t&&t!==h){const d=x.current.findIndex(M=>M.availablePercentComplete===s);d!==-1?x.current[d]={src:t,availablePercentComplete:s??0,lastSrcReceivedTime:performance.now()}:x.current.push({src:t,availablePercentComplete:s??0,lastSrcReceivedTime:performance.now()}),j(ee(x.current,w,i))}},[t,w,i,s]);const Q=a.useCallback(()=>{E.current&&s&&(A(R?Re:(performance.now()-N.current)*ut),(!i||L.current||s>=de)&&s!==1&&b(s),L.current=!0,N.current=performance.now(),u?.setHasImageReady(!0))},[s,R,i,u]),q=a.useCallback(h=>{const d=parseFloat(h.height)/100;o?.(d),D(d),j(ee(x.current,parseFloat(h.height)/100,i))},[o,i]),V=a.useCallback(h=>{const d=h.filter.toString().match(gt)?.[1]??"0",P=(16-parseFloat(d))/16,J=1-g,Y=g+J*P;o?.(Y),D(Y),j(ee(x.current,Y,i))},[i,g,o]);if(!S)return n.jsx(be,{isDimensionsUnknown:!0,children:n.jsx(Me,{withLottie:!0})});const $={duration:v/1e3,ease:"linear"},z=s!==1||!l;return n.jsxs("div",{className:F("relative z-0 cursor-pointer overflow-hidden",G<1?"max-w-[400px]":"max-w-[480px]",!k&&"pointer-events-none",!L.current&&"bg-token-main-surface-secondary",p&&"max-w-full"),"aria-label":e,style:{aspectRatio:G},children:[!u?.shouldHideDiagonalShimmer&&s&&s<de&&n.jsx("div",{className:"absolute inset-0 z-3 w-full overflow-hidden",children:n.jsx("div",{className:"absolute start-[-150%] top-[-150%] h-[400%] w-[400%]",children:n.jsx("div",{className:"diagonal-sweep-gradient h-full w-full"})})}),n.jsxs(W.div,{className:"absolute start-0 end-0 top-0 z-2 w-full overflow-hidden transition-[mask] ease-linear",initial:R?!1:{height:"0%"},animate:k?{height:"100%"}:{height:`${g*100}%`},onUpdate:R?void 0:q,transition:R?{duration:0,ease:"linear"}:$,style:k?void 0:{mask:"linear-gradient(rgb(0,0,0) 0%, rgb(0,0,0) calc(100% - 24px), rgba(0,0,0,0) 100%)"},children:[t&&n.jsx("img",{ref:E,src:t,onLoad:Q,onError:c,alt:e,className:"absolute top-0 z-1 w-full",style:{aspectRatio:G}}),l&&n.jsx("div",{className:"absolute inset-0 z-0 w-full overflow-hidden opacity-0 transition-opacity duration-300 group-hover/imagegen-image:opacity-100 group-focus/imagegen-image:opacity-100",children:n.jsx("div",{className:"absolute inset-0 bg-repeat",style:{backgroundImage:_,backgroundSize:"auto"}})})]}),n.jsx(W.div,{className:"relative z-1 w-full overflow-hidden",initial:{filter:"blur(16px)"},animate:R?{filter:"blur(0px)"}:void 0,transition:R?mt:void 0,onUpdate:R?V:void 0,style:{aspectRatio:G},children:x.current.map((h,d)=>{const M=T[d],P=h.availablePercentComplete===1;return M!==0||P?n.jsx("img",{src:h.src,alt:e,style:{opacity:M,willChange:"opacity",aspectRatio:G},className:!R&&u?.shouldShowPulseAnimation?"bg-scale-pulse":"",onLoad:P?()=>O(!0):void 0},h.src):null})}),n.jsx(W.div,{className:"absolute inset-0 z-0 scale-110 overflow-hidden blur-2xl",style:{aspectRatio:G},children:z&&x.current.filter((h,d)=>T[d]!==0).map(h=>n.jsx("img",{src:h.src,alt:e,className:"absolute top-0 w-full"},h.src))})]})},ue=2,X=({pointer:e,altLabel:t,isEditorAvailable:s,onPercentageRendered:o,messageId:i,imageIndex:l,clientThreadId:r,serverThreadId:c,onEditorClick:p,compact:u,progressLoaderProps:m})=>{const _=ve(),[S,C]=a.useState(void 0),v=a.useRef(void 0),A=e.metadata?.generation?.gen_id,w=e.metadata?.generation?.height??void 0,D=e.height,g=(w??0)/D,b=a.useRef({}),[N]=Ue(),{isUnauthenticated:f}=ke(),[x,T]=a.useState(!1),j=a.useContext(we),H=e.width/e.height,O=Ze({imageAssetPointer:e,serverThreadId:c}),E=a.useCallback((d=!1)=>{!d&&v.current===e.asset_pointer||(v.current=e.asset_pointer,Ie.fetch(_,{asset:e,conversationId:c,force:d,isUnauthenticated:f}).then(M=>{C(M)}).finally(()=>{v.current=void 0}))},[e,_,c,f,null]);a.useEffect(()=>{const d=e.asset_pointer!==S?.asset_pointer;(!S||d)&&E()},[S,e.asset_pointer,E]);const k=a.useMemo(()=>Se({pointer:S,conversationId:c,messageId:i,source:j?"paragen":"chat",imageIndex:l.toString()}),[S,c,i,j,l]),R=a.useRef(g);a.useEffect(()=>{g===1&&R.current<1&&B.renderingComplete({analyticsContext:k})},[g,k]);const G=a.useCallback(()=>{S&&p?.({image:S,messageId:i,analyticsContext:k})},[S,i,p,k]),Q=a.useMemo(()=>({width:e.width,height:e.height}),[e]),q=a.useCallback(()=>{const d=(b.current[e.asset_pointer]??0)+1;if(b.current[e.asset_pointer]=d,b.current[e.asset_pointer]>ue)return re.addAction("image-gen-asset-error",{name:"retries-exhausted",conversation_id:c,asset_pointer:e.asset_pointer,max_retries:ue});re.addAction("image-gen-asset-retry",{name:"retry-attempted",conversation_id:c,asset_pointer:e.asset_pointer,current_retry:d}),b.current[e.asset_pointer]=d,E(!0)},[e.asset_pointer,E,c]),V=a.useCallback(d=>{d===1&&T(!0),o?.(d)},[o]),U=a.useRef(null),$=a.useRef(null);a.useEffect(()=>{if(U.current&&m?.setContainerSize){const d=U.current.getBoundingClientRect(),M={width:d.width,height:d.height},P=$.current;(!P||P.width!==M.width||P.height!==M.height)&&($.current=M,m.setContainerSize(M))}},[m]);const z=S?.url,h=O??z;return n.jsx(et.Provider,{value:k,children:n.jsxs("div",{ref:U,className:F("group/imagegen-image relative w-full overflow-hidden",H<1?"max-w-[400px]":"max-w-[480px]",u?"rounded-lg":"rounded-2xl",j&&"max-w-full",i===N.get("image")&&"[view-transition-name:var(--vt-active-image)]"),id:`image-${i}`,style:{aspectRatio:H},onClick:s?G:void 0,tabIndex:0,children:[O&&n.jsx("img",{alt:t,className:"absolute inset-0 z-1 opacity-0",src:O}),n.jsx(ft,{alt:t,src:z,availablePercentComplete:g,onAnimationUpdate:V,isEditorAvailable:s,ignoreFirstChunk:!0,isTransparent:e.metadata?.generation?.transparent_background,dimensions:Q,onError:q,unconstrainedWidth:j,progressLoaderProps:m},A),m?.state&&m?.state!==I.Complete&&!x&&m?.hasImageReady&&n.jsx(Ce,{isGettingStarted:!1}),x&&!u&&(j?n.jsx(dt,{imageUrl:z??""}):n.jsx(tt,{imageAssetPointer:z,imageUrl:h,messageId:i,clientThreadId:r,serverThreadId:c,shouldShowOverflow:O!==void 0}))]},A)})},ht=({imageGenerationState:e,isInterrupted:t,asyncMessage:s,imageAssetPointer:o,altLabel:i,clientThreadId:l,serverThreadId:r,onEditorClick:c,isEditorAvailable:p,setAnimationPercentage:u,messageId:m})=>{const[_,S]=a.useState(null),C=_==null,[v,A]=a.useState(!0),w=e===I.Thinking||e===I.AsyncGenerating&&!s?.metadata?.is_visually_hidden_from_conversation,D=e===I.Generating||e===I.Complete;return a.useEffect(()=>{w&&A(!1)},[w]),t?null:n.jsxs(n.Fragment,{children:[(w||!v)&&n.jsx(ct,{isDimensionsUnknown:C,width:_?.width,height:_?.height,children:C&&n.jsx(Ce,{isGettingStarted:!0})}),D&&n.jsx(W.div,{className:"pb-2",variants:{hidden:{opacity:0},visible:{opacity:1}},initial:"hidden",animate:v?"visible":"hidden",exit:"hidden",children:o&&n.jsx(X,{pointer:o,altLabel:i,isEditorAvailable:p,onPercentageRendered:u,messageId:m,clientThreadId:l,serverThreadId:r,imageIndex:0,onEditorClick:c,progressLoaderProps:{state:e,setContainerSize:S,hasImageReady:v,setHasImageReady:A,shouldHideDiagonalShimmer:!0,shouldShowPulseAnimation:!0}})})]})};function pt({title:e,description:t,shimmer:s}){return!e&&!t?null:n.jsxs("div",{className:"border-token-border-default my-2 max-w-[480px] min-w-72 rounded-2xl border p-6",children:[!!e&&n.jsx("p",{className:F("text-lg font-medium",s&&"loading-shimmer-pure-text-inverted",!!t&&"mb-1"),children:e}),!!t&&n.jsx("p",{children:t})]})}const xt=({cotMessages:e,visualPercentComplete:t,isInterrupted:s=!1,state:o})=>{const l=K().formatMessage({id:"imagegen.thinkingHeader.interrupted",defaultMessage:"Stopped creating image"}),r=o===I.Complete||t===1,c=a.useMemo(()=>{if(s)return l;if(!e)return;if(r)return e.complete;if(t){const p=Object.keys(e.generating);for(let u=0;u<p.length;u+=1){const m=parseFloat(p[u]);if(t<m)return e.generating[p[u]]}}else return e.thinking;return e.complete},[e,l,s,r,t]);return c&&n.jsx(rt,{latestHeadline:c,isComplete:r||s,showChunkIcon:!1,isExpandDisabled:!0})},vt=({pointersToRender:e,altLabel:t,isEditorAvailable:s,updatePercentageRendered:o,toolCallMessage:i,toolOutputMessageIds:l,clientThreadId:r,serverThreadId:c,handleEditorClick:p})=>{const u=ne.useStore(),m=ne.useSelectedIndex();a.useEffect(()=>{u.setSelectedIndex(Math.max(l.findIndex(g=>g===i?.metadata?.selected_image_message_id),0))},[]);const _=a.useRef({}),S=a.useCallback(g=>b=>{_.current[g]=b;const N=Object.keys(_.current).length,f=Object.values(_.current).reduce((x,T)=>x+T,0);o?.(f/N)},[o]),[C,v]=a.useState(null),A=Ne(r,te.getRequestId),w=nt(A);a.useEffect(()=>{!w&&C!=null&&i!=null&&c!=null&&(ge(i.id,l[C],r,c),v(null))},[w]);const D=a.useCallback(g=>{u.setSelectedIndex(g);const b=Object.values(_.current);Ee.logEventWithStatsig("chatgpt_image_switched","chatgpt_image_switched",{conversationId:c,messageId:l[g],imageIndex:g.toString(),isLoading:(b.length===0||b.some(x=>x<1)).toString()});const f=te.getConversationLastTurn(he(r))?.messages.find(x=>x.id===i?.id)!=null;i!=null&&c!=null&&(f&&w?v(g):ge(i.id,l[g],r,c))},[i,l,r,c,u,w,v]);return n.jsxs("div",{className:"flex gap-2",children:[n.jsx(X,{pointer:e[m],altLabel:t,isEditorAvailable:s,messageId:l[m],imageIndex:m,clientThreadId:r,serverThreadId:c,onEditorClick:p}),n.jsx("div",{className:"flex flex-col gap-2",children:e.map((g,b)=>n.jsx(wt,{pointer:g,altLabel:t,isSelected:b===m,onClick:()=>D(b),onPercentageRendered:g.metadata?.generation?.gen_id?S(g.metadata.generation.gen_id):void 0,messageId:l[b],imageIndex:b,clientThreadId:r,serverThreadId:c},g.metadata?.generation?.gen_id))})]})},wt=({pointer:e,altLabel:t,isSelected:s,onClick:o,onPercentageRendered:i,messageId:l,imageIndex:r,clientThreadId:c,serverThreadId:p})=>n.jsxs("button",{type:"button",onClick:o,className:"relative w-14 rounded-lg p-1",children:[n.jsx("div",{className:F(s&&"opacity-70"),children:n.jsx(X,{pointer:e,altLabel:t,isEditorAvailable:!1,onPercentageRendered:i,messageId:l,imageIndex:r,clientThreadId:c,serverThreadId:p,compact:!0})}),s&&n.jsx("div",{className:"border-token-border-default pointer-events-none absolute inset-0 rounded-xl border-2"})]});async function ge(e,t,s,o){const i=await Ae.safePost("/image-gen/message-select",{requestBody:{message_id:e,selected_image_message_id:t,conversation_id:o}}),l=i.id;l!=null&&Ge(s,r=>{Pe.updateTree(r,c=>{c.updateNodeMessage(l,i)})})}function It(e){const t=e.find(r=>r.author.role==="tool"&&r.author.name===at&&r.content.content_type==="text"),[s,...o]=t?.content.content_type==="text"?t.content.parts:[],i=o.pop(),l=o.length;return s&&i&&o.length>0?{thinking:s,complete:i,generating:o.reduce((r,c,p)=>{const u=(p+1)/l;return r[u.toFixed(2)]=c,r},{})}:void 0}const St=e=>{const t=K(),{size:s="image",count:o=1}=e||{};return o>1?{thinking:t.formatMessage({id:"cdnmKo",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"aTbInH",defaultMessage:"Creating images. May take a moment."}),"0.67":t.formatMessage({id:"WRM3Yw",defaultMessage:"Creating images. May take a moment."}),"1.00":t.formatMessage({id:"8ZydRG",defaultMessage:"Creating images. May take a moment."})},complete:t.formatMessage({id:"XQ81dl",defaultMessage:"Images created"})}:s==="xlimage"?{thinking:t.formatMessage({id:"y7op2E",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"cdrDJH",defaultMessage:"Creating image. May take a moment."}),"0.67":t.formatMessage({id:"RP4bRn",defaultMessage:"Adding details"}),"1.00":t.formatMessage({id:"o36MSQ",defaultMessage:"Finishing touches"})},complete:t.formatMessage({id:"QsnnBN",defaultMessage:"Image created"})}:{thinking:t.formatMessage({id:"6c7+kN",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"DP6/8y",defaultMessage:"Creating image"}),"0.67":t.formatMessage({id:"k9y1TT",defaultMessage:"Creating image"}),"1.00":t.formatMessage({id:"GpR7v3",defaultMessage:"Creating image"})},complete:t.formatMessage({id:"l2Izz4",defaultMessage:"Image created"})}},_t=pe(()=>xe(()=>import("./bc0md0wib1cjfmx5.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17])).then(e=>e.ImageGenConversationLightboxNew)),bt=pe(async()=>xe(()=>import("./o899j6tq6eofkz5m.js"),__vite__mapDeps([18,3,1,4,8,2,5,7,9,10,11,12,13,14,15,16,17])).then(e=>e.ImageGenNewEditor)),Ct=[I.Empty,I.Errored],$t=({messages:e,clientThreadId:t,isLastTurnInConversation:s,disableClickThru:o=!1})=>{const i=De(t),l=K(),r=l.formatMessage({id:"imagegen.message.altLabel",defaultMessage:"Generated image"}),[c,p]=a.useState(!1),[u,m]=a.useState(null),[_,S]=a.useState(null),{messageIds:C,imageAssetPointers:v}=a.useMemo(()=>ce(e),[e]),A=e.find(st),w=ne.useSelectedIndex(),D=v?.[w]?.metadata?.generation?.gen_size,g=St({size:D??"image",count:v?.length??1}),b=a.useMemo(()=>It(e)??g,[e,g]),N=e.find(h=>h.metadata?.image_gen_async),f=a.useMemo(()=>it(e,s),[e,s]),x=a.useRef(!1),T=a.useRef(!1),j=a.useRef(null),H=a.useMemo(()=>Se({pointer:v[w],conversationId:i,messageId:C[w],source:o?"paragen":"chat",imageIndex:w.toString()}),[v,C,w,i,o]);a.useEffect(()=>{if(!x.current&&(f===I.Thinking||f===I.Generating))x.current=!0,j.current=performance.now();else if(x.current&&!T.current)if(f===I.Complete){const h=j.current?performance.now()-j.current:void 0;B.generationSuccess({analyticsContext:H,durationMs:h}),T.current=!0}else f===I.Errored&&(B.generationFailure({analyticsContext:H,errorReason:"assistant_error"}),T.current=!0)},[f,H]);const O=e[e.length-1],L=a.useMemo(()=>O&&Te(O),[O]),E=me(),k=Oe(E).checkGate("3287225511"),{onRequestCompletion:R,currentModelId:G}=ot(),Q=fe(E,"3019066937").get("should_use_new_ui",!1),q=Fe({clientThreadId:t})&&f===I.Complete,[V,U]=a.useState(0),$=ve(),z=a.useCallback(async({image:h,messageId:d,analyticsContext:M})=>{if(k){const P=he(t),J=P?te.getConversationTurns(P).flatMap(y=>y.messages):e,{imageAssetPointers:Y,messageIds:ae}=ce(J,{skipSort:!0}),se=(await Promise.all(Y.map(y=>Ie.fetch($,{asset:y,conversationId:i})))).map((y,oe)=>({id:y.metadata?.generation?.gen_id??ae[oe],archived:!1,transformationId:y.metadata?.generation?.gen_id??null,url:y.url,assetPointer:y.asset_pointer,thumbnail:null,width:y.width,height:y.height,title:null,conversationId:i,messageId:ae[oe]}));B.editorClick({sourceOperation:h.metadata?.dalle?.edit_op??"none",analyticsContext:M});const ie=se.findIndex(y=>y.assetPointer===h.asset_pointer);ze(E,({onClose:y})=>n.jsx(_t,{images:se,initialIndex:ie===-1?0:ie,onClose:y,onRequestCompletion:R,clientThreadId:t,currentModelId:G}))}else m(h),S(d),p(!0),B.editorClick({sourceOperation:h.metadata?.dalle?.edit_op??"none",analyticsContext:M})},[e,i,E,R,t,G,$,k]);return Ct.includes(f)?null:n.jsxs(we.Provider,{value:o,children:[n.jsx("div",{className:"flex flex-col",children:Q?n.jsx(ht,{imageGenerationState:f,isInterrupted:L,asyncMessage:N,imageAssetPointer:v[0],altLabel:r,clientThreadId:t,serverThreadId:i,onEditorClick:z,setAnimationPercentage:U,isEditorAvailable:q,messageId:C[0]}):n.jsxs(n.Fragment,{children:[f!==I.Unavailable&&f!==I.AsyncGenerating&&f!==I.AsyncHanging&&n.jsx("div",{className:"pb-3",children:n.jsx(xt,{cotMessages:b,visualPercentComplete:V,isInterrupted:L,state:f})}),f===I.Thinking&&!L&&n.jsx(be,{isDimensionsUnknown:!0,children:n.jsx(Me,{withLottie:!0})}),f===I.AsyncGenerating&&!N?.metadata?.is_visually_hidden_from_conversation&&n.jsx(pt,{shimmer:!0,title:N?.metadata?.ui_card_title,description:N?.metadata?.ui_card_description}),(f===I.Generating||f===I.Complete)&&!L&&n.jsx("div",{className:"pb-2",children:v.length>1?n.jsx(vt,{pointersToRender:v,altLabel:r,isEditorAvailable:q,updatePercentageRendered:U,toolCallMessage:A,toolOutputMessageIds:C,clientThreadId:t,serverThreadId:i,handleEditorClick:z}):n.jsx(X,{pointer:v[0],altLabel:r,isEditorAvailable:q,onPercentageRendered:U,messageId:C[0],imageIndex:0,clientThreadId:t,serverThreadId:i,onEditorClick:z})})]})}),!k&&n.jsx(Le,{testId:"modal-image-gen-content",type:"success",size:"fullscreen",isOpen:c,onClose:()=>p(!1),title:l.formatMessage({id:"imagegen.message.contentModalTitle",defaultMessage:"Edit image"}),visuallyHiddenHeader:!0,className:"dark:bg-(--gray-800)",children:u&&n.jsx(bt,{image:u,isLoadingNewImage:!1,clientThreadId:t,onClose:()=>p(!1),messageId:_??""})})]})};export{$t as ImageGenMessage};
//# sourceMappingURL=eil9fh4jcipwzcgy.js.map
